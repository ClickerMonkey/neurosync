!function(e,t){function i(e){return e!==t}function n(e){return!!(e&&e.constructor&&e.call&&e.apply)}function s(e){return!!(e&&e.Database&&n(e)&&e.prototype instanceof te)}function r(e){return"string"==typeof e}function o(e){return"number"==typeof e&&!isNaN(e)}function a(e){return"boolean"==typeof e}function h(e){return e instanceof Date}function u(e){return e instanceof RegExp}function l(e){return e instanceof Array}function d(e){return null!==e&&"object"==typeof e}function c(e,t){return e instanceof Array?e:e.split(t)}function f(e){return!(e===t||null===e)}function v(e,t,i){for(var n=i||P,s=0,r=e.length;r>s;s++)if(n(e[s],t))return s;return!1}function g(){}function m(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function E(){return m()+m()+"-"+m()+"-"+m()+"-"+m()+"-"+m()+m()+m()}function p(e,t,i,n){if(r(t))return e[t]===i[n];for(var s=0;s<t.length;s++){var o=t[s],a=n[s];if(!w(e[o],i[a]))return!1}return!0}function R(e){function t(){}return t.prototype=e.prototype,t}function A(e,t,i){e=R(e),t.prototype=new e,y(i,t.prototype),t.prototype.constructor=t}function $(e){function t(t){return e.apply(this,t)}return t.prototype=e.prototype,function(){return new t(arguments)}}function S(e,t,i){b()?(A(e,t,i),t.create=$(t)):(e=R(e),t.create=function(){var n=new e;return t.apply(n,arguments),y(i,n),n})}function b(){function e(){}if(b.supported===t){e.prototype=[];var i=new e;i.push(0),b.supported=1===i.length}return b.supported}function y(e,t){for(var i in e)t[i]=e[i];return t}function M(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function O(e,i,n){for(var s in n){var r=n[s],o=i[s];if(!o&&r===t)throw s+" is a required option";f(o)?e[s]=o:e[s]=H(r)}e.options=i}function N(e){return 1===e.length?e.toUpperCase():e.charAt(1).toUpperCase()}function D(e){return e.replace(/(^.|_.)/g,N)}function _(e){var t=arguments.length>1||!l(e)?Array.prototype.slice.call(arguments):e;return new ne(t)}function L(e){return f(e)?s(e)?new e:n(e)?e():H(e):e}function T(e,t,i){for(var n={},s=0;s<t.length;s++){var r=t[s];r in e&&(n[r]=i?H(e[r]):e[r])}return n}function I(e,t,i){if(r(t)){var n=e[t];return i?H(n):n}for(var s=[],o=0;o<t.length;o++){var a=t[o],n=e[a];s.push(i?H(n):n)}return s}function k(e){return function(){return e.apply(this,arguments)}}function H(e,i){if(null===e||e===t||"object"!=typeof e||n(e)||u(e))return e;if(l(e)){for(var s=[],r=0;r<e.length;r++)s.push(H(e[r],i));return s}if(h(e))return new Date(e.getTime());var s={};for(var o in e)(i||"$"!==o.charAt(0))&&(s[o]=H(e[o],i));return s}function U(e,t,i,n){for(var s={},r=0;r<i.length;r++){var o=i[r];n(e[o],t[o])||(s[o]=H(e[o]))}return s}function F(e){if(l(e)||r(e))return e.length;if(d(e)){var t=0;for(var i in e)t++;return t}return 0}function V(e){if(null===e||void 0===e||0===e)return!0;if(l(e)||r(e))return 0===e.length;if(h(e))return 0===e.getTime()||isNaN(e.getTime());if(d(e)){for(var t in e)return!1;return!0}return!1}function P(e,t){return e===t}function C(e,t){return 0===Y(e,t)}function w(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var i=typeof e,s=typeof t;if(i!==s)return!1;var r=l(e),o=l(t);if(r!==o)return!1;if(r){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!w(e[a],t[a]))return!1;return!0}if(h(e))return h(t)&&w(e.getTime(),t.getTime());if(u(e))return u(t)&&e.toString()===t.toString();if("object"===i){for(var d in e)if(!("$"===d.charAt(0)||n(e[d])||d in t&&w(e[d],t[d])))return!1;for(var d in t)if(!("$"===d.charAt(0)||n(t[d])||d in e))return!1;return!0}return!1}function K(e,t){return e===t?0:t>e?-1:1}function Y(e,t,i){if(e==t)return 0;var n=f(e),s=f(t);return n!==s?n&&!i||s&&i?-1:1:(h(e)&&(e=e.getTime()),h(t)&&(t=t.getTime()),o(e)&&o(t)?K(e,t):l(e)&&l(t)?K(e.length,t.length):a(e)&&a(t)?e?-1:1:(e+"").localeCompare(t+""))}function x(e,t){if(!e)return!0;for(var i=0,n=t.length-1;n>i;i++)if(e(t[i],t[i+1])>0)return!1;return!0}function z(e,t){if(n(e))return e;if(r(e))return"-"===e.charAt(0)?(e=e.substring(1),function(i,n){var s=f(i)?i[e]:i,r=f(n)?n[e]:n;return Y(r,s,!t)}):function(i,n){var s=f(i)?i[e]:i,r=f(n)?n[e]:n;return Y(s,r,t)};if(l(e)){for(var i=[],s=0;s<e.length;s++)i[s]=z(e[s],t);return function(e,t){for(var n=0,s=0;s<i.length&&0===n;s++)n=i[s](e,t);return n}}return null}function B(e){return n(e)?e:r(e)?function(i){return f(i)?parseFloat(i[e]):t}:function(e){return parseFloat(e)}}function G(e,t){if(n(e))return e;if(r(e))return function(t){return t[e]};if(l(e))return function(i){return I(i,e).join(t)};if(d(e)){var i=[],s=[];for(var o in e)i.push(o),s.push(G(e[o],t));return function(e){for(var n=[],r=0;r<o.length;r++)n.push(s[r](e[i[r]]));return n.join(t)}}return function(e){return e}}function J(e,t,i){var s=i||P;return n(e)?e:d(e)?function(t){for(var i in e)if(!s(t[i],e[i]))return!1;return!0}:r(e)?f(t)?function(i){return s(i[e],t)}:function(t){return f(t[e])}:function(e){return!0}}function q(e){return n(e)?e:r(e)?function(t){return f(t)&&f(t[e])}:function(){return!0}}function j(e,t){function s(e,t,s,r,o){if(n(r)){var s=c(s," ");i(e[t])||(e[t]={});for(var a=0;a<s.length;a++)i(e[t][s[a]])||(e[t][s[a]]=[]),e[t][s[a]].push([r,o||e,0])}}function r(e,t,i){return s(this,"$$on",e,t,i),this}function o(e,t,i){return s(this,"$$once",e,t,i),this}function a(e,t,i){return s(this,"$$after",e,t,i),this}function h(e,t,i){if(e&&t in e)for(var n=e[t],s=n.length-1;s>=0;s--)n[s][v]===i&&n.splice(s,1)}function u(e,t){e&&t in e&&delete e[t]}function l(e,t){if(i(e)){var e=c(e," ");if(n(t))for(var s=0;s<e.length;s++)h(this.$$on,e[s],t),h(this.$$once,e[s],t),h(this.$$after,e[s],t);else for(var s=0;s<e.length;s++)u(this.$$on,e[s]),u(this.$$once,e[s]),u(this.$$after,e[s])}else u(this,"$$on"),u(this,"$$once"),u(this,"$$after");return this}function d(e,t,i,n){if(e&&t in e){for(var s=e[t],r=++E,o=0;o<s.length;o++){var a=s[o];a&&a[m]!==r&&(a[m]=r,a[v].apply(a[g],i),a!==s[o]&&(o=-1))}n&&delete e[t]}}function f(e,t){for(var e=c(e," "),i=0;i<e.length;i++){var n=e[i];d(this.$$on,n,t,!1),d(this.$$once,n,t,!0),d(this.$$after,n,t,!1)}return this}var v=0,g=1,m=2,E=0;t?(e.$on=r,e.$once=o,e.$after=a,e.$off=l,e.$trigger=f):(e.on=r,e.once=o,e.after=a,e.off=l,e.trigger=f)}function W(e){if(e.name in W.cache)return W.cache[e.name];var t=new ee(e),i=new Function("return function "+t.className+"(props, remoteData) { this.$init( props, remoteData ) }")();return i.prototype=new te(t),t.Model=i,i.Database=t,W.trigger(W.Events.Plugins,[i,t,e]),W.cache[t.name]=i,W.cache[t.className]=i,t.init(),W.trigger(W.Events.Initialized,[i]),W.debug(W.Debugs.CREATION,t,e),i}function Z(e,t,i){var s=n(i)?i:d(i)&&n(i.get)?i.get:g,r=d(i)&&n(i.set)?i.set:g;if(Object.defineProperty)Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s,set:r});else{var o=e.$init;e.$init=function(){o.apply(this,arguments);var e=this[t]=s.apply(this),i=function(){var i=this[t];i!==e?r.call(this,i):e=this[t]=s.apply(this)};this.$after(te.Events.Changes,i,this)}}}function Q(e,t,i,s){var r={on:i?"$on":"on",once:i?"$once":"once",after:i?"$after":"after"},o=s||[];if(n(t))o.push({when:r.on,events:e,invoke:t});else if(l(t)&&2===t.length&&n(t[0]))o.push({when:r.on,events:e,invoke:t[0],context:t[1]});else if(d(t))for(var a in t)if(a in r){var h=t[a],u=r[a];n(h)?o.push({when:u,events:e,invoke:h}):l(h)&&2===h.length&&n(h[0])&&o.push({when:u,events:e,invoke:h[0],context:h[1]})}return o}function X(e,t){for(var i=0;i<t.length;i++){var n=t[i];e[n.when](n.events,n.invoke,n.context)}}function ee(e){var t=ee.Defaults;O(this,e,t);for(var i in e)i in t||(this[i]=e[i]);var n=this.key,s=this.fields;if(l(n))for(var r=n.length-1;r>=0;r--)v(s,n[r])===!1&&s.unshift(n[r]);else v(s,n)===!1&&s.unshift(n);this.models=new re(this),this.className=this.className||D(this.name),this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.firstRefresh=!1,this.pendingOperations=0,this.afterOnline=!1,this.saveFields=H(s),this.rest=W.rest(this),this.store=W.store(this),this.live=W.live(this,this.handlePublish(this)),this.setComparator(this.comparator,this.comparatorNullsFirst),this.setRevision(this.revision),this.setSummarize(this.summarize),this.relations={},this.relationNames=[];for(var o in e)if(o in W.Relations){var a=W.Relations[o];if(a.prototype instanceof pe){var h=e[o];for(var u in h){var d=h[u],c=new a;c.init(this,u,d),c.save&&this.saveFields.push(u),this.relations[u]=c,this.relationNames.push(u)}}}}function te(e){this.$db=e}function ie(){this.values=[],this.keys=[],this.indices={}}function ne(e){this.addAll(e)}function se(e,t){this.onAdd=k(this.handleAdd),this.onAdds=k(this.handleAdds),this.onRemove=k(this.handleRemove),this.onRemoves=k(this.handleRemoves),this.onReset=k(this.handleReset),this.onUpdates=k(this.handleUpdates),this.onCleared=k(this.handleCleared),this.init(e,t)}function re(e,t,i){this.init(e,t,i)}function oe(e,t,i,n){this.onModelAdd=k(this.handleModelAdded),this.onModelRemoved=k(this.handleModelRemoved),this.onModelUpdated=k(this.handleModelUpdated),this.init(e),this.connect(),this.setWhere(t,i,n)}function ae(e,t){this.init(e),this.query=t,this.status=ae.Status.Pending,this.onSuccess=this.handleSuccess(),this.onFailure=this.handleFailure()}function he(){}function ue(e,t){this.reset(e,t)}function le(e,t){this.reset(e,t)}function de(e,t){this.reset(e,t)}function ce(e,t){this.reset(e,t)}function fe(e,t){this.reset(e,t)}function ve(e,t){this.reset(e,t)}function ge(e,t){this.reset(e,t)}function me(e,t){this.reset(e,t)}function Ee(e,t){this.reset(e,t)}function pe(){}function Re(){}function Ae(){}function $e(){}function Se(){}function be(e,t,i){this.init(e),this.model=t,this.relator=i}W.Events={Initialized:"initialized",Plugins:"plugins",Online:"online",Offline:"offline"},W.cache={},W.get=function(t,i,s){function r(){var e=W.cache[t];e&&(i.call(a,e),W.off(W.Events.Initialized,r))}var o=W.cache[t],a=s||e;return n(i)&&(o?i.call(a,o):W.on(W.Events.Initialized,r)),o},j(W),W.on(W.Events.Plugins,function(e,t,i){e.all=function(){return t.models}}),W.on(W.Events.Plugins,function(e,t,i){e.boot=function(e){return l(e)?new re(t,e,!0):d(e)?t.putRemoteData(e):e}}),W.on(W.Events.Plugins,function(e,t,i){e.bootCollection=function(e){return new re(t,e,!0)}}),W.on(W.Events.Plugins,function(e,t,i){e.collect=function(e){var i=arguments.length>1||!l(e)?Array.prototype.slice.call(arguments):e;return new re(t,i)}}),W.on(W.Events.Plugins,function(e,t,i){e.create=function(e){if(!d(e)){var i=t.instantiate();return i.$save(),i}var n=T(e,t.fields),i=t.instantiate(n),s=i.$key(),r={};t.models.put(s,i),t.trigger(ee.Events.ModelAdded,[i,!1]),t.updated();for(var o=0;o<t.relationNames.length;o++){var a=t.relationNames[o];a in e&&(r[a]=e[a])}return i.$save(r),i}}),W.on(W.Events.Plugins,function(e,t,i){if(d(i.dynamic))for(var n in i.dynamic){var s=i.dynamic[n];Z(e.prototype,n,s)}}),W.on(W.Events.Plugins,function(e,t,i){var n=i.events;if(d(n)){var s=[],r=[],o=e.prototype.$init;e.prototype.$init=function(){o.apply(this,arguments),X(this,s)};for(var a in n){var h=n[a],u=D(a),l=ee.Events[u],c=te.Events[u];l&&Q(l,h,!1,r),c&&Q(c,h,!0,s)}X(t,r)}}),W.on(W.Events.Plugins,function(e,t,i){e.fetch=function(e){var i=t.buildKeyFromInput(e),n=t.get(i);return n||(n=t.buildObjectFromKey(i),d(e)&&n.$set(e)),n.$refresh(),n}}),W.on(W.Events.Plugins,function(e,t,i){e.get=function(e,i,s){if(!n(i)){var r=t.buildKeyFromInput(e);return t.get(r)}t.grabModel(e,i,s)}}),W.on(W.Events.Plugins,function(e,t,i){d(i.methods)&&y(i.methods,e.prototype)}),W.on(W.Events.Plugins,function(e,t,i){e.query=function(e){var i=new ae(t,e);return i.sync(),i}}),W.on(W.Events.Plugins,function(e,t,i){e.where=function(e,i,n){return new oe(t,e,i,n)}}),W.debug=function(e,t){},W.Debugs={CREATION:0,REST:1,AUTO_REFRESH:73,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,GET_LOCAL_SKIPPED:104,GET_LOCAL:105,GET_LOCAL_ERROR:106,GET_REMOTE:107,GET_REMOTE_ERROR:108,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_NINJA_SAVE:50,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:72,HASMANY_INIT:74,HASMANY_NINJA_REMOVE:75,HASMANY_NINJA_SAVE:76,HASMANY_INITIAL:77,HASMANY_INITIAL_PULLED:78,HASMANY_REMOVE:79,HASMANY_SORT:80,HASMANY_ADD:81,HASMANY_LAZY_LOAD:82,HASMANY_INITIAL_GRABBED:83,HASMANY_NINJA_ADD:84,HASMANY_AUTO_SAVE:85,HASMANY_PREREMOVE:86,HASMANY_POSTSAVE:87,HASMANYTHRU_INIT:88,HASMANYTHRU_NINJA_REMOVE:89,HASMANYTHRU_NINJA_SAVE:90,HASMANYTHRU_NINJA_THRU_REMOVE:91,HASMANYTHRU_INITIAL:92,HASMANYTHRU_INITIAL_PULLED:93,HASMANYTHRU_REMOVE:94,HASMANYTHRU_SORT:95,HASMANYTHRU_ADD:96,HASMANYTHRU_LAZY_LOAD:97,HASMANYTHRU_INITIAL_GRABBED:98,HASMANYTHRU_NINJA_ADD:99,HASMANYTHRU_AUTO_SAVE:100,HASMANYTHRU_PREREMOVE:101,HASMANYTHRU_POSTSAVE:102,HASMANYTHRU_THRU_ADD:103,HASMANYTHRU_THRU_REMOVE:68},W.rest=function(e){return{all:function(e,t){e([])},get:function(e,t,i){i(null,-1)},create:function(e,t,i,n){i({})},update:function(e,t,i,n){i({})},remove:function(e,t,i){t({})},query:function(e,t,i){t([])}}},W.store=function(e){return{put:function(e,t,i,n){i(e,t)},get:function(e,t,i){i(e,void 0)},remove:function(e,t,i){t(e,record)},all:function(e,t){e([],[])}}},W.live=function(e,t){return function(e){}},W.online=window.navigator.onLine!==!1,W.forceOffline=!1,W.setOnline=function(){W.online=!0,W.debug(W.Debugs.ONLINE),W.trigger(W.Events.Online)},W.setOffline=function(){W.online=!1,W.debug(W.Debugs.OFFLINE),W.trigger(W.Events.Offline)},W.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener(W.Events.Online,W.setOnline,!1),window.addEventListener(W.Events.Offline,W.setOffline,!1)):(document.body.ononline=W.setOnline,document.body.onoffline=W.setOffline)},W.checkNetworkStatus=function(){var e=window.navigator.onLine;W.forceOffline&&(e=!1),e===!0&&W.online===!1?W.setOnline():e===!1&&W.online===!0&&W.setOffline()},ee.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",Loads:"no-load remote-load local-load"},ee.Live={Save:"SAVE",Remove:"REMOVE"},W.Cache={None:"none",Pending:"pending",All:"all"},ee.Defaults={name:t,className:null,key:"id",keySeparator:"/",fields:[],defaults:{},comparator:null,comparatorNullsFirst:null,revision:null,loadRelations:!0,loadRemote:!0,autoRefresh:!0,cache:W.Cache.All,fullSave:!1,fullPublish:!1,encode:function(e){return e},decode:function(e){return e},summarize:function(e){return e.$key()}},ee.prototype={ready:function(e,t,i){function n(){r.off(ee.Events.Loads,s)}function s(){i||n(),(!a||i)&&(e.call(o,r)===!1&&n(),a=!0)}var r=this,o=t||r,a=!1;return r.initialized?(e.call(o,r),a=!0):r.on(ee.Events.Loads,s),a},grabModel:function(e,t,i,n){function s(){var i=r.parseModel(e,n);return i===!1||a||(a=!0,t.call(o,i)),null===i?!1:!0}var r=this,o=i||r,a=!1;s()&&r.ready(s,r,!0)},parseModel:function(e,t){var i=this,n=i.remoteLoaded||!i.loadRemote;if(!f(e))return n?null:!1;s(e)&&(e=new e);var r=i.buildKeyFromInput(e);if(e instanceof i.Model)return i.saveToModels(e),e;if(i.models.has(r)){var o=i.models.get(r);return d(e)&&(t?i.putRemoteData(e,r,o):o.$set(e)),o}return d(e)?t?i.putRemoteData(e):i.instantiate(i.decode(e)):n?null:!1},removeKey:function(e){var t=this.key;if(l(t))for(var i=0;i<t.length;i++)delete e[t[i]];else delete e[t]},buildKey:function(e,t){var i=this.buildKeys(e,t);return l(i)&&(i=i.join(this.keySeparator)),i},buildKeys:function(e,t){var i=null;if(l(t)){i=[];for(var n=0;n<t.length;n++)i.push(e[t[n]])}else i=e[t],i||(i=e[t]=E());return i},buildKeyFromInput:function(e){return e instanceof this.Model?e.$key():l(e)?this.buildKeyFromArray(e):d(e)?this.buildKey(e,this.key):e},buildKeyFromArray:function(e){return e.join(this.keySeparator)},getKey:function(e){return this.buildKey(e,this.key)},getKeys:function(e){return this.buildKeys(e,this.key)},buildObjectFromKey:function(e){var t=this,i={};if(l(t.key)){r(e)&&(e=e.split(t.keySeparator));for(var n=0;n<t.key.length;n++)i[t.key[n]]=e[n]}else i[t.key]=e;return t.instantiate(i)},hasFields:function(e,t,i){if(l(t)){for(var n=0;n<t.length;n++)if(!i(e[t[n]]))return!1;return!0}return i(e[t])},updated:function(){this.sort(),this.trigger(ee.Events.Updated)},setRevision:function(e){n(e)?this.revisionFunction=e:r(e)?this.revisionFunction=function(i,n){var s=d(i)&&e in i?i[e]:t,r=d(n)&&e in n?n[e]:t;return s===t||r===t?!1:Y(s,r)}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e,t){this.models.setComparator(e,t)},setSummarize:function(e){n(e)?this.summarize=e:r(e)?this.summarize=function(t){return f(t)?t[e]:t}:this.summarize=function(e){return e.$key()}},sort:function(){this.models.resort()},isSorted:function(){return this.models.isSorted()},putRemoteData:function(e,t,i){var n=this,t=t||n.getKey(e),i=i||n.models.get(t),s=n.decode(H(e));if(i){var r=this.revisionFunction(i,e);if(r!==!1&&r>0)return W.debug(W.Debugs.SAVE_OLD_REVISION,n,i,e),i}if(i&&i.$saved){var o=!n.models.has(t);o&&n.models.put(t,i);var a=i.$toJSON(!0),h={},u=!1,l={},d=V(i.$saved),c=n.relations;for(var f in e)if("$"!==f.charAt(0))if(f in c)i.$set(f,e[f],!0);else{var v=a[f],g=i.$saved[f];d||w(v,g)?(i[f]=s[f],l[f]=e[f],i.$local&&(i.$local[f]=e[f])):(h[f]=e[f],u=!0),i.$saved[f]=H(e[f])}u?i.$trigger(te.Events.PartialUpdate,[e,h]):i.$trigger(te.Events.FullUpdate,[e,l]),i.$trigger(te.Events.RemoteUpdate,[e]),i.$addOperation(me),o&&n.trigger(ee.Events.ModelAdded,[i,!0])}else i=n.instantiate(s,!0),i.$status=te.Status.Synced,n.cache===W.Cache.All?(i.$local=i.$toJSON(!1),i.$local.$status=i.$status,i.$saved=i.$local.$saved=i.$toJSON(!0),i.$addOperation(me)):i.$saved=i.$toJSON(!0),n.models.has(t)||(n.models.put(t,i),n.trigger(ee.Events.ModelAdded,[i,!0]));return i},destroyLocalUncachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,i.removeKey(e),e.$trigger(te.Events.Detach),!1):(i.models.remove(t),i.trigger(ee.Events.ModelRemoved,[e]),e.$trigger(te.Events.RemoteAndRemove),W.debug(W.Debugs.REMOTE_REMOVE,i,e),!0):!1},destroyLocalCachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,delete e.$local.$saved,i.removeKey(e),i.removeKey(e.$local),e.$trigger(te.Events.Detach),e.$addOperation(me),!1):(e.$addOperation(fe),i.models.remove(t),i.trigger(ee.Events.ModelRemoved,[e]),e.$trigger(te.Events.RemoteAndRemove),W.debug(W.Debugs.REMOTE_REMOVE,i,e),!0):(i.store.remove(t,function(e){e&&W.debug(W.Debugs.REMOTE_REMOVE,i,e)}),!1)},destroyLocalModel:function(e){var t=this,i=t.models.get(e);return t.cache===W.Cache.All?t.destroyLocalCachedModel(i,e):t.destroyLocalUncachedModel(i,e)},init:function(){function e(e,t){W.debug(W.Debugs.LOCAL_LOAD,i,e),i.models.clear(),e=Array.prototype.slice.call(e),t=Array.prototype.slice.call(t);for(var n=0;n<e.length;n++){var s=e[n],r=t[n],o=i.decode(H(s,!0)),a=i.instantiate(o,!0);a.$local=s,a.$saved=s.$saved,a.$status===te.Status.RemovePending?(W.debug(W.Debugs.LOCAL_RESUME_DELETE,i,a),a.$addOperation(ve)):a.$status===te.Status.Removed||(a.$status===te.Status.SavePending?(W.debug(W.Debugs.LOCAL_RESUME_SAVE,i,a),i.models.put(r,a,!0),a.$addOperation(Ee)):(W.debug(W.Debugs.LOCAL_LOAD_SAVED,i,a),i.models.put(r,a,!0)))}i.initialized=!0,i.localLoaded=!0,i.trigger(ee.Events.LocalLoad,[i]),i.updated(),i.loadRemote&&(0===i.pendingOperations?i.refresh():i.firstRefresh=!0)}function t(){i.initialized=!0,i.loadRemote?i.refresh():i.trigger(ee.Events.NoLoad,[i])}var i=this;return i.loadRemote&&i.autoRefresh&&W.after("online",i.onOnline,i),i.cache===W.Cache.None?void(i.loadRemote?i.refresh():(i.initialized=!0,i.trigger(ee.Events.NoLoad,[i]))):void i.store.all(e,t)},onOnline:function(){this.afterOnline=!0,0===this.pendingOperations&&this.onOperationRest()},onOperationRest:function(){var e=this;(e.autoRefresh&&e.remoteLoaded&&e.afterOnline||e.firstRefresh)&&(e.afterOnline=!1,e.firstRefresh=!1,W.debug(W.Debugs.AUTO_REFRESH,e),e.refresh())},refresh:function(){function e(e){for(var t={},n=0;n<e.length;n++){var s=i.putRemoteData(e[n]);if(s){var r=s.$key();t[r]=s}}for(var o=i.models.keys(),n=0;n<o.length;n++){var a=o[n];if(!(a in t)){var h=i.models.get(a);h.$saved&&(W.debug(W.Debugs.REMOTE_LOAD_REMOVE,i,a),i.destroyLocalModel(a))}}i.initialized=!0,i.remoteLoaded=!0,i.trigger(ee.Events.RemoteLoad,[i]),i.updated(),W.debug(W.Debugs.REMOTE_LOAD,i,e)}function t(e,t){0===t?(W.checkNetworkStatus(),W.online||(i.pendingRefresh=!0,W.once("online",i.onRefreshOnline,i)),W.debug(W.Debugs.REMOTE_LOAD_OFFLINE,i)):(W.debug(W.Debugs.REMOTE_LOAD_ERROR,i,t),i.initialized=!0,i.trigger(ee.Events.NoLoad,[i]))}var i=this;i.rest.all(e,t)},onRefreshOnline:function(){var e=this;W.debug(W.Debugs.REMOTE_LOAD_RESUME,e),e.pendingRefresh&&(e.pendingRefresh=!1,e.refresh())},get:function(e){return this.models.get(this.buildKeyFromInput(e))},handlePublish:function(e){return function(t){var i=t.key,n=t.model;switch(t.op){case ee.Live.Save:e.putRemoteData(n,i),e.updated(),W.debug(W.Debugs.REALTIME_SAVE,e,t.model,i);break;case ee.Live.Remove:e.destroyLocalModel(i)&&e.updated(),W.debug(W.Debugs.REALTIME_REMOVE,e,i)}}},instantiate:function(e,t){return new this.Model(e,t)},save:function(e,t){var i=this;return e.$isDeleted()?void W.debug(W.Debugs.SAVE_DELETED,i,e):(this.saveToModels(e),void e.$addOperation(ge,t))},saveToModels:function(e,t){var i=this,n=e.$key();i.models.has(n)?(i.trigger(ee.Events.ModelUpdated,[e,t]),e.$trigger(te.Events.UpdateAndSave)):(i.models.put(n,e),i.trigger(ee.Events.ModelAdded,[e,t]),i.updated(),e.$trigger(te.Events.CreateAndSave))},remove:function(e,t){var i=this;this.removeFromModels(e),e.$status===te.Status.SavePending&&W.debug(W.Debugs.REMOVE_CANCEL_SAVE,i,e),e.$status=te.Status.RemovePending,e.$addOperation(ce)},removeFromModels:function(e){var t=this,i=e.$key();t.models.has(i)&&(t.models.remove(i),t.trigger(ee.Events.ModelRemoved,[e]),t.updated(),e.$trigger(te.Events.Removed))},refreshModel:function(e,t){e.$addOperation(ue,t)}},j(ee.prototype),te.Events={Created:"created",Saved:"saved",PreSave:"pre-save",PostSave:"post-save",PreRemove:"pre-remove",PostRemove:"post-remove",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",Change:"change",CreateAndSave:"created saved",UpdateAndSave:"updated saved",KeyUpdate:"key-update",RelationUpdate:"relation-update",Removed:"removed",RemoteUpdate:"remote-update",RemoteRemove:"remote-remove",RemoteAndRemove:"remote-remove removed",SavedRemoteUpdate:"saved remote-update",Changes:"saved remote-update key-update relation-update removed change"},te.Status={Synced:0,SavePending:1,RemovePending:2,Removed:3},te.prototype={$init:function(e,t){if(this.$status=te.Status.Synced,this.$operation=null,this.$relations={},t?this.$set(e,void 0,t):this.$reset(e),this.$db.loadRelations){var i=this.$db.relations;for(var n in i)this.$getRelation(n,t)}},$reset:function(e){var i=this.$db.defaults,n=this.$db.fields,s=this.$db.relations;if(d(i)){for(var r=0;r<n.length;r++){var o=n[r],a=i[o],h=L(a);this[o]=h}for(var o in s)if(o in i){var a=i[o],h=L(a),u=this.$getRelation(o);u.set(this,h)}}else for(var r=0;r<n.length;r++){var o=n[r];this[o]=t}this.$set(e)},$set:function(e,t,i){if(d(e))for(var n in e)this.$set(n,e[n],i);else if(r(e)){var s=this.$getRelation(e,i);s?s.set(this,t,i):this[e]=t}f(e)&&this.$trigger(te.Events.Change,[e,t])},$get:function(e,t){if(l(e))return T(this,e,t);if(d(e)){for(var i in e)e[i]=t?H(this[i]):this[i];return e}if(r(e)){var n=this.$getRelation(e);if(n){var s=n.get(this);return t?H(s):s}return t?H(this[e]):this[e]}},$relate:function(e,t){var i=this.$getRelation(e);i&&i.relate(this,t)},$unrelate:function(e,t){var i=this.$getRelation(e);i&&i.unrelate(this,t)},$isRelated:function(e,t){var i=this.$getRelation(e);return i&&i.isRelated(this,t)},$getRelation:function(e,t){var i=this.$db.relations;if(e in i){var n=i[e];return e in this.$relations||n.load(this,t),n}return!1},$save:function(e,t,i){var i=3===arguments.length?i!==!1:2===arguments.length&&d(e)?t!==!1:1===arguments.length?e!==!1:!0;this.$set(e,t),this.$trigger(te.Events.PreSave,[this]),this.$db.save(this,i),this.$trigger(te.Events.PostSave,[this])},$remove:function(e){this.$exists()&&(this.$trigger(te.Events.PreRemove,[this]),this.$db.remove(this,e),this.$trigger(te.Events.PostRemove,[this]))},$refresh:function(e){this.$db.refreshModel(this,e)},$exists:function(){return!this.$isDeleted()&&this.$db.models.has(this.$key())},$addOperation:function(e,t){var i=new e(this,t);this.$operation?this.$operation.queue(i):(this.$operation=i,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(T(this,this.$db.fields,!0)),i=this.$db.relations,n=this.$relations;for(var s in n)i[s].encode(this,t,e);return t},$change:function(){this.$trigger(te.Events.Change)},$key:function(){return this.$db.getKey(this)},$keys:function(){return this.$db.getKeys(this)},$hasKey:function(){return this.$db.hasFields(this,this.$db.key,f)},$isDeleted:function(){return this.$status>=te.Status.RemovePending},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(e){var t=this.$saved,i=e||this.$toJSON(!0),n=this.$db.saveFields;return t?U(i,t,n,w):i},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(!0),t=this.$saved;for(var i in e){var n=e[i],s=t[i];if(!w(n,s))return!0}return!1},toString:function(){return this.$db.className+" "+JSON.stringify(this.$toJSON())}},j(te.prototype,!0),ie.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,this.values.push(t),this.keys.push(e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return o(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],i=this.values.pop(),n=this.keys.pop();return e<this.values.length&&(this.values[e]=i,this.keys[e]=n,this.indices[n]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},subtract:function(e,t){for(var i=t||new ie,n=this.size(),s=this.values,r=this.keys,o=0;n>o;o++){var a=s[o],h=r[o];e.has(h)||i.put(h,a)}return i},filter:function(e,t){for(var i=t||new ie,n=this.size(),s=this.values,r=this.keys,o=0;n>o;o++){var a=s[o],h=r[o];e(a,h)&&i.put(h,a)}return i},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),i=0;t>i;i++)M(this.values,i,e-i),M(this.keys,i,e-i);return this.rebuildIndex(),this},isSorted:function(e){return x(e,this.values)},sort:function(e){function t(t,i){for(var s=n.values[Math.floor((i+t)/2)],r=t,o=i;o>=r;){for(;e(n.values[r],s)<0;)r++;for(;e(n.values[o],s)>0;)o--;o>=r&&(M(n.values,r,o),M(n.keys,r,o),r++,o--)}return r}function i(e,n){var s=t(e,n);s-1>e&&i(e,s-1),n>s&&i(s,n)}var n=this,s=this.size()-1;return s>0&&(i(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},ne.Events={Add:"add",Adds:"adds",Sort:"sort",Remove:"remove",Removes:"removes",Updates:"updates",Reset:"reset",Cleared:"cleared",Changes:"add adds sort remove removes reset"},S(Array,ne,{setComparator:function(e,t){return this.comparator=z(e,t),this.resort(),this},isSorted:function(e,t){var i=e?z(e,t):this.comparator;return x(i,this)},resort:function(e,t){var i=e?z(e,t):this.comparator;return x(i,this)||(this.sort(i),this.trigger(ne.Events.Sort,[this])),this},filtered:function(e,t,i){var n=J(e,t,i);return new se(this,n)},filter:function(e,t,i){for(var n=J(e,t,i),s=new this.constructor,r=0;r<this.length;r++){var o=this[r];n(o)&&s.add(o)}return s},subtract:function(e,t){for(var i=t||new this.constructor,n=0;n<this.length;n++){for(var s=this[n],r=!1,o=0;o<e.length&&!r;o++)r=w(s,e[o]);r||i.push(s)}return i},intersect:function(e,t){for(var i=t||new this.constructor,n=0;n<e.length;n++){for(var s=e[n],r=!1,o=0;o<this.length&&!r;o++)r=w(s,this[o]);r&&i.push(s)}return i},complement:function(e,t){for(var i=t||new this.constructor,n=0;n<e.length;n++){for(var s=e[n],r=!1,o=0;o<this.length&&!r;o++)r=w(s,this[o]);r||i.push(s)}return i},clear:function(){this.length=0,this.trigger(ne.Events.Cleared,[this])},add:function(e,t){this.push(e),this.trigger(ne.Events.Add,[this,e]),t||this.resort()},addAll:function(e,t){l(e)&&e.length&&(this.push.apply(this,e),this.trigger(ne.Events.Adds,[this,e]),t||this.resort())},removeAt:function(e,t){if(e>=0&&e<this.length){var i=this[e];this.splice(e,1),this.trigger(ne.Events.Remove,[this,i,e]),t||this.resort()}},remove:function(e){var t=this.indexOf(e);-1!==t&&this.removeAt(t)},removeAll:function(e,t,i){if(l(e)&&e.length){for(var n=[],s=0;s<e.length;s++){var r=e[s],o=this.indexOf(r,t);-1!==o&&(this.splice(o,1),n.push(r))}return this.trigger(ne.Events.Removes,[this,n]),i||this.resort(),n}},removeWhere:function(e,t,i){for(var n=J(e,t,i),s=[],r=this.length-1;r>=0;r--){var o=this[r];n(o)&&(this.splice(r,1),s.push(o))}return this.trigger(ne.Events.Removes,[this,s]),this.resort(),s},indexOf:function(e,t){for(var i=t||P,n=0;n<this.length;n++)if(i(e,this[n]))return n;return-1},insertAt:function(e,t,i){this.splice(e,0,t),this.trigger(ne.Events.Add,[this,t]),i||this.resort()},minModel:function(e){for(var i=z(e||this.comparator,!1),n=t,s=0;s<this.length;s++)i(n,this[s])>0&&(n=this[s]);return n},maxModel:function(e){for(var i=z(e||this.comparator,!0),n=t,s=0;s<this.length;s++)i(n,this[s])<0&&(n=this[s]);return n},min:function(e,i){for(var n=G(e,i),s=t,r=0;r<this.length;r++){var o=n(this[r]);Y(s,o,!1)>0&&(s=o)}return s},max:function(e,i){for(var n=G(e,i),s=t,r=0;r<this.length;r++){var o=n(this[r]);Y(s,o,!0)<0&&(s=o)}return s},firstWhere:function(e,t,i){for(var n=J(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return r}return null},first:function(e,t){for(var i=G(e,t),n=0;n<this.length;n++){var s=i(this[n]);if(f(s))return s}},lastWhere:function(e,t,i){for(var n=J(e,t,i),s=this.length-1;s>=0;s--){var r=this[s];if(n(r))return r}return null},last:function(e,t){for(var i=G(e,t),n=this.length-1;n>=0;n--){var s=i(this[n]);if(f(s))return s}},aggregate:function(e,t,i,n){for(var s=0;s<this.length;s++){var r=e(this[s]);t(r)&&i(r)}return n()},sum:function(e){function t(e){s+=e}function i(){return s}var n=B(e),s=0;return this.aggregate(n,o,t,i)},avg:function(e){function t(e){s+=e,r++}function i(){return 0===r?0:s/r}var n=B(e),s=0,r=0;return this.aggregate(n,o,t,i)},countWhere:function(e,t,i){for(var n=J(e,t,i),s=0,r=0;r<this.length;r++){var o=this[r];n(o)&&s++}return s},count:function(e){if(!f(e))return this.length;for(var t=G(e),i=0,n=0;n<this.length;n++){var s=t(this[n]);f(s)&&i++}return i},pluck:function(e,t,i,n){var s=G(e,i);if(t){for(var r=G(t,n),o={},a=0;a<this.length;a++){var h=this[a],u=s(h),l=r(h);o[l]=u}return o}for(var o=[],a=0;a<this.length;a++){var h=this[a],u=s(h);o.push(u)}return o},each:function(e,t){for(var i=0;i<this.length;i++)e.call(t,this[i],i);
},reduce:function(e,t){for(var i=0;i<this.length;i++)t=e(t,this[i]);return t},random:function(){var e=Math.floor(Math.random()*this.length);return this[e]},chunk:function(e,t){for(var i=t||[],n=0,s=i[n]=i[n]||[],r=0,o=0;o<this.length;o++)s[r]=this[o],++r>=e&&(r=0,n++,s.length=e,s=i[n]=i[n]||[]);return 0!==r&&n++,s.length=r,i.length=n,i},where:function(e,t,i){for(var n=J(e,t,i),s=[],r=0;r<this.length;r++){var o=this[r];n(o)&&s.push(o)}return s},contains:function(e,t,i){for(var n=J(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return!0}return!1},toArray:function(){var e=[];return e.push.apply(e,this),e},group:function(e){var t=G(e.by,e.bySeparator||"/"),i=q(e.having),s=e.select||{},o={};if(r(e.by))e.by in s||(s[e.by]="first");else if(l(e.by))for(var a in e.by)a in s||(s[a]="first");for(var h=0;h<this.length;h++){var u=this[h],d=t(u),c=o[d];c||(c=o[d]=new this.constructor),c.add(u,!0)}var f=new this.constructor;f.setComparator(e.comparator,e.comparatorNullsFirst);for(var d in o){var v={},g=o[d];for(var m in s){var E=s[m];r(E)?v[m]=g[E](m):n(E)&&(v[m]=E(g,m))}e.track!==!1&&(v.$group=g),e.count!==!1&&(v.$count=g.length),i(v)&&f.push(v)}return f.resort(),f}}),j(ne.prototype),S(ne,se,{init:function(e,t){this.base!==e&&(this.base&&this.disconnect(),this.base=e,this.connect()),this.filter=t,this.sync()},setFilter:function(e,t,i){this.filter=J(e,t,i),this.sync()},connect:function(){this.base.on(ne.Events.Add,this.onAdd,this),this.base.on(ne.Events.Adds,this.onAdds,this),this.base.on(ne.Events.Remove,this.onRemove,this),this.base.on(ne.Events.Removes,this.onRemoves,this),this.base.on(ne.Events.Reset,this.onReset,this),this.base.on(ne.Events.Updates,this.onUpdates,this),this.base.on(ne.Events.Cleared,this.onClear,this)},disconnect:function(){this.base.off(ne.Events.Add,this.onAdd),this.base.off(ne.Events.Adds,this.onAdds),this.base.off(ne.Events.Remove,this.onRemove),this.base.off(ne.Events.Removes,this.onRemoves),this.base.off(ne.Events.Reset,this.onReset),this.base.off(ne.Events.Updates,this.onUpdates),this.base.off(ne.Events.Cleared,this.onClear)},sync:function(){var e=this.base,t=this.filter;this.length=0;for(var i=0;i<e.length;i++){var n=e[i];t(n)&&this.push(n)}this.trigger(ne.Events.Reset,[this])},handleAdd:function(e,t){var i=this.filter;i(t)&&this.add(t)},handleAdds:function(e,t){for(var i=this.filter,n=[],s=0;s<t.length;s++){var r=t[s];i(r)&&n.push(r)}this.addAll(n)},handleRemove:function(e,t){this.remove(t)},handleRemoves:function(e,t){this.removeAll(t)},handleReset:function(e){this.sync()},handleUpdates:function(e,t){for(var i=this.filter,n=0;n<t.length;n++){var s=t[n];i(s)?this.add(s,!0):this.remove(s,!0)}this.resort()},handleCleared:function(e){this.clear()}}),S(ne,re,{init:function(e,t,i){this.map=new ie,this.map.values=this,this.database=e,this.reset(t,i)},resort:function(e,t){var i=e?z(e,t):this.comparator;x(i,this)||(this.map.sort(i),this.trigger(ne.Events.Sort,[this]))},subtract:function(e,t){for(var i=this.database,n=t||new this.constructor,s=0;s<this.length;s++){var r=this[s],o=r.$key(),a=!1;if(e instanceof re)a=e.has(o);else for(var s=0;s<e.length&&!a;s++){var h=i.buildKeyFromInput(e[s]);a=o===h}a||n.push(r)}return n},intersect:function(e,t){for(var i=this.database,n=t||new this.constructor,s=0;s<e.length;s++){var r=e[s],o=i.buildKeyFromInput(r);this.has(o)&&n.push(r)}return n},complement:function(e,t){for(var i=this.database,n=t||new this.constructor,s=0;s<e.length;s++){var r=e[s],o=i.buildKeyFromInput(r);this.has(o)||n.push(r)}return n},clear:function(){return this.map.reset()},reset:function(e,t){if(l(e)){var i=this.database;this.map.reset();for(var n=0;n<e.length;n++){var s=e[n],r=i.parseModel(s,t);r&&this.map.put(r.$key(),r)}this.trigger(ne.Events.Reset,[this]),this.resort()}},add:function(e,t){this.map.put(e.$key(),e),this.trigger(ne.Events.Add,[this,e]),t||this.resort()},addAll:function(e,t){if(l(e)){for(var i=0;i<e.length;i++){var n=e[i];this.map.put(n.$key(),n)}this.trigger(ne.Events.Adds,[this,e]),t||this.resort()}},put:function(e,t,i){this.map.put(e,t),this.trigger(ne.Events.Add,[this,t]),i||this.resort()},has:function(e){return this.map.has(e)},get:function(e){return this.map.get(e)},remove:function(e,t){var i=this.database,n=i.buildKeyFromInput(e),s=this.map.get(n);s&&(this.map.remove(n),this.trigger(ne.Events.Remove,[this,s,e]),t||this.resort())},removeAll:function(e,t){for(var i=this.database,n=[],s=0;s<e.length;s++){var r=i.buildKeyFromInput(e[s]),o=this.map.get(r);o&&(this.map.remove(r),n.push(o))}return this.trigger(ne.Events.Removes,[this,n]),t||this.resort(),n},indexOf:function(e){var i=this.database,n=i.buildKeyFromInput(e),s=this.map.indices[n];return s===t?-1:s},rebuild:function(){this.map.rebuildIndex()},keys:function(){return this.map.keys},reverse:function(){this.map.reverse()},removeWhere:function(e,t,i,n){for(var s=J(t,i,n),r=[],o=0;o<this.length;o++){var a=this[o],h=a.$key();s(a)&&(this.map.remove(h),r.push(a),e&&a.$remove())}return this.trigger(ne.Events.Removes,[this,r]),this.resort(),r},update:function(e,t,i){for(var n=0;n<this.length;n++){var s=this[n];s.$set(e,t,i),s.$save()}return this.trigger(ne.Events.Updates,[this,this]),this.resort(),this},updateWhere:function(e,t,i,n){for(var s=[],r=0;r<this.length;r++){var o=this[r];e(o)&&(o.$set(t,i,n),o.$save(),s.push(o))}return this.trigger(ne.Events.Updates,[this,s]),this.resort(),s}}),S(re,oe,{setWhere:function(e,t,i){this.where=J(e,t,i),this.sync()},connect:function(){this.database.on(ee.Events.ModelAdded,this.onModelAdd,this),this.database.on(ee.Events.ModelRemoved,this.onModelRemoved,this),this.database.on(ee.Events.ModelUpdated,this.onModelUpdated,this)},disconnect:function(){this.database.off(ee.Events.ModelAdded,this.onModelAdd),this.database.off(ee.Events.ModelRemoved,this.onModelRemoved),this.database.off(ee.Events.ModelUpdated,this.onModelUpdated)},sync:function(){var e=this.where,t=this.map,i=this.database.models;this.map.reset();for(var n=0;n<i.length;n++){var s=i[n];e(s)&&t.put(s.$key(),s)}this.trigger(ne.Events.Reset,[this])},handleModelAdded:function(e,t){this.where(e)&&this.add(e)},handleModelRemoved:function(e){this.remove(e)},handleModelUpdated:function(e,t){var i=e.$key();this.map.has(i)?this.where(e)||this.remove(e):this.where(e)&&this.add(e)}}),ae.Status={Pending:0,Success:1,Failure:2},ae.Events={Ready:"ready",Success:"success",Failure:"failure"},S(oe,ae,{setQuery:function(e,t,i){return this.query=e,t||this.sync(i),this},sync:function(e){return this.status=ae.Status.Pending,e&&this.cancel(),this.database.rest.query(this.query,this.onSuccess,this.onFailure),this},cancel:function(){return this.off(ae.Events.Ready),this.off(ae.Events.Success),this.off(ae.Events.Failure),this},ready:function(e,t){return this.status===ae.Status.Pending?this.once(ae.Events.Ready,e,t):e.call(t,this),this},success:function(e,t){return this.status===ae.Status.Pending?this.once(ae.Events.Success,e,t):this.status===ae.Status.Success&&e.call(t,this),this},failure:function(e,t){return this.status===ae.Status.Pending?this.once(ae.Events.Failure,e,t):this.status===ae.Status.Failure&&e.call(t,this),this},handleSuccess:function(){var e=this;return function(t){e.status=ae.Status.Success,e.reset(t,!0),e.trigger(ae.Events.Success,[e]),e.trigger(ae.Events.Ready,[e])}},handleFailure:function(){var e=this;return function(t,i){e.status=ae.Status.Failure,e.trigger(ae.Events.Failure,[e]),e.trigger(ae.Events.Ready,[e])}}}),he.prototype={reset:function(e,t){this.model=e,this.cascade=t!==!1,this.db=e.$db,this.next=null,this.finished=!1},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},execute:function(){this.db.pendingOperations++,this.run(this.db,this.model)},run:function(e,t){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute(),this.db.pendingOperations--,0===this.db.pendingOperations&&this.db.onOperationRest()),this},tryNext:function(e,t){var i=!this.next;return i&&(this.next=new e(this.model,t)),i},insertNext:function(e,t){var i=new e(this.model,t);i.next=this.next,this.next=i},success:function(){var e=this;return function(){e.onSuccess.apply(e,arguments),e.finish()}},onSuccess:function(){},failure:function(){var e=this;return function(){e.onFailure.apply(e,arguments),e.finish()}},onFailure:function(){}},A(he,ue,{interrupts:!1,type:"NeuroGetLocal",run:function(e,t){t.$isDeleted()?this.finish():e.cache===W.Cache.All?e.store.get(t.$key(),this.success(),this.failure()):this.cascade&&(W.debug(W.Debugs.GET_LOCAL_SKIPPED,t),this.insertNext(le),this.finish())},onSuccess:function(e,t){var i=this.model;d(t)&&i.$set(t),W.debug(W.Debugs.GET_LOCAL,i,t),this.cascade&&!i.$isDeleted()&&this.insertNext(le)},onFailure:function(e){var t=this.model;W.debug(W.Debugs.GET_LOCAL,t,e),this.cascade&&!t.$isDeleted()&&this.insertNext(le)}}),A(he,le,{interrupts:!1,type:"NeuroGetRemote",run:function(e,t){t.$isDeleted()?this.finish():e.rest.get(t,this.success(),this.failure())},onSuccess:function(e){var t=this.model;d(e)&&t.$set(e,void 0,!0),W.debug(W.Debugs.GET_REMOTE,t,e)},onFailure:function(e,t){var i=this.model;W.debug(W.Debugs.GET_REMOTE_ERROR,i,e,t)}}),A(he,de,{interrupts:!0,type:"NeuroRemoveCache",run:function(e,t){e.cache==W.Cache.None?this.finish():e.store.remove(t.$key(),this.success(),this.failure())}}),A(he,ce,{interrupts:!0,type:"NeuroRemoveLocal",run:function(e,t){t.$status=te.Status.RemovePending,e.cache!==W.Cache.None&&t.$local?t.$saved?(t.$local.$status=t.$status,e.store.put(t.$key(),t.$local,this.success(),this.failure())):(W.debug(W.Debugs.REMOVE_LOCAL_UNSAVED,t),e.store.remove(t.$key(),this.success(),this.failure())):(W.debug(W.Debugs.REMOVE_LOCAL_NONE,t),this.insertNext(ve),this.finish())},onSuccess:function(e,t,i){var n=this.model;W.debug(W.Debugs.REMOVE_LOCAL,n),n.$saved&&this.cascade&&n.$addOperation(ve)},onFailure:function(e){var t=this.model;W.debug(W.Debugs.REMOVE_LOCAL_ERROR,t,e),t.$saved&&this.cascade&&t.$addOperation(ve)}}),A(he,fe,{interrupts:!0,type:"NeuroRemoveNow",run:function(e,t){var i=t.$key();t.$status=te.Status.RemovePending,e.removeFromModels(t),e.cache===W.Cache.None?(this.finishRemove(),this.finish()):e.store.remove(i,this.success(),this.failure())},onSuccess:function(){this.finishRemove()},onFailure:function(){this.finishRemove()},finishRemove:function(){var e=this.model;e.$status=te.Status.Removed,delete e.$local,delete e.$saving,delete e.$publish,delete e.$saved}}),A(he,ve,{interrupts:!0,type:"NeuroRemoveRemote",run:function(e,t){t.$status=te.Status.RemovePending,e.rest.remove(t,this.success(),this.failure())},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var i=this.key,n=this.model;404===t||410===t?(W.debug(W.Debugs.REMOVE_MISSING,n,i),this.finishRemove()):0!==t?W.debug(W.Debugs.REMOVE_ERROR,n,t,i):(W.checkNetworkStatus(),W.online||W.once("online",this.handleOnline,this),W.debug(W.Debugs.REMOVE_OFFLINE,n))},finishRemove:function(){var e=this.db,t=this.key,i=this.model;W.debug(W.Debugs.REMOVE_REMOTE,i,t),i.$status=te.Status.Removed,this.insertNext(fe),W.debug(W.Debugs.REMOVE_PUBLISH,i,t),e.live({op:ee.Live.Remove,key:t})},handleOnline:function(){var e=this.model;W.debug(W.Debugs.REMOVE_RESUME,e),e.$addOperation(ve)}}),A(he,ge,{interrupts:!1,type:"NeuroSaveLocal",run:function(e,t){if(t.$isDeleted())W.debug(W.Debugs.SAVE_LOCAL_DELETED,t),this.finish();else if(e.cache===W.Cache.None)this.cascade&&this.tryNext(Ee)&&this.markSaving(e,t),this.finish();else{var i=t.$key(),n=t.$toJSON(!1);this.markSaving(e,t),t.$local?y(n,t.$local):(t.$local=n,t.$saved&&(t.$local.$saved=t.$saved)),t.$local.$status=t.$status,t.$local.$saving=t.$saving,t.$local.$publish=t.$publish,e.store.put(i,t.$local,this.success(),this.failure())}},markSaving:function(e,t){var i=t.$toJSON(!0),n=t.$getChanges(i),s=e.fullSave?i:n,r=e.fullPublish?i:n;t.$status=te.Status.SavePending,t.$saving=s,t.$publish=r},clearLocal:function(e){e.$status=te.Status.Synced,e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish,this.insertNext(me)},onSuccess:function(e,t,i){var n=this.model;W.debug(W.Debugs.SAVE_LOCAL,n),this.cascade?this.tryNext(Ee):this.clearLocal(n)},onFailure:function(e){var t=this.model;W.debug(W.Debugs.SAVE_LOCAL_ERROR,t,e),this.cascade?this.tryNext(Ee):this.clearLocal(t)}}),A(he,me,{interrupts:!1,type:"NeuroSaveNow",run:function(e,t){var i=t.$key(),n=t.$local;e.cache===W.Cache.All&&i&&n?e.store.put(i,n,this.success(),this.failure()):this.finish()}}),A(he,Ee,{interrupts:!1,type:"NeuroSaveRemote",run:function(e,t){t.$isDeleted()?(W.debug(W.Debugs.SAVE_REMOTE_DELETED,t),this.finish()):V(t.$saving)?(this.markSynced(t,!0),this.finish()):(t.$status=te.Status.SavePending,t.$saved?e.rest.update(t,t.$saving,this.success(),this.failure()):e.rest.create(t,t.$saving,this.success(),this.failure()))},onSuccess:function(e){var t=this.model;W.debug(W.Debugs.SAVE_REMOTE,t),this.handleData(e)},onFailure:function(e,t){var i=(this.db,this.model);409===t?(W.debug(W.Debugs.SAVE_CONFLICT,i,e),this.handleData(e)):410===t||404===t?(W.debug(W.Debugs.SAVE_UPDATE_FAIL,i),this.insertNext(fe)):0!==t?(W.debug(W.Debugs.SAVE_ERROR,i,t),this.markSynced(i,!0)):(W.checkNetworkStatus(),W.online?this.markSynced(i,!0):W.once("online",this.handleOnline,this),W.debug(W.Debugs.SAVE_OFFLINE,i))},markSynced:function(e,t){e.$status=te.Status.Synced,this.clearPending(e),t&&this.insertNext(me)},clearPending:function(e){delete e.$saving,delete e.$publish,e.$local&&(e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish)},handleData:function(e){var t=this.db,i=this.model,n=i.$saving,s=i.$publish;return i.$isDeleted()?(W.debug(W.Debugs.SAVE_REMOTE_DELETED,i,e),this.clearPending(i)):(W.debug(W.Debugs.SAVE_VALUES,i,n),i.$saved||(i.$saved=i.$local?i.$local.$saved={}:{}),y(n,i.$saved),V(e)||t.putRemoteData(e,i.$key(),i),W.debug(W.Debugs.SAVE_PUBLISH,i,s),t.live({op:ee.Live.Save,model:i.$publish,key:i.$key()}),this.markSynced(i,!1),void(t.cache===W.Cache.Pending?this.insertNext(de):this.insertNext(me)))},handleOnline:function(){var e=this.model;e.$status===te.Status.SavePending&&(e.$addOperation(Ee),W.debug(W.Debugs.SAVE_RESUME,e))}}),W.Relations={},W.Store={None:0,Model:1,Key:2,Keys:3},W.Save={None:0,Model:4},pe.Defaults={model:t,store:W.Store.None,save:W.Save.None,auto:!0,property:!0},pe.prototype={getDefaults:function(e,t,i){return pe.Defaults},init:function(e,t,i){O(this,i,this.getDefaults(e,t,i)),this.database=e,this.name=t,this.options=i,this.pendingLoads=[],this.pendingRemoteDatas=[],this.initialized=!1,this.discriminator=i.discriminator||"discriminator",this.discriminators=i.discriminators||{},this.discriminated=!!i.discriminators;var n=this.setNeuro(e,t,i);s(i.model)?n.call(this,i.model):W.get(i.model,n,this)},setNeuro:function(e,t,i){return function(n){this.model=n,this.property||(this.property=v(e.fields,this.name)!==!1),this.discriminated&&this.loadDiscriminators(),this.onInitialized(e,t,i)}},onInitialized:function(e,t,i){},finishInitialization:function(){this.initialized=!0;for(var e=this.pendingLoads,t=this.pendingRemoteDatas,i=0;i<e.length;i++)this.handleLoad(e[i],t[i]);e.length=0,t.length=0},load:function(e,t){this.initialized?this.handleLoad(e,t):(this.pendingLoads.push(e),this.pendingRemoteDatas.push(t))},handleLoad:function(e,t){},set:function(e,t,i){},relate:function(e,t){},unrelate:function(e,t){},isRelated:function(e,t){},get:function(e){},encode:function(e,t,i){},isModelArray:function(e){if(!l(e))return!1;var t=this.model.Database,i=t.key;if(!l(i))return!0;if(i.length!==e.length)return!0;for(var n=0;n<e.length;n++)if(!o(e[n])&&!r(e[n]))return!0;return!1},clearFields:function(e,t,i){var n=!1;if(r(t))e[t]&&(e[t]=null,n=!0);else for(var s=0;s<t.length;s++){var o=t[s];e[o]&&(e[o]=null,n=!0)}return n&&!i&&this.auto&&!e.$isNew()&&e.$save(),n},updateFields:function(e,t,i,n,s){var o=!1;if(i.$key(),r(t)){var a=e[t],h=i[n];w(a,h)||(e[t]=h,o=!0)}else for(var u=0;u<t.length;u++){var l=t[u],a=e[l],d=n[u],c=i[d];w(a,c)||(e[l]=H(c),o=!0)}return o&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(te.Events.KeyUpdate,[e,i,t,n])),o},getStoredArray:function(e,t){if(!t)return null;for(var i=[],n=0;n<e.length;n++){var s=this.getStored(e[n],t);null!==s&&i.push(s)}return i},getStored:function(e,t){if(e)switch(t){case W.Save.Model:return e.$toJSON(!0);case W.Store.Model:if(e.$local)return e.$local;var i=e.$toJSON(!1);return e.$saved&&(i.$saved=e.$saved),i;case W.Store.Key:return e.$key();case W.Store.Keys:return e.$keys()}return null},loadDiscriminators:function(){for(var e in this.discriminators){var t=this.discriminators[e];W.get(t,this.setDiscriminated,this)}},setDiscriminated:function(e){return function(t){this.discriminators[e]=t}},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e);if(t in this.discriminators){var e=this.discriminators[t];return e.Database}return!1},parseDiscriminated:function(e){if(d(e)){var t=this.getDiscriminatorDatabase(e);return t.parseModel(e)}return!1},grabModel:function(e,t,i,n){if(this.discriminated){if(this.grabDiscriminated(i,n))return!0;this.getDiscriminatorByType(t)}},grabDiscriminated:function(e,t){if(d(e)){var i=this.getDiscriminatorDatabase(e);if(i!==!1)return i.grabModel(e,callack,this),!0}return!0},getDiscriminatorByType:function(e){for(var t in this.discriminators){var i=this.discriminators[t];if(e instanceof i)return t}return!1},loadAllRelated:function(e,t){if(this.discriminated)this.loadAllDiscriminated(e,t);else{var i=this.model.Database;i.ready(this.loadAllReady(e,t),this)}},loadAllReady:function(e,t){return function(i){var n=i.models.filter(e);t.call(this,n)}},loadAllDiscriminated:function(e,t){var i=new ie,n=this,s=F(this.discriminators),r=0;for(var o in this.discriminators){var a=this.discriminators[o],h=a.Database;h.ready(function(o){o.models.filter(e,i),++r===s&&t.call(n,i)})}}},W.Relations.belongsTo=Re,Re.Defaults={model:t,store:W.Store.None,save:W.Save.None,auto:!0,property:!0,local:null,cascade:!0},A(pe,Re,{type:"belongsTo",getDefaults:function(e,t,i){return Re.Defaults},onInitialized:function(e,t,i){var n=this.model.Database;this.local=this.local||n.name+"_"+n.key,W.debug(W.Debugs.BELONGSTO_INIT,this),this.finishInitialization()},handleLoad:function(e,t){var i=this,n=this.isRelatedFactory(e),s=this.model.Database,r=e[this.name],o=e.$relations[this.name]={parent:e,initial:r,isRelated:n,model:null,loaded:!1,onRemoved:function(){W.debug(W.Debugs.BELONGSTO_NINJA_REMOVE,i,e,o),this.cascade?e.$remove(this.cascade):this.clearRelated(o)},onSaved:function(){W.debug(W.Debugs.BELONGSTO_NINJA_SAVE,i,e,o),n(o.model)||(this.cascade?e.$remove(this.cascade):this.clearRelated(o))}};e.$on(te.Events.KeyUpdate,this.onKeyUpdate,this),e.$on(te.Events.PostRemove,this.postRemove,this),V(r)&&s.hasFields(e,this.local,f)&&(r=I(e,this.local),W.debug(W.Debugs.BELONGSTO_INITIAL_PULLED,this,e,r)),V(r)||(W.debug(W.Debugs.BELONGSTO_INITIAL,this,e,r),s.grabModel(r,this.handleModel(o,t),this,t))},set:function(e,t,i){if(V(t))this.unrelate(e);else{var n=this.model.Database,s=n.parseModel(t,i),r=e.$relations[this.name];s&&!r.isRelated(s)&&(this.clearModel(r),this.setRelated(r,s,i))}},relate:function(e,t){var i=this.model.Database,n=i.parseModel(t),s=e.$relations[this.name];n&&s.model!==n&&(this.clearModel(s),this.setRelated(s,n))},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=i.parseModel(t);s&&n.model!==s||this.clearRelated(n)},isRelated:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=i.parseModel(t);return s===n.model},setRelated:function(e,t,i){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t,i),this.setProperty(e))},clearRelated:function(e){this.clearModel(e),this.clearForeignKey(e.parent),this.setProperty(e)},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;n&&s&&(t[this.name]=this.getStored(n.model,s))},postRemove:function(e){var t=e.$relations[this.name];t&&(W.debug(W.Debugs.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t),this.setProperty(t))},clearModel:function(e){var t=e.model;t&&(W.debug(W.Debugs.BELONGSTO_CLEAR_MODEL,this,e),t.$off(te.Events.Saved,e.onSaved),t.$off(te.Events.Removed,e.onRemoved),e.model=null,e.loaded=!0)},setModel:function(e,t){t.$on(te.Events.Saved,e.onSaved,this),t.$on(te.Events.Removed,e.onRemoved,this),e.model=t,e.loaded=!0,W.debug(W.Debugs.BELONGSTO_SET_MODEL,this,e)},handleModel:function(e,t){return function(i){W.debug(W.Debugs.BELONGSTO_LOADED,this,e.parent,e,i),e.loaded===!1&&(i&&!i.$isDeleted()?(this.setModel(e,i,t),this.updateForeignKey(e.parent,i,t)):this.clearForeignKey(e.parent,t),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.model.Database,i=this.local,n=t.key;return function(t){return p(e,i,t,n)}},clearForeignKey:function(e,t){var i=this.local;W.debug(W.Debugs.BELONGSTO_CLEAR_KEY,this,e,i),this.clearFields(e,i,t)},updateForeignKey:function(e,t,i){var n=this.model.Database,s=this.local,r=n.key;W.debug(W.Debugs.BELONGSTO_UPDATE_KEY,this,e,s,t,r),this.updateFields(e,s,t,r,i)},setProperty:function(e){if(this.property){var t=e.parent,i=e.model;t[this.name]!==i&&(t[this.name]=i,t.$trigger(te.Events.RelationUpdate,[this,e]))}},onKeyUpdate:function(e,t,i,n){if(this.local===i){var s=e.$relations[this.name];s&&t!==s.model&&(this.clearModel(s),this.setModel(s,t),this.setProperty(s))}}}),W.Relations.hasMany=Ae,Ae.Defaults={model:t,store:W.Store.None,save:W.Save.None,auto:!0,property:!0,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:!0,cascadeSave:!0},A(pe,Ae,{type:"hasMany",getDefaults:function(e,t,i){return Ae.Defaults},onInitialized:function(e,t,i){this.foreign=this.foreign||e.name+"_"+e.key,this.comparator=z(this.comparator,this.comparatorNullsFirst),this.clearKey=this.ownsForeignKey(),W.debug(W.Debugs.HASMANY_INIT,this),this.finishInitialization()},handleLoad:function(e,t){var i=this,n=this.model.Database,s=this.isRelatedFactory(e),r=new be(n,e,this),o=e[this.name],a=e.$relations[this.name]={parent:e,isRelated:s,initial:o,pending:{},models:r,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){W.debug(W.Debugs.HASMANY_NINJA_REMOVE,i,e,this,a),i.removeModel(a,this,!0)},onSaved:function(){a.saving||(W.debug(W.Debugs.HASMANY_NINJA_SAVE,i,e,this,a),s(this)?(i.sort(a),i.checkSave(a)):i.removeModel(a,this))}};if(e.$key(),e.$on(te.Events.PostSave,this.postSave,this),e.$on(te.Events.PreRemove,this.preRemove,this),n.on(ee.Events.ModelAdded,this.handleModelAdded(a),this),l(o)){W.debug(W.Debugs.HASMANY_INITIAL,this,e,a,o);for(var h=0;h<o.length;h++){var u=o[h],d=n.buildKeyFromInput(u);a.pending[d]=!0,n.grabModel(u,this.handleModel(a),this,t)}}else W.debug(W.Debugs.HASMANY_INITIAL_PULLED,this,e,a),n.ready(this.handleLazyLoad(a),this);this.setProperty(a)},bulk:function(e,t,i){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,i)},set:function(e,t,i){if(V(t))this.unrelate(e);else{var n=this.model.Database,s=e.$relations[this.name],r=s.models,o=new re(n);if(this.isModelArray(t))for(var a=0;a<t.length;a++){var h=n.parseModel(t[a],i);h&&o.add(h)}else{var h=n.parseModel(t,i);h&&o.add(h)}var u=r.subtract(o),l=o.subtract(r);this.bulk(s,function(){for(var e=0;e<l.length;e++)this.addModel(s,l[e],i);for(var e=0;e<u.length;e++)this.removeModel(s,u[e])},i)}},relate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=i.parseModel(t[e]);s&&this.addModel(n,s)}});else if(f(t)){var s=i.parseModel(t);s&&this.addModel(n,s)}},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=i.parseModel(t[e]);s&&this.removeModel(n,s)}});else if(f(t)){var s=i.parseModel(t);s&&this.removeModel(n,s)}else{var r=n.models;this.bulk(n,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(n,r[e])})}},isRelated:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=n.models;if(this.isModelArray(t)){for(var r=0;r<t.length;r++){var o=i.parseModel(t[r]);if(o&&!s.has(o.$key()))return!1}return t.length>0}if(f(t)){var o=i.parseModel(t);return o&&s.has(o.$key())}return!1},get:function(e){var t=e.$relations[this.name];return t.models},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;n&&s&&(t[this.name]=this.getStoredArray(n.models,s))},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){W.debug(W.Debugs.HASMANY_POSTSAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var i=t.models,n=0;n<i.length;n++){var s=i[n];!s.$isDeleted()&&s.$hasChanges()&&s.$save()}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(W.debug(W.Debugs.HASMANY_PREREMOVE,this,e,t),this.bulk(t,function(){for(var e=t.models,i=0;i<e.length;i++){var n=e[i];n.$remove()}}))},checkSave:function(e,t){e.delaySaving||t||(this.store===W.Store.Model||this.save===W.Save.Model)&&(W.debug(W.Debugs.HASMANY_AUTO_SAVE,this,e),e.parent.$save())},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&(W.debug(W.Debugs.HASMANY_NINJA_ADD,this,e,t),this.addModel(e,t,i))}},handleModel:function(e){return function(t){var i=e.pending,n=t.$key();n in i&&(W.debug(W.Debugs.HASMANY_INITIAL_GRABBED,this,e,t),this.addModel(e,t,!0),delete i[n])}},handleLazyLoad:function(e){return function(t){var i=t.models.filter(e.isRelated);W.debug(W.Debugs.HASMANY_LAZY_LOAD,this,e,i),this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModel(e,i[t])})}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=e.models,s=t.$key(),r=!n.has(s);return r&&(W.debug(W.Debugs.HASMANY_ADD,this,e,t),n.put(s,t),t.$on(te.Events.Removed,e.onRemoved),t.$on(te.Events.SavedRemoteUpdate,e.onSaved),this.updateForeignKey(e.parent,t,i),this.sort(e),i||this.checkSave(e)),r}},removeModel:function(e,t,i){var n=e.models,s=e.pending,r=t.$key();n.has(r)&&(W.debug(W.Debugs.HASMANY_REMOVE,this,e,t),n.remove(r),t.$off(te.Events.Removed,e.onRemoved),t.$off(te.Events.SavedRemoteUpdate,e.onSaved),!i&&this.cascadeRemove&&t.$remove(),this.clearForeignKey(t),this.sort(e),this.checkSave(e)),delete s[r]},ownsForeignKey:function(){var e=this.foreign,t=this.model.Database.key;if(r(e))return l(t)?v(t,e)===!1:t!==e;if(l(t)){for(var i=0;i<e.length;i++)if(v(t,e[i])!==!1)return!1;return!0}return v(e,t)===!1},updateForeignKey:function(e,t,i){var n=this.foreign,s=e.$db.key;this.updateFields(t,n,e,s,i)},clearForeignKey:function(e){if(this.clearKey){var t=this.foreign;this.clearFields(e,t)}},isRelatedFactory:function(e){var t=this.foreign,i=e.$db.key;return function(n){return p(n,t,e,i)}},setProperty:function(e){this.property&&(e.parent[this.name]=e.models)},sort:function(e){var t=e.models;e.delaySorting||(W.debug(W.Debugs.HASMANY_SORT,this,e),t.resort(this.comparator),e.parent.$trigger(te.Events.RelationUpdate,[this,e]))}}),W.Relations.hasManyThrough=$e,$e.Defaults={model:t,store:W.Store.None,save:W.Save.None,auto:!0,property:!0,through:t,local:null,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:!0,cascadeSave:!0,cascadeSaveRelated:!1},A(pe,$e,{type:"hasManyThrough",getDefaults:function(e,t,i){return $e.Defaults},onInitialized:function(e,t,i){var n=this.model.Database;this.foreign=this.foreign||n.name+"_"+n.key,this.local=this.local||e.name+"_"+e.key,this.comparator=z(this.comparator,this.comparatorNullsFirst),s(i.through)?this.setThrough(i.through):W.get(i.through,this.setThrough,this),W.debug(W.Debugs.HASMANYTHRU_INIT,this)},setThrough:function(e){this.through=e,this.finishInitialization()},handleLoad:function(e,t){var i=this,n=this.model.Database,s=this.through.Database,r=new be(n,e,this),o=this.isRelatedFactory(e),a=e[this.name],h=e.$relations[this.name]={parent:e,isRelated:o,initial:a,pending:{},models:r,throughs:new ie,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){W.debug(W.Debugs.HASMANYTHRU_NINJA_REMOVE,i,e,this,h),i.removeModel(h,this)},onSaved:function(){h.saving||(W.debug(W.Debugs.HASMANYTHRU_NINJA_SAVE,i,e,this,h),i.sort(h),i.checkSave(h))},onThroughRemoved:function(){W.debug(W.Debugs.HASMANYTHRU_NINJA_THRU_REMOVE,i,e,this,h),i.removeModelFromThrough(h,this)}};if(e.$key(),e.$on(te.Events.PostSave,this.postSave,this),e.$on(te.Events.PreRemove,this.preRemove,this),s.on(ee.Events.ModelAdded,this.handleModelAdded(h),this),l(a)){W.debug(W.Debugs.HASMANYTHRU_INITIAL,this,e,h,a);for(var u=0;u<a.length;u++){var d=a[u],c=n.buildKeyFromInput(d);h.pending[c]=!0,n.grabModel(d,this.handleModel(h),this,t)}}else W.debug(W.Debugs.HASMANYTHRU_INITIAL_PULLED,this,e,h),s.ready(this.handleLazyLoad(h),this);this.setProperty(h)},bulk:function(e,t,i){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,i)},set:function(e,t,i){if(V(t))this.unrelate(e);else{var n=this.model.Database,s=e.$relations[this.name],r=s.models,o=new re(n);if(this.isModelArray(t))for(var a=0;a<t.length;a++){var h=n.parseModel(t[a],i);h&&o.add(h)}else{var h=n.parseModel(t,i);h&&o.add(h)}var u=r.subtract(o),l=o.subtract(r);this.bulk(s,function(){for(var e=0;e<l.length;e++)this.addModel(s,l[e],i);for(var e=0;e<u.length;e++)this.removeModel(s,u[e])},i)}},relate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=i.parseModel(t[e]);s&&this.addModel(n,s)}});else if(f(t)){var s=i.parseModel(t);s&&this.addModel(n,s)}},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=i.parseModel(t[e]);s&&this.removeModel(n,s)}});else if(f(t)){var s=i.parseModel(t);s&&this.removeModel(n,s)}else{var r=n.models;this.bulk(n,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(n,r[e])})}},isRelated:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=n.models;if(this.isModelArray(t)){for(var r=0;r<t.length;r++){var o=i.parseModel(t[r]);if(o&&!s.has(o.$key()))return!1}return t.length>0}if(f(t)){var o=i.parseModel(t);return o&&s.has(o.$key())}return!1},get:function(e){var t=e.$relations[this.name];return t.models},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;n&&s&&(t[this.name]=this.getStoredArray(n.models,s))},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSaveRelated){W.debug(W.Debugs.HASMANYTHRU_PRESAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var i=t.models,n=0;n<i.length;n++){var s=i[n];!s.$isDeleted()&&s.$hasChanges()&&s.$save()}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(W.debug(W.Debugs.HASMANYTHRU_PREREMOVE,this,e,t),this.bulk(t,function(){for(var e=t.throughs,i=0;i<e.length;i++){var n=e[i];n.$remove()}}))},checkSave:function(e,t){e.delaySaving||t||(this.store===W.Store.Model||this.save===W.Save.Model)&&(W.debug(W.Debugs.HASMANYTHRU_AUTO_SAVE,this,e),e.parent.$save())},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&!e.throughs.has(t.$key())&&(W.debug(W.Debugs.HASMANYTHRU_NINJA_ADD,this,e,t),this.addModelFromThrough(e,t,i))}},handleModel:function(e){return function(t){var i=e.pending,n=t.$key();n in i&&(W.debug(W.Debugs.HASMANYTHRU_INITIAL_GRABBED,this,e,t),this.addModel(e,t,!0),delete i[n])}},handleLazyLoad:function(e){return function(t){var i=t.models,n=i.filter(e.isRelated);0!==n.length&&(W.debug(W.Debugs.HASMANYTHRU_LAZY_LOAD,this,e,n),this.bulk(e,function(){for(var t=0;t<n.length;t++)this.addModelFromThrough(e,n[t])}))}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=this.finishAddModel(e,t,i);return n&&this.addThrough(e,t,i),n}},addThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t);n.grabModel(s,this.onAddThrough(e,i),this,i)},onAddThrough:function(e,t){
return function(i){this.finishAddThrough(e,i,t)}},addModelFromThrough:function(e,t,i){if(!t.$isDeleted()){var n=this.model.Database,s=n.buildKey(t,this.foreign);n.grabModel(s,this.onAddModelFromThrough(e,t,i),this,i)}},onAddModelFromThrough:function(e,t,i){return function(n){n&&(this.finishAddThrough(e,t,i),this.finishAddModel(e,n,i))}},finishAddThrough:function(e,t,i){var n=e.throughs,s=t.$key();n.has(s)||(W.debug(W.Debugs.HASMANYTHRU_THRU_ADD,this,e,t),n.put(s,t),t.$on(te.Events.Removed,e.onThroughRemoved),!i&&this.cascadeSave&&t.$save())},finishAddModel:function(e,t,i){var n=e.models,s=t.$key(),r=!n.has(s);return r&&(W.debug(W.Debugs.HASMANYTHRU_ADD,this,e,t),n.put(s,t),t.$on(te.Events.Removed,e.onRemoved),t.$on(te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r},removeModel:function(e,t,i){var n=t.$key();this.finishRemoveRelated(e,n)&&this.removeThrough(e,t,i)},removeThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t),r=n.getKey(s),o=e.throughs,a=o.get(r);this.finishRemoveThrough(e,a,t,!0)},removeModelFromThrough:function(e,t){var i=this.model.Database,n=i.buildKey(t,this.foreign);this.finishRemoveThrough(e,t)&&this.finishRemoveRelated(e,n)},finishRemoveThrough:function(e,t,i,n){var s=!!t;if(s){W.debug(W.Debugs.HASMANYTHRU_THRU_REMOVE,this,e,t,i);var r=e.throughs,o=t.$key();t.$off(te.Events.Removed,e.onThroughRemoved),n&&t.$remove(),r.remove(o)}return s},finishRemoveRelated:function(e,t){var i=e.pending,n=e.models,s=n.get(t);return s&&(W.debug(W.Debugs.HASMANYTHRU_REMOVE,this,e,s),n.remove(t),s.$off(te.Events.Removed,e.onRemoved),s.$off(te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete i[t],s},isRelatedFactory:function(e){var t=e.$db.key,i=this.local;return function(n){return p(n,i,e,t)}},setProperty:function(e){this.property&&(e.parent[this.name]=e.models)},sort:function(e){var t=e.models;e.delaySorting||(W.debug(W.Debugs.HASMANYTHRU_SORT,this,e),t.resort(this.comparator),e.parent.$trigger(te.Events.RelationUpdate,[this,e]))},createThroughKey:function(e,t){for(var i=e.parent,n=i.$db,s=this.model.Database,r=this.through.Database,o=r.key,a={},h=0;h<o.length;h++){var u=o[h];if(u===this.foreign)a[u]=t.$key();else if(u===this.local)a[u]=i.$key();else if(l(this.foreign)){var d=v(this.foreign,u),c=s.key[d];a[u]=t[c]}else if(l(this.local)){var d=v(this.local,u),c=n.key[d];a[u]=i[c]}}return a}}),W.Relations.hasOne=Se,Se.Defaults={model:t,store:W.Store.None,save:W.Save.None,auto:!0,property:!0,local:null,cascade:!0},A(pe,Se,{type:"hasOne",getDefaults:function(e,t,i){return Se.Defaults},onInitialized:function(e,t,i){var n=this.model.Database;this.local=this.local||n.name+"_"+n.key,W.debug(W.Debugs.HASONE_INIT,this),this.finishInitialization()},handleLoad:function(e,t){var i=this,n=this.isRelatedFactory(e),s=this.model.Database,r=e[this.name],o=e.$relations[this.name]={parent:e,initial:r,isRelated:n,model:null,loaded:!1,dirty:!1,saving:!1,onRemoved:function(){W.debug(W.Debugs.HASONE_NINJA_REMOVE,i,e,o),this.clearRelated(o)},onSaved:function(){o.saving||(W.debug(W.Debugs.HASONE_NINJA_SAVE,i,e,o),n(o.model)||this.clearRelated(o))}};e.$on(te.Events.PreSave,this.preSave,this),e.$on(te.Events.PostRemove,this.postRemove,this),V(r)&&s.hasFields(e,this.local,f)&&(r=I(e,this.local),W.debug(W.Debugs.HASONE_INITIAL_PULLED,this,e,r)),V(r)||(W.debug(W.Debugs.HASONE_INITIAL,this,e,r),s.grabModel(r,this.handleModel(o),this,t))},set:function(e,t,i){if(V(t))this.unrelate(e);else{var n=this.model.Database,s=n.parseModel(t,i),r=e.$relations[this.name];s&&!r.isRelated(s)&&(this.clearModel(r),this.setRelated(r,s))}},relate:function(e,t){var i=this.model.Database,n=i.parseModel(t),s=e.$relations[this.name];n&&s.model!==n&&(this.clearModel(s),this.setRelated(s,n))},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=i.parseModel(t);s&&n.model!==s||this.clearRelated(n)},isRelated:function(e,t){var i=this.model.Database,n=e.$relations[this.name],s=i.parseModel(t);return s===n.model},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;n&&s&&(t[this.name]=this.getStored(n.model,s))},preSave:function(e){var t=e.$relations[this.name];if(t&&t.model){var i=t.model;(t.dirty||i.$hasChanges())&&(W.debug(W.Debugs.HASONE_PRESAVE,this,e,t),t.saving=!0,i.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade&&(W.debug(W.Debugs.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},setRelated:function(e,t){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t),this.setProperty(e))},clearRelated:function(e){this.clearModel(e),this.clearForeignKey(e.parent),this.setProperty(e)},clearModel:function(e){var t=e.model;t&&(W.debug(W.Debugs.HASONE_CLEAR_MODEL,this,e),t.$off(te.Events.Saved,e.onSaved),t.$off(te.Events.Removed,e.onRemoved),this.cascade&&!t.$isDeleted()&&t.$remove(),e.model=null,e.dirty=!0,e.loaded=!0)},setModel:function(e,t){t.$on(te.Events.Saved,e.onSaved,this),t.$on(te.Events.Removed,e.onRemoved,this),e.model=t,e.dirty=!0,e.loaded=!0,W.debug(W.Debugs.HASONE_SET_MODEL,this,e)},handleModel:function(e){return function(t){W.debug(W.Debugs.HASONE_LOADED,this,e.parent,e,t),e.loaded===!1&&(t&&!t.$isDeleted()?(this.setModel(e,t),this.updateForeignKey(e.parent,t)):this.clearForeignKey(e.parent),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.model.Database,i=this.local,n=t.key;return function(t){return p(e,i,t,n)}},clearForeignKey:function(e){var t=this.local;W.debug(W.Debugs.HASONE_CLEAR_KEY,this,e,t),this.clearFields(e,t)},updateForeignKey:function(e,t){var i=this.model.Database,n=this.local,s=i.key;W.debug(W.Debugs.HASONE_UPDATE_KEY,this,e,n,t,s),this.updateFields(e,n,t,s)},setProperty:function(e){if(this.property){var t=e.parent,i=e.model;t[this.name]!==i&&(t[this.name]=i,t.$trigger(te.Events.RelationUpdate,[this,e]))}}}),S(re,be,{set:function(e){this.relator.set(this.model,e)},relate:function(e){this.relator.relate(this.model,e)},unrelate:function(e){this.relator.unrelate(this.model,e)},isRelated:function(e){return this.relator.isRelated(this.model,e)}}),e.Neuro=W,e.Neuro.Model=te,e.Neuro.Database=ee,e.Neuro.Relation=pe,e.Neuro.Operation=he,e.Neuro.Map=ie,e.Neuro.Collection=ne,e.Neuro.ModelCollection=re,e.Neuro.Query=oe,e.Neuro.RemoteQuery=ae,e.Neuro.isNeuro=s,e.Neuro.uuid=E,e.Neuro.indexOf=v,e.Neuro.propsMatch=p,e.Neuro.extend=A,e.Neuro.extendArray=S,e.Neuro.transfer=y,e.Neuro.swap=M,e.Neuro.grab=T,e.Neuro.pull=I,e.Neuro.copy=H,e.Neuro.diff=U,e.Neuro.sizeof=F,e.Neuro.isEmpty=V,e.Neuro.collect=_,e.Neuro.compare=Y,e.Neuro.equals=w,e.Neuro.equalsStrict=P,e.Neuro.equalsCompare=C,e.Neuro.isSorted=x,e.Neuro.createWhere=J,e.Neuro.createPropertyResolver=G,e.Neuro.createNumberResolver=B,e.Neuro.createComparator=z}(window);
//# sourceMappingURL=neurosync.min.js.map
