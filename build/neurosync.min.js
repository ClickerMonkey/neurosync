!function(e,t){function n(e){return"undefined"!=typeof e}function r(e){return!!(e&&e.constructor&&e.call&&e.apply)}function i(e){return"string"==typeof e}function o(e){return"number"==typeof e&&!isNaN(e)}function s(e){return e instanceof Date}function E(e){return e instanceof RegExp}function u(e){return e instanceof Array}function a(e){return null!==e&&"object"==typeof e}function d(e,t){return e instanceof Array?e:e.split(t)}function f(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function v(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()}function l(e,t){for(var n in e)t[n]=e[n];return t}function c(e,t,n){for(var r={},i=0;i<t.length;i++){var o=t[i];o in e&&(r[o]=n?O(e[o]):e[o])}return r}function O(e,t){if(void 0===e)return e;if(u(e)){for(var n=[],i=0;i<e.length;i++)n.push(O(e[i]));return e}if(r(e)||"object"!=typeof e||null===e)return e;if(s(e))return new Date(e.getTime());if(E(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var n={};for(var o in e)(t||"$"!==o.charAt(0))&&(n[o]=O(e[o]));return n}function $(e,t,n,r){for(var i={},o=0;o<n.length;o++){var s=n[o];s in e&&s in t&&!r(e[s],t[s])&&(i[s]=O(e[s]))}return i}function g(e){if(null===e||void 0===e||0===e)return!0;if(u(e))return 0===e.length;if(s(e))return 0===e.getTime()||isNaN(e.getTime());if(a(e)){for(var t in e)return!1;return!0}return!1}function h(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,i=typeof t;if(n!==i)return!1;var o=u(e),a=u(t);if(o!==a)return!1;if(o){if(e.length!==t.length)return!1;for(var d=0;d<e.length;d++)if(!h(e[d],t[d]))return!1;return!0}if(s(e))return s(t)&&h(e.getTime(),t.getTime());if(E(e))return E(t)&&e.toString()===t.toString();if("object"===n){for(var f in e)if(!("$"===f.charAt(0)&&r(e[f])||f in t&&h(e[f],t[f])))return!1;for(var f in t)if(!("$"===f.charAt(0)&&r(t[f])||f in e))return!1;return!0}return!1}function R(e,t){return e===t?0:t>e?-1:1}function L(e,t){return e==t?0:(s(e)&&(e=e.getTime()),s(t)&&(t=t.getTime()),o(e)&&o(t)?R(e,t):u(e)&&u(t)?R(e.length,t.length):(e+"").localeCompare(t+""))}function _(e){var t=function(e,t,r,i,o){var r=d(r," ");n(e[t])||(e[t]={});for(var s=0;s<r.length;s++)n(e[t][r[s]])||(e[t][r[s]]=[]),e[t][r[s]].push([i,o||e])};e.on=function(e,n,r){return t(this,"$on",e,n,r),this},e.once=function(e,n,r){return t(this,"$once",e,n,r),this};var i=function(e,t,n){if(e&&t in e)for(var r=e[t],i=r.length-1;i>=0;i--)r[i][0]===n&&r.splice(i,1)},o=function(e,t){e&&t in e&&delete e[t]};e.off=function(e,t){if(n(e)){var e=d(e," ");if(r(t))for(var s=0;s<e.length;s++)i(this.$on,e[s],t),i(this.$once,e[s],t);else for(var s=0;s<e.length;s++)o(this.$on,e[s]),o(this.$once,e[s])}else o(this,"$on"),o(this,"$once");return this};var s=function(e,t,n,r){if(e&&t in e){for(var i=e[t],o=i.length,s=0;o>s;s++){var E=i[s];E[0].call(E[1],n)}r&&(i.length!==o?e[t]=i.slice(o):delete e[t])}};e.trigger=function(e,t){for(var e=d(e," "),n=0;n<e.length;n++){var r=e[n];s(this.$on,r,t,!1),s(this.$once,r,t,!0)}return this}}function A(e){var t=new S(e),n=new Function("return function "+e.className+"(props) { this.$reset( props ) }")();return n.prototype=new m(t),n.db=t,t.model=n,t.init(),A.debug(A.Events.CREATION,e,t),{Database:t,Model:n}}function S(e){l(e,this),this.stork=new Stork(e),this.models=new Stork.FastMap,this.live=A.live(this,this.handlePublish(this))}function m(e){this.$db=e,this.$promise=Stork.Promise.Done(this),this.$pendingSave=!1,this.$pendingRemove=!1}_(A),A.debug=function(e,t){},A.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},A.rest=function(e,t){t.$failure([{},0])},A.online=window.navigator.onLine!==!1,A.forceOffline=!1,A.setOnline=function(){A.online=!0,A.debug(A.Events.ONLINE),A.trigger("online")},A.setOffline=function(){A.online=!1,A.debug(A.Events.OFFLINE),A.trigger("offline")},A.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",A.setOnline,!1),window.addEventListener("offline",A.setOffline,!1)):(document.body.ononline=A.setOnline,document.body.onoffline=A.setOffline)},A.checkNetworkStatus=function(){var e=window.navigator.onLine;A.forceOffline&&(e=!1),e===!0&&A.online===!1?A.setOnline():e===!1&&A.online===!0&&A.setOffline()},S.prototype={$pendingLoad:!1,removeKey:function(e){var t=this.key;if(u(t))for(var n=0;n<t.length;n++)delete e[t[n]];else delete e[t]},getKey:function(e){var t=this.key,n=null;if(u(t)){var r=this.keySeparator||"/";n="";for(var i=0;i<t.length;i++)i>0&&(n+=r),n+=e[t[i]]}else n=e[t],n||(e[t]=n=v());return n},updated:function(){var e=this.comparator;if(r(e))this.models.sort(e);else if(i(e)){var t=1;"-"===e.charAt(0)&&(e=e.substring(1),t=-1),this.models.sort(function(n,r){return t*L(n[e],r[e])})}this.trigger("updated")},putRemoteData:function(e,t,n){var r=this,t=t||r.getKey(e),n=n||r.models.get(t),i=r.decode(O(e));if(n&&n.$saved){var o=n.$toJSON();for(var s in e){var E=o[s],u=n.$saved[s];h(E,u)&&(n[s]=i[s],n.$local[s]=e[s]),n.$saved[s]=O(e[s])}n.$queue(function(){return A.debug(A.Events.REMOTE_UPDATE,e,n),r.stork.save(n.$local)})}else n=r.instantiate(i),n.$local=e,n.$saved=n.$local.$saved=O(e),n.$queue(function(){return A.debug(A.Events.REMOTE_CREATE,e,n),r.stork.save(n.$local)}),r.models.put(t,n);return n.trigger("saved"),n},destroyLocalModel:function(e){var t=this,n=t.models.get(e);return n?n.$hasChanges()?(delete n.$saved,delete n.$local.$saved,t.removeKey(n),t.removeKey(n.$local),n.$queue(function(){return t.stork.save(n.$local)}),!1):(n.$queue(function(){return t.stork.remove(e)},!0),t.models.remove(e),n.trigger("removed"),A.debug(A.Events.REMOTE_REMOVE,n),!0):(t.stork.remove(e,function(e){e&&A.debug(A.Events.REMOTE_REMOVE,e)}),!1)},init:function(){var e=this;e.PROMISED=new Stork.Promise(e).$success(),e.stork.all(function(t,n){A.debug(A.Events.LOCAL_LOAD,t),e.models.reset();for(var r=0;r<t.length;r++){var i=t[r],o=n[r],s=e.decode(O(i,!0)),E=e.instantiate(s);E.$local=i,i.$deleted?(A.debug(A.Events.LOCAL_RESUME_DELETE,E),e.removeRemote(E)):(i.$saved?A.debug(A.Events.LOCAL_LOAD_SAVED,E):(A.debug(A.Events.LOCAL_RESUME_SAVE,E),e.saveRemote(E)),e.models.put(o,E))}e.updated(),e.loadRemote()})},loadRemote:function(){var e=this,t=new Stork.Promise(this),n={method:"GET",url:this.rest};A.rest(n,t),t.then(function(t){for(var n={},r=0;r<t.length;r++){var i=e.putRemoteData(t[r]),o=i.$key();n[o]=i}for(var s=e.models.keys,r=0;r<s.length;r++){var E=s[r];if(!(E in n)){var u=e.models.get(E);u.$saved&&(A.debug(A.Events.REMOTE_LOAD_REMOVE,E),e.destroyLocalModel(E))}}e.updated(),A.debug(A.Events.REMOTE_LOAD,t)},function(t,n){0===n?(A.checkNetworkStatus(),A.online||(e.$pendingLoad=!0,A.once("online",function(){A.debug(A.Events.REMOTE_LOAD_RESUME),e.$pendingLoad&&(e.$pendingLoad=!1,e.loadRemote())})),A.debug(A.Events.REMOTE_LOAD_OFFLINE)):A.debug(A.Events.REMOTE_LOAD_ERROR,n)})},getModels:function(){return this.models.values},handlePublish:function(e){return function(t){var n=t.key,r=t.model;switch(t.op){case"SAVE":e.putRemoteData(r,n),e.updated(),A.debug(A.Events.REALTIME_SAVE,t.model);break;case"REMOVE":e.destroyLocalModel(n)&&e.updated(),A.debug(A.Events.REALTIME_REMOVE,n)}}},instantiate:function(e){return new this.model(e)},encode:function(e){return e},decode:function(e){return e},waitForPending:function(e,t,n){var r=this;return e.$pending()?(e.either(function(){t.apply(r,n)}),!0):(e.$reset(),!1)},interruptPending:function(e){e.$clear()},saveRemote:function(e){var t=this,n=e.$promise,r=new Stork.Promise(e);if(e.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,e),n;if(t.waitForPending(n,this.saveRemote,arguments))return A.debug(A.Events.SAVE_REMOTE_BLOCKED,e),n;var i=e.$toJSON(),o=e.$saved?$(i,e.$saved,t.fields,h):i;if(g(o))return n.$success();var s=e.$key(),E={method:e.$saved?"PUT":"POST",url:e.$saved?t.rest+s:t.rest,data:o};A.rest(E,r);var u=function(r){if(e.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,e,r),n.$failure();for(var i in r)i in o||(o[i]=r[i]);A.debug(A.Events.SAVE_VALUES,o,e),e.$saved||(e.$saved=e.$local.$saved={}),t.putRemoteData(o,s,e),n.$success(),A.debug(A.Events.SAVE_PUBLISH,o,e),t.live({op:"SAVE",model:o,key:s})};return r.then(function(t){A.debug(A.Events.SAVE_REMOTE,e),u(t)},function(r,i){409===i?(A.debug(A.Events.SAVE_CONFLICT,r,e),u(r)):410===i||404===i?(A.debug(A.Events.SAVE_UPDATE_FAIL,e),n.$failure(),e.$queue(function(){return t.models.remove(s),t.stork.remove(s)})):0!==i?(A.debug(A.Events.SAVE_ERROR,e,i),n.$failure()):(A.checkNetworkStatus(),A.online?n.$failure():(e.$pendingSave=!0,A.once("online",function(){e.$pendingSave&&(e.$pendingSave=!1,A.debug(A.Events.SAVE_RESUME,e),t.saveRemote(e,!0))}),n.$success()),A.debug(A.Events.SAVE_OFFLINE,e))}),n},save:function(e){var t=this,n=e.$promise,r=e.$key();return e.$deleted?(A.debug(A.Events.SAVE_DELETED,e),n):(t.models.has(r)||(t.models.put(r,e),t.updated()),t.saveLocal(e))},saveLocal:function(e){var t=this,n=e.$promise,r=e.$toJSON();if(e.$deleted)return A.debug(A.Events.SAVE_LOCAL_DELETED,e),n;if(t.waitForPending(n,this.saveLocal,arguments))return A.debug(A.Events.SAVE_LOCAL_BLOCKED,mdoel),n;e.$local?l(r,e.$local):e.$local=r;var i=t.stork.save(e.$local),o=function(){n.$success(),t.saveRemote(e)};return i.then(function(t){A.debug(A.Events.SAVE_LOCAL,e),o()},function(t){A.debug(A.Events.SAVE_LOCAL_ERROR,e,t),o()}),n},removeRemote:function(e){var t=this,n=e.$promise,r=new Stork.Promise(e),i=e.$key();if(e.$pendingSave=!1,e.$deleted=!0,t.interruptPending(n),t.waitForPending(n,this.removeRemote,arguments))return A.debug(A.Events.REMOVE_REMOTE_BLOCKED,e),n;var o={method:"DELETE",url:this.rest+i};A.rest(o,r);var s=function(){A.debug(A.Events.REMOVE_LOCAL,i,e),n.$bindTo(t.stork.remove(i)),e.trigger("removed"),A.debug(A.Events.REMOVE_PUBLISH,i,e),t.live({op:"REMOVE",key:i})};return r.then(function(t){A.debug(A.Events.REMOVE_REMOTE,e),s()},function(t,r){404===r||410===r?(A.debug(A.Events.REMOVE_MISSING,i,e),s()):0!==r?(A.debug(A.Events.REMOVE_ERROR,r,i,e),n.$failure()):(A.checkNetworkStatus(),A.online?n.$failure():(A.once("online",function(){A.debug(A.Events.REMOVE_RESUME,e)}),n.$success()),A.debug(A.Events.REMOVE_OFFLINE,e))}),n},removeLocal:function(e){var t=this,n=e.$promise,r=e.$key();if(t.interruptPending(n),t.waitForPending(n,this.removeLocal,arguments))return A.debug(A.Events.REMOVE_LOCAL_BLOCKED,e),n;if(!e.$local)return A.debug(A.Events.REMOVE_LOCAL_NONE,e),n.$success();if(e.$saved){e.$local.$deleted=!0;var i=t.stork.save(e.$local),o=function(){e.$saved?(t.interruptPending(n),n.$success(),t.removeRemote(e)):n.$success()};i.then(function(t){A.debug(A.Events.REMOVE_LOCAL,e),o()},function(t){A.debug(A.Events.REMOVE_LOCAL_ERROR,e,t),o()})}else A.debug(A.Events.REMOVE_LOCAL_UNSAVED,e),n.$bindTo(t.stork.remove(r));return n},remove:function(e){var t=this,n=e.$key();return t.models.has(n)&&(t.models.remove(n),t.updated()),e.$deleted=!0,e.$pendingSave&&(A.debug(A.Events.REMOVE_CANCEL_SAVE,e),e.$pendingSave=!1),t.removeLocal(e)}},_(S.prototype),m.prototype={$set:function(e,t){a(e)?l(e,this):i(e)&&void 0!==t&&(this[e]=t)},$get:function(e,t){if(u(e))return c(this,e,t);if(a(e)){for(var n in e)e[n]=t?O(this[n]):this[n];return e}return i(e)?t?O(this[e]):this[e]:void 0},$save:function(e,t){return this.$set(e,t),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$queue:function(e,t){var n=this.$promise;return t&&n.$clear(),n.either(function(){n.$reset(),n.$bindTo(e())}),n},$reset:function(e){var n=this.$db.defaults,i=this.$db.fields;if(a(n))for(var o=0;o<i.length;o++){var s=i[o];if(s in n){var E=n[s];r(E)?this[s]=E():this[s]=O(E)}else this[s]=t}else for(var o=0;o<i.length;o++){var s=i[o];this[s]=t}this.$set(e)},$toJSON:function(){return this.$db.encode(c(this,this.$db.fields,!0))},$key:function(){return this.$db.getKey(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(),t=this.$saved;for(var n in e){var r=e[n],i=t[n];if(!h(r,i))return!0}return!1}},_(m.prototype),e.Neuro=A}(window);
//# sourceMappingURL=neurosync.min.js.map
