!function(e,t){function i(e){return e!==t}function n(e){return!!(e&&e.constructor&&e.call&&e.apply)}function o(e){return n(e)&&e.prototype instanceof C}function s(e){return!!(e&&e.Model&&e.Database)}function r(e){return"string"==typeof e}function a(e){return"number"==typeof e&&!isNaN(e)}function d(e){return e instanceof Date}function l(e){return e instanceof RegExp}function u(e){return e instanceof Array}function h(e){return null!==e&&"object"==typeof e}function c(e,t){return e instanceof Array?e:e.split(t)}function v(e){return e!==t&&null!==e}function f(e,t,i){for(var n=i||N,o=0,s=e.length;s>o;o++)if(n(e[o],t))return o;return!1}function E(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function m(){return E()+E()+"-"+E()+"-"+E()+"-"+E()+"-"+E()+E()+E()}function g(e,t,i){t.prototype=e;for(var n in i)t.prototype[n]=i[n]}function $(e,t,i,n){if(r(t))return e[t]===i[n];for(var o=0;o<t.length;o++){var s=t[o],a=n[o];if(!D(e[s],i[a]))return!1}return!0}function p(e,t){for(var i in e)t[i]=e[i];return t}function O(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function S(e){return v(e)?s(e)?new e.Model:o(e)?new e:n(e)?e():M(e):e}function R(e,t,i){for(var n={},o=0;o<t.length;o++){var s=t[o];s in e&&(n[s]=i?M(e[s]):e[s])}return n}function y(e,t,i){if(r(t)){var n=e[t];return i?M(n):n}for(var o=[],s=0;s<t.length;s++){var a=t[s],n=e[a];o.push(i?M(n):n)}return o}function L(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function M(e,t){if(void 0===e)return e;if(u(e)){for(var i=[],o=0;o<e.length;o++)i.push(M(e[o]));return e}if(n(e)||"object"!=typeof e||null===e)return e;if(d(e))return new Date(e.getTime());if(l(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var i={};for(var s in e)(t||"$"!==s.charAt(0))&&(i[s]=M(e[s]));return i}function A(e,t,i,n){for(var o={},s=0;s<i.length;s++){var r=i[s];n(e[r],t[r])||(o[r]=M(e[r]))}return o}function _(e){if(u(e)||r(e))return e.length;if(h(e)){var t=0;for(var i in e)t++;return t}return 0}function b(e){if(null===e||void 0===e||0===e)return!0;if(u(e)||r(e))return 0===e.length;if(d(e))return 0===e.getTime()||isNaN(e.getTime());if(h(e)){for(var t in e)return!1;return!0}return!1}function N(e,t){return e===t}function D(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var i=typeof e,o=typeof t;if(i!==o)return!1;var s=u(e),r=u(t);if(s!==r)return!1;if(s){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!D(e[a],t[a]))return!1;return!0}if(d(e))return d(t)&&D(e.getTime(),t.getTime());if(l(e))return l(t)&&e.toString()===t.toString();if("object"===i){for(var h in e)if(!("$"===h.charAt(0)&&n(e[h])||h in t&&D(e[h],t[h])))return!1;for(var h in t)if(!("$"===h.charAt(0)&&n(t[h])||h in e))return!1;return!0}return!1}function T(e,t){return e===t?0:t>e?-1:1}function k(e,t){return e==t?0:(d(e)&&(e=e.getTime()),d(t)&&(t=t.getTime()),a(e)&&a(t)?T(e,t):u(e)&&u(t)?T(e.length,t.length):(e+"").localeCompare(t+""))}function V(e){return n(e)?e:r(e)?"-"===e.charAt(0)?(e=e.substring(1),function(t,i){return k(i[e],t[e])}):function(t,i){return k(t[e],i[e])}:null}function F(e,t){function o(e,t,o,s,r){if(n(s)){var o=c(o," ");i(e[t])||(e[t]={});for(var a=0;a<o.length;a++)i(e[t][o[a]])||(e[t][o[a]]=[]),e[t][o[a]].push([s,r||e])}}function s(e,t,i){return o(this,"$$on",e,t,i),this}function r(e,t,i){return o(this,"$$once",e,t,i),this}function a(e,t,i){if(e&&t in e)for(var n=e[t],o=n.length-1;o>=0;o--)n[o][0]===i&&n.splice(o,1)}function d(e,t){e&&t in e&&delete e[t]}function l(e,t){if(i(e)){var e=c(e," ");if(n(t))for(var o=0;o<e.length;o++)a(this.$$on,e[o],t),a(this.$$once,e[o],t);else for(var o=0;o<e.length;o++)d(this.$$on,e[o]),d(this.$$once,e[o])}else d(this,"$$on"),d(this,"$$once");return this}function u(e,t,i,n){if(e&&t in e){for(var o=e[t],s=o.length,r=0;s>r;r++){var a=o[r];a&&a[0].apply(a[1],i)}n&&(o.length!==s?e[t]=o.slice(s):delete e[t])}}function h(e,t){for(var e=c(e," "),i=0;i<e.length;i++){var n=e[i];u(this.$$on,n,t,!1),u(this.$$once,n,t,!0)}return this}t?(e.$on=s,e.$once=r,e.$off=l,e.$trigger=h):(e.on=s,e.once=r,e.off=l,e.trigger=h)}function I(e){var t=new K(e),i=new Function("return function "+e.className+"(props, exists) { this.$init( props, exists ) }")();return i.prototype=new C(t),t.model=i,t.init(),I.debug(I.Events.CREATION,t,e),i.Database=t,i.Model=i,I.cache[e.name]=i,I.cache[e.className]=i,I.trigger("initialized",[i]),i}function K(e){p(e,this),this.models=new w,this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.rest=I.rest(this),this.store=I.store(this),this.live=I.live(this,this.handlePublish(this)),this.setComparator(this.comparator),this.setRevision(this.revision),this.relations={};for(var t in e)if(t in I.Relations){var i=I.Relations[t];if(i.prototype instanceof J){var n=e[t];for(var o in n){var s=n[o],r=new i;r.init(this,o,s),this.relations[o]=r}}}}function C(e){this.$db=e}function w(){this.values=[],this.keys=[],this.indices={}}function U(e,t){this.interrupts=e,this.type=t}function P(e){this.reset(e)}function B(e){this.reset(e)}function x(e){this.reset(e)}function H(e){this.reset(e)}function G(e){this.reset(e)}function z(e){this.reset(e)}function J(){}function Y(){this.type="belongsTo"}function q(){this.type="hasMany"}function j(){this.type="hasManyThrough"}function Q(){this.type="hasOne"}I.cache={},I.get=function(t,i,o){function s(e){(e.name===t||e.className===t)&&(i.call(a,e),I.off("initialized",s))}var r=I.cache[t],a=o||e;return n(i)&&(r?i.call(a,r):I.on("initialized",s)),r},F(I),I.debug=function(e,t){},I.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_NINJA_SAVE:50,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_PRESAVE:68,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:71},I.rest=function(e){return function(e,t,i,n,o){o({},0)}},I.store=function(e){return{put:function(e,t,i,n){},remove:function(e,t,i){},all:function(e,t){}}},I.live=function(e,t){return function(e){}},I.online=window.navigator.onLine!==!1,I.forceOffline=!1,I.setOnline=function(){I.online=!0,I.debug(I.Events.ONLINE),I.trigger("online")},I.setOffline=function(){I.online=!1,I.debug(I.Events.OFFLINE),I.trigger("offline")},I.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",I.setOnline,!1),window.addEventListener("offline",I.setOffline,!1)):(document.body.ononline=I.setOnline,document.body.onoffline=I.setOffline)},I.checkNetworkStatus=function(){var e=window.navigator.onLine;I.forceOffline&&(e=!1),e===!0&&I.online===!1?I.setOnline():e===!1&&I.online===!0&&I.setOffline()},K.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",Loads:"no-load remote-load local-load"},K.Live={Save:"SAVE",Remove:"REMOVE"},K.prototype={toString:function(e){return""},ready:function(e,t,i){function n(){s.off(K.Events.Loads,o)}function o(){i||n(),(!a||i)&&(e.call(r,s)===!1&&n(),a=!0)}var s=this,r=t||s,a=!1;return s.initialized?(e.call(r,s),a=!0):s.on(K.Events.Loads,o),a},grabModel:function(e,t,i){function n(){var i=o.parseModel(e,!0);return i!==!1&&t.call(s,i),i}var o=this,s=i||o;n()&&o.ready(n,o,!0)},parseModel:function(e,i){var n=this;if(!v(e))return n.remoteLoaded?null:!1;s(e)?e=new e.Model:o(e)&&(e=new e);var r=n.buildKeyFromInput(e);return e instanceof n.model?(n.models.has(r)||n.models.put(r,e),e):n.models.has(r)?n.models.get(r):h(e)?n.putRemoteData(e,t,t,i):n.remoteLoaded?null:!1},removeKey:function(e){var t=this.key;if(u(t))for(var i=0;i<t.length;i++)delete e[t[i]];else delete e[t]},buildKey:function(e,t){var i=this.buildKeys(e,t);return u(i)&&(i=i.join(this.keySeparator||"/")),i},buildKeys:function(e,t){var i=null;if(u(t)){i=[];for(var n=0;n<t.length;n++)i.push(e[t[n]])}else i=e[t],i||(i=e[t]=m());return i},buildKeyFromInput:function(e){return e instanceof this.model?e.$key():u(e)?this.buildKeyFromArray(e):h(e)?this.buildKey(e,this.key):e},buildKeyFromArray:function(e){for(var t=this.keySeparator||"/",i="",n=0;n<e.length;n++)n>0&&(i+=t),i+=e[n];return i},getKey:function(e){return this.buildKey(e,this.key)},getKeys:function(e){return this.buildKeys(e,this.key)},hasFields:function(e,t,i){if(u(t)){for(var n=0;n<t.length;n++)if(!i(e[t[n]]))return!1;return!0}return i(e[t])},updated:function(){this.sort(),this.trigger(K.Events.Updated)},setRevision:function(e){n(e)?this.revisionFunction=e:r(e)?this.revisionFunction=function(t,i){return e in t&&e in i?t[e]-i[e]:!1}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e){this.comparatorFunction=V(e)},sort:function(){this.isSorted()||this.models.sort(this.comparatorFunction)},isSorted:function(){return this.models.isSorted(this.comparatorFunction)},putRemoteData:function(e,t,i,n){var o=this,t=t||o.getKey(e),i=i||o.models.get(t),s=o.decode(M(e));if(i){var r=this.revisionFunction(i,e);if(r!==!1&&r>0)return void I.debug(I.Events.SAVE_OLD_REVISION,o,i,e)}if(i&&i.$saved){var a=i.$toJSON(!0),d={},l=!1,u={};for(var h in e)if("$"!==h.charAt(0)){var c=a[h],v=i.$saved[h];D(c,v)?(i[h]=s[h],u[h]=e[h],o.cache!==!1&&(i.$local[h]=e[h])):(d[h]=e[h],l=!0),i.$saved[h]=M(e[h])}l?i.$trigger(C.Events.PartialUpdate,[e,d]):i.$trigger(C.Events.FullUpdate,[e,u]),i.$trigger(C.Events.RemoteUpdate,[e]),o.cache!==!1&&i.$addOperation(G)}else i=o.instantiate(s,n),o.cache!==!1?(i.$local=e,i.$saved=i.$local.$saved=M(e),i.$addOperation(G)):i.$saved=L(e);return o.models.has(t)||(o.models.put(t,i),o.trigger(K.Events.ModelAdded,[i]),n||i.$trigger(C.Events.Saved)),i},destroyLocalUncachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,i.removeKey(e),e.$trigger(C.Events.Detach),!1):(i.models.remove(t),i.trigger(K.Events.ModelRemoved,[e]),e.$trigger(C.Events.RemoteAndRemove),I.debug(I.Events.REMOTE_REMOVE,i,e),!0):!1},destroyLocalCachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,delete e.$local.$saved,i.removeKey(e),i.removeKey(e.$local),e.$trigger(C.Events.Detach),e.$addOperation(G),!1):(e.$addOperation(B),i.models.remove(t),i.trigger(K.Events.ModelRemoved,[e]),e.$trigger(C.Events.RemoteAndRemove),I.debug(I.Events.REMOTE_REMOVE,i,e),!0):(i.store.remove(t,function(e){e&&I.debug(I.Events.REMOTE_REMOVE,i,e)}),!1)},destroyLocalModel:function(e){var t=this,i=t.models.get(e);return t.cache===!1?t.destroyLocalUncachedModel(i,e):t.destroyLocalCachedModel(i,e)},init:function(){function e(e,t){I.debug(I.Events.LOCAL_LOAD,i,e),i.models.reset();for(var n=0;n<e.length;n++){var o=e[n],s=t[n],r=i.decode(M(o,!0)),a=i.instantiate(r,!0);a.$local=o,o.$deleted?(I.debug(I.Events.LOCAL_RESUME_DELETE,i,a),a.$addOperation(x)):(o.$saved?(I.debug(I.Events.LOCAL_LOAD_SAVED,i,a),a.$local.$saved=a.$saved):(I.debug(I.Events.LOCAL_RESUME_SAVE,i,a),a.$addOperation(z)),s===a.$key()?i.models.put(s,a):i.store.remove(s))}i.initialized=!0,i.localLoaded=!0,i.trigger(K.Events.LocalLoad,[i]),i.updated(),i.loadRemote!==!1&&i.refresh()}function t(){i.initialized=!0,i.loadRemote!==!1?i.refresh():i.trigger(K.Events.NoLoad,[i])}var i=this;return i.cache===!1?void(i.loadRemote!==!1?i.refresh():(i.initialized=!0,i.trigger(K.Events.NoLoad,[i]))):void i.store.all(e,t)},refresh:function(){function e(e){for(var t={},i=0;i<e.length;i++){var o=n.putRemoteData(e[i]),s=o.$key();t[s]=o}for(var r=n.models.keys,i=0;i<r.length;i++){var a=r[i];if(!(a in t)){var d=n.models.get(a);d.$saved&&(I.debug(I.Events.REMOTE_LOAD_REMOVE,n,a),n.destroyLocalModel(a))}}n.initialized=!0,n.remoteLoaded=!0,n.trigger(K.Events.RemoteLoad,[n]),n.updated(),I.debug(I.Events.REMOTE_LOAD,n,e)}function i(e,t){0===t?(I.checkNetworkStatus(),I.online||(n.pendingRefresh=!0,I.once("online",function(){I.debug(I.Events.REMOTE_LOAD_RESUME,n),n.pendingRefresh&&(n.pendingRefresh=!1,n.refresh())})),I.debug(I.Events.REMOTE_LOAD_OFFLINE,n)):(I.debug(I.Events.REMOTE_LOAD_ERROR,n,t),n.initialized=!0,n.trigger(K.Events.NoLoad,[n]))}var n=this;n.rest("GET",t,t,e,i)},getModels:function(){return this.models.values},getModel:function(e){return u(e)&&(e=this.buildKeyFromArray(e)),this.models.get(e)},handlePublish:function(e){return function(t){var i=t.key,n=t.model;switch(t.op){case K.Live.Save:e.putRemoteData(n,i),e.updated(),I.debug(I.Events.REALTIME_SAVE,e,t.model,i);break;case K.Live.Remove:e.destroyLocalModel(i)&&e.updated(),I.debug(I.Events.REALTIME_REMOVE,e,i)}}},instantiate:function(e,t){return new this.model(e,t)},encode:function(e){return e},decode:function(e){return e},save:function(e){var t=this,i=e.$key();return e.$deleted?void I.debug(I.Events.SAVE_DELETED,t,e):(t.models.has(i)?(t.trigger(K.Events.ModelUpdated,[e]),e.$trigger(C.Events.UpdateAndSave)):(t.models.put(i,e),t.trigger(K.Events.ModelAdded,[e]),t.updated(),e.$trigger(C.Events.CreateAndSave)),void(t.cache===!1?e.$addOperation(z):e.$addOperation(H)))},remove:function(e){var t=this,i=e.$key();t.models.has(i)&&(t.models.remove(i),t.trigger(K.Events.ModelRemoved,[e]),t.updated(),e.$trigger(C.Events.Removed)),e.$deleted=!0,e.$pendingSave&&(I.debug(I.Events.REMOVE_CANCEL_SAVE,t,e),e.$pendingSave=!1),t.cache===!1?e.$addOperation(x):e.$addOperation(P)}},F(K.prototype),C.Events={Created:"created",Saved:"saved",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",CreateAndSave:"created saved",UpdateAndSave:"updated saved",Removed:"removed",RemoteUpdate:"remote-update",RemoteRemove:"remote-remove",RemoteAndRemove:"remote-remove removed"},C.prototype={$init:function(e,t){if(this.$pendingSave=!1,this.$operation=null,this.$relations={},t?this.$set(e):this.$reset(e),this.$db.loadRelations){var i=this.$db.relations;for(var n in i)this.$getRelation(n)}},$reset:function(e){var i=this.$db.defaults,n=this.$db.fields,o=this.$db.relations;if(h(i)){for(var s=0;s<n.length;s++){var r=n[s],a=i[r],d=S(a);this[r]=d}for(var r in o)if(r in i){var a=i[r],d=S(a),l=this.$getRelation(r);l.set(this,d)}}else for(var s=0;s<n.length;s++){var r=n[s];this[r]=t}this.$set(e)},$set:function(e,t){if(h(e))p(e,this);else if(r(e)){var i=this.$getRelation(e);i?i.set(this,t):this[e]=t}},$get:function(e,t){if(u(e))return R(this,e,t);if(h(e)){for(var i in e)e[i]=t?M(this[i]):this[i];return e}if(r(e)){var n=this.$getRelation(e);if(n){var o=n.get(this);return t?M(o):o}return t?M(this[e]):this[e]}},$relate:function(e,t){var i=this.$getRelation(e);i&&i.relate(this,t)},$unrelate:function(e,t){var i=this.$getRelation(e);i&&i.unrelate(this,t)},$getRelation:function(e){var t=this.$db.relations;if(e in t){var i=t[e];return e in this.$relations||i.load(this),i}return!1},$save:function(e,t){this.$set(e,t),this.$callRelationFunction("preSave"),this.$db.save(this),this.$callRelationFunction("postSave")},$remove:function(){this.$exists()&&(this.$callRelationFunction("preRemove"),this.$db.remove(this),this.$callRelationFunction("postRemove"))},$exists:function(){return!this.$deleted&&this.$db.models.has(this.$key())},$callRelationFunction:function(e){var t=this.$db.relations;for(var i in t)t[i][e](this)},$addOperation:function(e){var t=new e(this);this.$operation?this.$operation.queue(t):(this.$operation=t,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(R(this,this.$db.fields,!0)),i=this.$db.relations,n=this.$relations;for(var o in n)i[o].encode(this,t,e);return t},$key:function(){return this.$db.getKey(this)},$keys:function(){return this.$db.getKeys(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(){var e=this.$saved,t=this.$toJSON(!0),i=this.$db.fields;return e?A(t,e,i,D):t},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(!0),t=this.$saved;for(var i in e){var n=e[i],o=t[i];if(!D(n,o))return!0}return!1}},F(C.prototype,!0),w.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,this.values.push(t),this.keys.push(e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return a(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],i=this.values.pop(),n=this.keys.pop();return e<this.values.length&&(this.values[e]=i,this.keys[e]=n,this.indices[n]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},filter:function(e,t){for(var i=t||new w,n=this.size(),o=this.values,s=this.keys,r=0;n>r;r++){var a=o[r],d=s[r];e(a,d)&&i.put(d,a)}return i},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),i=0;t>i;i++)O(this.values,i,e-i),O(this.keys,i,e-i);return this.rebuildIndex(),this},isSorted:function(e){if(!e)return!0;for(var t=this.values,i=0,n=t.length-1;n>i;i++)if(e(t[i],t[i+1])>0)return!1;return!0},sort:function(e){function t(t,i){for(var o=n.values[Math.floor((i+t)/2)],s=t,r=i;r>=s;){for(;e(n.values[s],o)<0;)s++;for(;e(n.values[r],o)>0;)r--;r>=s&&(O(n.values,s,r),O(n.keys,s,r),s++,r--)}return s}function i(e,n){var o=t(e,n);o-1>e&&i(e,o-1),n>o&&i(o,n)}var n=this,o=this.size()-1;return o>0&&(i(0,o),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},U.prototype={reset:function(e){this.model=e,this.db=e.$db,this.next=null,this.finished=!1},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},execute:function(){this.run(this.db,this.model)},run:function(e,t){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute()),this},tryNext:function(e){this.next||(this.next=new e(this.model))},insertNext:function(e){var t=new e(this.model);t.next=this.next,this.next=t},success:function(){var e=this;return function(){e.onSuccess.apply(e,arguments),e.finish()}},onSuccess:function(){},failure:function(){var e=this;return function(){e.onFailure.apply(e,arguments),e.finish()}},onFailure:function(){}},g(new U(!0,"NeuroRemoveLocal"),P,{run:function(e,t){var i=t.$key();return t.$local?void(t.$saved?(t.$local.$deleted=!0,e.store.put(i,t.$local,this.success(),this.failure())):(I.debug(I.Events.REMOVE_LOCAL_UNSAVED,t),e.store.remove(i,this.success(),this.failure()))):(I.debug(I.Events.REMOVE_LOCAL_NONE,t),this.finish())},onSuccess:function(e,t,i){var n=this.model;I.debug(I.Events.REMOVE_LOCAL,n),n.$saved&&n.$addOperation(x)},onFailure:function(e){var t=this.model;I.debug(I.Events.REMOVE_LOCAL_ERROR,t,e),t.$saved&&t.$addOperation(x)}}),g(new U(!0,"NeuroRemoveNow"),B,{run:function(e,t){var i=t.$key();e.models.has(i)&&(e.models.remove(i),e.trigger("model-removed",[t]),e.updated(),t.$trigger("removed")),e.store.remove(i,this.success(),this.failure())}}),g(new U(!0,"NeuroRemoveRemote"),x,{run:function(e,i){i.$pendingSave=!1,i.$deleted=!0,this.key=i.$key(),e.rest("DELETE",i,t,this.success(),this.failure())},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var i=this,n=this.key,o=this.model;404===t||410===t?(I.debug(I.Events.REMOVE_MISSING,this,n,o),this.finishRemove()):0!==t?I.debug(I.Events.REMOVE_ERROR,this,t,n,o):(I.checkNetworkStatus(),I.online||I.once("online",function(){I.debug(I.Events.REMOVE_RESUME,i,o),o.$addOperation(x)}),I.debug(I.Events.REMOVE_OFFLINE,this,o))},finishRemove:function(){var e=this.db,t=this.key,i=this.model;I.debug(I.Events.REMOVE_REMOTE,this,t,i),this.insertNext(B),I.debug(I.Events.REMOVE_PUBLISH,this,t,i),e.live({op:K.Live.Remove,key:t})}}),x.prototype=new U(!0,"NeuroRemoveRemote"),g(new U(!1,"NeuroSaveLocal"),H,{run:function(e,t){if(t.$deleted)return I.debug(I.Events.SAVE_LOCAL_DELETED,this,t),this.finish();var i=t.$toJSON(!1);t.$local?p(i,t.$local):t.$local=i,e.store.put(t.$key(),t.$local,this.success(),this.failure())},onSuccess:function(e,t,i){var n=this.model;I.debug(I.Events.SAVE_LOCAL,this,n),this.tryNext(z)},onFailure:function(e){var t=this.model;I.debug(I.Events.SAVE_LOCAL_ERROR,this,t,e),this.tryNext(z)}}),g(new U(!1,"NeuroSaveNow"),G,{run:function(e,t){e.store.put(t.$key(),t.$local,this.success(),this.failure())}}),g(new U(!1,"NeuroSaveRemote"),z,{run:function(e,t){if(t.$deleted)return I.debug(I.Events.SAVE_REMOTE_DELETED,this,t),this.finish();var i=(this.key=t.$key(),this.saving=t.$getChanges(!0));return b(i)?this.finish():void e.rest(t.$saved?"PUT":"POST",t,i,this.success(),this.failure())},onSuccess:function(e){var t=this.model;I.debug(I.Events.SAVE_REMOTE,this,t),this.handleData(e)},onFailure:function(e,t){var i=this,n=(this.db,this.model);409===t?(I.debug(I.Events.SAVE_CONFLICT,this,e,n),this.handleData(e,n,this.db)):410===t||404===t?(I.debug(I.Events.SAVE_UPDATE_FAIL,this,n),this.insertNext(B)):0!==t?I.debug(I.Events.SAVE_ERROR,this,n,t):(I.checkNetworkStatus(),I.online||(n.$pendingSave=!0,I.once("online",function(){n.$pendingSave&&(n.$pendingSave=!1,n.$addOperation(z),I.debug(I.Events.SAVE_RESUME,i,n))})),I.debug(I.Events.SAVE_OFFLINE,this,n))},handleData:function(e){var t=this.db,i=this.model,n=this.saving;if(i.$deleted)return void I.debug(I.Events.SAVE_REMOTE_DELETED,this,i,e);for(var o in e)o in n||(n[o]=e[o]);I.debug(I.Events.SAVE_VALUES,this,n,i),i.$saved||(t.cache===!1?i.$saved={}:i.$saved=i.$local.$saved={}),t.putRemoteData(n,this.key,i),I.debug(I.Events.SAVE_PUBLISH,this,n,i),t.live({op:K.Live.Save,model:n,key:this.key})}}),I.Relations={},I.Store={None:0,Model:1,Key:2,Keys:3},I.Save={None:0,Model:4},J.prototype={init:function(e,t,i){this.database=e,this.name=t,this.options=i,this.store=i.store||I.Store.None,this.save=i.save||I.Save.None,this.auto=!!i.auto,this.property=!!i.property,this.discriminator=i.discriminator||"discriminator",this.discriminators=i.discriminators||{},this.discriminated=!!i.discriminators;var n=this.setNeuro(e,t,i);s(i.model)?n.call(this,i.model):I.get(i.model,n,this)},setNeuro:function(e,t,i){return function(n){this.model=n,this.property||(this.property=f(e.fields,this.name)!==!1),this.discriminated&&this.loadDiscriminators(),this.onInitialized(e,t,i)}},onInitialized:function(e,t,i){},load:function(e){},relate:function(e,t){},unrelate:function(e,t){},get:function(e){},set:function(e,t){this.unrelate(e),this.relate(e,t)},encode:function(e,t,i){},preSave:function(e){},postSave:function(e){},preRemove:function(e){},postRemove:function(e){},clearFields:function(e,t){var i=!1;if(r(t))e[t]&&(e[t]=null,i=!0);else for(var n=0;n<t.length;n++){var o=t[n];e[o]&&(e[o]=null,i=!0)}return i&&this.auto&&!e.$isNew()&&e.$save(),i},updateFields:function(e,t,i,n){var o=!1;if(i.$key(),r(t)){var s=e[t],a=i[n];D(s,a)||(e[t]=a,o=!0)}else for(var d=0;d<t.length;d++){var l=t[d],s=e[l],u=n[d],h=i[u];D(s,h)||(e[l]=M(h),o=!0)}return o&&this.auto&&!e.$isNew()&&e.$save(),o},getStoredArray:function(e,t){if(!t)return null;for(var i=[],n=0;n<e.length;n++){var o=this.getStored(e[n],t);null!==o&&i.push(o)}return i},getStored:function(e,t){if(e)switch(t){case I.Save.Model:return e.$toJSON(!0);case I.Store.Model:if(e.$local)return e.$local;var i=e.$toJSON(!1);return e.$saved&&(i.$saved=e.$saved),i;case I.Store.Key:return e.$key();case I.Store.Keys:return e.$keys()}return null},loadDiscriminators:function(){for(var e in this.discriminators){var t=this.discriminators[e];I.get(t,this.setDiscriminated,this)}},setDiscriminated:function(e){return function(t){this.discriminators[e]=t}},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e);if(t in this.discriminators){var e=this.discriminators[t];return e.Database}return!1},parseDiscriminated:function(e){if(h(e)){var t=this.getDiscriminatorDatabase(e);return t.parseModel(e)}return!1},grabDiscriminated:function(e,t){if(h(e)){var i=this.getDiscriminatorDatabase(e);i!==!1&&i.grabModel(e,callack,this)}},getDiscriminatorByType:function(e){for(var t in this.discriminators){var i=this.discriminators[t];if(e instanceof i)return t}return!1},loadAllRelated:function(e,t){if(this.discriminated)this.loadAllDiscriminated(e,t);else{var i=this.model.Database;i.ready(this.loadAllReady(e,t),this)}},loadAllReady:function(e,t){return function(i){var n=i.models.filter(e);t.call(this,n)}},loadAllDiscriminated:function(e,t){var i=new w,n=this,o=_(this.discriminators),s=0;for(var r in this.discriminators){var a=this.discriminators[r],d=a.Database;d.ready(function(r){r.models.filter(e,i),++s===o&&t.call(n,i)})}}},I.Relations.belongsTo=Y,g(new J,Y,{onInitialized:function(e,t,i){var n=this.model.Database;this.local=i.local||n.name+"_"+n.key,I.debug(I.Events.BELONGSTO_INIT,this)},load:function(e){var t=this,i=this.model.Database,n=e[this.name],o=e.$relations[this.name]={initial:n,model:null,loaded:!1,onRemoved:function(){I.debug(I.Events.BELONGSTO_NINJA_REMOVE,t,e,o),this.cascade!==!1&&e.$remove()},onSaved:function(){I.debug(I.Events.BELONGSTO_NINJA_SAVE,t,e,o),this.hasForeignKey(e,o.model)||this.cascade===!1||e.$remove()}};b(n)&&i.hasFields(e,this.local,v)&&(n=y(e,this.local),I.debug(I.Events.BELONGSTO_INITIAL_PULLED,this,e,n)),b(n)||(I.debug(I.Events.BELONGSTO_INITIAL,this,e,n),i.grabModel(n,this.handleLoad(e,o),this))},set:function(e,t){if(v(t)){var i=this.model.Database,n=i.parseModel(t),o=e.$relations[this.name];n&&!this.hasForeignKey(e,n)&&(this.clearModel(o),this.setRelated(e,o,n))}else this.unrelate(e)},relate:function(e,t){var i=this.model.Database,n=i.parseModel(t),o=e.$relations[this.name];n&&o.model!==n&&(this.clearModel(o),this.setRelated(e,o,n))},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name],o=i.parseModel(t);o&&n.model!==o||(this.clearModel(n),this.clearForeignKey(e))},setRelated:function(e,t,i){this.setModel(t,i),this.updateForeignKey(e,i),this.setProperty(e,t)},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,i){var n=e.$relations[this.name],o=i?this.save:this.store;n&&o&&(t[this.name]=this.getStored(n.model,o))},postRemove:function(e){var t=e.$relations[this.name];t&&(I.debug(I.Events.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e){e.model&&(I.debug(I.Events.BELONGSTO_CLEAR_MODEL,this,e),e.model.$off("saved",e.onSaved),e.model.$off("removed",e.onRemoved),e.model=null,e.loaded=!0)},setModel:function(e,t){t.$on("saved",e.onSaved,this),t.$on("removed",e.onRemoved,this),e.model=t,e.loaded=!0,I.debug(I.Events.BELONGSTO_SET_MODEL,this,e)},handleLoad:function(e,t){return function(i){I.debug(I.Events.BELONGSTO_LOADED,this,e,t,i),t.loaded===!1&&(i?(this.setModel(t,i),this.updateForeignKey(e,i)):this.clearForeignKey(e),t.loaded=!0,this.setProperty(e,t))}},hasForeignKey:function(e,t){var i=this.model.Database,n=this.local,o=i.key;return $(e,n,t,o)},clearForeignKey:function(e){var t=this.local;I.debug(I.Events.BELONGSTO_CLEAR_KEY,this,e,t),this.clearFields(e,t)},updateForeignKey:function(e,t){var i=this.model.Database,n=this.local,o=i.key;I.debug(I.Events.BELONGSTO_UPDATE_KEY,this,e,n,t,o),this.updateFields(e,n,t,o)},setProperty:function(e,t){this.property&&e[this.name]!==t.model&&(e[this.name]=t.model,e.$trigger("relation-update",[this,t]))}}),I.Relations.hasMany=q,g(new J,q,{onInitialized:function(e,t,i){this.foreign=i.foreign||e.name+"_"+e.key,this.comparator=V(i.comparator),this.cascadeRemove=!!i.cascadeRemove,this.cascadeSave=!!i.cascadeSave,I.debug(I.Events.HASMANY_INIT,this)},load:function(e){var t=this,i=this.model.Database,n=this.isRelated(e),o=e[this.name],s=e.$relations[this.name]={parent:e,isRelated:n,initial:o,pending:{},models:new w,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){t.removeModel(s,this,!0)},onSaved:function(){s.saving||(n(this)?(t.sort(s),t.checkSave(s)):t.removeModel(s,this))}};if(e.$key(),i.on("model-added",this.handleModelAdded(s),this),u(o))for(var r=0;r<o.length;r++){var a=o[r],d=i.buildKeyFromInput(a);s.pending[d]=!0,i.grabModel(a,this.handleModel(s),this)}else this.loadAllRelated(n,this.handleLazyLoad(s));this.setProperty(s)},bulk:function(e,t){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e)},relate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var o=i.parseModel(t[e]);o&&this.addModel(n,o)}});else if(v(t)){var o=i.parseModel(t);o&&this.addModel(n,o)}},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var o=i.parseModel(t[e]);o&&this.removeModel(n,o)}});else if(v(t)){var o=i.parseModel(t);o&&this.removeModel(n,o)}else for(var s=n.models.values,r=s.length-1;r>=0;r--)this.removeModel(n,s[r])},get:function(e){var t=e.$relations[this.name];return t.models.values},encode:function(e,t,i){var n=e.$relations[this.name],o=i?this.save:this.store;n&&o&&(t[this.name]=this.getStoredArray(n.models.values,o))},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){t.saving=!0,t.delaySaving=!0;for(var i=t.models.values,n=0;n<i.length;n++){var o=i[n];o.$hasChanges()&&o.$save()}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&this.bulk(t,function(){for(var e=t.models.values,i=0;i<e.length;i++){var n=e[i];n.$remove()}})},checkSave:function(e){e.delaySaving||(this.store===I.Store.Model||this.save===I.Save.Model)&&e.parent.$save()},handleModelAdded:function(e){return function(t){e.isRelated(t)&&this.addModel(e,t)}},handleModel:function(e){return function(t){var i=e.pending,n=t.$key();n in i&&(this.addModel(e,t,!0),delete i[n])}},handleLazyLoad:function(e){return function(t){var i=t.values;this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModel(e,i[t])})}},addModel:function(e,t,i){var n=e.models,o=t.$key(),s=!n.has(o);return s&&(n.put(o,t),t.$on("removed",e.onRemoved),t.$on("saved remote-update",e.onSaved),this.updateForeignKey(e.parent,t),this.sort(e),i||this.checkSave(e)),s},removeModel:function(e,t,i){var n=e.models,o=e.pending,s=t.$key();n.has(s)&&(n.remove(s),t.$off("removed",e.onRemoved),t.$off("saved remote-update",e.onSaved),this.clearForeignKey(t),!i&&this.cascadeRemove&&t.$remove(),this.sort(e),this.checkSave(e)),delete o[s]},updateForeignKey:function(e,t){var i=this.foreign,n=e.$db.key;this.updateFields(t,i,e,n)},clearForeignKey:function(e){var t=this.foreign;this.clearFields(e,t)},isModelArray:function(e){if(!u(e))return!1;var t=this.model.Database,i=t.key;if(!u(i))return!1;if(i.length!==e.length)return!1;for(var n=0;n<e.length;n++)if(!a(e[n])&&!r(e[n]))return!1;return!0},isRelated:function(e){var t=this.foreign,i=e.$db.key;return function(n){return $(n,t,e,i)}},setProperty:function(e){this.property&&(e.parent[this.name]=e.models.values)},sort:function(e){var t=e.models;e.delaySorting||(t.isSorted(this.comparator)||t.sort(this.comparator),
e.parent.$trigger("relation-update",[this,e]))}}),I.Relations.hasManyThrough=j,g(new J,j,{onInitialized:function(e,t,i){var n=this.model.Database;this.foreign=i.foreign||n.name+"_"+n.key,this.local=i.local||e.name+"_"+e.key,this.comparator=V(i.comparator),this.cascadeRemove=!!i.cascadeRemove,this.cascadeSave=!!i.cascadeSave,s(i.through)?this.setThrough(i.through):I.get(i.through,this.setThrough,this),I.debug(I.Events.HASMANY_INIT,this)},setThrough:function(e){this.through=e},load:function(e){var t=this,i=this.model.Database,n=this.isRelated(e),o=e[this.name],s=e.$relations[this.name]={parent:e,isRelated:n,initial:o,pending:{},models:new w,throughs:new w,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){t.removeModel(s,this,!0)},onSaved:function(){s.saving||(n(this)?(t.sort(s),t.checkSave(s)):t.removeModel(s,this))}};if(e.$key(),i.on("model-added",this.handleModelAdded(s),this),u(o))for(var r=0;r<o.length;r++){var a=o[r],d=i.buildKeyFromInput(a);s.pending[d]=!0,i.grabModel(a,this.handleModel(s),this)}else{var l=i.models;i.ready(this.handleLazyLoad(s,l),this)}this.setProperty(s)},bulk:function(e,t){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e)},relate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var o=i.parseModel(t[e]);o&&this.addModel(n,o)}});else if(v(t)){var o=i.parseModel(t);o&&this.addModel(n,o)}},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var o=i.parseModel(t[e]);o&&this.removeModel(n,o)}});else if(v(t)){var o=i.parseModel(t);o&&this.removeModel(n,o)}else for(var s=n.models.values,r=s.length-1;r>=0;r--)this.removeModel(n,s[r])},get:function(e){var t=e.$relations[this.name];return t.models.values},encode:function(e,t,i){var n=e.$relations[this.name],o=i?this.save:this.store;n&&o&&(t[this.name]=this.getStoredArray(n.models.values,o))},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){t.saving=!0,t.delaySaving=!0;for(var i=t.models.values,n=0;n<i.length;n++){var o=i[n];o.$hasChanges()&&o.$save()}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&this.bulk(t,function(){for(var e=t.models.values,i=0;i<e.length;i++){var n=e[i];n.$remove()}})},checkSave:function(e){e.delaySaving||(this.store===I.Store.Model||this.save===I.Save.Model)&&e.parent.$save()},handleModelAdded:function(e){return function(t){e.isRelated(t)&&this.addModel(e,t)}},handleModel:function(e){return function(t){var i=e.pending,n=t.$key();n in i&&(this.addModel(e,t,!0),delete i[n])}},handleLazyLoad:function(e,t){return function(i){var n=t.filter(e.isRelated),o=n.values;this.bulk(e,function(){for(var t=0;t<o.length;t++)this.addModel(e,o[t])})}},addModel:function(e,t,i){var n=e.models,o=t.$key(),s=!n.has(o);return s&&(n.put(o,t),t.$on("removed",e.onRemoved),t.$on("saved remote-update",e.onSaved),this.updateForeignKey(e.parent,t),this.sort(e),i||this.checkSave(e)),s},removeModel:function(e,t,i){var n=e.models,o=e.pending,s=t.$key();n.has(s)&&(n.remove(s),t.$off("removed",e.onRemoved),t.$off("saved remote-update",e.onSaved),this.clearForeignKey(t),!i&&this.cascadeRemove&&t.$remove(),this.sort(e),this.checkSave(e)),delete o[s]},updateForeignKey:function(e,t){var i=this.foreign,n=e.$db.key;this.updateFields(t,i,e,n)},clearForeignKey:function(e){var t=this.foreign;this.clearFields(e,t)},isModelArray:function(e){if(!u(e))return!1;var t=this.model.Database,i=t.key;if(!u(i))return!1;if(i.length!==e.length)return!1;for(var n=0;n<e.length;n++)if(!a(e[n])&&!r(e[n]))return!1;return!0},isRelated:function(e){var t=this.foreign,i=e.$db.key;return function(n){return $(n,t,e,i)}},setProperty:function(e){this.property&&(e.parent[this.name]=e.models.values)},sort:function(e){var t=e.models;e.delaySorting||(t.isSorted(this.comparator)||t.sort(this.comparator),e.parent.$trigger("relation-update",[this,e]))}}),I.Relations.hasOne=Q,g(new J,Q,{onInitialized:function(e,t,i){var n=this.model.Database;this.local=i.local||n.name+"_"+n.key,I.debug(I.Events.HASONE_INIT,this)},load:function(e){var t=this,i=this.model.Database,n=e[this.name],o=e.$relations[this.name]={initial:n,model:null,loaded:!1,dirty:!1,saving:!1,onRemoved:function(){I.debug(I.Events.HASONE_NINJA_REMOVE,t,e,o),this.clearModel(o,!0),this.clearForeignKey(e)},onSaved:function(){o.saving||(I.debug(I.Events.HASONE_NINJA_SAVE,t,e,o),this.hasForeignKey(e,o.model)||(this.clearModel(o),this.clearForeignKey(e)))}};b(n)&&i.hasFields(e,this.local,v)&&(n=y(e,this.local),I.debug(I.Events.HASONE_INITIAL_PULLED,this,e,n)),b(n)||(I.debug(I.Events.HASONE_INITIAL,this,e,n),i.grabModel(n,this.handleLoad(e,o),this))},set:function(e,t){if(v(t)){var i=this.model.Database,n=i.parseModel(t),o=e.$relations[this.name];n&&!this.hasForeignKey(e,n)&&(this.clearModel(o),this.setRelated(e,o,n))}else this.unrelate(e)},relate:function(e,t){var i=this.model.Database,n=i.parseModel(t),o=e.$relations[this.name];n&&o.model!==n&&(this.clearModel(o),this.setRelated(e,o,n))},unrelate:function(e,t){var i=this.model.Database,n=e.$relations[this.name],o=i.parseModel(t);o&&n.model!==o||(this.clearModel(n),this.clearForeignKey(e))},setRelated:function(e,t,i){this.setModel(t,i),this.updateForeignKey(e,i),this.setProperty(e,t)},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,i){var n=e.$relations[this.name],o=i?this.save:this.store;n&&o&&(t[this.name]=this.getStored(n.model,o))},preSave:function(e){var t=e.$relations[this.name];if(t&&t.model){var i=t.model;!this.hasForeignKey(e,i),(t.dirty||i.$hasChanges())&&(I.debug(I.Events.HASONE_PRESAVE,this,e,t),t.saving=!0,i.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade!==!1&&(I.debug(I.Events.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e,t){e.model&&(I.debug(I.Events.HASONE_CLEAR_MODEL,this,e),e.model.$off("saved",e.onSaved),e.model.$off("removed",e.onRemoved),t||e.model.$remove(),e.model=null,e.dirty=!0,e.loaded=!0)},setModel:function(e,t){t.$on("saved",e.onSaved,this),t.$on("removed",e.onRemoved,this),e.model=t,e.dirty=!0,e.loaded=!0,I.debug(I.Events.HASONE_SET_MODEL,this,e)},handleLoad:function(e,t){return function(i){I.debug(I.Events.HASONE_LOADED,this,e,t,i),t.loaded===!1&&(i?(this.setModel(t,i),this.updateForeignKey(e,i)):this.clearForeignKey(e),t.loaded=!0,this.setProperty(e,t))}},hasForeignKey:function(e,t){var i=this.model.Database,n=this.local,o=i.key;return $(e,n,t,o)},clearForeignKey:function(e){var t=this.local;I.debug(I.Events.HASONE_CLEAR_KEY,this,e,t),this.clearFields(e,t)},updateForeignKey:function(e,t){var i=this.model.Database,n=this.local,o=i.key;I.debug(I.Events.HASONE_UPDATE_KEY,this,e,n,t,o),this.updateFields(e,n,t,o)},setProperty:function(e,t){this.property&&e[this.name]!==t.model&&(e[this.name]=t.model,e.$trigger("relation-update",[this,t]))}}),e.Neuro=I,e.Neuro.Model=C,e.Neuro.Database=K,e.Neuro.Relation=J,e.Neuro.Operation=U,e.Neuro.uuid=m,e.Neuro.indexOf=f,e.Neuro.extend=g,e.Neuro.transfer=p,e.Neuro.swap=O,e.Neuro.grab=R,e.Neuro.pull=y,e.Neuro.copy=M,e.Neuro.diff=A,e.Neuro.isEmpty=b,e.Neuro.compare=k,e.Neuro.equals=D,e.Neuro.equalsStrict=N,e.Neuro.createComparator=V}(window);
//# sourceMappingURL=neurosync.min.js.map
