!function(e,t){function n(e){return"undefined"!=typeof e}function i(e){return!!(e&&e.constructor&&e.call&&e.apply)}function r(e){return"string"==typeof e}function s(e){return"number"==typeof e&&!isNaN(e)}function o(e){return e instanceof Date}function u(e){return e instanceof RegExp}function a(e){return e instanceof Array}function h(e){return null!==e&&"object"==typeof e}function d(e,t){return e instanceof Array?e:e.split(t)}function E(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function f(){return E()+E()+"-"+E()+"-"+E()+"-"+E()+"-"+E()+E()+E()}function l(e,t){for(var n in e)t[n]=e[n];return t}function c(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function v(e,t,n){for(var i={},r=0;r<t.length;r++){var s=t[r];s in e&&(i[s]=n?g(e[s]):e[s])}return i}function g(e,t){if(void 0===e)return e;if(a(e)){for(var n=[],r=0;r<e.length;r++)n.push(g(e[r]));return e}if(i(e)||"object"!=typeof e||null===e)return e;if(o(e))return new Date(e.getTime());if(u(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var n={};for(var s in e)(t||"$"!==s.charAt(0))&&(n[s]=g(e[s]));return n}function p(e,t,n,i){for(var r={},s=0;s<n.length;s++){var o=n[s];o in e&&o in t&&!i(e[o],t[o])&&(r[o]=g(e[o]))}return r}function O(e){if(null===e||void 0===e||0===e)return!0;if(a(e))return 0===e.length;if(o(e))return 0===e.getTime()||isNaN(e.getTime());if(h(e)){for(var t in e)return!1;return!0}return!1}function $(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,r=typeof t;if(n!==r)return!1;var s=a(e),h=a(t);if(s!==h)return!1;if(s){if(e.length!==t.length)return!1;for(var d=0;d<e.length;d++)if(!$(e[d],t[d]))return!1;return!0}if(o(e))return o(t)&&$(e.getTime(),t.getTime());if(u(e))return u(t)&&e.toString()===t.toString();if("object"===n){for(var E in e)if(!("$"===E.charAt(0)&&i(e[E])||E in t&&$(e[E],t[E])))return!1;for(var E in t)if(!("$"===E.charAt(0)&&i(t[E])||E in e))return!1;return!0}return!1}function R(e,t){return e===t?0:t>e?-1:1}function _(e,t){return e==t?0:(o(e)&&(e=e.getTime()),o(t)&&(t=t.getTime()),s(e)&&s(t)?R(e,t):a(e)&&a(t)?R(e.length,t.length):(e+"").localeCompare(t+""))}function L(e){var t=function(e,t,i,r,s){var i=d(i," ");n(e[t])||(e[t]={});for(var o=0;o<i.length;o++)n(e[t][i[o]])||(e[t][i[o]]=[]),e[t][i[o]].push([r,s||e])};e.on=function(e,n,i){return t(this,"$on",e,n,i),this},e.once=function(e,n,i){return t(this,"$once",e,n,i),this};var r=function(e,t,n){if(e&&t in e)for(var i=e[t],r=i.length-1;r>=0;r--)i[r][0]===n&&i.splice(r,1)},s=function(e,t){e&&t in e&&delete e[t]};e.off=function(e,t){if(n(e)){var e=d(e," ");if(i(t))for(var o=0;o<e.length;o++)r(this.$on,e[o],t),r(this.$once,e[o],t);else for(var o=0;o<e.length;o++)s(this.$on,e[o]),s(this.$once,e[o])}else s(this,"$on"),s(this,"$once");return this};var o=function(e,t,n,i){if(e&&t in e){for(var r=e[t],s=r.length,o=0;s>o;o++){var u=r[o];u[0].apply(u[1],n)}i&&(r.length!==s?e[t]=r.slice(s):delete e[t])}};e.trigger=function(e,t){for(var e=d(e," "),n=0;n<e.length;n++){var i=e[n];o(this.$on,i,t,!1),o(this.$once,i,t,!0)}return this}}function m(e){var t=new A(e),n=new Function("return function "+e.className+"(props) { this.$init( props ) }")();return n.prototype=new S(t),t.model=n,t.init(),m.debug(m.Events.CREATION,e,t),{Database:t,Model:n}}function A(e){l(e,this),this.models=new y,this.rest=m.rest(this),this.store=m.store(this),this.live=m.live(this,this.handlePublish(this)),this.relations={},this.setComparator(this.comparator),this.setRevision(this.revision)}function S(e){this.$db=e}function y(){this.values=[],this.keys=[],this.indices={}}function M(e){this.interrupts=e}function V(e){this.reset(e)}function b(e){this.reset(e)}function T(e){this.reset(e)}function D(e){this.reset(e)}function N(e){this.reset(e)}function C(e){this.reset(e)}L(m),m.debug=function(e,t){},m.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},m.rest=function(e){return function(e,t,n){n({},0)}},m.store=function(e){return{put:function(e,t,n,i){},remove:function(e,t,n){},all:function(e,t){}}},m.live=function(e,t){return function(e){}},m.online=window.navigator.onLine!==!1,m.forceOffline=!1,m.setOnline=function(){m.online=!0,m.debug(m.Events.ONLINE),m.trigger("online")},m.setOffline=function(){m.online=!1,m.debug(m.Events.OFFLINE),m.trigger("offline")},m.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",m.setOnline,!1),window.addEventListener("offline",m.setOffline,!1)):(document.body.ononline=m.setOnline,document.body.onoffline=m.setOffline)},m.checkNetworkStatus=function(){var e=window.navigator.onLine;m.forceOffline&&(e=!1),e===!0&&m.online===!1?m.setOnline():e===!1&&m.online===!0&&m.setOffline()},A.prototype={pendingRefresh:!1,removeKey:function(e){var t=this.key;if(a(t))for(var n=0;n<t.length;n++)delete e[t[n]];else delete e[t]},getKey:function(e){var t=this.key,n=null;if(a(t)){var i=this.keySeparator||"/";n="";for(var r=0;r<t.length;r++)r>0&&(n+=i),n+=e[t[r]]}else n=e[t],n||(e[t]=n=f());return n},updated:function(){this.sort(),this.trigger("updated")},setRevision:function(e){i(e)?this.revisionFunction=e:r(e)?this.revisionFunction=function(t,n){return e in t&&e in n?t[e]-n[e]:!1}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e){i(e)?this.comparatorFunction=e:r(e)?"-"===e.charAt(0)?(e=e.substring(1),this.comparatorFunction=function(t,n){return _(n[e],t[e])}):this.comparatorFunction=function(t,n){return _(t[e],n[e])}:this.comparatorFunction=null},sort:function(){this.isSorted()||this.models.sort(this.comparatorFunction)},isSorted:function(){var e=this.comparatorFunction;if(!e)return!0;for(var t=this.models.values,n=0,i=t.length-1;i>n;n++)if(e(t[n],t[n+1])>0)return!1;return!0},putRemoteData:function(e,t,n){var i=this,t=t||i.getKey(e),n=n||i.models.get(t),r=i.decode(g(e));if(n){var s=this.revisionFunction(n,e);if(s!==!1&&s>0)return void m.debug(m.Events.SAVE_OLD_REVISION,n,e)}if(n&&n.$saved){var o=n.$toJSON(),u={},a=!1,h={};for(var d in e){var E=o[d],f=n.$saved[d];$(E,f)?(n[d]=r[d],h[d]=n.$local[d]=e[d]):(u[d]=e[d],a=!0),n.$saved[d]=g(e[d])}a?n.trigger("partial-update",[e,u]):n.trigger("full-update",[e,h]),n.trigger("remote-update",[e]),n.$addOperation(N)}else n=i.instantiate(r),n.$local=e,n.$saved=n.$local.$saved=g(e),n.$addOperation(N);return i.models.has(t)||(i.models.put(t,n),i.trigger("model-added",[n]),n.trigger("saved")),n},destroyLocalModel:function(e){var t=this,n=t.models.get(e);return n?n.$hasChanges()?(delete n.$saved,delete n.$local.$saved,t.removeKey(n),t.removeKey(n.$local),n.trigger("detach"),n.$addOperation(N),!1):(n.trigger("remote-remove"),n.$addOperation(b),t.models.remove(e),t.trigger("model-removed",[n]),n.trigger("removed"),m.debug(m.Events.REMOTE_REMOVE,n),!0):(t.store.remove(e,function(e){e&&m.debug(m.Events.REMOTE_REMOVE,e)}),!1)},init:function(){var e=this;return e.cache===!1?void(e.loadRemote&&e.refresh()):void e.store.all(function(t,n){m.debug(m.Events.LOCAL_LOAD,t),e.models.reset();for(var i=0;i<t.length;i++){var r=t[i],s=n[i],o=e.decode(g(r,!0)),u=e.instantiate(o);u.$local=r,r.$deleted?(m.debug(m.Events.LOCAL_RESUME_DELETE,u),u.$addOperation(T)):(r.$saved?(m.debug(m.Events.LOCAL_LOAD_SAVED,u),u.$local.$saved=u.$saved):(m.debug(m.Events.LOCAL_RESUME_SAVE,u),u.$addOperation(C)),e.models.put(s,u))}e.trigger("local-load"),e.updated(),e.loadRemote!==!1&&e.refresh()})},refresh:function(){function e(e){for(var t={},i=0;i<e.length;i++){var r=n.putRemoteData(e[i]),s=r.$key();t[s]=r}for(var o=n.models.keys,i=0;i<o.length;i++){var u=o[i];if(!(u in t)){var a=n.models.get(u);a.$saved&&(m.debug(m.Events.REMOTE_LOAD_REMOVE,u),n.destroyLocalModel(u))}}n.trigger("remote-load"),n.updated(),m.debug(m.Events.REMOTE_LOAD,e)}function t(e,t){0===t?(m.checkNetworkStatus(),m.online||(n.pendingRefresh=!0,m.once("online",function(){m.debug(m.Events.REMOTE_LOAD_RESUME),n.pendingRefresh&&(n.pendingRefresh=!1,n.refresh())})),m.debug(m.Events.REMOTE_LOAD_OFFLINE)):m.debug(m.Events.REMOTE_LOAD_ERROR,t)}var n=this,i={method:"GET",url:n.api};n.rest(i,e,t)},getModels:function(){return this.models.values},getModel:function(e){if(a(e)){for(var t=this.keySeparator||"/",n="",i=0;i<e.length;i++)i>0&&(n+=t),n+=e[i];e=n}return this.models.get(e)},handlePublish:function(e){return function(t){var n=t.key,i=t.model;switch(t.op){case"SAVE":e.putRemoteData(i,n),e.updated(),m.debug(m.Events.REALTIME_SAVE,t.model);break;case"REMOVE":e.destroyLocalModel(n)&&e.updated(),m.debug(m.Events.REALTIME_REMOVE,n)}}},instantiate:function(e){return new this.model(e)},encode:function(e){return e},decode:function(e){return e},save:function(e){var t=this,n=e.$key();return e.$deleted?void m.debug(m.Events.SAVE_DELETED,e):(t.models.has(n)?t.trigger("model-updated",[e]):(t.models.put(n,e),t.trigger("model-added",[e]),t.updated(),e.trigger("saved")),void e.$addOperation(D))},remove:function(e){var t=this,n=e.$key();t.models.has(n)&&(t.models.remove(n),t.trigger("model-removed",[e]),t.updated(),e.trigger("removed")),e.$deleted=!0,e.$pendingSave&&(m.debug(m.Events.REMOVE_CANCEL_SAVE,e),e.$pendingSave=!1),e.$addOperation(V)}},L(A.prototype),S.prototype={$init:function(e){this.$pendingSave=!1,this.$operation=null,this.$relations={},this.$reset(e)},$reset:function(e){var n=this.$db.defaults,r=this.$db.fields;if(h(n))for(var s=0;s<r.length;s++){var o=r[s];if(o in n){var u=n[o];i(u)?this[o]=u():this[o]=g(u)}else this[o]=t}else for(var s=0;s<r.length;s++){var o=r[s];this[o]=t}this.$set(e)},$set:function(e,t){if(h(e))l(e,this);else if(r(e)&&void 0!==t)if(e in this.$relations){var n=this.$db.relations[e];n.set(this,t)}else this[e]=t},$get:function(e,t){if(a(e))return v(this,e,t);if(h(e)){for(var n in e)e[n]=t?g(this[n]):this[n];return e}if(r(e)){if(e in this.$relations){var i=this.$db.relations[e],s=i.get(this);return t?g(s):s}return t?g(this[e]):this[e]}},$save:function(e,t){return this.$set(e,t),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$addOperation:function(e){var t=new e(this);this.$operation?this.$operation.queue(t):(this.$operation=t,this.$operation.execute())},$toJSON:function(){return this.$db.encode(v(this,this.$db.fields,!0))},$key:function(){return this.$db.getKey(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$getChanges:function(){var e=this.$saved,t=this.$toJSON(),n=this.$db.fields;return e?p(t,e,n,$):t},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(),t=this.$saved;for(var n in e){var i=e[n],r=t[n];if(!$(i,r))return!0}return!1}},L(S.prototype),y.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,this.values.push(t),this.keys.push(e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return s(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],n=this.values.pop(),i=this.keys.pop();return e<this.values.length&&(this.values[e]=n,this.keys[e]=i,this.indices[i]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},filter:function(e,t){for(var n=t||new y,i=this.size(),r=this.values,s=this.keys,o=0;i>o;o++){var u=r[o],a=s[o];e(u,a)&&n.put(a,u)}return n},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),n=0;t>n;n++)c(this.values,n,e-n),c(this.keys,n,e-n);return this.rebuildIndex(),this},sort:function(e){function t(t,n){for(var r=i.values[Math.floor((n+t)/2)],s=t,o=n;o>=s;){for(;e(i.values[s],r)<0;)s++;for(;e(i.values[o],r)>0;)o--;o>=s&&(c(i.values,s,o),c(i.keys,s,o),s++,o--)}return s}function n(e,i){var r=t(e,i);r-1>e&&n(e,r-1),i>r&&n(r,i)}var i=this,r=this.size()-1;return r>0&&(n(0,r),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},M.prototype={reset:function(e){this.model=e,this.db=e.$db,this.next=null,this.finished=!1},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},execute:function(){this.run(this.db,this.model)},run:function(e,t){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute()),this},tryNext:function(e){this.next||(this.next=new e(this.model))},insertNext:function(e){var t=new e(this.model);t.next=this.next,this.next=t},success:function(){var e=this;return function(){e.onSuccess.apply(e,arguments),e.finish()}},onSuccess:function(){},failure:function(){var e=this;return function(){e.onFailure.apply(e,arguments),e.finish()}},onFailure:function(){}},V.prototype=new M(!0),V.prototype.run=function(e,t){var n=t.$key();return t.$local?void(t.$saved?(t.$local.$deleted=!0,e.store.put(n,t.$local,this.success(),this.failure())):(m.debug(m.Events.REMOVE_LOCAL_UNSAVED,t),e.store.remove(n,this.success(),this.failure()))):(m.debug(m.Events.REMOVE_LOCAL_NONE,t),this.finish())},V.prototype.onSuccess=function(e,t,n){var i=this.model;m.debug(m.Events.REMOVE_LOCAL,i),i.$saved&&i.$addOperation(T)},V.prototype.onFailure=function(e){var t=this.model;m.debug(m.Events.REMOVE_LOCAL_ERROR,t,e),t.$saved&&t.$addOperation(T)},b.prototype=new M(!0),b.prototype.run=function(e,t){var n=t.$key();e.models.has(n)&&(e.models.remove(n),e.trigger("model-removed",[t]),e.updated(),t.trigger("removed")),e.store.remove(n,this.success(),this.failure())},T.prototype=new M(!0),T.prototype.run=function(e,t){t.$pendingSave=!1,t.$deleted=!0,this.key=t.$key();var n={method:"DELETE",url:e.api+this.key};e.rest(n,this.success(),this.failure())},T.prototype.onSuccess=function(e){this.finishRemove()},T.prototype.onFailure=function(e,t){var n=this.key,i=this.model;404===t||410===t?(m.debug(m.Events.REMOVE_MISSING,n,i),this.finishRemove()):0!==t?m.debug(m.Events.REMOVE_ERROR,t,n,i):(m.checkNetworkStatus(),m.online||m.once("online",function(){m.debug(m.Events.REMOVE_RESUME,i),i.$addOperation(T)}),m.debug(m.Events.REMOVE_OFFLINE,i))},T.prototype.finishRemove=function(){var e=this.db,t=this.key,n=this.model;m.debug(m.Events.REMOVE_REMOTE,t,n),this.insertNext(b),m.debug(m.Events.REMOVE_PUBLISH,t,n),e.live({op:"REMOVE",key:t})},D.prototype=new M(!1),D.prototype.run=function(e,t){if(t.$deleted)return m.debug(m.Events.SAVE_LOCAL_DELETED,t),this.finish();var n=t.$toJSON();t.$local?l(n,t.$local):t.$local=n,e.store.put(t.$key(),t.$local,this.success(),this.failure())},D.prototype.onSuccess=function(e,t,n){var i=this.model;m.debug(m.Events.SAVE_LOCAL,i),this.tryNext(C)},D.prototype.onFailure=function(e){var t=this.model;m.debug(m.Events.SAVE_LOCAL_ERROR,t,e),this.tryNext(C)},N.prototype=new M(!1),N.prototype.run=function(e,t){e.store.put(t.$key(),t.$local,this.success(),this.failure())},C.prototype=new M(!1),C.prototype.run=function(e,t){if(t.$deleted)return m.debug(m.Events.SAVE_REMOTE_DELETED,t),this.finish();var n=this.key=t.$key(),i=this.saving=t.$getChanges();if(O(i))return this.finish();var r={method:t.$saved?"PUT":"POST",url:t.$saved?e.api+n:e.api,data:i};e.rest(r,this.success(),this.failure())},C.prototype.onSuccess=function(e){var t=this.model;m.debug(m.Events.SAVE_REMOTE,t),this.handleData(e)},C.prototype.onFailure=function(e,t){var n=(this.db,this.model);409===t?(m.debug(m.Events.SAVE_CONFLICT,e,n),this.handleData(e,n,this.db)):410===t||404===t?(m.debug(m.Events.SAVE_UPDATE_FAIL,n),this.insertNext(b)):0!==t?m.debug(m.Events.SAVE_ERROR,n,t):(m.checkNetworkStatus(),m.online||(n.$pendingSave=!0,m.once("online",function(){n.$pendingSave&&(n.$pendingSave=!1,n.$addOperation(C),m.debug(m.Events.SAVE_RESUME,n))})),m.debug(m.Events.SAVE_OFFLINE,n))},C.prototype.handleData=function(e){var t=this.db,n=this.model,i=this.saving;if(n.$deleted)return void m.debug(m.Events.SAVE_REMOTE_DELETED,n,e);for(var r in e)r in i||(i[r]=e[r]);m.debug(m.Events.SAVE_VALUES,i,n),n.$saved||(n.$saved=n.$local.$saved={}),t.putRemoteData(i,this.key,n),m.debug(m.Events.SAVE_PUBLISH,i,n),t.live({op:"SAVE",model:i,key:this.key})},e.Neuro=m}(window);
//# sourceMappingURL=neurosync.min.js.map
