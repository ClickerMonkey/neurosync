!function(e,n){function t(e){return"undefined"!=typeof e}function r(e){return!!(e&&e.constructor&&e.call&&e.apply)}function i(e){return"string"==typeof e}function o(e){return"number"==typeof e&&!isNaN(e)}function s(e){return e instanceof Date}function u(e){return e instanceof RegExp}function E(e){return e instanceof Array}function a(e){return null!==e&&"object"==typeof e}function d(e,n){return e instanceof Array?e:e.split(n)}function f(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function c(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()}function v(e,n){for(var t in e)n[t]=e[t];return n}function l(e,n,t){for(var r={},i=0;i<n.length;i++){var o=n[i];o in e&&(r[o]=t?O(e[o]):e[o])}return r}function O(e,n){if(void 0===e)return e;if(E(e)){for(var t=[],i=0;i<e.length;i++)t.push(O(e[i]));return e}if(r(e)||"object"!=typeof e||null===e)return e;if(s(e))return new Date(e.getTime());if(u(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var t={};for(var o in e)(n||"$"!==o.charAt(0))&&(t[o]=O(e[o]));return t}function h(e,n,t,r){for(var i={},o=0;o<t.length;o++){var s=t[o];s in e&&s in n&&!r(e[s],n[s])&&(i[s]=O(e[s]))}return i}function $(e){if(null===e||void 0===e||0===e)return!0;if(E(e))return 0===e.length;if(s(e))return 0===e.getTime()||isNaN(e.getTime());if(a(e)){for(var n in e)return!1;return!0}return!1}function g(e,n){if(e===n)return!0;if(null===e||null===n)return!1;if(e!==e&&n!==n)return!0;var t=typeof e,i=typeof n;if(t!==i)return!1;var o=E(e),a=E(n);if(o!==a)return!1;if(o){if(e.length!==n.length)return!1;for(var d=0;d<e.length;d++)if(!g(e[d],n[d]))return!1;return!0}if(s(e))return s(n)&&g(e.getTime(),n.getTime());if(u(e))return u(n)&&e.toString()===n.toString();if("object"===t){for(var f in e)if(!("$"===f.charAt(0)&&r(e[f])||f in n&&g(e[f],n[f])))return!1;for(var f in n)if(!("$"===f.charAt(0)&&r(n[f])||f in e))return!1;return!0}return!1}function R(e,n){return e===n?0:n>e?-1:1}function L(e,n){return e==n?0:(s(e)&&(e=e.getTime()),s(n)&&(n=n.getTime()),o(e)&&o(n)?R(e,n):E(e)&&E(n)?R(e.length,n.length):(e+"").localeCompare(n+""))}function _(e){var n=function(e,n,r,i,o){var r=d(r," ");t(e[n])||(e[n]={});for(var s=0;s<r.length;s++)t(e[n][r[s]])||(e[n][r[s]]=[]),e[n][r[s]].push([i,o||e])};e.on=function(e,t,r){return n(this,"$on",e,t,r),this},e.once=function(e,t,r){return n(this,"$once",e,t,r),this};var i=function(e,n,t){if(e&&n in e)for(var r=e[n],i=r.length-1;i>=0;i--)r[i][0]===t&&r.splice(i,1)},o=function(e,n){e&&n in e&&delete e[n]};e.off=function(e,n){if(t(e)){var e=d(e," ");if(r(n))for(var s=0;s<e.length;s++)i(this.$on,e[s],n),i(this.$once,e[s],n);else for(var s=0;s<e.length;s++)o(this.$on,e[s]),o(this.$once,e[s])}else o(this,"$on"),o(this,"$once");return this};var s=function(e,n,t,r){if(e&&n in e){for(var i=e[n],o=i.length,s=0;o>s;s++){var u=i[s];u[0].call(u[1],t)}r&&(i.length!==o?e[n]=i.slice(o):delete e[n])}};e.trigger=function(e,n){for(var e=d(e," "),t=0;t<e.length;t++){var r=e[t];s(this.$on,r,n,!1),s(this.$once,r,n,!0)}return this}}function A(e){var n=new S(e),t=new Function("return function "+e.className+"(props) { this.$reset( props ) }")();return t.prototype=new b(n),t.db=n,n.model=t,n.init(),A.debug(A.Events.CREATION,e,n),{Database:n,Model:t}}function S(e){v(e,this);var n=A.getPubSub(e.pubsub);this.stork=new Stork(e),this.models=new Stork.FastMap,this.channel=n.subscribe(e.channel,e.token),this.channel.onpublish=this.handlePublish(this)}function b(e){this.$db=e,this.$promise=Stork.Promise.Done(this),this.$pendingSave=!1,this.$pendingRemove=!1}_(A),A.debug=function(e,n){},A.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},A.rest=function(e,n){n.$failure([{},0])},A.getPubSub=function(e){if(!(e in A.pubsubs)){var n=new PubSub(e);A.pubsubs[e]=n,A.debug(A.Events.PUBSUB_CREATED,n)}return A.pubsubs[e]},A.pubsubs={},A.online=window.navigator.onLine!==!1,A.forceOffline=!1,A.setOnline=function(){A.online=!0,A.debug(A.Events.ONLINE),A.trigger("online")},A.setOffline=function(){A.online=!1,A.debug(A.Events.OFFLINE),A.trigger("offline")},A.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",A.setOnline,!1),window.addEventListener("offline",A.setOffline,!1)):(document.body.ononline=A.setOnline,document.body.onoffline=A.setOffline)},A.checkNetworkStatus=function(){var e=window.navigator.onLine;A.forceOffline&&(e=!1),e===!0&&A.online===!1?A.setOnline():e===!1&&A.online===!0&&A.setOffline()},S.prototype={$pendingLoad:!1,generateKey:function(){return c()},updated:function(){var e=this.comparator;if(r(e))this.models.sort(e);else if(i(e)){var n=1;"-"===e.charAt(0)&&(e=e.substring(1),n=-1),this.models.sort(function(t,r){return n*L(t[e],r[e])})}this.trigger("updated")},putRemoteData:function(e,n,t){var r=this,n=n||e[r.key],t=t||r.models.get(n),i=r.decode(O(e));if(t&&t.$saved){var o=t.$toJSON();for(var s in e){var u=o[s],E=t.$saved[s];g(u,E)&&(t[s]=i[s],t.$local[s]=e[s]),t.$saved[s]=O(e[s])}t.$queue(function(){return A.debug(A.Events.REMOTE_UPDATE,e,t),r.stork.save(t.$local)})}else t=r.instantiate(i),t.$local=e,t.$saved=t.$local.$saved=O(e),t.$queue(function(){return A.debug(A.Events.REMOTE_CREATE,e,t),r.stork.save(t.$local)}),r.models.put(n,t);return t.trigger("saved"),t},destroyLocalModel:function(e){var n=this,t=n.models.get(e);return t?t.$hasChanges()?(delete t.$saved,delete t.$local.$saved,delete t[n.key],delete t.$local[n.key],t.$queue(function(){return n.stork.save(t.$local)}),!1):(t.$queue(function(){return n.stork.remove(e)},!0),n.models.remove(e),t.trigger("removed"),A.debug(A.Events.REMOTE_REMOVE,t),!0):(n.stork.remove(e,function(e){e&&A.debug(A.Events.REMOTE_REMOVE,e)}),!1)},init:function(){var e=this;e.PROMISED=new Stork.Promise(e).$success(),e.stork.all(function(n,t){A.debug(A.Events.LOCAL_LOAD,n),e.models.reset();for(var r=0;r<n.length;r++){var i=n[r],o=t[r],s=e.decode(O(i,!0)),u=e.instantiate(s);u.$local=i,i.$deleted?(A.debug(A.Events.LOCAL_RESUME_DELETE,u),e.removeRemote(u)):(i.$saved?A.debug(A.Events.LOCAL_LOAD_SAVED,u):(A.debug(A.Events.LOCAL_RESUME_SAVE,u),e.saveRemote(u)),e.models.put(o,u))}e.updated(),e.loadRemote()})},loadRemote:function(){var e=this,n=new Stork.Promise(this),t={method:"GET",url:this.rest};A.rest(t,n),n.then(function(n){for(var t={},r=0;r<n.length;r++){var i=e.putRemoteData(n[r]),o=i.$key();t[o]=i}for(var s=e.models.keys,r=0;r<s.length;r++){var u=s[r];if(!(u in t)){var E=e.models.get(u);E.$saved&&(A.debug(A.Events.REMOTE_LOAD_REMOVE,u),e.destroyLocalModel(u))}}e.updated(),A.debug(A.Events.REMOTE_LOAD,n)},function(n,t){0===t?(A.checkNetworkStatus(),A.online||(e.$pendingLoad=!0,A.once("online",function(){A.debug(A.Events.REMOTE_LOAD_RESUME),e.$pendingLoad&&(e.$pendingLoad=!1,e.loadRemote())})),A.debug(A.Events.REMOTE_LOAD_OFFLINE)):A.debug(A.Events.REMOTE_LOAD_ERROR,t)})},getModels:function(){return this.models.values},handlePublish:function(e){return function(n){var t=n.key,r=n.model;switch(n.op){case"SAVE":e.putRemoteData(r,t),e.updated(),A.debug(A.Events.REALTIME_SAVE,n.model);break;case"REMOVE":e.destroyLocalModel(t)&&e.updated(),A.debug(A.Events.REALTIME_REMOVE,t)}}},instantiate:function(e){return new this.model(e)},encode:function(e){return e},decode:function(e){return e},waitForPending:function(e,n,t){var r=this;return e.$pending()?(e.either(function(){n.apply(r,t)}),!0):(e.$reset(),!1)},interruptPending:function(e){e.$clear()},saveRemote:function(e){var n=this,t=e.$promise,r=new Stork.Promise(e);if(e.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,e),t;if(n.waitForPending(t,this.saveRemote,arguments))return A.debug(A.Events.SAVE_REMOTE_BLOCKED,e),t;var i=e.$toJSON(),o=e.$saved?h(i,e.$saved,n.fields,g):i;if($(o))return t.$success();var s=e.$key(),u={method:e.$saved?"PUT":"POST",url:e.$saved?n.rest+s:n.rest,data:o};A.rest(u,r);var E=function(r){if(e.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,e,r),t.$failure();for(var i in r)i in o||(o[i]=r[i]);A.debug(A.Events.SAVE_VALUES,o,e),e.$saved||(e.$saved=e.$local.$saved={}),n.putRemoteData(o,s,e),t.$success(),A.debug(A.Events.SAVE_PUBLISH,o,e),n.channel.publish({op:"SAVE",model:o,key:s})};return r.then(function(n){A.debug(A.Events.SAVE_REMOTE,e),E(n)},function(r,i){409===i?(A.debug(A.Events.SAVE_CONFLICT,r,e),E(r)):410===i||404===i?(A.debug(A.Events.SAVE_UPDATE_FAIL,e),t.$failure(),e.$queue(function(){return n.models.remove(s),n.stork.remove(s)})):0!==i?(A.debug(A.Events.SAVE_ERROR,e,i),t.$failure()):(A.checkNetworkStatus(),A.online?t.$failure():(e.$pendingSave=!0,A.once("online",function(){e.$pendingSave&&(e.$pendingSave=!1,A.debug(A.Events.SAVE_RESUME,e),n.saveRemote(e,!0))}),t.$success()),A.debug(A.Events.SAVE_OFFLINE,e))}),t},save:function(e){var n=this,t=e.$promise,r=e.$key();return e.$deleted?(A.debug(A.Events.SAVE_DELETED,e),t):(n.models.has(r)||(n.models.put(r,e),n.updated()),n.saveLocal(e))},saveLocal:function(e){var n=this,t=e.$promise,r=e.$toJSON();if(e.$deleted)return A.debug(A.Events.SAVE_LOCAL_DELETED,e),t;if(n.waitForPending(t,this.saveLocal,arguments))return A.debug(A.Events.SAVE_LOCAL_BLOCKED,mdoel),t;e.$local?v(r,e.$local):e.$local=r;var i=n.stork.save(e.$local),o=function(){t.$success(),n.saveRemote(e)};return i.then(function(n){A.debug(A.Events.SAVE_LOCAL,e),o()},function(n){A.debug(A.Events.SAVE_LOCAL_ERROR,e,n),o()}),t},removeRemote:function(e){var n=this,t=e.$promise,r=new Stork.Promise(e),i=e.$key();if(e.$pendingSave=!1,e.$deleted=!0,n.interruptPending(t),n.waitForPending(t,this.removeRemote,arguments))return A.debug(A.Events.REMOVE_REMOTE_BLOCKED,e),t;var o={method:"DELETE",url:this.rest+i};A.rest(o,r);var s=function(){A.debug(A.Events.REMOVE_LOCAL,i,e),t.$bindTo(n.stork.remove(i)),e.trigger("removed"),A.debug(A.Events.REMOVE_PUBLISH,i,e),n.channel.publish({op:"REMOVE",key:i})};return r.then(function(n){A.debug(A.Events.REMOVE_REMOTE,e),s()},function(n,r){404===r||410===r?(A.debug(A.Events.REMOVE_MISSING,i,e),s()):0!==r?(A.debug(A.Events.REMOVE_ERROR,r,i,e),t.$failure()):(A.checkNetworkStatus(),A.online?t.$failure():(A.once("online",function(){A.debug(A.Events.REMOVE_RESUME,e)}),t.$success()),A.debug(A.Events.REMOVE_OFFLINE,e))}),t},removeLocal:function(e){var n=this,t=e.$promise,r=e.$key();if(n.interruptPending(t),n.waitForPending(t,this.removeLocal,arguments))return A.debug(A.Events.REMOVE_LOCAL_BLOCKED,e),t;if(!e.$local)return A.debug(A.Events.REMOVE_LOCAL_NONE,e),t.$success();if(e.$saved){e.$local.$deleted=!0;var i=n.stork.save(e.$local),o=function(){e.$saved?(n.interruptPending(t),t.$success(),n.removeRemote(e)):t.$success()};i.then(function(n){A.debug(A.Events.REMOVE_LOCAL,e),o()},function(n){A.debug(A.Events.REMOVE_LOCAL_ERROR,e,n),o()})}else A.debug(A.Events.REMOVE_LOCAL_UNSAVED,e),t.$bindTo(n.stork.remove(r));return t},remove:function(e){var n=this,t=e.$key();return n.models.has(t)&&(n.models.remove(t),n.updated()),e.$deleted=!0,e.$pendingSave&&(A.debug(A.Events.REMOVE_CANCEL_SAVE,e),e.$pendingSave=!1),n.removeLocal(e)}},_(S.prototype),b.prototype={$set:function(e,n){a(e)?v(e,this):i(e)&&void 0!==n&&(this[e]=n)},$get:function(e,n){if(E(e))return l(this,e,n);if(a(e)){for(var t in e)e[t]=n?O(this[t]):this[t];return e}return i(e)?n?O(this[e]):this[e]:void 0},$save:function(e,n){return this.$set(e,n),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$queue:function(e,n){var t=this.$promise;return n&&t.$clear(),t.either(function(){t.$reset(),t.$bindTo(e())}),t},$reset:function(e){var t=this.$db.defaults,i=this.$db.fields;if(a(t))for(var o=0;o<i.length;o++){var s=i[o];if(s in t){var u=t[s];r(u)?this[s]=u():this[s]=O(u)}else this[s]=n}else for(var o=0;o<i.length;o++){var s=i[o];this[s]=n}this.$set(e)},$toJSON:function(){return this.$db.encode(l(this,this.$db.fields,!0))},$key:function(){var e=this.$db.key;return e in this?this[e]:this[e]=this.$db.generateKey()},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(),n=this.$saved;for(var t in e){var r=e[t],i=n[t];if(!g(r,i))return!0}return!1}},_(b.prototype),e.Neuro=A}(window);
//# sourceMappingURL=neurosync.min.js.map
