!function(e,t){function n(e){return e!==t}function i(e){return!!(e&&e.constructor&&e.call&&e.apply)}function o(e){return i(e)&&e.prototype instanceof C}function r(e){return!!(e&&e.Model&&e.Database)}function s(e){return"string"==typeof e}function a(e){return"number"==typeof e&&!isNaN(e)}function u(e){return e instanceof Date}function d(e){return e instanceof RegExp}function l(e){return e instanceof Array}function h(e){return null!==e&&"object"==typeof e}function c(e,t){return e instanceof Array?e:e.split(t)}function f(e){return e!==t&&null!==e}function v(e,t,n){for(var i=n||M,o=0,r=e.length;r>o;o++)if(i(e[o],t))return o;return!1}function E(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function g(){return E()+E()+"-"+E()+"-"+E()+"-"+E()+"-"+E()+E()+E()}function m(e,t,n){t.prototype=e;for(var i in n)t.prototype[i]=n[i]}function O(e,t,n,i){if(s(t))return e[t]===n[i];for(var o=0;o<t.length;o++){var r=t[o],a=i[o];if(!b(e[r],n[a]))return!1}return!0}function p(e,t){for(var n in e)t[n]=e[n];return t}function $(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function S(e){return f(e)?r(e)?new e.Model:o(e)?new e:i(e)?e():L(e):e}function y(e,t,n){for(var i={},o=0;o<t.length;o++){var r=t[o];r in e&&(i[r]=n?L(e[r]):e[r])}return i}function _(e,t,n){if(s(t)){var i=e[t];return n?L(i):i}for(var o=[],r=0;r<t.length;r++){var a=t[r],i=e[a];o.push(n?L(i):i)}return o}function R(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function L(e,t){if(void 0===e)return e;if(l(e)){for(var n=[],o=0;o<e.length;o++)n.push(L(e[o]));return e}if(i(e)||"object"!=typeof e||null===e)return e;if(u(e))return new Date(e.getTime());if(d(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var n={};for(var r in e)(t||"$"!==r.charAt(0))&&(n[r]=L(e[r]));return n}function A(e,t,n,i){for(var o={},r=0;r<n.length;r++){var s=n[r];i(e[s],t[s])||(o[s]=L(e[s]))}return o}function N(e){if(null===e||void 0===e||0===e)return!0;if(l(e)||s(e))return 0===e.length;if(u(e))return 0===e.getTime()||isNaN(e.getTime());if(h(e)){for(var t in e)return!1;return!0}return!1}function M(e,t){return e===t}function b(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,o=typeof t;if(n!==o)return!1;var r=l(e),s=l(t);if(r!==s)return!1;if(r){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!b(e[a],t[a]))return!1;return!0}if(u(e))return u(t)&&b(e.getTime(),t.getTime());if(d(e))return d(t)&&e.toString()===t.toString();if("object"===n){for(var h in e)if(!("$"===h.charAt(0)&&i(e[h])||h in t&&b(e[h],t[h])))return!1;for(var h in t)if(!("$"===h.charAt(0)&&i(t[h])||h in e))return!1;return!0}return!1}function T(e,t){return e===t?0:t>e?-1:1}function D(e,t){return e==t?0:(u(e)&&(e=e.getTime()),u(t)&&(t=t.getTime()),a(e)&&a(t)?T(e,t):l(e)&&l(t)?T(e.length,t.length):(e+"").localeCompare(t+""))}function V(e){return i(e)?e:s(e)?"-"===e.charAt(0)?(e=e.substring(1),function(t,n){return D(n[e],t[e])}):function(t,n){return D(t[e],n[e])}:null}function I(e,t){function o(e,t,o,r,s){if(i(r)){var o=c(o," ");n(e[t])||(e[t]={});for(var a=0;a<o.length;a++)n(e[t][o[a]])||(e[t][o[a]]=[]),e[t][o[a]].push([r,s||e])}}function r(e,t,n){return o(this,"$$on",e,t,n),this}function s(e,t,n){return o(this,"$$once",e,t,n),this}function a(e,t,n){if(e&&t in e)for(var i=e[t],o=i.length-1;o>=0;o--)i[o][0]===n&&i.splice(o,1)}function u(e,t){e&&t in e&&delete e[t]}function d(e,t){if(n(e)){var e=c(e," ");if(i(t))for(var o=0;o<e.length;o++)a(this.$$on,e[o],t),a(this.$$once,e[o],t);else for(var o=0;o<e.length;o++)u(this.$$on,e[o]),u(this.$$once,e[o])}else u(this,"$$on"),u(this,"$$once");return this}function l(e,t,n,i){if(e&&t in e){for(var o=e[t],r=o.length,s=0;r>s;s++){var a=o[s];a&&a[0].apply(a[1],n)}i&&(o.length!==r?e[t]=o.slice(r):delete e[t])}}function h(e,t){for(var e=c(e," "),n=0;n<e.length;n++){var i=e[n];l(this.$$on,i,t,!1),l(this.$$once,i,t,!0)}return this}t?(e.$on=r,e.$once=s,e.$off=d,e.$trigger=h):(e.on=r,e.once=s,e.off=d,e.trigger=h)}function F(e){var t=new k(e),n=new Function("return function "+e.className+"(props, exists) { this.$init( props, exists ) }")();return n.prototype=new C(t),t.model=n,t.init(),F.debug(F.Events.CREATION,t,e),n.Database=t,n.Model=n,F.cache[e.name]=n,F.cache[e.className]=n,F.trigger("initialized",[n]),n}function k(e){p(e,this),this.models=new K,this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.rest=F.rest(this),this.store=F.store(this),this.live=F.live(this,this.handlePublish(this)),this.setComparator(this.comparator),this.setRevision(this.revision),this.relations={};for(var t in e)if(t in F.RELATIONS){var n=F.RELATIONS[t];if(n.prototype instanceof z){var i=e[t];for(var o in i){var r=i[o],s=new n;s.init(this,o,r),this.relations[o]=s}}}}function C(e){this.$db=e}function K(){this.values=[],this.keys=[],this.indices={}}function w(e,t){this.interrupts=e,this.type=t}function P(e){this.reset(e)}function U(e){this.reset(e)}function B(e){this.reset(e)}function x(e){this.reset(e)}function H(e){this.reset(e)}function G(e){this.reset(e)}function z(){}function J(){this.type="belongsTo"}function Y(){this.type="hasMany"}function q(){this.type="hasOne"}F.cache={},F.get=function(t,n,o){function r(e){(e.name===t||e.className===t)&&(n.call(a,e),F.off("initialized",r))}var s=F.cache[t],a=o||e;return i(n)&&(s?n.call(a,s):F.on("initialized",r)),s},F.RELATIONS={},I(F),F.debug=function(e,t){},F.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_NINJA_SAVE:50,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_PRESAVE:68,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:71},F.rest=function(e){return function(e,t,n,i,o){o({},0)}},F.store=function(e){return{put:function(e,t,n,i){},remove:function(e,t,n){},all:function(e,t){}}},F.live=function(e,t){return function(e){}},F.online=window.navigator.onLine!==!1,F.forceOffline=!1,F.setOnline=function(){F.online=!0,F.debug(F.Events.ONLINE),F.trigger("online")},F.setOffline=function(){F.online=!1,F.debug(F.Events.OFFLINE),F.trigger("offline")},F.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",F.setOnline,!1),window.addEventListener("offline",F.setOffline,!1)):(document.body.ononline=F.setOnline,document.body.onoffline=F.setOffline)},F.checkNetworkStatus=function(){var e=window.navigator.onLine;F.forceOffline&&(e=!1),e===!0&&F.online===!1?F.setOnline():e===!1&&F.online===!0&&F.setOffline()},k.prototype={toString:function(e){return""},ready:function(e,t,n){function i(){r.off("local-load remote-load",o)}function o(){n||i(),(!a||n)&&(e.call(s,r)===!1&&i(),a=!0)}var r=this,s=t||r,a=!1;return r.initialized?(e.call(s,r),a=!0):r.on("local-load remote-load",o),a},grabModel:function(e,t,n){function i(){var n=o.parseModel(e,!0);return n!==!1&&t.call(r,n),n}var o=this,r=n||o;i()&&o.ready(i,o,!0)},parseModel:function(e,n){var i=this;if(!f(e))return i.remoteLoaded?null:!1;r(e)?e=new e.Model:o(e)&&(e=new e);var s=i.buildKeyFromInput(e);return e instanceof i.model?(i.models.has(s)||i.models.put(s,e),e):i.models.has(s)?i.models.get(s):h(e)?i.putRemoteData(e,t,t,n):i.remoteLoaded?null:!1},removeKey:function(e){var t=this.key;if(l(t))for(var n=0;n<t.length;n++)delete e[t[n]];else delete e[t]},buildKey:function(e,t){var n=this.buildKeys(e,t);return l(n)&&(n=n.join(this.keySeparator||"/")),n},buildKeys:function(e,t){var n=null;if(l(t)){n=[];for(var i=0;i<t.length;i++)n.push(e[t[i]])}else n=e[t],n||(n=e[t]=g());return n},buildKeyFromInput:function(e){return e instanceof this.model?e.$key():l(e)?this.buildKeyFromArray(e):h(e)?this.buildKey(e,this.key):e},buildKeyFromArray:function(e){for(var t=this.keySeparator||"/",n="",i=0;i<e.length;i++)i>0&&(n+=t),n+=e[i];return n},getKey:function(e){return this.buildKey(e,this.key)},getKeys:function(e){return this.buildKeys(e,this.key)},hasFields:function(e,t,n){if(l(t)){for(var i=0;i<t.length;i++)if(!n(e[t[i]]))return!1;return!0}return n(e[t])},updated:function(){this.sort(),this.trigger("updated")},setRevision:function(e){i(e)?this.revisionFunction=e:s(e)?this.revisionFunction=function(t,n){return e in t&&e in n?t[e]-n[e]:!1}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e){this.comparatorFunction=V(e)},sort:function(){this.isSorted()||this.models.sort(this.comparatorFunction)},isSorted:function(){return this.models.isSorted(this.comparatorFunction)},putRemoteData:function(e,t,n,i){var o=this,t=t||o.getKey(e),n=n||o.models.get(t),r=o.decode(L(e));if(n){var s=this.revisionFunction(n,e);if(s!==!1&&s>0)return void F.debug(F.Events.SAVE_OLD_REVISION,o,n,e)}if(n&&n.$saved){var a=n.$toJSON(!0),u={},d=!1,l={};for(var h in e)if("$"!==h.charAt(0)){var c=a[h],f=n.$saved[h];b(c,f)?(n[h]=r[h],l[h]=e[h],o.cache!==!1&&(n.$local[h]=e[h])):(u[h]=e[h],d=!0),n.$saved[h]=L(e[h])}d?n.$trigger("partial-update",[e,u]):n.$trigger("full-update",[e,l]),n.$trigger("remote-update",[e]),o.cache!==!1&&n.$addOperation(H)}else n=o.instantiate(r,i),o.cache!==!1?(n.$local=e,n.$saved=n.$local.$saved=L(e),n.$addOperation(H)):n.$saved=R(e);return o.models.has(t)||(o.models.put(t,n),o.trigger("model-added",[n]),i||n.$trigger("saved")),n},destroyLocalUncachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,n.removeKey(e),e.$trigger("detach"),!1):(e.$trigger("remote-remove"),n.models.remove(t),n.trigger("model-removed",[e]),e.$trigger("removed"),F.debug(F.Events.REMOTE_REMOVE,n,e),!0):!1},destroyLocalCachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,delete e.$local.$saved,n.removeKey(e),n.removeKey(e.$local),e.$trigger("detach"),e.$addOperation(H),!1):(e.$trigger("remote-remove"),e.$addOperation(U),n.models.remove(t),n.trigger("model-removed",[e]),e.$trigger("removed"),F.debug(F.Events.REMOTE_REMOVE,n,e),!0):(n.store.remove(t,function(e){e&&F.debug(F.Events.REMOTE_REMOVE,n,e)}),!1)},destroyLocalModel:function(e){var t=this,n=t.models.get(e);return t.cache===!1?t.destroyLocalUncachedModel(n,e):t.destroyLocalCachedModel(n,e)},init:function(){var e=this;return e.cache===!1?void(e.loadRemote!==!1&&e.refresh()):void e.store.all(function(t,n){F.debug(F.Events.LOCAL_LOAD,e,t),e.models.reset();for(var i=0;i<t.length;i++){var o=t[i],r=n[i],s=e.decode(L(o,!0)),a=e.instantiate(s,!0);a.$local=o,o.$deleted?(F.debug(F.Events.LOCAL_RESUME_DELETE,e,a),a.$addOperation(B)):(o.$saved?(F.debug(F.Events.LOCAL_LOAD_SAVED,e,a),a.$local.$saved=a.$saved):(F.debug(F.Events.LOCAL_RESUME_SAVE,e,a),a.$addOperation(G)),r===a.$key()?e.models.put(r,a):e.store.remove(r))}e.initialized=!0,e.localLoaded=!0,e.trigger("local-load",[e]),e.updated(),e.loadRemote!==!1&&e.refresh()})},refresh:function(){function e(e){for(var t={},n=0;n<e.length;n++){var o=i.putRemoteData(e[n]),r=o.$key();t[r]=o}for(var s=i.models.keys,n=0;n<s.length;n++){var a=s[n];if(!(a in t)){var u=i.models.get(a);u.$saved&&(F.debug(F.Events.REMOTE_LOAD_REMOVE,i,a),i.destroyLocalModel(a))}}i.initialized=!0,i.remoteLoaded=!0,i.trigger("remote-load",[i]),i.updated(),F.debug(F.Events.REMOTE_LOAD,i,e)}function n(e,t){0===t?(F.checkNetworkStatus(),F.online||(i.pendingRefresh=!0,F.once("online",function(){F.debug(F.Events.REMOTE_LOAD_RESUME,i),i.pendingRefresh&&(i.pendingRefresh=!1,i.refresh())})),F.debug(F.Events.REMOTE_LOAD_OFFLINE,i)):F.debug(F.Events.REMOTE_LOAD_ERROR,i,t)}var i=this;i.rest("GET",t,t,e,n)},getModels:function(){return this.models.values},getModel:function(e){return l(e)&&(e=this.buildKeyFromArray(e)),this.models.get(e)},handlePublish:function(e){return function(t){var n=t.key,i=t.model;switch(t.op){case"SAVE":e.putRemoteData(i,n),e.updated(),F.debug(F.Events.REALTIME_SAVE,e,t.model,n);break;case"REMOVE":e.destroyLocalModel(n)&&e.updated(),F.debug(F.Events.REALTIME_REMOVE,e,n)}}},instantiate:function(e,t){return new this.model(e,t)},encode:function(e){return e},decode:function(e){return e},save:function(e){var t=this,n=e.$key();return e.$deleted?void F.debug(F.Events.SAVE_DELETED,t,e):(t.models.has(n)?(t.trigger("model-updated",[e]),e.$trigger("updated saved")):(t.models.put(n,e),t.trigger("model-added",[e]),t.updated(),e.$trigger("created saved")),void(t.cache===!1?e.$addOperation(G):e.$addOperation(x)))},remove:function(e){var t=this,n=e.$key();t.models.has(n)&&(t.models.remove(n),t.trigger("model-removed",[e]),t.updated(),e.$trigger("removed")),e.$deleted=!0,e.$pendingSave&&(F.debug(F.Events.REMOVE_CANCEL_SAVE,t,e),e.$pendingSave=!1),t.cache===!1?e.$addOperation(B):e.$addOperation(P)}},I(k.prototype),C.prototype={$init:function(e,t){if(this.$pendingSave=!1,this.$operation=null,this.$relations={},t?this.$set(e):this.$reset(e),this.$db.loadRelations){var n=this.$db.relations;for(var i in n)this.$getRelation(i)}},$reset:function(e){var n=this.$db.defaults,i=this.$db.fields,o=this.$db.relations;if(h(n)){for(var r=0;r<i.length;r++){var s=i[r],a=n[s],u=S(a);this[s]=u}for(var s in o)if(s in n){var a=n[s],u=S(a),d=this.$getRelation(s);d.set(this,u)}}else for(var r=0;r<i.length;r++){var s=i[r];this[s]=t}this.$set(e)},$set:function(e,t){if(h(e))p(e,this);else if(s(e)){var n=this.$getRelation(e);n?n.set(this,t):this[e]=t}},$get:function(e,t){if(l(e))return y(this,e,t);if(h(e)){for(var n in e)e[n]=t?L(this[n]):this[n];return e}if(s(e)){var i=this.$getRelation(e);if(i){var o=i.get(this);return t?L(o):o}return t?L(this[e]):this[e]}},$relate:function(e,t){var n=this.$getRelation(e);n&&n.relate(this,t)},$unrelate:function(e,t){var n=this.$getRelation(e);n&&n.unrelate(this,t)},$getRelation:function(e){var t=this.$db.relations;if(e in t){var n=t[e];return e in this.$relations||n.load(this),n}return!1},$save:function(e,t){this.$set(e,t),this.$callRelationFunction("preSave"),this.$db.save(this),this.$callRelationFunction("postSave")},$remove:function(){this.$exists()&&(this.$callRelationFunction("preRemove"),this.$db.remove(this),this.$callRelationFunction("postRemove"))},$exists:function(){return!this.$deleted&&this.$db.models.has(this.$key())},$callRelationFunction:function(e){var t=this.$db.relations;for(var n in t)t[n][e](this)},$addOperation:function(e){var t=new e(this);this.$operation?this.$operation.queue(t):(this.$operation=t,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(y(this,this.$db.fields,!0)),n=this.$db.relations,i=this.$relations;for(var o in i)n[o].encode(this,t,e);return t},$key:function(){return this.$db.getKey(this)},$keys:function(){return this.$db.getKeys(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(){var e=this.$saved,t=this.$toJSON(!0),n=this.$db.fields;return e?A(t,e,n,b):t},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(!0),t=this.$saved;for(var n in e){var i=e[n],o=t[n];if(!b(i,o))return!0}return!1}},I(C.prototype,!0),K.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,this.values.push(t),this.keys.push(e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return a(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],n=this.values.pop(),i=this.keys.pop();return e<this.values.length&&(this.values[e]=n,this.keys[e]=i,this.indices[i]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},filter:function(e,t){for(var n=t||new K,i=this.size(),o=this.values,r=this.keys,s=0;i>s;s++){var a=o[s],u=r[s];e(a,u)&&n.put(u,a)}return n},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),n=0;t>n;n++)$(this.values,n,e-n),$(this.keys,n,e-n);return this.rebuildIndex(),this},isSorted:function(e){if(!e)return!0;for(var t=this.values,n=0,i=t.length-1;i>n;n++)if(e(t[n],t[n+1])>0)return!1;return!0},sort:function(e){function t(t,n){for(var o=i.values[Math.floor((n+t)/2)],r=t,s=n;s>=r;){for(;e(i.values[r],o)<0;)r++;for(;e(i.values[s],o)>0;)s--;s>=r&&($(i.values,r,s),$(i.keys,r,s),r++,s--)}return r}function n(e,i){var o=t(e,i);o-1>e&&n(e,o-1),i>o&&n(o,i)}var i=this,o=this.size()-1;return o>0&&(n(0,o),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},w.prototype={reset:function(e){this.model=e,this.db=e.$db,this.next=null,this.finished=!1},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},execute:function(){this.run(this.db,this.model)},run:function(e,t){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute()),this},tryNext:function(e){this.next||(this.next=new e(this.model))},insertNext:function(e){var t=new e(this.model);t.next=this.next,this.next=t},success:function(){var e=this;return function(){e.onSuccess.apply(e,arguments),e.finish()}},onSuccess:function(){},failure:function(){var e=this;return function(){e.onFailure.apply(e,arguments),e.finish()}},onFailure:function(){}},P.prototype=new w(!0,"NeuroRemoveLocal"),P.prototype.run=function(e,t){var n=t.$key();return t.$local?void(t.$saved?(t.$local.$deleted=!0,e.store.put(n,t.$local,this.success(),this.failure())):(F.debug(F.Events.REMOVE_LOCAL_UNSAVED,t),e.store.remove(n,this.success(),this.failure()))):(F.debug(F.Events.REMOVE_LOCAL_NONE,t),this.finish())},P.prototype.onSuccess=function(e,t,n){var i=this.model;F.debug(F.Events.REMOVE_LOCAL,i),i.$saved&&i.$addOperation(B)},P.prototype.onFailure=function(e){var t=this.model;F.debug(F.Events.REMOVE_LOCAL_ERROR,t,e),t.$saved&&t.$addOperation(B)},U.prototype=new w(!0,"NeuroRemoveNow"),U.prototype.run=function(e,t){var n=t.$key();e.models.has(n)&&(e.models.remove(n),e.trigger("model-removed",[t]),e.updated(),t.$trigger("removed")),e.store.remove(n,this.success(),this.failure())},B.prototype=new w(!0,"NeuroRemoveRemote"),B.prototype.run=function(e,n){n.$pendingSave=!1,n.$deleted=!0,this.key=n.$key(),e.rest("DELETE",n,t,this.success(),this.failure())},B.prototype.onSuccess=function(e){this.finishRemove()},B.prototype.onFailure=function(e,t){var n=this,i=this.key,o=this.model;404===t||410===t?(F.debug(F.Events.REMOVE_MISSING,this,i,o),this.finishRemove()):0!==t?F.debug(F.Events.REMOVE_ERROR,this,t,i,o):(F.checkNetworkStatus(),F.online||F.once("online",function(){F.debug(F.Events.REMOVE_RESUME,n,o),o.$addOperation(B)}),F.debug(F.Events.REMOVE_OFFLINE,this,o))},B.prototype.finishRemove=function(){var e=this.db,t=this.key,n=this.model;F.debug(F.Events.REMOVE_REMOTE,this,t,n),this.insertNext(U),F.debug(F.Events.REMOVE_PUBLISH,this,t,n),e.live({op:"REMOVE",key:t})},x.prototype=new w(!1,"NeuroSaveLocal"),x.prototype.run=function(e,t){if(t.$deleted)return F.debug(F.Events.SAVE_LOCAL_DELETED,this,t),this.finish();var n=t.$toJSON(!1);t.$local?p(n,t.$local):t.$local=n,e.store.put(t.$key(),t.$local,this.success(),this.failure())},x.prototype.onSuccess=function(e,t,n){var i=this.model;F.debug(F.Events.SAVE_LOCAL,this,i),this.tryNext(G)},x.prototype.onFailure=function(e){var t=this.model;F.debug(F.Events.SAVE_LOCAL_ERROR,this,t,e),this.tryNext(G)},H.prototype=new w(!1,"NeuroSaveNow"),H.prototype.run=function(e,t){e.store.put(t.$key(),t.$local,this.success(),this.failure())},G.prototype=new w(!1,"NeuroSaveRemote"),G.prototype.run=function(e,t){if(t.$deleted)return F.debug(F.Events.SAVE_REMOTE_DELETED,this,t),this.finish();var n=(this.key=t.$key(),this.saving=t.$getChanges(!0));return N(n)?this.finish():void e.rest(t.$saved?"PUT":"POST",t,n,this.success(),this.failure())},G.prototype.onSuccess=function(e){var t=this.model;F.debug(F.Events.SAVE_REMOTE,this,t),this.handleData(e)},G.prototype.onFailure=function(e,t){var n=this,i=(this.db,this.model);409===t?(F.debug(F.Events.SAVE_CONFLICT,this,e,i),this.handleData(e,i,this.db)):410===t||404===t?(F.debug(F.Events.SAVE_UPDATE_FAIL,this,i),this.insertNext(U)):0!==t?F.debug(F.Events.SAVE_ERROR,this,i,t):(F.checkNetworkStatus(),F.online||(i.$pendingSave=!0,F.once("online",function(){i.$pendingSave&&(i.$pendingSave=!1,i.$addOperation(G),F.debug(F.Events.SAVE_RESUME,n,i))})),F.debug(F.Events.SAVE_OFFLINE,this,i))},G.prototype.handleData=function(e){var t=this.db,n=this.model,i=this.saving;if(n.$deleted)return void F.debug(F.Events.SAVE_REMOTE_DELETED,this,n,e);for(var o in e)o in i||(i[o]=e[o]);F.debug(F.Events.SAVE_VALUES,this,i,n),n.$saved||(t.cache===!1?n.$saved={}:n.$saved=n.$local.$saved={}),t.putRemoteData(i,this.key,n),F.debug(F.Events.SAVE_PUBLISH,this,i,n),t.live({op:"SAVE",model:i,key:this.key})},F.STORE_NONE=0,F.STORE_MODEL=1,F.STORE_KEY=2,F.STORE_KEYS=3,F.SAVE_NONE=0,F.SAVE_MODEL=4,z.prototype={init:function(e,t,n){this.database=e,this.name=t,this.options=n,this.store=n.store||F.STORE_NONE,this.save=n.save||F.SAVE_NONE,this.auto=!!n.auto,this.property=!!n.property;var i=this.setNeuro(e,t,n);r(n.model)?i(n.model):F.get(n.model,i,this)},setNeuro:function(e,t,n){return function(i){this.model=i,this.property||(this.property=v(e.fields,this.name)!==!1),this.onInitialized(e,t,n)}},onInitialized:function(e,t,n){},load:function(e){},relate:function(e,t){},unrelate:function(e,t){},get:function(e){},set:function(e,t){this.unrelate(e),this.relate(e,t)},encode:function(e,t,n){},preSave:function(e){},postSave:function(e){},preRemove:function(e){},postRemove:function(e){},clearFields:function(e,t){var n=!1;if(s(t))e[t]&&(e[t]=null,n=!0);else for(var i=0;i<t.length;i++){var o=t[i];e[o]&&(e[o]=null,n=!0)}return n&&this.auto&&!e.$isNew()&&e.$save(),n},updateFields:function(e,t,n,i){var o=!1;if(n.$key(),s(t)){var r=e[t],a=n[i];b(r,a)||(e[t]=a,o=!0)}else for(var u=0;u<t.length;u++){var d=t[u],r=e[d],l=i[u],h=n[l];b(r,h)||(e[d]=L(h),o=!0)}return o&&this.auto&&!e.$isNew()&&e.$save(),o},getStoredArray:function(e,t){if(!t)return null;for(var n=[],i=0;i<e.length;i++){var o=this.getStored(e[i],t);null!==o&&n.push(o)}return n},getStored:function(e,t){if(e)switch(t){case F.SAVE_MODEL:return e.$toJSON(!0);case F.STORE_MODEL:if(e.$local)return e.$local;var n=e.$toJSON(!1);return e.$saved&&(n.$saved=e.$saved),n;case F.STORE_KEY:return e.$key();case F.STORE_KEYS:return e.$keys()}return null}},m(new z,J,{onInitialized:function(e,t,n){var i=this.model.Database;this.local=n.local||i.name+"_"+i.key,F.debug(F.Events.BELONGSTO_INIT,this)},load:function(e){var t=this,n=this.model.Database,i=e[this.name],o=e.$relations[this.name]={initial:i,model:null,loaded:!1,onRemoved:function(){F.debug(F.Events.BELONGSTO_NINJA_REMOVE,t,e,o),this.cascade!==!1&&e.$remove()},onSaved:function(){F.debug(F.Events.BELONGSTO_NINJA_SAVE,t,e,o),this.hasForeignKey(e,o.model)||this.cascade===!1||e.$remove()}};N(i)&&n.hasFields(e,this.local,f)&&(i=_(e,this.local),F.debug(F.Events.BELONGSTO_INITIAL_PULLED,this,e,i)),N(i)||(F.debug(F.Events.BELONGSTO_INITIAL,this,e,i),n.grabModel(i,this.handleLoad(e,o),this))},set:function(e,t){if(f(t)){var n=this.model.Database,i=n.parseModel(t),o=e.$relations[this.name];i&&!this.hasForeignKey(e,i)&&(this.clearModel(o),this.setRelated(e,o,i))}else this.unrelate(e)},relate:function(e,t){var n=this.model.Database,i=n.parseModel(t),o=e.$relations[this.name];i&&o.model!==i&&(this.clearModel(o),this.setRelated(e,o,i))},unrelate:function(e,t){var n=this.model.Database,i=e.$relations[this.name],o=n.parseModel(t);o&&i.model!==o||(this.clearModel(i),this.clearForeignKey(e))},setRelated:function(e,t,n){this.setModel(t,n),this.updateForeignKey(e,n),this.setProperty(e,t)},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,n){var i=e.$relations[this.name],o=n?this.save:this.store;i&&o&&(t[this.name]=this.getStored(i.model,o))},postRemove:function(e){var t=e.$relations[this.name];t&&(F.debug(F.Events.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e){e.model&&(F.debug(F.Events.BELONGSTO_CLEAR_MODEL,this,e),e.model.$off("saved",e.onSaved),e.model.$off("removed",e.onRemoved),e.model=null,e.loaded=!0)},setModel:function(e,t){t.$on("saved",e.onSaved,this),t.$on("removed",e.onRemoved,this),e.model=t,e.loaded=!0,F.debug(F.Events.BELONGSTO_SET_MODEL,this,e)},handleLoad:function(e,t){return function(n){F.debug(F.Events.BELONGSTO_LOADED,this,e,t,n),t.loaded===!1&&(n?(this.setModel(t,n),this.updateForeignKey(e,n)):this.clearForeignKey(e),t.loaded=!0,this.setProperty(e,t))}},hasForeignKey:function(e,t){var n=this.model.Database,i=this.local,o=n.key;return O(e,i,t,o)},clearForeignKey:function(e){var t=this.local;F.debug(F.Events.BELONGSTO_CLEAR_KEY,this,e,t),this.clearFields(e,t)},updateForeignKey:function(e,t){var n=this.model.Database,i=this.local,o=n.key;F.debug(F.Events.BELONGSTO_UPDATE_KEY,this,e,i,t,o),this.updateFields(e,i,t,o)},setProperty:function(e,t){this.property&&e[this.name]!==t.model&&(e[this.name]=t.model,e.$trigger("relation-update",[this,t]))}}),F.RELATIONS.belongsTo=J,m(new z,Y,{onInitialized:function(e,t,n){this.foreign=n.foreign||e.name+"_"+e.key,this.comparator=V(n.comparator),this.cascadeRemove=!!n.cascadeRemove,this.cascadeSave=!!n.cascadeSave,F.debug(F.Events.HASMANY_INIT,this)},load:function(e){var t=this,n=this.model.Database,i=this.isRelated(e),o=e[this.name],r=e.$relations[this.name]={parent:e,isRelated:i,initial:o,pending:{},models:new K,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){t.removeModel(r,this,!0)},onSaved:function(){r.saving||(i(this)?(t.sort(r),t.checkSave(r)):t.removeModel(r,this))}};if(e.$key(),n.on("model-added",this.handleModelAdded(r),this),l(o))for(var s=0;s<o.length;s++){var a=o[s],u=n.buildKeyFromInput(a);r.pending[u]=!0,n.grabModel(a,this.handleModel(r),this)}else{var d=n.models;n.ready(this.handleLazyLoad(r,d),this)}this.setProperty(r)},bulk:function(e,t){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e)},relate:function(e,t){var n=this.model.Database,i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var o=n.parseModel(t[e]);o&&this.addModel(i,o)}});else if(f(t)){var o=n.parseModel(t);o&&this.addModel(i,o)}},unrelate:function(e,t){var n=this.model.Database,i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var o=n.parseModel(t[e]);o&&this.removeModel(i,o)}});else if(f(t)){var o=n.parseModel(t);o&&this.removeModel(i,o)}else for(var r=i.models.values,s=r.length-1;s>=0;s--)this.removeModel(i,r[s])},get:function(e){var t=e.$relations[this.name];return t.models.values},encode:function(e,t,n){var i=e.$relations[this.name],o=n?this.save:this.store;i&&o&&(t[this.name]=this.getStoredArray(i.models.values,o))},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){t.saving=!0,t.delaySaving=!0;for(var n=t.models.values,i=0;i<n.length;i++){var o=n[i];o.$hasChanges()&&o.$save()}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&this.bulk(t,function(){for(var e=t.models.values,n=0;n<e.length;n++){var i=e[n];i.$remove()}})},checkSave:function(e){e.delaySaving||(this.store===F.STORE_MODEL||this.save===F.SAVE_MODEL)&&e.parent.$save()},handleModelAdded:function(e){return function(t){e.isRelated(t)&&this.addModel(e,t)}},handleModel:function(e){return function(t){var n=e.pending,i=t.$key();i in n&&(this.addModel(e,t,!0),delete n[i])}},handleLazyLoad:function(e,t){return function(n){var i=t.filter(e.isRelated),o=i.values;this.bulk(e,function(){for(var t=0;t<o.length;t++)this.addModel(e,o[t])})}},addModel:function(e,t,n){var i=e.models,o=t.$key(),r=!i.has(o);return r&&(i.put(o,t),t.$on("removed",e.onRemoved),t.$on("saved remote-update",e.onSaved),this.updateForeignKey(e.parent,t),this.sort(e),n||this.checkSave(e)),r},removeModel:function(e,t,n){var i=e.models,o=e.pending,r=t.$key();i.has(r)&&(i.remove(r),t.$off("removed",e.onRemoved),t.$off("saved remote-update",e.onSaved),this.clearForeignKey(t),!n&&this.cascadeRemove&&t.$remove(),this.sort(e),this.checkSave(e)),delete o[r]},updateForeignKey:function(e,t){var n=this.foreign,i=e.$db.key;this.updateFields(t,n,e,i)},clearForeignKey:function(e){var t=this.foreign;this.clearFields(e,t)},isModelArray:function(e){if(!l(e))return!1;var t=this.model.Database,n=t.key;if(!l(n))return!1;if(n.length!==e.length)return!1;for(var i=0;i<e.length;i++)if(!a(e[i])&&!s(e[i]))return!1;return!0},isRelated:function(e){var t=this.foreign,n=e.$db.key;return function(i){return O(i,t,e,n)}},setProperty:function(e){this.property&&(e.parent[this.name]=e.models.values)},sort:function(e){var t=e.models;e.delaySorting||(t.isSorted(this.comparator)||t.sort(this.comparator),e.parent.$trigger("relation-update",[this,e]))}}),F.RELATIONS.hasMany=Y,m(new z,q,{onInitialized:function(e,t,n){var i=this.model.Database;this.local=n.local||i.name+"_"+i.key,F.debug(F.Events.HASONE_INIT,this)},load:function(e){var t=this,n=this.model.Database,i=e[this.name],o=e.$relations[this.name]={initial:i,model:null,loaded:!1,dirty:!1,saving:!1,onRemoved:function(){F.debug(F.Events.HASONE_NINJA_REMOVE,t,e,o),this.clearModel(o,!0),this.clearForeignKey(e)},onSaved:function(){o.saving||(F.debug(F.Events.HASONE_NINJA_SAVE,t,e,o),this.hasForeignKey(e,o.model)||(this.clearModel(o),this.clearForeignKey(e)))}};N(i)&&n.hasFields(e,this.local,f)&&(i=_(e,this.local),F.debug(F.Events.HASONE_INITIAL_PULLED,this,e,i)),N(i)||(F.debug(F.Events.HASONE_INITIAL,this,e,i),n.grabModel(i,this.handleLoad(e,o),this))},set:function(e,t){if(f(t)){var n=this.model.Database,i=n.parseModel(t),o=e.$relations[this.name];i&&!this.hasForeignKey(e,i)&&(this.clearModel(o),this.setRelated(e,o,i))}else this.unrelate(e)},relate:function(e,t){var n=this.model.Database,i=n.parseModel(t),o=e.$relations[this.name];i&&o.model!==i&&(this.clearModel(o),this.setRelated(e,o,i))},unrelate:function(e,t){var n=this.model.Database,i=e.$relations[this.name],o=n.parseModel(t);o&&i.model!==o||(this.clearModel(i),this.clearForeignKey(e))},setRelated:function(e,t,n){this.setModel(t,n),this.updateForeignKey(e,n),this.setProperty(e,t)},get:function(e){var t=e.$relations[this.name];return t.model},encode:function(e,t,n){var i=e.$relations[this.name],o=n?this.save:this.store;i&&o&&(t[this.name]=this.getStored(i.model,o))},preSave:function(e){var t=e.$relations[this.name];if(t&&t.model){var n=t.model;!this.hasForeignKey(e,n),(t.dirty||n.$hasChanges())&&(F.debug(F.Events.HASONE_PRESAVE,this,e,t),t.saving=!0,n.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade!==!1&&(F.debug(F.Events.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e,t){e.model&&(F.debug(F.Events.HASONE_CLEAR_MODEL,this,e),e.model.$off("saved",e.onSaved),e.model.$off("removed",e.onRemoved),t||e.model.$remove(),e.model=null,e.dirty=!0,e.loaded=!0)},setModel:function(e,t){
t.$on("saved",e.onSaved,this),t.$on("removed",e.onRemoved,this),e.model=t,e.dirty=!0,e.loaded=!0,F.debug(F.Events.HASONE_SET_MODEL,this,e)},handleLoad:function(e,t){return function(n){F.debug(F.Events.HASONE_LOADED,this,e,t,n),t.loaded===!1&&(n?(this.setModel(t,n),this.updateForeignKey(e,n)):this.clearForeignKey(e),t.loaded=!0,this.setProperty(e,t))}},hasForeignKey:function(e,t){var n=this.model.Database,i=this.local,o=n.key;return O(e,i,t,o)},clearForeignKey:function(e){var t=this.local;F.debug(F.Events.HASONE_CLEAR_KEY,this,e,t),this.clearFields(e,t)},updateForeignKey:function(e,t){var n=this.model.Database,i=this.local,o=n.key;F.debug(F.Events.HASONE_UPDATE_KEY,this,e,i,t,o),this.updateFields(e,i,t,o)},setProperty:function(e,t){this.property&&e[this.name]!==t.model&&(e[this.name]=t.model,e.$trigger("relation-update",[this,t]))}}),F.RELATIONS.hasOne=q,e.Neuro=F,e.Neuro.Model=C,e.Neuro.Database=k,e.Neuro.Relation=z,e.Neuro.Operation=w,e.Neuro.uuid=g,e.Neuro.indexOf=v,e.Neuro.extend=m,e.Neuro.transfer=p,e.Neuro.swap=$,e.Neuro.grab=y,e.Neuro.pull=_,e.Neuro.copy=L,e.Neuro.diff=A,e.Neuro.isEmpty=N,e.Neuro.compare=D,e.Neuro.equals=b,e.Neuro.equalsStrict=M,e.Neuro.createComparator=V}(window);
//# sourceMappingURL=neurosync.min.js.map
