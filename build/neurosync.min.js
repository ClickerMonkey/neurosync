!function(e,t){function n(e){return"undefined"!=typeof e}function i(e){return!!(e&&e.constructor&&e.call&&e.apply)}function s(e){return"string"==typeof e}function r(e){return"number"==typeof e&&!isNaN(e)}function o(e){return e instanceof Date}function u(e){return e instanceof RegExp}function a(e){return e instanceof Array}function E(e){return null!==e&&"object"==typeof e}function d(e,t){return e instanceof Array?e:e.split(t)}function h(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function f(){return h()+h()+"-"+h()+"-"+h()+"-"+h()+"-"+h()+h()+h()}function l(e,t){for(var n in e)t[n]=e[n];return t}function c(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function v(e,t,n){for(var i={},s=0;s<t.length;s++){var r=t[s];r in e&&(i[r]=n?O(e[r]):e[r])}return i}function O(e,t){if(void 0===e)return e;if(a(e)){for(var n=[],s=0;s<e.length;s++)n.push(O(e[s]));return e}if(i(e)||"object"!=typeof e||null===e)return e;if(o(e))return new Date(e.getTime());if(u(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var n={};for(var r in e)(t||"$"!==r.charAt(0))&&(n[r]=O(e[r]));return n}function p(e,t,n,i){for(var s={},r=0;r<n.length;r++){var o=n[r];o in e&&o in t&&!i(e[o],t[o])&&(s[o]=O(e[o]))}return s}function g(e){if(null===e||void 0===e||0===e)return!0;if(a(e))return 0===e.length;if(o(e))return 0===e.getTime()||isNaN(e.getTime());if(E(e)){for(var t in e)return!1;return!0}return!1}function $(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,s=typeof t;if(n!==s)return!1;var r=a(e),E=a(t);if(r!==E)return!1;if(r){if(e.length!==t.length)return!1;for(var d=0;d<e.length;d++)if(!$(e[d],t[d]))return!1;return!0}if(o(e))return o(t)&&$(e.getTime(),t.getTime());if(u(e))return u(t)&&e.toString()===t.toString();if("object"===n){for(var h in e)if(!("$"===h.charAt(0)&&i(e[h])||h in t&&$(e[h],t[h])))return!1;for(var h in t)if(!("$"===h.charAt(0)&&i(t[h])||h in e))return!1;return!0}return!1}function R(e,t){return e===t?0:t>e?-1:1}function L(e,t){return e==t?0:(o(e)&&(e=e.getTime()),o(t)&&(t=t.getTime()),r(e)&&r(t)?R(e,t):a(e)&&a(t)?R(e.length,t.length):(e+"").localeCompare(t+""))}function _(e){var t=function(e,t,i,s,r){var i=d(i," ");n(e[t])||(e[t]={});for(var o=0;o<i.length;o++)n(e[t][i[o]])||(e[t][i[o]]=[]),e[t][i[o]].push([s,r||e])};e.on=function(e,n,i){return t(this,"$on",e,n,i),this},e.once=function(e,n,i){return t(this,"$once",e,n,i),this};var s=function(e,t,n){if(e&&t in e)for(var i=e[t],s=i.length-1;s>=0;s--)i[s][0]===n&&i.splice(s,1)},r=function(e,t){e&&t in e&&delete e[t]};e.off=function(e,t){if(n(e)){var e=d(e," ");if(i(t))for(var o=0;o<e.length;o++)s(this.$on,e[o],t),s(this.$once,e[o],t);else for(var o=0;o<e.length;o++)r(this.$on,e[o]),r(this.$once,e[o])}else r(this,"$on"),r(this,"$once");return this};var o=function(e,t,n,i){if(e&&t in e){for(var s=e[t],r=s.length,o=0;r>o;o++){var u=s[o];u[0].call(u[1],n)}i&&(s.length!==r?e[t]=s.slice(r):delete e[t])}};e.trigger=function(e,t){for(var e=d(e," "),n=0;n<e.length;n++){var i=e[n];o(this.$on,i,t,!1),o(this.$once,i,t,!0)}return this}}function A(e){var t=new S(e),n=new Function("return function "+e.className+"(props) { this.$init( props ) }")();return n.prototype=new y(t),t.model=n,t.init(),A.debug(A.Events.CREATION,e,t),{Database:t,Model:n}}function S(e){l(e,this),this.models=new m,this.rest=A.rest(this),this.store=A.store(this),this.live=A.live(this,this.handlePublish(this))}function y(e){this.$db=e}function m(){this.values=[],this.keys=[],this.indices={}}function M(e){this.interrupts=e}function V(e){this.reset(e)}function b(e){this.reset(e)}function T(e){this.reset(e)}function D(e){this.reset(e)}function N(e){this.reset(e)}function k(e){this.reset(e)}_(A),A.debug=function(e,t){},A.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},A.rest=function(e){return function(e,t,n){n({},0)}},A.store=function(e){return{put:function(e,t,n,i){},remove:function(e,t,n){},all:function(e,t){}}},A.live=function(e,t){return function(e){}},A.online=window.navigator.onLine!==!1,A.forceOffline=!1,A.setOnline=function(){A.online=!0,A.debug(A.Events.ONLINE),A.trigger("online")},A.setOffline=function(){A.online=!1,A.debug(A.Events.OFFLINE),A.trigger("offline")},A.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",A.setOnline,!1),window.addEventListener("offline",A.setOffline,!1)):(document.body.ononline=A.setOnline,document.body.onoffline=A.setOffline)},A.checkNetworkStatus=function(){var e=window.navigator.onLine;A.forceOffline&&(e=!1),e===!0&&A.online===!1?A.setOnline():e===!1&&A.online===!0&&A.setOffline()},S.prototype={pendingLoad:!1,removeKey:function(e){var t=this.key;if(a(t))for(var n=0;n<t.length;n++)delete e[t[n]];else delete e[t]},getKey:function(e){var t=this.key,n=null;if(a(t)){var i=this.keySeparator||"/";n="";for(var s=0;s<t.length;s++)s>0&&(n+=i),n+=e[t[s]]}else n=e[t],n||(e[t]=n=f());return n},updated:function(){var e=this.comparator;if(i(e))this.models.sort(e);else if(s(e)){var t=1;"-"===e.charAt(0)&&(e=e.substring(1),t=-1),this.models.sort(function(n,i){return t*L(n[e],i[e])})}this.trigger("updated")},putRemoteData:function(e,t,n){var i=this,t=t||i.getKey(e),n=n||i.models.get(t),s=i.decode(O(e));if(n&&n.$saved){var r=n.$toJSON();for(var o in e){var u=r[o],a=n.$saved[o];$(u,a)&&(n[o]=s[o],n.$local[o]=e[o]),n.$saved[o]=O(e[o])}n.$addOperation(N)}else n=i.instantiate(s),n.$local=e,n.$saved=n.$local.$saved=O(e),n.$addOperation(N);return i.models.has(t)||(i.models.put(t,n),n.trigger("saved")),n},destroyLocalModel:function(e){var t=this,n=t.models.get(e);return n?n.$hasChanges()?(delete n.$saved,delete n.$local.$saved,t.removeKey(n),t.removeKey(n.$local),n.$addOperation(N),!1):(n.$addOperation(b),t.models.remove(e),n.trigger("removed"),A.debug(A.Events.REMOTE_REMOVE,n),!0):(t.store.remove(e,function(e){e&&A.debug(A.Events.REMOTE_REMOVE,e)}),!1)},init:function(){var e=this;e.store.all(function(t,n){A.debug(A.Events.LOCAL_LOAD,t),e.models.reset();for(var i=0;i<t.length;i++){var s=t[i],r=n[i],o=e.decode(O(s,!0)),u=e.instantiate(o);u.$local=s,s.$deleted?(A.debug(A.Events.LOCAL_RESUME_DELETE,u),u.$addOperation(T)):(s.$saved?(A.debug(A.Events.LOCAL_LOAD_SAVED,u),u.$local.$saved=u.$saved):(A.debug(A.Events.LOCAL_RESUME_SAVE,u),u.$addOperation(k)),e.models.put(r,u))}e.updated(),e.loadRemote()})},loadRemote:function(){function e(e){for(var t={},i=0;i<e.length;i++){var s=n.putRemoteData(e[i]),r=s.$key();t[r]=s}for(var o=n.models.keys,i=0;i<o.length;i++){var u=o[i];if(!(u in t)){var a=n.models.get(u);a.$saved&&(A.debug(A.Events.REMOTE_LOAD_REMOVE,u),n.destroyLocalModel(u))}}n.updated(),A.debug(A.Events.REMOTE_LOAD,e)}function t(e,t){0===t?(A.checkNetworkStatus(),A.online||(n.pendingLoad=!0,A.once("online",function(){A.debug(A.Events.REMOTE_LOAD_RESUME),n.pendingLoad&&(n.pendingLoad=!1,n.loadRemote())})),A.debug(A.Events.REMOTE_LOAD_OFFLINE)):A.debug(A.Events.REMOTE_LOAD_ERROR,t)}var n=this,i={method:"GET",url:n.api};n.rest(i,e,t)},getModels:function(){return this.models.values},handlePublish:function(e){return function(t){var n=t.key,i=t.model;switch(t.op){case"SAVE":e.putRemoteData(i,n),e.updated(),A.debug(A.Events.REALTIME_SAVE,t.model);break;case"REMOVE":e.destroyLocalModel(n)&&e.updated(),A.debug(A.Events.REALTIME_REMOVE,n)}}},instantiate:function(e){return new this.model(e)},encode:function(e){return e},decode:function(e){return e},save:function(e){var t=this,n=e.$key();return e.$deleted?void A.debug(A.Events.SAVE_DELETED,e):(t.models.has(n)||(t.models.put(n,e),t.updated(),e.trigger("saved")),void e.$addOperation(D))},remove:function(e){var t=this,n=e.$key();t.models.has(n)&&(t.models.remove(n),t.updated(),e.trigger("removed")),e.$deleted=!0,e.$pendingSave&&(A.debug(A.Events.REMOVE_CANCEL_SAVE,e),e.$pendingSave=!1),e.$addOperation(V)}},_(S.prototype),y.prototype={$set:function(e,t){E(e)?l(e,this):s(e)&&void 0!==t&&(this[e]=t)},$get:function(e,t){if(a(e))return v(this,e,t);if(E(e)){for(var n in e)e[n]=t?O(this[n]):this[n];return e}return s(e)?t?O(this[e]):this[e]:void 0},$save:function(e,t){return this.$set(e,t),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$addOperation:function(e){var t=new e(this);this.$operation?this.$operation.queue(t):(this.$operation=t,this.$operation.execute())},$init:function(e){this.$pendingSave=!1,this.$pendingRemove=!1,this.$queued=[],this.$operation=null,this.$reset(e)},$reset:function(e){var n=this.$db.defaults,s=this.$db.fields;if(E(n))for(var r=0;r<s.length;r++){var o=s[r];if(o in n){var u=n[o];i(u)?this[o]=u():this[o]=O(u)}else this[o]=t}else for(var r=0;r<s.length;r++){var o=s[r];this[o]=t}this.$set(e)},$toJSON:function(){return this.$db.encode(v(this,this.$db.fields,!0))},$key:function(){return this.$db.getKey(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(),t=this.$saved;for(var n in e){var i=e[n],s=t[n];if(!$(i,s))return!0}return!1}},_(y.prototype),m.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,this.values.push(t),this.keys.push(e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return r(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],n=this.values.pop(),i=this.keys.pop();return e<this.values.length&&(this.values[e]=n,this.keys[e]=i,this.indices[i]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),n=0;t>n;n++)c(this.values,n,e-n),c(this.keys,n,e-n);return this.rebuildIndex(),this},sort:function(e){function t(t,n){for(var s=i.values[Math.floor((n+t)/2)],r=t,o=n;o>=r;){for(;e(i.values[r],s)<0;)r++;for(;e(i.values[o],s)>0;)o--;o>=r&&(c(i.values,r,o),c(i.keys,r,o),r++,o--)}return r}function n(e,i){var s=t(e,i);s-1>e&&n(e,s-1),i>s&&n(s,i)}var i=this,s=this.size()-1;return s>0&&(n(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},M.prototype={reset:function(e){this.model=e,this.db=e.$db,this.next=null,this.finished=!1},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},execute:function(){this.run(this.db,this.model)},run:function(e,t){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute()),this},tryNext:function(e){this.next||(this.next=new e(this.model))},insertNext:function(e){var t=new e(this.model);t.next=this.next,this.next=t},success:function(){var e=this;return function(){e.onSuccess.apply(e,arguments),e.finish()}},onSuccess:function(){},failure:function(){var e=this;return function(){e.onFailure.apply(e,arguments),e.finish()}},onFailure:function(){}},V.prototype=new M(!0),V.prototype.run=function(e,t){var n=t.$key();return t.$local?void(t.$saved?(t.$local.$deleted=!0,e.store.put(n,t.$local,this.success(),this.failure())):(A.debug(A.Events.REMOVE_LOCAL_UNSAVED,t),e.store.remove(n,this.success(),this.failure()))):(A.debug(A.Events.REMOVE_LOCAL_NONE,t),this.finish())},V.prototype.onSuccess=function(e,t,n){var i=this.model;A.debug(A.Events.REMOVE_LOCAL,i),i.$saved&&i.$addOperation(T)},V.prototype.onFailure=function(e){var t=this.model;A.debug(A.Events.REMOVE_LOCAL_ERROR,t,e),t.$saved&&t.$addOperation(T)},b.prototype=new M(!0),b.prototype.run=function(e,t){var n=t.$key();e.models.has(n)&&(e.models.remove(n),t.trigger("removed")),e.store.remove(n,this.success(),this.failure())},T.prototype=new M(!0),T.prototype.run=function(e,t){t.$pendingSave=!1,t.$deleted=!0,this.key=t.$key();var n={method:"DELETE",url:e.api+this.key};e.rest(n,this.success(),this.failure())},T.prototype.onSuccess=function(e){this.finishRemove()},T.prototype.onFailure=function(e,t){var n=this.key,i=this.model;404===t||410===t?(A.debug(A.Events.REMOVE_MISSING,n,i),this.finishRemove()):0!==t?A.debug(A.Events.REMOVE_ERROR,t,n,i):(A.checkNetworkStatus(),A.online||A.once("online",function(){A.debug(A.Events.REMOVE_RESUME,i),i.$addOperation(T)}),A.debug(A.Events.REMOVE_OFFLINE,i))},T.prototype.finishRemove=function(){var e=this.db,t=this.key,n=this.model;A.debug(A.Events.REMOVE_REMOTE,t,n),this.insertNext(b),A.debug(A.Events.REMOVE_PUBLISH,t,n),e.live({op:"REMOVE",key:t})},D.prototype=new M(!1),D.prototype.run=function(e,t){if(t.$deleted)return A.debug(A.Events.SAVE_LOCAL_DELETED,t),this.finish();var n=t.$toJSON();t.$local?l(n,t.$local):t.$local=n,e.store.put(t.$key(),t.$local,this.success(),this.failure())},D.prototype.onSuccess=function(e,t,n){var i=this.model;A.debug(A.Events.SAVE_LOCAL,i),this.tryNext(k)},D.prototype.onFailure=function(e){var t=this.model;A.debug(A.Events.SAVE_LOCAL_ERROR,t,e),this.tryNext(k)},N.prototype=new M(!1),N.prototype.run=function(e,t){e.store.put(t.$key(),t.$local,this.success(),this.failure())},k.prototype=new M(!1),k.prototype.run=function(e,t){if(t.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,t),this.finish();if(this.key=t.$key(),this.encoded=t.$toJSON(),this.saving=t.$saved?p(this.encoded,t.$saved,e.fields,$):this.encoded,g(this.saving))return this.finish();var n={method:t.$saved?"PUT":"POST",url:t.$saved?e.api+this.key:e.api,data:this.saving};e.rest(n,this.success(),this.failure())},k.prototype.onSuccess=function(e){var t=this.model;A.debug(A.Events.SAVE_REMOTE,t),this.handleData(e)},k.prototype.onFailure=function(e,t){var n=(this.db,this.model);409===t?(A.debug(A.Events.SAVE_CONFLICT,e,n),this.handleData(e,n,this.db)):410===t||404===t?(A.debug(A.Events.SAVE_UPDATE_FAIL,n),this.insertNext(b)):0!==t?A.debug(A.Events.SAVE_ERROR,n,t):(A.checkNetworkStatus(),A.online||(n.$pendingSave=!0,A.once("online",function(){n.$pendingSave&&(n.$pendingSave=!1,n.$addOperation(k),A.debug(A.Events.SAVE_RESUME,n))})),A.debug(A.Events.SAVE_OFFLINE,n))},k.prototype.handleData=function(e){var t=this.db,n=this.model,i=this.saving;if(n.$deleted)return void A.debug(A.Events.SAVE_REMOTE_DELETED,n,e);for(var s in e)s in i||(i[s]=e[s]);A.debug(A.Events.SAVE_VALUES,i,n),n.$saved||(n.$saved=n.$local.$saved={}),t.putRemoteData(i,this.key,n),A.debug(A.Events.SAVE_PUBLISH,i,n),t.live({op:"SAVE",model:i,key:this.key})},e.Neuro=A}(window);
//# sourceMappingURL=neurosync.min.js.map
