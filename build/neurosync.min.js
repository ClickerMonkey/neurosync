!function(e,n){function t(e){return"undefined"!=typeof e}function r(e){return!!(e&&e.constructor&&e.call&&e.apply)}function i(e){return"string"==typeof e}function o(e){return e instanceof Date}function E(e){return e instanceof RegExp}function s(e){return e instanceof Array}function u(e){return null!==e&&"object"==typeof e}function a(e,n){return e instanceof Array?e:e.split(n)}function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function f(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}function c(e,n){for(var t in e)n[t]=e[t];return n}function v(e,n,t){for(var r={},i=0;i<n.length;i++){var o=n[i];o in e&&(r[o]=t?l(e[o]):e[o])}return r}function l(e,n){if(void 0===e)return e;if(s(e)){for(var t=[],i=0;i<e.length;i++)t.push(l(e[i]));return e}if(r(e)||"object"!=typeof e||null===e)return e;if(o(e))return new Date(e.getTime());if(E(e))return new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]);var t={};for(var u in e)(n||"$"!==u.charAt(0))&&(t[u]=l(e[u]));return t}function O(e,n,t,r){for(var i={},o=0;o<t.length;o++){var E=t[o];E in e&&E in n&&!r(e[E],n[E])&&(i[E]=l(e[E]))}return i}function $(e,n){if(e===n)return!0;if(null===e||null===n)return!1;if(e!==e&&n!==n)return!0;var t=typeof e,i=typeof n;if(t!==i)return!1;var u=s(e),a=s(n);if(u!==a)return!1;if(u){if(e.length!==n.length)return!1;for(var d=0;d<e.length;d++)if(!$(e[d],n[d]))return!1;return!0}if(o(e))return o(n)&&$(e.getTime(),n.getTime());if(E(e))return E(n)&&e.toString()===n.toString();if("object"===t){for(var f in e)if(!("$"===f.charAt(0)&&r(e[f])||f in n&&$(e[f],n[f])))return!1;for(var f in n)if(!("$"===f.charAt(0)&&r(n[f])||f in e))return!1;return!0}return!1}function R(e){var n=function(e,n,r,i,o){var r=a(r," ");t(e[n])||(e[n]={});for(var E=0;E<r.length;E++)t(e[n][r[E]])||(e[n][r[E]]=[]),e[n][r[E]].push([i,o||e])};e.on=function(e,t,r){return n(this,"$on",e,t,r),this},e.once=function(e,t,r){return n(this,"$once",e,t,r),this};var i=function(e,n,t){if(e&&n in e)for(var r=e[n],i=r.length-1;i>=0;i--)r[i][0]===t&&r.splice(i,1)},o=function(e,n){e&&n in e&&delete e[n]};e.off=function(e,n){if(t(e)){var e=a(e," ");if(r(n))for(var E=0;E<e.length;E++)i(this.$on,e[E],n),i(this.$once,e[E],n);else for(var E=0;E<e.length;E++)o(this.$on,e[E]),o(this.$once,e[E])}else o(this,"$on"),o(this,"$once");return this};var E=function(e,n,t,r){if(e&&n in e){for(var i=e[n],o=i.length,E=0;o>E;E++){var s=i[E];s[0].call(s[1],t)}r&&(i.length!==o?e[n]=i.slice(o):delete e[n])}};e.trigger=function(e,n){for(var e=a(e," "),t=0;t<e.length;t++){var r=e[t];E(this.$on,r,n,!1),E(this.$once,r,n,!0)}return this}}function h(e){var n=new L(e),t=new Function("return function "+e.className+"(props) { this.$set( props ) }")();return t.prototype=new g(n),t.db=n,n.model=t,n.init(),h.debug(h.Events.CREATION,e,n),{Database:n,Model:t}}function L(e){c(e,this);var n=h.getPubSub(e.pubsub);this.stork=new Stork(e),this.models=new Stork.FastMap,this.channel=n.subscribe(e.channel,e.token),this.channel.onpublish=this.handlePublish(this)}function g(e){this.$db=e,this.$promise=Stork.Promise.Done(this),this.$pendingSave=!1,this.$pendingRemove=!1}R(h),h.debug=function(e,n){},h.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},h.rest=function(e,n){n.$failure([{},0])},h.getPubSub=function(e){if(!(e in h.pubsubs)){var n=new PubSub(e);h.pubsubs[e]=n,h.debug(h.Events.PUBSUB_CREATED,n)}return h.pubsubs[e]},h.pubsubs={},h.online=window.navigator.onLine!==!1,h.forceOffline=!1,h.setOnline=function(){h.online=!0,h.debug(h.Events.ONLINE),h.trigger("online")},h.setOffline=function(){h.online=!1,h.debug(h.Events.OFFLINE),h.trigger("offline")},h.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",h.setOnline,!1),window.addEventListener("offline",h.setOffline,!1)):(document.body.ononline=h.setOnline,document.body.onoffline=h.setOffline)},h.checkNetworkStatus=function(){var e=window.navigator.onLine;h.forceOffline&&(e=!1),e===!0&&h.online===!1?h.setOnline():e===!1&&h.online===!0&&h.setOffline()},L.prototype={$pendingLoad:!1,generateKey:function(){return f()},updated:function(){this.models.sort(this.comparator),this.trigger("updated")},putRemoteData:function(e,n,t){var r=this,n=n||e[r.key],t=t||r.models.get(n),i=r.decode(l(e));if(t&&t.$saved){var o=t.$toJSON();for(var E in e){var s=o[E],u=t.$saved[E];$(s,u)&&(t[E]=i[E],t.$local[E]=e[E]),t.$saved[E]=l(e[E])}t.$queue(function(){return h.debug(h.Events.REMOTE_UPDATE,e,t),r.stork.save(t.$local)})}else t=r.instantiate(i),t.$local=e,t.$saved=t.$local.$saved=l(e),t.$queue(function(){return h.debug(h.Events.REMOTE_CREATE,e,t),r.stork.save(t.$local)}),r.models.put(n,t);return t.trigger("saved"),t},destroyLocalModel:function(e){var n=this,t=n.models.get(e);return t?t.$hasChanges()?(delete t.$saved,delete t.$local.$saved,delete t[n.key],delete t.$local[n.key],t.$queue(function(){return n.stork.save(t.$local)}),!1):(t.$queue(function(){return n.stork.remove(e)},!0),n.models.remove(e),t.trigger("removed"),h.debug(h.Events.REMOTE_REMOVE,t),!0):(n.stork.remove(e,function(e){e&&h.debug(h.Events.REMOTE_REMOVE,e)}),!1)},init:function(){var e=this;e.PROMISED=new Stork.Promise(e).$success(),e.stork.all(function(n,t){h.debug(h.Events.LOCAL_LOAD,n),e.models.reset();for(var r=0;r<n.length;r++){var i=n[r],o=t[r],E=e.decode(l(i,!0)),s=e.instantiate(E);s.$local=i,i.$deleted?(h.debug(h.Events.LOCAL_RESUME_DELETE,s),e.removeRemote(s)):(i.$saved?h.debug(h.Events.LOCAL_LOAD_SAVED,s):(h.debug(h.Events.LOCAL_RESUME_SAVE,s),e.saveRemote(s)),e.models.put(o,s))}e.updated(),e.loadRemote()})},loadRemote:function(){var e=this,n=new Stork.Promise(this),t={method:"GET",url:this.rest};h.rest(t,n),n.then(function(n){for(var t={},r=0;r<n.length;r++){var i=e.putRemoteData(n[r]),o=i.$key();t[o]=i}for(var E=e.models.keys,r=0;r<E.length;r++){var s=E[r];if(!(s in t)){var u=e.models.get(s);u.$saved&&(h.debug(h.Events.REMOTE_LOAD_REMOVE,s),e.destroyLocalModel(s))}}e.updated(),h.debug(h.Events.REMOTE_LOAD,n)},function(n,t){0===t?(h.checkNetworkStatus(),h.online||(e.$pendingLoad=!0,h.once("online",function(){h.debug(h.Events.REMOTE_LOAD_RESUME),e.$pendingLoad&&(e.$pendingLoad=!1,e.loadRemote())})),h.debug(h.Events.REMOTE_LOAD_OFFLINE)):h.debug(h.Events.REMOTE_LOAD_ERROR,t)})},getModels:function(){return this.models.values},handlePublish:function(e){return function(n){var t=n.key,r=n.model;switch(n.op){case"SAVE":e.putRemoteData(r,t),e.updated(),h.debug(h.Events.REALTIME_SAVE,n.model);break;case"REMOVE":e.destroyLocalModel(t)&&e.updated(),h.debug(h.Events.REALTIME_REMOVE,t)}}},instantiate:function(e){return new this.model(e)},encode:function(e){return e},decode:function(e){return e},waitForPending:function(e,n,t){var r=this;return e.$pending()?(e.either(function(){n.apply(r,t)}),!0):(e.$reset(),!1)},interruptPending:function(e){e.$clear()},saveRemote:function(e){var n=this,t=e.$promise,r=new Stork.Promise(e);if(e.$deleted)return h.debug(h.Events.SAVE_REMOTE_DELETED,e),t;if(n.waitForPending(t,this.saveRemote,arguments))return h.debug(h.Events.SAVE_REMOTE_BLOCKED,e),t;var i=e.$toJSON(),o=e.$saved?O(i,e.$saved,n.fields,$):i,E=e.$key(),s={method:e.$saved?"PUT":"POST",url:e.$saved?n.rest+E:n.rest,data:o};h.rest(s,r);var u=function(r){if(e.$deleted)return h.debug(h.Events.SAVE_REMOTE_DELETED,e,r),t.$failure();for(var i in r)i in o||(o[i]=r[i]);h.debug(h.Events.SAVE_VALUES,o,e),e.$saved||(e.$saved=e.$local.$saved={}),n.putRemoteData(o,E,e),t.$success(),h.debug(h.Events.SAVE_PUBLISH,o,e),n.channel.publish({op:"SAVE",model:o,key:E})};return r.then(function(n){h.debug(h.Events.SAVE_REMOTE,e),u(n)},function(r,i){409===i?(h.debug(h.Events.SAVE_CONFLICT,r,e),u(r)):410===i||404===i?(h.debug(h.Events.SAVE_UPDATE_FAIL,e),t.$failure(),e.$queue(function(){return n.models.remove(E),n.stork.remove(E)})):0!==i?(h.debug(h.Events.SAVE_ERROR,e,i),t.$failure()):(h.checkNetworkStatus(),h.online?t.$failure():(e.$pendingSave=!0,h.once("online",function(){e.$pendingSave&&(e.$pendingSave=!1,h.debug(h.Events.SAVE_RESUME,e),n.saveRemote(e,!0))}),t.$success()),h.debug(h.Events.SAVE_OFFLINE,e))}),t},save:function(e){var n=this,t=e.$promise,r=e.$key();return e.$deleted?(h.debug(h.Events.SAVE_DELETED,e),t):(n.models.has(r)||(n.models.put(r,e),n.updated()),n.saveLocal(e))},saveLocal:function(e){var n=this,t=e.$promise,r=e.$toJSON();if(e.$deleted)return h.debug(h.Events.SAVE_LOCAL_DELETED,e),t;if(n.waitForPending(t,this.saveLocal,arguments))return h.debug(h.Events.SAVE_LOCAL_BLOCKED,mdoel),t;e.$local?c(r,e.$local):e.$local=r;var i=n.stork.save(e.$local),o=function(){t.$success(),n.saveRemote(e)};return i.then(function(n){h.debug(h.Events.SAVE_LOCAL,e),o()},function(n){h.debug(h.Events.SAVE_LOCAL_ERROR,e,n),o()}),t},removeRemote:function(e){var n=this,t=e.$promise,r=new Stork.Promise(e),i=e.$key();if(e.$pendingSave=!1,e.$deleted=!0,n.interruptPending(t),n.waitForPending(t,this.removeRemote,arguments))return h.debug(h.Events.REMOVE_REMOTE_BLOCKED,e),t;var o={method:"DELETE",url:this.rest+i};h.rest(o,r);var E=function(){h.debug(h.Events.REMOVE_LOCAL,i,e),t.$bindTo(n.stork.remove(i)),e.trigger("removed"),h.debug(h.Events.REMOVE_PUBLISH,i,e),n.channel.publish({op:"REMOVE",key:i})};return r.then(function(n){h.debug(h.Events.REMOVE_REMOTE,e),E()},function(n,r){404===r||410===r?(h.debug(h.Events.REMOVE_MISSING,i,e),E()):0!==r?(h.debug(h.Events.REMOVE_ERROR,r,i,e),t.$failure()):(h.checkNetworkStatus(),h.online?t.$failure():(h.once("online",function(){h.debug(h.Events.REMOVE_RESUME,e)}),t.$success()),h.debug(h.Events.REMOVE_OFFLINE,e))}),t},removeLocal:function(e){var n=this,t=e.$promise,r=e.$key();if(n.interruptPending(t),n.waitForPending(t,this.removeLocal,arguments))return h.debug(h.Events.REMOVE_LOCAL_BLOCKED,e),t;if(!e.$local)return h.debug(h.Events.REMOVE_LOCAL_NONE,e),t.$success();if(e.$saved){e.$local.$deleted=!0;var i=n.stork.save(e.$local),o=function(){e.$saved?(n.interruptPending(t),t.$success(),n.removeRemote(e)):t.$success()};i.then(function(n){h.debug(h.Events.REMOVE_LOCAL,e),o()},function(n){h.debug(h.Events.REMOVE_LOCAL_ERROR,e,n),o()})}else h.debug(h.Events.REMOVE_LOCAL_UNSAVED,e),t.$bindTo(n.stork.remove(r));return t},remove:function(e){var n=this,t=e.$key();return n.models.has(t)&&(n.models.remove(t),n.updated()),e.$deleted=!0,e.$pendingSave&&(h.debug(h.Events.REMOVE_CANCEL_SAVE,e),e.$pendingSave=!1),n.removeLocal(e)}},R(L.prototype),g.prototype={$set:function(e,n){u(e)?c(e,this):i(e)&&void 0!==n&&(this[e]=n)},$get:function(e,n){if(s(e))return v(this,e,n);if(u(e)){for(var t in e)e[t]=n?l(this[t]):this[t];return e}return i(e)?n?l(this[e]):this[e]:void 0},$save:function(e,n){return this.$set(e,n),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$queue:function(e,n){var t=this.$promise;return n&&t.$clear(),t.either(function(){t.$reset(),t.$bindTo(e())}),t},$reset:function(e){var n=this.$db.defaults;for(var t in n)this[n]=l(n[t]);this.$set(e)},$toJSON:function(){return this.$db.encode(v(this,this.$db.fields,!0))},$key:function(){var e=this.$db.key;return e in this?this[e]:this[e]=this.$db.generateKey()},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$toJSON(),n=this.$saved;for(var t in e){var r=e[t],i=n[t];if(!$(r,i))return!0}return!1}},R(g.prototype),e.Neuro=h}(window);
//# sourceMappingURL=neurosync.min.js.map
