!function(t,e){function n(t){return"undefined"!=typeof t}function i(t){return!!(t&&t.constructor&&t.call&&t.apply)}function r(t){return"string"==typeof t}function s(t){return"number"==typeof t&&!isNaN(t)}function o(t){return t instanceof Date}function u(t){return t instanceof RegExp}function a(t){return t instanceof Array}function h(t){return null!==t&&"object"==typeof t}function E(t,e){return t instanceof Array?t:t.split(e)}function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function f(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}function l(t,e){for(var n in t)e[n]=t[n];return e}function c(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function v(t,e,n){for(var i={},r=0;r<e.length;r++){var s=e[r];s in t&&(i[s]=n?p(t[s]):t[s])}return i}function p(t,e){if(void 0===t)return t;if(a(t)){for(var n=[],r=0;r<t.length;r++)n.push(p(t[r]));return t}if(i(t)||"object"!=typeof t||null===t)return t;if(o(t))return new Date(t.getTime());if(u(t))return new RegExp(t.source,t.toString().match(/[^\/]*$/)[0]);var n={};for(var s in t)(e||"$"!==s.charAt(0))&&(n[s]=p(t[s]));return n}function O(t,e,n,i){for(var r={},s=0;s<n.length;s++){var o=n[s];o in t&&o in e&&!i(t[o],e[o])&&(r[o]=p(t[o]))}return r}function g(t){if(null===t||void 0===t||0===t)return!0;if(a(t))return 0===t.length;if(o(t))return 0===t.getTime()||isNaN(t.getTime());if(h(t)){for(var e in t)return!1;return!0}return!1}function $(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(t!==t&&e!==e)return!0;var n=typeof t,r=typeof e;if(n!==r)return!1;var s=a(t),h=a(e);if(s!==h)return!1;if(s){if(t.length!==e.length)return!1;for(var E=0;E<t.length;E++)if(!$(t[E],e[E]))return!1;return!0}if(o(t))return o(e)&&$(t.getTime(),e.getTime());if(u(t))return u(e)&&t.toString()===e.toString();if("object"===n){for(var d in t)if(!("$"===d.charAt(0)&&i(t[d])||d in e&&$(t[d],e[d])))return!1;for(var d in e)if(!("$"===d.charAt(0)&&i(e[d])||d in t))return!1;return!0}return!1}function R(t,e){return t===e?0:e>t?-1:1}function L(t,e){return t==e?0:(o(t)&&(t=t.getTime()),o(e)&&(e=e.getTime()),s(t)&&s(e)?R(t,e):a(t)&&a(e)?R(t.length,e.length):(t+"").localeCompare(e+""))}function _(t){var e=function(t,e,i,r,s){var i=E(i," ");n(t[e])||(t[e]={});for(var o=0;o<i.length;o++)n(t[e][i[o]])||(t[e][i[o]]=[]),t[e][i[o]].push([r,s||t])};t.on=function(t,n,i){return e(this,"$on",t,n,i),this},t.once=function(t,n,i){return e(this,"$once",t,n,i),this};var r=function(t,e,n){if(t&&e in t)for(var i=t[e],r=i.length-1;r>=0;r--)i[r][0]===n&&i.splice(r,1)},s=function(t,e){t&&e in t&&delete t[e]};t.off=function(t,e){if(n(t)){var t=E(t," ");if(i(e))for(var o=0;o<t.length;o++)r(this.$on,t[o],e),r(this.$once,t[o],e);else for(var o=0;o<t.length;o++)s(this.$on,t[o]),s(this.$once,t[o])}else s(this,"$on"),s(this,"$once");return this};var o=function(t,e,n,i){if(t&&e in t){for(var r=t[e],s=r.length,o=0;s>o;o++){var u=r[o];u[0].call(u[1],n)}i&&(r.length!==s?t[e]=r.slice(s):delete t[e])}};t.trigger=function(t,e){for(var t=E(t," "),n=0;n<t.length;n++){var i=t[n];o(this.$on,i,e,!1),o(this.$once,i,e,!0)}return this}}function A(t){var e=new m(t),n=new Function("return function "+t.className+"(props) { this.$init( props ) }")();return n.prototype=new S(e),e.model=n,e.init(),A.debug(A.Events.CREATION,t,e),{Database:e,Model:n}}function m(t){l(t,this),this.models=new y,this.rest=A.rest(this),this.store=A.store(this),this.live=A.live(this,this.handlePublish(this)),this.relations={},this.setComparator(this.comparator)}function S(t){this.$db=t}function y(){this.values=[],this.keys=[],this.indices={}}function M(t){this.interrupts=t}function V(t){this.reset(t)}function b(t){this.reset(t)}function T(t){this.reset(t)}function D(t){this.reset(t)}function N(t){this.reset(t)}function C(t){this.reset(t)}_(A),A.debug=function(t,e){},A.Events={CREATION:0,REST:1,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37},A.rest=function(t){return function(t,e,n){n({},0)}},A.store=function(t){return{put:function(t,e,n,i){},remove:function(t,e,n){},all:function(t,e){}}},A.live=function(t,e){return function(t){}},A.online=window.navigator.onLine!==!1,A.forceOffline=!1,A.setOnline=function(){A.online=!0,A.debug(A.Events.ONLINE),A.trigger("online")},A.setOffline=function(){A.online=!1,A.debug(A.Events.OFFLINE),A.trigger("offline")},A.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener("online",A.setOnline,!1),window.addEventListener("offline",A.setOffline,!1)):(document.body.ononline=A.setOnline,document.body.onoffline=A.setOffline)},A.checkNetworkStatus=function(){var t=window.navigator.onLine;A.forceOffline&&(t=!1),t===!0&&A.online===!1?A.setOnline():t===!1&&A.online===!0&&A.setOffline()},m.prototype={pendingLoad:!1,removeKey:function(t){var e=this.key;if(a(e))for(var n=0;n<e.length;n++)delete t[e[n]];else delete t[e]},getKey:function(t){var e=this.key,n=null;if(a(e)){var i=this.keySeparator||"/";n="";for(var r=0;r<e.length;r++)r>0&&(n+=i),n+=t[e[r]]}else n=t[e],n||(t[e]=n=f());return n},updated:function(){this.sort(),this.trigger("updated")},setComparator:function(t){i(t)?this.comparatorFunction=t:r(t)?"-"===t.charAt(0)?(t=t.substring(1),this.comparatorFunction=function(e,n){return L(n[t],e[t])}):this.comparatorFunction=function(e,n){return L(e[t],n[t])}:this.comparatorFunction=null},sort:function(){this.isSorted()||this.models.sort(this.comparatorFunction)},isSorted:function(){var t=this.comparatorFunction;if(!t)return!0;for(var e=this.models.values,n=0,i=e.length-1;i>n;n++)if(t(e[n],e[n+1])>0)return!1;return!0},putRemoteData:function(t,e,n){var i=this,e=e||i.getKey(t),n=n||i.models.get(e),r=i.decode(p(t));if(n&&n.$saved){var s=n.$toJSON();for(var o in t){var u=s[o],a=n.$saved[o];$(u,a)&&(n[o]=r[o],n.$local[o]=t[o]),n.$saved[o]=p(t[o])}n.$addOperation(N)}else n=i.instantiate(r),n.$local=t,n.$saved=n.$local.$saved=p(t),n.$addOperation(N);return i.models.has(e)||(i.models.put(e,n),n.trigger("saved")),n},destroyLocalModel:function(t){var e=this,n=e.models.get(t);return n?n.$hasChanges()?(delete n.$saved,delete n.$local.$saved,e.removeKey(n),e.removeKey(n.$local),n.$addOperation(N),!1):(n.$addOperation(b),e.models.remove(t),n.trigger("removed"),A.debug(A.Events.REMOTE_REMOVE,n),!0):(e.store.remove(t,function(t){t&&A.debug(A.Events.REMOTE_REMOVE,t)}),!1)},init:function(){var t=this;t.store.all(function(e,n){A.debug(A.Events.LOCAL_LOAD,e),t.models.reset();for(var i=0;i<e.length;i++){var r=e[i],s=n[i],o=t.decode(p(r,!0)),u=t.instantiate(o);u.$local=r,r.$deleted?(A.debug(A.Events.LOCAL_RESUME_DELETE,u),u.$addOperation(T)):(r.$saved?(A.debug(A.Events.LOCAL_LOAD_SAVED,u),u.$local.$saved=u.$saved):(A.debug(A.Events.LOCAL_RESUME_SAVE,u),u.$addOperation(C)),t.models.put(s,u))}t.updated(),t.loadRemote()})},loadRemote:function(){function t(t){for(var e={},i=0;i<t.length;i++){var r=n.putRemoteData(t[i]),s=r.$key();e[s]=r}for(var o=n.models.keys,i=0;i<o.length;i++){var u=o[i];if(!(u in e)){var a=n.models.get(u);a.$saved&&(A.debug(A.Events.REMOTE_LOAD_REMOVE,u),n.destroyLocalModel(u))}}n.updated(),A.debug(A.Events.REMOTE_LOAD,t)}function e(t,e){0===e?(A.checkNetworkStatus(),A.online||(n.pendingLoad=!0,A.once("online",function(){A.debug(A.Events.REMOTE_LOAD_RESUME),n.pendingLoad&&(n.pendingLoad=!1,n.loadRemote())})),A.debug(A.Events.REMOTE_LOAD_OFFLINE)):A.debug(A.Events.REMOTE_LOAD_ERROR,e)}var n=this,i={method:"GET",url:n.api};n.rest(i,t,e)},getModels:function(){return this.models.values},getModel:function(t){if(a(t)){for(var e="",n=0;n<t.length;n++)n>0&&(e+=this.keySeparator),e+=t[n];t=e}return this.models.get(t)},handlePublish:function(t){return function(e){var n=e.key,i=e.model;switch(e.op){case"SAVE":t.putRemoteData(i,n),t.updated(),A.debug(A.Events.REALTIME_SAVE,e.model);break;case"REMOVE":t.destroyLocalModel(n)&&t.updated(),A.debug(A.Events.REALTIME_REMOVE,n)}}},instantiate:function(t){return new this.model(t)},encode:function(t){return t},decode:function(t){return t},save:function(t){var e=this,n=t.$key();return t.$deleted?void A.debug(A.Events.SAVE_DELETED,t):(e.models.has(n)||(e.models.put(n,t),e.updated(),t.trigger("saved")),void t.$addOperation(D))},remove:function(t){var e=this,n=t.$key();e.models.has(n)&&(e.models.remove(n),e.updated(),t.trigger("removed")),t.$deleted=!0,t.$pendingSave&&(A.debug(A.Events.REMOVE_CANCEL_SAVE,t),t.$pendingSave=!1),t.$addOperation(V)}},_(m.prototype),S.prototype={$init:function(t){this.$pendingSave=!1,this.$operation=null,this.$relations={},this.$reset(t)},$reset:function(t){var n=this.$db.defaults,r=this.$db.fields;if(h(n))for(var s=0;s<r.length;s++){var o=r[s];if(o in n){var u=n[o];i(u)?this[o]=u():this[o]=p(u)}else this[o]=e}else for(var s=0;s<r.length;s++){var o=r[s];this[o]=e}this.$set(t)},$set:function(t,e){if(h(t))l(t,this);else if(r(t)&&void 0!==e)if(t in this.$relations){var n=this.$db.relations[t];n.set(this,e)}else this[t]=e},$get:function(t,e){if(a(t))return v(this,t,e);if(h(t)){for(var n in t)t[n]=e?p(this[n]):this[n];return t}if(r(t)){if(t in this.$relations){var i=this.$db.relations[t],s=i.get(this);return e?p(s):s}return e?p(this[t]):this[t]}},$save:function(t,e){return this.$set(t,e),this.$db.save(this)},$remove:function(){return this.$db.remove(this)},$addOperation:function(t){var e=new t(this);this.$operation?this.$operation.queue(e):(this.$operation=e,this.$operation.execute())},$toJSON:function(){return this.$db.encode(v(this,this.$db.fields,!0))},$key:function(){return this.$db.getKey(this)},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$getChanges:function(){var t=this.$saved,e=this.$toJSON(),n=this.$db.fields;return t?O(e,t,n,$):e},$hasChanges:function(){if(!this.$saved)return!0;var t=this.$toJSON(),e=this.$saved;for(var n in t){var i=t[n],r=e[n];if(!$(i,r))return!0}return!1}},_(S.prototype),y.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(t,e){return t in this.indices?this.values[this.indices[t]]=e:(this.indices[t]=this.values.length,this.values.push(e),this.keys.push(t)),this},get:function(t){return this.values[this.indices[t]]},remove:function(t){var e=this.indices[t];return s(e)&&this.removeAt(e),this},removeAt:function(t){var e=this.keys[t],n=this.values.pop(),i=this.keys.pop();return t<this.values.length&&(this.values[t]=n,this.keys[t]=i,this.indices[i]=t),delete this.indices[e],this},has:function(t){return t in this.indices},size:function(){return this.values.length},filter:function(t,e){for(var n=e||new y,i=this.size(),r=this.values,s=this.keys,o=0;i>o;o++){var u=r[o],a=s[o];t(u,a)&&n.put(a,u)}return n},reverse:function(){for(var t=this.size()-1,e=Math.ceil(t/2),n=0;e>n;n++)c(this.values,n,t-n),c(this.keys,n,t-n);return this.rebuildIndex(),this},sort:function(t){function e(e,n){for(var r=i.values[Math.floor((n+e)/2)],s=e,o=n;o>=s;){for(;t(i.values[s],r)<0;)s++;for(;t(i.values[o],r)>0;)o--;o>=s&&(c(i.values,s,o),c(i.keys,s,o),s++,o--)}return s}function n(t,i){var r=e(t,i);r-1>t&&n(t,r-1),i>r&&n(r,i)}var i=this,r=this.size()-1;return r>0&&(n(0,r),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var t=0,e=this.keys.length;e>t;t++)this.indices[this.keys[t]]=t;return this}},M.prototype={reset:function(t){this.model=t,this.db=t.$db,this.next=null,this.finished=!1},queue:function(t){this.next&&!t.interrupts?this.next.queue(t):this.next=t},execute:function(){this.run(this.db,this.model)},run:function(t,e){throw"NeuroOperation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute()),this},tryNext:function(t){this.next||(this.next=new t(this.model))},insertNext:function(t){var e=new t(this.model);e.next=this.next,this.next=e},success:function(){var t=this;return function(){t.onSuccess.apply(t,arguments),t.finish()}},onSuccess:function(){},failure:function(){var t=this;return function(){t.onFailure.apply(t,arguments),t.finish()}},onFailure:function(){}},V.prototype=new M(!0),V.prototype.run=function(t,e){var n=e.$key();return e.$local?void(e.$saved?(e.$local.$deleted=!0,t.store.put(n,e.$local,this.success(),this.failure())):(A.debug(A.Events.REMOVE_LOCAL_UNSAVED,e),t.store.remove(n,this.success(),this.failure()))):(A.debug(A.Events.REMOVE_LOCAL_NONE,e),this.finish())},V.prototype.onSuccess=function(t,e,n){var i=this.model;A.debug(A.Events.REMOVE_LOCAL,i),i.$saved&&i.$addOperation(T)},V.prototype.onFailure=function(t){var e=this.model;A.debug(A.Events.REMOVE_LOCAL_ERROR,e,t),e.$saved&&e.$addOperation(T)},b.prototype=new M(!0),b.prototype.run=function(t,e){var n=e.$key();t.models.has(n)&&(t.models.remove(n),t.updated(),e.trigger("removed")),t.store.remove(n,this.success(),this.failure())},T.prototype=new M(!0),T.prototype.run=function(t,e){e.$pendingSave=!1,e.$deleted=!0,this.key=e.$key();var n={method:"DELETE",url:t.api+this.key};t.rest(n,this.success(),this.failure())},T.prototype.onSuccess=function(t){this.finishRemove()},T.prototype.onFailure=function(t,e){var n=this.key,i=this.model;404===e||410===e?(A.debug(A.Events.REMOVE_MISSING,n,i),this.finishRemove()):0!==e?A.debug(A.Events.REMOVE_ERROR,e,n,i):(A.checkNetworkStatus(),A.online||A.once("online",function(){A.debug(A.Events.REMOVE_RESUME,i),i.$addOperation(T)}),A.debug(A.Events.REMOVE_OFFLINE,i))},T.prototype.finishRemove=function(){var t=this.db,e=this.key,n=this.model;A.debug(A.Events.REMOVE_REMOTE,e,n),this.insertNext(b),A.debug(A.Events.REMOVE_PUBLISH,e,n),t.live({op:"REMOVE",key:e})},D.prototype=new M(!1),D.prototype.run=function(t,e){if(e.$deleted)return A.debug(A.Events.SAVE_LOCAL_DELETED,e),this.finish();var n=e.$toJSON();e.$local?l(n,e.$local):e.$local=n,t.store.put(e.$key(),e.$local,this.success(),this.failure())},D.prototype.onSuccess=function(t,e,n){var i=this.model;A.debug(A.Events.SAVE_LOCAL,i),this.tryNext(C)},D.prototype.onFailure=function(t){var e=this.model;A.debug(A.Events.SAVE_LOCAL_ERROR,e,t),this.tryNext(C)},N.prototype=new M(!1),N.prototype.run=function(t,e){t.store.put(e.$key(),e.$local,this.success(),this.failure())},C.prototype=new M(!1),C.prototype.run=function(t,e){if(e.$deleted)return A.debug(A.Events.SAVE_REMOTE_DELETED,e),this.finish();var n=this.key=e.$key(),i=this.saving=e.$getChanges();if(g(i))return this.finish();var r={method:e.$saved?"PUT":"POST",url:e.$saved?t.api+n:t.api,data:i};t.rest(r,this.success(),this.failure())},C.prototype.onSuccess=function(t){var e=this.model;A.debug(A.Events.SAVE_REMOTE,e),this.handleData(t)},C.prototype.onFailure=function(t,e){var n=(this.db,this.model);409===e?(A.debug(A.Events.SAVE_CONFLICT,t,n),this.handleData(t,n,this.db)):410===e||404===e?(A.debug(A.Events.SAVE_UPDATE_FAIL,n),this.insertNext(b)):0!==e?A.debug(A.Events.SAVE_ERROR,n,e):(A.checkNetworkStatus(),A.online||(n.$pendingSave=!0,A.once("online",function(){n.$pendingSave&&(n.$pendingSave=!1,n.$addOperation(C),A.debug(A.Events.SAVE_RESUME,n))})),A.debug(A.Events.SAVE_OFFLINE,n))},C.prototype.handleData=function(t){var e=this.db,n=this.model,i=this.saving;if(n.$deleted)return void A.debug(A.Events.SAVE_REMOTE_DELETED,n,t);for(var r in t)r in i||(i[r]=t[r]);A.debug(A.Events.SAVE_VALUES,i,n),n.$saved||(n.$saved=n.$local.$saved={}),e.putRemoteData(i,this.key,n),A.debug(A.Events.SAVE_PUBLISH,i,n),e.live({op:"SAVE",model:i,key:this.key})},t.Neuro=A}(window);
//# sourceMappingURL=neurosync.min.js.map
