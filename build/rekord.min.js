!function(e,t){function i(e){return e!==t}function n(e){return!!(e&&e.constructor&&e.call&&e.apply)}function s(e){return!!(e&&e.Database&&n(e)&&e.prototype instanceof ke)}function r(e){return"string"==typeof e}function a(e){return"number"==typeof e&&!isNaN(e)}function o(e){return"boolean"==typeof e}function u(e){return e instanceof Date}function h(e){return e instanceof RegExp}function l(e){return e instanceof Array}function d(e){return null!==e&&"object"==typeof e}function c(e,t){return e instanceof Array?e:e.split(t)}function f(e){return!(e===t||null===e)}function v(e,t,i){for(var n=i||w,s=0,r=e.length;r>s;s++)if(n(e[s],t))return s;return!1}function g(){}function p(e,t){return function(){t.apply(e,arguments)}}function m(){return E()+E()+"-"+E()+"-"+E()+"-"+E()+"-"+E()+E()+E()}function E(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function R(e,t,i,n,s){var a=s||le.equals;if(r(t))return a(e[t],i[n]);for(var o=0;o<t.length;o++){var u=t[o],h=n[o];if(!a(e[u],i[h]))return!1}return!0}function $(e,t,i){if(l(t)){for(var n=0;n<t.length;n++)if(!i(e[t[n]]))return!1;return!0}return i(e[t])}function S(e){function t(){}return t.prototype=e.prototype,t}function y(e,t,i){e=S(e),t.prototype=new e,O(i,t.prototype),t.prototype.constructor=t}function A(e){function t(t){return e.apply(this,t)}return t.prototype=e.prototype,function(){return new t(arguments)}}function b(e,t,i){M()?(y(e,t,i),t.create=A(t)):(e=S(e),t.create=function(){var n=new e;return t.apply(n,arguments),O(i,n),n})}function M(){function e(){}if(M.supported===t){e.prototype=[];var i=new e;i.push(0),M.supported=1===i.length}return M.supported}function O(e,t){for(var i in e)t[i]=e[i];return t}function _(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function D(e,i,n,s){i=i||{};for(var r in n){var a=n[r],o=i[r],u=f(o);if(!u&&a===t)throw r+" is a required option";u?e[r]=o:e[r]=P(a)}for(var r in i)r in n||(e[r]=i[r]);s?e.$options=i:e.options=i}function N(e){return 1===e.length?e.toUpperCase():e.charAt(1).toUpperCase()}function L(e){return e.replace(L.REGEX,N)}function T(e){var t=arguments.length>1||!l(e)?Array.prototype.slice.call(arguments):e;return new Ue(t)}function C(e){return f(e)?s(e)?new e:n(e)?e():P(e):e}function k(e,t,i){for(var n={},s=0;s<t.length;s++){var r=t[s];r in e&&(n[r]=i?P(e[r]):e[r])}return n}function I(e,t,i){if(r(t)){var n=e[t];return i?P(n):n}for(var s=[],a=0;a<t.length;a++){var o=t[a],n=e[o];s.push(i?P(n):n)}return s}function F(){for(var e={},t=0;t<arguments.length;t++){var i=arguments[t];if(d(i))for(var n in i)n in e||(e[n]=i[n])}return e}function U(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function H(e){for(var t in e)n(e[t])&&delete e[t];return e}function P(e,i){if(null===e||e===t||"object"!=typeof e||n(e)||h(e))return e;if(l(e)){for(var s=[],r=0;r<e.length;r++)s.push(P(e[r],i));return s}if(u(e))return new Date(e.getTime());var s={};for(var a in e)(i||"$"!==a.charAt(0))&&(s[a]=P(e[a],i));return s}function V(e,t,i,n){for(var s={},r=0;r<i.length;r++){var a=i[r];n(e[a],t[a])||(s[a]=P(e[a]))}return s}function x(e){if(l(e)||r(e))return e.length;if(d(e)){var t=0;for(var i in e)t++;return t}return 0}function Y(e){if(null===e||void 0===e||0===e)return!0;if(l(e)||r(e))return 0===e.length;if(u(e))return 0===e.getTime()||isNaN(e.getTime());if(d(e)){for(var t in e)return!1;return!0}return!1}function w(e,t){return e===t}function K(e,t){return 0===Q(e,t)}function z(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var i=typeof e,s=typeof t;if(i!==s)return!1;var r=l(e),a=l(t);if(r!==a)return!1;if(r){if(e.length!==t.length)return!1;for(var o=0;o<e.length;o++)if(!z(e[o],t[o]))return!1;return!0}if(u(e))return u(t)&&z(e.getTime(),t.getTime());if(h(e))return h(t)&&e.toString()===t.toString();if("object"===i){for(var d in e)if(!("$"===d.charAt(0)||n(e[d])||d in t&&z(e[d],t[d])))return!1;for(var d in t)if(!("$"===d.charAt(0)||n(t[d])||d in e))return!1;return!0}return!1}function G(e,t){return e===t?0:t>e?-1:1}function Q(e,t,i){if(e==t)return 0;var n=f(e),s=f(t);return n!==s?n&&!i||s&&i?-1:1:(u(e)&&(e=e.getTime()),u(t)&&(t=t.getTime()),a(e)&&a(t)?G(e,t):l(e)&&l(t)?G(e.length,t.length):o(e)&&o(t)?e?-1:1:(e+"").localeCompare(t+""))}function B(e,t){if(!e)return!0;for(var i=0,n=t.length-1;n>i;i++)if(e(t[i],t[i+1])>0)return!1;return!0}function q(e,t,i){return le.Comparators[e]=j(t,i)}function J(e,t,i){var s=j(t,i);return n(e)?function(t,i){var n=s(t,i);return 0!==n?n:e(t,i)}:s}function j(e,t){if(n(e))return e;if(r(e)){if(e in le.Comparators)return le.Comparators[e];if("-"===e.charAt(0)){var i=j(e.substring(1),!t);return function(e,t){return-i(e,t)}}return-1!==e.indexOf("{")?function(t,i){var n=ae(e,t),s=ae(e,i);return n.localeCompare(s)}:-1!==e.indexOf(".")?function(i,n){var s=re(e,i),r=re(e,n);return Q(s,r,t)}:function(i,n){var s=f(i)?i[e]:i,r=f(n)?n[e]:n;return Q(s,r,t)}}if(l(e)){for(var i=[],s=0;s<e.length;s++)i[s]=j(e[s],t);return function(e,t){for(var n=0,s=0;s<i.length&&0===n;s++)n=i[s](e,t);return n}}return null}function W(e,t){return le.NumberResolvers[e]=X(t)}function X(e){var t=ee(e);return r(e)&&e in le.NumberResolvers?le.NumberResolvers[e]:function(e){return parseFloat(t(e))}}function Z(e,t,i){return le.PropertyResolvers[e]=ee(t,i)}function ee(e,t){if(n(e))return e;if(r(e))return e in le.PropertyResolvers?le.PropertyResolvers[e]:-1!==e.indexOf("{")?function(t){return ae(e,t)}:-1!==e.indexOf(".")?function(t){return re(e,t)}:function(t){return t[e]};if(l(e))return function(i){return I(i,e).join(t)};if(d(e)){var i=[],s=[];for(var a in e)i.push(a),s.push(ee(e[a],t));return function(e){for(var n=[],r=0;r<a.length;r++)n.push(s[r](e[i[r]]));return n.join(t)}}return function(e){return e}}function te(e,t,i,n){return le.Wheres[e]=ie(t,i,n)}function ie(e,t,i){var s=i||w;if(n(e))return e;if(l(e)){for(var a=[],o=0;o<e.length;o++){var u=e[o];a.push(l(u)?ie.apply(this,u):ie(u))}return function(e){for(var t=0;t<a.length;t++)if(!a[t](e))return!1;return!0}}if(d(e))return function(t){for(var i in e)if(!s(t[i],e[i]))return!1;return!0};if(r(e)){if(e in le.Wheres)return le.Wheres[e];var h=ee(e);return f(t)?function(e){return s(h(e),t)}:function(e){return f(h(e))}}return function(e){return!0}}function ne(e,t){return le.Havings[e]=se(t)}function se(e){return n(e)?e:r(e)?e in le.Havings?le.Havings[e]:function(t){return f(t)&&f(t[e])}:function(){return!0}}function re(e,t){var i=!0;return e.replace(re.REGEX,function(e){if(i)if(l(t)){var s=parseInt(e);isNaN(s)?i=!1:t=t[s]}else if(d(t))if(e in t){var r=t[e];t=n(r)?r():r}else i=!1;else i=!1}),i?t:void 0}function ae(e,t){return e.replace(ae.REGEX,function(e){return re(e,t)})}function oe(e){return function(t){return ae(e,t)}}function ue(e,t,i,n){var s=n?"$on":"on",r=n?"$off":"off";e[t]=function(e,t){function n(){var i=e.apply(t||o,arguments);i===!1&&a()}function a(){u||(o[r](i,n),u=!0)}var o=this,u=!1;return o[s](i,n),a}}function he(e,t){function s(e,t,s,r,a){if(!n(r))return g;var s=c(s," "),o=e[t];i(o)||(o=e[t]={});for(var h=0;h<s.length;h++){var l=s[h],d=o[l];i(d)||(d=o[l]=[]),d.push([r,a||e,0])}return function(){for(var e=0;e<s.length;e++)u(o,s[e],r)}}function r(e,t,i){return s(this,"$$on",e,t,i)}function a(e,t,i){return s(this,"$$once",e,t,i)}function o(e,t,i){return s(this,"$$after",e,t,i)}function u(e,t,i){if(e&&t in e)for(var n=e[t],s=n.length-1;s>=0;s--)n[s][v]===i&&n.splice(s,1)}function h(e,t){e&&t in e&&delete e[t]}function l(e,t){if(i(e)){var e=c(e," ");if(n(t))for(var s=0;s<e.length;s++)u(this.$$on,e[s],t),u(this.$$once,e[s],t),u(this.$$after,e[s],t);else for(var s=0;s<e.length;s++)h(this.$$on,e[s]),h(this.$$once,e[s]),h(this.$$after,e[s])}else h(this,"$$on"),h(this,"$$once"),h(this,"$$after");return this}function d(e,t,i,n){if(e&&t in e){for(var s=e[t],r=++E,a=0;a<s.length;a++){var o=s[a];o&&o[m]!==r&&(o[m]=r,o[v].apply(o[p],i),o!==s[a]&&(a=-1))}n&&delete e[t]}}function f(e,t){for(var e=c(e," "),i=0;i<e.length;i++){var n=e[i];d(this.$$on,n,t,!1),d(this.$$once,n,t,!0),d(this.$$after,n,t,!1)}return this}var v=0,p=1,m=2,E=0;t?(e.$on=r,e.$once=a,e.$after=o,e.$off=l,e.$trigger=f):(e.on=r,e.once=a,e.after=o,e.off=l,e.trigger=f)}function le(e){if(e.name in le.cache)return le.cache[e.name];le.trigger(le.Events.Options,[e]);var t=new be(e),i=new Function("return function "+t.className+"(props, remoteData) { this.$init( props, remoteData ) }")();return i.prototype=new ke(t),t.Model=i,i.Database=t,le.trigger(le.Events.Plugins,[i,t,e]),le.cache[t.name]=i,le.cache[t.className]=i,le.autoload?t.loadBegin(function(e){e&&t.loadFinish()}):le.unloaded.push(t),le.trigger(le.Events.Initialized,[i]),le.debug(le.Debugs.CREATION,t,e),i}function de(e,t,i){var s=n(i)?i:d(i)&&n(i.get)?i.get:g,r=d(i)&&n(i.set)?i.set:g;if(Object.defineProperty)Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s,set:r});else{var a=e.$init;e.$init=function(){a.apply(this,arguments);var e=this[t]=s.apply(this),i=function(){var i=this[t];i!==e?r.call(this,i):e=this[t]=s.apply(this)};this.$after(ke.Events.Changes,i,this)}}}function ce(e,t,i,s){var r={on:i?"$on":"on",once:i?"$once":"once",after:i?"$after":"after"},a=s||[];if(n(t))a.push({when:r.on,events:e,invoke:t});else if(l(t)&&2===t.length&&n(t[0]))a.push({when:r.on,events:e,invoke:t[0],context:t[1]});else if(d(t))for(var o in t)if(o in r){var u=t[o],h=r[o];n(u)?a.push({when:h,events:e,invoke:u}):l(u)&&2===u.length&&n(u[0])&&a.push({when:h,events:e,invoke:u[0],context:u[1]})}return a}function fe(e,t){for(var i=0;i<t.length;i++){var n=t[i];e[n.when](n.events,n.invoke,n.context)}}function ve(){return e.File&&e.FileReader&&e.FileList}function ge(t){return t instanceof e.File?t:t instanceof e.Blob?t:t instanceof e.FileList&&t.length>0?t[0]:!1}function pe(e){return e}function me(e){var t=r(e)?e.indexOf(";base64,"):-1;return-1===t?e:e.substring(t+8)}function Ee(e,t){t.autoSave&&e.$isSaved()&&e.$save()}function Re(e,t,i,n,s){e.$files=e.$files||{},e.$files[t]={value:i,user:i,file:n,options:s}}function $e(e,i,n,s,r){var a=t,o=!1;return e&&e.valueToUser?e.valueToUser(i,n,s,function(e){n.$files[s].user=e,o?(n[s]=e,Ee(n,r)):a=e}):a=i,o=!0,a}function Se(i,n,s){var r=le.fileProcessors[s.processor];return i in e.FileReader.prototype||le.trigger(le.Events.FilesNotSupported),function(a,o,u){var h=ge(a);if(h!==!1){var l=new e.FileReader,c=t,f=!1;return l.onload=function(e){var t=n(e.target.result);Re(o,u,t,h,s),c=$e(r,t,o,u,s),f&&(o[u]=c,Ee(o,s))},l[i](h),f=!0,c}if(d(a)&&a.FILE){var c=t,v=function(e){c=e};return le.trigger(le.Events.FileOffline,[a,o,u,v]),c}return Re(o,u,a,null,s),$e(r,a,o,u,s)}}function ye(e,i,n,s){if(i.$files&&n in i.$files){var r=i.$files[n];if(s&&r.save===!1||!s&&r.store===!1)return t;if(!s&&r.file){var a=k(r.file,le.fileProperties,!1);return a.FILE=!0,a}if(e===r.user)return s&&r.file&&i.$once(ke.Events.RemoteSave,function(){delete r.file,i.$addOperation(Ze,le.Cascade.Local)}),r.value}return e}function Ae(e){var t=!1,i=[],n=function(){t?e.apply(this,arguments):i.push(this,dt.slice.apply(arguments))};return n.open=function(){if(!t){for(var n=0;n<i.length;n+=2){var s=i[n],r=i[n+1];e.apply(s,r)}i.length=0,t=!0}},n}function be(e){var t=be.Defaults;D(this,e,t);for(var i in e)i in t||(this[i]=e[i]);var n=this.key,s=this.fields;if(l(n))for(var r=n.length-1;r>=0;r--)v(s,n[r])===!1&&s.unshift(n[r]);else v(s,n)===!1&&s.unshift(n);this.keys=c(this.key),this.models=new Ve(this),this.all={},this.loaded={},this.className=this.className||L(this.name),this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.firstRefresh=!1,this.pendingOperations=0,this.afterOnline=!1,this.saveFields=P(s),this.prepare(this,e),this.rest=this.createRest(this),this.store=this.createStore(this),this.live=this.createLive(this),this.setComparator(this.comparator,this.comparatorNullsFirst),this.setRevision(this.revision),this.setSummarize(this.summarize),this.relations={},this.relationNames=[];for(var a in e)if(a in le.Relations){var o=le.Relations[a];if(o.prototype instanceof it){var u=e[a];for(var h in u){var d=u[h],f=new o;f.init(this,h,d),f.save&&this.saveFields.push(h),this.relations[h]=f,this.relationNames.push(h)}}}}function Me(e,t,i){var n=this.encodings;for(var s in t)s in n&&(t[s]=n[s](t[s],e,s,i));return t}function Oe(e){var t=this.decodings;for(var i in e)i in t&&(e[i]=t[i](e[i],e,i));return e}function _e(e){return e.$key()}function De(e){return le.rest(e)}function Ne(e){return le.store(e)}function Le(e){return le.live(e)}function Te(e){return e}function Ce(e){return e}function ke(e){this.$db=e}function Ie(){this.values=[],this.keys=[],this.indices={}}function Fe(e,t,i){this.context=e,this.success=t,this.failure=i,this.call=0,this.callCanceled=0}function Ue(e){this.addAll(e)}function He(e,t,i){this.onChanges=p(this,this.handleChanges),this.pageSize=t,this.pageIndex=i||0,this.pageCount=0,this.setCollection(e)}function Pe(e,t){this.bind(),this.init(e,t)}function Ve(e,t,i){this.init(e,t,i)}function xe(e,t){this.bind(),this.init(e,t)}function Ye(e,t,i,n,s){this.model=t,this.relator=i,this.init(e,n,s)}function we(e,t,i){e.discriminator=t,e.discriminatorsToModel=i;var n=(e.buildKeyFromInput,e.parseModel,e.clone),s=e.cloneEmpty;return e.buildKeyFromInput=function(e){if(d(e)){var t=e[this.discriminator],i=this.discriminatorsToModel[t];if(i)return i.Database.buildKeyFromInput(e)}return e},e.parseModel=function(e,t){if(e instanceof ke)return e;var i=f(e)?e[this.discriminator]:null,n=this.discriminatorsToModel[i];return n?n.Database.parseModel(e,t):null},e.clone=function(){return we(n.apply(this),t,i)},e.cloneEmpty=function(){return we(s.apply(this),t,i)},e}function Ke(e,t,i){this.$init(e,t,i)}function ze(e,t,i){this.$init(e,t,i)}function Ge(e,t,i){this.cascade=e,this.model=t,this.operation=i,this.status=null,this.completed=0,this.operations=0}function Qe(){}function Be(e,t){this.reset(e,t)}function qe(e,t){this.reset(e,t)}function Je(e,t){this.reset(e,t)}function je(e,t){this.reset(e,t)}function We(e,t){this.reset(e,t)}function Xe(e,t){this.reset(e,t)}function Ze(e,t){this.reset(e,t)}function et(e,t){this.reset(e,t)}function tt(e,t){this.reset(e,t)}function it(){}function nt(){}function st(){}function rt(){}function at(){}function ot(){}function ut(){}function ht(){}function lt(e){this.database=e}var dt=Array.prototype;L.REGEX=/(^.|_.)/g,le.Comparators={},le.NumberResolvers={},le.PropertyResolvers={},le.Wheres={},le.Havings={},re.REGEX=/([\w$]+)/g,ae.REGEX=/\{[^\}]+\}/g,le.autoload=!1,le.unloaded=[],le.load=function(e,t){function i(t,i){if(a.push(t),r.push(i),r.length===s.length){for(var o=0;o<r.length;o++){var i=r[o],t=a[o];t&&i.loadFinish()}e&&e.call(n)}}var n=t||this,s=le.unloaded.slice(),r=[],a=[];le.unloaded.length=0;for(var o=0;o<s.length;o++)s[o].loadBegin(i)},le.cache={},le.get=function(t,i,s){function r(){var e=le.cache[t];e&&(i.call(o,e),u())}var a=le.cache[t],o=s||e;if(n(i))if(a)i.call(o,a);else var u=le.on(le.Events.Initialized,r);return a},he(le),le.Events={Initialized:"initialized",Plugins:"plugins",Options:"options",Online:"online",Offline:"offline"},le.Cascade={None:0,Local:1,Rest:2,NoLive:3,Live:4,NoRest:5,Remote:6,All:7},le.Cache={None:"none",Pending:"pending",All:"all"},le.Store={None:0,Model:1,Key:2,Keys:3},le.Save={None:0,Model:4,Key:5,Keys:6},le.on(le.Events.Plugins,function(e,t,i){e.all=function(){return t.models}}),le.on(le.Events.Plugins,function(e,t,i){e.boot=function(e){return l(e)?new Ve(t,e,!0):d(e)?t.putRemoteData(e):e}}),le.on(le.Events.Plugins,function(e,t,i){e.collect=function(e){var i=arguments.length>1||!l(e)?dt.slice.call(arguments):e;return new Ve(t,i)}}),le.on(le.Events.Plugins,function(e,t,i){e.create=function(e){var i=d(e)?t.createModel(e):t.instantiate();return i.$save(),i}}),le.on(le.Events.Plugins,function(e,t,i){var n=F(i.dynamic,be.Defaults.dynamic);if(!Y(n))for(var s in n)de(e.prototype,s,n[s])}),le.on(le.Events.Plugins,function(e,t,i){var n=F(i.events,be.Defaults.events);if(!Y(n)){var s=[],r=[];for(var a in n){var o=n[a],u=L(a),h=be.Events[u],l=ke.Events[u];h&&ce(h,o,!1,r),l&&ce(l,o,!0,s)}if(fe(t,r),s.length){var d=e.prototype.$init;e.prototype.$init=function(){d.apply(this,arguments),fe(this,s)}}}}),le.on(le.Events.Plugins,function(e,t,i){function n(e){i[e]||(t[e]=u[e])}function r(e){var i=t[e],n=u[e];for(var s in n)s in i||(i[s]=n[s])}function a(e,i){for(var n=u[i||e],s=t[e],r=n.length-1;r>=0;r--){var a=v(s,n[r]);a!==!1&&s.splice(a,1),s.unshift(n[r])}}var o=i.extend||be.Defaults.extend;if(s(o)){var u=(be.Defaults,o.Database),h=u.options;n("keySeparator"),r("defaults"),r("ignoredFields"),n("loadRelations"),n("loadRemote"),n("autoRefresh"),n("cache"),n("fullSave"),n("fullPublish"),r("encodings"),r("decodings"),n("summarize"),a("fields"),a("saveFields","fields"),i.comparator||t.setComparator(h.comparator,h.comparatorNullsFirst),i.revision||t.setRevision(h.revision),i.summarize||t.setSummarize(h.summarize);for(var l in u.relations)if(!(l in t.relations)){var d=u.relations[l],c=new d.constructor;c.init(t,l,d.options),c.save&&t.saveFields.push(l),t.relations[l]=c,t.relationNames.push(l)}t.rest=le.rest(t),t.store=le.store(t),t.live=le.live(t)}}),le.on(le.Events.Plugins,function(e,t,i){e.fetch=function(e,i,s){var r=t.buildKeyFromInput(e),a=t.get(r);if(a||(a=t.buildObjectFromKey(r),d(e)&&a.$set(e)),n(i)){var o=s||this;a.$once(ke.Events.RemoteGets,function(){i.call(o,a)})}return a.$refresh(),a}}),le.on(le.Events.Plugins,function(e,t,i){e.fetchAll=function(e,i){return t.refresh(e,i),t.models}}),le.on(le.Events.Plugins,function(e,t,i){var n=i.files||be.Defaults.files;if(d(n)){if(!ve())return void le.trigger(le.Events.FilesNotSupported);for(var s in n){var a=n[s];r(a)&&(a={type:a}),t.decodings[s]=ct[a.type](t,a),t.encodings[s]=ye}}}),le.fileProcessors={},le.Events.FilesNotSupported="files-not-supported",le.Events.FileTooLarge="file-too-large",le.Events.FileWrongType="file-wrong-type",le.Events.FileOffline="file-offline",le.addFileProcessor=function(e,t){le.fileProcessors[e]=t},le.fileProperties=["lastModifiedDate","name","size","type"];var ct={text:function(e,t){return Se("readAsText",pe,t)},dataURL:function(e,t){return Se("readAsDataURL",pe,t)},base64:function(e,t){return Se("readAsDataURL",me,t)},resource:function(e,i){return function(e,n,s){var o=ge(e),u=le.fileProcessors[i.processor];if(!u)throw"Processor required for resource files.";if(o!==!1){if(a(i.capacity)&&a(o.size)&&o.size>i.capacity)return le.trigger(le.Events.FileTooLarge,[o,n,s]),t;if(l(i.types)&&r(o.type)&&v(i.types,o.type)===!1)return le.trigger(le.Events.FileWrongType,[o,n,s]),t;var h=t,c=!1;return u.fileToValue(o,n,s,function(e){Re(n,s,e,o,i),h=$e(u,e,n,s,i),c&&(n[s]=h,Ee(n,i))}),c=!0,h}return d(e)&&e.FILE?void le.trigger(le.Events.FileOffline,[e,n,s]):(Re(n,s,e,null,i),$e(u,e,n,s,i))}}};le.on(le.Events.Plugins,function(e,t,i){e.find=function(e,i,n){return t.models.firstWhere(e,i,n)}}),le.on(le.Events.Plugins,function(e,t,i){e.get=function(e,i,s){return n(i)?void t.grabModel(e,i,s):t.get(e)}}),le.on(le.Events.Plugins,function(e,t,i){e.grab=function(i,n,s){var r=s||this,a=t.get(i);return a?n.call(r,a):t.grabModel(i,function(t){t?n.call(r,t):e.fetch(i,n,s)}),a}}),le.on(le.Events.Plugins,function(e,t,i){e.grabAll=function(e,i){var n=i||this,s=t.models;return s.length?e.call(n,s):t.ready(function(){s.length?e.call(n,s):t.refresh(function(){e.call(n,s)})}),s}}),le.on(le.Events.Plugins,function(e,t,i){var n=F(i.methods,be.Defaults.methods);Y(n)||O(n,e.prototype)}),le.on(le.Events.Plugins,function(e,t,i){e.ready=function(e,i,n){t.ready(e,i,n)}}),le.on(le.Events.Plugins,function(e,t,i){e.refresh=function(e,i){return t.refresh(e,i)}}),le.on(le.Events.Plugins,function(e,t,i){e.search=function(e,i){return new Ke(t,e,i)}}),le.on(le.Events.Plugins,function(e,t,i){e.searchPaged=function(e,i){return new ze(t,e,i)}}),le.on(le.Events.Options,function(e){var t=e.shard||be.Defaults.shard;d(t)&&(e.createRest=le.shard(t))}),le.on(le.Events.Plugins,function(e,t,i){function n(){return(new Date).getTime()}function s(){return new Date}function o(e){return e instanceof Date?e.getTime():e}function u(e){return a(e)?new Date(e):r(e)&&Date.parse?Date.parse(e):e}function h(e){var i=v(t.fields,e);i===!1&&(t.fields.push(e),t.saveFields.push(e)),e in t.defaults||(t.defaults[e]=E),m&&(e in t.encodings||(t.encodings[e]=o),e in t.decodings||(t.decodings[e]=u))}function c(e){h(e),t.ignoredFields[e]=!0}function f(i){h(i),t.ignoredFields[i]=!0;var n=e.prototype.$save;e.prototype.$save=function(){this[i]=E(),n.apply(this,arguments)}}function g(e,t){switch(e){case"created_at":return c(t);case"updated_at":return f(t);default:return h(t)}}var p=i.timestamps||be.Defaults.timestamps,m=i.timestampsAsDate||be.Defaults.timestampsAsDate,E=m?s:n;if(p)if(r(p))g(p,p);else if(l(p))for(var R=0;R<p.length;R++)g(p[R],p[R]);else if(d(p))for(var $ in p)g($,p[$]);else c("created_at"),f("updated_at")}),le.on(le.Events.Plugins,function(e,t,i){e.filtered=function(e,i,n){return t.models.filtered(e,i,n)}}),le.debug=function(e,t){},le.Debugs={CREATION:0,REST:1,AUTO_REFRESH:73,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,GET_LOCAL_SKIPPED:104,GET_LOCAL:105,GET_LOCAL_ERROR:106,GET_REMOTE:107,GET_REMOTE_ERROR:108,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,HASONE_QUERY:111,HASONE_QUERY_RESULTS:112,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:72,BELONGSTO_QUERY:113,BELONGSTO_QUERY_RESULTS:114,HASMANY_INIT:74,HASMANY_NINJA_REMOVE:75,HASMANY_NINJA_SAVE:76,HASMANY_INITIAL:77,HASMANY_INITIAL_PULLED:78,HASMANY_REMOVE:79,HASMANY_SORT:80,HASMANY_ADD:81,HASMANY_LAZY_LOAD:82,HASMANY_INITIAL_GRABBED:83,HASMANY_NINJA_ADD:84,HASMANY_AUTO_SAVE:85,HASMANY_PREREMOVE:86,HASMANY_POSTSAVE:87,HASMANY_QUERY:115,HASMANY_QUERY_RESULTS:116,HASMANYTHRU_INIT:88,HASMANYTHRU_NINJA_REMOVE:89,HASMANYTHRU_NINJA_SAVE:90,HASMANYTHRU_NINJA_THRU_REMOVE:91,HASMANYTHRU_INITIAL:92,HASMANYTHRU_INITIAL_PULLED:93,HASMANYTHRU_REMOVE:94,HASMANYTHRU_SORT:95,HASMANYTHRU_ADD:96,HASMANYTHRU_LAZY_LOAD:97,HASMANYTHRU_INITIAL_GRABBED:98,HASMANYTHRU_NINJA_ADD:99,HASMANYTHRU_AUTO_SAVE:100,HASMANYTHRU_PREREMOVE:101,HASMANYTHRU_POSTSAVE:102,HASMANYTHRU_THRU_ADD:103,HASMANYTHRU_THRU_REMOVE:68,HASMANYTHRU_QUERY:117,HASMANYTHRU_QUERY_RESULTS:118,HASREMOTE_INIT:50,HASREMOTE_SORT:121,HASREMOVE_NINJA_REMOVE:109,HASREMOVE_NINJA_SAVE:110,HASREMOVE_QUERY:119,HASREMOVE_QUERY_RESULTS:120},le.rest=function(e){return{all:function(e,t){e([])},get:function(e,t,i){i(null,-1)},create:function(e,t,i,n){i({})},update:function(e,t,i,n){i({})},remove:function(e,t,i){t({})},query:function(e,t,i,n){i([])}}},le.store=function(e){return{put:function(e,t,i,n){i(e,t)},get:function(e,t,i){i(e,void 0)},remove:function(e,t,i){t(e)},all:function(e,t){e([],[])}}},le.live=function(e){return{save:function(e,t){},remove:function(e){}}},le.online=window.navigator.onLine!==!1,le.forceOffline=!1,le.setOnline=function(){le.online=!0,le.debug(le.Debugs.ONLINE),le.trigger(le.Events.Online)},le.setOffline=function(){le.online=!1,le.debug(le.Debugs.OFFLINE),le.trigger(le.Events.Offline)},le.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener(le.Events.Online,le.setOnline,!1),window.addEventListener(le.Events.Offline,le.setOffline,!1)):(document.body.ononline=le.setOnline,document.body.onoffline=le.setOffline)},le.checkNetworkStatus=function(){var e=window.navigator.onLine;le.forceOffline&&(e=!1),e===!0&&le.online===!1?le.setOnline():e===!1&&le.online===!0&&le.setOffline()},be.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",Loads:"no-load remote-load local-load",Changes:"updated"},be.Defaults={name:t,className:null,key:"id",keySeparator:"/",fields:[],ignoredFields:{},defaults:{},comparator:null,comparatorNullsFirst:null,revision:null,loadRelations:!0,loadRemote:!0,autoRefresh:!0,cache:le.Cache.All,fullSave:!1,fullPublish:!1,encodings:{},decodings:{},prepare:g,encode:Me,decode:Oe,resolveModel:Te,resolveModels:Ce,summarize:_e,createRest:De,createStore:Ne,createLive:Le},be.prototype={ready:function(e,t,i){function n(){i||o(),(!a||i)&&(e.call(r,s)===!1&&o(),a=!0)}var s=this,r=t||s,a=!1;if(s.initialized&&(e.call(r,s),a=!0),!s.initialized||i)var o=s.on(be.Events.Loads,n);return a},hasData:function(e){if(!d(e))return!1;for(var t in e)if(!this.ignoredFields[t])return!0;return!1},grabModel:function(e,t,i,n){function s(){var i=r.parseModel(e,n);return i===!1||o||(r.loadRemote||r.remoteLoaded||null!==i&&i.$isSaved()?(o=!0,t.call(a,i)):(i||(i=r.buildObjectFromKey(r.buildKeyFromInput(e))),i.$once(ke.Events.RemoteGets,function(){o||(o=!0,d(e)&&i.$set(e),t.call(a,i.$isSaved()?i:null))}),i.$refresh())),o?!1:!0}var r=this,a=i||r,o=!1;s()&&r.ready(s,r,!0)},parseModel:function(e,t){var i=this,r=i.remoteLoaded||!i.loadRemote;if(!f(e))return r?null:!1;s(e)&&(e=new e),n(e)&&(e=e());var a=i.buildKeyFromInput(e);if(e instanceof i.Model)return e;if(a in i.all){var o=i.all[a];return d(e)&&(t?i.putRemoteData(e,a,o):o.$set(e)),o}return d(e)?t?i.putRemoteData(e):i.instantiate(i.decode(e)):r?null:!1},removeKey:function(e){var t=this.key;if(l(t))for(var i=0;i<t.length;i++)delete e[t[i]];else delete e[t]},buildKey:function(e,t){var i=this.buildKeys(e,t);return l(i)&&(i=i.join(this.keySeparator)),i},buildKeys:function(e,t){var i=null;if(l(t)){i=[];for(var n=0;n<t.length;n++)i.push(e[t[n]])}else i=e[t],i||(i=e[t]=m());return i},buildKeyFromInput:function(e){return e instanceof this.Model?e.$key():l(e)?this.buildKeyFromArray(e):d(e)?this.buildKey(e,this.key):e},buildKeyFromArray:function(e){return e.join(this.keySeparator)},getKey:function(e,t){var i=this.key,n=this.buildKey(e,i);if($(e,i,f))return n;if(!t)throw"Composite key not supplied.";return!1},getKeys:function(e){return this.buildKeys(e,this.key)},buildObjectFromKey:function(e){var t=this,i={};if(l(t.key)){r(e)&&(e=e.split(t.keySeparator));for(var n=0;n<t.key.length;n++)i[t.key[n]]=e[n]}else i[t.key]=e;return t.instantiate(i)},updated:function(){this.sort(),this.trigger(be.Events.Updated)},setRevision:function(e){n(e)?this.revisionFunction=e:r(e)?this.revisionFunction=function(i,n){var s=d(i)&&e in i?i[e]:t,r=d(n)&&e in n?n[e]:t;return s===t||r===t?!1:Q(s,r)>0}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e,t){this.models.setComparator(e,t)},addComparator:function(e,t){this.models.addComparator(e,t)},setSummarize:function(e){n(e)?this.summarize=e:r(e)?v(this.fields,e)!==!1?this.summarize=function(t){return f(t)?t[e]:t}:this.summarize=oe(e):this.summarize=function(e){return e.$key()}},sort:function(){this.models.sort()},isSorted:function(){return this.models.isSorted()},clean:function(){var e=this,t=e.models.keys,i=e.models;e.all={};for(var n=0;n<t.length;n++)e.all[t[n]]=i[n]},putRemoteData:function(e,t,i,n){if(!d(e))return i;var s=this,t=t||s.getKey(e),i=i||s.all[t],r=s.decode(P(e));if(i){var a=this.revisionFunction(i,e);if(a)return le.debug(le.Debugs.SAVE_OLD_REVISION,s,i,e),i}if(i){for(var o=s.keys,u=0;u<o.length;u++){var h=o[u],l=i[h],c=r[h];if(f(l)&&f(c)&&l!==c)throw new Error("Model keys cannot be changed")}s.all[t]=i,i.$saved||(i.$saved={});var v=i.$toJSON(!0),g={},p=!1,m={},E=Y(i.$saved),R=s.relations;for(var $ in e)if("$"!==$.charAt(0))if($ in R)i.$set($,e[$],!0);else{var S=v[$],y=i.$saved[$];E||n||z(S,y)?(i[$]=r[$],m[$]=e[$],i.$local&&(i.$local[$]=e[$])):(g[$]=e[$],p=!0),i.$saved[$]=P(e[$])}p?i.$trigger(ke.Events.PartialUpdate,[e,g]):i.$trigger(ke.Events.FullUpdate,[e,m]),i.$trigger(ke.Events.RemoteUpdate,[e]),i.$addOperation(et),s.models.has(t)||(s.models.put(t,i),s.trigger(be.Events.ModelAdded,[i,!0]))}else i=s.createModel(r,!0),s.cache===le.Cache.All?(i.$local=i.$toJSON(!1),i.$local.$status=i.$status,i.$saved=i.$local.$saved=i.$toJSON(!0),i.$addOperation(et)):i.$saved=i.$toJSON(!0);return i},createModel:function(e,t){var i=this,n=i.instantiate(e,t),s=n.$key();return i.models.has(s)||(i.models.put(s,n),i.trigger(be.Events.ModelAdded,[n,t])),n},destroyLocalUncachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,i.removeKey(e),e.$trigger(ke.Events.Detach),!1):(delete i.all[t],i.models.remove(t),i.trigger(be.Events.ModelRemoved,[e]),e.$trigger(ke.Events.RemoteAndRemove),le.debug(le.Debugs.REMOTE_REMOVE,i,e),!0):!1},destroyLocalCachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,delete e.$local.$saved,i.removeKey(e),i.removeKey(e.$local),e.$trigger(ke.Events.Detach),e.$addOperation(et),!1):(e.$addOperation(We),delete i.all[t],i.models.remove(t),i.trigger(be.Events.ModelRemoved,[e]),e.$trigger(ke.Events.RemoteAndRemove),le.debug(le.Debugs.REMOTE_REMOVE,i,e),!0):(i.store.remove(t,function(e){e&&le.debug(le.Debugs.REMOTE_REMOVE,i,e)}),!1)},destroyLocalModel:function(e){var t=this,i=t.all[e];return t.cache===le.Cache.All?t.destroyLocalCachedModel(i,e):t.destroyLocalUncachedModel(i,e)},loadFinish:function(){var e=this;for(var t in e.loaded){var i=e.loaded[t];i.$status===ke.Status.RemovePending?(le.debug(le.Debugs.LOCAL_RESUME_DELETE,e,i),i.$addOperation(Xe)):(i.$status===ke.Status.SavePending?(le.debug(le.Debugs.LOCAL_RESUME_SAVE,e,i),i.$addOperation(tt)):le.debug(le.Debugs.LOCAL_LOAD_SAVED,e,i),e.models.put(t,i,!0))}e.loaded={},e.updated(),e.loadRemote&&(0===e.pendingOperations?e.refresh():e.firstRefresh=!0)},loadBegin:function(e){function t(t,i){le.debug(le.Debugs.LOCAL_LOAD,n,t);for(var s=0;s<t.length;s++){var r=t[s],a=i[s],o=n.decode(P(r,!0)),u=n.instantiate(o,!0);u.$local=r,u.$saved=r.$saved,u.$status!==ke.Status.Removed&&(n.loaded[a]=u,n.all[a]=u)}n.initialized=!0,n.localLoaded=!0,n.trigger(be.Events.LocalLoad,[n]),e(!0,n)}function i(){n.loadNone(),e(!1,n)}var n=this;n.loadRemote&&n.autoRefresh&&le.after(le.Events.Online,n.onOnline,n),n.cache===le.Cache.None?(n.loadNone(),e(!1,n)):n.store.all(t,i)},loadNone:function(){var e=this;e.loadRemote?e.refresh():(e.initialized=!0,e.trigger(be.Events.NoLoad,[e]))},onOnline:function(){this.afterOnline=!0,0===this.pendingOperations&&this.onOperationRest()},onOperationRest:function(){var e=this;(e.autoRefresh&&e.remoteLoaded&&e.afterOnline||e.firstRefresh)&&(e.afterOnline=!1,e.firstRefresh=!1,le.debug(le.Debugs.AUTO_REFRESH,e),e.refresh())},refresh:function(e,t){function i(t){for(var i=s.resolveModels(t),n={},a=0;a<i.length;a++){var o=s.putRemoteData(i[a]);if(o){var u=o.$key();n[u]=o}}for(var h=s.models.keys(),a=0;a<h.length;a++){var l=h[a];if(!(l in n)){var d=s.models.get(l);d.$saved&&(le.debug(le.Debugs.REMOTE_LOAD_REMOVE,s,l),s.destroyLocalModel(l))}}s.initialized=!0,s.remoteLoaded=!0,s.trigger(be.Events.RemoteLoad,[s]),s.updated(),le.debug(le.Debugs.REMOTE_LOAD,s,i),e&&e.call(r,s.models)}function n(t,i){0===i?(le.checkNetworkStatus(),le.online||(s.pendingRefresh=!0,le.once(le.Events.Online,s.onRefreshOnline,s)),le.debug(le.Debugs.REMOTE_LOAD_OFFLINE,s)):(le.debug(le.Debugs.REMOTE_LOAD_ERROR,s,i),s.initialized=!0,s.trigger(be.Events.NoLoad,[s,t])),
e&&e.call(r,s.models)}var s=this,r=t||s;s.rest.all(i,n)},onRefreshOnline:function(){var e=this;le.debug(le.Debugs.REMOTE_LOAD_RESUME,e),e.pendingRefresh&&(e.pendingRefresh=!1,e.refresh())},get:function(e){return this.all[this.buildKeyFromInput(e)]},filter:function(e){var t=this.all,i=[];for(var n in t){var s=t[n];e(s)&&i.push(s)}return i},liveSave:function(e,t){this.putRemoteData(t,e),this.updated(),le.debug(le.Debugs.REALTIME_SAVE,this,t,e)},liveRemove:function(e){this.destroyLocalModel(e)&&this.updated(),le.debug(le.Debugs.REALTIME_REMOVE,this,e)},instantiate:function(e,t){return new this.Model(e,t)},addReference:function(e){this.all[e.$key()]=e},save:function(e,t){var i=this;if(e.$isDeleted())return void le.debug(le.Debugs.SAVE_DELETED,i,e);var n=e.$key(),s=i.models.has(n);s?(i.trigger(be.Events.ModelUpdated,[e]),e.$trigger(ke.Events.UpdateAndSave)):(i.models.put(n,e),i.trigger(be.Events.ModelAdded,[e]),i.updated(),e.$trigger(ke.Events.CreateAndSave)),e.$addOperation(Ze,t)},remove:function(e,t){var i=this;this.removeFromModels(e),e.$status===ke.Status.SavePending&&le.debug(le.Debugs.REMOVE_CANCEL_SAVE,i,e),e.$status=ke.Status.RemovePending,e.$addOperation(je,t)},removeFromModels:function(e){var t=this,i=e.$key();t.models.has(i)&&(t.models.remove(i),t.trigger(be.Events.ModelRemoved,[e]),t.updated(),e.$trigger(ke.Events.Removed))},refreshModel:function(e,t){e.$addOperation(Be,t)}},he(be.prototype),ue(be.prototype,"change",be.Events.Changes),ke.Events={Created:"created",Saved:"saved",PreSave:"pre-save",PostSave:"post-save",PreRemove:"pre-remove",PostRemove:"post-remove",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",Change:"change",CreateAndSave:"created saved",UpdateAndSave:"updated saved",KeyUpdate:"key-update",RelationUpdate:"relation-update",Removed:"removed",RemoteUpdate:"remote-update",LocalSave:"local-save",LocalSaveFailure:"local-save-failure",LocalSaves:"local-save local-save-failure",RemoteSave:"remote-save",RemoteSaveFailure:"remote-save-failure",RemoteSaveOffline:"remote-save-offline",RemoteSaves:"remote-save remote-save-failure remote-save-offline",LocalRemove:"local-remove",LocalRemoveFailure:"local-remove-failure",LocalRemoves:"local-remove local-remove-failure",RemoteRemove:"remote-remove",RemoteRemoveFailure:"remote-remove-failure",RemoteRemoveOffline:"remote-remove-offline",RemoteRemoves:"remote-remove remote-remove-failure remote-remove-offline",LocalGet:"local-get",LocalGetFailure:"local-get-failure",LocalGets:"local-get local-get-failure",RemoteGet:"remote-get",RemoteGetFailure:"remote-get-failure",RemoteGetOffline:"remote-get-offline",RemoteGets:"remote-get remote-get-failure remote-get-offline",RemoteAndRemove:"remote-remove removed",SavedRemoteUpdate:"saved remote-update",Changes:"saved remote-update key-update relation-update removed change"},ke.Status={Synced:0,SavePending:1,RemovePending:2,Removed:3},ke.Blocked={toString:!0,valueOf:!0},ke.prototype={$init:function(e,t){if(this.$status=ke.Status.Synced,this.$operation=null,this.$relations={},this.$dependents={},t){var i=this.$db.getKey(e);this.$db.all[i]=this,this.$set(e,void 0,t)}else this.$reset(e);if(this.$db.loadRelations){var n=this.$db.relations;for(var s in n){var r=n[s];r.lazy||this.$getRelation(s,void 0,t)}}},$load:function(e){if(l(e))for(var t=0;t<e.length;t++)this.$getRelation(e[t]);else if(r(e))this.$getRelation(e);else{var i=this.$db.relations;for(var n in i)this.$getRelation(n)}},$reset:function(e){var i=this.$db.defaults,n=this.$db.fields,s=this.$db.relations,a=this.$db.key;if(d(i)){for(var o=0;o<n.length;o++){var u=n[o],h=i[u],l=C(h);this[u]=l}for(var u in s)if(u in i){var h=i[u],l=C(h),c=this.$getRelation(u);c.set(this,l)}}else for(var o=0;o<n.length;o++){var u=n[o];this[u]=t}var f=!1;if(e&&(f=this.$db.getKey(e,!0)),f===!1)f=this.$db.getKey(this,!0);else if(r(a))this[a]=f;else for(var o=0;o<a.length;o++){var v=a[o];this[v]=e[v]}f!==!1&&(this.$db.all[f]=this,this.$$key=f),this.$set(e)},$set:function(e,t,i){if(d(e))for(var n in e)this.$set(n,e[n],i);else if(r(e)){if(ke.Blocked[e])return;var s=this.$getRelation(e,t,i);s?s.set(this,t,i):this[e]=t}f(e)&&this.$trigger(ke.Events.Change,[e,t])},$get:function(e,t){if(l(e))return k(this,e,t);if(d(e)){for(var i in e)e[i]=t?P(this[i]):this[i];return e}if(r(e)){if(ke.Blocked[e])return;var n=this.$getRelation(e);if(n){var s=n.get(this);return t?P(s):s}return t?P(this[e]):this[e]}},$decode:function(){this.$db.decode(this)},$isDependentsSaved:function(e,t){function i(){e.apply(t||this,arguments),a()}var n=this.$dependents;for(var s in n){var r=n[s];if(!r.$isSaved()){var a=r.$once(ke.Events.RemoteSaves,i);return!1}}return!0},$relate:function(e,t){var i=this.$getRelation(e);i&&i.relate(this,t)},$unrelate:function(e,t){var i=this.$getRelation(e);i&&i.unrelate(this,t)},$isRelated:function(e,t){var i=this.$getRelation(e);return i&&i.isRelated(this,t)},$getRelation:function(e,t,i){var n=this.$db.relations,s=n[e];return s?(e in this.$relations||s.load(this,t,i),s):!1},$save:function(e,t,i){var i=3===arguments.length?i:2===arguments.length&&d(e)&&a(t)?t:1===arguments.length&&a(e)?e:le.Cascade.All;return this.$isDeleted()?(le.debug(le.Debugs.SAVE_DELETED,this.$db,this),le.transactNone(i,this,"save")):le.transact(i,this,"save",function(n){this.$db.addReference(this),this.$set(e,t),this.$trigger(ke.Events.PreSave,[this]),this.$db.save(this,i),this.$trigger(ke.Events.PostSave,[this])})},$remove:function(e){var e=a(e)?e:le.Cascade.All;return this.$exists()?le.transact(e,this,"remove",function(t){this.$trigger(ke.Events.PreRemove,[this]),this.$db.remove(this,e),this.$trigger(ke.Events.PostRemove,[this])}):le.transactNone(e,this,"remove")},$refresh:function(e){this.$db.refreshModel(this,e)},$cancel:function(e){this.$saved?this.$save(this.$saved):e&&this.$reset()},$clone:function(e){for(var t=this.$db,i=t.key,n=t.fields,s=t.relations,a={},o=0;o<n.length;o++){var u=n[o];e&&u in e?a[u]=C(e[u]):u in this&&(a[u]=P(this[u]))}r(i)&&delete a[i];var h=t.getKey(a),l=this.$key();if(h===l)throw"A clone cannot have the same key as the original model.";for(var d in s)e&&d in e&&s[d].preClone(this,a,e[d]);var c=t.instantiate(a),f={};for(var d in s)e&&d in e&&s[d].postClone(this,f,e[d]);return c.$set(f),c},$push:function(e){this.$savedState=this.$db.encode(this,k(this,e||this.$db.fields,!0),!1)},$pop:function(e){d(this.$savedState)&&(this.$set(this.$savedState),e||this.$discard())},$discard:function(){delete this.$savedState},$exists:function(){return!this.$isDeleted()&&this.$db.models.has(this.$key())},$addOperation:function(e,t){var i=new e(this,t);this.$operation?this.$operation.queue(i):(this.$operation=i,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(this,k(this,this.$db.fields,!0),e),i=this.$db.relations,n=this.$relations;for(var s in n)i[s].encode(this,t,e);return t},$change:function(){this.$trigger(ke.Events.Change)},$key:function(e){return this.$$key||(this.$$key=this.$db.getKey(this,e)),this.$$key},$keys:function(){return this.$db.getKeys(this)},$uid:function(){return this.$db.name+"$"+this.$key()},$hasKey:function(){return $(this,this.$db.key,f)},$isSynced:function(){return this.$status===ke.Status.Synced},$isPending:function(){return this.$status===ke.Status.SavePending},$isDeleted:function(){return this.$status>=ke.Status.RemovePending},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(e){var t=this.$saved,i=e||this.$toJSON(!0),n=this.$db.saveFields;return t?V(i,t,n,z):i},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$db.ignoredFields,t=this.$toJSON(!0),i=this.$saved;for(var n in t){var s=t[n],r=i[n];if(!e[n]&&!z(s,r))return!0}return!1},toString:function(){return this.$db.className+" "+JSON.stringify(this.$toJSON())}},he(ke.prototype,!0),ue(ke.prototype,"$change",ke.Events.Changes,!0),Ie.prototype={reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,dt.push.call(this.values,t),dt.push.call(this.keys,e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return a(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],i=dt.pop.apply(this.values),n=dt.pop.apply(this.keys);return e<this.values.length&&(this.values[e]=i,this.keys[e]=n,this.indices[n]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},subtract:function(e,t){for(var i=t||new Ie,n=this.size(),s=this.values,r=this.keys,a=0;n>a;a++){var o=s[a],u=r[a];e.has(u)||i.put(u,o)}return i},filter:function(e,t){for(var i=t||new Ie,n=this.size(),s=this.values,r=this.keys,a=0;n>a;a++){var o=s[a],u=r[a];e(o,u)&&i.put(u,o)}return i},reverse:function(){for(var e=this.size()-1,t=Math.ceil(e/2),i=0;t>i;i++)_(this.values,i,e-i),_(this.keys,i,e-i);return this.rebuildIndex(),this},isSorted:function(e){return B(e,this.values)},sort:function(e){function t(t,i){for(var s=n.values[Math.floor((i+t)/2)],r=t,a=i;a>=r;){for(;e(n.values[r],s)<0;)r++;for(;e(n.values[a],s)>0;)a--;a>=r&&(_(n.values,r,a),_(n.keys,r,a),r++,a--)}return r}function i(e,n){var s=t(e,n);s-1>e&&i(e,s-1),n>s&&i(s,n)}var n=this,s=this.size()-1;return s>0&&(i(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}},Fe.prototype={onSuccess:function(){return this.handleCall(this,++this.call,this.success)},onFailure:function(){return this.handleCall(this,this.call,this.failure)},handleCall:function(e,t,i){return function(){e.call===t&&t>e.callCanceled&&n(i)&&i.apply(e.context,arguments)}},cancel:function(){this.callCanceled=this.call}},Ue.Events={Add:"add",Adds:"adds",Sort:"sort",Remove:"remove",Removes:"removes",Updates:"updates",Reset:"reset",Cleared:"cleared",Changes:"add adds sort remove removes updates reset cleared"},b(Array,Ue,{setComparator:function(e,t){return this.comparator=j(e,t),this.sort(),this},addComparator:function(e,t){return this.comparator=J(this.comparator,e,t),this.sort(),this},isSorted:function(e,t){var i=e?j(e,t):this.comparator;return B(i,this)},sort:function(e,t){var i=e?j(e,t):this.comparator;return B(i,this)||(dt.sort.call(this,i),this.trigger(Ue.Events.Sort,[this])),this},reset:function(e){return this.length=0,l(e)?dt.push.apply(this,e):d(models)&&dt.push.call(this,e),this.trigger(Ue.Events.Reset,[this]),this.sort(),this},page:function(e,t){return new He(this,e,t)},filtered:function(e,t,i){var n=ie(e,t,i);return new Pe(this,n)},where:function(e,t,i,n){for(var s=ie(e,t,i),r=n||this.cloneEmpty(),a=0;a<this.length;a++){var o=this[a];s(o)&&r.add(o)}return r},subtract:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||w,r=0;r<this.length;r++){for(var a=this[r],o=!1,u=0;u<e.length&&!o;u++)o=s(a,e[u]);o||n.push(a)}return n},intersect:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||w,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o&&n.push(a)}return n},complement:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||w,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o||n.push(a)}return n},clear:function(){return this.length=0,this.trigger(Ue.Events.Cleared,[this]),this},add:function(e,t){return dt.push.call(this,e),this.trigger(Ue.Events.Add,[this,e]),t||this.sort(),this},push:function(){var e=arguments;return dt.push.apply(this,e),this.trigger(Ue.Events.Adds,[this,e]),this.sort(),this.length},unshift:function(){var e=arguments;return dt.unshift.apply(this,e),this.trigger(Ue.Events.Adds,[this,e]),this.sort(),this.length},addAll:function(e,t){return l(e)&&e.length&&(dt.push.apply(this,e),this.trigger(Ue.Events.Adds,[this,e]),t||this.sort()),this},insertAt:function(e,t,i){return dt.splice.call(this,e,0,t),this.trigger(Ue.Events.Add,[this,t]),i||this.sort(),this},pop:function(e){var t=dt.pop.apply(this),i=this.length;return this.trigger(Ue.Events.Remove,[this,t,i]),e||this.sort(),t},shift:function(e){var t=dt.shift.apply(this);return this.trigger(Ue.Events.Remove,[this,t,0]),e||this.sort(),t},removeAt:function(e,t){var i;return e>=0&&e<this.length&&(i=this[e],dt.splice.call(this,e,1),this.trigger(Ue.Events.Remove,[this,i,e]),t||this.sort()),i},remove:function(e,t,i){var n=this.indexOf(e,i),s=this[n];return-1!==n&&this.removeAt(n,t),s},removeAll:function(e,t,i){var n=[];if(l(e)&&e.length){for(var s=0;s<e.length;s++){var r=e[s],a=this.indexOf(r,i);-1!==a&&(dt.splice.call(this,a,1),n.push(r))}this.trigger(Ue.Events.Removes,[this,n]),t||this.sort()}return n},removeWhere:function(e,t,i,n,s){for(var r=ie(e,t,i),a=n||this.cloneEmpty(),o=this.length-1;o>=0;o--){var u=this[o];r(u)&&(dt.splice.call(this,o,1),a.push(u))}return this.trigger(Ue.Events.Removes,[this,a]),s||this.sort(),a},splice:function(e,t){var i=dt.splice.call(arguments,0,2),n=dt.splice.apply(this,arguments);return t&&this.trigger(Ue.Events.Removes,[this,n]),i.length&&this.trigger(Ue.Events.Adds,[this,i]),this.sort(),n},reverse:function(){if(dt.reverse)dt.reverse.apply(this);else for(var e=this.length,t=Math.floor(e/2),i=0;t>i;i++){var n=e-i-1,s=this[i];this[i]=this[n],this[n]=s}return this.trigger(Ue.Events.Updates,[this]),this},indexOf:function(e,t){for(var i=t||w,n=0;n<this.length;n++)if(i(e,this[n]))return n;return-1},minModel:function(e,t){for(var i=j(e||this.comparator,!1),n=t,s=0;s<this.length;s++)i(n,this[s])>0&&(n=this[s]);return n},maxModel:function(e,t){for(var i=j(e||this.comparator,!0),n=t,s=0;s<this.length;s++)i(n,this[s])<0&&(n=this[s]);return n},min:function(e,t,i){for(var n=ee(e,t),s=i,r=0;r<this.length;r++){var a=n(this[r]);Q(s,a,!1)>0&&(s=a)}return s},max:function(e,t,i){for(var n=ee(e,t),s=i,r=0;r<this.length;r++){var a=n(this[r]);Q(s,a,!0)<0&&(s=a)}return s},firstWhere:function(e,t,i){for(var n=ie(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return r}return null},first:function(e,t){for(var i=ee(e,t),n=0;n<this.length;n++){var s=i(this[n]);if(f(s))return s}},lastWhere:function(e,t,i){for(var n=ie(e,t,i),s=this.length-1;s>=0;s--){var r=this[s];if(n(r))return r}return null},last:function(e,t){for(var i=ee(e,t),n=this.length-1;n>=0;n--){var s=i(this[n]);if(f(s))return s}},aggregate:function(e,t,i,n){for(var s=0;s<this.length;s++){var r=e(this[s]);t(r)&&i(r)}return n()},sum:function(e){function t(e){s+=e}function i(){return s}var n=X(e),s=0;return this.aggregate(n,a,t,i)},avg:function(e){function t(e){s+=e,r++}function i(){return 0===r?0:s/r}var n=X(e),s=0,r=0;return this.aggregate(n,a,t,i)},countWhere:function(e,t,i){for(var n=ie(e,t,i),s=0,r=0;r<this.length;r++){var a=this[r];n(a)&&s++}return s},count:function(e){if(!f(e))return this.length;for(var t=ee(e),i=0,n=0;n<this.length;n++){var s=t(this[n]);f(s)&&i++}return i},pluck:function(e,t,i,n){var s=ee(e,i);if(t){for(var r=ee(t,n),a={},o=0;o<this.length;o++){var u=this[o],h=s(u),l=r(u);a[l]=h}return a}for(var a=[],o=0;o<this.length;o++){var u=this[o],h=s(u);a.push(h)}return a},each:function(e,t){for(var i=0;i<this.length;i++){var n=this[i];e.call(t,n,i),this[i]!==n&&i--}return this},reduce:function(e,t){for(var i=0;i<this.length;i++)t=e(t,this[i]);return t},random:function(){var e=Math.floor(Math.random()*this.length);return this[e]},chunk:function(e,t){for(var i=t||[],n=0,s=i[n]=i[n]||[],r=0,a=0;a<this.length;a++)s[r]=this[a],++r>=e&&(r=0,n++,s.length=e,s=i[n]=i[n]||[]);return 0!==r&&n++,s.length=r,i.length=n,i},contains:function(e,t,i){for(var n=ie(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return!0}return!1},group:function(e){var t=ee(e.by,e.bySeparator||"/"),i=se(e.having),s=e.select||{},a={};if(r(e.by))e.by in s||(s[e.by]="first");else if(l(e.by))for(var o in e.by)o in s||(s[o]="first");for(var u=0;u<this.length;u++){var h=this[u],d=t(h),c=a[d];c||(c=a[d]=this.cloneEmpty()),c.add(h,!0)}var f=this.cloneEmpty();f.setComparator(e.comparator,e.comparatorNullsFirst);for(var d in a){var v={},g=a[d];for(var p in s){var m=s[p];r(m)?v[p]=g[m](p):n(m)&&(v[p]=m(g,p))}e.track!==!1&&(v.$group=g),e.count!==!1&&(v.$count=g.length),i(v,g)&&f.push(v)}return f.sort(),f},toArray:function(){return this.slice()},clone:function(){return new this.constructor(this)},cloneEmpty:function(){return new this.constructor}}),he(Ue.prototype),ue(Ue.prototype,"change",Ue.Events.Changes);var ft={bind:function(){this.onAdd=p(this,ft.handleAdd),this.onAdds=p(this,ft.handleAdds),this.onRemove=p(this,ft.handleRemove),this.onRemoves=p(this,ft.handleRemoves),this.onReset=p(this,ft.handleReset),this.onUpdates=p(this,ft.handleUpdates),this.onCleared=p(this,ft.handleCleared)},init:function(e,t){return this.base!==e&&(this.base&&this.disconnect(),this.base=e,this.connect()),this.filter=t,this.sync(),this},setFilter:function(e,t,i){return this.filter=ie(e,t,i),this.sync(),this},connect:function(){return this.base.on(Ue.Events.Add,this.onAdd),this.base.on(Ue.Events.Adds,this.onAdds),this.base.on(Ue.Events.Remove,this.onRemove),this.base.on(Ue.Events.Removes,this.onRemoves),this.base.on(Ue.Events.Reset,this.onReset),this.base.on(Ue.Events.Updates,this.onUpdates),this.base.on(Ue.Events.Cleared,this.onClear),this},disconnect:function(){return this.base.off(Ue.Events.Add,this.onAdd),this.base.off(Ue.Events.Adds,this.onAdds),this.base.off(Ue.Events.Remove,this.onRemove),this.base.off(Ue.Events.Removes,this.onRemoves),this.base.off(Ue.Events.Reset,this.onReset),this.base.off(Ue.Events.Updates,this.onUpdates),this.base.off(Ue.Events.Cleared,this.onClear),this},sync:function(){for(var e=this.base,t=this.filter,i=[],n=0;n<e.length;n++){var s=e[n];t(s)&&i.push(s)}return this.reset(i)},handleAdd:function(e,t){var i=this.filter;i(t)&&this.add(t)},handleAdds:function(e,t){for(var i=this.filter,n=[],s=0;s<t.length;s++){var r=t[s];i(r)&&n.push(r)}this.addAll(n)},handleRemove:function(e,t){this.remove(t)},handleRemoves:function(e,t){this.removeAll(t)},handleReset:function(e){this.sync()},handleUpdates:function(e,t){for(var i=this.filter,n=0;n<t.length;n++){var s=t[n];i(s)?this.add(s,!0):this.remove(s,!0)}this.sort()},handleCleared:function(e){this.clear()},clone:function(){return new this.constructor(this.base,this.filter)},cloneEmpty:function(){return new this.constructor(this.base,this.filter)}};He.Events={Change:"change",Changes:"change"},b(Array,He,{setPageSize:function(e){this.pageSize=e,this.handleChanges()},setPageIndex:function(e){this["goto"](e)},setCollection:function(e){e!==this.collection&&(this.collection&&this.disconnect(),this.collection=e,this.connect(),this.handleChanges(!0))},connect:function(){this.collection.on(Ue.Events.Changes,this.onChanges)},disconnect:function(){this.collection.off(Ue.Events.Changes,this.onChanges)},"goto":function(e){var t=Math.max(0,Math.min(e,this.pageCount-1));t!==this.pageIndex&&(this.pageIndex=t,this.update(),this.trigger(He.Events.Change,[this]))},next:function(){this["goto"](this.pageIndex+1)},prev:function(){this["goto"](this.pageIndex-1)},jump:function(e){this["goto"](e)},first:function(){this["goto"](0)},last:function(){this["goto"](this.pageCount-1)},handleChanges:function(e){var t=this.collection.length,i=Math.ceil(t/this.pageSize),n=Math.max(0,Math.min(this.pageIndex,i-1)),s=e||this.pageIndex!==n||this.length!==this.pageSize,r=s||this.pageCount!==i;this.pageIndex=n,this.pageCount=i,s&&this.update(),r&&this.trigger(He.Events.Change,[this])},update:function(){var e=this.collection,t=e.length,i=this.pageIndex*this.pageSize,n=Math.min(i+this.pageSize,t),s=n-i;this.length=s;for(var r=0;s>r;r++)this[r]=e[i++]},toArray:function(){return this.slice()}}),he(He.prototype),ue(He.prototype,"change",He.Events.Changes),b(Ue,Pe,{bind:ft.bind,init:ft.init,setFilter:ft.setFilter,connect:ft.connect,disconnect:ft.disconnect,sync:ft.sync,clone:ft.clone,cloneEmpty:ft.cloneEmpty}),b(Ue,Ve,{init:function(e,t,i){return this.map=new Ie,this.map.values=this,this.database=e,this.reset(t,i),this},sort:function(e,t){var i=e?j(e,t):this.comparator;return B(i,this)||(this.map.sort(i),this.trigger(Ue.Events.Sort,[this])),this},buildKeyFromInput:function(e){return this.database.buildKeyFromInput(e)},parseModel:function(e,t){return this.database.parseModel(e,t)},filtered:function(e,t,i){var n=ie(e,t,i);return new xe(this,n)},subtract:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<this.length;n++){var s=this[n],r=s.$key(),a=!1;if(e instanceof Ve)a=e.has(r);else for(var n=0;n<e.length&&!a;n++){var o=this.buildKeyFromInput(e[n]);a=r===o}a||i.push(s)}return i},intersect:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<e.length;n++){var s=e[n],r=this.buildKeyFromInput(s);this.has(r)&&i.push(s)}return i},complement:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<e.length;n++){var s=e[n],r=this.buildKeyFromInput(s);this.has(r)||i.push(s)}return i},clear:function(){return this.map.reset()},reset:function(e,t){var i=this.map;if(i.reset(),l(e))for(var n=0;n<e.length;n++){var s=e[n],r=this.parseModel(s,t);r&&i.put(r.$key(),r)}else if(d(e)){var r=this.parseModel(e,t);r&&i.put(r.$key(),r)}this.trigger(Ue.Events.Reset,[this]),this.sort()},has:function(e){return this.map.has(e)},get:function(e){return this.map.get(e)},put:function(e,t,i){this.map.put(e,t),this.trigger(Ue.Events.Add,[this,t]),i||this.sort()},add:function(e,t){var i=this.parseModel(e);return this.map.put(i.$key(),i),this.trigger(Ue.Events.Add,[this,i]),t||this.sort(),this},push:function(){for(var e=arguments,t=0;t<e.length;t++){var i=this.parseModel(e[t]);this.map.put(i.$key(),i)}return this.trigger(Ue.Events.Adds,[this,e]),this.sort(),this.length},unshift:function(){return this.push.apply(this,arguments)},addAll:function(e,t){if(l(e)){for(var i=0;i<e.length;i++){var n=this.parseModel(e[i]);this.map.put(n.$key(),n)}this.trigger(Ue.Events.Adds,[this,e]),t||this.sort()}},insertAt:function(e,t,i){return this.add(t,i)},pop:function(e){var t=this.length-1,i=this[t];return this.map.removeAt(t),this.trigger(Ue.Events.Remove,[this,i,t]),e||this.sort(),i},shift:function(e){var t=this[0];return this.map.removeAt(0),this.trigger(Ue.Events.Remove,[this,t,0]),e||this.sort(),t},removeAt:function(e,t){var i;return e>=0&&e<this.length&&(i=this[e],this.map.removeAt(e),this.trigger(Ue.Events.Remove,[this,i,e]),t||this.sort()),i},remove:function(e,t){var i=this.buildKeyFromInput(e),n=this.map.get(i);n&&(this.map.remove(i),this.trigger(Ue.Events.Remove,[this,n,e]),t||this.sort())},removeAll:function(e,t){for(var i=this.map,n=[],s=0;s<e.length;s++){var r=this.buildKeyFromInput(e[s]),a=i.get(r);a&&(i.remove(r),n.push(a))}return this.trigger(Ue.Events.Removes,[this,n]),t||this.sort(),n},indexOf:function(e){var i=this.buildKeyFromInput(e),n=this.map.indices[i];return n===t?-1:n},rebuild:function(){this.map.rebuildIndex()},keys:function(){return this.map.keys},reverse:function(){return this.map.reverse(),this.trigger(Ue.Events.Updates,[this]),this},removeWhere:function(e,t,i,n){for(var s=ie(t,i,n),r=[],a=0;a<this.length;a++){var o=this[a],u=o.$key();s(o)&&(this.map.remove(u),r.push(o),e&&o.$remove())}return this.trigger(Ue.Events.Removes,[this,r]),this.sort(),r},update:function(e,t,i,n){for(var s=0;s<this.length;s++){var r=this[s];r.$set(e,t,i),n||r.$save()}return this.trigger(Ue.Events.Updates,[this,this]),this.sort(),this},updateWhere:function(e,t,i,n,s){for(var r=[],a=0;a<this.length;a++){var o=this[a];e(o)&&(o.$set(t,i,n),autoSave||o.$save(),r.push(o))}return this.trigger(Ue.Events.Updates,[this,r]),this.sort(),r},clone:function(){return new Ve(this.database,this,!0)},cloneEmpty:function(){return new Ve(this.database)}}),b(Ve,xe,{bind:function(){ft.bind.apply(this),this.onModelUpdated=p(this,this.handleModelUpdate)},init:function(e,t){return this.base&&this.base.database.off(be.Events.ModelUpdated,this.onModelUpdated),Ve.prototype.init.call(this,e.database),ft.init.call(this,e,t),e.database.on(be.Events.ModelUpdated,this.onModelUpdated),this},setFilter:ft.setFilter,connect:ft.connect,disconnect:ft.disconnect,sync:ft.sync,handleModelUpdate:function(e){var t=this.has(e.$key()),i=this.filter(e);t&&!i&&this.remove(e),!t&&i&&this.add(e)},clone:ft.clone,cloneEmpty:ft.cloneEmpty}),b(Ve,Ye,{set:function(e){return this.relator.set(this.model,e),this},relate:function(e){return this.relator.relate(this.model,e),this},unrelate:function(e){return this.relator.unrelate(this.model,e),this},isRelated:function(e){return this.relator.isRelated(this.model,e)},clone:function(){return new Ye(this.database,this.model,this.relator,this,!0)},cloneEmpty:function(){return new Ye(this.database,this.model,this.relator)}}),Ke.Events={Ready:"ready",Success:"success",Failure:"failure"},Ke.Status={Pending:"pending",Success:"success",Failure:"failure"},Ke.Defaults={},Ke.prototype={$getDefaults:function(){return Ke.Defaults},$init:function(e,t,i){D(this,i,Ke.Defaults,!0),this.$db=e,this.$url=t,this.$results=new Ve(e),this.$status=Ke.Status.Success,this.$request=new Fe(this,this.$handleSuccess,this.$handleFailure)},$set:function(e){return O(e,this)},$run:function(){var e=this.$encode(),t=this.$request.onSuccess(),i=this.$request.onFailure();return this.$status=Ke.Status.Pending,this.$db.rest.query(this.$url,e,t,i),this},$cancel:function(){return this.$off(Ke.Events.Ready),this.$off(Ke.Events.Success),this.$off(Ke.Events.Failure),this.$request.cancel(),this},$ready:function(e,t){return this.$status===Ke.Status.Pending?this.$once(Ke.Events.Ready,e,t):e.call(t,this),this},$success:function(e,t){return this.$status===Ke.Status.Pending?this.$once(Ke.Events.Success,e,t):this.$status===Ke.Status.Success&&e.call(t,this),this},$failure:function(e,t){return this.$status===Ke.Status.Pending?this.$once(Ke.Events.Failure,e,t):this.$status===Ke.Status.Failure&&e.call(t,this),this},$handleSuccess:function(e){var t=this.$decode.apply(this,arguments);this.$status=Ke.Status.Success,this.$results.reset(t,!0),this.$trigger(Ke.Events.Ready,[this,e]),this.$trigger(Ke.Events.Success,[this,e])},$handleFailure:function(e){this.$status=Ke.Status.Failure,this.$trigger(Ke.Events.Ready,[this,e]),this.$trigger(Ke.Events.Failure,[this,e])},$encode:function(){return H(P(this))},$decode:function(e){return e},$key:function(){return""}},he(Ke.prototype,!0),ze.Defaults={page_size:10,page_index:0,total:0},y(Ke,ze,{$getDefaults:function(){return ze.Defaults},$goto:function(e,t){var i=this.$getPageIndex(),n=this.$getPageCount(),s=Math.max(0,Math.min(e,n-1));return i!==s&&(this.$setPageIndex(s),t||this.$run()),this},$first:function(e){return this.$goto(0,e)},$last:function(e){return this.$goto(this.$getPageCount()-1,e)},$prev:function(e){return this.$goto(this.$getPageIndex()-1,e)},$next:function(e){return this.$goto(this.$getPageIndex()+1,e)},$decode:function(e){return this.$updatePageSize(e),this.$updatePageIndex(e),this.$updateTotal(e),this.$decodeResults(e)},$decodeResults:function(e){return e.results},$updatePageSize:function(e){a(e.page_size)&&(this.page_size=e.page_size)},$setPageSize:function(e){this.page_size=e},$getPageSize:function(){return this.page_size},$updatePageIndex:function(e){a(e.page_index)&&(this.page_index=e.page_index)},$setPageIndex:function(e){this.page_index=e||0},$getPageIndex:function(){return this.page_index},$getPageOffset:function(){return this.page_index*this.page_size},$updateTotal:function(e){a(e.total)&&(this.total=e.total)},$setTotal:function(e){this.total=e||0},$getTotal:function(){return this.total},$getPageCount:function(){return Math.ceil(this.$getTotal()/this.$getPageSize())}}),le.transaction=null,le.transact=function(e,t,i,n){var s=le.transaction;return s?(s.add(e,t,i),n.call(t,s),s):(s=le.transaction=new Ge(e,t,i),s.add(e,t,i),n.call(t,s),le.transaction=null,s)},le.transactNone=function(e,t,i){return new Ge(e,t,i)},Ge.Events={RemoteSuccess:"remote-success",LocalSuccess:"local-success",Offline:"offline",Blocked:"blocked",Error:"error",Any:"remote-success local-success offline blocked error"},Ge.prototype={add:function(e,t,i){var n={already:!1,offs:[]};switch(i){case"save":e&le.Cascade.Rest?n.offs.push(t.$once(ke.Events.RemoteSave,this.createHandler(!1,!1,n),this),t.$once(ke.Events.RemoteSaveFailure,this.createHandler(!0,!1,n),this),t.$once(ke.Events.RemoteSaveOffline,this.createHandler(!1,!0,n),this)):e&le.Cascade.Local&&n.offs.push(t.$once(ke.Events.LocalSave,this.createHandler(!1,!1,n),this),t.$once(ke.Events.LocalSaveFailure,this.createHandler(!0,!1,n),this));break;case"remove":e&le.Cascade.Rest?n.offs.push(t.$once(ke.Events.RemoteRemove,this.createHandler(!1,!1,n),this),t.$once(ke.Events.RemoteRemoveFailure,this.createHandler(!0,!1,n),this),t.$once(ke.Events.RemoteRemoveOffline,this.createHandler(!1,!0,n),this)):e&le.Cascade.Local&&n.offs.push(t.$once(ke.Events.LocalRemove,this.createHandler(!1,!1,n),this),t.$once(ke.Events.LocalRemoveFailure,this.createHandler(!0,!1,n),this))}n.offs.length&&this.operations++},createHandler:function(e,t,i){return function(){if(!i.already){i.already=!0;for(var n=0;n<i.offs.length;n++)i.offs[n]();t?this.status=Ge.Events.Offline:!this.status&&e&&(this.status=Ge.Events.Error),this.completed++,this.isFinished()&&this.finish()}}},finish:function(){this.completed=this.operations,this.status||(this.cascade&le.Cascade.Rest?this.status=Ge.Events.RemoteSuccess:this.cascade&le.Cascade.Local?this.status=Ge.Events.LocalSuccess:this.status=Ge.Events.Error),this.trigger(this.status,[this.status,this.model,this.cascade])},isFinished:function(){return this.completed===this.operations},then:function(e,t){var i=this.once(Ge.Events.Any,e,t);return this.isFinished()&&this.finish(),i}},he(Ge.prototype),Qe.prototype={reset:function(e,t){this.model=e,this.cascade=a(t)?t:le.Cascade.All,this.db=e.$db,this.next=null,this.finished=!1},canCascade:function(e){var t=e||this.cascading,i=this.cascade;return 0!==(t&i)},notCascade:function(e){var t=this.cascade;return 0===(e&t)},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):this.next=e},tryNext:function(e){var t=!this.next;return t&&(this.next=new e(this.model,this.cascade)),t},insertNext:function(e){var t=new e(this.model,this.cascade);t.next=this.next,this.next=t},execute:function(){this.db.pendingOperations++,this.run(this.db,this.model)},run:function(e,t){throw"Operation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)&&this.next.execute(),this.db.pendingOperations--,0===this.db.pendingOperations&&this.db.onOperationRest()),this},success:function(){return p(this,this.handleSuccess)},handleSuccess:function(){this.onSuccess.apply(this,arguments),this.finish()},onSuccess:function(){},failure:function(){return p(this,this.handleFailure)},handleFailure:function(){this.onFailure.apply(this,arguments),this.finish()},onFailure:function(){}},y(Qe,Be,{cascading:le.Cascade.Local,interrupts:!1,type:"GetLocal",run:function(e,t){t.$isDeleted()?(t.$trigger(ke.Events.LocalGetFailure,[t]),this.finish()):this.canCascade()&&e.cache===le.Cache.All?e.store.get(t.$key(),this.success(),this.failure()):(le.debug(le.Debugs.GET_LOCAL_SKIPPED,t),t.$trigger(ke.Events.LocalGet,[t]),this.insertNext(qe),this.finish())},onSuccess:function(e,t){var i=this.model;d(t)&&i.$set(t),le.debug(le.Debugs.GET_LOCAL,i,t),i.$trigger(ke.Events.LocalGet,[i]),this.canCascade(le.Cascade.Rest)&&!i.$isDeleted()&&this.insertNext(qe)},onFailure:function(e){var t=this.model;le.debug(le.Debugs.GET_LOCAL,t,e),t.$trigger(ke.Events.LocalGetFailure,[t]),this.canCascade(le.Cascade.Rest)&&!t.$isDeleted()&&this.insertNext(qe)}}),y(Qe,qe,{cascading:le.Cascade.Rest,interrupts:!1,type:"GetRemote",run:function(e,t){t.$isDeleted()?(t.$trigger(ke.Events.RemoteGetFailure,[t]),this.finish()):this.canCascade()?e.rest.get(t,this.success(),this.failure()):(t.$trigger(ke.Events.RemoteGet,[t]),this.finish())},onSuccess:function(e){var t=this.db,i=t.resolveModel(e),n=this.model;d(i)&&t.putRemoteData(i,n.$key(),n,!0),le.debug(le.Debugs.GET_REMOTE,n,i),n.$trigger(ke.Events.RemoteGet,[n]);
},onFailure:function(e,t){var i=this.model;le.debug(le.Debugs.GET_REMOTE_ERROR,i,e,t),0===t?i.$trigger(ke.Events.RemoteGetOffline,[i,e]):i.$trigger(ke.Events.RemoteGetFailure,[i,e])}}),y(Qe,Je,{cascading:le.Cascade.None,interrupts:!0,type:"RemoveCache",run:function(e,t){e.cache==le.Cache.None?this.finish():e.store.remove(t.$key(),this.success(),this.failure())}}),y(Qe,je,{cascading:le.Cascade.Local,interrupts:!0,type:"RemoveLocal",run:function(e,t){t.$status=ke.Status.RemovePending,e.cache!==le.Cache.None&&t.$local&&this.canCascade()?t.$saved?(t.$local.$status=t.$status,e.store.put(t.$key(),t.$local,this.success(),this.failure())):(le.debug(le.Debugs.REMOVE_LOCAL_UNSAVED,t),e.store.remove(t.$key(),this.success(),this.failure())):(le.debug(le.Debugs.REMOVE_LOCAL_NONE,t),t.$trigger(ke.Events.LocalRemove,[t]),this.insertNext(Xe),this.finish())},onSuccess:function(e,t,i){var n=this.model;le.debug(le.Debugs.REMOVE_LOCAL,n),n.$trigger(ke.Events.LocalRemove,[n]),n.$saved&&this.canCascade(le.Cascade.Remote)&&n.$addOperation(Xe,this.cascade)},onFailure:function(e){var t=this.model;le.debug(le.Debugs.REMOVE_LOCAL_ERROR,t,e),t.$trigger(ke.Events.LocalRemoveFailure,[t]),t.$saved&&this.canCascade(le.Cascade.Remote)&&t.$addOperation(Xe,this.cascade)}}),y(Qe,We,{cascading:le.Cascade.Local,interrupts:!0,type:"RemoveNow",run:function(e,t){var i=t.$key();t.$status=ke.Status.RemovePending,e.removeFromModels(t),e.cache!==le.Cache.None&&this.canCascade()?e.store.remove(i,this.success(),this.failure()):(this.finishRemove(),this.finish())},onSuccess:function(){this.finishRemove()},onFailure:function(){this.finishRemove()},finishRemove:function(){var e=this.model;e.$status=ke.Status.Removed,delete e.$local,delete e.$saving,delete e.$publish,delete e.$saved}}),y(Qe,Xe,{cascading:le.Cascade.Remote,interrupts:!0,type:"RemoveRemote",run:function(e,t){this.notCascade(le.Cascade.Rest)?(this.liveRemove(),t.$trigger(ke.Events.RemoteRemove,[t]),this.finish()):(t.$status=ke.Status.RemovePending,e.rest.remove(t,this.success(),this.failure()))},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var i=this.model,n=i.$key();404===t||410===t?(le.debug(le.Debugs.REMOVE_MISSING,i,n),this.finishRemove()):0!==t?(le.debug(le.Debugs.REMOVE_ERROR,i,t,n,e),i.$trigger(ke.Events.RemoteRemoveFailure,[i,e])):(le.checkNetworkStatus(),le.online?i.$trigger(ke.Events.RemoteRemoveFailure,[i,e]):(le.once(le.Events.Online,this.handleOnline,this),i.$trigger(ke.Events.RemoteRemoveOffline,[i,e])),le.debug(le.Debugs.REMOVE_OFFLINE,i,e))},finishRemove:function(){var e=this.db,t=this.model,i=t.$key();le.debug(le.Debugs.REMOVE_REMOTE,t,i),t.$status=ke.Status.Removed,t.$trigger(ke.Events.RemoteRemove,[t]),this.insertNext(We),this.liveRemove(),delete e.all[i]},liveRemove:function(){if(this.canCascade(le.Cascade.Live)){var e=this.db,t=this.model,i=t.$key();le.debug(le.Debugs.REMOVE_PUBLISH,t,i),e.live.remove(t)}},handleOnline:function(){var e=this.model;le.debug(le.Debugs.REMOVE_RESUME,e),e.$addOperation(Xe)}}),y(Qe,Ze,{cascading:le.Cascade.Local,interrupts:!1,type:"SaveLocal",run:function(e,t){if(t.$isDeleted())le.debug(le.Debugs.SAVE_LOCAL_DELETED,t),t.$trigger(ke.Events.LocalSaveFailure,[t]),this.finish();else if(e.cache!==le.Cache.None&&this.canCascade()){var i=t.$key(),n=t.$toJSON(!1);this.markSaving(e,t),t.$local?O(n,t.$local):(t.$local=n,t.$saved&&(t.$local.$saved=t.$saved)),t.$local.$status=t.$status,t.$local.$saving=t.$saving,t.$local.$publish=t.$publish,e.store.put(i,t.$local,this.success(),this.failure())}else this.canCascade(le.Cascade.Remote)&&this.tryNext(tt)&&this.markSaving(e,t),t.$trigger(ke.Events.LocalSave,[t]),this.finish()},markSaving:function(e,t){var i=t.$toJSON(!0),n=t.$getChanges(i),s=e.fullSave?i:n,r=e.fullPublish?i:n;t.$status=ke.Status.SavePending,t.$saving=s,t.$publish=r},clearLocal:function(e){e.$status=ke.Status.Synced,e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish,this.insertNext(et)},onSuccess:function(e,t,i){var n=this.model;le.debug(le.Debugs.SAVE_LOCAL,n),this.cascade?this.tryNext(tt):this.clearLocal(n),n.$trigger(ke.Events.LocalSave,[n])},onFailure:function(e){var t=this.model;le.debug(le.Debugs.SAVE_LOCAL_ERROR,t,e),this.cascade?this.tryNext(tt):this.clearLocal(t),t.$trigger(ke.Events.LocalSaveFailure,[t])}}),y(Qe,et,{cascading:le.Cascade.Local,interrupts:!1,type:"SaveNow",run:function(e,t){var i=t.$key(),n=t.$local;e.cache===le.Cache.All&&i&&n&&this.canCascade()?e.store.put(i,n,this.success(),this.failure()):this.finish()}}),y(Qe,tt,{cascading:le.Cascade.Remote,interrupts:!1,type:"SaveRemote",run:function(e,t){t.$isDeleted()?(le.debug(le.Debugs.SAVE_REMOTE_DELETED,t),this.markSynced(t,!0,ke.Events.RemoteSaveFailure,null),this.finish()):t.$isDependentsSaved(this.tryAgain,this)?!e.hasData(t.$saving)||this.notCascade(le.Cascade.Rest)?(this.liveSave(),this.markSynced(t,!0,ke.Events.RemoteSave,null),this.finish()):(t.$status=ke.Status.SavePending,t.$saved?e.rest.update(t,t.$saving,this.success(),this.failure()):e.rest.create(t,t.$saving,this.success(),this.failure())):this.finish()},onSuccess:function(e){var t=this.db,i=t.resolveModel(e),n=this.model;le.debug(le.Debugs.SAVE_REMOTE,n),this.handleData(i)},onFailure:function(e,t){var i=this.db,n=i.resolveModel(e),s=this.model;409===t?(le.debug(le.Debugs.SAVE_CONFLICT,s,n),this.handleData(n)):410===t||404===t?(le.debug(le.Debugs.SAVE_UPDATE_FAIL,s),this.insertNext(We),s.$trigger(ke.Events.RemoteSaveFailure,[s,e])):0!==t?(le.debug(le.Debugs.SAVE_ERROR,s,t),this.markSynced(s,!0,ke.Events.RemoteSaveFailure,e)):(le.checkNetworkStatus(),le.online?this.markSynced(s,!0,ke.Events.RemoteSaveFailure,e):(le.once(le.Events.Online,this.handleOnline,this),s.$trigger(ke.Events.RemoteSaveOffline,[s,e])),le.debug(le.Debugs.SAVE_OFFLINE,s,e))},markSynced:function(e,t,i,n){e.$status=ke.Status.Synced,this.clearPending(e),t&&this.insertNext(et),i&&e.$trigger(i,[e,n])},clearPending:function(e){delete e.$saving,delete e.$publish,e.$local&&(e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish)},handleData:function(e){var t=this.db,i=this.model,n=i.$saving;return i.$isDeleted()?(le.debug(le.Debugs.SAVE_REMOTE_DELETED,i,e),this.clearPending(i)):(le.debug(le.Debugs.SAVE_VALUES,i,n),i.$saved||(i.$saved=i.$local?i.$local.$saved={}:{}),O(n,i.$saved),Y(e)||t.putRemoteData(e,i.$key(),i),this.liveSave(),this.markSynced(i,!1,ke.Events.RemoteSave,null),void(t.cache===le.Cache.Pending?this.insertNext(Je):this.insertNext(et)))},liveSave:function(){var e=this.db,t=this.model;this.canCascade(le.Cascade.Live)&&e.hasData(t.$publish)&&(le.debug(le.Debugs.SAVE_PUBLISH,t,t.$publish),e.live.save(t,t.$publish))},handleOnline:function(){var e=this.model;e.$status===ke.Status.SavePending&&(e.$addOperation(tt,this.cascade),le.debug(le.Debugs.SAVE_RESUME,e))},tryAgain:function(){var e=this.model;e.$addOperation(tt,this.cascade)}}),le.Relations={},it.Defaults={model:null,lazy:!1,store:le.Store.None,save:le.Save.None,auto:!0,property:!0,preserve:!0,dynamic:!1,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},it.prototype={debugQuery:null,debugQueryResults:null,getDefaults:function(e,t,i){return it.Defaults},init:function(e,t,i){D(this,i,this.getDefaults(e,t,i)),this.database=e,this.name=t,this.options=i,this.initialized=!1,this.property=this.property||v(e.fields,this.name)!==!1,this.discriminated=!Y(this.discriminators),this.discriminated&&O(vt,this),this.setReferences(e,t,i)},setReferences:function(e,t,i){s(this.model)?this.onInitialized(e,t,i):le.get(this.model,this.setModelReference(e,t,i),this)},setModelReference:function(e,t,i){return function(n){this.model=n,this.onInitialized(e,t,i)}},onInitialized:function(e,t,i){},finishInitialization:function(){this.initialized=!0,this.load.open()},load:Ae(function(e,t,i){}),set:function(e,t,i){},relate:function(e,t,i){},unrelate:function(e,t){},isRelated:function(e,t){},preClone:function(e,t,i){},postClone:function(e,t,i){},get:function(e){return e.$relations[this.name].related},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;if(n&&s){var r=n.related;l(r)?t[this.name]=this.getStoredArray(r,s):t[this.name]=this.getStored(r,s)}},ready:function(e){this.model.Database.ready(e,this)},listenToModelAdded:function(e){this.model.Database.on(be.Events.ModelAdded,e,this)},executeQuery:function(e){var t=this.query,i=this.queryOptions,n=this.queryData,s=r(t)?ae(t,e):t,a=this.model.search(s,i);return d(n)&&O(n,a),le.debug(this.debugQuery,this,e,a,t,s,n),a.$run(),a.$ready(this.handleExecuteQuery(e),this),a},handleExecuteQuery:function(e){return function(t){var i=t.$results;le.debug(this.debugQueryResults,this,e,t);for(var n=0;n<i.length;n++)this.relate(e,i[n],!0)}},createRelationCollection:function(e){return new Ye(this.model.Database,e,this)},createCollection:function(){return new Ve(this.model.Database)},parseModel:function(e,t){return this.model.Database.parseModel(e,t)},grabInitial:function(e,t){return $(e,t,f)?I(e,t):void 0},grabModel:function(e,t,i){this.model.Database.grabModel(e,t,this,i)},grabModels:function(e,t,i,n){for(var s=this.model.Database,r=0;r<t.length;r++){var a=t[r],o=s.buildKeyFromInput(a);e.pending[o]=!0,s.grabModel(a,i,this,n)}},setProperty:function(e){if(this.property){var t=e.parent,i=this.name,n=!!e.dynamicSet;if(!n&&this.dynamic&&Object.defineProperty){var s=this;Object.defineProperty(t,i,{enumerable:!0,set:function(e){s.set(t,e)},get:function(){return e.related}}),n=e.dynamicSet=!0}n||(t[i]=e.related),e.lastRelated!==e.related&&(e.lastRelated=e.related,t.$trigger(ke.Events.RelationUpdate,[this,e]))}},isModelArray:function(e){if(!l(e))return!1;var t=this.model.Database,i=t.key;if(!l(i))return!0;if(i.length!==e.length)return!0;for(var n=0;n<e.length;n++)if(!a(e[n])&&!r(e[n]))return!0;return!1},clearFields:function(e,t,i,n){var s=this.clearFieldsReturnChanges(e,t);return s&&!i&&this.auto&&!e.$isNew()&&e.$save(n),s},clearFieldsReturnChanges:function(e,t){var i=!1;if(r(t))e[t]&&(e[t]=null,i=!0);else for(var n=0;n<t.length;n++){var s=t[n];e[s]&&(e[s]=null,i=!0)}return i},updateFields:function(e,t,i,n,s){var r=this.updateFieldsReturnChanges(e,t,i,n);return r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(ke.Events.KeyUpdate,[e,i,t,n])),r},updateFieldsReturnChanges:function(e,t,i,n){var s=!1;if(r(t)){var a=e[t],o=i[n];z(a,o)||(e[t]=o,s=!0)}else for(var u=0;u<t.length;u++){var h=t[u],a=e[h],l=n[u],o=i[l];z(a,o)||(e[h]=P(o),s=!0)}return s},getStoredArray:function(e,t){if(!t)return null;for(var i=[],n=0;n<e.length;n++){var s=this.getStored(e[n],t);null!==s&&i.push(s)}return i},getStored:function(e,t){if(e)switch(t){case le.Save.Model:return e.$toJSON(!0);case le.Store.Model:if(e.$local)return e.$local;var i=e.$toJSON(!1);return e.$saved&&(i.$saved=e.$saved),i;case le.Save.Key:case le.Store.Key:return e.$key();case le.Save.Keys:case le.Store.Keys:return e.$keys()}return null}},y(it,nt,{debugInit:null,debugClearModel:null,debugSetModel:null,debugLoaded:null,debugClearKey:null,debugUpdateKey:null,onInitialized:function(e,t,i){if(!this.discriminated){var n=this.model.Database;this.local=this.local||n.name+"_"+n.key}le.debug(this.debugInit,this),this.finishInitialization()},set:function(e,i,n){if(Y(i))this.unrelate(e,t,n);else{var s=e.$relations[this.name],r=this.parseModel(i,n);r&&!s.isRelated(r)&&(this.clearModel(s),this.setRelated(s,r,n))}},relate:function(e,t,i){var n=e.$relations[this.name],s=this.parseModel(t,i);s&&n.related!==s&&(this.clearModel(n),this.setRelated(n,s,i))},unrelate:function(e,t,i){var n=e.$relations[this.name],s=this.parseModel(t);s&&n.related!==s||this.clearRelated(n,i)},isRelated:function(e,t){var i=e.$relations[this.name],n=this.parseModel(t);return n===i.related},setRelated:function(e,t,i){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t,i),this.setProperty(e))},clearRelated:function(e,t){if(t){var i=e.related;if(i&&i.$isPending())return}this.clearModel(e),this.clearForeignKey(e.parent),this.setProperty(e)},clearModel:function(e){var t=e.related;t&&(le.debug(this.debugClearModel,this,e),e.onSaved&&t.$off(ke.Events.Saved,e.onSaved),e.onRemoved&&t.$off(ke.Events.Removed,e.onRemoved),e.related=null,e.dirty=!0,e.loaded=!0,delete e.parent.$dependents[t.$uid()])},setModel:function(e,t){e.onSaved&&t.$on(ke.Events.Saved,e.onSaved,this),e.onRemoved&&t.$on(ke.Events.Removed,e.onRemoved,this),e.related=t,e.dirty=!0,e.loaded=!0,e.parent.$dependents[t.$uid()]=t,le.debug(this.debugSetModel,this,e)},handleModel:function(e,t){return function(i){var n=e.parent;le.debug(this.debugLoaded,this,n,e,i),e.loaded===!1&&(i&&!i.$isDeleted()?(this.setModel(e,i,t),this.updateForeignKey(n,i,t)):this.query?e.query=this.executeQuery(n):this.preserve||this.clearForeignKey(n,t),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.local;return function(i){return R(e,t,i,i.$db.key)}},clearForeignKey:function(e,t){var i=this.local;le.debug(this.debugClearKey,this,e,i),this.clearFields(e,i,t)},updateForeignKey:function(e,t,i){var n=this.local,s=t.$db.key;le.debug(this.debugUpdateKey,this,e,n,t,s),this.updateFields(e,n,t,s,i)}}),y(it,st,{debugAutoSave:null,debugInitialGrabbed:null,debugSort:null,handleExecuteQuery:function(e){return function(t){var i=e.$relations[this.name],n=t.$results;le.debug(this.debugQueryResults,this,e,t),this.bulk(i,function(){for(var e=0;e<n.length;e++)this.addModel(i,n[e],!0)}),this.sort(i),this.checkSave(i,!0)}},bulk:function(e,t,i){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,i)},set:function(e,i,n){if(Y(i))this.unrelate(e,t,n);else{var s=e.$relations[this.name],r=s.related,a=this.createCollection();if(this.isModelArray(i))for(var o=0;o<i.length;o++){var u=this.parseModel(i[o],n);u&&a.add(u)}else{var u=this.parseModel(i,n);u&&a.add(u)}var h=r.subtract(a),l=a.subtract(r);this.bulk(s,function(){for(var e=0;e<l.length;e++)this.addModel(s,l[e],n);for(var e=0;e<h.length;e++)this.removeModel(s,h[e],n)},n)}},relate:function(e,t,i){var n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e],i);s&&this.addModel(n,s,i)}});else if(f(t)){var s=this.parseModel(t,i);s&&this.addModel(n,s,i)}},unrelate:function(e,t,i){var n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e]);s&&this.removeModel(n,s,i)}});else if(f(t)){var s=this.parseModel(t);s&&this.removeModel(n,s,i)}else{var r=n.related;this.bulk(n,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(n,r[e],i)})}},isRelated:function(e,t){var i=e.$relations[this.name],n=i.related;if(this.isModelArray(t)){for(var s=0;s<t.length;s++){var r=this.parseModel(t[s]);if(r&&!n.has(r.$key()))return!1}return t.length>0}if(f(t)){var r=this.parseModel(t);return r&&n.has(r.$key())}return!1},canRemoveRelated:function(e,t){return!t||!e.$isPending()},checkSave:function(e,t){e.delaySaving||t||!e.parent.$exists()||(this.store===le.Store.Model||this.save===le.Save.Model)&&(le.debug(this.debugAutoSave,this,e),e.parent.$save())},handleModel:function(e,t){return function(i){var n=e.pending,s=i.$key();s in n&&(le.debug(this.debugInitialGrabbed,this,e,i),this.addModel(e,i,t),delete n[s])}},sort:function(e){var t=e.related;e.delaySorting||(le.debug(this.debugSort,this,e),t.sort(this.comparator),e.parent.$trigger(ke.Events.RelationUpdate,[this,e]))}}),le.Relations.belongsTo=rt,rt.Defaults={model:null,lazy:!1,query:!1,store:le.Store.None,save:le.Save.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:le.Cascade.Local,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},y(nt,rt,{type:"belongsTo",debugInit:le.Debugs.BELONGSTO_INIT,debugClearModel:le.Debugs.BELONGSTO_CLEAR_MODEL,debugSetModel:le.Debugs.BELONGSTO_SET_MODEL,debugLoaded:le.Debugs.BELONGSTO_LOADED,debugClearKey:le.Debugs.BELONGSTO_CLEAR_KEY,debugUpdateKey:le.Debugs.BELONGSTO_UPDATE_KEY,debugQuery:le.Debugs.BELONGSTO_QUERY,debugQueryResults:le.Debugs.BELONGSTO_QUERY_RESULTS,getDefaults:function(e,t,i){return rt.Defaults},load:Ae(function(e,t,i){var n=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,onRemoved:function(){le.debug(le.Debugs.BELONGSTO_NINJA_REMOVE,this,e,n),e.$remove(this.cascade),this.clearRelated(n)},onSaved:function(){le.debug(le.Debugs.BELONGSTO_NINJA_SAVE,this,e,n),n.isRelated(n.related)||(e.$remove(this.cascade),this.clearRelated(n))}};e.$on(ke.Events.PostRemove,this.postRemove,this),e.$on(ke.Events.KeyUpdate,this.onKeyUpdate,this),Y(t)&&(t=this.grabInitial(e,this.local),t&&le.debug(le.Debugs.BELONGSTO_INITIAL_PULLED,this,e,t)),Y(t)?this.query&&(n.query=this.executeQuery(e)):(le.debug(le.Debugs.BELONGSTO_INITIAL,this,e,t),this.grabModel(t,this.handleModel(n,i),i))}),postRemove:function(e){var t=e.$relations[this.name];t&&(le.debug(le.Debugs.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t),this.setProperty(t))},onKeyUpdate:function(e,t,i,n){if(this.local===i){var s=e.$relations[this.name];s&&t!==s.related&&(this.clearModel(s),this.setModel(s,t),this.setProperty(s))}}}),le.Relations.hasOne=at,at.Defaults={model:null,lazy:!1,query:!1,store:le.Store.None,save:le.Save.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:le.Cascade.All,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},y(nt,at,{type:"hasOne",debugInit:le.Debugs.HASONE_INIT,debugClearModel:le.Debugs.HASONE_CLEAR_MODEL,debugSetModel:le.Debugs.HASONE_SET_MODEL,debugLoaded:le.Debugs.HASONE_LOADED,debugClearKey:le.Debugs.HASONE_CLEAR_KEY,debugUpdateKey:le.Debugs.HASONE_UPDATE_KEY,debugQuery:le.Debugs.HASONE_QUERY,debugQueryResults:le.Debugs.HASONE_QUERY_RESULTS,getDefaults:function(e,t,i){return at.Defaults},load:Ae(function(e,t,i){var n=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,dirty:!1,saving:!1,onRemoved:function(){le.debug(le.Debugs.HASONE_NINJA_REMOVE,this,e,n),this.clearRelated(n)}};e.$on(ke.Events.PreSave,this.preSave,this),e.$on(ke.Events.PostRemove,this.postRemove,this),Y(t)&&(t=this.grabInitial(e,this.local),t&&le.debug(le.Debugs.HASONE_INITIAL_PULLED,this,e,t)),Y(t)?this.query&&(n.query=this.executeQuery(e)):(le.debug(le.Debugs.HASONE_INITIAL,this,e,t),this.grabModel(t,this.handleModel(n),i))}),preClone:function(e,t,i){var n=this.get(e);if(n){var s=n.$clone(i);this.updateFieldsReturnChanges(t,this.local,s,s.$db.key),t[this.name]=s}},preSave:function(e){var t=e.$relations[this.name];if(t&&t.related){var i=t.related;(t.dirty||i.$hasChanges())&&(le.debug(le.Debugs.HASONE_PRESAVE,this,e,t),t.saving=!0,i.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade&&(le.debug(le.Debugs.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e){var t=e.related;t&&(le.debug(this.debugClearModel,this,e),t.$off(ke.Events.Removed,e.onRemoved),this.cascade&&!t.$isDeleted()&&t.$remove(this.cascade),e.related=null,e.dirty=!0,e.loaded=!0,delete e.parent.$dependents[t.$uid()])}}),le.Relations.hasMany=ot,ot.Defaults={model:null,lazy:!1,query:!1,store:le.Store.None,save:le.Save.None,auto:!0,property:!0,dynamic:!1,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:le.Cascade.Local,cascadeSave:le.Cascade.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},y(st,ot,{type:"hasMany",debugAutoSave:le.Debugs.HASMANY_AUTO_SAVE,debugInitialGrabbed:le.Debugs.HASMANY_INITIAL_GRABBED,debugSort:le.Debugs.HASMANY_SORT,debugQuery:le.Debugs.HASMANY_QUERY,debugQueryResults:le.Debugs.HASMANY_QUERY_RESULTS,getDefaults:function(e,t,i){return ot.Defaults},onInitialized:function(e,t,i){this.foreign=this.foreign||e.name+"_"+e.key,this.comparator=j(this.comparator,this.comparatorNullsFirst),le.debug(le.Debugs.HASMANY_INIT,this),this.finishInitialization()},load:Ae(function(e,t,i){var n=this,s=e.$relations[this.name]={parent:e,pending:{},isRelated:this.isRelatedFactory(e),related:this.createRelationCollection(e),saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){le.debug(le.Debugs.HASMANY_NINJA_REMOVE,n,e,this,s),n.removeModel(s,this,!0)},onSaved:function(){s.saving||(le.debug(le.Debugs.HASMANY_NINJA_SAVE,n,e,this,s),s.isRelated(this)?(n.sort(s),n.checkSave(s)):n.removeModel(s,this))}};e.$on(ke.Events.PostSave,this.postSave,this),e.$on(ke.Events.PreRemove,this.preRemove,this),this.listenToModelAdded(this.handleModelAdded(s)),l(t)?(le.debug(le.Debugs.HASMANY_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,i),i)):this.query?s.query=this.executeQuery(e):(le.debug(le.Debugs.HASMANY_INITIAL_PULLED,this,e,s),this.ready(this.handleLazyLoad(s))),this.setProperty(s)}),postClone:function(e,t,i){var n=this.get(e);if(n){var s=[];this.updateFieldsReturnChanges(i,this.foreign,t,e.$db.key),i[this.foreign]=t[e.$db.key];for(var r=0;r<n.length;r++)s.push(n[r].$clone(i));t[this.name]=s}},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){le.debug(le.Debugs.HASMANY_POSTSAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var i=t.related,n=0;n<i.length;n++){var s=i[n];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave)}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(le.debug(le.Debugs.HASMANY_PREREMOVE,this,e,t),this.bulk(t,function(){for(var e=t.related,i=e.length-1;i>=0;i--){var n=e[i];n.$remove(this.cascadeRemove)}}))},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&(le.debug(le.Debugs.HASMANY_NINJA_ADD,this,e,t),this.addModel(e,t,i))}},handleLazyLoad:function(e){return function(t){var i=t.filter(e.isRelated);le.debug(le.Debugs.HASMANY_LAZY_LOAD,this,e,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModel(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=e.parent,s=e.related,r=t.$key(),a=!s.has(r);return a&&(le.debug(le.Debugs.HASMANY_ADD,this,e,t),s.put(r,t),t.$on(ke.Events.Removed,e.onRemoved),t.$on(ke.Events.SavedRemoteUpdate,e.onSaved),t.$dependents[n.$uid()]=n,this.updateForeignKey(n,t,i),this.sort(e),i||this.checkSave(e)),a}},removeModel:function(e,t,i){if(this.canRemoveRelated(t,i)){var n=e.parent,s=e.related,r=e.pending,a=t.$key();s.has(a)&&(le.debug(le.Debugs.HASMANY_REMOVE,this,e,t),s.remove(a),t.$off(ke.Events.Removed,e.onRemoved),t.$off(ke.Events.SavedRemoteUpdate,e.onSaved),delete t.$dependents[n.$uid()],this.cascadeRemove&&t.$remove(this.cascadeRemove),this.sort(e),this.checkSave(e)),delete r[a]}},updateForeignKey:function(e,t,i){var n=this.foreign,s=e.$db.key;this.updateFields(t,n,e,s,i)},isRelatedFactory:function(e){var t=this.foreign,i=e.$db.key;return function(n){return R(n,t,e,i)}}}),le.Relations.hasManyThrough=ut,ut.Defaults={model:null,lazy:!1,query:!1,store:le.Store.None,save:le.Save.None,auto:!0,property:!0,dynamic:!1,through:t,local:null,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:le.Cascade.NoRest,cascadeSave:le.Cascade.All,cascadeSaveRelated:le.Cascade.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},y(st,ut,{type:"hasManyThrough",debugAutoSave:le.Debugs.HASMANYTHRU_AUTO_SAVE,debugInitialGrabbed:le.Debugs.HASMANYTHRU_INITIAL_GRABBED,debugSort:le.Debugs.HASMANYTHRU_SORT,debugQuery:le.Debugs.HASMANYTHRU_QUERY,debugQueryResults:le.Debugs.HASMANYTHRU_QUERY_RESULTS,getDefaults:function(e,t,i){return ut.Defaults},onInitialized:function(e,t,i){if(!this.discriminated){var n=this.model.Database;this.foreign=this.foreign||n.name+"_"+n.key}this.local=this.local||e.name+"_"+e.key,this.comparator=j(this.comparator,this.comparatorNullsFirst),s(i.through)?this.setThrough(i.through):le.get(i.through,this.setThrough,this),le.debug(le.Debugs.HASMANYTHRU_INIT,this)},setThrough:function(e){this.through=e,this.finishInitialization()},load:Ae(function(e,t,i){var n=this,s=this.through.Database,r=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),pending:{},related:this.createRelationCollection(e),throughs:new Ie,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){le.debug(le.Debugs.HASMANYTHRU_NINJA_REMOVE,n,e,this,r),n.removeModel(r,this)},onSaved:function(){r.saving||(le.debug(le.Debugs.HASMANYTHRU_NINJA_SAVE,n,e,this,r),n.sort(r),n.checkSave(r))},onThroughRemoved:function(){le.debug(le.Debugs.HASMANYTHRU_NINJA_THRU_REMOVE,n,e,this,r),n.removeModelFromThrough(r,this)}};e.$on(ke.Events.PostSave,this.postSave,this),e.$on(ke.Events.PreRemove,this.preRemove,this),s.on(be.Events.ModelAdded,this.handleModelAdded(r),this),l(t)?(le.debug(le.Debugs.HASMANYTHRU_INITIAL,this,e,r,t),this.grabModels(r,t,this.handleModel(r,i),i)):this.query?r.query=this.executeQuery(e):(le.debug(le.Debugs.HASMANYTHRU_INITIAL_PULLED,this,e,r),s.ready(this.handleLazyLoad(r),this)),this.setProperty(r)}),preClone:function(e,t,i){var n=this.get(e);n&&(t[this.name]=n.slice())},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave)for(var i=t.throughs.values,n=0;n<i.length;n++){var s=i[n];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave)}if(t&&this.cascadeSaveRelated){le.debug(le.Debugs.HASMANYTHRU_PRESAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var r=t.related,n=0;n<r.length;n++){var a=r[n];!a.$isDeleted()&&a.$hasChanges()&&a.$save(this.cascadeSaveRelated)}t.saving=!1,t.delaySaving=!1}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(le.debug(le.Debugs.HASMANYTHRU_PREREMOVE,this,e,t),this.bulk(t,function(){for(var e=t.throughs.values,i=0;i<e.length;i++){var n=e[i];n.$remove(this.cascadeRemove)}}))},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&!e.throughs.has(t.$key())&&(le.debug(le.Debugs.HASMANYTHRU_NINJA_ADD,this,e,t),this.addModelFromThrough(e,t,i))}},handleLazyLoad:function(e){return function(t){var i=t.filter(e.isRelated);le.debug(le.Debugs.HASMANYTHRU_LAZY_LOAD,this,e,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModelFromThrough(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=this.finishAddModel(e,t,i);return n&&this.addThrough(e,t,i),n}},addThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t);n.grabModel(s,this.onAddThrough(e,i),this,i)},onAddThrough:function(e,t){return function(i){this.finishAddThrough(e,i,t)}},addModelFromThrough:function(e,t,i){if(!t.$isDeleted()){var n=this.model.Database,s=n.buildKey(t,this.foreign);n.grabModel(s,this.onAddModelFromThrough(e,t,i),this,i)}},onAddModelFromThrough:function(e,t,i){return function(n){n&&(this.finishAddThrough(e,t,i),this.finishAddModel(e,n,i))}},finishAddThrough:function(e,t,i){var n=e.parent,s=e.throughs,r=t.$key();s.has(r)||(le.debug(le.Debugs.HASMANYTHRU_THRU_ADD,this,e,t),s.put(r,t),t.$on(ke.Events.Removed,e.onThroughRemoved),t.$dependents[n.$uid()]=n,!i&&this.cascadeSave&&(n.$isSaved()?t.$save(this.cascadeSave):t.$save(le.Cascade.None)))},finishAddModel:function(e,t,i){var n=e.related,s=t.$key(),r=!n.has(s);return r&&(le.debug(le.Debugs.HASMANYTHRU_ADD,this,e,t),n.put(s,t),t.$on(ke.Events.Removed,e.onRemoved),t.$on(ke.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r},removeModel:function(e,t,i){var n=t.$key(),s=e.related,r=s.get(n);r&&this.removeThrough(e,t,i)&&this.finishRemoveRelated(e,n,i)},removeThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t),r=n.getKey(s),a=e.throughs,o=a.get(r);return this.finishRemoveThrough(e,o,t,!0,i)},removeModelFromThrough:function(e,t){var i=this.model.Database,n=i.buildKey(t,this.foreign);this.finishRemoveThrough(e,t)&&this.finishRemoveRelated(e,n)},finishRemoveThrough:function(e,t,i,n,s){var r=e.parent,a=!!t;if(a){if(!this.canRemoveRelated(t,s))return!1;le.debug(le.Debugs.HASMANYTHRU_THRU_REMOVE,this,e,t,i);var o=e.throughs,u=t.$key();t.$off(ke.Events.Removed,e.onThroughRemoved),delete t.$dependents[r.$uid()],n&&t.$remove(),o.remove(u)}return a},finishRemoveRelated:function(e,t){var i=e.pending,n=e.related,s=n.get(t);return s&&(le.debug(le.Debugs.HASMANYTHRU_REMOVE,this,e,s),n.remove(t),s.$off(ke.Events.Removed,e.onRemoved),s.$off(ke.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete i[t],s},isRelatedFactory:function(e){var t=e.$db.key,i=this.local;return function(n){return R(n,i,e,t)}},createThroughKey:function(e,t){for(var i=e.parent,n=i.$db,s=this.model.Database,r=this.through.Database,a=r.key,o={},u=0;u<a.length;u++){var h=a[u];if(h===this.foreign)o[h]=t.$key();else if(h===this.local)o[h]=i.$key();else if(l(this.foreign)){var d=v(this.foreign,h),c=s.key[d];o[h]=t[c]}else if(l(this.local)){var d=v(this.local,h),c=n.key[d];o[h]=i[c]}}return o}}),le.Relations.hasRemote=ht,ht.Defaults={model:t,lazy:!1,query:!1,store:le.Store.None,save:le.Save.None,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1,autoRefresh:!1},y(st,ht,{type:"hasRemote",debugSort:le.Debugs.HASREMOTE_SORT,debugQuery:le.Debugs.HASREMOTE_QUERY,debugQueryResults:le.Debugs.HASREMOTE_QUERY_RESULTS,getDefaults:function(e,t,i){return ht.Defaults},onInitialized:function(e,t,i){this.comparator=j(this.comparator,this.comparatorNullsFirst),le.debug(le.Debugs.HASREMOTE_INIT,this),this.finishInitialization()},load:Ae(function(e,t,i){var n=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){le.debug(le.Debugs.HASREMOVE_NINJA_REMOVE,n,e,this,s),n.removeModel(s,this,!0)},onSaved:function(){le.debug(le.Debugs.HASREMOVE_NINJA_SAVE,n,e,this,s),n.sort(s),n.checkSave(s)}};e.$key(),this.autoRefresh&&e.$on(this.autoRefresh,this.onRefresh(s),this),s.query=this.executeQuery(e),this.setProperty(s)}),onRefresh:function(e){return function(){e.query=this.executeQuery(e.parent)}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=(e.parent,e.related),s=t.$key(),r=!n.has(s);return r&&(le.debug(le.Debugs.HASMANY_ADD,this,e,t),n.put(s,t),t.$on(ke.Events.Removed,e.onRemoved),t.$on(ke.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r}},removeModel:function(e,t,i){if(this.canRemoveRelated(t,i)){var n=(e.parent,e.related),s=e.pending,r=t.$key();n.has(r)&&(le.debug(le.Debugs.HASMANY_REMOVE,this,e,t),n.remove(r),t.$off(ke.Events.Removed,e.onRemoved),t.$off(ke.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete s[r]}}});var vt={setReferences:function(e,t,i){this.isRelatedFactory=this.isRelatedDiscriminatedFactory(this.isRelatedFactory),this.loadDiscriminators(function(){this.onInitialized(e,t,i)})},isRelatedDiscriminatedFactory:function(e){return function(t){var i=e.call(this,t),n=this.getDiscriminatorForModel(t),s=this.discriminator;return function(e){return i(e)?z(n,e[s]):!1}}},loadDiscriminators:function(e){function t(){++s===n&&e.apply(this)}var i=this.discriminators,n=x(i),s=0;for(var r in i){var a=i[r];le.get(r,this.setDiscriminated(a,t),this)}},setDiscriminated:function(e,t){return function(i){this.discriminators[i.Database.name]=e,this.discriminators[i.Database.className]=e,this.discriminatorToModel[e]=i,t.apply(this)}},createRelationCollection:function(e){return we(new Ye(t,e,this),this.discriminator,this.discriminatorToModel)},createCollection:function(){return we(new Ve,this.discriminator,this.discriminatorToModel)},ready:function(e){var t=this.discriminatorToModel;for(var i in t){var n=t[i];n.Database.ready(e,this)}},listenToModelAdded:function(e){var t=this.discriminatorToModel;for(var i in t){var n=t[i];n.Database.on(be.Events.ModelAdded,e,this)}},executeQuery:function(e){var t=this.query,i=this.queryOptions,n=this.queryData,s=r(t)?ae(t,e):t,a=e.search(s,i);return d(n)&&O(n,a),we(a,this.discriminator,this.discriminatorToModel),a.$run(),a.$ready(this.handleExecuteQuery(e),this),a},parseModel:function(e,t){if(e instanceof ke)return e;if(d(e)){var i=this.getDiscriminatorDatabase(e);if(i)return i.parseModel(e,t);
}return!1},clearFields:function(e,t,i){var n=this.clearFieldsReturnChanges(e,t);return e[this.discriminator]&&(e[this.discriminator]=null,n=!0),n&&!i&&this.auto&&!e.$isNew()&&e.$save(),n},updateFields:function(e,t,i,n,s){var r=this.updateFieldsReturnChanges(e,t,i,n),a=this.discriminator,o=e[a],u=this.getDiscriminatorForModel(i);return z(o,u)||(e[a]=u,r=!0),r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(ke.Events.KeyUpdate,[e,i,t,n])),r},grabInitial:function(e,t){var i=this.discriminator,n=e[i];if($(e,t,f)&&f(n)){var s=this.discriminatorToModel[n];if(s.Database){var a={};if(a[i]=n,r(t))a[s.Database.key]=e[t];else for(var o=0;o<t.length;o++)a[s.Database.key[o]]=e[t[o]];return a}}},grabModel:function(e,t,i){if(d(e)){var n=this.getDiscriminatorDatabase(e);n!==!1&&n.grabModel(e,t,this,i)}},grabModels:function(e,t,i){for(var n=0;n<e.length;n++){var s=e[n];if(s instanceof ke)t.call(this,s);else if(d(s)){var r=this.getDiscriminatorDatabase(s);if(r){var a=r.buildKeyFromInput(s);relation.pending[a]=!0,r.grabModel(s,t,this,i)}}}},ownsForeignKey:function(){return!0},isModelArray:function(e){return l(e)},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e),e=this.discriminatorToModel[t];return e?e.Database:!1},getDiscriminatorForModel:function(e){return this.discriminators[e.$db.name]}};le.shard=function(e){return function(t){var i=new lt(t);return O(e,i),i.initialize(t),i}},lt.prototype={STATUS_FAIL_ALL:500,STATUS_FAIL_GET:500,STATUS_FAIL_CREATE:500,STATUS_FAIL_UPDATE:500,STATUS_FAIL_REMOVE:500,STATUS_FAIL_QUERY:500,ATOMIC_ALL:!1,ATOMIC_GET:!1,ATOMIC_CREATE:!0,ATOMIC_UPDATE:!0,ATOMIC_REMOVE:!1,ATOMIC_QUERY:!0,getShards:function(e){throw"getShards not implemented"},getShardForModel:function(e,t){throw"getShardForModel not implemented"},getShardsForModel:function(e,t){var i=this.getShardForModel(e,t);return i?[i]:this.getShards(t)},getShardsForQuery:function(e,t){return this.getShards()},initialize:function(e){},all:function(e,t){function n(e,t,i){e.all(t,i)}function s(e){l(e)&&o.push.apply(o,e)}function r(n,s,r){n||o.length&&!this.ATOMIC_ALL?e(o):s||t(o,i(r)?r:this.STATUS_FAIL_ALL)}var a=this.getShards(!0),o=[];this.multiplex(a,this.ATOMIC_ALL,n,s,t,r)},get:function(e,t,n){function s(t,i,n){t.get(e,i,n)}function r(e){null===u&&d(e)&&(u=e)}function a(e,s,r){null!==u?t(u):n(u,i(r)?r:this.STATUS_FAIL_GET)}var o=this.getShardsForModel(e,!0),u=null;this.multiplex(o,this.ATOMIC_GET,s,r,g,a)},create:function(e,t,n,s){function r(i,n,s){i.create(e,t,n,s)}function a(e){null===h&&d(h)&&(h=e)}function o(e,t,r){e?n(h):s(h,i(r)?r:this.STATUS_FAIL_CREATE)}var u=this.getShardsForModel(e,!1),h=null;this.multiplex(u,this.ATOMIC_CREATE,r,a,g,o)},update:function(e,t,n,s){function r(i,n,s){i.update(e,t,n,s)}function a(e){null===h&&d(h)&&(h=e)}function o(e,t,r){e?n(h):s(h,i(r)?r:this.STATUS_FAIL_UPDATE)}var u=this.getShardsForModel(e,!1),h=null;this.multiplex(u,this.ATOMIC_UPDATE,r,a,g,o)},remove:function(e,t,n){function s(t,i,n){t.remove(e,i,n)}function r(e){null===u&&d(u)&&(u=e)}function a(e,s,r){e?t(u):n(u,i(r)?r:this.STATUS_FAIL_REMOVE)}var o=this.getShardsForModel(e,!1),u=null;this.multiplex(o,this.ATOMIC_REMOVE,s,r,g,a)},query:function(e,t,n,s){function r(i,n,s){i.query(e,t,n,s)}function a(e){l(e)&&h.push.apply(h,e)}function o(e,t,r){e||h.length&&!this.ATOMIC_QUERY?n(h):t||s(h,i(r)?r:this.STATUS_FAIL_QUERY)}var u=this.getShardsForQuery(e,t),h=[];this.multiplex(u,this.ATOMIC_QUERY,r,a,g,o)},multiplex:function(e,i,n,s,r,o){function u(){++g===e.length&&o.call(this,c,f,v)}function h(e){(c||!i)&&s.apply(this,arguments),u()}function d(e,n){c&&(c=!1,i&&(f=!0,r.apply(this,arguments))),a(n)&&(v===t||v>n)&&(v=n),u()}var c=!0,f=!1,v=t,g=0;if(l(e)&&0!==e.length)for(var p=0;p<e.length;p++)n.call(this,e[p],h,d);else o.call(this,!1,!1,v)}},e.Rekord=le,e.Rekord.Model=ke,e.Rekord.Database=be,e.Rekord.Relation=it,e.Rekord.Operation=Qe,e.Rekord.Transaction=Ge,e.Rekord.Search=Ke,e.Rekord.SearchPaged=ze,e.Rekord.Map=Ie,e.Rekord.Collection=Ue,e.Rekord.FilteredCollection=Pe,e.Rekord.ModelCollection=Ve,e.Rekord.FilteredModelCollection=xe,e.Rekord.Page=He,e.Rekord.HasOne=at,e.Rekord.BelongsTo=rt,e.Rekord.HasMany=ot,e.Rekord.HasManyThrough=ut,e.Rekord.HasRemote=ht,e.Rekord.isRekord=s,e.Rekord.isDefined=i,e.Rekord.isFunction=n,e.Rekord.isString=r,e.Rekord.isNumber=a,e.Rekord.isBoolean=o,e.Rekord.isDate=u,e.Rekord.isRegExp=h,e.Rekord.isArray=l,e.Rekord.isObject=d,e.Rekord.isValue=f,e.Rekord.uuid=m,e.Rekord.indexOf=v,e.Rekord.propsMatch=R,e.Rekord.hasFields=$,e.Rekord.toArray=c,e.Rekord.eventize=he,e.Rekord.extend=y,e.Rekord.extendArray=b,e.Rekord.copyConstructor=S,e.Rekord.factory=A,e.Rekord.transfer=O,e.Rekord.collapse=F,e.Rekord.swap=_,e.Rekord.grab=k,e.Rekord.pull=I,e.Rekord.copy=P,e.Rekord.noop=g,e.Rekord.bind=p,e.Rekord.diff=V,e.Rekord.sizeof=x,e.Rekord.isEmpty=Y,e.Rekord.collect=T,e.Rekord.applyOptions=D,e.Rekord.toCamelCase=L,e.Rekord.evaluate=C,e.Rekord.clean=U,e.Rekord.cleanFunctions=H,e.Rekord.compare=Q,e.Rekord.equals=z,e.Rekord.equalsStrict=w,e.Rekord.equalsCompare=K,e.Rekord.isSorted=B,e.Rekord.saveComparator=q,e.Rekord.createComparator=j,e.Rekord.addComparator=J,e.Rekord.saveWhere=te,e.Rekord.createWhere=ie,e.Rekord.savePropertyResolver=Z,e.Rekord.createPropertyResolver=ee,e.Rekord.saveNumberResolver=W,e.Rekord.createNumberResolver=X,e.Rekord.saveHaving=ne,e.Rekord.createHaving=se,e.Rekord.parse=re,e.Rekord.format=ae,e.Rekord.createFormatter=oe}(this);
//# sourceMappingURL=rekord.min.js.map
