/* rekord 1.2.7 - A javascript REST ORM that is offline and real-time capable http://rekord.github.io/rekord/ by Philip Diffenderfer */
!function(e,t){function i(e,t){return e instanceof Array?e:$(e)?e.split(t):O(e)?[e]:[]}function n(e,t,i){for(var n=i||H,s=0,r=e.length;r>s;s++)if(n(e[s],t))return s;return!1}function s(e){var t=arguments.length>1||!A(e)?Array.prototype.slice.call(arguments):e;return new Be(t)}function r(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function o(e){for(var t=e.length,i=Math.floor(t/2),n=0;i>n;n++)r(e,t-n-1,n);return e}function a(e,t){if(!e)return!0;for(var i=0,n=t.length-1;n>i;i++)if(e(t[i],t[i+1])>0)return!1;return!0}function u(e){for(var t=0;t<e.length;t++){var i=e[t];if(O(i))return!M(i)}return!0}function h(e,t,i){e=v(e),t.prototype=new e,c(t.prototype,i),t.prototype.constructor=t}function l(e,t,i){d()?(h(e,t,i),t.create=g(t)):(e=v(e),t.create=function(){var n=new e;return t.apply(n,arguments),X(i,n),n})}function d(){function e(){}if(d.supported===t){e.prototype=[];var i=new e;i.push(0),d.supported=1===i.length}return d.supported}function c(e,t){for(var i in t)Yt(e,i,t[i])}function f(e,t,i){Yt(e,t,i(e[t]))}function v(e){function t(){}return t.prototype=e.prototype,t}function g(e){function t(t){return e.apply(this,t)}return t.prototype=e.prototype,function(){return new t(arguments)}}function p(e){return e!==t}function m(e){return!!(e&&e.constructor&&e.call&&e.apply)}function E(e){return!!(e&&e.Database&&m(e)&&e.prototype instanceof Ve)}function $(e){return"string"==typeof e}function y(e){return"number"==typeof e&&!isNaN(e)}function R(e){return"boolean"==typeof e}function S(e){return e instanceof Date}function b(e){return e instanceof RegExp}function A(e){return e instanceof Array}function M(e){return null!==e&&"object"==typeof e}function O(e){return!(e===t||null===e)}function _(){}function D(e,t){return function(){t.apply(e,arguments)}}function T(){return L()+L()+"-"+L()+"-"+L()+"-"+L()+"-"+L()+L()+L()}function L(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function N(e){if(A(e)||$(e))return e.length;if(M(e)){var t=0;for(var i in e)t++;return t}return y(e)?e:0}function I(e){if(null===e||e===t||0===e)return!0;if(A(e)||$(e))return 0===e.length;if(S(e))return 0===e.getTime()||isNaN(e.getTime());if(M(e)){for(var i in e)return!1;return!0}return!1}function F(e,t){return O(e)?E(e)?new e:m(e)?e():t?e:ie(e):e}function C(e,t,i){var n=U(t,i);return xt[e]=n,n}function k(e,t,i){var n=U(t,i);return m(e)?function(t,i){var s=n(t,i);return 0!==s?s:e(t,i)}:n}function U(e,t){if(m(e))return e;if($(e)){if(e in xt)return xt[e];if("-"===e.charAt(0)){var i=U(e.substring(1),!t);return function(e,t){return-i(e,t)}}if(ae(e)){var n=he(e);return function(e,t){var i=n(e),s=n(t);return i.localeCompare(s)}}if(se(e)){var s=oe(e);return function(e,i){var n=s(e),r=s(i);return Y(n,r,t)}}return function(i,n){var s=O(i)?i[e]:i,r=O(n)?n[e]:n;return Y(s,r,t)}}if(A(e)){for(var r=[],o=0;o<e.length;o++)r[o]=U(e[o],t);return function(e,t){for(var i=0,n=0;n<r.length&&0===i;n++)i=r[n](e,t);return i}}return null}function H(e,t){return e===t}function P(e,t){return e==t}function K(e,t){return 0===Y(e,t)}function V(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var i=typeof e,n=typeof t,s=b(e),r=b(t);if("string"===i&&r)return t.test(e);if("string"===n&&s)return e.test(t);if(i!==n)return!1;var o=A(e),a=A(t);if(o!==a)return!1;if(o){if(e.length!==t.length)return!1;for(var u=0;u<e.length;u++)if(!V(e[u],t[u]))return!1;return!0}if(S(e))return S(t)&&V(e.getTime(),t.getTime());if(s)return r&&e.toString()===t.toString();if("object"===i){for(var h in e)if(!("$"===h.charAt(0)||m(e[h])||h in t&&V(e[h],t[h])))return!1;for(var l in t)if(!("$"===l.charAt(0)||m(t[l])||l in e))return!1;return!0}return!1}function w(e,t){return e===t?0:t>e?-1:1}function Y(e,t,i){if(e==t)return 0;var n=O(e),s=O(t);return n!==s?n&&!i||s&&i?-1:1:(S(e)&&(e=e.getTime()),S(t)&&(t=t.getTime()),y(e)&&y(t)?w(e,t):A(e)&&A(t)?w(e.length,t.length):R(e)&&R(t)?e?-1:1:(e+"").localeCompare(t+""))}function x(e,t,i,n){var s=n?"$on":"on",r=n?"$off":"off";Yt(e,t,function(e,t){function n(){var i=e.apply(t||a,arguments);i===!1&&o()}function o(){u||(a[r](i,n),u=!0)}var a=this,u=!1;return a[s](i,n),o})}function G(e,t){function n(e,t,n,s,r){if(!m(s))return _;var o=i(n," "),u=e[t];u||(u=e[t]={});for(var h=0;h<o.length;h++){var l=o[h],d=u[l];d||(d=u[l]=[]),d.push([s,r||e,0])}return function(){for(var e=0;e<o.length;e++)a(u,o[e],s)}}function s(e,t,i){return n(this,"$$on",e,t,i)}function r(e,t,i){return n(this,"$$once",e,t,i)}function o(e,t,i){return n(this,"$$after",e,t,i)}function a(e,t,i){if(e&&t in e)for(var n=e[t],s=n.length-1;s>=0;s--)n[s][c]===i&&n.splice(s,1)}function u(e,t){e&&t in e&&delete e[t]}function h(e,t){if(p(e)){var n=i(e," ");if(m(t))for(var s=0;s<n.length;s++)a(this.$$on,n[s],t),a(this.$$once,n[s],t),a(this.$$after,n[s],t);else for(var s=0;s<n.length;s++)u(this.$$on,n[s]),u(this.$$once,n[s]),u(this.$$after,n[s])}else u(this,"$$on"),u(this,"$$once"),u(this,"$$after");return this}function l(e,t,i,n){if(e&&t in e){for(var s=e[t],r=++g,o=0;o<s.length;o++){var a=s[o];a&&a[v]!==r&&(a[v]=r,a[c].apply(a[f],i),a!==s[o]&&(o=-1))}n&&delete e[t]}}function d(e,t){try{for(var n=i(e," "),s=0;s<n.length;s++){var r=n[s];l(this.$$on,r,t,!1),l(this.$$once,r,t,!0),l(this.$$after,r,t,!1)}}catch(o){ye.trigger(ye.Events.Error,[o])}return this}var c=0,f=1,v=2,g=0;t?(Yt(e,"$on",s),Yt(e,"$once",r),Yt(e,"$after",o),Yt(e,"$off",h),Yt(e,"$trigger",d)):(Yt(e,"on",s),Yt(e,"once",r),Yt(e,"after",o),Yt(e,"off",h),Yt(e,"trigger",d))}function z(e,i,n,s){function r(t,i){m(i)?Yt(e,t,i):e[t]=i}i=i||{};for(var o in n){var a=n[o],u=i[o],h=O(u);if(!h&&a===t)throw o+" is a required option";h?r(o,u):r(o,ie(a))}for(var l in i)l in n||r(l,i[l]);s?e.$options=i:e.options=i}function Q(e,t,i,n,s){var r=s||ye.equals;if($(t))return r(e[t],i[n]);for(var o=0;o<t.length;o++){var a=t[o],u=n[o];if(!r(e[a],i[u]))return!1}return!0}function B(e,t,i){if(A(t)){for(var n=0;n<t.length;n++)if(!i(e[t[n]]))return!1;return!0}return i(e[t])}function q(e,t){var i=!1;if(A(t))for(var n=0;n<t.length;n++){var s=t[n];e[s]&&(e[s]=null,i=!0)}else e[t]&&(e[t]=null,i=!0);return i}function J(e,t,i,n){var s=!1;if(A(t))for(var r=0;r<t.length;r++){var o=t[r],a=e[o],u=n[r],h=i[u];V(a,h)||(e[o]=ie(h),s=!0)}else{var a=e[t],h=i[n];V(a,h)||(e[t]=ie(h),s=!0)}return s}function j(e,t,i){for(var n={},s=0;s<t.length;s++){var r=t[s];r in e&&(n[r]=i?ie(e[r]):e[r])}return n}function W(e,t,i){if($(t)){var n=e[t];return i?ie(n):n}for(var s=[],r=0;r<t.length;r++){var o=t[r],n=e[o];s.push(i?ie(n):n)}return s}function X(e,t){for(var i in e)t[i]=e[i];return t}function Z(){for(var e={},t=0;t<arguments.length;t++){var i=arguments[t];if(M(i))for(var n in i)n in e||(e[n]=i[n])}return e}function ee(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function te(e){for(var t in e)m(e[t])&&delete e[t];return e}function ie(e,i){if(null===e||e===t||"object"!=typeof e||m(e)||b(e))return e;if(A(e)){for(var n=[],s=0;s<e.length;s++)n.push(ie(e[s],i));return n}if(S(e))return new Date(e.getTime());var n={};for(var r in e)(i||"$"!==r.charAt(0))&&(n[r]=ie(e[r],i));return n}function ne(e,t,i,n){for(var s={},r=0;r<i.length;r++){var o=i[r];n(e[o],t[o])||(s[o]=ie(e[o]))}return s}function se(e){return-1!==e.indexOf(".")||-1!==e.indexOf("[")}function re(e,t){return oe(e)(t)}function oe(e){for(var i=re.REGEX,n=[],s=null;null!==(s=i.exec(e));)n.push(s[1]);return function(e){for(var i=0;i<n.length&&e!==t;i++){var s=n[i];M(e)&&(e=F(e[s],!0))}return e}}function ae(e){return-1!==e.indexOf("{")}function ue(e,t){return he(e)(t)}function he(e){for(var t=e.split(ue.REGEX),i=1;i<t.length;i+=2)t[i]=oe(t[i]);return function(e){for(var i="",n=0;n<t.length;n++)if(0===(1&n))i+=t[n];else{var s=t[n](e);i+=O(s)?s:""}return i}}function le(e,t){return $(e)&&(Date.parse&&(e=Date.parse(e)),y(e)||(e=new Date(e))),y(e)&&(e=new Date(e)),S(e)&&y(e.getTime())?(t&&(e=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())),e):!1}function de(e,t,i){var n=ce(t,i);return Gt[e]=n,n}function ce(e,t){var i=ve(e);return $(e)&&e in Gt?Gt[e]:function(e){var n=parseFloat(i(e));return isNaN(n)?t:n}}function fe(e,t){var i=ve(t);return zt[e]=i,i}function ve(e){if(m(e))return e;if($(e))return e in zt?zt[e]:ae(e)?he(e):se(e)?oe(e):function(i){return i?i[e]:t};if(A(e))return function(t){return W(t,e)};if(M(e)){var i=[],n=[];for(var s in e)i.push(s),n.push(ve(e[s]));return function(e){for(var t={},s=0;s<i.length;s++){var r=i[s];t[r]=n[s](e[r])}return t}}return function(e){return e}}function ge(e){return 1===e.length?e.toUpperCase():e.charAt(1).toUpperCase()}function pe(e){return e.replace(pe.REGEX,ge)}function me(e,t,i){for(var n=b(t)?t:new RegExp("("+t+")"),s=e.split(n),r=0,o=s.length-2;o>r;){var a=s[r],u=a.length-i.length;if(a.substring(u)===i){var h=s[r+1],l=s[r+2],d=a.substring(0,u)+h+l;s.splice(r,3,d),o-=2}else r+=1,s.splice(r,1),o-=1}return s}function Ee(e,t,i,n){var s=$e(t,i,n);return Qt[e]=s,s}function $e(e,t,i){var n=i||H;if(m(e))return e;if(A(e)){for(var s=[],r=0;r<e.length;r++){var o=e[r];s.push(A(o)?$e.apply(this,o):$e(o))}return function(e){for(var t=0;t<s.length;t++)if(!s[t](e))return!1;return!0}}if(M(e))return function(t){for(var i in e)if(!n(t[i],e[i]))return!1;return!0};if($(e)){if(e in Qt)return Qt[e];var a=ve(e);return O(t)?function(e){return n(a(e),t)}:function(e){return O(a(e))}}return function(e){return!0}}function ye(e){var t=ye.get(e.name);if(t.isComplete())return t.results[0];ye.trigger(ye.Events.Options,[e]);var i=new Ne(e),n=new Function("return function "+i.className+"(props, remoteData) { this.$init( props, remoteData ) }")();return n.prototype=new Ve(i),i.Model=n,n.Database=i,ye.classes[i.name]=n,ye.trigger(ye.Events.Plugins,[n,i,e]),ye.autoload?i.loadBegin(function(e){e&&i.loadFinish()}):ye.unloaded.push(i),ye.get(i.name).resolve(n),ye.get(i.className).resolve(n),ye.debug(ye.Debugs.CREATION,i,e),n}function Re(e,t){return!y(e)||(e&t)===t}function Se(e,t,n){for(var s=i(e,/\s*,\s/),r=i(t,/\s*,\s/),o=ti.push(n)-1,a=ei[o]=new Be,u=0;u<s.length;u++){var h=s[u],l=Ae(r,a);if($(h))h in ye.classes?l(ye.classes[h]):be(h,l);else if(E(h))l(h);else{if(h!==!0)throw h+" is not a valid input for batching";for(var d in ye.classes)l(ye.classes[d]);ye.on(ye.Events.Plugins,l)}}}function be(e,t){var i=ye.on(ye.Events.Plugins,function(n,s){s.name===e&&(t(n),i())})}function Ae(e,t){return function(i){for(var n=i.Database,s=n.rest,r=0;r<e.length;r++){var o=e[r];switch(ii.push(s,o,s[o]),o){case"all":s.all=function(e,s){t.push({database:n,"class":i,operation:"all",success:e,failure:s})};break;case"get":s.get=function(e,s,r){t.push({database:n,"class":i,operation:"get",success:s,failure:r,model:e})};break;case"create":s.create=function(e,s,r,o){t.push({database:n,"class":i,operation:"create",success:r,failure:o,model:e,encoded:s})};break;case"update":s.update=function(e,s,r,o){t.push({database:n,"class":i,operation:"update",success:r,failure:o,model:e,encoded:s})};break;case"remove":s.remove=function(e,s,r){t.push({database:n,"class":i,operation:"remove",success:s,failure:r,model:e})};break;case"query":s.query=function(e,s,r,o){t.push({database:n,"class":i,operation:"query",success:r,failure:o,url:e,encoded:s})};break;default:throw o+" is not a valid operation you can batch"}}}}function Me(){for(var e=0;e<ei.length;e++){var t=ei[e],i=ti[e];t.length&&(i(t),t.clear())}}function Oe(){Zt++}function _e(){Zt--,0===Zt&&Me()}function De(){for(var e=0;e<ii.length;e+=3){var t=ii[e+0],i=ii[e+1],n=ii[e+2];t[i]=n}ei.length=0,ti.length=0,ii.length=0}function Te(e,t){try{Oe(),e.apply(t)}catch(i){throw ye.trigger(ye.Events.Error,[i]),i}finally{_e()}}function Le(e){var t=!1,i=[],n=function(){t?e.apply(this,arguments):i.push(this,wt.slice.apply(arguments))};return n.open=function(){if(!t){for(var n=0;n<i.length;n+=2){var s=i[n],r=i[n+1];e.apply(s,r)}i.length=0,t=!0}},n}function Ne(e){z(this,e,ni),this.keyHandler=A(this.key)?new Qe(this):new ze(this),this.keyHandler.addToFields(this.fields),this.models=new je(this),this.all={},this.loaded={},this.className=this.className||pe(this.name),this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.firstRefresh=!1,this.pendingOperations=0,this.afterOnline=!1,this.saveFields=ie(this.fields),this.readyPromise=new it(null,!1),this.prepare(this,e),this.rest=this.createRest(this),this.store=this.createStore(this),this.live=this.createLive(this),this.setComparator(this.comparator,this.comparatorNullsFirst),this.setRevision(this.revision),this.setSummarize(this.summarize),this.relations={},this.relationNames=[];for(var t in e)if(t in ye.Relations){var i=ye.Relations[t];if(i.prototype instanceof ft){var n=e[t];for(var s in n){var r=n[s],o=new i;o.init(this,s,r),o.save&&this.saveFields.push(s),this.relations[s]=o,this.relationNames.push(s)}}}}function Ie(e,t,i){var n=this.encodings;for(var s in t)s in n&&(t[s]=n[s](t[s],e,s,i));return t}function Fe(e){var t=this.decodings;for(var i in e)i in t&&(e[i]=t[i](e[i],e,i));return e}function Ce(e){return e.$key()}function ke(e){return e.rest===!1?ye.defaultRest(e):ye.rest(e)}function Ue(e){return e.store===!1?ye.defaultStore(e):ye.store(e)}function He(e){return e.live===!1?ye.defaultLive(e):ye.live(e)}function Pe(e){return e}function Ke(e){return e}function Ve(e){this.$db=e}function we(e,t,i,n,s,r,o){var a=new it(null,!1);if(Re(t,Bt.Rest))var u=e.$once(i,function(t){h(),l(),a.resolve(e,t)}),h=e.$once(n,function(t,i){u(),l(),a.reject(e,i,t)}),l=e.$once(s,function(){u(),h(),a.noline(e)});else if(Re(t,Bt.Local))var u=e.$once(r,function(t){h(),a.resolve(e,t)}),h=e.$once(o,function(t,i){u(),a.reject(e,t)});else a.resolve(e);return a}function Ye(){this.values=[],this.keys=[],this.indices={}}function xe(e){this.map={},this.listeners={},this.subject=e}function Ge(){}function ze(e){this.init(e)}function Qe(e){this.init(e)}function Be(e){this.addAll(e,!0)}function qe(e,t,i){this.onChanges=D(this,this.handleChanges),this.pageSize=t,this.pageIndex=i||0,this.pageCount=0,this.setCollection(e)}function Je(e,t){this.bind(),this.init(e,t)}function je(e,t,i){this.init(e,t,i)}function We(e,t){this.bind(),this.init(e,t)}function Xe(e,t,i,n,s){this.model=t,this.relator=i,this.init(e,n,s)}function Ze(e,t,i){e.discriminator=t,e.discriminatorsToModel=i;var n=(e.buildKeyFromInput,e.parseModel,e.clone),s=e.cloneEmpty;return c(e,{buildKeyFromInput:function(e){if(M(e)){var t=e[this.discriminator],i=this.discriminatorsToModel[t];if(i)return i.Database.keyHandler.buildKeyFromInput(e)}return e},parseModel:function(e,t){if(e instanceof Ve)return e;var i=O(e)?e[this.discriminator]:null,n=this.discriminatorsToModel[i];return n?n.Database.parseModel(e,t):null},clone:function(){return Ze(n.apply(this),t,i)},cloneEmpty:function(){return Ze(s.apply(this),t,i)}}),e}function et(e,t,i,n,s){this.$init(e,t,i,n,s)}function tt(e,t,i,n,s){this.$init(e,t,i,n,s)}function it(e,t){this.status=it.Status.Pending,this.results=null,this.cancelable=t!==!1,m(e)&&e(D(this,this.resolve),D(this,this.reject),D(this,this.noline),D(this,this.cancel))}function nt(){}function st(e,t){this.reset(e,t)}function rt(e,t){this.reset(e,t)}function ot(e,t){this.reset(e,t)}function at(e,t){this.reset(e,t)}function ut(e,t){this.reset(e,t)}function ht(e,t){this.reset(e,t)}function lt(e,t){this.reset(e,t)}function dt(e,t){this.reset(e,t)}function ct(e,t){this.reset(e,t)}function ft(){}function vt(){}function gt(){}function pt(){}function mt(){}function Et(){}function $t(){}function yt(){}function Rt(){}function St(e){this.database=e}function bt(e,t,i){var n=m(i)?i:M(i)&&m(i.get)?i.get:_,s=M(i)&&m(i.set)?i.set:_;if(Object.defineProperty)Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n,set:s});else{var r=e.$init;e.$init=function(){r.apply(this,arguments);var e=this[t]=n.apply(this),i=function(){var i=this[t];i!==e?s.call(this,i):e=this[t]=n.apply(this)};this.$after(Ve.Events.Changes,i,this)}}}function At(e,t,i,n){var s={on:i?"$on":"on",once:i?"$once":"once",after:i?"$after":"after"},r=n||[];if(m(t))r.push({when:s.on,events:e,invoke:t});else if(A(t)&&2===t.length&&m(t[0]))r.push({when:s.on,events:e,invoke:t[0],context:t[1]});else if(M(t))for(var o in t)if(o in s){var a=t[o],u=s[o];m(a)?r.push({when:u,events:e,invoke:a}):A(a)&&2===a.length&&m(a[0])&&r.push({when:u,events:e,invoke:a[0],context:a[1]})}return r}function Mt(e,t){for(var i=0;i<t.length;i++){var n=t[i];e[n.when](n.events,n.invoke,n.context)}}function Ot(){return e.File&&e.FileReader&&e.FileList}function _t(t){return t instanceof e.File?t:t instanceof e.Blob?t:t instanceof e.FileList&&t.length>0?t[0]:!1}function Dt(e){return e}function Tt(e){var t=$(e)?e.indexOf(";base64,"):-1;return-1===t?e:e.substring(t+8)}function Lt(e,t){t.autoSave&&e.$isSaved()&&e.$save()}function Nt(e,t,i,n,s){e.$files=e.$files||{},e.$files[t]={value:i,user:i,file:n,options:s}}function It(e,t,i,n,s){var r,o=!1;return e&&e.valueToUser?e.valueToUser(t,i,n,function(e){i.$files[n].user=e,o?(i[n]=e,Lt(i,s)):r=e}):r=t,o=!0,r}function Ft(t,i,n){var s=ye.fileProcessors[n.processor];return t in e.FileReader.prototype||ye.trigger(ye.Events.FilesNotSupported),function(r,o,a){var u=_t(r);if(u!==!1){var h,l=new e.FileReader,d=!1;return l.onload=function(e){var t=i(e.target.result);Nt(o,a,t,u,n),h=It(s,t,o,a,n),d&&(o[a]=h,Lt(o,n))},l[t](u),d=!0,h}if(M(r)&&r.FILE){var h,c=function(e){h=e};return ye.trigger(ye.Events.FileOffline,[r,o,a,c]),h}return Nt(o,a,r,null,n),It(s,r,o,a,n)}}function Ct(e,t,i,n){if(t.$files&&i in t.$files){var s=t.$files[i];if(n&&s.save===!1||!n&&s.store===!1)return;if(!n&&s.file){var r=j(s.file,ye.fileProperties,!1);return r.FILE=!0,r}if(e===s.user)return n&&s.file&&t.$once(Ve.Events.RemoteSave,function(){delete s.file,t.$addOperation(lt,Bt.Local)}),s.value}return e}function kt(e){return function(t,i,n){var s=e.indices[i];if(y(s)){var r=e.listeners[i];delete e.indices[i],delete e.listeners[i],e.keys[s]=n,e.indices[n]=s,e.listeners[n]=r}}}function Ut(e,t){return ai.apply(this,arguments),t instanceof Ve&&t.$db.keyChanges&&(this.listeners=this.listeners||{},this.listeners[e]=t.$on(Ve.Events.KeyChange,kt(this))),this}function Ht(e){var t=this.indices[e];return y(t)&&(this.listeners&&(F(this.listeners[e]),delete this.listeners[e]),this.removeAt(t)),this}function Pt(){Yt(Ye.prototype,"put",Ut),Yt(Ye.prototype,"remove",Ht)}function Kt(){Yt(Ye.prototype,"put",ai),Yt(Ye.prototype,"remove",ui)}function Vt(e,t,i){var n=le(e,i);if(n===!1)return!1;if(!t)return n;switch(t){case hi.Date:return n;case hi.Millis:return n.getTime();case hi.Seconds:return Math.floor(n.getTime()/1e3);default:return ye.formatDate(n,t)}}var wt=Array.prototype,Yt=function(){return Object.defineProperty?function(e,t,i){Object.defineProperty(e,t,{configurable:!0,enumerable:!1,value:i})}:function(e,t,i){e[t]=i}}(),xt={};re.REGEX=/([\w$]+)/g,ue.REGEX=/[\{\}]/;var Gt={},zt={};pe.REGEX=/(^.|_.)/g;var Qt={};ye.classes={},ye.autoload=!1,ye.unloaded=[],ye.loadPromise=null,ye.load=function(e,t){function i(e,t){if(o.push(e),r.push(t),r.length===s.length){for(var i=0;i<r.length;i++){var t=r[i],e=o[i];e&&t.loadFinish()}n.reset().resolve()}}var n=ye.loadPromise=ye.loadPromise||new it(null,!1),s=ye.unloaded.slice(),r=[],o=[];n.success(e,t||this),ye.unloaded.length=0;for(var a=0;a<s.length;a++)s[a].loadBegin(i);return n},ye.promises={},ye.get=function(e){var t=ye.promises[e];return t||(t=ye.promises[e]=new it(null,!1)),t},G(ye),ye.Events={Initialized:"initialized",Plugins:"plugins",Options:"options",Online:"online",Offline:"offline",Error:"error"};var Bt={None:0,Local:1,Rest:2,NoLive:3,Live:4,NoRest:5,Remote:6,All:7},qt={None:"none",Pending:"pending",All:"all"},Jt={None:0,Model:1,Key:2,Keys:3},jt={None:0,Model:4,Key:5,Keys:6},Wt={None:0,All:1,Lazy:2,Both:3},Xt={Conflict:{409:!0},NotFound:{404:!0,410:!0},Offline:{0:!0}};ye.debug=function(e,t){},ye.setDebug=function(e,t){ye.debugSet&&!t||(ye.debug=e,ye.debugSet=!0)},ye.Debugs={CREATION:0,REST:1,AUTO_REFRESH:73,MISSING_KEY:33,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,GET_LOCAL_SKIPPED:104,GET_LOCAL:105,GET_LOCAL_ERROR:106,GET_REMOTE:107,GET_REMOTE_ERROR:108,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,HASONE_QUERY:111,HASONE_QUERY_RESULTS:112,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:72,BELONGSTO_QUERY:113,BELONGSTO_QUERY_RESULTS:114,HASMANY_INIT:74,HASMANY_NINJA_REMOVE:75,HASMANY_NINJA_SAVE:76,HASMANY_INITIAL:77,HASMANY_INITIAL_PULLED:78,HASMANY_REMOVE:79,HASMANY_SORT:80,HASMANY_ADD:81,HASMANY_LAZY_LOAD:82,HASMANY_INITIAL_GRABBED:83,HASMANY_NINJA_ADD:84,HASMANY_AUTO_SAVE:85,HASMANY_PREREMOVE:86,HASMANY_POSTSAVE:87,HASMANY_QUERY:115,HASMANY_QUERY_RESULTS:116,HASMANY_UPDATE_KEY:129,HASMANYTHRU_INIT:88,HASMANYTHRU_NINJA_REMOVE:89,HASMANYTHRU_NINJA_SAVE:90,HASMANYTHRU_NINJA_THRU_REMOVE:91,HASMANYTHRU_INITIAL:92,HASMANYTHRU_INITIAL_PULLED:93,HASMANYTHRU_REMOVE:94,HASMANYTHRU_SORT:95,HASMANYTHRU_ADD:96,HASMANYTHRU_LAZY_LOAD:97,HASMANYTHRU_INITIAL_GRABBED:98,HASMANYTHRU_NINJA_ADD:99,HASMANYTHRU_AUTO_SAVE:100,HASMANYTHRU_PREREMOVE:101,HASMANYTHRU_POSTSAVE:102,HASMANYTHRU_THRU_ADD:103,HASMANYTHRU_THRU_REMOVE:68,HASMANYTHRU_QUERY:117,HASMANYTHRU_QUERY_RESULTS:118,HASMANYTHRU_UPDATE_KEY:130,HASREMOTE_INIT:50,HASREMOTE_SORT:121,HASREMOTE_NINJA_REMOVE:109,HASREMOTE_NINJA_SAVE:110,HASREMOTE_QUERY:119,HASREMOTE_QUERY_RESULTS:120,HASLIST_INIT:122,HASLIST_SORT:123,HASLIST_NINJA_REMOVE:124,HASLIST_NINJA_SAVE:125,HASLIST_REMOVE:126,HASLIST_ADD:127,HASLIST_INITIAL:128},ye.defaultRest=ye.rest=function(e){return{all:function(e,t){e([])},get:function(e,t,i){i(null,-1)},create:function(e,t,i,n){i({})},update:function(e,t,i,n){i({})},remove:function(e,t,i){t({})},query:function(e,t,i,n){i([])}}},ye.setRest=function(e,t){ye.restSet&&!t||(ye.rest=e,ye.restSet=!0)},ye.defaultStore=ye.store=function(e){return{put:function(e,t,i,n){i(e,t)},get:function(e,i,n){n(e,t)},remove:function(e,t,i){t(e)},all:function(e,t){e([],[])},reset:function(e,t,i,n){i(e,t)}}},ye.setStore=function(e,t){ye.storeSet&&!t||(ye.store=e,ye.storeSet=!0)},ye.defaultLive=ye.live=function(e){return{save:function(e,t){},remove:function(e){}}},ye.setLive=function(e,t){ye.liveSet&&!t||(ye.live=e,ye.liveSet=!0)},ye.online=e.navigator.onLine!==!1,ye.forceOffline=!1,ye.setOnline=function(){ye.online=!0,ye.debug(ye.Debugs.ONLINE),Te(function(){ye.trigger(ye.Events.Online)})},ye.setOffline=function(){ye.online=!1,ye.debug(ye.Debugs.OFFLINE),ye.trigger(ye.Events.Offline)},ye.listenToNetworkStatus=function(){e.addEventListener?(e.addEventListener(ye.Events.Online,ye.setOnline,!1),e.addEventListener(ye.Events.Offline,ye.setOffline,!1)):(e.document.body.ononline=ye.setOnline,e.document.body.onoffline=ye.setOffline)},ye.checkNetworkStatus=function(){var t=e.navigator.onLine;ye.forceOffline&&(t=!1),t===!0&&ye.online===!1?ye.setOnline():t===!1&&ye.online===!0&&ye.setOffline()};var Zt=0,ei=[],ti=[],ii=[];ye.batch=Se,ye.batchRun=Me,ye.batchStart=Oe,ye.batchEnd=_e,ye.batchClear=De,ye.batchExecute=Te,ye.batchDepth=function(){return Zt},Ne.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",Loads:"no-load remote-load local-load",Changes:"updated"};var ni=Ne.Defaults={name:t,className:null,key:"id",keySeparator:"/",fields:[],ignoredFields:{},defaults:{},publishAlways:[],comparator:null,comparatorNullsFirst:null,revision:null,cascade:Bt.All,load:Wt.None,allComplete:!1,loadRelations:!0,autoRefresh:!0,cache:qt.All,fullSave:!1,fullPublish:!1,encodings:{},decodings:{},prepare:_,encode:Ie,decode:Fe,resolveModel:Pe,resolveModels:Ke,summarize:Ce,createRest:ke,createStore:Ue,createLive:He};c(Ne.prototype,{setStoreEnabled:function(e){e?this.storeDisabled&&(this.store=this.storeDisabled,this.storeDisabled=!1):this.storeDisabled||(this.storeDisabled=this.store,this.store=ye.defaultStore(this))},setRestEnabled:function(e){e?this.restDisabled&&(this.rest=this.restDisabled,this.restDisabled=!1):this.restDisabled||(this.restDisabled=this.rest,this.rest=ye.defaultRest(this))},setLiveEnabled:function(e){e?this.liveDisabled&&(this.live=this.liveDisabled,this.liveDisabled=!1):this.liveDisabled||(this.liveDisabled=this.live,this.live=ye.defaultLive(this))},ready:function(e,t,i){return this.readyPromise.success(e,t,i)},hasData:function(e){if(!M(e))return!1;for(var t in e)if(!this.ignoredFields[t])return!0;return!1},grabModel:function(e,t,i,n){function s(){var t=r.parseModel(e,n);if(t!==!1&&!o.isComplete()&&r.initialized){var i=r.remoteLoaded||!r.hasLoad(Wt.All),s=null===t||!t.$isSaved(),a=r.hasLoad(Wt.Lazy);a&&i&&s?(t||(t=r.keyHandler.buildObjectFromKey(r.keyHandler.buildKeyFromInput(e))),t.$once(Ve.Events.RemoteGets,function(){o.isComplete()||(M(e)&&t.$set(e),o.resolve(t.$isSaved()?t:null))}),t.$refresh()):o.resolve(t)}return!o.isComplete()}var r=this,o=new it;return o.success(t,i||r),s()&&r.ready(s,r,!0),o},parseModel:function(e,t){var i=this,n=i.keyHandler,s=i.remoteLoaded||!i.hasLoad(Wt.All);if(!O(e))return s?null:!1;E(e)&&(e=new e),m(e)&&(e=e());var r=n.buildKeyFromInput(e);if(e instanceof i.Model)return e;if(r in i.all){var o=i.all[r];return M(e)&&(n.buildKeyFromRelations(e),t?i.putRemoteData(e,r,o):o.$set(e)),o}return M(e)?(n.buildKeyFromRelations(e),t?i.putRemoteData(e):i.instantiate(i.decode(e))):s?null:!1},updated:function(){this.sort(),this.trigger(Ne.Events.Updated)},setRevision:function(e){m(e)?this.revisionFunction=e:$(e)?this.revisionFunction=function(i,n){var s=M(i)&&e in i?i[e]:t,r=M(n)&&e in n?n[e]:t;return s===t||r===t?!1:Y(s,r)>0}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e,t){this.models.setComparator(e,t)},addComparator:function(e,t){this.models.addComparator(e,t)},setSummarize:function(e){m(e)?this.summarize=e:$(e)?n(this.fields,e)!==!1?this.summarize=function(t){return O(t)?t[e]:t}:this.summarize=he(e):this.summarize=function(e){return e.$key()}},sort:function(){this.models.sort()},isSorted:function(){return this.models.isSorted()},clean:function(){var e=this,t=e.models.keys,i=e.models;e.all={};for(var n=0;n<t.length;n++)e.all[t[n]]=i[n]},putRemoteData:function(e,t,i,n){if(!M(e))return i;var s=this,t=t||s.keyHandler.getKey(e,!0);if(!O(t))return void ye.debug(ye.Debugs.MISSING_KEY,s,e);var i=i||s.all[t],r=s.decode(ie(e));if(i){var o=this.revisionFunction(i,e);if(o)return ye.debug(ye.Debugs.SAVE_OLD_REVISION,s,i,e),i}if(i){s.keyHandler.hasKeyChange(i,r)&&(t=i.$setKey(s.keyHandler.getKey(r,!0))),s.all[t]=i,i.$saved||(i.$saved={});var a=i.$toJSON(!0),u={},h=!1,l={},d={},c={},f=I(i.$saved),v=s.relations;for(var g in e)if("$"!==g.charAt(0))if(g in v)i.$set(g,e[g],!0);else{var p=a[g],m=i.$saved[g];d[g]=i[g],c[g]=m,f||n||V(p,m)?(i[g]=r[g],l[g]=e[g],i.$local&&(i.$local[g]=e[g])):(u[g]=e[g],h=!0),i.$saved[g]=ie(e[g])}h?i.$trigger(Ve.Events.PartialUpdate,[e,l,d,c,u]):i.$trigger(Ve.Events.FullUpdate,[e,l,d,c,u]),i.$trigger(Ve.Events.RemoteUpdate,[e,l,d,c,u]),i.$addOperation(dt),s.models.has(t)||(s.models.put(t,i),s.trigger(Ne.Events.ModelAdded,[i,!0]))}else i=s.createModel(r,!0),i&&(s.cache===qt.All?(i.$local=i.$toJSON(!1),i.$local.$status=i.$status,i.$saved=i.$local.$saved=i.$toJSON(!0),i.$addOperation(dt)):i.$saved=i.$toJSON(!0));return i},createModel:function(e,t){var i=this,n=i.instantiate(e,t);if(n.$invalid===!0)return void ye.debug(ye.Debugs.MISSING_KEY,i,e);var s=n.$key();return i.models.has(s)||(i.models.put(s,n),i.trigger(Ne.Events.ModelAdded,[n,t])),n},destroyModel:function(e,t){var i=this,n=t||e.$key();delete i.all[n],i.models.remove(n),i.trigger(Ne.Events.ModelRemoved,[e]),e.$trigger(Ve.Events.RemoteAndRemove),ye.debug(ye.Debugs.REMOTE_REMOVE,i,e)},destroyLocalUncachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,i.keyHandler.removeKey(e),e.$trigger(Ve.Events.Detach),!1):(i.destroyModel(e,t),!0):!1},destroyLocalCachedModel:function(e,t){var i=this;return e?e.$hasChanges()?(delete e.$saved,i.keyHandler.removeKey(e),e.$local&&(delete e.$local.$saved,i.keyHandler.removeKey(e.$local)),e.$trigger(Ve.Events.Detach),e.$addOperation(dt),!1):(e.$addOperation(ut),i.destroyModel(e,t),!0):(i.store.remove(t,function(e){e&&ye.debug(ye.Debugs.REMOTE_REMOVE,i,e)}),!1)},destroyLocalModel:function(e){var t=this,i=t.all[e];return t.cache===qt.All?t.destroyLocalCachedModel(i,e):t.destroyLocalUncachedModel(i,e)},loadFinish:function(){var e=this;Te(function(){for(var t in e.loaded){var i=e.loaded[t];i.$status===Ve.Status.RemovePending?(ye.debug(ye.Debugs.LOCAL_RESUME_DELETE,e,i),i.$addOperation(ht)):(i.$status===Ve.Status.SavePending?(ye.debug(ye.Debugs.LOCAL_RESUME_SAVE,e,i),i.$addOperation(ct)):ye.debug(ye.Debugs.LOCAL_LOAD_SAVED,e,i),e.models.put(t,i,!0))}}),e.loaded={},e.updated(),e.hasLoad(Wt.All)&&(0===e.pendingOperations?e.refresh():e.firstRefresh=!0)},hasLoad:function(e){return 0!==(this.load&e)},loadBegin:function(e){function t(t,i){ye.debug(ye.Debugs.LOCAL_LOAD,n,t);for(var s=0;s<t.length;s++){var r=t[s],o=i[s],a=n.decode(ie(r,!0)),u=n.instantiate(a,!0);if(u.$invalid===!0){ye.debug(ye.Debugs.MISSING_KEY,n,r);break}u.$local=r,u.$saved=r.$saved,u.$status!==Ve.Status.Removed&&(n.loaded[o]=u,n.all[o]=u)}n.localLoaded=!0,n.triggerLoad(Ne.Events.LocalLoad),e(!0,n)}function i(){n.loadNone(),e(!1,n)}var n=this;n.hasLoad(Wt.All)&&n.autoRefresh&&ye.after(ye.Events.Online,n.onOnline,n),n.cache===qt.None?(n.loadNone(),e(!1,n)):n.store.all(t,i)},triggerLoad:function(e,t){var i=this;i.initialized=!0,i.trigger(e,[i].concat(t||[])),i.readyPromise.reset().resolve(i)},loadNone:function(){var e=this;e.hasLoad(Wt.All)?e.refresh():e.triggerLoad(Ne.Events.NoLoad)},onOnline:function(){var e=this;e.afterOnline=!0,0===e.pendingOperations&&e.onOperationRest()},onOperationRest:function(){var e=this;(e.autoRefresh&&e.remoteLoaded&&e.afterOnline||e.firstRefresh)&&(e.afterOnline=!1,e.firstRefresh=!1,ye.debug(ye.Debugs.AUTO_REFRESH,e),e.refresh())},handleRefreshSuccess:function(e){var t=this;return function(i){for(var n=t.resolveModels(i),s={},r=0;r<n.length;r++){var o=t.putRemoteData(n[r]);if(o){var a=o.$key();s[a]=o}}if(t.allComplete)for(var u=t.models.keys().slice(),r=0;r<u.length;r++){var h=u[r];if(!(h in s)){var l=t.models.get(h);l.$saved&&(ye.debug(ye.Debugs.REMOTE_LOAD_REMOVE,t,h),t.destroyLocalModel(h))}}t.remoteLoaded=!0,t.triggerLoad(Ne.Events.RemoteLoad),t.updated(),ye.debug(ye.Debugs.REMOTE_LOAD,t,n),e.resolve(t.models)}},handleRefreshFailure:function(e){var t=this;return function(i,n){0===n?(ye.checkNetworkStatus(),ye.online||(t.pendingRefresh=!0,ye.once(ye.Events.Online,t.onRefreshOnline,t)),ye.debug(ye.Debugs.REMOTE_LOAD_OFFLINE,t)):(ye.debug(ye.Debugs.REMOTE_LOAD_ERROR,t,n),t.triggerLoad(Ne.Events.NoLoad,[i])),e.reject(t.models)}},executeRefresh:function(e,t){this.rest.all(e,t)},refresh:function(e,t){var i=this,n=new it,s=this.handleRefreshSuccess(n),r=this.handleRefreshFailure(n);
return n.complete(e,t||i),Te(function(){i.executeRefresh(s,r)}),n},onRefreshOnline:function(){var e=this;ye.debug(ye.Debugs.REMOTE_LOAD_RESUME,e),e.pendingRefresh&&(e.pendingRefresh=!1,e.refresh())},get:function(e){return this.all[this.keyHandler.buildKeyFromInput(e)]},filter:function(e){var t=this.all,i=[];for(var n in t){var s=t[n];e(s)&&i.push(s)}return i},liveSave:function(e,t){this.putRemoteData(t,e),this.updated(),ye.debug(ye.Debugs.REALTIME_SAVE,this,t,e)},liveRemove:function(e){this.destroyLocalModel(e)&&this.updated(),ye.debug(ye.Debugs.REALTIME_REMOVE,this,e)},instantiate:function(e,t){return new this.Model(e,t)},addReference:function(e){this.all[e.$key()]=e},save:function(e,t){var i=this;if(e.$isDeleted())return void ye.debug(ye.Debugs.SAVE_DELETED,i,e);var n=e.$key(),s=i.models.has(n);s?(i.trigger(Ne.Events.ModelUpdated,[e]),e.$trigger(Ve.Events.UpdateAndSave)):(i.models.put(n,e),i.trigger(Ne.Events.ModelAdded,[e]),i.updated(),e.$trigger(Ve.Events.CreateAndSave)),e.$addOperation(lt,t)},remove:function(e,t){var i=this;this.removeFromModels(e),e.$status===Ve.Status.SavePending&&ye.debug(ye.Debugs.REMOVE_CANCEL_SAVE,i,e),e.$status=Ve.Status.RemovePending,e.$addOperation(at,t)},removeFromModels:function(e){var t=this,i=e.$key();t.models.has(i)&&(t.models.remove(i),t.trigger(Ne.Events.ModelRemoved,[e]),t.updated(),e.$trigger(Ve.Events.Removed))}}),G(Ne.prototype),x(Ne.prototype,"change",Ne.Events.Changes),Ve.Events={Created:"created",Saved:"saved",PreSave:"pre-save",PostSave:"post-save",PreRemove:"pre-remove",PostRemove:"post-remove",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",Change:"change",CreateAndSave:"created saved",UpdateAndSave:"updated saved",KeyUpdate:"key-update",RelationUpdate:"relation-update",Removed:"removed",RemoteUpdate:"remote-update",LocalSave:"local-save",LocalSaveFailure:"local-save-failure",LocalSaves:"local-save local-save-failure",RemoteSave:"remote-save",RemoteSaveFailure:"remote-save-failure",RemoteSaveOffline:"remote-save-offline",RemoteSaves:"remote-save remote-save-failure remote-save-offline",LocalRemove:"local-remove",LocalRemoveFailure:"local-remove-failure",LocalRemoves:"local-remove local-remove-failure",RemoteRemove:"remote-remove",RemoteRemoveFailure:"remote-remove-failure",RemoteRemoveOffline:"remote-remove-offline",RemoteRemoves:"remote-remove remote-remove-failure remote-remove-offline",LocalGet:"local-get",LocalGetFailure:"local-get-failure",LocalGets:"local-get local-get-failure",RemoteGet:"remote-get",RemoteGetFailure:"remote-get-failure",RemoteGetOffline:"remote-get-offline",RemoteGets:"remote-get remote-get-failure remote-get-offline",RemoteAndRemove:"remote-remove removed",SavedRemoteUpdate:"saved remote-update",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",KeyChange:"key-change",Changes:"saved remote-update key-update relation-update removed key-change change"},Ve.Status={Synced:0,SavePending:1,RemovePending:2,Removed:3},Ve.Blocked={toString:!0,valueOf:!0},c(Ve.prototype,{$init:function(e,i){if(this.$status=Ve.Status.Synced,this.$operation=null,this.$relations={},this.$dependents=new xe(this),i){var n=this.$db.keyHandler.getKey(e,!0);if(!O(n))return void(this.$invalid=!0);this.$db.all[n]=this,this.$set(e,t,i)}else this.$reset(e);if(this.$db.loadRelations){var s=this.$db.relations;for(var r in s){var o=s[r];o.lazy||this.$getRelation(r,t,i)}}},$load:function(e){if(A(e))for(var t=0;t<e.length;t++)this.$getRelation(e[t]);else if($(e))this.$getRelation(e);else{var i=this.$db.relations;for(var n in i)this.$getRelation(n)}},$reset:function(e){var i=this.$db.defaults,n=this.$db.fields,s=this.$db.relations,r=this.$db.keyHandler,o=this.$db.key;if(I(i))for(var a=0;a<n.length;a++){var u=n[a];this[u]=t}else for(var a=0;a<n.length;a++){var u=n[a],h=i[u],l=F(h);this[u]=l}var d=null;if(e&&(d=r.getKey(e,!0)),O(d)?J(this,o,e,o):d=r.getKey(this),O(d)&&(this.$db.all[d]=this,this.$$key=d),!I(i))for(var u in s)if(u in i){var h=i[u],l=F(h),c=!!this.$relations[u],f=this.$getRelation(u,l);c&&f.set(this,l)}this.$set(e)},$set:function(e,t,i,n){if(M(e))for(var s in e)this.$set(s,e[s],i,!0);else if($(e)){if(Ve.Blocked[e])return;var r=this.$getRelation(e,t,i);r?r.set(this,t,i):this[e]=t}!n&&O(e)&&this.$trigger(Ve.Events.Change,[e,t])},$get:function(e,t){if(A(e))return j(this,e,t);if(M(e)){for(var i in e)e[i]=t?ie(this[i]):this[i];return e}if($(e)){if(Ve.Blocked[e])return;var n=this.$getRelation(e);if(n){var s=n.get(this);return t?ie(s):s}return t?ie(this[e]):this[e]}},$decode:function(){this.$db.decode(this)},$relate:function(e,t){var i=this.$getRelation(e);i&&i.relate(this,t)},$unrelate:function(e,t){var i=this.$getRelation(e);i&&i.unrelate(this,t)},$isRelated:function(e,t){var i=this.$getRelation(e);return i&&i.isRelated(this,t)},$getRelation:function(e,t,i){var n=this.$db.relations,s=n[e];return s?(e in this.$relations||s.load(this,t,i),s):!1},$save:function(e,t,i){var i=3===arguments.length?i:2===arguments.length&&M(e)&&y(t)?t:1===arguments.length&&y(e)?e:this.$db.cascade;if(this.$isDeleted())return ye.debug(ye.Debugs.SAVE_DELETED,this.$db,this),it.resolve(this);if(!this.$hasKey())throw"Key missing from model";var n=we(this,i,Ve.Events.RemoteSave,Ve.Events.RemoteSaveFailure,Ve.Events.RemoteSaveOffline,Ve.Events.LocalSave,Ve.Events.LocalSaveFailure);return it.singularity(n,this,function(n){Te(function(){this.$db.addReference(this),this.$set(e,t),this.$trigger(Ve.Events.PreSave,[this]),this.$db.save(this,i),this.$trigger(Ve.Events.PostSave,[this])},this)})},$remove:function(e){var e=y(e)?e:this.$db.cascade;if(!this.$exists())return it.resolve(this);var t=we(this,e,Ve.Events.RemoteRemove,Ve.Events.RemoteRemoveFailure,Ve.Events.RemoteRemoveOffline,Ve.Events.LocalRemove,Ve.Events.LocalRemoveFailure);return it.singularity(t,this,function(t){Te(function(){this.$trigger(Ve.Events.PreRemove,[this]),this.$db.remove(this,e),this.$trigger(Ve.Events.PostRemove,[this])},this)})},$refresh:function(e){var t=we(this,e,Ve.Events.RemoteGet,Ve.Events.RemoteGetFailure,Ve.Events.RemoteGetOffline,Ve.Events.LocalGet,Ve.Events.LocalGetFailure);return Re(e,Bt.Rest)?this.$addOperation(rt,e):Re(e,Bt.Local)?this.$addOperation(st,e):t.resolve(this),t},$autoRefresh:function(){return ye.on(ye.Events.Online,this.$refresh,this),this},$cancel:function(e){this.$saved?this.$save(this.$saved):e&&this.$reset()},$clone:function(e){for(var t=this.$db,i=t.key,n=t.fields,s=t.relations,r={},o=0;o<n.length;o++){var a=n[o];e&&a in e?r[a]=F(e[a]):a in this&&(r[a]=ie(this[a]))}$(i)&&delete r[i];var u=t.keyHandler.getKey(r),h=this.$key();if(u===h)throw"A clone cannot have the same key as the original model.";for(var l in s)e&&l in e&&s[l].preClone(this,r,e[l]);var d=t.instantiate(r),c={};for(var l in s)e&&l in e&&s[l].postClone(this,c,e[l]);return d.$set(c),d},$push:function(e){this.$savedState=this.$db.encode(this,j(this,e||this.$db.fields,!0),!1)},$pop:function(e){M(this.$savedState)&&(this.$set(this.$savedState),e||this.$discard())},$discard:function(){delete this.$savedState},$exists:function(){return!this.$isDeleted()&&this.$db.models.has(this.$key())},$addOperation:function(e,t){var i=new e(this,t);this.$operation?this.$operation.queue(i):(this.$operation=i,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(this,j(this,this.$db.fields,!0),e),i=this.$db.relations,n=this.$relations;for(var s in n)i[s].encode(this,t,e);return t},$changed:function(){this.$trigger(Ve.Events.Change)},$key:function(e){return this.$$key||(this.$$key=this.$db.keyHandler.getKey(this,e)),this.$$key},$keys:function(){return this.$db.keyHandler.getKeys(this)},$uid:function(){return this.$db.name+"$"+this.$key()},$hasKey:function(){return B(this,this.$db.key,O)},$setKey:function(e,t){var i=this.$db,n=i.keyHandler.buildKeyFromInput(e),s=this.$$key;if(n!==s){if(!i.keyChanges)throw"Key changes are not supported, see the documentation on how to enable key changes.";delete i.all[s],i.all[n]=this,this.$$key=n,t||i.keyHandler.applyKey(n,this),this.$trigger(Ve.Events.KeyChange,[this,s,n])}return n},$isSynced:function(){return this.$status===Ve.Status.Synced},$isSaving:function(){return this.$status===Ve.Status.SavePending},$isPending:function(){return this.$status===Ve.Status.SavePending||this.$status===Ve.Status.RemovePending},$isDeleted:function(){return this.$status>=Ve.Status.RemovePending},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(e){var t=this.$saved,i=e||this.$toJSON(!0),n=this.$db.saveFields;return t?ne(i,t,n,V):i},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$db.ignoredFields,t=this.$toJSON(!0),i=this.$saved;for(var n in t){var s=t[n],r=i[n];if(!e[n]&&!V(s,r))return!0}return!1},$listenForOnline:function(e){this.$offline||(this.$offline=!0,ye.once(ye.Events.Online,this.$resume,this)),this.$resumeCascade=e},$resume:function(){this.$status===Ve.Status.RemovePending?(ye.debug(ye.Debugs.REMOVE_RESUME,this),this.$addOperation(ht,this.$resumeCascade)):this.$status===Ve.Status.SavePending&&(ye.debug(ye.Debugs.SAVE_RESUME,this),this.$addOperation(ct,this.$resumeCascade)),this.$offline=!1},toString:function(){return this.$db.className+" "+JSON.stringify(this.$toJSON())}}),G(Ve.prototype,!0),x(Ve.prototype,"$change",Ve.Events.Changes,!0),c(Ye.prototype,{reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,wt.push.call(this.values,t),wt.push.call(this.keys,e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return y(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],i=wt.pop.apply(this.values),n=wt.pop.apply(this.keys);return e<this.values.length&&(this.values[e]=i,this.keys[e]=n,this.indices[n]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},subtract:function(e,t){for(var i=t||new Ye,n=this.size(),s=this.values,r=this.keys,o=0;n>o;o++){var a=s[o],u=r[o];e.has(u)||i.put(u,a)}return i},filter:function(e,t){for(var i=t||new Ye,n=this.size(),s=this.values,r=this.keys,o=0;n>o;o++){var a=s[o],u=r[o];e(a,u)&&i.put(u,a)}return i},reverse:function(){return o(this.values),o(this.keys),this.rebuildIndex(),this},isSorted:function(e){return a(e,this.values)},sort:function(e){function t(t,i){for(var s=n.values[Math.floor((i+t)/2)],o=t,a=i;a>=o;){for(;e(n.values[o],s)<0;)o++;for(;e(n.values[a],s)>0;)a--;a>=o&&(r(n.values,o,a),r(n.keys,o,a),o++,a--)}return o}function i(e,n){var s=t(e,n);s-1>e&&i(e,s-1),n>s&&i(s,n)}var n=this,s=this.size()-1;return s>0&&(i(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}}),xe.prototype={add:function(e,t){var i=e.$uid();if(this.map[i]=e,e.$db.keyChanges&&!this.listeners[i]){var n=this.handleKeyChange(t);this.listeners[i]=e.$on(Ve.Events.KeyChange,n,this)}},remove:function(e){var t=e.$uid();F(this.listeners[t]),delete this.listeners[t],delete this.map[t]},handleKeyChange:function(e){return function(t,i,n){var s=t.$db.name+"$";i=s+i,n=s+n,this.listeners[n]=this.listeners[i],this.map[n]=this.map[i],delete this.listeners[i],delete this.map[i],e.updateForeignKey(this.subject,t,!0)}},isSaved:function(e,t){var i=this.map,n=_,s=function(){e.apply(t||this,arguments),n()};for(var r in i){var o=i[r];if(!o.$isSaved())return n=o.$once(Ve.Events.RemoteSaves,s),!1}return!0}},Ge.prototype={init:function(e){this.key=e.key,this.keySeparator=e.keySeparator,this.database=e},getKey:function(e,t){var i=this.key,n=this.buildKey(e,i);if(B(e,i,O))return n;if(!t)throw"Composite key not supplied.";return null},buildKeyFromRelations:function(e){if(M(e)){var t=this.database.relations;for(var i in t)i in e&&t[i].buildKey(e)}},buildKeyFromInput:function(e){return e instanceof this.database.Model?e.$key():A(e)?e.join(this.keySeparator):M(e)?this.buildKey(e):e}},h(Ge,ze,{getKeys:function(e){return this.buildKey(e)},removeKey:function(e){var t=this.key;delete e[t]},buildKey:function(e,t){this.buildKeyFromRelations(e);var i=t||this.key,n=e[i];return O(n)||(n=e[i]=T()),n},buildObjectFromKey:function(e){var t=this.key,i={};return i[t]=e,this.database.instantiate(i)},hasKeyChange:function(e,t){var i=this.key,n=e[i],s=t[i];return O(n)&&O(s)&&n!==s},addToFields:function(e){var t=this.key;n(e,t)===!1&&e.unshift(t)},isValid:function(e){return O(e)},copyFields:function(e,t,i,n){var s=e[t],r=i[n];!O(s)&&O(r)&&(e[t]=ie(r))},inKey:function(e){if(A(e)){for(var t=0;t<e.length;t++)if(e[t]===this.key)return!0;return!1}return e===this.key},setKeyField:function(e,t,i,n){t===n&&(e[t]=i[this.key])},applyKey:function(e,t){t[this.key]=e}}),h(Ge,Qe,{getKeys:function(e,t){return this.buildKeyFromRelations(e),W(e,t||this.key)},removeKey:function(e){for(var t=this.key,i=0;i<t.length;i++)delete e[t[i]]},buildKey:function(e,t){return this.getKeys(e,t).join(this.keySeparator)},buildObjectFromKey:function(e){var t=this.key,i={};$(e)&&(e=e.split(this.keySeparator));for(var n=0;n<t.length;n++)i[t[n]]=e[n];return this.database.instantiate(i)},hasKeyChange:function(e,t){for(var i=this.key,n=0;n<i.length;n++){var s=e[i[n]],r=t[i[n]];if(O(s)&&O(r)&&s!==r)return!0}return!1},addToFields:function(e){for(var t=this.key,i=t.length-1;i>=0;i--)n(e,t[i])===!1&&e.unshift(t[i])},isValid:function(e){return O(e)},copyFields:function(e,t,i,n){for(var s=0;s<t.length;s++){var r=e[t[s]],o=i[n[s]];!O(r)&&O(o)&&(e[t[s]]=ie(o))}},inKey:function(e){if(A(e)){for(var t=0;t<e.length;t++)if(n(this.key,e[t])!==!1)return!0;return!1}return n(this.key,e)!==!1},setKeyField:function(e,t,i,s){var r=n(s);r!==!1&&(e[t]=i[this.key[r]])},applyKey:function(e,t){var i=this.key;$(e)&&(e=e.split(this.keySeparator));for(var n=0;n<i.length;n++)t[i[n]]=e[n]}}),Be.Events={Add:"add",Adds:"adds",Sort:"sort",Remove:"remove",Removes:"removes",Updates:"updates",Reset:"reset",Cleared:"cleared",Changes:"add adds sort remove removes updates reset cleared"},l(Array,Be,{setComparator:function(e,t){return this.comparator=U(e,t),this.sort(),this},addComparator:function(e,t){return this.comparator=k(this.comparator,e,t),this.sort(),this},isSorted:function(e,t){var i=e?U(e,t):this.comparator;return a(i,this)},sort:function(e,t,i){var n=e?U(e,t):this.comparator;return a(n,this)&&(i||n||!u(this))||(wt.sort.call(this,n),this.trigger(Be.Events.Sort,[this])),this},reset:function(e){return this.length=0,A(e)?wt.push.apply(this,e):O(e)&&wt.push.call(this,e),this.trigger(Be.Events.Reset,[this]),this.sort(t,t,!0),this},page:function(e,t){return new qe(this,e,t)},filtered:function(e,t,i){var n=$e(e,t,i);return new Je(this,n)},where:function(e,t,i,n){for(var s=$e(e,t,i),r=n||this.cloneEmpty(),o=0;o<this.length;o++){var a=this[o];s(a)&&r.push(a)}return r},subtract:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||H,r=0;r<this.length;r++){for(var o=this[r],a=!1,u=0;u<e.length&&!a;u++)a=s(o,e[u]);a||n.push(o)}return n},intersect:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||H,r=0;r<e.length;r++){for(var o=e[r],a=!1,u=0;u<this.length&&!a;u++)a=s(o,this[u]);a&&n.push(o)}return n},complement:function(e,t,i){for(var n=t||this.cloneEmpty(),s=i||H,r=0;r<e.length;r++){for(var o=e[r],a=!1,u=0;u<this.length&&!a;u++)a=s(o,this[u]);a||n.push(o)}return n},clear:function(){return this.length=0,this.trigger(Be.Events.Cleared,[this]),this},add:function(e,i){return wt.push.call(this,e),this.trigger(Be.Events.Add,[this,e]),i||this.sort(t,t,!0),this},push:function(){var e=arguments;return wt.push.apply(this,e),this.trigger(Be.Events.Adds,[this,wt.slice.apply(e)]),this.sort(t,t,!0),this.length},unshift:function(){var e=arguments;return wt.unshift.apply(this,e),this.trigger(Be.Events.Adds,[this,wt.slice.apply(e)]),this.sort(t,t,!0),this.length},addAll:function(e,i){return A(e)&&e.length&&(wt.push.apply(this,e),this.trigger(Be.Events.Adds,[this,e]),i||this.sort(t,t,!0)),this},insertAt:function(e,i,n){return wt.splice.call(this,e,0,i),this.trigger(Be.Events.Add,[this,i]),n||this.sort(t,t,!0),this},pop:function(e){var i=wt.pop.apply(this),n=this.length;return this.trigger(Be.Events.Remove,[this,i,n]),e||this.sort(t,t,!0),i},shift:function(e){var i=wt.shift.apply(this);return this.trigger(Be.Events.Remove,[this,i,0]),e||this.sort(t,t,!0),i},removeAt:function(e,i){var n;return e>=0&&e<this.length&&(n=this[e],wt.splice.call(this,e,1),this.trigger(Be.Events.Remove,[this,n,e]),i||this.sort(t,t,!0)),n},remove:function(e,t,i){var n=this.indexOf(e,i),s=this[n];return-1!==n&&this.removeAt(n,t),s},removeAll:function(e,i,n){var s=[];if(A(e)&&e.length){for(var r=0;r<e.length;r++){var o=e[r],a=this.indexOf(o,n);-1!==a&&(wt.splice.call(this,a,1),s.push(o))}this.trigger(Be.Events.Removes,[this,s]),i||this.sort(t,t,!0)}return s},removeWhere:function(e,i,n,s,r){for(var o=$e(e,i,n),a=s||this.cloneEmpty(),u=this.length-1;u>=0;u--){var h=this[u];o(h)&&(wt.splice.call(this,u,1),a.push(h))}return this.trigger(Be.Events.Removes,[this,a]),r||this.sort(t,t,!0),a},splice:function(e,i){var n=wt.slice.call(arguments,2),s=wt.splice.apply(this,arguments);return i&&this.trigger(Be.Events.Removes,[this,s]),n.length&&this.trigger(Be.Events.Adds,[this,n]),this.sort(t,t,!0),s},reverse:function(){return wt.reverse?wt.reverse.apply(this):o(this),this.trigger(Be.Events.Updates,[this]),this},indexOf:function(e,t){for(var i=t||H,n=0;n<this.length;n++)if(i(e,this[n]))return n;return-1},minModel:function(e,t){for(var i=U(e||this.comparator,!1),n=t,s=0;s<this.length;s++)i(n,this[s])>0&&(n=this[s]);return n},maxModel:function(e,t){for(var i=U(e||this.comparator,!0),n=t,s=0;s<this.length;s++)i(n,this[s])<0&&(n=this[s]);return n},min:function(e,t,i){for(var n=i||Y,s=ve(e),r=t,o=0;o<this.length;o++){var a=s(this[o]);n(r,a,!1)>0&&(r=a)}return r},max:function(e,t,i){for(var n=i||Y,s=ve(e),r=t,o=0;o<this.length;o++){var a=s(this[o]);n(r,a,!0)<0&&(r=a)}return r},firstWhere:function(e,t,i){for(var n=$e(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return r}return null},first:function(e){for(var t=ve(e),i=0;i<this.length;i++){var n=t(this[i]);if(O(n))return n}},lastWhere:function(e,t,i){for(var n=$e(e,t,i),s=this.length-1;s>=0;s--){var r=this[s];if(n(r))return r}return null},last:function(e){for(var t=ve(e),i=this.length-1;i>=0;i--){var n=t(this[i]);if(O(n))return n}},aggregate:function(e,t,i,n){for(var s=0;s<this.length;s++){var r=e(this[s]);t(r)&&i(r)}return n()},sum:function(e){function t(e){s+=e}function i(){return s}var n=ce(e),s=0;return this.aggregate(n,y,t,i)},avg:function(e){function t(e){s+=e,r++}function i(){return 0===r?0:s/r}var n=ce(e),s=0,r=0;return this.aggregate(n,y,t,i)},countWhere:function(e,t,i){for(var n=$e(e,t,i),s=0,r=0;r<this.length;r++){var o=this[r];n(o)&&s++}return s},count:function(e){if(!O(e))return this.length;for(var t=ve(e),i=0,n=0;n<this.length;n++){var s=t(this[n]);O(s)&&i++}return i},pluck:function(e,t){var i=ve(e);if(t){for(var n=ve(t),s={},r=0;r<this.length;r++){var o=this[r],a=i(o),u=n(o);s[u]=a}return s}for(var s=[],r=0;r<this.length;r++){var o=this[r],a=i(o);s.push(a)}return s},each:function(e,t){for(var i=0;i<this.length;i++){var n=this[i];e.call(t,n,i),this[i]!==n&&i--}return this},eachWhere:function(e,t,i,n){for(var s=$e(t,i,n),r=0;r<this.length;r++){var o=this[r];s(o)&&(e.call(this,o,r),this[r]!==o&&r--)}return this},reduce:function(e,t){for(var i=0;i<this.length;i++)t=e(t,this[i]);return t},random:function(){var e=Math.floor(Math.random()*this.length);return this[e]},chunk:function(e,t){for(var i=t||[],n=0,s=i[n]=i[n]||[],r=0,o=0;o<this.length;o++)s[r]=this[o],++r>=e&&(r=0,n++,s.length=e,s=i[n]=i[n]||[]);return 0!==r&&n++,s.length=r,i.length=n,i},contains:function(e,t,i){for(var n=$e(e,t,i),s=0;s<this.length;s++){var r=this[s];if(n(r))return!0}return!1},group:function(e){var t=ve(e.by),i=$e(e.having,e.havingValue,e.havingEquals),n=e.select||{},s={};if($(e.by))e.by in n||(n[e.by]="first");else if(A(e.by))for(var r in e.by)r in n||(n[r]="first");for(var o=0;o<this.length;o++){var a=this[o],u=t(a),h=s[u];h||(h=s[u]=this.cloneEmpty()),h.add(a,!0)}var l=this.cloneEmpty();l.setComparator(e.comparator,e.comparatorNullsFirst);for(var u in s){var d={},c=s[u];for(var f in n){var v=n[f];$(v)?d[f]=c[v](f):m(v)&&(d[f]=v(c,f))}e.track!==!1&&(d.$group=c),e.count!==!1&&(d.$count=c.length),i(d,c)&&l.push(d)}return l.sort(),l},toArray:function(){return this.slice()},clone:function(){return new this.constructor(this)},cloneEmpty:function(){return new this.constructor}}),G(Be.prototype),x(Be.prototype,"change",Be.Events.Changes);var si={bind:function(){this.onAdd=D(this,si.handleAdd),this.onAdds=D(this,si.handleAdds),this.onRemove=D(this,si.handleRemove),this.onRemoves=D(this,si.handleRemoves),this.onReset=D(this,si.handleReset),this.onUpdates=D(this,si.handleUpdates),this.onCleared=D(this,si.handleCleared)},init:function(e,t){return this.base!==e&&(this.base&&this.disconnect(),this.base=e,this.connect()),this.filter=t,this.sync(),this},setFilter:function(e,t,i){return this.filter=$e(e,t,i),this.sync(),this},connect:function(){return this.base.on(Be.Events.Add,this.onAdd),this.base.on(Be.Events.Adds,this.onAdds),this.base.on(Be.Events.Remove,this.onRemove),this.base.on(Be.Events.Removes,this.onRemoves),this.base.on(Be.Events.Reset,this.onReset),this.base.on(Be.Events.Updates,this.onUpdates),this.base.on(Be.Events.Cleared,this.onClear),this},disconnect:function(){return this.base.off(Be.Events.Add,this.onAdd),this.base.off(Be.Events.Adds,this.onAdds),this.base.off(Be.Events.Remove,this.onRemove),this.base.off(Be.Events.Removes,this.onRemoves),this.base.off(Be.Events.Reset,this.onReset),this.base.off(Be.Events.Updates,this.onUpdates),this.base.off(Be.Events.Cleared,this.onClear),this},sync:function(){for(var e=this.base,t=this.filter,i=[],n=0;n<e.length;n++){var s=e[n];t(s)&&i.push(s)}return this.reset(i)},handleAdd:function(e,t){var i=this.filter;i(t)&&this.add(t)},handleAdds:function(e,t){for(var i=this.filter,n=[],s=0;s<t.length;s++){var r=t[s];i(r)&&n.push(r)}this.addAll(n)},handleRemove:function(e,t){this.remove(t)},handleRemoves:function(e,t){this.removeAll(t)},handleReset:function(e){this.sync()},handleUpdates:function(e,t){for(var i=this.filter,n=0;n<t.length;n++){var s=t[n];i(s)?this.add(s,!0):this.remove(s,!0)}this.sort()},handleCleared:function(e){this.clear()},clone:function(){return new this.constructor(this.base,this.filter)},cloneEmpty:function(){return new this.constructor(this.base,this.filter)}};qe.Events={Change:"change",Changes:"change"},l(Array,qe,{setPageSize:function(e){this.pageSize=e,this.handleChanges()},setPageIndex:function(e){this["goto"](e)},setCollection:function(e){e!==this.collection&&(this.collection&&this.disconnect(),this.collection=e,this.connect(),this.handleChanges(!0))},connect:function(){this.collection.on(Be.Events.Changes,this.onChanges)},disconnect:function(){this.collection.off(Be.Events.Changes,this.onChanges)},"goto":function(e){var t=Math.max(0,Math.min(e,this.pageCount-1));t!==this.pageIndex&&(this.pageIndex=t,this.update(),this.trigger(qe.Events.Change,[this]))},next:function(){this["goto"](this.pageIndex+1)},prev:function(){this["goto"](this.pageIndex-1)},jump:function(e){this["goto"](e)},first:function(){this["goto"](0)},last:function(){this["goto"](this.pageCount-1)},handleChanges:function(e){var t=this.collection.length,i=Math.ceil(t/this.pageSize),n=Math.max(0,Math.min(this.pageIndex,i-1)),s=e||this.pageIndex!==n||this.length!==this.pageSize,r=s||this.pageCount!==i;this.pageIndex=n,this.pageCount=i,s&&this.update(),r&&this.trigger(qe.Events.Change,[this])},update:function(){var e=this.collection,t=e.length,i=this.pageIndex*this.pageSize,n=Math.min(i+this.pageSize,t),s=n-i;this.length=0;for(var r=0;s>r;r++)this.push(e[i++])},more:function(e){for(var t=this.collection,i=t.length,n=e||1,s=this.pageIndex*this.pageSize,r=s+this.length,o=this.pageSize*n,a=r+o,u=Math.min(i,a);u>r;)this.push(t[r++])},toArray:function(){return this.slice()}}),G(qe.prototype),x(qe.prototype,"change",qe.Events.Changes),l(Be,Je,{bind:si.bind,init:si.init,setFilter:si.setFilter,connect:si.connect,disconnect:si.disconnect,sync:si.sync,clone:si.clone,cloneEmpty:si.cloneEmpty}),l(Be,je,{init:function(e,t,i){return this.map=new Ye,this.map.values=this,this.database=e,this.reset(t,i),this},sort:function(e,t){var i=e?U(e,t):this.comparator;return a(i,this)||(this.map.sort(i),this.trigger(Be.Events.Sort,[this])),this},buildKeyFromInput:function(e){return this.database.keyHandler.buildKeyFromInput(e)},parseModel:function(e,t){return this.database.parseModel(e,t)},filtered:function(e,t,i){var n=$e(e,t,i);return new We(this,n)},subtract:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<this.length;n++){var s=this[n],r=s.$key(),o=!1;if(e instanceof je)o=e.has(r);else for(var a=0;a<e.length&&!o;a++){var u=this.buildKeyFromInput(e[a]);o=r===u}o||i.push(s)}return i},intersect:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<e.length;n++){var s=e[n],r=this.buildKeyFromInput(s);this.has(r)&&i.push(s)}return i},complement:function(e,t){for(var i=t||this.cloneEmpty(),n=0;n<e.length;n++){var s=e[n],r=this.buildKeyFromInput(s);this.has(r)||i.push(s)}return i},clear:function(){return this.map.reset()},reset:function(e,t){var i=this.map;if(i.reset(),A(e))for(var n=0;n<e.length;n++){var s=e[n],r=this.parseModel(s,t);r&&i.put(r.$key(),r)}else if(M(e)){var r=this.parseModel(e,t);r&&i.put(r.$key(),r)}return this.trigger(Be.Events.Reset,[this]),this.sort(),this},has:function(e){return this.map.has(e)},get:function(e){return this.map.get(e)},put:function(e,t,i){this.map.put(e,t),this.trigger(Be.Events.Add,[this,t]),i||this.sort()},add:function(e,t,i){var n=this.parseModel(e,i);return this.map.put(n.$key(),n),this.trigger(Be.Events.Add,[this,n]),t||this.sort(),this},push:function(){for(var e=arguments,t=0;t<e.length;t++){var i=this.parseModel(e[t]);this.map.put(i.$key(),i)}return this.trigger(Be.Events.Adds,[this,wt.slice.apply(e)]),this.sort(),this.length},unshift:function(){return this.push.apply(this,arguments)},addAll:function(e,t,i){if(A(e)){for(var n=0;n<e.length;n++){var s=this.parseModel(e[n],i);this.map.put(s.$key(),s)}this.trigger(Be.Events.Adds,[this,e]),t||this.sort()}},insertAt:function(e,t,i){return this.add(t,i)},pop:function(e){var t=this.length-1,i=this[t];return this.map.removeAt(t),this.trigger(Be.Events.Remove,[this,i,t]),e||this.sort(),i},shift:function(e){var t=this[0];return this.map.removeAt(0),this.trigger(Be.Events.Remove,[this,t,0]),e||this.sort(),t},removeAt:function(e,t){var i;return e>=0&&e<this.length&&(i=this[e],this.map.removeAt(e),this.trigger(Be.Events.Remove,[this,i,e]),t||this.sort()),i},remove:function(e,t){var i=this.buildKeyFromInput(e),n=this.map.get(i);return n&&(this.map.remove(i),this.trigger(Be.Events.Remove,[this,n,e]),t||this.sort()),n},removeAll:function(e,t){for(var i=this.map,n=[],s=0;s<e.length;s++){var r=this.buildKeyFromInput(e[s]),o=i.get(r);o&&(i.remove(r),n.push(o))}return this.trigger(Be.Events.Removes,[this,n]),t||this.sort(),n},indexOf:function(e){var i=this.buildKeyFromInput(e),n=this.map.indices[i];return n===t?-1:n},rebuild:function(){this.map.rebuildIndex()},keys:function(){return this.map.keys},reverse:function(){return this.map.reverse(),this.trigger(Be.Events.Updates,[this]),this},splice:function(e,t){for(var i=wt.slice.call(arguments,2),n=[e,t],s=0;s<i.length;s++)n.push(this.buildKeyFromInput(i[s]));var r=wt.splice.apply(this,arguments);return wt.splice.apply(this.map.keys,n),t&&this.trigger(Be.Events.Removes,[this,r]),i.length&&this.trigger(Be.Events.Adds,[this,i]),this.sort(),r},removeWhere:function(e,t,i,n,s,r){var o=$e(t,i,n),a=s||this.cloneEmpty();return Te(function(){for(var t=0;t<this.length;t++){var i=this[t],n=i.$key();o(i)&&(this.map.remove(n),a.push(i),t--,e&&i.$remove())}},this),this.trigger(Be.Events.Removes,[this,a]),r||this.sort(),a},update:function(e,t,i,n,s){return Te(function(){for(var s=0;s<this.length;s++){var r=this[s];r.$set(e,t,i),n||r.$save()}},this),this.trigger(Be.Events.Updates,[this,this]),this.sort(),this},updateWhere:function(e,t,i,n,s,r){var o=[];return Te(function(){for(var a=0;a<this.length;a++){var u=this[a];e(u)&&(u.$set(t,i,n),s||u.$save(r),o.push(u))}},this),this.trigger(Be.Events.Updates,[this,o]),this.sort(),o},pushWhere:function(e,t,i,n){function s(t){t.$push(e)}return this.eachWhere(s,t,i,n)},popWhere:function(e,t,i,n){function s(t){t.$pop(e)}return this.eachWhere(s,t,i,n)},discardWhere:function(e,t,i){function n(e){e.$discard()}return this.eachWhere(n,e,t,i)},cancelWhere:function(e,t,i,n){function s(t){t.$cancel(e)}return Te(function(){this.eachWhere(s,t,i,n)},this),this},refreshWhere:function(e,t,i){function n(e){e.$refresh()}return Te(function(){this.eachWhere(n,e,t,i)},this),this},saveWhere:function(e,t,i,n,s){function r(e){e.$save(n,s)}return Te(function(){this.eachWhere(r,e,t,i)},this),this},clone:function(e,t){var i=this;if(e){i=[];for(var n=0;n<this.length;n++)i[n]=this[n].$clone(t)}return new je(this.database,i,!0)},cloneEmpty:function(){return new je(this.database)}}),l(je,We,{bind:function(){si.bind.apply(this),this.onModelUpdated=D(this,this.handleModelUpdate)},init:function(e,t){return this.base&&this.base.database.off(Ne.Events.ModelUpdated,this.onModelUpdated),je.prototype.init.call(this,e.database),si.init.call(this,e,t),e.database.on(Ne.Events.ModelUpdated,this.onModelUpdated),this},setFilter:si.setFilter,connect:si.connect,disconnect:si.disconnect,sync:si.sync,handleModelUpdate:function(e){var t=this.has(e.$key()),i=this.filter(e);t&&!i&&this.remove(e),!t&&i&&this.add(e)},clone:si.clone,cloneEmpty:si.cloneEmpty}),l(je,Xe,{set:function(e){return this.relator.set(this.model,e),this},relate:function(e){return this.relator.relate(this.model,e),this},unrelate:function(e){return this.relator.unrelate(this.model,e),this},unrelateWhere:function(e,t,i){return this.unrelate(this.where(e,t,i,[]))},isRelated:function(e){return this.relator.isRelated(this.model,e)},clone:function(){return new Xe(this.database,this.model,this.relator,this,!0)},cloneEmpty:function(){return new Xe(this.database,this.model,this.relator)}}),et.Defaults={},c(et.prototype,{$getDefaults:function(){return et.Defaults},$init:function(e,t,i,n,s){z(this,i,this.$getDefaults(),!0),this.$append=!1,this.$db=e,this.$url=t,this.$set(n),this.$results=new je(e),this.$promise=it.resolve(this),s&&this.$run()},$set:function(e){return M(e)&&X(e,this),this},$unset:function(){for(var e in this)"$"!==e.charAt(0)&&delete this[e];return this},$run:function(e,t){this.$url=e||this.$url,this.$set(t);var i=this.$encode(),n=D(this,this.$handleSuccess),s=D(this,this.$handleFailure);return Te(function(){this.$cancel(),this.$promise=new it,this.$db.rest.query(this.$url,i,n,s)},this),this.$promise},$handleSuccess:function(e){if(this.$promise.isPending()){var t=this.$decode.apply(this,arguments);this.$append?this.$results.addAll(t,!1,!0):this.$results.reset(t,!0),this.$promise.resolve(this,e,this.$results)}},$handleFailure:function(e,t){if(this.$promise.isPending()){var i=Xt.Offline[t];i&&(ye.checkNetworkStatus(),i=!ye.online),i?this.$promise.noline(this,e,t):this.$promise.reject(this,e,t)}},$cancel:function(){this.$promise.cancel()},$clear:function(){this.$results.clear()},$encode:function(){return te(ie(this))},$decode:function(e){return e},$key:function(){return""},$change:function(e,t){return this.$results.change(e,t)}}),tt.Defaults={page_size:10,page_index:0,total:0},h(et,tt,{$getDefaults:function(){return tt.Defaults},$goto:function(e,t){var i=this.$getPageIndex(),n=this.$getPageCount(),s=Math.max(0,Math.min(e,n-1));return i!==s&&(this.$setPageIndex(s),t||(this.$append=!1,this.$run())),this.$promise},$more:function(){var e=this.$getPageIndex()+1;return e<this.$getPageCount()&&(this.$setPageIndex(e),this.$append=!0,this.$run(),this.$promise.complete(this.$onMoreEnd,this)),
this.$promise},$onMoreEnd:function(){this.$append=!1},$first:function(e){return this.$goto(0,e)},$last:function(e){return this.$goto(this.$getPageCount()-1,e)},$prev:function(e){return this.$goto(this.$getPageIndex()-1,e)},$next:function(e){return this.$goto(this.$getPageIndex()+1,e)},$decode:function(e){return this.$updatePageSize(e),this.$updatePageIndex(e),this.$updateTotal(e),this.$decodeResults(e)},$decodeResults:function(e){return e.results},$updatePageSize:function(e){y(e.page_size)&&(this.page_size=e.page_size)},$setPageSize:function(e){this.page_size=e},$getPageSize:function(){return this.page_size},$updatePageIndex:function(e){y(e.page_index)&&(this.page_index=e.page_index)},$setPageIndex:function(e){this.page_index=e||0},$getPageIndex:function(){return this.page_index},$getPageOffset:function(){return this.page_index*this.page_size},$updateTotal:function(e){y(e.total)&&(this.total=e.total)},$setTotal:function(e){this.total=e||0},$getTotal:function(){return this.total},$getPageCount:function(){return Math.ceil(this.$getTotal()/this.$getPageSize())}}),it.Status={Pending:"pending",Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled"},it.Events={Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled",Unsuccessful:"failure offline canceled",Complete:"success failure offline canceled"},it.all=function(e){function t(){r.push(wt.slice.apply(arguments)),++n===s&&i.resolve(r)}for(var i=new it,n=0,s=e.length,r=[],o=0;o<e.length;o++){var a=e[o];a instanceof it?a.then(t,i.reject,i.noline,i.cancel,i):s--}return i},it.race=function(e){for(var t=new it,i=0;i<e.length;i++){var n=e[i];n instanceof it&&n.then(t.resolve,t.reject,t.noline,t.cancel,t)}return t},it.reject=function(e){var t=new it;return t.reject.apply(t,arguments),t},it.resolve=function(){var e=new it;return e.resolve.apply(e,arguments),e},it.noline=function(e){var t=new it;return t.noline.apply(t,arguments),t},it.cancel=function(){var e=new it;return e.cancel.apply(e,arguments),e},it.singularity=function(){function e(){++o===r&&i.resolve(n)}function t(t){r++,t.then(e,i.reject,i.noline,null,i)}var i=null,n=null,s=!1,r=0,o=0;return function(e,a,u){if(s)t(e),u.call(a,i);else{s=!0,i=new it(null,!1),n=a,r=0,o=0,t(e);try{u.call(a,i)}catch(h){throw ye.trigger(ye.Events.Error,[h]),h}finally{s=!1}}return i}}(),c(it.prototype,{resolve:function(){this.finish(it.Status.Success,it.Events.Success,arguments)},reject:function(){this.finish(it.Status.Failure,it.Events.Failure,arguments)},noline:function(){this.finish(it.Status.Offline,it.Events.Offline,arguments)},cancel:function(){this.cancelable&&this.finish(it.Status.Canceled,it.Events.Canceled,arguments)},then:function(e,t,i,n,s,r){return this.success(e,s,r),this.failure(t,s,r),this.offline(i,s,r),this.canceled(n,s,r),this},reset:function(e){return this.status=it.Status.Pending,e&&this.off(),this},finish:function(e,t,i){this.status===it.Status.Pending&&(this.results=wt.slice.apply(i),this.status=e,this.trigger(t,i))},listenFor:function(e,t,i,n,s){return m(i)&&(this.status===it.Status.Pending?s?this.on(t,i,n):this.once(t,i,n):e&&i.apply(n||this,this.results)),this},success:function(e,t,i){return this.listenFor(this.isSuccess(),it.Events.Success,e,t,i)},unsuccessful:function(e,t,i){return this.listenFor(this.isUnsuccessful(),it.Events.Unsuccessful,e,t,i)},failure:function(e,t,i){return this.listenFor(this.isFailure(),it.Events.Failure,e,t,i)},"catch":function(e,t,i){return this.listenFor(this.isFailure(),it.Events.Failure,e,t,i)},offline:function(e,t,i){return this.listenFor(this.isOffline(),it.Events.Offline,e,t,i)},canceled:function(e,t,i){return this.listenFor(this.isCanceled(),it.Events.Canceled,e,t,i)},complete:function(e,t,i){return this.listenFor(!0,it.Events.Complete,e,t,i)},isSuccess:function(){return this.status===it.Status.Success},isUnsuccessful:function(){return this.status!==it.Status.Success&&this.status!==it.Status.Pending},isFailure:function(){return this.status===it.Status.Failure},isOffline:function(){return this.status===it.Status.Offline},isCanceled:function(){return this.status===it.Status.Canceled},isPending:function(){return this.status===it.Status.Pending},isComplete:function(){return this.status!==it.Status.Pending}}),G(it.prototype),c(nt.prototype,{reset:function(e,t){this.model=e,this.cascade=y(t)?t:Bt.All,this.db=e.$db,this.next=null,this.finished=!1},canCascade:function(e){var t=e||this.cascading,i=this.cascade;return 0!==(t&i)},notCascade:function(e){var t=this.cascade;return 0===(e&t)},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):(this.next=e,this.model.$trigger(Ve.Events.OperationsStarted))},tryNext:function(e){var t=!this.next;return t&&(this.next=new e(this.model,this.cascade)),t},insertNext:function(e){var t=new e(this.model,this.cascade);t.next=this.next,this.next=t},execute:function(){0===this.db.pendingOperations&&this.db.trigger(Ne.Events.OperationsStarted),this.db.pendingOperations++;try{this.run(this.db,this.model)}catch(e){throw this.finish(),ye.trigger(ye.Events.Error,[e]),e}},run:function(e,t){throw"Operation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,this.model.$operation=this.next,this.next&&this.next.execute(),this.db.pendingOperations--,this.next||this.model.$trigger(Ve.Events.OperationsFinished),0===this.db.pendingOperations&&(this.db.onOperationRest(),this.db.trigger(Ne.Events.OperationsFinished))),this},success:function(){return D(this,this.handleSuccess)},handleSuccess:function(){try{this.onSuccess.apply(this,arguments)}catch(e){throw ye.trigger(ye.Events.Error,[e]),e}finally{this.finish()}},onSuccess:function(){},failure:function(){return D(this,this.handleFailure)},handleFailure:function(){try{this.onFailure.apply(this,arguments)}catch(e){throw ye.trigger(ye.Events.Error,[e]),e}finally{this.finish()}},onFailure:function(){}}),h(nt,st,{cascading:Bt.Local,interrupts:!1,type:"GetLocal",run:function(e,t){t.$isDeleted()?(t.$trigger(Ve.Events.LocalGetFailure,[t]),this.finish()):this.canCascade()&&e.cache===qt.All?e.store.get(t.$key(),this.success(),this.failure()):(ye.debug(ye.Debugs.GET_LOCAL_SKIPPED,t),t.$trigger(Ve.Events.LocalGet,[t]),this.insertNext(rt),this.finish())},onSuccess:function(e,t){var i=this.model;M(t)&&i.$set(t),ye.debug(ye.Debugs.GET_LOCAL,i,t),i.$trigger(Ve.Events.LocalGet,[i]),this.canCascade(Bt.Rest)&&!i.$isDeleted()&&this.insertNext(rt)},onFailure:function(e){var t=this.model;ye.debug(ye.Debugs.GET_LOCAL,t,e),t.$trigger(Ve.Events.LocalGetFailure,[t]),this.canCascade(Bt.Rest)&&!t.$isDeleted()&&this.insertNext(rt)}}),h(nt,rt,{cascading:Bt.Rest,interrupts:!1,type:"GetRemote",run:function(e,t){t.$isDeleted()?(t.$trigger(Ve.Events.RemoteGetFailure,[t]),this.finish()):this.canCascade()?Te(function(){e.rest.get(t,this.success(),this.failure())},this):(t.$trigger(Ve.Events.RemoteGet,[t]),this.finish())},onSuccess:function(e){var t=this.db,i=t.resolveModel(e),n=this.model;M(i)&&t.putRemoteData(i,n.$key(),n,!0),ye.debug(ye.Debugs.GET_REMOTE,n,i),n.$trigger(Ve.Events.RemoteGet,[n])},onFailure:function(e,t){var i=this.db,n=this.model;ye.debug(ye.Debugs.GET_REMOTE_ERROR,n,e,t),Xt.NotFound[t]?(this.insertNext(ut),i.destroyModel(n),n.$trigger(Ve.Events.RemoteGetFailure,[n,e])):Xt.Offline[t]?n.$trigger(Ve.Events.RemoteGetOffline,[n,e]):n.$trigger(Ve.Events.RemoteGetFailure,[n,e])}}),h(nt,ot,{cascading:Bt.None,interrupts:!0,type:"RemoveCache",run:function(e,t){e.cache===qt.None?this.finish():e.store.remove(t.$key(),this.success(),this.failure())}}),h(nt,at,{cascading:Bt.Local,interrupts:!0,type:"RemoveLocal",run:function(e,t){t.$status=Ve.Status.RemovePending,e.cache!==qt.None&&t.$local&&this.canCascade()?t.$saved?(t.$local.$status=t.$status,e.store.put(t.$key(),t.$local,this.success(),this.failure())):(ye.debug(ye.Debugs.REMOVE_LOCAL_UNSAVED,t),e.store.remove(t.$key(),this.success(),this.failure())):(ye.debug(ye.Debugs.REMOVE_LOCAL_NONE,t),t.$trigger(Ve.Events.LocalRemove,[t]),this.insertNext(ht),this.finish())},onSuccess:function(e,t,i){var n=this.model;ye.debug(ye.Debugs.REMOVE_LOCAL,n),n.$trigger(Ve.Events.LocalRemove,[n]),n.$saved&&this.canCascade(Bt.Remote)&&n.$addOperation(ht,this.cascade)},onFailure:function(e){var t=this.model;ye.debug(ye.Debugs.REMOVE_LOCAL_ERROR,t,e),t.$trigger(Ve.Events.LocalRemoveFailure,[t]),t.$saved&&this.canCascade(Bt.Remote)&&t.$addOperation(ht,this.cascade)}}),h(nt,ut,{cascading:Bt.Local,interrupts:!0,type:"RemoveNow",run:function(e,t){var i=t.$key();t.$status=Ve.Status.RemovePending,e.removeFromModels(t),e.cache!==qt.None&&this.canCascade()?e.store.remove(i,this.success(),this.failure()):(this.finishRemove(),this.finish())},onSuccess:function(){this.finishRemove()},onFailure:function(){this.finishRemove()},finishRemove:function(){var e=this.model;e.$status=Ve.Status.Removed,delete e.$local,delete e.$saving,delete e.$publish,delete e.$saved}}),h(nt,ht,{cascading:Bt.Remote,interrupts:!0,type:"RemoveRemote",run:function(e,t){this.notCascade(Bt.Rest)?(this.liveRemove(),t.$trigger(Ve.Events.RemoteRemove,[t]),this.finish()):(t.$status=Ve.Status.RemovePending,Te(function(){e.rest.remove(t,this.success(),this.failure())},this))},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var i=this.model,n=i.$key();Xt.NotFound[t]?(ye.debug(ye.Debugs.REMOVE_MISSING,i,n),this.finishRemove(!0)):Xt.Offline[t]?(ye.checkNetworkStatus(),ye.online?i.$trigger(Ve.Events.RemoteRemoveFailure,[i,e]):(i.$listenForOnline(this.cascade),i.$trigger(Ve.Events.RemoteRemoveOffline,[i,e])),ye.debug(ye.Debugs.REMOVE_OFFLINE,i,e)):(ye.debug(ye.Debugs.REMOVE_ERROR,i,t,n,e),i.$trigger(Ve.Events.RemoteRemoveFailure,[i,e]))},finishRemove:function(e){var t=this.db,i=this.model,n=i.$key();ye.debug(ye.Debugs.REMOVE_REMOTE,i,n),i.$status=Ve.Status.Removed,i.$trigger(Ve.Events.RemoteRemove,[i]),this.insertNext(ut),e||this.liveRemove(),delete t.all[n]},liveRemove:function(){if(this.canCascade(Bt.Live)){var e=this.db,t=this.model,i=t.$key();ye.debug(ye.Debugs.REMOVE_PUBLISH,t,i),e.live.remove(t)}}}),h(nt,lt,{cascading:Bt.Local,interrupts:!1,type:"SaveLocal",run:function(e,t){if(t.$isDeleted())ye.debug(ye.Debugs.SAVE_LOCAL_DELETED,t),t.$trigger(Ve.Events.LocalSaveFailure,[t]),this.finish();else if(e.cache!==qt.None&&this.canCascade()){var i=t.$key(),n=t.$toJSON(!1);this.markSaving(e,t),t.$local?X(n,t.$local):(t.$local=n,t.$saved&&(t.$local.$saved=t.$saved)),t.$local.$status=t.$status,t.$local.$saving=t.$saving,t.$local.$publish=t.$publish,e.store.put(i,t.$local,this.success(),this.failure())}else this.canCascade(Bt.Remote)&&this.tryNext(ct)&&this.markSaving(e,t),t.$trigger(Ve.Events.LocalSave,[t]),this.finish()},markSaving:function(e,t){var i=t.$toJSON(!0),n=t.$getChanges(i),s=e.fullSave?i:n,r=e.fullPublish?i:this.publishAlways(e,n,i);t.$status=Ve.Status.SavePending,t.$saving=s,t.$publish=r},publishAlways:function(e,t,i){var n=null;if(e.publishAlways.length)for(var s=0;s<e.publishAlways.length;s++){var r=e.publishAlways[s];r in t||(n||(n=ie(t)),n[r]=i[r])}return n||t},clearLocal:function(e){e.$status=Ve.Status.Synced,e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish,this.insertNext(dt)},onSuccess:function(e,t,i){var n=this.model;ye.debug(ye.Debugs.SAVE_LOCAL,n),this.cascade?this.tryNext(ct):this.clearLocal(n),n.$trigger(Ve.Events.LocalSave,[n])},onFailure:function(e){var t=this.model;ye.debug(ye.Debugs.SAVE_LOCAL_ERROR,t,e),this.cascade?this.tryNext(ct):this.clearLocal(t),t.$trigger(Ve.Events.LocalSaveFailure,[t])}}),h(nt,dt,{cascading:Bt.Local,interrupts:!1,type:"SaveNow",run:function(e,t){var i=t.$key(),n=t.$local;e.cache===qt.All&&i&&n&&this.canCascade()?e.store.put(i,n,this.success(),this.failure()):this.finish()}}),h(nt,ct,{cascading:Bt.Remote,interrupts:!1,type:"SaveRemote",run:function(e,t){t.$isDeleted()?(ye.debug(ye.Debugs.SAVE_REMOTE_DELETED,t),this.markSynced(t,!0,Ve.Events.RemoteSaveFailure,null),this.finish()):t.$dependents.isSaved(this.tryAgain,this)?!e.hasData(t.$saving)||this.notCascade(Bt.Rest)?(this.liveSave(),this.markSynced(t,!0,Ve.Events.RemoteSave,null),this.finish()):(t.$status=Ve.Status.SavePending,Te(function(){t.$saved?e.rest.update(t,t.$saving,this.success(),this.failure()):e.rest.create(t,t.$saving,this.success(),this.failure())},this)):this.finish()},onSuccess:function(e){var t=this.db,i=t.resolveModel(e),n=this.model;ye.debug(ye.Debugs.SAVE_REMOTE,n),this.handleData(i)},onFailure:function(e,t){var i=this.db,n=i.resolveModel(e),s=this.model;Xt.Conflict[t]?(ye.debug(ye.Debugs.SAVE_CONFLICT,s,n),this.handleData(n)):Xt.NotFound[t]?(ye.debug(ye.Debugs.SAVE_UPDATE_FAIL,s),this.insertNext(ut),i.destroyModel(s),s.$trigger(Ve.Events.RemoteSaveFailure,[s,e])):Xt.Offline[t]?(ye.checkNetworkStatus(),ye.online?this.markSynced(s,!0,Ve.Events.RemoteSaveFailure,e):(s.$listenForOnline(this.cascade),s.$trigger(Ve.Events.RemoteSaveOffline,[s,e])),ye.debug(ye.Debugs.SAVE_OFFLINE,s,e)):(ye.debug(ye.Debugs.SAVE_ERROR,s,t),this.markSynced(s,!0,Ve.Events.RemoteSaveFailure,e))},markSynced:function(e,t,i,n){e.$status=Ve.Status.Synced,this.clearPending(e),t&&this.insertNext(dt),i&&e.$trigger(i,[e,n])},clearPending:function(e){delete e.$saving,delete e.$publish,e.$local&&(e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish)},handleData:function(e){var t=this.db,i=this.model,n=i.$saving;return i.$isDeleted()?(ye.debug(ye.Debugs.SAVE_REMOTE_DELETED,i,e),this.clearPending(i)):(ye.debug(ye.Debugs.SAVE_VALUES,i,n),i.$saved||(i.$saved=i.$local?i.$local.$saved={}:{}),X(n,i.$saved),I(e)||t.putRemoteData(e,i.$key(),i),this.liveSave(e),this.markSynced(i,!1,Ve.Events.RemoteSave,null),void(t.cache===qt.Pending?this.insertNext(ot):this.insertNext(dt)))},liveSave:function(e){var t=this.db,i=this.model;M(e)&&X(e,i.$publish),this.canCascade(Bt.Live)&&t.hasData(i.$publish)&&(ye.debug(ye.Debugs.SAVE_PUBLISH,i,i.$publish),t.live.save(i,i.$publish))},tryAgain:function(){var e=this.model;e.$addOperation(lt,this.cascade)}}),ye.Relations={},ft.Defaults={model:null,lazy:!1,store:Jt.None,save:jt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},c(ft.prototype,{debugQuery:null,debugQueryResults:null,getDefaults:function(e,t,i){return ft.Defaults},init:function(e,t,i){if(z(this,i,this.getDefaults(e,t,i)),this.database=e,this.name=t,this.options=i,this.initialized=!1,this.property=this.property||n(e.fields,this.name)!==!1,this.discriminated=!I(this.discriminators),this.discriminated){if(!ri)throw"Polymorphic feature is required to use the discriminated option.";c(this,ri)}this.setReferences(e,t,i)},setReferences:function(e,t,i){E(this.model)?this.onInitialized(e,t,i):ye.get(this.model).complete(this.setModelReference(e,t,i),this)},setModelReference:function(e,t,i){return function(n){this.model=n,this.onInitialized(e,t,i)}},onInitialized:function(e,t,i){},finishInitialization:function(){this.initialized=!0,this.load.open()},load:Le(function(e,t,i){}),set:function(e,t,i){},relate:function(e,t,i){},unrelate:function(e,t){},isRelated:function(e,t){},preClone:function(e,t,i){},postClone:function(e,t,i){},get:function(e){return e.$relations[this.name].related},encode:function(e,t,i){var n=e.$relations[this.name],s=i?this.save:this.store;if(n&&s){var r=n.related;A(r)?t[this.name]=this.getStoredArray(r,s):t[this.name]=this.getStored(r,s)}},ready:function(e){this.model.Database.ready(e,this)},listenToModelAdded:function(e){this.model.Database.on(Ne.Events.ModelAdded,e,this)},executeQuery:function(e){if(!et)throw"Search feature is required to use the query option.";var t=this.query,i=this.queryOptions,n=this.queryData,s=$(t)?ue(t,e):t,r=this.model.search(s,i,n);ye.debug(this.debugQuery,this,e,r,t,s,n);var o=r.$run();return o.complete(this.handleExecuteQuery(e),this),r},handleExecuteQuery:function(e){return function(t){var i=t.$results;ye.debug(this.debugQueryResults,this,e,t);for(var n=0;n<i.length;n++)this.relate(e,i[n],!0)}},createRelationCollection:function(e){return new Xe(this.model.Database,e,this)},createCollection:function(){return new je(this.model.Database)},parseModel:function(e,t){return this.model.Database.parseModel(e,t)},grabInitial:function(e,t){return B(e,t,O)?W(e,t):void 0},grabModel:function(e,t,i){this.model.Database.grabModel(e,t,this,i)},grabModels:function(e,t,i,n){for(var s=this.model.Database,r=0;r<t.length;r++){var o=t[r],a=s.keyHandler.buildKeyFromInput(o);e.pending[a]=!0,s.grabModel(o,i,this,n)}},buildKey:function(e){},setProperty:function(e){if(this.property){var t=e.parent,i=this.name,n=!!e.dynamicSet;if(!n&&this.dynamic&&Object.defineProperty){var s=this;Object.defineProperty(t,i,{enumerable:!0,set:function(e){s.set(t,e)},get:function(){return e.related}}),n=e.dynamicSet=!0}n||(t[i]=e.related),e.lastRelated!==e.related&&(e.lastRelated=e.related,t.$trigger(Ve.Events.RelationUpdate,[this,e]))}},isModelArray:function(e){if(!A(e))return!1;var t=this.model.Database,i=t.key;if(!A(i))return!0;if(i.length!==e.length)return!0;for(var n=0;n<e.length;n++)if(!y(e[n])&&!$(e[n]))return!0;return!1},clearFields:function(e,t,i,n){var s=q(e,t);return s&&!i&&this.auto&&!e.$isNew()&&e.$save(n),s},updateFields:function(e,t,i,n,s){var r=J(e,t,i,n);return r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(Ve.Events.KeyUpdate,[e,i,t,n])),r},updateForeignKey:function(e,t,i){var n=this.getTargetFields(e),s=this.getSourceFields(t),r=e.$key(),o=e.$db.keyHandler,a=e.$db.keyChanges;if(ye.debug(this.debugUpdateKey,this,e,n,t,s),this.updateFields(e,n,t,s,i),a&&i){var u=o.getKey(e,!0);o.inKey(n)&&u!==r&&e.$setKey(u,!0)}},getTargetFields:function(e){return e.$db.key},getSourceFields:function(e){return e.$db.key},getStoredArray:function(e,t){if(!t)return null;for(var i=[],n=0;n<e.length;n++){var s=this.getStored(e[n],t);null!==s&&i.push(s)}return i},getStored:function(e,t){if(e)switch(t){case jt.Model:return e.$toJSON(!0);case Jt.Model:if(e.$local)return e.$local;var i=e.$toJSON(!1);return e.$saved&&(i.$saved=e.$saved),i;case jt.Key:case Jt.Key:return e.$key();case jt.Keys:case Jt.Keys:return e.$keys()}return null}}),h(ft,vt,{debugInit:null,debugClearModel:null,debugSetModel:null,debugLoaded:null,debugClearKey:null,debugUpdateKey:null,onInitialized:function(e,t,i){if(!this.discriminated){var n=this.model.Database;this.local=this.local||n.name+"_"+n.key}ye.debug(this.debugInit,this),this.finishInitialization()},set:function(e,i,n){if(I(i))this.unrelate(e,t,n);else{var s=e.$relations[this.name],r=this.parseModel(i,n);r&&!s.isRelated(r)&&(this.clearModel(s),this.setRelated(s,r,n))}},relate:function(e,t,i){var n=e.$relations[this.name],s=this.parseModel(t,i);s&&n.related!==s&&(this.clearModel(n),this.setRelated(n,s,i))},unrelate:function(e,t,i){var n=e.$relations[this.name],s=this.parseModel(t);s&&n.related!==s||this.clearRelated(n,i)},isRelated:function(e,t){var i=e.$relations[this.name],n=this.parseModel(t);return n===i.related},setRelated:function(e,t,i){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t,i),this.setProperty(e))},clearRelated:function(e,t){if(t){var i=e.related;if(i&&i.$isSaving())return}this.clearModel(e),this.clearForeignKey(e.parent),this.setProperty(e)},clearModel:function(e){var t=e.related;t&&(ye.debug(this.debugClearModel,this,e),e.onSaved&&t.$off(Ve.Events.Saved,e.onSaved),e.onRemoved&&t.$off(Ve.Events.Removed,e.onRemoved),e.related=null,e.dirty=!0,e.loaded=!0,e.parent.$dependents.remove(t))},setModel:function(e,t){e.onSaved&&t.$on(Ve.Events.Saved,e.onSaved,this),e.onRemoved&&t.$on(Ve.Events.Removed,e.onRemoved,this),e.related=t,e.dirty=!0,e.loaded=!0,this.isDependent(e,t)&&e.parent.$dependents.add(t,this),ye.debug(this.debugSetModel,this,e)},isDependent:function(e,t){return!0},handleModel:function(e,t){return function(i){var n=e.parent;ye.debug(this.debugLoaded,this,n,e,i),e.loaded===!1&&(i&&!i.$isDeleted()?(this.setModel(e,i,t),this.updateForeignKey(n,i,t)):this.query?e.query=this.executeQuery(n):this.preserve||this.clearForeignKey(n,t),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.local;return function(i){return Q(e,t,i,i.$db.key)}},clearForeignKey:function(e,t){var i=this.local;ye.debug(this.debugClearKey,this,e,i),this.clearFields(e,i,t)},getTargetFields:function(e){return this.local},buildKey:function(e){var t=e[this.name],i=this.local;if(M(t)&&this.model){var n=this.model.Database,s=n.key;n.keyHandler.copyFields(e,i,t,s)}}}),h(ft,gt,{debugAutoSave:null,debugInitialGrabbed:null,debugSort:null,handleExecuteQuery:function(e){return function(t){var i=e.$relations[this.name],n=t.$results;ye.debug(this.debugQueryResults,this,e,t),this.bulk(i,function(){for(var e=0;e<n.length;e++)this.addModel(i,n[e],!0)}),this.sort(i),this.checkSave(i,!0)}},bulk:function(e,t,i){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,i)},set:function(e,i,n){if(I(i))this.unrelate(e,t,n);else{var s=e.$relations[this.name],r=s.related,o=this.createCollection();if(this.isModelArray(i))for(var a=0;a<i.length;a++){var u=this.parseModel(i[a],n);u&&o.add(u)}else{var u=this.parseModel(i,n);u&&o.add(u)}var h=r.subtract(o),l=o.subtract(r);this.bulk(s,function(){for(var e=0;e<l.length;e++)this.addModel(s,l[e],n);for(var e=0;e<h.length;e++)this.removeModel(s,h[e],n)},n)}},relate:function(e,t,i){var n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e],i);s&&this.addModel(n,s,i)}});else if(O(t)){var s=this.parseModel(t,i);s&&this.addModel(n,s,i)}},unrelate:function(e,t,i){var n=e.$relations[this.name];if(this.isModelArray(t))this.bulk(n,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e]);s&&this.removeModel(n,s,i)}});else if(O(t)){var s=this.parseModel(t);s&&this.removeModel(n,s,i)}else{var r=n.related;this.bulk(n,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(n,r[e],i)})}},isRelated:function(e,t){var i=e.$relations[this.name],n=i.related;if(this.isModelArray(t)){for(var s=0;s<t.length;s++){var r=this.parseModel(t[s]);if(r&&!n.has(r.$key()))return!1}return t.length>0}if(O(t)){var r=this.parseModel(t);return r&&n.has(r.$key())}return!1},canRemoveRelated:function(e,t){return!t||!e.$isSaving()},checkSave:function(e,t){e.delaySaving||t||!e.parent.$exists()||this.store!==Jt.Model&&this.save!==jt.Model||(ye.debug(this.debugAutoSave,this,e),e.parent.$save())},handleModel:function(e,t){return function(i){var n=e.pending,s=i.$key();s in n&&(ye.debug(this.debugInitialGrabbed,this,e,i),this.addModel(e,i,t),delete n[s])}},sort:function(e){var t=e.related;e.delaySorting||(ye.debug(this.debugSort,this,e),t.sort(this.comparator),e.parent.$trigger(Ve.Events.RelationUpdate,[this,e]))}}),ye.Relations.belongsTo=pt,pt.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:jt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:Bt.Local,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},h(vt,pt,{type:"belongsTo",debugInit:ye.Debugs.BELONGSTO_INIT,debugClearModel:ye.Debugs.BELONGSTO_CLEAR_MODEL,debugSetModel:ye.Debugs.BELONGSTO_SET_MODEL,debugLoaded:ye.Debugs.BELONGSTO_LOADED,debugClearKey:ye.Debugs.BELONGSTO_CLEAR_KEY,debugUpdateKey:ye.Debugs.BELONGSTO_UPDATE_KEY,debugQuery:ye.Debugs.BELONGSTO_QUERY,debugQueryResults:ye.Debugs.BELONGSTO_QUERY_RESULTS,getDefaults:function(e,t,i){return pt.Defaults},load:Le(function(e,t,i){var n=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,onRemoved:function(){ye.debug(ye.Debugs.BELONGSTO_NINJA_REMOVE,this,e,n),e.$remove(this.cascade),this.clearRelated(n)},onSaved:function(){ye.debug(ye.Debugs.BELONGSTO_NINJA_SAVE,this,e,n),n.isRelated(n.related)||(e.$remove(this.cascade),this.clearRelated(n))}};e.$on(Ve.Events.PostRemove,this.postRemove,this),e.$on(Ve.Events.KeyUpdate,this.onKeyUpdate,this),I(t)&&(t=this.grabInitial(e,this.local),t&&ye.debug(ye.Debugs.BELONGSTO_INITIAL_PULLED,this,e,t)),I(t)?this.query&&(n.query=this.executeQuery(e)):(ye.debug(ye.Debugs.BELONGSTO_INITIAL,this,e,t),this.grabModel(t,this.handleModel(n,i),i))}),postRemove:function(e){var t=e.$relations[this.name];t&&(ye.debug(ye.Debugs.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t),this.setProperty(t))},onKeyUpdate:function(e,t,i,n){if(this.local===i){var s=e.$relations[this.name];s&&t!==s.related&&(this.clearModel(s),this.setModel(s,t),this.setProperty(s))}}}),ye.Relations.hasOne=mt,mt.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:jt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:Bt.All,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},h(vt,mt,{type:"hasOne",debugInit:ye.Debugs.HASONE_INIT,debugClearModel:ye.Debugs.HASONE_CLEAR_MODEL,debugSetModel:ye.Debugs.HASONE_SET_MODEL,debugLoaded:ye.Debugs.HASONE_LOADED,debugClearKey:ye.Debugs.HASONE_CLEAR_KEY,debugUpdateKey:ye.Debugs.HASONE_UPDATE_KEY,debugQuery:ye.Debugs.HASONE_QUERY,debugQueryResults:ye.Debugs.HASONE_QUERY_RESULTS,getDefaults:function(e,t,i){return mt.Defaults},load:Le(function(e,t,n){var s=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,dirty:!1,saving:!1,child:V(this.local,e.$db.key),onRemoved:function(){ye.debug(ye.Debugs.HASONE_NINJA_REMOVE,this,e,s),this.clearRelated(s)}};if(e.$on(Ve.Events.PreSave,this.preSave,this),e.$on(Ve.Events.PostRemove,this.postRemove,this),I(t)&&(t=this.grabInitial(e,this.local),t&&ye.debug(ye.Debugs.HASONE_INITIAL_PULLED,this,e,t)),I(t))this.query&&(s.query=this.executeQuery(e));else{if(ye.debug(ye.Debugs.HASONE_INITIAL,this,e,t),M(t)&&s.child)for(var r=i(this.local),o=i(this.model.Database.key),a=0;a<r.length;a++)t[o[a]]=e[r[a]];this.grabModel(t,this.handleModel(s),n)}}),isDependent:function(e,t){return!e.child},preClone:function(e,t,i){var n=this.get(e);if(n){var s=n.$clone(i);J(t,this.local,s,s.$db.key),t[this.name]=s}},preSave:function(e){var t=e.$relations[this.name];if(t&&t.related){var i=t.related;(t.dirty||i.$hasChanges())&&(ye.debug(ye.Debugs.HASONE_PRESAVE,this,e,t),t.saving=!0,i.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade&&(ye.debug(ye.Debugs.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e){var t=e.related;t&&(ye.debug(this.debugClearModel,this,e),t.$off(Ve.Events.Removed,e.onRemoved),this.cascade&&!t.$isDeleted()&&t.$remove(this.cascade),e.related=null,e.dirty=!0,e.loaded=!0,e.parent.$dependents.remove(t))}}),ye.Relations.hasMany=Et,Et.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:jt.None,auto:!0,property:!0,dynamic:!1,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:Bt.Local,cascadeSave:Bt.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},h(gt,Et,{type:"hasMany",debugAutoSave:ye.Debugs.HASMANY_AUTO_SAVE,debugInitialGrabbed:ye.Debugs.HASMANY_INITIAL_GRABBED,debugSort:ye.Debugs.HASMANY_SORT,debugQuery:ye.Debugs.HASMANY_QUERY,debugQueryResults:ye.Debugs.HASMANY_QUERY_RESULTS,debugUpdateKey:ye.Debugs.HASMANY_UPDATE_KEY,getDefaults:function(e,t,i){return Et.Defaults},onInitialized:function(e,t,i){this.foreign=this.foreign||e.name+"_"+e.key,this.comparator=U(this.comparator,this.comparatorNullsFirst),ye.debug(ye.Debugs.HASMANY_INIT,this),this.finishInitialization()},load:Le(function(e,t,i){var n=this,s=e.$relations[this.name]={parent:e,pending:{},isRelated:this.isRelatedFactory(e),related:this.createRelationCollection(e),saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){ye.debug(ye.Debugs.HASMANY_NINJA_REMOVE,n,e,this,s),n.removeModel(s,this,!0)},onSaved:function(){s.saving||(ye.debug(ye.Debugs.HASMANY_NINJA_SAVE,n,e,this,s),s.isRelated(this)?(n.sort(s),n.checkSave(s)):n.removeModel(s,this))}};e.$on(Ve.Events.PostSave,this.postSave,this),e.$on(Ve.Events.PreRemove,this.preRemove,this),this.listenToModelAdded(this.handleModelAdded(s)),A(t)?(ye.debug(ye.Debugs.HASMANY_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,i),i)):this.query?s.query=this.executeQuery(e):(ye.debug(ye.Debugs.HASMANY_INITIAL_PULLED,this,e,s),this.ready(this.handleLazyLoad(s))),this.setProperty(s)}),postClone:function(e,t,i){var n=this.get(e);if(n){var s=[];J(i,this.foreign,t,e.$db.key),i[this.foreign]=t[e.$db.key];for(var r=0;r<n.length;r++)s.push(n[r].$clone(i));t[this.name]=s}},postSave:function(e){var t=e.$relations[this.name];t&&this.cascadeSave&&(ye.debug(ye.Debugs.HASMANY_POSTSAVE,this,e,t),Te(function(){t.saving=!0,t.delaySaving=!0;for(var e=t.related,i=0;i<e.length;i++){var n=e[i];!n.$isDeleted()&&n.$hasChanges()&&n.$save(this.cascadeSave)}t.saving=!1,t.delaySaving=!1},this))},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(ye.debug(ye.Debugs.HASMANY_PREREMOVE,this,e,t),Te(function(){this.bulk(t,function(){for(var e=t.related,i=e.length-1;i>=0;i--){var n=e[i];n.$remove(this.cascadeRemove)}})},this))},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&(ye.debug(ye.Debugs.HASMANY_NINJA_ADD,this,e,t),this.addModel(e,t,i))}},handleLazyLoad:function(e){return function(t){var i=t.filter(e.isRelated);ye.debug(ye.Debugs.HASMANY_LAZY_LOAD,this,e,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModel(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=e.parent,s=e.related,r=t.$key(),o=!s.has(r);return o&&(ye.debug(ye.Debugs.HASMANY_ADD,this,e,t),s.put(r,t),t.$on(Ve.Events.Removed,e.onRemoved),t.$on(Ve.Events.SavedRemoteUpdate,e.onSaved),t.$dependents.add(n,this),this.updateForeignKey(t,n,i),this.sort(e),i||this.checkSave(e)),o}},removeModel:function(e,t,i){if(this.canRemoveRelated(t,i)){var n=e.parent,s=e.related,r=e.pending,o=t.$key(),a=s.has(o);return a&&(ye.debug(ye.Debugs.HASMANY_REMOVE,this,e,t),s.remove(o),t.$off(Ve.Events.Removed,e.onRemoved),t.$off(Ve.Events.SavedRemoteUpdate,e.onSaved),t.$dependents.remove(n),this.cascadeRemove&&(i?Re(this.cascadeRemove,Bt.Local)&&t.$remove(Bt.Local):t.$remove(this.cascadeRemove)),this.sort(e),this.checkSave(e)),delete r[o],a}},isRelatedFactory:function(e){var t=this.foreign,i=e.$db.key;return function(n){return Q(n,t,e,i)}},getTargetFields:function(e){return this.foreign}}),ye.Relations.hasManyThrough=$t,$t.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:jt.None,auto:!0,property:!0,dynamic:!1,through:t,local:null,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:Bt.NoRest,cascadeSave:Bt.All,cascadeSaveRelated:Bt.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},h(gt,$t,{type:"hasManyThrough",debugAutoSave:ye.Debugs.HASMANYTHRU_AUTO_SAVE,debugInitialGrabbed:ye.Debugs.HASMANYTHRU_INITIAL_GRABBED,debugSort:ye.Debugs.HASMANYTHRU_SORT,debugQuery:ye.Debugs.HASMANYTHRU_QUERY,debugQueryResults:ye.Debugs.HASMANYTHRU_QUERY_RESULTS,debugUpdateKey:ye.Debugs.HASMANYTHRU_UPDATE_KEY,getDefaults:function(e,t,i){return $t.Defaults},onInitialized:function(e,t,i){if(!this.discriminated){var n=this.model.Database;this.foreign=this.foreign||n.name+"_"+n.key}this.local=this.local||e.name+"_"+e.key,this.comparator=U(this.comparator,this.comparatorNullsFirst),E(i.through)?this.setThrough(i.through):ye.get(i.through).complete(this.setThrough,this),ye.debug(ye.Debugs.HASMANYTHRU_INIT,this)},setThrough:function(e){this.through=e,this.finishInitialization()},load:Le(function(e,t,i){var n=this,s=this.through.Database,r=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),pending:{},related:this.createRelationCollection(e),throughs:new Ye,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){ye.debug(ye.Debugs.HASMANYTHRU_NINJA_REMOVE,n,e,this,r),n.removeModel(r,this)},onSaved:function(){r.saving||(ye.debug(ye.Debugs.HASMANYTHRU_NINJA_SAVE,n,e,this,r),n.sort(r),n.checkSave(r))},onThroughRemoved:function(){ye.debug(ye.Debugs.HASMANYTHRU_NINJA_THRU_REMOVE,n,e,this,r),n.removeModelFromThrough(r,this)}};e.$on(Ve.Events.PostSave,this.postSave,this),e.$on(Ve.Events.PreRemove,this.preRemove,this),
s.on(Ne.Events.ModelAdded,this.handleModelAdded(r),this),A(t)?(ye.debug(ye.Debugs.HASMANYTHRU_INITIAL,this,e,r,t),this.grabModels(r,t,this.handleModel(r,i),i)):this.query?r.query=this.executeQuery(e):(ye.debug(ye.Debugs.HASMANYTHRU_INITIAL_PULLED,this,e,r),s.ready(this.handleLazyLoad(r),this)),this.setProperty(r)}),preClone:function(e,t,i){var n=this.get(e);n&&(t[this.name]=n.slice())},postSave:function(e){var t=e.$relations[this.name];Te(function(){if(t&&this.cascadeSave)for(var i=t.throughs.values,n=0;n<i.length;n++){var s=i[n];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave)}if(t&&this.cascadeSaveRelated){ye.debug(ye.Debugs.HASMANYTHRU_PRESAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var r=t.related,n=0;n<r.length;n++){var o=r[n];!o.$isDeleted()&&o.$hasChanges()&&o.$save(this.cascadeSaveRelated)}t.saving=!1,t.delaySaving=!1}},this)},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(ye.debug(ye.Debugs.HASMANYTHRU_PREREMOVE,this,e,t),Te(function(){this.bulk(t,function(){for(var e=t.throughs.values,i=0;i<e.length;i++){var n=e[i];n.$remove(this.cascadeRemove)}})},this))},handleModelAdded:function(e){return function(t,i){e.isRelated(t)&&!e.throughs.has(t.$key())&&(ye.debug(ye.Debugs.HASMANYTHRU_NINJA_ADD,this,e,t),this.addModelFromThrough(e,t,i))}},handleLazyLoad:function(e){return function(t){var i=t.filter(e.isRelated);ye.debug(ye.Debugs.HASMANYTHRU_LAZY_LOAD,this,e,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModelFromThrough(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=this.finishAddModel(e,t,i);return n&&this.addThrough(e,t,i),n}},addThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t);n.grabModel(s,this.onAddThrough(e,i),this,i)},onAddThrough:function(e,t){return function(i){this.finishAddThrough(e,i,t)}},addModelFromThrough:function(e,t,i){if(!t.$isDeleted()){var n=this.model.Database,s=n.keyHandler.buildKey(t,this.foreign);n.grabModel(s,this.onAddModelFromThrough(e,t,i),this,i)}},onAddModelFromThrough:function(e,t,i){return function(n){n&&(this.finishAddThrough(e,t,i),this.finishAddModel(e,n,i))}},finishAddThrough:function(e,t,i){var n=e.parent,s=e.throughs,r=t.$key(),o=!s.has(r);return o&&(ye.debug(ye.Debugs.HASMANYTHRU_THRU_ADD,this,e,t),s.put(r,t),t.$on(Ve.Events.Removed,e.onThroughRemoved),t.$dependents.add(n,this),!i&&this.cascadeSave&&(n.$isSaved()?t.$save(this.cascadeSave):t.$save(Bt.None))),o},finishAddModel:function(e,t,i){var n=e.related,s=t.$key(),r=!n.has(s);return r&&(ye.debug(ye.Debugs.HASMANYTHRU_ADD,this,e,t),n.put(s,t),t.$on(Ve.Events.Removed,e.onRemoved),t.$on(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r},removeModel:function(e,t,i){var n=t.$key(),s=e.related,r=s.get(n);r&&this.removeThrough(e,t,i)&&this.finishRemoveRelated(e,n,i)},removeThrough:function(e,t,i){var n=this.through.Database,s=this.createThroughKey(e,t),r=n.keyHandler.getKey(s),o=e.throughs,a=o.get(r);return this.finishRemoveThrough(e,a,t,!0,i)},removeModelFromThrough:function(e,t){var i=this.model.Database,n=i.keyHandler.buildKey(t,this.foreign);this.finishRemoveThrough(e,t)&&this.finishRemoveRelated(e,n)},finishRemoveThrough:function(e,t,i,n,s){var r=e.parent,o=!!t;if(o){if(!this.canRemoveRelated(t,s))return!1;ye.debug(ye.Debugs.HASMANYTHRU_THRU_REMOVE,this,e,t,i);var a=e.throughs,u=t.$key();t.$off(Ve.Events.Removed,e.onThroughRemoved),t.$dependents.remove(r),n&&t.$remove(s?Bt.Local:Bt.All),a.remove(u)}return o},finishRemoveRelated:function(e,t){var i=e.pending,n=e.related,s=n.get(t);return s&&(ye.debug(ye.Debugs.HASMANYTHRU_REMOVE,this,e,s),n.remove(t),s.$off(Ve.Events.Removed,e.onRemoved),s.$off(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete i[t],s},isRelatedFactory:function(e){var t=e.$db.key,i=this.local;return function(n){return Q(n,i,e,t)}},createThroughKey:function(e,t){for(var i=e.parent,n=i.$db.keyHandler,s=this.model.Database.keyHandler,r=this.through.Database,o=r.key,a={},u=0;u<o.length;u++){var h=o[u];n.setKeyField(a,h,t,this.foreign),s.setKeyField(a,h,i,this.local)}return a},getTargetFields:function(e){return this.local}}),ye.Relations.hasRemote=yt,yt.Defaults={model:t,lazy:!1,query:!1,store:Jt.None,save:jt.None,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1,autoRefresh:!1},h(gt,yt,{type:"hasRemote",debugSort:ye.Debugs.HASREMOTE_SORT,debugQuery:ye.Debugs.HASREMOTE_QUERY,debugQueryResults:ye.Debugs.HASREMOTE_QUERY_RESULTS,getDefaults:function(e,t,i){return yt.Defaults},onInitialized:function(e,t,i){this.comparator=U(this.comparator,this.comparatorNullsFirst),ye.debug(ye.Debugs.HASREMOTE_INIT,this),this.finishInitialization()},load:Le(function(e,t,i){var n=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){ye.debug(ye.Debugs.HASREMOTE_NINJA_REMOVE,n,e,this,s),n.removeModel(s,this,!0)},onSaved:function(){ye.debug(ye.Debugs.HASREMOTE_NINJA_SAVE,n,e,this,s),n.sort(s),n.checkSave(s)}};e.$key(),this.autoRefresh&&e.$on(this.autoRefresh,this.onRefresh(s),this),s.query=this.executeQuery(e),this.setProperty(s)}),onRefresh:function(e){return function(){e.query=this.executeQuery(e.parent)}},addModel:function(e,t,i){if(!t.$isDeleted()){var n=(e.parent,e.related),s=t.$key(),r=!n.has(s);return r&&(ye.debug(ye.Debugs.HASMANY_ADD,this,e,t),n.put(s,t),t.$on(Ve.Events.Removed,e.onRemoved),t.$on(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r}},removeModel:function(e,t,i){if(this.canRemoveRelated(t,i)){var n=(e.parent,e.related),s=e.pending,r=t.$key();n.has(r)&&(ye.debug(ye.Debugs.HASMANY_REMOVE,this,e,t),n.remove(r),t.$off(Ve.Events.Removed,e.onRemoved),t.$off(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete s[r]}}}),ye.Relations.hasList=Rt,Rt.Defaults={model:t,lazy:!1,store:Jt.Model,save:jt.Model,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1},h(gt,Rt,{type:"hasList",debugSort:ye.Debugs.HASLIST_SORT,getDefaults:function(e,t,i){return Rt.Defaults},onInitialized:function(e,t,i){this.comparator=U(this.comparator,this.comparatorNullsFirst),ye.debug(ye.Debugs.HASLIST_INIT,this),this.finishInitialization()},load:Le(function(e,t,i){var n=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){ye.debug(ye.Debugs.HASLIST_NINJA_REMOVE,n,e,this,s),n.removeModel(s,this,!0)},onSaved:function(){ye.debug(ye.Debugs.HASLIST_NINJA_SAVE,n,e,this,s),n.sort(s),n.checkSave(s)}};A(t)&&(ye.debug(ye.Debugs.HASLIST_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,i),i)),this.setProperty(s)}),addModel:function(e,t,i){if(!t.$isDeleted()){var n=(e.parent,e.related),s=t.$key(),r=!n.has(s);return r&&(ye.debug(ye.Debugs.HASLIST_ADD,this,e,t),n.put(s,t),t.$on(Ve.Events.Removed,e.onRemoved),t.$on(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),i||this.checkSave(e)),r}},removeModel:function(e,t,i){if(this.canRemoveRelated(t,i)){var n=(e.parent,e.related),s=e.pending,r=t.$key();n.has(r)&&(ye.debug(ye.Debugs.HASLIST_REMOVE,this,e,t),n.remove(r),t.$off(Ve.Events.Removed,e.onRemoved),t.$off(Ve.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete s[r]}},postClone:function(e,t,i){var n=this.get(e);if(n){for(var s=[],r=0;r<n.length;r++)s.push(n[r].$clone());t[this.name]=s}}});var ri={setReferences:function(e,t,i){this.isRelatedFactory=this.isRelatedDiscriminatedFactory(this.isRelatedFactory),this.loadDiscriminators(function(){this.onInitialized(e,t,i)})},isRelatedDiscriminatedFactory:function(e){return function(t){var i=e.call(this,t),n=this.getDiscriminatorForModel(t),s=this.discriminator;return function(e){return i(e)?V(n,e[s]):!1}}},loadDiscriminators:function(e){function t(){++s===n&&e.apply(this)}var i=this.discriminators,n=N(i),s=0;for(var r in i){var o=i[r];ye.get(r).complete(this.setDiscriminated(o,t),this)}},setDiscriminated:function(e,t){return function(i){this.discriminators[i.Database.name]=e,this.discriminators[i.Database.className]=e,this.discriminatorToModel[e]=i,t.apply(this)}},createRelationCollection:function(e){return Ze(new Xe(t,e,this),this.discriminator,this.discriminatorToModel)},createCollection:function(){return Ze(new je,this.discriminator,this.discriminatorToModel)},ready:function(e){var t=this.discriminatorToModel;for(var i in t){var n=t[i];n.Database.ready(e,this)}},listenToModelAdded:function(e){var t=this.discriminatorToModel;for(var i in t){var n=t[i];n.Database.on(Ne.Events.ModelAdded,e,this)}},executeQuery:function(e){var t=this.query,i=this.queryOptions,n=this.queryData,s=$(t)?ue(t,e):t,r=e.search(s,i);M(n)&&r.$set(n),Ze(r.$results,this.discriminator,this.discriminatorToModel);var o=r.$run();return o.complete(this.handleExecuteQuery(e),this),r},parseModel:function(e,t){if(e instanceof Ve)return e;if(M(e)){var i=this.getDiscriminatorDatabase(e);if(i)return i.parseModel(e,t)}return!1},clearFields:function(e,t,i){var n=q(e,t);return e[this.discriminator]&&(e[this.discriminator]=null,n=!0),n&&!i&&this.auto&&!e.$isNew()&&e.$save(),n},updateFields:function(e,t,i,n,s){var r=J(e,t,i,n),o=this.discriminator,a=e[o],u=this.getDiscriminatorForModel(i);return V(a,u)||(e[o]=u,r=!0),r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(Ve.Events.KeyUpdate,[e,i,t,n])),r},grabInitial:function(e,t){var i=this.discriminator,n=e[i];if(B(e,t,O)&&O(n)){var s=this.discriminatorToModel[n];if(s.Database){var r=s.Database,o={};return o[i]=n,J(o,r.key,e,t),o}}},grabModel:function(e,t,i){if(M(e)){var n=this.getDiscriminatorDatabase(e);n!==!1&&n.grabModel(e,t,this,i)}},grabModels:function(e,t,i,n){for(var s=0;s<t.length;s++){var r=t[s];if(r instanceof Ve)i.call(this,r);else if(M(r)){var o=this.getDiscriminatorDatabase(r);if(o){var a=o.keyHandler.buildKeyFromInput(r);e.pending[a]=!0,o.grabModel(r,i,this,n)}}}},ownsForeignKey:function(){return!0},isModelArray:function(e){return A(e)},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e),e=this.discriminatorToModel[t];return e?e.Database:!1},getDiscriminatorForModel:function(e){return this.discriminators[e.$db.name]}};ye.shard=function(e){return function(t){var i=new St(t);return c(i,e),i.initialize(t),i}},c(St.prototype,{STATUS_FAIL_ALL:500,STATUS_FAIL_GET:500,STATUS_FAIL_CREATE:500,STATUS_FAIL_UPDATE:500,STATUS_FAIL_REMOVE:500,STATUS_FAIL_QUERY:500,ATOMIC_ALL:!1,ATOMIC_GET:!1,ATOMIC_CREATE:!0,ATOMIC_UPDATE:!0,ATOMIC_REMOVE:!1,ATOMIC_QUERY:!0,getShards:function(e){throw"getShards not implemented"},getShardForModel:function(e,t){throw"getShardForModel not implemented"},getShardsForModel:function(e,t){var i=this.getShardForModel(e,t);return i?[i]:this.getShards(t)},getShardsForQuery:function(e,t){return this.getShards()},initialize:function(e){},all:function(e,t){function i(e,t,i){e.all(t,i)}function n(e){A(e)&&o.push.apply(o,e)}function s(i,n,s){i||o.length&&!this.ATOMIC_ALL?e(o):n||t(o,p(s)?s:this.STATUS_FAIL_ALL)}var r=this.getShards(!0),o=[];this.multiplex(r,this.ATOMIC_ALL,i,n,t,s)},get:function(e,t,i){function n(t,i,n){t.get(e,i,n)}function s(e){null===a&&M(e)&&(a=e)}function r(e,n,s){null!==a?t(a):i(a,p(s)?s:this.STATUS_FAIL_GET)}var o=this.getShardsForModel(e,!0),a=null;this.multiplex(o,this.ATOMIC_GET,n,s,_,r)},create:function(e,t,i,n){function s(i,n,s){i.create(e,t,n,s)}function r(e){null===u&&M(u)&&(u=e)}function o(e,t,s){e?i(u):n(u,p(s)?s:this.STATUS_FAIL_CREATE)}var a=this.getShardsForModel(e,!1),u=null;this.multiplex(a,this.ATOMIC_CREATE,s,r,_,o)},update:function(e,t,i,n){function s(i,n,s){i.update(e,t,n,s)}function r(e){null===u&&M(u)&&(u=e)}function o(e,t,s){e?i(u):n(u,p(s)?s:this.STATUS_FAIL_UPDATE)}var a=this.getShardsForModel(e,!1),u=null;this.multiplex(a,this.ATOMIC_UPDATE,s,r,_,o)},remove:function(e,t,i){function n(t,i,n){t.remove(e,i,n)}function s(e){null===a&&M(a)&&(a=e)}function r(e,n,s){e?t(a):i(a,p(s)?s:this.STATUS_FAIL_REMOVE)}var o=this.getShardsForModel(e,!1),a=null;this.multiplex(o,this.ATOMIC_REMOVE,n,s,_,r)},query:function(e,t,i,n){function s(i,n,s){i.query(e,t,n,s)}function r(e){A(e)&&u.push.apply(u,e)}function o(e,t,s){e||u.length&&!this.ATOMIC_QUERY?i(u):t||n(u,p(s)?s:this.STATUS_FAIL_QUERY)}var a=this.getShardsForQuery(e,t),u=[];this.multiplex(a,this.ATOMIC_QUERY,s,r,_,o)},multiplex:function(e,i,n,s,r,o){function a(){++f===e.length&&o.call(this,d,c,l)}function u(e){!d&&i||s.apply(this,arguments),a()}function h(e,n){d&&(d=!1,i&&(c=!0,r.apply(this,arguments))),y(n)&&(l===t||l>n)&&(l=n),a()}var l,d=!0,c=!1,f=0;if(A(e)&&0!==e.length)for(var v=0;v<e.length;v++)n.call(this,e[v],u,h);else o.call(this,!1,!1,l)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.all=function(){return t.models}}),ye.on(ye.Events.Plugins,function(e,t,i){e.boot=function(e){return A(e)?new je(t,e,!0):M(e)?t.putRemoteData(e):e}}),ye.on(ye.Events.Plugins,function(e,t,i){e.collect=function(e){var i=arguments.length>1||!A(e)?wt.slice.call(arguments):e;return new je(t,i)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.count=function(e,i,n){return t.models.countWhere(e,i,n)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.create=function(e,i){var n=M(e)?t.createModel(e):t.instantiate();return n.$save(i),n}}),ye.on(ye.Events.Plugins,function(e,t,i){var n=Z(i.dynamic,ni.dynamic);if(!I(n))for(var s in n)bt(e.prototype,s,n[s])}),ye.on(ye.Events.Plugins,function(e,t,i){var n=Z(i.events,ni.events);if(!I(n)){var s=[],r=[];for(var o in n){var a=n[o],u=pe(o),h=Ne.Events[u],l=Ve.Events[u];h&&At(h,a,!1,r),l&&At(l,a,!0,s)}if(Mt(t,r),s.length){var d=e.prototype.$init;Yt(e.prototype,"$init",function(){d.apply(this,arguments),Mt(this,s)})}}}),ye.on(ye.Events.Plugins,function(e,t,i){function s(e){i[e]||(t[e]=u[e])}function r(e){var i=t[e],n=u[e];for(var s in n)s in i||(i[s]=n[s])}function o(e,i){for(var s=u[i||e],r=t[e],o=s.length-1;o>=0;o--){var a=n(r,s[o]);a!==!1&&r.splice(a,1),r.unshift(s[o])}}var a=i.extend||ni.extend;if(E(a)){var u=a.Database,h=u.options;s("keySeparator"),r("defaults"),r("ignoredFields"),s("loadRelations"),s("load"),s("autoRefresh"),s("cache"),s("fullSave"),s("fullPublish"),r("encodings"),r("decodings"),s("summarize"),o("fields"),o("saveFields","fields"),i.comparator||t.setComparator(h.comparator,h.comparatorNullsFirst),i.revision||t.setRevision(h.revision),i.summarize||t.setSummarize(h.summarize);for(var l in u.relations)if(!(l in t.relations)){var d=u.relations[l],c=new d.constructor;c.init(t,l,d.options),c.save&&t.saveFields.push(l),t.relations[l]=c,t.relationNames.push(l)}t.rest=ye.rest(t),t.store=ye.store(t),t.live=ye.live(t)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.fetch=function(e,i,n){var s=t.keyHandler.buildKeyFromInput(e),r=t.get(s);if(r||(r=t.keyHandler.buildObjectFromKey(s),M(e)&&r.$set(e)),m(i)){var o=n||this;r.$once(Ve.Events.RemoteGets,function(){i.call(o,r)})}return r.$refresh(),r}}),ye.on(ye.Events.Plugins,function(e,t,i){e.fetchAll=function(e,i){return t.refresh(e,i),t.models}}),ye.on(ye.Events.Plugins,function(e,t,i){var n=i.files||ni.files;if(M(n)){if(!Ot())return void ye.trigger(ye.Events.FilesNotSupported);for(var s in n){var r=n[s];$(r)&&(r={type:r}),t.decodings[s]=oi[r.type](t,r),t.encodings[s]=Ct}}}),ye.fileProcessors={},ye.Events.FilesNotSupported="files-not-supported",ye.Events.FileTooLarge="file-too-large",ye.Events.FileWrongType="file-wrong-type",ye.Events.FileOffline="file-offline",ye.addFileProcessor=function(e,t){ye.fileProcessors[e]=t},ye.fileProperties=["lastModifiedDate","name","size","type"];var oi={text:function(e,t){return Ft("readAsText",Dt,t)},dataURL:function(e,t){return Ft("readAsDataURL",Dt,t)},base64:function(e,t){return Ft("readAsDataURL",Tt,t)},resource:function(e,t){return function(e,i,s){var r=_t(e),o=ye.fileProcessors[t.processor];if(!o)throw"Processor required for resource files.";if(r!==!1){if(y(t.capacity)&&y(r.size)&&r.size>t.capacity)return void ye.trigger(ye.Events.FileTooLarge,[r,i,s]);if(A(t.types)&&$(r.type)&&n(t.types,r.type)===!1)return void ye.trigger(ye.Events.FileWrongType,[r,i,s]);var a,u=!1;return o.fileToValue(r,i,s,function(e){Nt(i,s,e,r,t),a=It(o,e,i,s,t),u&&(i[s]=a,Lt(i,t))}),u=!0,a}return M(e)&&e.FILE?void ye.trigger(ye.Events.FileOffline,[e,i,s]):(Nt(i,s,e,null,t),It(o,e,i,s,t))}}};ye.on(ye.Events.Plugins,function(e,t,i){e.filtered=function(e,i,n){return t.models.filtered(e,i,n)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.first=e.find=function(e,i,n){return t.models.firstWhere(e,i,n)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.findOrCreate=function(i,n,s,r){var o=r||this,a=t.get(i),u=!1;return a?(a.$set(i),s&&s.call(o,a,u)):t.grabModel(i,function(t){t?(a=t,a.$set(i),a.$isSaved()||a.$save(n)):(a=e.create(i,n),u=!0),s&&s.call(o,a,u)}),a}}),ye.on(ye.Events.Plugins,function(e,t,i){e.get=function(e,i,n){return m(i)?void t.grabModel(e,i,n):t.get(e)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.grab=function(i,n,s){var r=s||this,o=t.get(i);return o?n.call(r,o):t.grabModel(i,function(t){t?n.call(r,t):e.fetch(i,n,s)}),o}}),ye.on(ye.Events.Plugins,function(e,t,i){e.grabAll=function(e,i){var n=i||this,s=t.models;return s.length?e.call(n,s):t.ready(function(){s.length?e.call(n,s):t.refresh(function(){e.call(n,s)})}),s}}),ye.on(ye.Events.Plugins,function(e,t,i){i.keyChanges&&Pt()});var ai=Ye.prototype.put,ui=Ye.prototype.remove;ye.on(ye.Events.Plugins,function(e,t,i){var n=Z(i.methods,ni.methods);I(n)||c(e.prototype,n)}),ye.on(ye.Events.Plugins,function(e,t,i){e.persist=function(t,i,n,s){var r=s||this;return e.findOrCreate(t,i,function(e,t){t||e.$save(i),n&&n.call(r,e)})}}),ye.on(ye.Events.Plugins,function(e,t,i){e.ready=function(e,i,n){t.ready(e,i,n)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.refresh=function(e,i){return t.refresh(e,i)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.search=function(e,i,n,s){return new et(t,e,i,n,s)}}),ye.on(ye.Events.Plugins,function(e,t,i){e.searchPaged=function(e,i,n,s){return new tt(t,e,i,n,s)}}),ye.on(ye.Events.Options,function(e){var t=e.shard||ni.shard;M(t)&&(e.createRest=ye.shard(t))}),ye.on(ye.Events.Plugins,function(e,t,i){function s(e,t){return M(e)&&M(t)?Z(e,t):e||t}function r(e){return y===!0||n(y,e)!==!1}function o(e,t){return M(t)?t[e]:t}function a(e){var t=o(e,m);return function(){return Vt(new Date,t)}}function u(e,t,i,n){var s=o(i,p),r=Vt(e,s);return r||e}function h(e,t,i){var n=o(i,m),s=o(i,E),r=Vt(e,n,s);return r||e}function l(e){var i=n(t.fields,e);i===!1&&(t.fields.push(e),t.saveFields.push(e)),!r(e)||e in t.defaults||(t.defaults[e]=a(e)),!p||e in t.encodings||(t.encodings[e]=u),!m||e in t.decodings||(t.decodings[e]=h)}function d(e){l(e),t.ignoredFields[e]=!0}function c(i){l(i),t.ignoredFields[i]=!0,f(e.prototype,"$save",function(e){return function(){this[i]=F(t.defaults[i]),e.apply(this,arguments)}})}function v(e,t){switch(e){case"created_at":return d(t);case"updated_at":return c(t);default:return l(t)}}var g=i.timestamps||ni.timestamps,p=s(i.timestampFormat,ni.timestampFormat),m=s(i.timestampType,ni.timestampType),E=s(i.timestampUTC,ni.timestampUTC),y=i.timestampCurrent||ni.timestampCurrent;if(g)if($(g))v(g,g);else if(A(g))for(var R=0;R<g.length;R++)v(g[R],g[R]);else if(M(g))for(var S in g)v(S,g[S]);else d("created_at"),c("updated_at")});var hi={Date:"date",Millis:"millis",Seconds:"seconds"};ni.timestampFormat=hi.Millis,ni.timestampType=hi.Date,ni.timestampUTC=!1,ni.timestampCurrent=["created_at","updated_at"],ye.Timestamp=hi,ye.formatDate=_,ye.convertDate=Vt,ye.on(ye.Events.Plugins,function(e,t,i){e.where=function(e,i,n,s){return t.models.where(e,i,n,s)}}),e.Rekord=ye,ye.Model=Ve,ye.Database=Ne,ye.Defaults=ni,ye.Relation=ft,ye.Operation=nt,ye.Search=et,ye.SearchPaged=tt,ye.Promise=it,ye.KeyHandler=Ge,ye.KeySimple=ze,ye.KeyComposite=Qe,ye.enableKeyChanges=Pt,ye.disableKeyChanges=Kt,ye.Cascade=Bt,ye.Cache=qt,ye.Store=Jt,ye.Save=jt,ye.Load=Wt,ye.Map=Ye,ye.Collection=Be,ye.FilteredCollection=Je,ye.ModelCollection=je,ye.FilteredModelCollection=We,ye.Page=qe,ye.HasOne=mt,ye.BelongsTo=pt,ye.HasMany=Et,ye.HasManyThrough=$t,ye.HasRemote=yt,ye.HasList=Rt,ye.isRekord=E,ye.isDefined=p,ye.isFunction=m,ye.isString=$,ye.isNumber=y,ye.isBoolean=R,ye.isDate=S,ye.isRegExp=b,ye.isArray=A,ye.isObject=M,ye.isValue=O,ye.noop=_,ye.bind=D,ye.uuid=T,ye.sizeof=N,ye.isEmpty=I,ye.evaluate=F,ye.toArray=i,ye.indexOf=n,ye.collect=s,ye.swap=r,ye.reverse=o,ye.isSorted=a,ye.isPrimitiveArray=u,ye.extend=h,ye.extendArray=l,ye.addMethod=Yt,ye.addMethods=c,ye.replaceMethod=f,ye.copyConstructor=v,ye.factory=g,ye.Comparators=xt,ye.saveComparator=C,ye.addComparator=k,ye.createComparator=U,ye.equalsStrict=H,ye.equalsWeak=P,ye.equalsCompare=K,ye.equals=V,ye.compareNumbers=w,ye.compare=Y,ye.addEventFunction=x,ye.addEventful=G,ye.applyOptions=z,ye.propsMatch=Q,ye.hasFields=B,ye.updateFieldsReturnChanges=J,ye.clearFieldsReturnChanges=q,ye.grab=j,ye.pull=W,ye.transfer=X,ye.collapse=Z,ye.clean=ee,ye.cleanFunctions=te,ye.copy=ie,ye.diff=ne,ye.isParseInput=se,ye.parse=re,ye.createParser=oe,ye.isFormatInput=ae,ye.format=ue,ye.createFormatter=he,ye.parseDate=le,ye.NumberResolvers=Gt,ye.saveNumberResolver=de,ye.createNumberResolver=ce,ye.PropertyResolvers=zt,ye.savePropertyResolver=fe,ye.createPropertyResolver=ve,ye.toCamelCase=pe,ye.split=me,ye.Wheres=Qt,ye.saveWhere=Ee,ye.createWhere=$e}(this);
//# sourceMappingURL=rekord.min.js.map
