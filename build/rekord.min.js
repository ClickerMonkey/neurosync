!function(e,t){function n(e,t){return e instanceof Array?e:E(e)?e.split(t):O(e)?[e]:[]}function i(e,t,n){for(var i=n||k,s=0,r=e.length;r>s;s++)if(i(e[s],t))return s;return!1}function s(e){var t=arguments.length>1||!A(e)?Array.prototype.slice.call(arguments):e;return new Ce(t)}function r(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function a(e){for(var t=e.length,n=Math.floor(t/2),i=0;n>i;i++)r(e,t-i-1,i);return e}function o(e,t){if(!e)return!0;for(var n=0,i=t.length-1;i>n;n++)if(e(t[n],t[n+1])>0)return!1;return!0}function u(e){for(var t=0;t<e.length;t++){var n=e[t];if(O(n))return!M(n)}return!0}function l(e,t,n){e=v(e),t.prototype=new e,d(t.prototype,n),t.prototype.constructor=t}function h(e,t,n){c()?(l(e,t,n),t.create=g(t)):(e=v(e),t.create=function(){var i=new e;return t.apply(i,arguments),j(n,i),i})}function c(){function e(){}if(c.supported===t){e.prototype=[];var n=new e;n.push(0),c.supported=1===n.length}return c.supported}function d(e,t){for(var n in t)Kt(e,n,t[n])}function f(e,t,n){Kt(e,t,n(e[t]))}function v(e){function t(){}return t.prototype=e.prototype,t}function g(e){function t(t){return e.apply(this,t)}return t.prototype=e.prototype,function(){return new t(arguments)}}function m(e){return e!==t}function p(e){return!!(e&&e.constructor&&e.call&&e.apply)}function $(e){return!!(e&&e.Database&&p(e)&&e.prototype instanceof Te)}function E(e){return"string"==typeof e}function R(e){return"number"==typeof e&&!isNaN(e)}function b(e){return"boolean"==typeof e}function y(e){return e instanceof Date}function S(e){return e instanceof RegExp}function A(e){return e instanceof Array}function M(e){return null!==e&&"object"==typeof e}function O(e){return!(e===t||null===e)}function _(){}function D(e,t){return function(){t.apply(e,arguments)}}function L(){return N()+N()+"-"+N()+"-"+N()+"-"+N()+"-"+N()+N()+N()}function N(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function T(e){if(A(e)||E(e))return e.length;if(M(e)){var t=0;for(var n in e)t++;return t}return R(e)?e:0}function F(e){if(null===e||void 0===e||0===e)return!0;if(A(e)||E(e))return 0===e.length;if(y(e))return 0===e.getTime()||isNaN(e.getTime());if(M(e)){for(var t in e)return!1;return!0}return!1}function I(e){return O(e)?$(e)?new e:p(e)?e():X(e):e}function C(e,t,n){return Gt[e]=P(t,n)}function U(e,t,n){var i=P(t,n);return p(e)?function(t,n){var s=i(t,n);return 0!==s?s:e(t,n)}:i}function P(e,t){if(p(e))return e;if(E(e)){if(e in Gt)return Gt[e];if("-"===e.charAt(0)){var n=P(e.substring(1),!t);return function(e,t){return-n(e,t)}}return-1!==e.indexOf("{")?function(t,n){var i=ne(e,t),s=ne(e,n);return i.localeCompare(s)}:-1!==e.indexOf(".")?function(n,i){var s=te(e,n),r=te(e,i);return V(s,r,t)}:function(n,i){var s=O(n)?n[e]:n,r=O(i)?i[e]:i;return V(s,r,t)}}if(A(e)){for(var n=[],i=0;i<e.length;i++)n[i]=P(e[i],t);return function(e,t){for(var i=0,s=0;s<n.length&&0===i;s++)i=n[s](e,t);return i}}return null}function k(e,t){return e===t}function w(e,t){return 0===V(e,t)}function H(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,i=typeof t;if(n!==i)return!1;var s=A(e),r=A(t);if(s!==r)return!1;if(s){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!H(e[a],t[a]))return!1;return!0}if(y(e))return y(t)&&H(e.getTime(),t.getTime());if(S(e))return S(t)&&e.toString()===t.toString();if("object"===n){for(var o in e)if(!("$"===o.charAt(0)||p(e[o])||o in t&&H(e[o],t[o])))return!1;for(var o in t)if(!("$"===o.charAt(0)||p(t[o])||o in e))return!1;return!0}return!1}function x(e,t){return e===t?0:t>e?-1:1}function V(e,t,n){if(e==t)return 0;var i=O(e),s=O(t);return i!==s?i&&!n||s&&n?-1:1:(y(e)&&(e=e.getTime()),y(t)&&(t=t.getTime()),R(e)&&R(t)?x(e,t):A(e)&&A(t)?x(e.length,t.length):b(e)&&b(t)?e?-1:1:(e+"").localeCompare(t+""))}function Y(e,t,n,i){var s=i?"$on":"on",r=i?"$off":"off";Kt(e,t,function(e,t){function i(){var n=e.apply(t||o,arguments);n===!1&&a()}function a(){u||(o[r](n,i),u=!0)}var o=this,u=!1;return o[s](n,i),a})}function K(e,t){function i(e,t,i,s,r){if(!p(s))return _;var i=n(i," "),a=e[t];a||(a=e[t]={});for(var u=0;u<i.length;u++){var l=i[u],h=a[l];h||(h=a[l]=[]),h.push([s,r||e,0])}return function(){for(var e=0;e<i.length;e++)o(a,i[e],s)}}function s(e,t,n){return i(this,"$$on",e,t,n)}function r(e,t,n){return i(this,"$$once",e,t,n)}function a(e,t,n){return i(this,"$$after",e,t,n)}function o(e,t,n){if(e&&t in e)for(var i=e[t],s=i.length-1;s>=0;s--)i[s][d]===n&&i.splice(s,1)}function u(e,t){e&&t in e&&delete e[t]}function l(e,t){if(m(e)){var e=n(e," ");if(p(t))for(var i=0;i<e.length;i++)o(this.$$on,e[i],t),o(this.$$once,e[i],t),o(this.$$after,e[i],t);else for(var i=0;i<e.length;i++)u(this.$$on,e[i]),u(this.$$once,e[i]),u(this.$$after,e[i])}else u(this,"$$on"),u(this,"$$once"),u(this,"$$after");return this}function h(e,t,n,i){if(e&&t in e){for(var s=e[t],r=++g,a=0;a<s.length;a++){var o=s[a];o&&o[v]!==r&&(o[v]=r,o[d].apply(o[f],n),o!==s[a]&&(a=-1))}i&&delete e[t]}}function c(e,t){for(var e=n(e," "),i=0;i<e.length;i++){var s=e[i];h(this.$$on,s,t,!1),h(this.$$once,s,t,!0),h(this.$$after,s,t,!1)}return this}var d=0,f=1,v=2,g=0;t?(Kt(e,"$on",s),Kt(e,"$once",r),Kt(e,"$after",a),Kt(e,"$off",l),Kt(e,"$trigger",c)):(Kt(e,"on",s),Kt(e,"once",r),Kt(e,"after",a),Kt(e,"off",l),Kt(e,"trigger",c))}function G(e,n,i,s){function r(t,n){p(n)?Kt(e,t,n):e[t]=n}n=n||{};for(var a in i){var o=i[a],u=n[a],l=O(u);if(!l&&o===t)throw a+" is a required option";l?r(a,u):r(a,X(o))}for(var a in n)a in i||r(a,n[a]);s?e.$options=n:e.options=n}function z(e,t,n,i,s){var r=s||ve.equals;if(E(t))return r(e[t],n[i]);for(var a=0;a<t.length;a++){var o=t[a],u=i[a];if(!r(e[o],n[u]))return!1}return!0}function q(e,t,n){if(A(t)){for(var i=0;i<t.length;i++)if(!n(e[t[i]]))return!1;return!0}return n(e[t])}function Q(e,t,n){for(var i={},s=0;s<t.length;s++){var r=t[s];r in e&&(i[r]=n?X(e[r]):e[r])}return i}function B(e,t,n){if(E(t)){var i=e[t];return n?X(i):i}for(var s=[],r=0;r<t.length;r++){var a=t[r],i=e[a];s.push(n?X(i):i)}return s}function j(e,t){for(var n in e)t[n]=e[n];return t}function J(){for(var e={},t=0;t<arguments.length;t++){var n=arguments[t];if(M(n))for(var i in n)i in e||(e[i]=n[i])}return e}function W(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function Z(e){for(var t in e)p(e[t])&&delete e[t];return e}function X(e,n){if(null===e||e===t||"object"!=typeof e||p(e)||S(e))return e;if(A(e)){for(var i=[],s=0;s<e.length;s++)i.push(X(e[s],n));return i}if(y(e))return new Date(e.getTime());var i={};for(var r in e)(n||"$"!==r.charAt(0))&&(i[r]=X(e[r],n));return i}function ee(e,t,n,i){for(var s={},r=0;r<n.length;r++){var a=n[r];i(e[a],t[a])||(s[a]=X(e[a]))}return s}function te(e,t){var n=!0;return e.replace(te.REGEX,function(e){if(n)if(A(t)){var i=parseInt(e);isNaN(i)?n=!1:t=t[i]}else if(M(t))if(e in t){var s=t[e];t=p(s)?s():s}else n=!1;else n=!1}),n?t:void 0}function ne(e,t){return e.replace(ne.REGEX,function(e){return te(e,t)})}function ie(e){return function(t){return ne(e,t)}}function se(e,t){return E(e)&&(t&&(e+=" UTC"),e=Date.parse?Date.parse(e):new Date(e)),R(e)&&(e=new Date(e)),y(e)&&R(e.getTime())?e:!1}function re(e,t){return zt[e]=ae(t)}function ae(e){var t=ue(e);return E(e)&&e in zt?zt[e]:function(e){return parseFloat(t(e))}}function oe(e,t,n){return qt[e]=ue(t,n)}function ue(e,n){if(p(e))return e;if(E(e))return e in qt?qt[e]:-1!==e.indexOf("{")?function(t){return ne(e,t)}:-1!==e.indexOf(".")?function(t){return te(e,t)}:function(n){return n?n[e]:t};if(A(e))return function(t){return B(t,e).join(n)};if(M(e)){var i=[],s=[];for(var r in e)i.push(r),s.push(ue(e[r],n));return function(e){for(var t=[],a=0;a<r.length;a++)t.push(s[a](e[i[a]]));return t.join(n)}}return function(e){return e}}function le(e){return 1===e.length?e.toUpperCase():e.charAt(1).toUpperCase()}function he(e){return e.replace(he.REGEX,le)}function ce(e,t,n){for(var i=e.split(t),s=0,r=i.length-2;r>s;){var a=i[s],o=a.length-n.length;if(a.substring(o)===n){var u=i[s+1],l=i[s+2],h=a.substring(0,o)+u+l;i.splice(s,3,h),r-=2}else s+=1,i.splice(s,1),r-=1}return i}function de(e,t,n,i){return Qt[e]=fe(t,n,i)}function fe(e,t,n){var i=n||k;if(p(e))return e;if(A(e)){for(var s=[],r=0;r<e.length;r++){var a=e[r];s.push(A(a)?fe.apply(this,a):fe(a))}return function(e){for(var t=0;t<s.length;t++)if(!s[t](e))return!1;return!0}}if(M(e))return function(t){for(var n in e)if(!i(t[n],e[n]))return!1;return!0};if(E(e)){if(e in Qt)return Qt[e];var o=ue(e);return O(t)?function(e){return i(o(e),t)}:function(e){return O(o(e))}}return function(e){return!0}}function ve(e){var t=ve.get(e.name);if(t.isComplete())return t.results[0];ve.trigger(ve.Events.Options,[e]);var n=new ye(e),i=new Function("return function "+n.className+"(props, remoteData) { this.$init( props, remoteData ) }")();return i.prototype=new Te(n),n.Model=i,i.Database=n,ve.classes[n.name]=i,ve.trigger(ve.Events.Plugins,[i,n,e]),ve.autoload?n.loadBegin(function(e){e&&n.loadFinish()}):ve.unloaded.push(n),ve.get(n.name).resolve(i),ve.get(n.className).resolve(i),ve.debug(ve.Debugs.CREATION,n,e),i}function ge(e,t){return!R(e)||(e&t)===t}function me(e,t,i){for(var s=n(e,/\s*,\s/),r=n(t,/\s*,\s/),a=en.push(i)-1,o=0;o<s.length;o++){var u=s[o],l=pe(r,a);if(E(u))u in ve.classes?l(ve.classes[u]):!function(e,t){ve.on(ve.Events.Plugins,function(n,i){i.name===e&&t(n)})}(u,l);else if($(u))l(u);else{if(u!==!0)throw u+" is not a valid input for batching";for(databaseName in ve.classes)l(ve.classes[databaseName]);ve.on(ve.Events.Plugins,l)}}}function pe(e,t){return function(n){for(var i=n.Database,s=i.rest,r=Xt[t]=[],a=0;a<e.length;a++){var o=e[a];switch(o){case"all":s.all=function(e,t){r.push({database:i,"class":n,operation:"all",success:e,failure:t})};break;case"get":s.get=function(e,t,s){r.push({database:i,"class":n,operation:"get",success:t,failure:s,model:e})};break;case"create":s.create=function(e,t,s,a){r.push({database:i,"class":n,operation:"create",success:s,failure:a,model:e,encoded:t})};break;case"update":s.update=function(e,t,s,a){r.push({database:i,"class":n,operation:"update",success:s,failure:a,model:e,encoded:t})};break;case"remove":s.remove=function(e,t,s){r.push({database:i,"class":n,operation:"remove",success:t,failure:s,model:e})};break;case"query":s.query=function(e,t,s,a){r.push({database:i,"class":n,operation:"query",success:s,failure:a,url:e,encoded:t})};break;default:throw o+" is not a valid operation you can batch"}}}}function $e(){for(var e=0;e<Xt.length;e++){var t=Xt[e],n=en[e];t.length&&(n(t),t.length=0)}}function Ee(){Zt++}function Re(){Zt--,0===Zt&&$e()}function be(e){var t=!1,n=[],i=function(){t?e.apply(this,arguments):n.push(this,Yt.slice.apply(arguments))};return i.open=function(){if(!t){for(var i=0;i<n.length;i+=2){var s=n[i],r=n[i+1];e.apply(s,r)}n.length=0,t=!0}},i}function ye(e){var t=ye.Defaults;G(this,e,t);for(var s in e)s in t||(this[s]=e[s]);var r=this.key,a=this.fields;if(A(r))for(var o=r.length-1;o>=0;o--)i(a,r[o])===!1&&a.unshift(r[o]);else i(a,r)===!1&&a.unshift(r);this.keys=n(this.key),this.models=new ke(this),this.all={},this.loaded={},this.className=this.className||he(this.name),this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.firstRefresh=!1,this.pendingOperations=0,this.afterOnline=!1,this.saveFields=X(a),this.readyPromise=new Ke(null,!1),this.prepare(this,e),this.rest=this.createRest(this),this.store=this.createStore(this),this.live=this.createLive(this),this.setComparator(this.comparator,this.comparatorNullsFirst),this.setRevision(this.revision),this.setSummarize(this.summarize),this.relations={},this.relationNames=[];for(var u in e)if(u in ve.Relations){var l=ve.Relations[u];if(l.prototype instanceof et){var h=e[u];for(var c in h){var d=h[c],f=new l;f.init(this,c,d),f.save&&this.saveFields.push(c),this.relations[c]=f,this.relationNames.push(c)}}}}function Se(e,t,n){var i=this.encodings;for(var s in t)s in i&&(t[s]=i[s](t[s],e,s,n));return t}function Ae(e){var t=this.decodings;for(var n in e)n in t&&(e[n]=t[n](e[n],e,n));return e}function Me(e){return e.$key()}function Oe(e){return ve.rest(e)}function _e(e){return ve.store(e)}function De(e){return ve.live(e)}function Le(e){return e}function Ne(e){return e}function Te(e){this.$db=e}function Fe(e,t,n,i,s,r,a){var o=new Ke(null,!1);if(ge(t,Bt.Rest))var u=e.$once(n,function(t){l(),h(),o.resolve(e,t)}),l=e.$once(i,function(t,n){u(),h(),o.reject(e,n,t)}),h=e.$once(s,function(){u(),l(),o.noline(e)});else if(ge(t,Bt.Local))var u=e.$once(r,function(t){l(),o.resolve(e,t)}),l=e.$once(a,function(t,n){u(),o.reject(e,t)});else o.resolve(e);return o}function Ie(){this.values=[],this.keys=[],this.indices={}}function Ce(e){this.addAll(e,!0)}function Ue(e,t,n){this.onChanges=D(this,this.handleChanges),this.pageSize=t,this.pageIndex=n||0,this.pageCount=0,this.setCollection(e)}function Pe(e,t){this.bind(),this.init(e,t)}function ke(e,t,n){this.init(e,t,n)}function we(e,t){this.bind(),this.init(e,t)}function He(e,t,n,i,s){this.model=t,this.relator=n,this.init(e,i,s)}function xe(e,t,n){e.discriminator=t,e.discriminatorsToModel=n;var i=(e.buildKeyFromInput,e.parseModel,e.clone),s=e.cloneEmpty;return d(e,{buildKeyFromInput:function(e){if(M(e)){var t=e[this.discriminator],n=this.discriminatorsToModel[t];if(n)return n.Database.buildKeyFromInput(e)}return e},parseModel:function(e,t){if(e instanceof Te)return e;var n=O(e)?e[this.discriminator]:null,i=this.discriminatorsToModel[n];return i?i.Database.parseModel(e,t):null},clone:function(){return xe(i.apply(this),t,n)},cloneEmpty:function(){return xe(s.apply(this),t,n)}}),e}function Ve(e,t,n,i,s){this.$init(e,t,n,i,s)}function Ye(e,t,n,i,s){this.$init(e,t,n,i,s)}function Ke(e,t){this.status=Ke.Status.Pending,this.results=null,this.cancelable=t!==!1,p(e)&&e(D(this,this.resolve),D(this,this.reject),D(this,this.noline),D(this,this.cancel))}function Ge(){}function ze(e,t){this.reset(e,t)}function qe(e,t){this.reset(e,t)}function Qe(e,t){this.reset(e,t)}function Be(e,t){this.reset(e,t)}function je(e,t){this.reset(e,t)}function Je(e,t){this.reset(e,t)}function We(e,t){this.reset(e,t)}function Ze(e,t){this.reset(e,t)}function Xe(e,t){this.reset(e,t)}function et(){}function tt(){}function nt(){}function it(){}function st(){}function rt(){}function at(){}function ot(){}function ut(e){this.database=e}function lt(e,t,n){var i=p(n)?n:M(n)&&p(n.get)?n.get:_,s=M(n)&&p(n.set)?n.set:_;if(Object.defineProperty)Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i,set:s});else{var r=e.$init;e.$init=function(){r.apply(this,arguments);var e=this[t]=i.apply(this),n=function(){var n=this[t];n!==e?s.call(this,n):e=this[t]=i.apply(this)};this.$after(Te.Events.Changes,n,this)}}}function ht(e,t,n,i){var s={on:n?"$on":"on",once:n?"$once":"once",after:n?"$after":"after"},r=i||[];if(p(t))r.push({when:s.on,events:e,invoke:t});else if(A(t)&&2===t.length&&p(t[0]))r.push({when:s.on,events:e,invoke:t[0],context:t[1]});else if(M(t))for(var a in t)if(a in s){var o=t[a],u=s[a];p(o)?r.push({when:u,events:e,invoke:o}):A(o)&&2===o.length&&p(o[0])&&r.push({when:u,events:e,invoke:o[0],context:o[1]})}return r}function ct(e,t){for(var n=0;n<t.length;n++){var i=t[n];e[i.when](i.events,i.invoke,i.context)}}function dt(){return e.File&&e.FileReader&&e.FileList}function ft(t){return t instanceof e.File?t:t instanceof e.Blob?t:t instanceof e.FileList&&t.length>0?t[0]:!1}function vt(e){return e}function gt(e){var t=E(e)?e.indexOf(";base64,"):-1;return-1===t?e:e.substring(t+8)}function mt(e,t){t.autoSave&&e.$isSaved()&&e.$save()}function pt(e,t,n,i,s){e.$files=e.$files||{},e.$files[t]={value:n,user:n,file:i,options:s}}function $t(e,n,i,s,r){var a=t,o=!1;return e&&e.valueToUser?e.valueToUser(n,i,s,function(e){i.$files[s].user=e,o?(i[s]=e,mt(i,r)):a=e}):a=n,o=!0,a}function Et(n,i,s){var r=ve.fileProcessors[s.processor];return n in e.FileReader.prototype||ve.trigger(ve.Events.FilesNotSupported),function(a,o,u){var l=ft(a);if(l!==!1){var h=new e.FileReader,c=t,d=!1;return h.onload=function(e){var t=i(e.target.result);pt(o,u,t,l,s),c=$t(r,t,o,u,s),d&&(o[u]=c,mt(o,s))},h[n](l),d=!0,c}if(M(a)&&a.FILE){var c=t,f=function(e){c=e};return ve.trigger(ve.Events.FileOffline,[a,o,u,f]),c}return pt(o,u,a,null,s),$t(r,a,o,u,s)}}function Rt(e,n,i,s){if(n.$files&&i in n.$files){var r=n.$files[i];if(s&&r.save===!1||!s&&r.store===!1)return t;if(!s&&r.file){var a=Q(r.file,ve.fileProperties,!1);return a.FILE=!0,a}if(e===r.user)return s&&r.file&&n.$once(Te.Events.RemoteSave,function(){delete r.file,n.$addOperation(We,Bt.Local)}),r.value}return e}function bt(e,t,n){var i=se(e,n);if(i===!1)return!1;if(!t)return i;switch(t){case rn.Date:return i;case rn.Millis:return i.getTime();case rn.Seconds:return Math.floor(i.getTime()/1e3);default:return ve.formatDate(i,t)}}function yt(e){var t=parseFloat(e);return isNaN(t)||(e=t),e}function St(e){var t=parseInt(e);return isNaN(t)||(e=t),e}function At(e){return y(e)?e.setHours(0,0,0,0):R(e)&&(e-=e%864e5),e}function Mt(e){return y(e)?e.setHours(23,59,59,999):R(e)&&(e=e-e%864e5+864e5-1),e}function Ot(e,t,n){an.Rules[e]=function(t,i,s,r,a){Nt(e,t,i);var o=_t(e,a);return function(e,i,s){function a(t){e=t}return n(e,i,a)&&s(Tt(t,r(t),e,i,o)),e}},an.Rules[e].message=t}function _t(e,t){return t||an.Rules[e].message}function Dt(e,t,n,i){var s=e.slice();if(i)for(var r=0;r<s.length;r++)s[r]=i(s[r]);var a=s.pop(),t=t||"and",n=n||", ";switch(s.length){case 0:return a;case 1:return s[0]+" "+t+" "+a;default:return s.join(n)+n+t+" "+a}}function Lt(e,t){for(var n={},i=0;i<e.length;i++)n[e[i]]=t;return n}function Nt(e,t,n){if(n)throw"the rule "+e+" for field "+t+" has no arguments"}function Tt(e,t,n,i,s,r){p(s)&&(s=s(e,t,n,i,r));var a={};return a.$field=e,a.$alias=t,a.$value=n,j(i,a),M(r)&&j(r,a),ne(s,a)}function Ft(e,t,n){an.Rules[e]=function(t,s,r,a,o){if(!s)throw e+" validation rule requires field & value arguments";var u,l,h;if(E(s)){var c=s.indexOf(",");if(-1===c)throw e+" validation rule requires field & value arguments";u=s.substring(0,c),l=s.substring(c+1)}else A(s)?(u=s[0],l=s[1],h=s[2]):M(s)&&(u=s.field,l=s.value,h=s.equals);if(p(h)||(h=w),-1===i(r.fields,u))throw otherField+" is not a valid field for the "+e+" rule";var d=_t(e,o),f={$matchField:u,$matchAlias:a(u),$matchValue:l};return function(e,i,s){return n(e,i,u,l,h)&&s(Tt(t,a(t),e,i,d,f)),e}},an.Rules[e].message=t}function It(e,t,n){an.Rules[e]=function(t,i,s,r,a){if(!i)throw e+" validation rule requires a date expression argument";var o;if(E(i))o=an.parseExpression(i,s);else if(p(i))o=i;else{var u=se(i);if(u!==!1){var l=u.getTime();o=function(){return l}}}if(!o||o===_)throw i+" is not a valid date expression for the "+e+" rule";var h=_t(e,a),c={$date:i};return function(e,i,s){var a=se(e);if(a!==!1){e=a.getTime();var u=o(e,i);R(u)&&n(e,u)&&s(Tt(t,r(t),e,i,h,c))}return e}},an.Rules[e].message=t}function Ct(e,t,n){an.Rules[e]=function(t,s,r,a,o){if(!s)throw e+" validation rule requires a field and list arguments";var u,l;if(E(s)){var h=ce(s,/(,)/,"\\");u=h.shift(),l=h}else A(s)?(u=s.shift(),l=s):M(s)&&(u=s.field,l=s.values);if(i(r.fields,u)===!1)throw u+" is not a valid field for the "+e+" rule";var c=_t(e,o),d=Dt(l),f={$params:s,$matchField:u,$matchAlias:a(u),$list:d},v=Lt(l,!0);return function(e,i,s){return n(e,i,u,l,v)&&s(Tt(t,a(t),e,i,c,f)),e}},an.Rules[e].message=t}function Ut(e,t,n){an.Rules[e]=function(t,s,r,a,o){if(!s)throw e+" validation rule requires an array of fields argument";for(var u=ce(s,/(\s*,\s*)/,"\\"),l=0;l<u.length;l++)if(-1===i(r.fields,u[l]))throw u[l]+" is not a valid field for the "+e+" rule";var h=_t(e,o),c=Dt(u),d=Dt(u,!1,!1,a),f={$fields:c,$fieldAliases:d};return function(e,i,s){function r(t){e=t}return n(e,i,u,r)&&s(Tt(t,a(t),e,i,h,f)),e}},an.Rules[e].message=t}function Pt(e,t,n){an.Rules[e]=function(t,s,r,a,o){var u,l,h;if(!O(s)||E(s)){var c=ce(s||"",/(\s*,\s*)/,"\\");u=c[0]||r.name,h=c[1]||t,l=null}else A(s)?(u=E(s[0])?s.shift():r.name,h=E(s[0])?s.shift():t,l=new ke(r,s)):M(s)&&(u=s.model||r.name,h=s.field||t,l=s.models);if(!l){if(!u)throw"model, model class, or models is required for "+e+" rule";E(u)?ve.get(u).success(function(e){l=e.all()}):$(u)&&(l=u.all())}if(i(r.fields,h)===!1)throw h+" is not a valid field for the "+e+" rule";var d=_t(e,o),f={$class:u,$matchField:h,$matchAlias:a(h)};return function(e,i,s){return l&&O(e)&&n(e,i,l,h)&&s(Tt(t,a(t),e,i,d,f)),e}},an.Rules[e].message=t}function kt(e,t){an.Rules[e]=function(n,s,r,a,o){if(!s)throw e+" validation rule requires a validation rule argument";var u,l;if(E(s)){var h=s.indexOf(":");if(-1===h)throw s+" is not a valid argument for the "+e+" rule";u=s.substring(0,h)||n,l=s.substring(h+1)}else A(s)?(u=s.shift()||n,l=s):M(s)&&(u=s.field||n,l=s.rules);if(-1===i(r.fields,u))throw u+" is not a valid field for the "+e+" rule";if(!l)throw"rules are required for the "+e+" rule";var c=an.parseRules(l,u,r,a);return function(e,n,i){for(var s=0,r=function(e){e&&s++},a=0;a<c.length;a++)c[a](e,n,r);return t(s,c.length)?an.Stop:e}}}function wt(e,t,n){an.Rules[e]=function(t,s,r,a,o){if(!s)throw e+" validation rule requires a list argument";var l,h=!1;if(E(s)?l=ce(s,/(,)/,"\\"):A(s)?l=s:p(s)&&(l=h),h!==!1&&(!l||0===l.length))throw s+" is not a valid list of values for the "+e+" rule";if(u(l)){var c=Lt(l,!0);h=function(e){return c[e]}}else h=function(e){return i(l,e,H)};var d=_t(e,o),f=Dt(l,"or"),v={$params:s,$list:f};return function(e,i,s){return n(e,i,h)&&s(Tt(t,a(t),e,i,d,v)),e}},an.Rules[e].message=t}function Ht(e,t,n){an.Rules[e]=function(t,i,s,r,a){if(!i)throw e+" validation rule requires a range argument";var o,u;if(E(i)){var l=ce(i,/(\s*,\s*)/,"\\");o=parseFloat(l[0]),u=parseFloat(l[1])}else A(i)?(o=i[0],u=i[1]):M(i)&&(o=i.start,u=i.end);if(isNaN(o)||isNaN(u))throw i+" is not a valid range of numbers for the "+e+" rule";E(a)&&(a={string:a,number:a,object:a});var h=_t(e,a),c={$start:o,$end:u};return function(e,i,s){var a=T(e),l=typeof e,d=h[l];return d&&n(a,o,u)&&(c.$size=a,s(Tt(t,r(t),e,i,d,c))),e}},an.Rules[e].message=t}function xt(e,t,n){an.Rules[e]=function(t,i,s,r,a){Nt(e,t,i);var o=_t(e,a);return function(e,i,s){return n.test(e)||s(Tt(t,r(t),e,i,o)),e}},an.Rules[e].message=t}function Vt(e,t,n){an.Rules[e]=function(t,i,s,r,a){var o;if(E(i)?o=parseFloat(i):R(i)&&(o=i),isNaN(o))throw'"'+i+'" is not a valid number for the '+e+" rule";E(a)&&(a={string:a,number:a,object:a});var u=_t(e,a),l={$number:i};return function(e,i,s){var a=T(e),h=typeof e,c=u[h];return c&&n(a,o)&&(l.$size=a,s(Tt(t,r(t),e,i,c,l))),e}},an.Rules[e].message=t}var Yt=Array.prototype,Kt=function(){return Object.defineProperty?function(e,t,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!1,value:n})}:function(e,t,n){e[t]=n}}(),Gt={};te.REGEX=/([\w$]+)/g,ne.REGEX=/\{[^\}]+\}/g;var zt={},qt={};he.REGEX=/(^.|_.)/g;var Qt={};ve.classes={},ve.autoload=!1,ve.unloaded=[],ve.loadPromise=null,ve.load=function(e,t){function n(e,t){if(a.push(e),r.push(t),r.length===s.length){for(var n=0;n<r.length;n++){var t=r[n],e=a[n];e&&t.loadFinish()}i.reset().resolve()}}var i=ve.loadPromise=ve.loadPromise||new Ke(null,!1),s=ve.unloaded.slice(),r=[],a=[];i.success(e,t||this),ve.unloaded.length=0;for(var o=0;o<s.length;o++)s[o].loadBegin(n);return i},ve.promises={},ve.get=function(e){return ve.promises[e]=ve.promises[e]||new Ke(null,!1)},K(ve),ve.Events={Initialized:"initialized",Plugins:"plugins",Options:"options",Online:"online",Offline:"offline"};var Bt={None:0,Local:1,Rest:2,NoLive:3,Live:4,NoRest:5,Remote:6,All:7},jt={None:"none",Pending:"pending",All:"all"},Jt={None:0,Model:1,Key:2,Keys:3},Wt={None:0,Model:4,Key:5,Keys:6};ve.debug=function(e,t){},ve.setDebug=function(e,t){(!ve.debugSet||t)&&(ve.debug=e,ve.debugSet=!0)},ve.Debugs={CREATION:0,REST:1,AUTO_REFRESH:73,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL:33,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,GET_LOCAL_SKIPPED:104,GET_LOCAL:105,GET_LOCAL_ERROR:106,GET_REMOTE:107,GET_REMOTE_ERROR:108,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,HASONE_QUERY:111,HASONE_QUERY_RESULTS:112,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:72,BELONGSTO_QUERY:113,BELONGSTO_QUERY_RESULTS:114,HASMANY_INIT:74,HASMANY_NINJA_REMOVE:75,HASMANY_NINJA_SAVE:76,HASMANY_INITIAL:77,HASMANY_INITIAL_PULLED:78,HASMANY_REMOVE:79,HASMANY_SORT:80,HASMANY_ADD:81,HASMANY_LAZY_LOAD:82,HASMANY_INITIAL_GRABBED:83,HASMANY_NINJA_ADD:84,HASMANY_AUTO_SAVE:85,HASMANY_PREREMOVE:86,HASMANY_POSTSAVE:87,HASMANY_QUERY:115,HASMANY_QUERY_RESULTS:116,HASMANYTHRU_INIT:88,HASMANYTHRU_NINJA_REMOVE:89,HASMANYTHRU_NINJA_SAVE:90,HASMANYTHRU_NINJA_THRU_REMOVE:91,HASMANYTHRU_INITIAL:92,HASMANYTHRU_INITIAL_PULLED:93,HASMANYTHRU_REMOVE:94,HASMANYTHRU_SORT:95,HASMANYTHRU_ADD:96,HASMANYTHRU_LAZY_LOAD:97,HASMANYTHRU_INITIAL_GRABBED:98,HASMANYTHRU_NINJA_ADD:99,HASMANYTHRU_AUTO_SAVE:100,HASMANYTHRU_PREREMOVE:101,HASMANYTHRU_POSTSAVE:102,HASMANYTHRU_THRU_ADD:103,HASMANYTHRU_THRU_REMOVE:68,HASMANYTHRU_QUERY:117,HASMANYTHRU_QUERY_RESULTS:118,HASREMOTE_INIT:50,HASREMOTE_SORT:121,HASREMOVE_NINJA_REMOVE:109,HASREMOVE_NINJA_SAVE:110,HASREMOVE_QUERY:119,HASREMOVE_QUERY_RESULTS:120},ve.rest=function(e){return{all:function(e,t){e([])},get:function(e,t,n){n(null,-1)},create:function(e,t,n,i){n({})},update:function(e,t,n,i){n({})},remove:function(e,t,n){t({})},query:function(e,t,n,i){n([])}}},ve.setRest=function(e,t){(!ve.restSet||t)&&(ve.rest=e,ve.restSet=!0)},ve.store=function(e){return{put:function(e,t,n,i){n(e,t)},get:function(e,t,n){n(e,void 0)},remove:function(e,t,n){t(e)},all:function(e,t){e([],[])}}},ve.setStore=function(e,t){(!ve.storeSet||t)&&(ve.store=e,ve.storeSet=!0)},ve.live=function(e){return{save:function(e,t){},remove:function(e){}}},ve.setLive=function(e,t){(!ve.liveSet||t)&&(ve.live=e,ve.liveSet=!0)},ve.online=window.navigator.onLine!==!1,ve.forceOffline=!1,ve.setOnline=function(){ve.online=!0,ve.debug(ve.Debugs.ONLINE),ve.trigger(ve.Events.Online)},ve.setOffline=function(){ve.online=!1,ve.debug(ve.Debugs.OFFLINE),ve.trigger(ve.Events.Offline)},ve.listenToNetworkStatus=function(){window.addEventListener?(window.addEventListener(ve.Events.Online,ve.setOnline,!1),window.addEventListener(ve.Events.Offline,ve.setOffline,!1)):(document.body.ononline=ve.setOnline,document.body.onoffline=ve.setOffline)},ve.checkNetworkStatus=function(){var e=window.navigator.onLine;ve.forceOffline&&(e=!1),e===!0&&ve.online===!1?ve.setOnline():e===!1&&ve.online===!0&&ve.setOffline()};var Zt=0,Xt=[],en=[];ve.batch=me,ve.batchRun=$e,ve.batchStart=Ee,ve.batchEnd=Re,ye.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",Loads:"no-load remote-load local-load",Changes:"updated"},ye.Defaults={name:t,className:null,key:"id",keySeparator:"/",fields:[],ignoredFields:{},defaults:{},comparator:null,comparatorNullsFirst:null,revision:null,loadRelations:!0,loadRemote:!0,autoRefresh:!0,cache:jt.All,fullSave:!1,fullPublish:!1,encodings:{},decodings:{},prepare:_,encode:Se,decode:Ae,resolveModel:Le,resolveModels:Ne,summarize:Me,createRest:Oe,createStore:_e,createLive:De},d(ye.prototype,{ready:function(e,t,n){return this.readyPromise.success(e,t,n)},hasData:function(e){if(!M(e))return!1;for(var t in e)if(!this.ignoredFields[t])return!0;return!1},grabModel:function(e,t,n,i){function s(){var t=r.parseModel(e,i);return t===!1||a.isComplete()||(r.loadRemote||r.remoteLoaded||null!==t&&t.$isSaved()?a.resolve(t):(t||(t=r.buildObjectFromKey(r.buildKeyFromInput(e))),t.$once(Te.Events.RemoteGets,function(){a.isComplete()||(M(e)&&t.$set(e),a.resolve(t.$isSaved()?t:null))}),t.$refresh())),a.isComplete()?!1:!0}var r=this,a=new Ke;return a.success(t,n||r),s()&&r.ready(s,r,!0),a},parseModel:function(e,t){var n=this,i=n.remoteLoaded||!n.loadRemote;if(!O(e))return i?null:!1;$(e)&&(e=new e),p(e)&&(e=e());var s=n.buildKeyFromInput(e);if(e instanceof n.Model)return e;if(s in n.all){var r=n.all[s];return M(e)&&(t?n.putRemoteData(e,s,r):r.$set(e)),r}return M(e)?t?n.putRemoteData(e):n.instantiate(n.decode(e)):i?null:!1},removeKey:function(e){var t=this.key;if(A(t))for(var n=0;n<t.length;n++)delete e[t[n]];else delete e[t]},buildKey:function(e,t){var n=this.buildKeys(e,t);return A(n)&&(n=n.join(this.keySeparator)),n},buildKeys:function(e,t){var n=null;if(A(t)){n=[];for(var i=0;i<t.length;i++)n.push(e[t[i]])}else n=e[t],n||(n=e[t]=L());return n},buildKeyFromInput:function(e){return e instanceof this.Model?e.$key():A(e)?this.buildKeyFromArray(e):M(e)?this.buildKey(e,this.key):e},buildKeyFromArray:function(e){return e.join(this.keySeparator)},getKey:function(e,t){var n=this.key,i=this.buildKey(e,n);if(q(e,n,O))return i;if(!t)throw"Composite key not supplied.";return!1},getKeys:function(e){return this.buildKeys(e,this.key)},buildObjectFromKey:function(e){var t=this,n={};if(A(t.key)){E(e)&&(e=e.split(t.keySeparator));for(var i=0;i<t.key.length;i++)n[t.key[i]]=e[i]}else n[t.key]=e;return t.instantiate(n)},updated:function(){this.sort(),this.trigger(ye.Events.Updated)},setRevision:function(e){p(e)?this.revisionFunction=e:E(e)?this.revisionFunction=function(n,i){var s=M(n)&&e in n?n[e]:t,r=M(i)&&e in i?i[e]:t;return s===t||r===t?!1:V(s,r)>0}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e,t){this.models.setComparator(e,t)},addComparator:function(e,t){this.models.addComparator(e,t)},setSummarize:function(e){p(e)?this.summarize=e:E(e)?i(this.fields,e)!==!1?this.summarize=function(t){return O(t)?t[e]:t}:this.summarize=ie(e):this.summarize=function(e){return e.$key()}},sort:function(){this.models.sort()},isSorted:function(){return this.models.isSorted()},clean:function(){var e=this,t=e.models.keys,n=e.models;e.all={};for(var i=0;i<t.length;i++)e.all[t[i]]=n[i]},putRemoteData:function(e,t,n,i){if(!M(e))return n;var s=this,t=t||s.getKey(e),n=n||s.all[t],r=s.decode(X(e));if(n){var a=this.revisionFunction(n,e);if(a)return ve.debug(ve.Debugs.SAVE_OLD_REVISION,s,n,e),n}if(n){for(var o=s.keys,u=0;u<o.length;u++){var l=o[u],h=n[l],c=r[l];if(O(h)&&O(c)&&h!==c)throw new Error("Model keys cannot be changed")}s.all[t]=n,n.$saved||(n.$saved={});var d=n.$toJSON(!0),f={},v=!1,g={},m=F(n.$saved),p=s.relations;for(var $ in e)if("$"!==$.charAt(0))if($ in p)n.$set($,e[$],!0);else{var E=d[$],R=n.$saved[$];m||i||H(E,R)?(n[$]=r[$],g[$]=e[$],n.$local&&(n.$local[$]=e[$])):(f[$]=e[$],v=!0),n.$saved[$]=X(e[$])}v?n.$trigger(Te.Events.PartialUpdate,[e,f]):n.$trigger(Te.Events.FullUpdate,[e,g]),n.$trigger(Te.Events.RemoteUpdate,[e]),n.$addOperation(Ze),s.models.has(t)||(s.models.put(t,n),s.trigger(ye.Events.ModelAdded,[n,!0]))}else n=s.createModel(r,!0),s.cache===jt.All?(n.$local=n.$toJSON(!1),n.$local.$status=n.$status,n.$saved=n.$local.$saved=n.$toJSON(!0),n.$addOperation(Ze)):n.$saved=n.$toJSON(!0);return n},createModel:function(e,t){var n=this,i=n.instantiate(e,t),s=i.$key();return n.models.has(s)||(n.models.put(s,i),
n.trigger(ye.Events.ModelAdded,[i,t])),i},destroyModel:function(e,t){var n=this,i=t||e.$key();delete n.all[i],n.models.remove(i),n.trigger(ye.Events.ModelRemoved,[e]),e.$trigger(Te.Events.RemoteAndRemove),ve.debug(ve.Debugs.REMOTE_REMOVE,n,e)},destroyLocalUncachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,n.removeKey(e),e.$trigger(Te.Events.Detach),!1):(n.destroyModel(e,t),!0):!1},destroyLocalCachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,n.removeKey(e),e.$local&&(delete e.$local.$saved,n.removeKey(e.$local)),e.$trigger(Te.Events.Detach),e.$addOperation(Ze),!1):(e.$addOperation(je),n.destroyModel(e,t),!0):(n.store.remove(t,function(e){e&&ve.debug(ve.Debugs.REMOTE_REMOVE,n,e)}),!1)},destroyLocalModel:function(e){var t=this,n=t.all[e];return t.cache===jt.All?t.destroyLocalCachedModel(n,e):t.destroyLocalUncachedModel(n,e)},loadFinish:function(){var e=this;Ee();for(var t in e.loaded){var n=e.loaded[t];n.$status===Te.Status.RemovePending?(ve.debug(ve.Debugs.LOCAL_RESUME_DELETE,e,n),n.$addOperation(Je)):(n.$status===Te.Status.SavePending?(ve.debug(ve.Debugs.LOCAL_RESUME_SAVE,e,n),n.$addOperation(Xe)):ve.debug(ve.Debugs.LOCAL_LOAD_SAVED,e,n),e.models.put(t,n,!0))}Re(),e.loaded={},e.updated(),e.loadRemote&&(0===e.pendingOperations?e.refresh():e.firstRefresh=!0)},loadBegin:function(e){function t(t,n){ve.debug(ve.Debugs.LOCAL_LOAD,i,t);for(var s=0;s<t.length;s++){var r=t[s],a=n[s],o=i.decode(X(r,!0)),u=i.instantiate(o,!0);u.$local=r,u.$saved=r.$saved,u.$status!==Te.Status.Removed&&(i.loaded[a]=u,i.all[a]=u)}i.localLoaded=!0,i.triggerLoad(ye.Events.LocalLoad),e(!0,i)}function n(){i.loadNone(),e(!1,i)}var i=this;i.loadRemote&&i.autoRefresh&&ve.after(ve.Events.Online,i.onOnline,i),i.cache===jt.None?(i.loadNone(),e(!1,i)):i.store.all(t,n)},triggerLoad:function(e,t){var n=this;n.initialized=!0,n.trigger(e,[n].concat(t||[])),n.readyPromise.reset().resolve(n)},loadNone:function(){var e=this;e.loadRemote?e.refresh():e.triggerLoad(ye.Events.NoLoad)},onOnline:function(){var e=this;e.afterOnline=!0,0===e.pendingOperations&&e.onOperationRest()},onOperationRest:function(){var e=this;(e.autoRefresh&&e.remoteLoaded&&e.afterOnline||e.firstRefresh)&&(e.afterOnline=!1,e.firstRefresh=!1,ve.debug(ve.Debugs.AUTO_REFRESH,e),e.refresh())},refresh:function(e,t){function n(e){for(var t=s.resolveModels(e),n={},i=0;i<t.length;i++){var a=s.putRemoteData(t[i]);if(a){var o=a.$key();n[o]=a}}for(var u=s.models.keys(),i=0;i<u.length;i++){var l=u[i];if(!(l in n)){var h=s.models.get(l);h.$saved&&(ve.debug(ve.Debugs.REMOTE_LOAD_REMOVE,s,l),s.destroyLocalModel(l))}}s.remoteLoaded=!0,s.triggerLoad(ye.Events.RemoteLoad),s.updated(),ve.debug(ve.Debugs.REMOTE_LOAD,s,t),r.resolve(s.models)}function i(e,t){0===t?(ve.checkNetworkStatus(),ve.online||(s.pendingRefresh=!0,ve.once(ve.Events.Online,s.onRefreshOnline,s)),ve.debug(ve.Debugs.REMOTE_LOAD_OFFLINE,s)):(ve.debug(ve.Debugs.REMOTE_LOAD_ERROR,s,t),s.triggerLoad(ye.Events.NoLoad,[e])),r.reject(s.models)}var s=this,r=new Ke;return r.complete(e,t||s),Ee(),s.rest.all(n,i),Re(),r},onRefreshOnline:function(){var e=this;ve.debug(ve.Debugs.REMOTE_LOAD_RESUME,e),e.pendingRefresh&&(e.pendingRefresh=!1,e.refresh())},get:function(e){return this.all[this.buildKeyFromInput(e)]},filter:function(e){var t=this.all,n=[];for(var i in t){var s=t[i];e(s)&&n.push(s)}return n},liveSave:function(e,t){this.putRemoteData(t,e),this.updated(),ve.debug(ve.Debugs.REALTIME_SAVE,this,t,e)},liveRemove:function(e){this.destroyLocalModel(e)&&this.updated(),ve.debug(ve.Debugs.REALTIME_REMOVE,this,e)},instantiate:function(e,t){return new this.Model(e,t)},addReference:function(e){this.all[e.$key()]=e},save:function(e,t){var n=this;if(e.$isDeleted())return void ve.debug(ve.Debugs.SAVE_DELETED,n,e);var i=e.$key(),s=n.models.has(i);s?(n.trigger(ye.Events.ModelUpdated,[e]),e.$trigger(Te.Events.UpdateAndSave)):(n.models.put(i,e),n.trigger(ye.Events.ModelAdded,[e]),n.updated(),e.$trigger(Te.Events.CreateAndSave)),e.$addOperation(We,t)},remove:function(e,t){var n=this;this.removeFromModels(e),e.$status===Te.Status.SavePending&&ve.debug(ve.Debugs.REMOVE_CANCEL_SAVE,n,e),e.$status=Te.Status.RemovePending,e.$addOperation(Be,t)},removeFromModels:function(e){var t=this,n=e.$key();t.models.has(n)&&(t.models.remove(n),t.trigger(ye.Events.ModelRemoved,[e]),t.updated(),e.$trigger(Te.Events.Removed))}}),K(ye.prototype),Y(ye.prototype,"change",ye.Events.Changes),Te.Events={Created:"created",Saved:"saved",PreSave:"pre-save",PostSave:"post-save",PreRemove:"pre-remove",PostRemove:"post-remove",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",Change:"change",CreateAndSave:"created saved",UpdateAndSave:"updated saved",KeyUpdate:"key-update",RelationUpdate:"relation-update",Removed:"removed",RemoteUpdate:"remote-update",LocalSave:"local-save",LocalSaveFailure:"local-save-failure",LocalSaves:"local-save local-save-failure",RemoteSave:"remote-save",RemoteSaveFailure:"remote-save-failure",RemoteSaveOffline:"remote-save-offline",RemoteSaves:"remote-save remote-save-failure remote-save-offline",LocalRemove:"local-remove",LocalRemoveFailure:"local-remove-failure",LocalRemoves:"local-remove local-remove-failure",RemoteRemove:"remote-remove",RemoteRemoveFailure:"remote-remove-failure",RemoteRemoveOffline:"remote-remove-offline",RemoteRemoves:"remote-remove remote-remove-failure remote-remove-offline",LocalGet:"local-get",LocalGetFailure:"local-get-failure",LocalGets:"local-get local-get-failure",RemoteGet:"remote-get",RemoteGetFailure:"remote-get-failure",RemoteGetOffline:"remote-get-offline",RemoteGets:"remote-get remote-get-failure remote-get-offline",RemoteAndRemove:"remote-remove removed",SavedRemoteUpdate:"saved remote-update",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",Changes:"saved remote-update key-update relation-update removed change"},Te.Status={Synced:0,SavePending:1,RemovePending:2,Removed:3},Te.Blocked={toString:!0,valueOf:!0},d(Te.prototype,{$init:function(e,t){if(this.$status=Te.Status.Synced,this.$operation=null,this.$relations={},this.$dependents={},t){var n=this.$db.getKey(e);this.$db.all[n]=this,this.$set(e,void 0,t)}else this.$reset(e);if(this.$db.loadRelations){var i=this.$db.relations;for(var s in i){var r=i[s];r.lazy||this.$getRelation(s,void 0,t)}}},$load:function(e){if(A(e))for(var t=0;t<e.length;t++)this.$getRelation(e[t]);else if(E(e))this.$getRelation(e);else{var n=this.$db.relations;for(var i in n)this.$getRelation(i)}},$reset:function(e){var n=this.$db.defaults,i=this.$db.fields,s=this.$db.relations,r=this.$db.key;if(M(n)){for(var a=0;a<i.length;a++){var o=i[a],u=n[o],l=I(u);this[o]=l}for(var o in s)if(o in n){var u=n[o],l=I(u),h=this.$getRelation(o);h.set(this,l)}}else for(var a=0;a<i.length;a++){var o=i[a];this[o]=t}var c=!1;if(e&&(c=this.$db.getKey(e,!0)),c===!1)c=this.$db.getKey(this,!0);else if(E(r))this[r]=c;else for(var a=0;a<r.length;a++){var d=r[a];this[d]=e[d]}c!==!1&&(this.$db.all[c]=this,this.$$key=c),this.$set(e)},$set:function(e,t,n,i){if(M(e))for(var s in e)this.$set(s,e[s],n,!0);else if(E(e)){if(Te.Blocked[e])return;var r=this.$getRelation(e,t,n);r?r.set(this,t,n):this[e]=t}!i&&O(e)&&this.$trigger(Te.Events.Change,[e,t])},$get:function(e,t){if(A(e))return Q(this,e,t);if(M(e)){for(var n in e)e[n]=t?X(this[n]):this[n];return e}if(E(e)){if(Te.Blocked[e])return;var i=this.$getRelation(e);if(i){var s=i.get(this);return t?X(s):s}return t?X(this[e]):this[e]}},$decode:function(){this.$db.decode(this)},$isDependentsSaved:function(e,t){function n(){e.apply(t||this,arguments),a()}var i=this.$dependents;for(var s in i){var r=i[s];if(!r.$isSaved()){var a=r.$once(Te.Events.RemoteSaves,n);return!1}}return!0},$relate:function(e,t){var n=this.$getRelation(e);n&&n.relate(this,t)},$unrelate:function(e,t){var n=this.$getRelation(e);n&&n.unrelate(this,t)},$isRelated:function(e,t){var n=this.$getRelation(e);return n&&n.isRelated(this,t)},$getRelation:function(e,t,n){var i=this.$db.relations,s=i[e];return s?(e in this.$relations||s.load(this,t,n),s):!1},$save:function(e,t,n){var n=3===arguments.length?n:2===arguments.length&&M(e)&&R(t)?t:1===arguments.length&&R(e)?e:Bt.All;if(this.$isDeleted())return ve.debug(ve.Debugs.SAVE_DELETED,this.$db,this),Ke.resolve(this);var i=Fe(this,n,Te.Events.RemoteSave,Te.Events.RemoteSaveFailure,Te.Events.RemoteSaveOffline,Te.Events.LocalSave,Te.Events.LocalSaveFailure);return Ke.singularity(i,this,function(i){Ee(),this.$db.addReference(this),this.$set(e,t),this.$trigger(Te.Events.PreSave,[this]),this.$db.save(this,n),this.$trigger(Te.Events.PostSave,[this]),Re()})},$remove:function(e){var e=R(e)?e:Bt.All;if(!this.$exists())return Ke.resolve(this);var t=Fe(this,e,Te.Events.RemoteRemove,Te.Events.RemoteRemoveFailure,Te.Events.RemoteRemoveOffline,Te.Events.LocalRemove,Te.Events.LocalRemoveFailure);return Ke.singularity(t,this,function(t){Ee(),this.$trigger(Te.Events.PreRemove,[this]),this.$db.remove(this,e),this.$trigger(Te.Events.PostRemove,[this]),Re()})},$refresh:function(e){var t=Fe(this,e,Te.Events.RemoteGet,Te.Events.RemoteGetFailure,Te.Events.RemoteGetOffline,Te.Events.LocalGet,Te.Events.LocalGetFailure);return ge(e,Bt.Rest)?this.$addOperation(qe,e):ge(e,Bt.Local)?this.$addOperation(ze,e):t.resolve(this),t},$autoRefresh:function(){return ve.on(ve.Events.Online,this.$refresh,this),this},$cancel:function(e){this.$saved?this.$save(this.$saved):e&&this.$reset()},$clone:function(e){for(var t=this.$db,n=t.key,i=t.fields,s=t.relations,r={},a=0;a<i.length;a++){var o=i[a];e&&o in e?r[o]=I(e[o]):o in this&&(r[o]=X(this[o]))}E(n)&&delete r[n];var u=t.getKey(r),l=this.$key();if(u===l)throw"A clone cannot have the same key as the original model.";for(var h in s)e&&h in e&&s[h].preClone(this,r,e[h]);var c=t.instantiate(r),d={};for(var h in s)e&&h in e&&s[h].postClone(this,d,e[h]);return c.$set(d),c},$push:function(e){this.$savedState=this.$db.encode(this,Q(this,e||this.$db.fields,!0),!1)},$pop:function(e){M(this.$savedState)&&(this.$set(this.$savedState),e||this.$discard())},$discard:function(){delete this.$savedState},$exists:function(){return!this.$isDeleted()&&this.$db.models.has(this.$key())},$addOperation:function(e,t){var n=new e(this,t);this.$operation?this.$operation.queue(n):(this.$operation=n,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(this,Q(this,this.$db.fields,!0),e),n=this.$db.relations,i=this.$relations;for(var s in i)n[s].encode(this,t,e);return t},$changed:function(){this.$trigger(Te.Events.Change)},$key:function(e){return this.$$key||(this.$$key=this.$db.getKey(this,e)),this.$$key},$keys:function(){return this.$db.getKeys(this)},$uid:function(){return this.$db.name+"$"+this.$key()},$hasKey:function(){return q(this,this.$db.key,O)},$isSynced:function(){return this.$status===Te.Status.Synced},$isSaving:function(){return this.$status===Te.Status.SavePending},$isPending:function(){return this.$status===Te.Status.SavePending||this.$status===Te.Status.RemovePending},$isDeleted:function(){return this.$status>=Te.Status.RemovePending},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$getChanges:function(e){var t=this.$saved,n=e||this.$toJSON(!0),i=this.$db.saveFields;return t?ee(n,t,i,H):n},$hasChanges:function(){if(!this.$saved)return!0;var e=this.$db.ignoredFields,t=this.$toJSON(!0),n=this.$saved;for(var i in t){var s=t[i],r=n[i];if(!e[i]&&!H(s,r))return!0}return!1},toString:function(){return this.$db.className+" "+JSON.stringify(this.$toJSON())}}),K(Te.prototype,!0),Y(Te.prototype,"$change",Te.Events.Changes,!0),d(Ie.prototype,{reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,Yt.push.call(this.values,t),Yt.push.call(this.keys,e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return R(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],n=Yt.pop.apply(this.values),i=Yt.pop.apply(this.keys);return e<this.values.length&&(this.values[e]=n,this.keys[e]=i,this.indices[i]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},subtract:function(e,t){for(var n=t||new Ie,i=this.size(),s=this.values,r=this.keys,a=0;i>a;a++){var o=s[a],u=r[a];e.has(u)||n.put(u,o)}return n},filter:function(e,t){for(var n=t||new Ie,i=this.size(),s=this.values,r=this.keys,a=0;i>a;a++){var o=s[a],u=r[a];e(o,u)&&n.put(u,o)}return n},reverse:function(){return a(this.values),a(this.keys),this.rebuildIndex(),this},isSorted:function(e){return o(e,this.values)},sort:function(e){function t(t,n){for(var s=i.values[Math.floor((n+t)/2)],a=t,o=n;o>=a;){for(;e(i.values[a],s)<0;)a++;for(;e(i.values[o],s)>0;)o--;o>=a&&(r(i.values,a,o),r(i.keys,a,o),a++,o--)}return a}function n(e,i){var s=t(e,i);s-1>e&&n(e,s-1),i>s&&n(s,i)}var i=this,s=this.size()-1;return s>0&&(n(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this}}),Ce.Events={Add:"add",Adds:"adds",Sort:"sort",Remove:"remove",Removes:"removes",Updates:"updates",Reset:"reset",Cleared:"cleared",Changes:"add adds sort remove removes updates reset cleared"},h(Array,Ce,{setComparator:function(e,t){return this.comparator=P(e,t),this.sort(),this},addComparator:function(e,t){return this.comparator=U(this.comparator,e,t),this.sort(),this},isSorted:function(e,t){var n=e?P(e,t):this.comparator;return o(n,this)},sort:function(e,t,n){var i=e?P(e,t):this.comparator;return(!o(i,this)||!n&&!i&&u(this))&&(Yt.sort.call(this,i),this.trigger(Ce.Events.Sort,[this])),this},reset:function(e){return this.length=0,A(e)?Yt.push.apply(this,e):O(e)&&Yt.push.call(this,e),this.trigger(Ce.Events.Reset,[this]),this.sort(t,t,!0),this},page:function(e,t){return new Ue(this,e,t)},filtered:function(e,t,n){var i=fe(e,t,n);return new Pe(this,i)},where:function(e,t,n,i){for(var s=fe(e,t,n),r=i||this.cloneEmpty(),a=0;a<this.length;a++){var o=this[a];s(o)&&r.add(o)}return r},subtract:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||k,r=0;r<this.length;r++){for(var a=this[r],o=!1,u=0;u<e.length&&!o;u++)o=s(a,e[u]);o||i.push(a)}return i},intersect:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||k,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o&&i.push(a)}return i},complement:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||k,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o||i.push(a)}return i},clear:function(){return this.length=0,this.trigger(Ce.Events.Cleared,[this]),this},add:function(e,n){return Yt.push.call(this,e),this.trigger(Ce.Events.Add,[this,e]),n||this.sort(t,t,!0),this},push:function(){var e=arguments;return Yt.push.apply(this,e),this.trigger(Ce.Events.Adds,[this,Yt.slice.apply(e)]),this.sort(t,t,!0),this.length},unshift:function(){var e=arguments;return Yt.unshift.apply(this,e),this.trigger(Ce.Events.Adds,[this,Yt.slice.apply(e)]),this.sort(t,t,!0),this.length},addAll:function(e,n){return A(e)&&e.length&&(Yt.push.apply(this,e),this.trigger(Ce.Events.Adds,[this,e]),n||this.sort(t,t,!0)),this},insertAt:function(e,n,i){return Yt.splice.call(this,e,0,n),this.trigger(Ce.Events.Add,[this,n]),i||this.sort(t,t,!0),this},pop:function(e){var n=Yt.pop.apply(this),i=this.length;return this.trigger(Ce.Events.Remove,[this,n,i]),e||this.sort(t,t,!0),n},shift:function(e){var n=Yt.shift.apply(this);return this.trigger(Ce.Events.Remove,[this,n,0]),e||this.sort(t,t,!0),n},removeAt:function(e,n){var i;return e>=0&&e<this.length&&(i=this[e],Yt.splice.call(this,e,1),this.trigger(Ce.Events.Remove,[this,i,e]),n||this.sort(t,t,!0)),i},remove:function(e,t,n){var i=this.indexOf(e,n),s=this[i];return-1!==i&&this.removeAt(i,t),s},removeAll:function(e,n,i){var s=[];if(A(e)&&e.length){for(var r=0;r<e.length;r++){var a=e[r],o=this.indexOf(a,i);-1!==o&&(Yt.splice.call(this,o,1),s.push(a))}this.trigger(Ce.Events.Removes,[this,s]),n||this.sort(t,t,!0)}return s},removeWhere:function(e,n,i,s,r){for(var a=fe(e,n,i),o=s||this.cloneEmpty(),u=this.length-1;u>=0;u--){var l=this[u];a(l)&&(Yt.splice.call(this,u,1),o.push(l))}return this.trigger(Ce.Events.Removes,[this,o]),r||this.sort(t,t,!0),o},splice:function(e,n){var i=Yt.slice.call(arguments,2),s=Yt.splice.apply(this,arguments);return n&&this.trigger(Ce.Events.Removes,[this,s]),i.length&&this.trigger(Ce.Events.Adds,[this,i]),this.sort(t,t,!0),s},reverse:function(){return Yt.reverse?Yt.reverse.apply(this):a(this),this.trigger(Ce.Events.Updates,[this]),this},indexOf:function(e,t){for(var n=t||k,i=0;i<this.length;i++)if(n(e,this[i]))return i;return-1},minModel:function(e,t){for(var n=P(e||this.comparator,!1),i=t,s=0;s<this.length;s++)n(i,this[s])>0&&(i=this[s]);return i},maxModel:function(e,t){for(var n=P(e||this.comparator,!0),i=t,s=0;s<this.length;s++)n(i,this[s])<0&&(i=this[s]);return i},min:function(e,t,n){for(var i=ue(e,t),s=n,r=0;r<this.length;r++){var a=i(this[r]);V(s,a,!1)>0&&(s=a)}return s},max:function(e,t,n){for(var i=ue(e,t),s=n,r=0;r<this.length;r++){var a=i(this[r]);V(s,a,!0)<0&&(s=a)}return s},firstWhere:function(e,t,n){for(var i=fe(e,t,n),s=0;s<this.length;s++){var r=this[s];if(i(r))return r}return null},first:function(e,t){for(var n=ue(e,t),i=0;i<this.length;i++){var s=n(this[i]);if(O(s))return s}},lastWhere:function(e,t,n){for(var i=fe(e,t,n),s=this.length-1;s>=0;s--){var r=this[s];if(i(r))return r}return null},last:function(e,t){for(var n=ue(e,t),i=this.length-1;i>=0;i--){var s=n(this[i]);if(O(s))return s}},aggregate:function(e,t,n,i){for(var s=0;s<this.length;s++){var r=e(this[s]);t(r)&&n(r)}return i()},sum:function(e){function t(e){s+=e}function n(){return s}var i=ae(e),s=0;return this.aggregate(i,R,t,n)},avg:function(e){function t(e){s+=e,r++}function n(){return 0===r?0:s/r}var i=ae(e),s=0,r=0;return this.aggregate(i,R,t,n)},countWhere:function(e,t,n){for(var i=fe(e,t,n),s=0,r=0;r<this.length;r++){var a=this[r];i(a)&&s++}return s},count:function(e){if(!O(e))return this.length;for(var t=ue(e),n=0,i=0;i<this.length;i++){var s=t(this[i]);O(s)&&n++}return n},pluck:function(e,t,n,i){var s=ue(e,n);if(t){for(var r=ue(t,i),a={},o=0;o<this.length;o++){var u=this[o],l=s(u),h=r(u);a[h]=l}return a}for(var a=[],o=0;o<this.length;o++){var u=this[o],l=s(u);a.push(l)}return a},each:function(e,t){for(var n=0;n<this.length;n++){var i=this[n];e.call(t,i,n),this[n]!==i&&n--}return this},eachWhere:function(e,t,n,i){for(var s=fe(t,n,i),r=0;r<this.length;r++){var a=this[r];s(a)&&(e.call(this,a,r),this[r]!==a&&r--)}return this},reduce:function(e,t){for(var n=0;n<this.length;n++)t=e(t,this[n]);return t},random:function(){var e=Math.floor(Math.random()*this.length);return this[e]},chunk:function(e,t){for(var n=t||[],i=0,s=n[i]=n[i]||[],r=0,a=0;a<this.length;a++)s[r]=this[a],++r>=e&&(r=0,i++,s.length=e,s=n[i]=n[i]||[]);return 0!==r&&i++,s.length=r,n.length=i,n},contains:function(e,t,n){for(var i=fe(e,t,n),s=0;s<this.length;s++){var r=this[s];if(i(r))return!0}return!1},group:function(e){var t=ue(e.by,e.bySeparator||"/"),n=fe(e.having,e.havingValue,e.havingEquals),i=e.select||{},s={};if(E(e.by))e.by in i||(i[e.by]="first");else if(A(e.by))for(var r in e.by)r in i||(i[r]="first");for(var a=0;a<this.length;a++){var o=this[a],u=t(o),l=s[u];l||(l=s[u]=this.cloneEmpty()),l.add(o,!0)}var h=this.cloneEmpty();h.setComparator(e.comparator,e.comparatorNullsFirst);for(var u in s){var c={},d=s[u];for(var f in i){var v=i[f];E(v)?c[f]=d[v](f):p(v)&&(c[f]=v(d,f))}e.track!==!1&&(c.$group=d),e.count!==!1&&(c.$count=d.length),n(c,d)&&h.push(c)}return h.sort(),h},toArray:function(){return this.slice()},clone:function(){return new this.constructor(this)},cloneEmpty:function(){return new this.constructor}}),K(Ce.prototype),Y(Ce.prototype,"change",Ce.Events.Changes);var tn={bind:function(){this.onAdd=D(this,tn.handleAdd),this.onAdds=D(this,tn.handleAdds),this.onRemove=D(this,tn.handleRemove),this.onRemoves=D(this,tn.handleRemoves),this.onReset=D(this,tn.handleReset),this.onUpdates=D(this,tn.handleUpdates),this.onCleared=D(this,tn.handleCleared)},init:function(e,t){return this.base!==e&&(this.base&&this.disconnect(),this.base=e,this.connect()),this.filter=t,this.sync(),this},setFilter:function(e,t,n){return this.filter=fe(e,t,n),this.sync(),this},connect:function(){return this.base.on(Ce.Events.Add,this.onAdd),this.base.on(Ce.Events.Adds,this.onAdds),this.base.on(Ce.Events.Remove,this.onRemove),this.base.on(Ce.Events.Removes,this.onRemoves),this.base.on(Ce.Events.Reset,this.onReset),this.base.on(Ce.Events.Updates,this.onUpdates),this.base.on(Ce.Events.Cleared,this.onClear),this},disconnect:function(){return this.base.off(Ce.Events.Add,this.onAdd),this.base.off(Ce.Events.Adds,this.onAdds),this.base.off(Ce.Events.Remove,this.onRemove),this.base.off(Ce.Events.Removes,this.onRemoves),this.base.off(Ce.Events.Reset,this.onReset),this.base.off(Ce.Events.Updates,this.onUpdates),this.base.off(Ce.Events.Cleared,this.onClear),this},sync:function(){for(var e=this.base,t=this.filter,n=[],i=0;i<e.length;i++){var s=e[i];t(s)&&n.push(s)}return this.reset(n)},handleAdd:function(e,t){var n=this.filter;n(t)&&this.add(t)},handleAdds:function(e,t){for(var n=this.filter,i=[],s=0;s<t.length;s++){var r=t[s];n(r)&&i.push(r)}this.addAll(i)},handleRemove:function(e,t){this.remove(t)},handleRemoves:function(e,t){this.removeAll(t)},handleReset:function(e){this.sync()},handleUpdates:function(e,t){for(var n=this.filter,i=0;i<t.length;i++){var s=t[i];n(s)?this.add(s,!0):this.remove(s,!0)}this.sort()},handleCleared:function(e){this.clear()},clone:function(){return new this.constructor(this.base,this.filter)},cloneEmpty:function(){return new this.constructor(this.base,this.filter)}};Ue.Events={Change:"change",Changes:"change"},h(Array,Ue,{setPageSize:function(e){this.pageSize=e,this.handleChanges()},setPageIndex:function(e){this["goto"](e)},setCollection:function(e){e!==this.collection&&(this.collection&&this.disconnect(),this.collection=e,this.connect(),this.handleChanges(!0))},connect:function(){this.collection.on(Ce.Events.Changes,this.onChanges)},disconnect:function(){this.collection.off(Ce.Events.Changes,this.onChanges)},"goto":function(e){var t=Math.max(0,Math.min(e,this.pageCount-1));t!==this.pageIndex&&(this.pageIndex=t,this.update(),this.trigger(Ue.Events.Change,[this]))},next:function(){this["goto"](this.pageIndex+1)},prev:function(){this["goto"](this.pageIndex-1)},jump:function(e){this["goto"](e)},first:function(){this["goto"](0)},last:function(){this["goto"](this.pageCount-1)},handleChanges:function(e){var t=this.collection.length,n=Math.ceil(t/this.pageSize),i=Math.max(0,Math.min(this.pageIndex,n-1)),s=e||this.pageIndex!==i||this.length!==this.pageSize,r=s||this.pageCount!==n;this.pageIndex=i,this.pageCount=n,s&&this.update(),r&&this.trigger(Ue.Events.Change,[this])},update:function(){var e=this.collection,t=e.length,n=this.pageIndex*this.pageSize,i=Math.min(n+this.pageSize,t),s=i-n;this.length=0;for(var r=0;s>r;r++)this.push(e[n++])},more:function(e){for(var t=this.collection,n=t.length,i=e||1,s=this.pageIndex*this.pageSize,r=s+this.length,a=this.pageSize*i,o=r+a,u=Math.min(n,o);u>r;)this.push(t[r++])},toArray:function(){return this.slice()}}),K(Ue.prototype),Y(Ue.prototype,"change",Ue.Events.Changes),h(Ce,Pe,{bind:tn.bind,init:tn.init,setFilter:tn.setFilter,connect:tn.connect,disconnect:tn.disconnect,sync:tn.sync,clone:tn.clone,cloneEmpty:tn.cloneEmpty}),h(Ce,ke,{init:function(e,t,n){return this.map=new Ie,this.map.values=this,this.database=e,this.reset(t,n),this},sort:function(e,t){var n=e?P(e,t):this.comparator;return o(n,this)||(this.map.sort(n),this.trigger(Ce.Events.Sort,[this])),this},buildKeyFromInput:function(e){return this.database.buildKeyFromInput(e)},parseModel:function(e,t){return this.database.parseModel(e,t)},filtered:function(e,t,n){var i=fe(e,t,n);return new we(this,i)},subtract:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<this.length;i++){var s=this[i],r=s.$key(),a=!1;if(e instanceof ke)a=e.has(r);else for(var o=0;o<e.length&&!a;o++){var u=this.buildKeyFromInput(e[o]);a=r===u}a||n.push(s)}return n},intersect:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<e.length;i++){var s=e[i],r=this.buildKeyFromInput(s);this.has(r)&&n.push(s)}return n},complement:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<e.length;i++){var s=e[i],r=this.buildKeyFromInput(s);this.has(r)||n.push(s)}return n},clear:function(){return this.map.reset()},reset:function(e,t){var n=this.map;if(n.reset(),A(e))for(var i=0;i<e.length;i++){var s=e[i],r=this.parseModel(s,t);r&&n.put(r.$key(),r)}else if(M(e)){var r=this.parseModel(e,t);r&&n.put(r.$key(),r)}return this.trigger(Ce.Events.Reset,[this]),this.sort(),this},has:function(e){return this.map.has(e)},get:function(e){return this.map.get(e)},put:function(e,t,n){this.map.put(e,t),this.trigger(Ce.Events.Add,[this,t]),n||this.sort()},add:function(e,t,n){var i=this.parseModel(e,n);return this.map.put(i.$key(),i),this.trigger(Ce.Events.Add,[this,i]),t||this.sort(),this},push:function(){for(var e=arguments,t=0;t<e.length;t++){var n=this.parseModel(e[t]);this.map.put(n.$key(),n)}return this.trigger(Ce.Events.Adds,[this,Yt.slice.apply(e)]),this.sort(),this.length},unshift:function(){return this.push.apply(this,arguments)},addAll:function(e,t,n){if(A(e)){for(var i=0;i<e.length;i++){var s=this.parseModel(e[i],n);this.map.put(s.$key(),s)}this.trigger(Ce.Events.Adds,[this,e]),t||this.sort()}},insertAt:function(e,t,n){return this.add(t,n)},pop:function(e){var t=this.length-1,n=this[t];return this.map.removeAt(t),this.trigger(Ce.Events.Remove,[this,n,t]),e||this.sort(),n},shift:function(e){var t=this[0];return this.map.removeAt(0),this.trigger(Ce.Events.Remove,[this,t,0]),e||this.sort(),t},removeAt:function(e,t){var n;return e>=0&&e<this.length&&(n=this[e],this.map.removeAt(e),this.trigger(Ce.Events.Remove,[this,n,e]),t||this.sort()),n},remove:function(e,t){var n=this.buildKeyFromInput(e),i=this.map.get(n);return i&&(this.map.remove(n),this.trigger(Ce.Events.Remove,[this,i,e]),t||this.sort()),i},removeAll:function(e,t){for(var n=this.map,i=[],s=0;s<e.length;s++){var r=this.buildKeyFromInput(e[s]),a=n.get(r);a&&(n.remove(r),i.push(a))}return this.trigger(Ce.Events.Removes,[this,i]),t||this.sort(),i},indexOf:function(e){var n=this.buildKeyFromInput(e),i=this.map.indices[n];return i===t?-1:i},rebuild:function(){this.map.rebuildIndex()},keys:function(){return this.map.keys},reverse:function(){return this.map.reverse(),this.trigger(Ce.Events.Updates,[this]),this},splice:function(e,t){for(var n=Yt.slice.call(arguments,2),i=[e,t],s=0;s<n.length;s++)i.push(this.buildKeyFromInput(n[s]));var r=Yt.splice.apply(this,arguments);return Yt.splice.apply(this.map.keys,i),t&&this.trigger(Ce.Events.Removes,[this,r]),n.length&&this.trigger(Ce.Events.Adds,[this,n]),this.sort(),r},removeWhere:function(e,t,n,i,s,r){var a=fe(t,n,i),o=s||this.cloneEmpty();Ee();for(var u=0;u<this.length;u++){var l=this[u],h=l.$key();a(l)&&(this.map.remove(h),o.push(l),u--,e&&l.$remove())}return Re(),this.trigger(Ce.Events.Removes,[this,o]),r||this.sort(),o},update:function(e,t,n,i){Ee();for(var s=0;s<this.length;s++){var r=this[s];r.$set(e,t,n),i||r.$save()}return Re(),this.trigger(Ce.Events.Updates,[this,this]),this.sort(),this},updateWhere:function(e,t,n,i,s){var r=[];Ee();for(var a=0;a<this.length;a++){var o=this[a];e(o)&&(o.$set(t,n,i),s||o.$save(),r.push(o))}return Re(),this.trigger(Ce.Events.Updates,[this,r]),this.sort(),r},pushWhere:function(e,t,n,i){function s(t){t.$push(e)}return this.eachWhere(s,t,n,i)},popWhere:function(e,t,n,i){function s(t){t.$pop(e)}return this.eachWhere(s,t,n,i)},discardWhere:function(e,t,n){function i(e){e.$discard()}return this.eachWhere(i,e,t,n)},cancelWhere:function(e,t,n,i){function s(t){t.$cancel(e)}return Ee(),this.eachWhere(s,t,n,i),Re(),this},refreshWhere:function(e,t,n){function i(e){e.$refresh()}return Ee(),this.eachWhere(i,e,t,n),Re(),this},clone:function(e,t){var n=this;if(e){n=[];for(var i=0;i<this.length;i++)n[i]=this[i].$clone(t)}return new ke(this.database,n,!0)},cloneEmpty:function(){return new ke(this.database)}}),h(ke,we,{bind:function(){tn.bind.apply(this),this.onModelUpdated=D(this,this.handleModelUpdate)},init:function(e,t){return this.base&&this.base.database.off(ye.Events.ModelUpdated,this.onModelUpdated),ke.prototype.init.call(this,e.database),tn.init.call(this,e,t),e.database.on(ye.Events.ModelUpdated,this.onModelUpdated),this},setFilter:tn.setFilter,connect:tn.connect,disconnect:tn.disconnect,sync:tn.sync,handleModelUpdate:function(e){var t=this.has(e.$key()),n=this.filter(e);t&&!n&&this.remove(e),!t&&n&&this.add(e)},clone:tn.clone,cloneEmpty:tn.cloneEmpty}),h(ke,He,{set:function(e){return this.relator.set(this.model,e),this},relate:function(e){return this.relator.relate(this.model,e),this},unrelate:function(e){return this.relator.unrelate(this.model,e),this},isRelated:function(e){return this.relator.isRelated(this.model,e)},clone:function(){return new He(this.database,this.model,this.relator,this,!0)},cloneEmpty:function(){return new He(this.database,this.model,this.relator)}}),Ve.Defaults={},d(Ve.prototype,{$getDefaults:function(){return Ve.Defaults},$init:function(e,t,n,i,s){G(this,n,this.$getDefaults(),!0),this.$append=!1,this.$db=e,this.$url=t,this.$results=new ke(e),this.$promise=Ke.resolve(this),M(i)&&this.$set(i),s&&this.$run()},$set:function(e){return j(e,this)},$run:function(){var e=this.$encode(),t=D(this,this.$handleSuccess),n=D(this,this.$handleFailure);return Ee(),this.$cancel(),this.$promise=new Ke,this.$db.rest.query(this.$url,e,t,n),Re(),this.$promise},$handleSuccess:function(e){if(this.$promise.isPending()){var t=this.$decode.apply(this,arguments);this.$append?this.$results.addAll(t,!1,!0):this.$results.reset(t,!0),this.$promise.resolve(this,e,this.$results)}},$handleFailure:function(e,t){if(this.$promise.isPending()){var n=0===t;n&&(ve.checkNetworkStatus(),n=!ve.online),n?this.$promise.noline(this,e,t):this.$promise.reject(this,e,t)}},$cancel:function(){this.$promise.cancel()},$encode:function(){return Z(X(this))},$decode:function(e){return e},$key:function(){return""}}),Ye.Defaults={page_size:10,page_index:0,total:0},l(Ve,Ye,{$getDefaults:function(){return Ye.Defaults},$goto:function(e,t){var n=this.$getPageIndex(),i=this.$getPageCount(),s=Math.max(0,Math.min(e,i-1));return n!==s&&(this.$setPageIndex(s),t||(this.$append=!1,this.$run())),this.$promise},$more:function(){var e=this.$getPageIndex()+1;return e<this.$getPageCount()&&(this.$setPageIndex(e),this.$append=!0,this.$run(),this.$promise.complete(this.$onMoreEnd,this)),this.$promise},$onMoreEnd:function(){this.$append=!1},$first:function(e){return this.$goto(0,e)},$last:function(e){return this.$goto(this.$getPageCount()-1,e)},$prev:function(e){return this.$goto(this.$getPageIndex()-1,e)},$next:function(e){return this.$goto(this.$getPageIndex()+1,e)},$decode:function(e){return this.$updatePageSize(e),this.$updatePageIndex(e),this.$updateTotal(e),this.$decodeResults(e)},$decodeResults:function(e){return e.results},$updatePageSize:function(e){R(e.page_size)&&(this.page_size=e.page_size)},$setPageSize:function(e){this.page_size=e},$getPageSize:function(){return this.page_size},$updatePageIndex:function(e){R(e.page_index)&&(this.page_index=e.page_index)},$setPageIndex:function(e){this.page_index=e||0},$getPageIndex:function(){return this.page_index},$getPageOffset:function(){return this.page_index*this.page_size},$updateTotal:function(e){R(e.total)&&(this.total=e.total)},$setTotal:function(e){this.total=e||0},$getTotal:function(){return this.total},$getPageCount:function(){return Math.ceil(this.$getTotal()/this.$getPageSize())}}),Ke.Status={Pending:"pending",Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled"},Ke.Events={
Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled",Unsuccessful:"failure offline canceled",Complete:"success failure offline canceled"},Ke.all=function(e){function t(){r.push(Yt.slice.apply(arguments)),++i===s&&n.resolve(r)}for(var n=new Ke,i=0,s=e.length,r=[],a=0;a<e.length;a++){var o=e[a];o instanceof Ke?o.then(t,n.reject,n.noline,n.cancel,n):s--}return n},Ke.race=function(e){for(var t=new Ke,n=0;n<e.length;n++){var i=e[n];i instanceof Ke&&i.then(t.resolve,t.reject,t.noline,t.cancel,t)}return t},Ke.reject=function(e){var t=new Ke;return t.reject.apply(t,arguments),t},Ke.resolve=function(){var e=new Ke;return e.resolve.apply(e,arguments),e},Ke.noline=function(e){var t=new Ke;return t.noline.apply(t,arguments),t},Ke.cancel=function(){var e=new Ke;return e.cancel.apply(e,arguments),e},Ke.singularity=function(){function t(){++o===a&&i.resolve(s)}function n(e){a++,e.then(t,i.reject,i.noline,null,i)}var i=null,s=null,r=!1,a=0,o=0;return function(t,u,l){if(r)n(t),l.call(u,i);else{r=!0,i=new Ke(null,!1),s=u,a=0,o=0,n(t);try{l.call(u,i)}catch(h){throw e.console&&e.console.log&&e.console.log(h),h}finally{r=!1}}return i}}(),d(Ke.prototype,{resolve:function(){this.finish(Ke.Status.Success,Ke.Events.Success,arguments)},reject:function(){this.finish(Ke.Status.Failure,Ke.Events.Failure,arguments)},noline:function(){this.finish(Ke.Status.Offline,Ke.Events.Offline,arguments)},cancel:function(){this.cancelable&&this.finish(Ke.Status.Canceled,Ke.Events.Canceled,arguments)},then:function(e,t,n,i,s,r){return this.success(e,s,r),this.failure(t,s,r),this.offline(n,s,r),this.canceled(i,s,r),this},reset:function(e){return this.status=Ke.Status.Pending,e&&this.off(),this},finish:function(e,t,n){this.status===Ke.Status.Pending&&(this.results=Yt.slice.apply(n),this.status=e,this.trigger(t,n))},listenFor:function(e,t,n,i,s){return p(n)&&(this.status===Ke.Status.Pending?s?this.on(t,n,i):this.once(t,n,i):e&&n.apply(i||this,this.results)),this},success:function(e,t,n){return this.listenFor(this.isSuccess(),Ke.Events.Success,e,t,n)},unsuccessful:function(e,t,n){return this.listenFor(this.isUnsuccessful(),Ke.Events.Unsuccessful,e,t,n)},failure:function(e,t,n){return this.listenFor(this.isFailure(),Ke.Events.Failure,e,t,n)},"catch":function(e,t,n){return this.listenFor(this.isFailure(),Ke.Events.Failure,e,t,n)},offline:function(e,t,n){return this.listenFor(this.isOffline(),Ke.Events.Offline,e,t,n)},canceled:function(e,t,n){return this.listenFor(this.isCanceled(),Ke.Events.Canceled,e,t,n)},complete:function(e,t,n){return this.listenFor(!0,Ke.Events.Complete,e,t,n)},isSuccess:function(){return this.status===Ke.Status.Success},isUnsuccessful:function(){return this.status!==Ke.Status.Success&&this.status!==Ke.Status.Pending},isFailure:function(){return this.status===Ke.Status.Failure},isOffline:function(){return this.status===Ke.Status.Offline},isCanceled:function(){return this.status===Ke.Status.Canceled},isPending:function(){return this.status===Ke.Status.Pending},isComplete:function(){return this.status!==Ke.Status.Pending}}),K(Ke.prototype),d(Ge.prototype,{reset:function(e,t){this.model=e,this.cascade=R(t)?t:Bt.All,this.db=e.$db,this.next=null,this.finished=!1},canCascade:function(e){var t=e||this.cascading,n=this.cascade;return 0!==(t&n)},notCascade:function(e){var t=this.cascade;return 0===(e&t)},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):(this.next=e,this.model.$trigger(Te.Events.OperationsStarted))},tryNext:function(e){var t=!this.next;return t&&(this.next=new e(this.model,this.cascade)),t},insertNext:function(e){var t=new e(this.model,this.cascade);t.next=this.next,this.next=t},execute:function(){0===this.db.pendingOperations&&this.db.trigger(ye.Events.OperationsStarted),this.db.pendingOperations++,this.run(this.db,this.model)},run:function(e,t){throw"Operation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,(this.model.$operation=this.next)?this.next.execute():this.model.$trigger(Te.Events.OperationsFinished),this.db.pendingOperations--,0===this.db.pendingOperations&&(this.db.onOperationRest(),this.db.trigger(ye.Events.OperationsFinished))),this},success:function(){return D(this,this.handleSuccess)},handleSuccess:function(){this.onSuccess.apply(this,arguments),this.finish()},onSuccess:function(){},failure:function(){return D(this,this.handleFailure)},handleFailure:function(){this.onFailure.apply(this,arguments),this.finish()},onFailure:function(){}}),l(Ge,ze,{cascading:Bt.Local,interrupts:!1,type:"GetLocal",run:function(e,t){t.$isDeleted()?(t.$trigger(Te.Events.LocalGetFailure,[t]),this.finish()):this.canCascade()&&e.cache===jt.All?e.store.get(t.$key(),this.success(),this.failure()):(ve.debug(ve.Debugs.GET_LOCAL_SKIPPED,t),t.$trigger(Te.Events.LocalGet,[t]),this.insertNext(qe),this.finish())},onSuccess:function(e,t){var n=this.model;M(t)&&n.$set(t),ve.debug(ve.Debugs.GET_LOCAL,n,t),n.$trigger(Te.Events.LocalGet,[n]),this.canCascade(Bt.Rest)&&!n.$isDeleted()&&this.insertNext(qe)},onFailure:function(e){var t=this.model;ve.debug(ve.Debugs.GET_LOCAL,t,e),t.$trigger(Te.Events.LocalGetFailure,[t]),this.canCascade(Bt.Rest)&&!t.$isDeleted()&&this.insertNext(qe)}}),l(Ge,qe,{cascading:Bt.Rest,interrupts:!1,type:"GetRemote",run:function(e,t){t.$isDeleted()?(t.$trigger(Te.Events.RemoteGetFailure,[t]),this.finish()):this.canCascade()?(Ee(),e.rest.get(t,this.success(),this.failure()),Re()):(t.$trigger(Te.Events.RemoteGet,[t]),this.finish())},onSuccess:function(e){var t=this.db,n=t.resolveModel(e),i=this.model;M(n)&&t.putRemoteData(n,i.$key(),i,!0),ve.debug(ve.Debugs.GET_REMOTE,i,n),i.$trigger(Te.Events.RemoteGet,[i])},onFailure:function(e,t){var n=this.db,i=this.model;ve.debug(ve.Debugs.GET_REMOTE_ERROR,i,e,t),410===t||404===t?(this.insertNext(je),n.destroyModel(i),i.$trigger(Te.Events.RemoteGetFailure,[i,e])):0===t?i.$trigger(Te.Events.RemoteGetOffline,[i,e]):i.$trigger(Te.Events.RemoteGetFailure,[i,e])}}),l(Ge,Qe,{cascading:Bt.None,interrupts:!0,type:"RemoveCache",run:function(e,t){e.cache==jt.None?this.finish():e.store.remove(t.$key(),this.success(),this.failure())}}),l(Ge,Be,{cascading:Bt.Local,interrupts:!0,type:"RemoveLocal",run:function(e,t){t.$status=Te.Status.RemovePending,e.cache!==jt.None&&t.$local&&this.canCascade()?t.$saved?(t.$local.$status=t.$status,e.store.put(t.$key(),t.$local,this.success(),this.failure())):(ve.debug(ve.Debugs.REMOVE_LOCAL_UNSAVED,t),e.store.remove(t.$key(),this.success(),this.failure())):(ve.debug(ve.Debugs.REMOVE_LOCAL_NONE,t),t.$trigger(Te.Events.LocalRemove,[t]),this.insertNext(Je),this.finish())},onSuccess:function(e,t,n){var i=this.model;ve.debug(ve.Debugs.REMOVE_LOCAL,i),i.$trigger(Te.Events.LocalRemove,[i]),i.$saved&&this.canCascade(Bt.Remote)&&i.$addOperation(Je,this.cascade)},onFailure:function(e){var t=this.model;ve.debug(ve.Debugs.REMOVE_LOCAL_ERROR,t,e),t.$trigger(Te.Events.LocalRemoveFailure,[t]),t.$saved&&this.canCascade(Bt.Remote)&&t.$addOperation(Je,this.cascade)}}),l(Ge,je,{cascading:Bt.Local,interrupts:!0,type:"RemoveNow",run:function(e,t){var n=t.$key();t.$status=Te.Status.RemovePending,e.removeFromModels(t),e.cache!==jt.None&&this.canCascade()?e.store.remove(n,this.success(),this.failure()):(this.finishRemove(),this.finish())},onSuccess:function(){this.finishRemove()},onFailure:function(){this.finishRemove()},finishRemove:function(){var e=this.model;e.$status=Te.Status.Removed,delete e.$local,delete e.$saving,delete e.$publish,delete e.$saved}}),l(Ge,Je,{cascading:Bt.Remote,interrupts:!0,type:"RemoveRemote",run:function(e,t){this.notCascade(Bt.Rest)?(this.liveRemove(),t.$trigger(Te.Events.RemoteRemove,[t]),this.finish()):(t.$status=Te.Status.RemovePending,Ee(),e.rest.remove(t,this.success(),this.failure()),Re())},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var n=this.model,i=n.$key();404===t||410===t?(ve.debug(ve.Debugs.REMOVE_MISSING,n,i),this.finishRemove(!0)):0!==t?(ve.debug(ve.Debugs.REMOVE_ERROR,n,t,i,e),n.$trigger(Te.Events.RemoteRemoveFailure,[n,e])):(ve.checkNetworkStatus(),ve.online?n.$trigger(Te.Events.RemoteRemoveFailure,[n,e]):(ve.once(ve.Events.Online,this.handleOnline,this),n.$trigger(Te.Events.RemoteRemoveOffline,[n,e])),ve.debug(ve.Debugs.REMOVE_OFFLINE,n,e))},finishRemove:function(e){var t=this.db,n=this.model,i=n.$key();ve.debug(ve.Debugs.REMOVE_REMOTE,n,i),n.$status=Te.Status.Removed,n.$trigger(Te.Events.RemoteRemove,[n]),this.insertNext(je),e||this.liveRemove(),delete t.all[i]},liveRemove:function(){if(this.canCascade(Bt.Live)){var e=this.db,t=this.model,n=t.$key();ve.debug(ve.Debugs.REMOVE_PUBLISH,t,n),e.live.remove(t)}},handleOnline:function(){var e=this.model;ve.debug(ve.Debugs.REMOVE_RESUME,e),e.$addOperation(Je)}}),l(Ge,We,{cascading:Bt.Local,interrupts:!1,type:"SaveLocal",run:function(e,t){if(t.$isDeleted())ve.debug(ve.Debugs.SAVE_LOCAL_DELETED,t),t.$trigger(Te.Events.LocalSaveFailure,[t]),this.finish();else if(e.cache!==jt.None&&this.canCascade()){var n=t.$key(),i=t.$toJSON(!1);this.markSaving(e,t),t.$local?j(i,t.$local):(t.$local=i,t.$saved&&(t.$local.$saved=t.$saved)),t.$local.$status=t.$status,t.$local.$saving=t.$saving,t.$local.$publish=t.$publish,e.store.put(n,t.$local,this.success(),this.failure())}else this.canCascade(Bt.Remote)&&this.tryNext(Xe)&&this.markSaving(e,t),t.$trigger(Te.Events.LocalSave,[t]),this.finish()},markSaving:function(e,t){var n=t.$toJSON(!0),i=t.$getChanges(n),s=e.fullSave?n:i,r=e.fullPublish?n:i;t.$status=Te.Status.SavePending,t.$saving=s,t.$publish=r},clearLocal:function(e){e.$status=Te.Status.Synced,e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish,this.insertNext(Ze)},onSuccess:function(e,t,n){var i=this.model;ve.debug(ve.Debugs.SAVE_LOCAL,i),this.cascade?this.tryNext(Xe):this.clearLocal(i),i.$trigger(Te.Events.LocalSave,[i])},onFailure:function(e){var t=this.model;ve.debug(ve.Debugs.SAVE_LOCAL_ERROR,t,e),this.cascade?this.tryNext(Xe):this.clearLocal(t),t.$trigger(Te.Events.LocalSaveFailure,[t])}}),l(Ge,Ze,{cascading:Bt.Local,interrupts:!1,type:"SaveNow",run:function(e,t){var n=t.$key(),i=t.$local;e.cache===jt.All&&n&&i&&this.canCascade()?e.store.put(n,i,this.success(),this.failure()):this.finish()}}),l(Ge,Xe,{cascading:Bt.Remote,interrupts:!1,type:"SaveRemote",run:function(e,t){t.$isDeleted()?(ve.debug(ve.Debugs.SAVE_REMOTE_DELETED,t),this.markSynced(t,!0,Te.Events.RemoteSaveFailure,null),this.finish()):t.$isDependentsSaved(this.tryAgain,this)?!e.hasData(t.$saving)||this.notCascade(Bt.Rest)?(this.liveSave(),this.markSynced(t,!0,Te.Events.RemoteSave,null),this.finish()):(t.$status=Te.Status.SavePending,Ee(),t.$saved?e.rest.update(t,t.$saving,this.success(),this.failure()):e.rest.create(t,t.$saving,this.success(),this.failure()),Re()):this.finish()},onSuccess:function(e){var t=this.db,n=t.resolveModel(e),i=this.model;ve.debug(ve.Debugs.SAVE_REMOTE,i),this.handleData(n)},onFailure:function(e,t){var n=this.db,i=n.resolveModel(e),s=this.model;409===t?(ve.debug(ve.Debugs.SAVE_CONFLICT,s,i),this.handleData(i)):410===t||404===t?(ve.debug(ve.Debugs.SAVE_UPDATE_FAIL,s),this.insertNext(je),n.destroyModel(s),s.$trigger(Te.Events.RemoteSaveFailure,[s,e])):0!==t?(ve.debug(ve.Debugs.SAVE_ERROR,s,t),this.markSynced(s,!0,Te.Events.RemoteSaveFailure,e)):(ve.checkNetworkStatus(),ve.online?this.markSynced(s,!0,Te.Events.RemoteSaveFailure,e):(ve.once(ve.Events.Online,this.handleOnline,this),s.$trigger(Te.Events.RemoteSaveOffline,[s,e])),ve.debug(ve.Debugs.SAVE_OFFLINE,s,e))},markSynced:function(e,t,n,i){e.$status=Te.Status.Synced,this.clearPending(e),t&&this.insertNext(Ze),n&&e.$trigger(n,[e,i])},clearPending:function(e){delete e.$saving,delete e.$publish,e.$local&&(e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish)},handleData:function(e){var t=this.db,n=this.model,i=n.$saving;return n.$isDeleted()?(ve.debug(ve.Debugs.SAVE_REMOTE_DELETED,n,e),this.clearPending(n)):(ve.debug(ve.Debugs.SAVE_VALUES,n,i),n.$saved||(n.$saved=n.$local?n.$local.$saved={}:{}),j(i,n.$saved),F(e)||t.putRemoteData(e,n.$key(),n),this.liveSave(),this.markSynced(n,!1,Te.Events.RemoteSave,null),void(t.cache===jt.Pending?this.insertNext(Qe):this.insertNext(Ze)))},liveSave:function(){var e=this.db,t=this.model;this.canCascade(Bt.Live)&&e.hasData(t.$publish)&&(ve.debug(ve.Debugs.SAVE_PUBLISH,t,t.$publish),e.live.save(t,t.$publish))},handleOnline:function(){var e=this.model;e.$status===Te.Status.SavePending&&(e.$addOperation(Xe,this.cascade),ve.debug(ve.Debugs.SAVE_RESUME,e))},tryAgain:function(){var e=this.model;e.$addOperation(Xe,this.cascade)}}),ve.Relations={},et.Defaults={model:null,lazy:!1,store:Jt.None,save:Wt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},d(et.prototype,{debugQuery:null,debugQueryResults:null,getDefaults:function(e,t,n){return et.Defaults},init:function(e,t,n){if(G(this,n,this.getDefaults(e,t,n)),this.database=e,this.name=t,this.options=n,this.initialized=!1,this.property=this.property||i(e.fields,this.name)!==!1,this.discriminated=!F(this.discriminators),this.discriminated){if(!nn)throw"Polymorphic feature is required to use the discriminated option.";d(this,nn)}this.setReferences(e,t,n)},setReferences:function(e,t,n){$(this.model)?this.onInitialized(e,t,n):ve.get(this.model).complete(this.setModelReference(e,t,n),this)},setModelReference:function(e,t,n){return function(i){this.model=i,this.onInitialized(e,t,n)}},onInitialized:function(e,t,n){},finishInitialization:function(){this.initialized=!0,this.load.open()},load:be(function(e,t,n){}),set:function(e,t,n){},relate:function(e,t,n){},unrelate:function(e,t){},isRelated:function(e,t){},preClone:function(e,t,n){},postClone:function(e,t,n){},get:function(e){return e.$relations[this.name].related},encode:function(e,t,n){var i=e.$relations[this.name],s=n?this.save:this.store;if(i&&s){var r=i.related;A(r)?t[this.name]=this.getStoredArray(r,s):t[this.name]=this.getStored(r,s)}},ready:function(e){this.model.Database.ready(e,this)},listenToModelAdded:function(e){this.model.Database.on(ye.Events.ModelAdded,e,this)},executeQuery:function(e){if(!Ve)throw"Search feature is required to use the query option.";var t=this.query,n=this.queryOptions,i=this.queryData,s=E(t)?ne(t,e):t,r=this.model.search(s,n);M(i)&&j(i,r),ve.debug(this.debugQuery,this,e,r,t,s,i);var a=r.$run();return a.complete(this.handleExecuteQuery(e),this),r},handleExecuteQuery:function(e){return function(t){var n=t.$results;ve.debug(this.debugQueryResults,this,e,t);for(var i=0;i<n.length;i++)this.relate(e,n[i],!0)}},createRelationCollection:function(e){return new He(this.model.Database,e,this)},createCollection:function(){return new ke(this.model.Database)},parseModel:function(e,t){return this.model.Database.parseModel(e,t)},grabInitial:function(e,t){return q(e,t,O)?B(e,t):void 0},grabModel:function(e,t,n){this.model.Database.grabModel(e,t,this,n)},grabModels:function(e,t,n,i){for(var s=this.model.Database,r=0;r<t.length;r++){var a=t[r],o=s.buildKeyFromInput(a);e.pending[o]=!0,s.grabModel(a,n,this,i)}},setProperty:function(e){if(this.property){var t=e.parent,n=this.name,i=!!e.dynamicSet;if(!i&&this.dynamic&&Object.defineProperty){var s=this;Object.defineProperty(t,n,{enumerable:!0,set:function(e){s.set(t,e)},get:function(){return e.related}}),i=e.dynamicSet=!0}i||(t[n]=e.related),e.lastRelated!==e.related&&(e.lastRelated=e.related,t.$trigger(Te.Events.RelationUpdate,[this,e]))}},isModelArray:function(e){if(!A(e))return!1;var t=this.model.Database,n=t.key;if(!A(n))return!0;if(n.length!==e.length)return!0;for(var i=0;i<e.length;i++)if(!R(e[i])&&!E(e[i]))return!0;return!1},clearFields:function(e,t,n,i){var s=this.clearFieldsReturnChanges(e,t);return s&&!n&&this.auto&&!e.$isNew()&&e.$save(i),s},clearFieldsReturnChanges:function(e,t){var n=!1;if(E(t))e[t]&&(e[t]=null,n=!0);else for(var i=0;i<t.length;i++){var s=t[i];e[s]&&(e[s]=null,n=!0)}return n},updateFields:function(e,t,n,i,s){var r=this.updateFieldsReturnChanges(e,t,n,i);return r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(Te.Events.KeyUpdate,[e,n,t,i])),r},updateFieldsReturnChanges:function(e,t,n,i){var s=!1;if(E(t)){var r=e[t],a=n[i];H(r,a)||(e[t]=a,s=!0)}else for(var o=0;o<t.length;o++){var u=t[o],r=e[u],l=i[o],a=n[l];H(r,a)||(e[u]=X(a),s=!0)}return s},getStoredArray:function(e,t){if(!t)return null;for(var n=[],i=0;i<e.length;i++){var s=this.getStored(e[i],t);null!==s&&n.push(s)}return n},getStored:function(e,t){if(e)switch(t){case Wt.Model:return e.$toJSON(!0);case Jt.Model:if(e.$local)return e.$local;var n=e.$toJSON(!1);return e.$saved&&(n.$saved=e.$saved),n;case Wt.Key:case Jt.Key:return e.$key();case Wt.Keys:case Jt.Keys:return e.$keys()}return null}}),l(et,tt,{debugInit:null,debugClearModel:null,debugSetModel:null,debugLoaded:null,debugClearKey:null,debugUpdateKey:null,onInitialized:function(e,t,n){if(!this.discriminated){var i=this.model.Database;this.local=this.local||i.name+"_"+i.key}ve.debug(this.debugInit,this),this.finishInitialization()},set:function(e,n,i){if(F(n))this.unrelate(e,t,i);else{var s=e.$relations[this.name],r=this.parseModel(n,i);r&&!s.isRelated(r)&&(this.clearModel(s),this.setRelated(s,r,i))}},relate:function(e,t,n){var i=e.$relations[this.name],s=this.parseModel(t,n);s&&i.related!==s&&(this.clearModel(i),this.setRelated(i,s,n))},unrelate:function(e,t,n){var i=e.$relations[this.name],s=this.parseModel(t);s&&i.related!==s||this.clearRelated(i,n)},isRelated:function(e,t){var n=e.$relations[this.name],i=this.parseModel(t);return i===n.related},setRelated:function(e,t,n){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t,n),this.setProperty(e))},clearRelated:function(e,t){if(t){var n=e.related;if(n&&n.$isSaving())return}this.clearModel(e),this.clearForeignKey(e.parent),this.setProperty(e)},clearModel:function(e){var t=e.related;t&&(ve.debug(this.debugClearModel,this,e),e.onSaved&&t.$off(Te.Events.Saved,e.onSaved),e.onRemoved&&t.$off(Te.Events.Removed,e.onRemoved),e.related=null,e.dirty=!0,e.loaded=!0,delete e.parent.$dependents[t.$uid()])},setModel:function(e,t){e.onSaved&&t.$on(Te.Events.Saved,e.onSaved,this),e.onRemoved&&t.$on(Te.Events.Removed,e.onRemoved,this),e.related=t,e.dirty=!0,e.loaded=!0,e.parent.$dependents[t.$uid()]=t,ve.debug(this.debugSetModel,this,e)},handleModel:function(e,t){return function(n){var i=e.parent;ve.debug(this.debugLoaded,this,i,e,n),e.loaded===!1&&(n&&!n.$isDeleted()?(this.setModel(e,n,t),this.updateForeignKey(i,n,t)):this.query?e.query=this.executeQuery(i):this.preserve||this.clearForeignKey(i,t),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.local;return function(n){return z(e,t,n,n.$db.key)}},clearForeignKey:function(e,t){var n=this.local;ve.debug(this.debugClearKey,this,e,n),this.clearFields(e,n,t)},updateForeignKey:function(e,t,n){var i=this.local,s=t.$db.key;ve.debug(this.debugUpdateKey,this,e,i,t,s),this.updateFields(e,i,t,s,n)}}),l(et,nt,{debugAutoSave:null,debugInitialGrabbed:null,debugSort:null,handleExecuteQuery:function(e){return function(t){var n=e.$relations[this.name],i=t.$results;ve.debug(this.debugQueryResults,this,e,t),this.bulk(n,function(){for(var e=0;e<i.length;e++)this.addModel(n,i[e],!0)}),this.sort(n),this.checkSave(n,!0)}},bulk:function(e,t,n){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,n)},set:function(e,n,i){if(F(n))this.unrelate(e,t,i);else{var s=e.$relations[this.name],r=s.related,a=this.createCollection();if(this.isModelArray(n))for(var o=0;o<n.length;o++){var u=this.parseModel(n[o],i);u&&a.add(u)}else{var u=this.parseModel(n,i);u&&a.add(u)}var l=r.subtract(a),h=a.subtract(r);this.bulk(s,function(){for(var e=0;e<h.length;e++)this.addModel(s,h[e],i);for(var e=0;e<l.length;e++)this.removeModel(s,l[e],i)},i)}},relate:function(e,t,n){var i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e],n);s&&this.addModel(i,s,n)}});else if(O(t)){var s=this.parseModel(t,n);s&&this.addModel(i,s,n)}},unrelate:function(e,t,n){var i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e]);s&&this.removeModel(i,s,n)}});else if(O(t)){var s=this.parseModel(t);s&&this.removeModel(i,s,n)}else{var r=i.related;this.bulk(i,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(i,r[e],n)})}},isRelated:function(e,t){var n=e.$relations[this.name],i=n.related;if(this.isModelArray(t)){for(var s=0;s<t.length;s++){var r=this.parseModel(t[s]);if(r&&!i.has(r.$key()))return!1}return t.length>0}if(O(t)){var r=this.parseModel(t);return r&&i.has(r.$key())}return!1},canRemoveRelated:function(e,t){return!t||!e.$isSaving()},checkSave:function(e,t){e.delaySaving||t||!e.parent.$exists()||(this.store===Jt.Model||this.save===Wt.Model)&&(ve.debug(this.debugAutoSave,this,e),e.parent.$save())},handleModel:function(e,t){return function(n){var i=e.pending,s=n.$key();s in i&&(ve.debug(this.debugInitialGrabbed,this,e,n),this.addModel(e,n,t),delete i[s])}},sort:function(e){var t=e.related;e.delaySorting||(ve.debug(this.debugSort,this,e),t.sort(this.comparator),e.parent.$trigger(Te.Events.RelationUpdate,[this,e]))}}),ve.Relations.belongsTo=it,it.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:Wt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:Bt.Local,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},l(tt,it,{type:"belongsTo",debugInit:ve.Debugs.BELONGSTO_INIT,debugClearModel:ve.Debugs.BELONGSTO_CLEAR_MODEL,debugSetModel:ve.Debugs.BELONGSTO_SET_MODEL,debugLoaded:ve.Debugs.BELONGSTO_LOADED,debugClearKey:ve.Debugs.BELONGSTO_CLEAR_KEY,debugUpdateKey:ve.Debugs.BELONGSTO_UPDATE_KEY,debugQuery:ve.Debugs.BELONGSTO_QUERY,debugQueryResults:ve.Debugs.BELONGSTO_QUERY_RESULTS,getDefaults:function(e,t,n){return it.Defaults},load:be(function(e,t,n){var i=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,onRemoved:function(){ve.debug(ve.Debugs.BELONGSTO_NINJA_REMOVE,this,e,i),e.$remove(this.cascade),this.clearRelated(i)},onSaved:function(){ve.debug(ve.Debugs.BELONGSTO_NINJA_SAVE,this,e,i),i.isRelated(i.related)||(e.$remove(this.cascade),this.clearRelated(i))}};e.$on(Te.Events.PostRemove,this.postRemove,this),e.$on(Te.Events.KeyUpdate,this.onKeyUpdate,this),F(t)&&(t=this.grabInitial(e,this.local),t&&ve.debug(ve.Debugs.BELONGSTO_INITIAL_PULLED,this,e,t)),F(t)?this.query&&(i.query=this.executeQuery(e)):(ve.debug(ve.Debugs.BELONGSTO_INITIAL,this,e,t),this.grabModel(t,this.handleModel(i,n),n))}),postRemove:function(e){var t=e.$relations[this.name];t&&(ve.debug(ve.Debugs.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t),this.setProperty(t))},onKeyUpdate:function(e,t,n,i){if(this.local===n){var s=e.$relations[this.name];s&&t!==s.related&&(this.clearModel(s),this.setModel(s,t),this.setProperty(s))}}}),ve.Relations.hasOne=st,st.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:Wt.None,auto:!0,property:!0,preserve:!0,dynamic:!1,local:null,cascade:Bt.All,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},l(tt,st,{type:"hasOne",debugInit:ve.Debugs.HASONE_INIT,debugClearModel:ve.Debugs.HASONE_CLEAR_MODEL,debugSetModel:ve.Debugs.HASONE_SET_MODEL,debugLoaded:ve.Debugs.HASONE_LOADED,debugClearKey:ve.Debugs.HASONE_CLEAR_KEY,debugUpdateKey:ve.Debugs.HASONE_UPDATE_KEY,debugQuery:ve.Debugs.HASONE_QUERY,debugQueryResults:ve.Debugs.HASONE_QUERY_RESULTS,getDefaults:function(e,t,n){return st.Defaults},load:be(function(e,t,n){var i=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,dirty:!1,saving:!1,onRemoved:function(){ve.debug(ve.Debugs.HASONE_NINJA_REMOVE,this,e,i),this.clearRelated(i)}};e.$on(Te.Events.PreSave,this.preSave,this),e.$on(Te.Events.PostRemove,this.postRemove,this),F(t)&&(t=this.grabInitial(e,this.local),t&&ve.debug(ve.Debugs.HASONE_INITIAL_PULLED,this,e,t)),F(t)?this.query&&(i.query=this.executeQuery(e)):(ve.debug(ve.Debugs.HASONE_INITIAL,this,e,t),this.grabModel(t,this.handleModel(i),n))}),preClone:function(e,t,n){var i=this.get(e);if(i){var s=i.$clone(n);this.updateFieldsReturnChanges(t,this.local,s,s.$db.key),t[this.name]=s}},preSave:function(e){var t=e.$relations[this.name];if(t&&t.related){var n=t.related;(t.dirty||n.$hasChanges())&&(ve.debug(ve.Debugs.HASONE_PRESAVE,this,e,t),t.saving=!0,n.$save(),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade&&(ve.debug(ve.Debugs.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e){var t=e.related;t&&(ve.debug(this.debugClearModel,this,e),t.$off(Te.Events.Removed,e.onRemoved),this.cascade&&!t.$isDeleted()&&t.$remove(this.cascade),e.related=null,e.dirty=!0,e.loaded=!0,delete e.parent.$dependents[t.$uid()])}}),ve.Relations.hasMany=rt,rt.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:Wt.None,auto:!0,property:!0,dynamic:!1,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:Bt.Local,cascadeSave:Bt.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},l(nt,rt,{type:"hasMany",debugAutoSave:ve.Debugs.HASMANY_AUTO_SAVE,debugInitialGrabbed:ve.Debugs.HASMANY_INITIAL_GRABBED,debugSort:ve.Debugs.HASMANY_SORT,debugQuery:ve.Debugs.HASMANY_QUERY,debugQueryResults:ve.Debugs.HASMANY_QUERY_RESULTS,getDefaults:function(e,t,n){return rt.Defaults},onInitialized:function(e,t,n){this.foreign=this.foreign||e.name+"_"+e.key,this.comparator=P(this.comparator,this.comparatorNullsFirst),ve.debug(ve.Debugs.HASMANY_INIT,this),this.finishInitialization()},load:be(function(e,t,n){var i=this,s=e.$relations[this.name]={parent:e,pending:{},isRelated:this.isRelatedFactory(e),related:this.createRelationCollection(e),saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){ve.debug(ve.Debugs.HASMANY_NINJA_REMOVE,i,e,this,s),i.removeModel(s,this,!0)},onSaved:function(){s.saving||(ve.debug(ve.Debugs.HASMANY_NINJA_SAVE,i,e,this,s),s.isRelated(this)?(i.sort(s),i.checkSave(s)):i.removeModel(s,this))}};e.$on(Te.Events.PostSave,this.postSave,this),e.$on(Te.Events.PreRemove,this.preRemove,this),this.listenToModelAdded(this.handleModelAdded(s)),A(t)?(ve.debug(ve.Debugs.HASMANY_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,n),n)):this.query?s.query=this.executeQuery(e):(ve.debug(ve.Debugs.HASMANY_INITIAL_PULLED,this,e,s),this.ready(this.handleLazyLoad(s))),this.setProperty(s)}),postClone:function(e,t,n){var i=this.get(e);if(i){var s=[];this.updateFieldsReturnChanges(n,this.foreign,t,e.$db.key),n[this.foreign]=t[e.$db.key];for(var r=0;r<i.length;r++)s.push(i[r].$clone(n));t[this.name]=s}},postSave:function(e){var t=e.$relations[this.name];if(t&&this.cascadeSave){ve.debug(ve.Debugs.HASMANY_POSTSAVE,this,e,t),Ee(),t.saving=!0,t.delaySaving=!0;for(var n=t.related,i=0;i<n.length;i++){var s=n[i];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave)}t.saving=!1,t.delaySaving=!1,Re()}},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(ve.debug(ve.Debugs.HASMANY_PREREMOVE,this,e,t),Ee(),this.bulk(t,function(){for(var e=t.related,n=e.length-1;n>=0;n--){var i=e[n];i.$remove(this.cascadeRemove)}}),Re())},handleModelAdded:function(e){return function(t,n){e.isRelated(t)&&(ve.debug(ve.Debugs.HASMANY_NINJA_ADD,this,e,t),this.addModel(e,t,n))}},handleLazyLoad:function(e){return function(t){var n=t.filter(e.isRelated);ve.debug(ve.Debugs.HASMANY_LAZY_LOAD,this,e,n),n.length?this.bulk(e,function(){for(var t=0;t<n.length;t++)this.addModel(e,n[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,n){if(!t.$isDeleted()){var i=e.parent,s=e.related,r=t.$key(),a=!s.has(r);return a&&(ve.debug(ve.Debugs.HASMANY_ADD,this,e,t),s.put(r,t),t.$on(Te.Events.Removed,e.onRemoved),t.$on(Te.Events.SavedRemoteUpdate,e.onSaved),t.$dependents[i.$uid()]=i,this.updateForeignKey(i,t,n),this.sort(e),n||this.checkSave(e)),a}},removeModel:function(e,t,n){if(this.canRemoveRelated(t,n)){var i=e.parent,s=e.related,r=e.pending,a=t.$key();s.has(a)&&(ve.debug(ve.Debugs.HASMANY_REMOVE,this,e,t),s.remove(a),t.$off(Te.Events.Removed,e.onRemoved),t.$off(Te.Events.SavedRemoteUpdate,e.onSaved),delete t.$dependents[i.$uid()],this.cascadeRemove&&(n?ge(this.cascadeRemove,Bt.Local)&&t.$remove(Bt.Local):t.$remove(this.cascadeRemove)),this.sort(e),this.checkSave(e)),delete r[a]}},updateForeignKey:function(e,t,n){var i=this.foreign,s=e.$db.key;this.updateFields(t,i,e,s,n)},isRelatedFactory:function(e){var t=this.foreign,n=e.$db.key;return function(i){return z(i,t,e,n)}}}),ve.Relations.hasManyThrough=at,at.Defaults={model:null,lazy:!1,query:!1,store:Jt.None,save:Wt.None,auto:!0,property:!0,dynamic:!1,through:t,local:null,foreign:null,comparator:null,comparatorNullsFirst:!1,cascadeRemove:Bt.NoRest,cascadeSave:Bt.All,cascadeSaveRelated:Bt.None,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},l(nt,at,{type:"hasManyThrough",debugAutoSave:ve.Debugs.HASMANYTHRU_AUTO_SAVE,debugInitialGrabbed:ve.Debugs.HASMANYTHRU_INITIAL_GRABBED,debugSort:ve.Debugs.HASMANYTHRU_SORT,debugQuery:ve.Debugs.HASMANYTHRU_QUERY,debugQueryResults:ve.Debugs.HASMANYTHRU_QUERY_RESULTS,getDefaults:function(e,t,n){return at.Defaults},onInitialized:function(e,t,n){if(!this.discriminated){var i=this.model.Database;this.foreign=this.foreign||i.name+"_"+i.key}this.local=this.local||e.name+"_"+e.key,this.comparator=P(this.comparator,this.comparatorNullsFirst),$(n.through)?this.setThrough(n.through):ve.get(n.through).complete(this.setThrough,this),ve.debug(ve.Debugs.HASMANYTHRU_INIT,this)},setThrough:function(e){this.through=e,this.finishInitialization()},load:be(function(e,t,n){var i=this,s=this.through.Database,r=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),pending:{},related:this.createRelationCollection(e),throughs:new Ie,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){ve.debug(ve.Debugs.HASMANYTHRU_NINJA_REMOVE,i,e,this,r),i.removeModel(r,this)},onSaved:function(){r.saving||(ve.debug(ve.Debugs.HASMANYTHRU_NINJA_SAVE,i,e,this,r),i.sort(r),i.checkSave(r))},onThroughRemoved:function(){ve.debug(ve.Debugs.HASMANYTHRU_NINJA_THRU_REMOVE,i,e,this,r),i.removeModelFromThrough(r,this)}};e.$on(Te.Events.PostSave,this.postSave,this),e.$on(Te.Events.PreRemove,this.preRemove,this),s.on(ye.Events.ModelAdded,this.handleModelAdded(r),this),A(t)?(ve.debug(ve.Debugs.HASMANYTHRU_INITIAL,this,e,r,t),this.grabModels(r,t,this.handleModel(r,n),n)):this.query?r.query=this.executeQuery(e):(ve.debug(ve.Debugs.HASMANYTHRU_INITIAL_PULLED,this,e,r),s.ready(this.handleLazyLoad(r),this)),this.setProperty(r)}),preClone:function(e,t,n){var i=this.get(e);i&&(t[this.name]=i.slice())},postSave:function(e){var t=e.$relations[this.name];if(Ee(),t&&this.cascadeSave)for(var n=t.throughs.values,i=0;i<n.length;i++){var s=n[i];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave)}if(t&&this.cascadeSaveRelated){ve.debug(ve.Debugs.HASMANYTHRU_PRESAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var r=t.related,i=0;i<r.length;i++){var a=r[i];!a.$isDeleted()&&a.$hasChanges()&&a.$save(this.cascadeSaveRelated)}t.saving=!1,t.delaySaving=!1}Re()},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(ve.debug(ve.Debugs.HASMANYTHRU_PREREMOVE,this,e,t),Ee(),this.bulk(t,function(){for(var e=t.throughs.values,n=0;n<e.length;n++){var i=e[n];i.$remove(this.cascadeRemove)}}),Re())},handleModelAdded:function(e){return function(t,n){e.isRelated(t)&&!e.throughs.has(t.$key())&&(ve.debug(ve.Debugs.HASMANYTHRU_NINJA_ADD,this,e,t),this.addModelFromThrough(e,t,n))}},handleLazyLoad:function(e){return function(t){var n=t.filter(e.isRelated);ve.debug(ve.Debugs.HASMANYTHRU_LAZY_LOAD,this,e,n),n.length?this.bulk(e,function(){for(var t=0;t<n.length;t++)this.addModelFromThrough(e,n[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,n){if(!t.$isDeleted()){var i=this.finishAddModel(e,t,n);return i&&this.addThrough(e,t,n),
i}},addThrough:function(e,t,n){var i=this.through.Database,s=this.createThroughKey(e,t);i.grabModel(s,this.onAddThrough(e,n),this,n)},onAddThrough:function(e,t){return function(n){this.finishAddThrough(e,n,t)}},addModelFromThrough:function(e,t,n){if(!t.$isDeleted()){var i=this.model.Database,s=i.buildKey(t,this.foreign);i.grabModel(s,this.onAddModelFromThrough(e,t,n),this,n)}},onAddModelFromThrough:function(e,t,n){return function(i){i&&(this.finishAddThrough(e,t,n),this.finishAddModel(e,i,n))}},finishAddThrough:function(e,t,n){var i=e.parent,s=e.throughs,r=t.$key();s.has(r)||(ve.debug(ve.Debugs.HASMANYTHRU_THRU_ADD,this,e,t),s.put(r,t),t.$on(Te.Events.Removed,e.onThroughRemoved),t.$dependents[i.$uid()]=i,!n&&this.cascadeSave&&(i.$isSaved()?t.$save(this.cascadeSave):t.$save(Bt.None)))},finishAddModel:function(e,t,n){var i=e.related,s=t.$key(),r=!i.has(s);return r&&(ve.debug(ve.Debugs.HASMANYTHRU_ADD,this,e,t),i.put(s,t),t.$on(Te.Events.Removed,e.onRemoved),t.$on(Te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),n||this.checkSave(e)),r},removeModel:function(e,t,n){var i=t.$key(),s=e.related,r=s.get(i);r&&this.removeThrough(e,t,n)&&this.finishRemoveRelated(e,i,n)},removeThrough:function(e,t,n){var i=this.through.Database,s=this.createThroughKey(e,t),r=i.getKey(s),a=e.throughs,o=a.get(r);return this.finishRemoveThrough(e,o,t,!0,n)},removeModelFromThrough:function(e,t){var n=this.model.Database,i=n.buildKey(t,this.foreign);this.finishRemoveThrough(e,t)&&this.finishRemoveRelated(e,i)},finishRemoveThrough:function(e,t,n,i,s){var r=e.parent,a=!!t;if(a){if(!this.canRemoveRelated(t,s))return!1;ve.debug(ve.Debugs.HASMANYTHRU_THRU_REMOVE,this,e,t,n);var o=e.throughs,u=t.$key();t.$off(Te.Events.Removed,e.onThroughRemoved),delete t.$dependents[r.$uid()],i&&t.$remove(s?Bt.Local:Bt.All),o.remove(u)}return a},finishRemoveRelated:function(e,t){var n=e.pending,i=e.related,s=i.get(t);return s&&(ve.debug(ve.Debugs.HASMANYTHRU_REMOVE,this,e,s),i.remove(t),s.$off(Te.Events.Removed,e.onRemoved),s.$off(Te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete n[t],s},isRelatedFactory:function(e){var t=e.$db.key,n=this.local;return function(i){return z(i,n,e,t)}},createThroughKey:function(e,t){for(var n=e.parent,s=n.$db,r=this.model.Database,a=this.through.Database,o=a.key,u={},l=0;l<o.length;l++){var h=o[l];if(h===this.foreign)u[h]=t.$key();else if(h===this.local)u[h]=n.$key();else if(A(this.foreign)){var c=i(this.foreign,h),d=r.key[c];u[h]=t[d]}else if(A(this.local)){var c=i(this.local,h),d=s.key[c];u[h]=n[d]}}return u}}),ve.Relations.hasRemote=ot,ot.Defaults={model:t,lazy:!1,query:!1,store:Jt.None,save:Wt.None,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1,autoRefresh:!1},l(nt,ot,{type:"hasRemote",debugSort:ve.Debugs.HASREMOTE_SORT,debugQuery:ve.Debugs.HASREMOTE_QUERY,debugQueryResults:ve.Debugs.HASREMOTE_QUERY_RESULTS,getDefaults:function(e,t,n){return ot.Defaults},onInitialized:function(e,t,n){this.comparator=P(this.comparator,this.comparatorNullsFirst),ve.debug(ve.Debugs.HASREMOTE_INIT,this),this.finishInitialization()},load:be(function(e,t,n){var i=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){ve.debug(ve.Debugs.HASREMOVE_NINJA_REMOVE,i,e,this,s),i.removeModel(s,this,!0)},onSaved:function(){ve.debug(ve.Debugs.HASREMOVE_NINJA_SAVE,i,e,this,s),i.sort(s),i.checkSave(s)}};e.$key(),this.autoRefresh&&e.$on(this.autoRefresh,this.onRefresh(s),this),s.query=this.executeQuery(e),this.setProperty(s)}),onRefresh:function(e){return function(){e.query=this.executeQuery(e.parent)}},addModel:function(e,t,n){if(!t.$isDeleted()){var i=(e.parent,e.related),s=t.$key(),r=!i.has(s);return r&&(ve.debug(ve.Debugs.HASMANY_ADD,this,e,t),i.put(s,t),t.$on(Te.Events.Removed,e.onRemoved),t.$on(Te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),n||this.checkSave(e)),r}},removeModel:function(e,t,n){if(this.canRemoveRelated(t,n)){var i=(e.parent,e.related),s=e.pending,r=t.$key();i.has(r)&&(ve.debug(ve.Debugs.HASMANY_REMOVE,this,e,t),i.remove(r),t.$off(Te.Events.Removed,e.onRemoved),t.$off(Te.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete s[r]}}});var nn={setReferences:function(e,t,n){this.isRelatedFactory=this.isRelatedDiscriminatedFactory(this.isRelatedFactory),this.loadDiscriminators(function(){this.onInitialized(e,t,n)})},isRelatedDiscriminatedFactory:function(e){return function(t){var n=e.call(this,t),i=this.getDiscriminatorForModel(t),s=this.discriminator;return function(e){return n(e)?H(i,e[s]):!1}}},loadDiscriminators:function(e){function t(){++s===i&&e.apply(this)}var n=this.discriminators,i=T(n),s=0;for(var r in n){var a=n[r];ve.get(r).complete(this.setDiscriminated(a,t),this)}},setDiscriminated:function(e,t){return function(n){this.discriminators[n.Database.name]=e,this.discriminators[n.Database.className]=e,this.discriminatorToModel[e]=n,t.apply(this)}},createRelationCollection:function(e){return xe(new He(t,e,this),this.discriminator,this.discriminatorToModel)},createCollection:function(){return xe(new ke,this.discriminator,this.discriminatorToModel)},ready:function(e){var t=this.discriminatorToModel;for(var n in t){var i=t[n];i.Database.ready(e,this)}},listenToModelAdded:function(e){var t=this.discriminatorToModel;for(var n in t){var i=t[n];i.Database.on(ye.Events.ModelAdded,e,this)}},executeQuery:function(e){var t=this.query,n=this.queryOptions,i=this.queryData,s=E(t)?ne(t,e):t,r=e.search(s,n);M(i)&&r.$set(i),xe(r.$results,this.discriminator,this.discriminatorToModel);var a=r.$run();return a.complete(this.handleExecuteQuery(e),this),r},parseModel:function(e,t){if(e instanceof Te)return e;if(M(e)){var n=this.getDiscriminatorDatabase(e);if(n)return n.parseModel(e,t)}return!1},clearFields:function(e,t,n){var i=this.clearFieldsReturnChanges(e,t);return e[this.discriminator]&&(e[this.discriminator]=null,i=!0),i&&!n&&this.auto&&!e.$isNew()&&e.$save(),i},updateFields:function(e,t,n,i,s){var r=this.updateFieldsReturnChanges(e,t,n,i),a=this.discriminator,o=e[a],u=this.getDiscriminatorForModel(n);return H(o,u)||(e[a]=u,r=!0),r&&(!this.auto||e.$isNew()||s||e.$save(),e.$trigger(Te.Events.KeyUpdate,[e,n,t,i])),r},grabInitial:function(e,t){var n=this.discriminator,i=e[n];if(q(e,t,O)&&O(i)){var s=this.discriminatorToModel[i];if(s.Database){var r={};if(r[n]=i,E(t))r[s.Database.key]=e[t];else for(var a=0;a<t.length;a++)r[s.Database.key[a]]=e[t[a]];return r}}},grabModel:function(e,t,n){if(M(e)){var i=this.getDiscriminatorDatabase(e);i!==!1&&i.grabModel(e,t,this,n)}},grabModels:function(e,t,n){for(var i=0;i<e.length;i++){var s=e[i];if(s instanceof Te)t.call(this,s);else if(M(s)){var r=this.getDiscriminatorDatabase(s);if(r){var a=r.buildKeyFromInput(s);relation.pending[a]=!0,r.grabModel(s,t,this,n)}}}},ownsForeignKey:function(){return!0},isModelArray:function(e){return A(e)},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e),e=this.discriminatorToModel[t];return e?e.Database:!1},getDiscriminatorForModel:function(e){return this.discriminators[e.$db.name]}};ve.shard=function(e){return function(t){var n=new ut(t);return d(n,e),n.initialize(t),n}},d(ut.prototype,{STATUS_FAIL_ALL:500,STATUS_FAIL_GET:500,STATUS_FAIL_CREATE:500,STATUS_FAIL_UPDATE:500,STATUS_FAIL_REMOVE:500,STATUS_FAIL_QUERY:500,ATOMIC_ALL:!1,ATOMIC_GET:!1,ATOMIC_CREATE:!0,ATOMIC_UPDATE:!0,ATOMIC_REMOVE:!1,ATOMIC_QUERY:!0,getShards:function(e){throw"getShards not implemented"},getShardForModel:function(e,t){throw"getShardForModel not implemented"},getShardsForModel:function(e,t){var n=this.getShardForModel(e,t);return n?[n]:this.getShards(t)},getShardsForQuery:function(e,t){return this.getShards()},initialize:function(e){},all:function(e,t){function n(e,t,n){e.all(t,n)}function i(e){A(e)&&a.push.apply(a,e)}function s(n,i,s){n||a.length&&!this.ATOMIC_ALL?e(a):i||t(a,m(s)?s:this.STATUS_FAIL_ALL)}var r=this.getShards(!0),a=[];this.multiplex(r,this.ATOMIC_ALL,n,i,t,s)},get:function(e,t,n){function i(t,n,i){t.get(e,n,i)}function s(e){null===o&&M(e)&&(o=e)}function r(e,i,s){null!==o?t(o):n(o,m(s)?s:this.STATUS_FAIL_GET)}var a=this.getShardsForModel(e,!0),o=null;this.multiplex(a,this.ATOMIC_GET,i,s,_,r)},create:function(e,t,n,i){function s(n,i,s){n.create(e,t,i,s)}function r(e){null===u&&M(u)&&(u=e)}function a(e,t,s){e?n(u):i(u,m(s)?s:this.STATUS_FAIL_CREATE)}var o=this.getShardsForModel(e,!1),u=null;this.multiplex(o,this.ATOMIC_CREATE,s,r,_,a)},update:function(e,t,n,i){function s(n,i,s){n.update(e,t,i,s)}function r(e){null===u&&M(u)&&(u=e)}function a(e,t,s){e?n(u):i(u,m(s)?s:this.STATUS_FAIL_UPDATE)}var o=this.getShardsForModel(e,!1),u=null;this.multiplex(o,this.ATOMIC_UPDATE,s,r,_,a)},remove:function(e,t,n){function i(t,n,i){t.remove(e,n,i)}function s(e){null===o&&M(o)&&(o=e)}function r(e,i,s){e?t(o):n(o,m(s)?s:this.STATUS_FAIL_REMOVE)}var a=this.getShardsForModel(e,!1),o=null;this.multiplex(a,this.ATOMIC_REMOVE,i,s,_,r)},query:function(e,t,n,i){function s(n,i,s){n.query(e,t,i,s)}function r(e){A(e)&&u.push.apply(u,e)}function a(e,t,s){e||u.length&&!this.ATOMIC_QUERY?n(u):t||i(u,m(s)?s:this.STATUS_FAIL_QUERY)}var o=this.getShardsForQuery(e,t),u=[];this.multiplex(o,this.ATOMIC_QUERY,s,r,_,a)},multiplex:function(e,n,i,s,r,a){function o(){++f===e.length&&a.call(this,h,c,d)}function u(e){(h||!n)&&s.apply(this,arguments),o()}function l(e,i){h&&(h=!1,n&&(c=!0,r.apply(this,arguments))),R(i)&&(d===t||d>i)&&(d=i),o()}var h=!0,c=!1,d=t,f=0;if(A(e)&&0!==e.length)for(var v=0;v<e.length;v++)i.call(this,e[v],u,l);else a.call(this,!1,!1,d)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.all=function(){return t.models}}),ve.on(ve.Events.Plugins,function(e,t,n){e.boot=function(e){return A(e)?new ke(t,e,!0):M(e)?t.putRemoteData(e):e}}),ve.on(ve.Events.Plugins,function(e,t,n){e.collect=function(e){var n=arguments.length>1||!A(e)?Yt.slice.call(arguments):e;return new ke(t,n)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.create=function(e){var n=M(e)?t.createModel(e):t.instantiate();return n.$save(),n}}),ve.on(ve.Events.Plugins,function(e,t,n){var i=J(n.dynamic,ye.Defaults.dynamic);if(!F(i))for(var s in i)lt(e.prototype,s,i[s])}),ve.on(ve.Events.Plugins,function(e,t,n){var i=J(n.events,ye.Defaults.events);if(!F(i)){var s=[],r=[];for(var a in i){var o=i[a],u=he(a),l=ye.Events[u],h=Te.Events[u];l&&ht(l,o,!1,r),h&&ht(h,o,!0,s)}if(ct(t,r),s.length){var c=e.prototype.$init;Kt(e.prototype,"$init",function(){c.apply(this,arguments),ct(this,s)})}}}),ve.on(ve.Events.Plugins,function(e,t,n){function s(e){n[e]||(t[e]=u[e])}function r(e){var n=t[e],i=u[e];for(var s in i)s in n||(n[s]=i[s])}function a(e,n){for(var s=u[n||e],r=t[e],a=s.length-1;a>=0;a--){var o=i(r,s[a]);o!==!1&&r.splice(o,1),r.unshift(s[a])}}var o=n.extend||ye.Defaults.extend;if($(o)){var u=(ye.Defaults,o.Database),l=u.options;s("keySeparator"),r("defaults"),r("ignoredFields"),s("loadRelations"),s("loadRemote"),s("autoRefresh"),s("cache"),s("fullSave"),s("fullPublish"),r("encodings"),r("decodings"),s("summarize"),a("fields"),a("saveFields","fields"),n.comparator||t.setComparator(l.comparator,l.comparatorNullsFirst),n.revision||t.setRevision(l.revision),n.summarize||t.setSummarize(l.summarize);for(var h in u.relations)if(!(h in t.relations)){var c=u.relations[h],d=new c.constructor;d.init(t,h,c.options),d.save&&t.saveFields.push(h),t.relations[h]=d,t.relationNames.push(h)}t.rest=ve.rest(t),t.store=ve.store(t),t.live=ve.live(t)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.fetch=function(e,n,i){var s=t.buildKeyFromInput(e),r=t.get(s);if(r||(r=t.buildObjectFromKey(s),M(e)&&r.$set(e)),p(n)){var a=i||this;r.$once(Te.Events.RemoteGets,function(){n.call(a,r)})}return r.$refresh(),r}}),ve.on(ve.Events.Plugins,function(e,t,n){e.fetchAll=function(e,n){return t.refresh(e,n),t.models}}),ve.on(ve.Events.Plugins,function(e,t,n){var i=n.files||ye.Defaults.files;if(M(i)){if(!dt())return void ve.trigger(ve.Events.FilesNotSupported);for(var s in i){var r=i[s];E(r)&&(r={type:r}),t.decodings[s]=sn[r.type](t,r),t.encodings[s]=Rt}}}),ve.fileProcessors={},ve.Events.FilesNotSupported="files-not-supported",ve.Events.FileTooLarge="file-too-large",ve.Events.FileWrongType="file-wrong-type",ve.Events.FileOffline="file-offline",ve.addFileProcessor=function(e,t){ve.fileProcessors[e]=t},ve.fileProperties=["lastModifiedDate","name","size","type"];var sn={text:function(e,t){return Et("readAsText",vt,t)},dataURL:function(e,t){return Et("readAsDataURL",vt,t)},base64:function(e,t){return Et("readAsDataURL",gt,t)},resource:function(e,n){return function(e,s,r){var a=ft(e),o=ve.fileProcessors[n.processor];if(!o)throw"Processor required for resource files.";if(a!==!1){if(R(n.capacity)&&R(a.size)&&a.size>n.capacity)return ve.trigger(ve.Events.FileTooLarge,[a,s,r]),t;if(A(n.types)&&E(a.type)&&i(n.types,a.type)===!1)return ve.trigger(ve.Events.FileWrongType,[a,s,r]),t;var u=t,l=!1;return o.fileToValue(a,s,r,function(e){pt(s,r,e,a,n),u=$t(o,e,s,r,n),l&&(s[r]=u,mt(s,n))}),l=!0,u}return M(e)&&e.FILE?void ve.trigger(ve.Events.FileOffline,[e,s,r]):(pt(s,r,e,null,n),$t(o,e,s,r,n))}}};ve.on(ve.Events.Plugins,function(e,t,n){e.filtered=function(e,n,i){return t.models.filtered(e,n,i)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.find=function(e,n,i){return t.models.firstWhere(e,n,i)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.get=function(e,n,i){return p(n)?void t.grabModel(e,n,i):t.get(e)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.grab=function(n,i,s){var r=s||this,a=t.get(n);return a?i.call(r,a):t.grabModel(n,function(t){t?i.call(r,t):e.fetch(n,i,s)}),a}}),ve.on(ve.Events.Plugins,function(e,t,n){e.grabAll=function(e,n){var i=n||this,s=t.models;return s.length?e.call(i,s):t.ready(function(){s.length?e.call(i,s):t.refresh(function(){e.call(i,s)})}),s}}),ve.on(ve.Events.Plugins,function(e,t,n){var i=J(n.methods,ye.Defaults.methods);F(i)||d(e.prototype,i)}),ve.on(ve.Events.Plugins,function(e,t,n){e.ready=function(e,n,i){t.ready(e,n,i)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.refresh=function(e,n){return t.refresh(e,n)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.search=function(e,n,i,s){return new Ve(t,e,n,i,s)}}),ve.on(ve.Events.Plugins,function(e,t,n){e.searchPaged=function(e,n,i,s){return new Ye(t,e,n,i,s)}}),ve.on(ve.Events.Options,function(e){var t=e.shard||ye.Defaults.shard;M(t)&&(e.createRest=ve.shard(t))}),ve.on(ve.Events.Plugins,function(e,t,n){function s(){return bt(new Date,v)}function r(e){var t=bt(e,d);return t||e}function a(e){var t=bt(e,v,g);return t||e}function o(e){var n=i(t.fields,e);n===!1&&(t.fields.push(e),t.saveFields.push(e)),e in t.defaults||(t.defaults[e]=s),!d||e in t.encodings||(t.encodings[e]=r),!v||e in t.decodings||(t.decodings[e]=a)}function u(e){o(e),t.ignoredFields[e]=!0}function l(n){o(n),t.ignoredFields[n]=!0,f(e.prototype,"$save",function(e){return function(){this[n]=s(),e.apply(this,arguments)}})}function h(e,t){switch(e){case"created_at":return u(t);case"updated_at":return l(t);default:return o(t)}}var c=n.timestamps||ye.Defaults.timestamps,d=n.timestampFormat||ye.Defaults.timestampFormat,v=n.timestampType||ye.Defaults.timestampType,g=n.timestampUTC||ye.Defaults.timestampUTC;if(c)if(E(c))h(c,c);else if(A(c))for(var m=0;m<c.length;m++)h(c[m],c[m]);else if(M(c))for(var p in c)h(p,c[p]);else u("created_at"),l("updated_at")});var rn={Date:"date",Millis:"millis",Seconds:"seconds"};ye.Defaults.timestampFormat=rn.Millis,ye.Defaults.timestampType=rn.Date,ye.Defaults.timestampUTC=!1,ve.Timestamp=rn,ve.formatDate=_,ve.convertDate=bt,ve.on(ve.Events.Plugins,function(e,n,i){function s(e){return u[e]||e}var r=i.validation||ye.Defaults.validation;if(!F(r)){var a=r.rules||{},o=r.messages||{},u=r.aliases||{},l=!!r.required;n.validations={};for(var h in a)n.validations[h]=an.parseRules(a[h],h,n,s,o[h]);Kt(e.prototype,"$validate",function(){var e=this;this.$trigger(Te.Events.PreValidate,[this]),this.$valid=!0,this.$validations={},this.$validationMessages.length=0;for(var t in n.validations)for(var i=n.validations[t],s=this.$get(t),r=!0,a=function(n){n&&r&&(r=!1,e.$validations[t]=n,e.$validationMessages.push(n),e.$valid=!1)},o=0;o<i.length&&r&&s!==an.Stop;o++)s=i[o](s,this,a);return this.$trigger(this.$valid?Te.Events.ValidatePass:Te.Events.ValidateFail,[this]),this.$valid}),f(e.prototype,"$init",function(e){return function(){return this.$valid=t,this.$validations={},this.$validationMessages=[],e.apply(this,arguments)}}),l&&f(e.prototype,"$save",function(e){return function(){return this.$isDeleted()?(ve.debug(ve.Debugs.SAVE_DELETED,this.$db,this),Ke.resolve(this)):this.$validate()?e.apply(this,arguments):Ke.resolve(this)}})}}),Te.Events.PreValidate="pre-validate",Te.Events.ValidatePass="validate-pass",Te.Events.ValidateFail="validate-fail";var an={Rules:{},Expression:{},Expressions:[],Delimiter:/([|])/,Escape:"\\",RuleSeparator:":",Stop:{},parseRules:function(e,n,i,s,r){var a=[];if(E(e)&&(e=ce(e,this.Delimiter,this.Escape)),A(e))for(var o=0;o<e.length;o++){var u=e[o],l=this.parseRule(u,n,i,s,r);a.push(l)}else if(M(e))for(var u in e){var h=e[u],c=M(h)?h.message:E(h)?h:t,d=M(h)&&h.message?h.input:E(h)?t:h,l=this.parseRule(u,n,i,s,c||r,d);a.push(l)}return a},parseRule:function(e,t,n,i,s,r){var a=e.indexOf(this.RuleSeparator),o=-1===a?e:e.substring(0,a);if("$"===o.charAt(0))return this.customValidator(o,t,n,i,s);var u=-1===a?r:e.substring(a+1),l=an.Rules[o];if(!l)throw o+" is not a valid rule";return l(t,u,n,i,s)},parseExpression:function(e,t){for(var n=an.Expressions,i=0;i<n.length;i++){var s=n[i],r=s(e,t);if(p(r))return r}return _},customValidator:function(e,t,n,i,s){return function(t,n,r){var a=n[e](t,i,s);return E(a)&&r(a),t}}};ve.Validation=an,ve.ruleGenerator=Ot,ve.rangeRuleGenerator=Ht,ve.collectionRuleGenerator=Ft,ve.dateRuleGenerator=It,ve.fieldListRuleGenerator=Ct,ve.fieldsRuleGenerator=Ut,ve.foreignRuleGenerator=Pt,ve.subRuleGenerator=kt,ve.listRuleGenerator=wt,ve.regexRuleGenerator=xt,ve.sizeRuleGenerator=Vt,ve.joinFriendly=Dt,ve.tryParseFloat=yt,ve.tryParseInt=St,ve.startOfDay=At,ve.endOfDay=Mt,ve.determineMessage=_t,ve.mapFromArray=Lt,ve.checkNoParams=Nt,ve.generateMessage=Tt,an.Rules.accepted=function(e,t,n,i,s){Nt("accepted",e,t);var r=_t("accepted",s),a=an.Rules.accepted.acceptable;return function(t,n,s){var o=(t+"").toLowerCase(),u=a[o];return u||s(Tt(e,i(e),t,n,r)),t}},an.Rules.accepted.message="{$alias} has not been accepted.",an.Rules.accepted.acceptable={1:!0,yes:!0,on:!0,y:!0,"true":!0},Ft("contains","{$alias} does not contain an item whose {$matchAlias} equals {$matchValue}.",function(e,t,n,i,s){return!e.contains(function(e){return e!==t&&s(i,e.$get(n))})}),Ft("not_contains","{$alias} contains an item whose {$matchAlias} equals {$matchValue}.",function(e,t,n,i,s){return e.contains(function(e){return e!==t&&s(i,e.$get(n))})}),an.Rules.validate=function(e,t,n,i,s){var r=t||"message",a=_t("validate",s);return function(t,n,s){if(A(t)){for(var o=new Ce,u=0;u<t.length;u++){var n=t[u];n&&n.$validate&&!n.$validate()&&o.push(n)}if(o.length)switch(r){case"models":s(o);break;case"validations":s(o.pluck("$validations","$$key"));break;default:s(Tt(e,i(e),t,n,a))}}return t}},an.Rules.validate.message="{$alias} is not valid.",It("after","{$alias} must be after {$date}.",function(e,t){return e<Mt(t)}),It("after_on","{$alias} must be after or equal to {$date}.",function(e,t){return t>e}),It("before","{$alias} must be before {$date}.",function(e,t){return e>t}),It("before_on","{$alias} must be before or equal to {$date}.",function(e,t){return e>Mt(t)}),Ot("date_like","{$alias} must be a valid date.",function(e,t,n){var i=se(e),s=i===!1;return s||n(i.getTime()),s}),Ct("required_if","{$alias} is required.",function(e,t,n,i,s){var r=s[t.$get(n)];return r&&F(e)}),Ct("required_unless","{$alias} is required.",function(e,t,n,i,s){var r=!s[t.$get(n)];return r&&F(e)}),Ut("confirmed","{$alias} must match {$fieldAliases}.",function(e,t,n,i){for(var s=!0,r=0;r<n.length;r++)H(e,t.$get(n[r]))||(s=!1);return!s}),Ut("different","{$alias} must not match {$fieldAliases}.",function(e,t,n,i){for(var s=!1,r=0;r<n.length;r++)H(e,t.$get(n[r]))||(s=!0);return!s}),Ut("if_valid","",function(e,t,n,i){for(var s=!0,r=0;r<n.length&&s;r++)t.$validations[n[r]]&&(s=!1);return s||i(an.Stop),!1}),Ut("required_with","{$alias} is required.",function(e,t,n,i){for(var s=!1,r=0;r<n.length&&!s;r++)F(t.$get(n[r]))||(s=!0);return s&&F(e)}),Ut("required_with_all","{$alias} is required.",function(e,t,n,i){for(var s=!0,r=0;r<n.length&&s;r++)F(t.$get(n[r]))&&(s=!1);return s&&F(e)}),Ut("required_without","{$alias} is required.",function(e,t,n,i){for(var s=!1,r=0;r<n.length&&!s;r++)F(t.$get(n[r]))&&(s=!0);return s&&F(e)}),Ut("required_without_all","{$alias} is required.",function(e,t,n,i){for(var s=!0,r=0;r<n.length&&s;r++)F(t.$get(n[r]))||(s=!1);return s&&F(e)}),Pt("exists","{$alias} must match an existing {$matchAlias} in a {$class}",function(e,t,n,i){return!n.contains(function(n){return n!==t&&H(e,n.$get(i))})}),Pt("unique","{$alias} must be a unique {$matchAlias} in a {$class}",function(e,t,n,i){return n.contains(function(n){return n!==t&&H(e,n.$get(i))})}),kt("if",function(e,t){return e>0}),kt("if_any",function(e,t){return e>=t}),kt("if_not",function(e,t){return t>e}),wt("in","{$alias} must be one of {$list}.",function(e,t,n){return!n(e,t)}),wt("not_in","{$alias} must not be one of {$list}.",function(e,t,n){return n(e,t)}),Ht("between",{string:"{$alias} must have between {$start} to {$end} characters.",number:"{$alias} must be between {$start} and {$end}.",object:"{$alias} must have between {$start} to {$end} items."},function(e,t,n){return t>e||e>n}),Ht("not_between",{string:"{$alias} must not have between {$start} to {$end} characters.",number:"{$alias} must not be between {$start} and {$end}.",object:"{$alias} must not have between {$start} to {$end} items."},function(e,t,n){return e>=t&&n>=e}),xt("alpha","{$alias} should only contain alphabetic characters.",/^[a-zA-Z]*$/),xt("alpha_dash","{$alias} should only contain alpha-numeric characters, dashes, and underscores.",/^[a-zA-Z0-9_-]*$/),xt("alpha_num","{$alias} should only contain alpha-numeric characters.",/^[a-zA-Z0-9]*$/),xt("email","{$alias} is not a valid email.",/^.+@.+\..+$/),xt("url","{$alias} is not a valid URL.",/^(https?:\/\/)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)$/),xt("uri","{$alias} is not a valid URI.",/^(\w+:\/\/)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)$/),xt("phone","{$alias} is not a valid phone number.",/^1?\W*([2-9][0-8][0-9])\W*([2-9][0-9]{2})\W*([0-9]{4})(\se?x?t?(\d*))?$/),an.Rules.regex=function(e,t,n,i,s){var r;if(E(t)){var a=/^\/(.*)\/([gmi]*)$/.exec(t);a&&(r=new RegExp(a[1],a[2]))}else S(t)&&(r=t);if(!r)throw t+" is not a valid regular expression for the regex rule";var o=_t("regex",s);return function(t,n,s){return r.test(t)||s(Tt(e,i(e),t,n,o)),t}},an.Rules.regex.message="{$alias} is not a valid value.",Ot("required","{$alias} is required.",function(e){return F(e)}),Vt("min",{string:"{$alias} must have a minimum of {$number} characters.",number:"{$alias} must be at least {$number}.",object:"{$alias} must have at least {$number} items."},function(e,t){return t>e}),Vt("greater_than",{string:"{$alias} must have more than {$number} characters.",number:"{$alias} must be greater than {$number}.",object:"{$alias} must have more than {$number} items."},function(e,t){return t>=e}),Vt("max",{string:"{$alias} must have no more than {$number} characters.",number:"{$alias} must be no more than {$number}.",object:"{$alias} must have no more than {$number} items."},function(e,t){return e>t}),Vt("less_than",{string:"{$alias} must have less than {$number} characters.",number:"{$alias} must be less than {$number}.",object:"{$alias} must have less than {$number} items."},function(e,t){return e>=t}),Vt("equal",{string:"{$alias} must have {$number} characters.",number:"{$alias} must equal {$number}.",object:"{$alias} must have {$number} items."},function(e,t){return e!==t}),Vt("not_equal",{string:"{$alias} must not have {$number} characters.",number:"{$alias} must not equal {$number}.",object:"{$alias} must not have {$number} items."},function(e,t){return e===t}),Ot("array","{$alias} must be an array.",function(e){return!A(e)}),Ot("object","{$alias} must be an object.",function(e){return!M(e)}),Ot("string","{$alias} must be a string.",function(e){return!E(e)}),Ot("number","{$alias} must be a number.",function(e){return!R(e)}),Ot("boolean","{$alias} must be a true or false.",function(e){return!b(e)}),Ot("model","{$alias} must have a value.",function(e){return!(e instanceof Te)}),Ot("whole","{$alias} must be a whole number.",function(e,t,n){var i=St(e),s=parseFloat(e),r=!R(i);return r||(r=Math.floor(i)!==s,r||n(i)),r}),Ot("numeric","{$alias} must be numeric.",function(e,t,n){var i=yt(e),s=!R(i);return s||n(i),s}),Ot("yesno","{$alias} must be a yes or no.",function(e,t,n){var i=an.Rules.yesno.map[e],s=!b(i);return s||n(i),s}),an.Rules.yesno.map={"true":!0,t:!0,yes:!0,y:!0,1:!0,"false":!1,f:!1,no:!1,n:!1,0:!1},an.Expression.date=an.Expressions.push(function(e,t){var n=se(e);if(n!==!1){var i=n.getTime();return function(e,t){return i}}})-1,an.Expression.field=an.Expressions.push(function(e,t){return i(t.fields,e)?function(t,n){return n.$get(e)}:void 0})-1;var on=/^([+-]\d+(\.\d+)?)\s*(.+)$/,un={ms:1,millisecond:1,milliseconds:1,s:1e3,second:1e3,seconds:1e3,min:6e4,mins:6e4,minute:6e4,minutes:6e4,hr:36e5,hour:36e5,hours:36e5,day:864e5,days:864e5,wk:6048e5,week:6048e5,weeks:6048e5,month:["getMonth","setMonth"],months:["getMonth","setMonth"],yr:["getFullYear","setFullYear"],year:["getFullYear","setFullYear"],years:["getFullYear","setFullYear"]};an.Expression.relative=an.Expressions.push(function(e,t){var n=on.exec(e);if(null!==n){var i=parseFloat(n[1]),s=n[3],r=un[s];if(!r)throw s+" is not a valid unit.";return function(e,t){var n=new Date;if(R(r))n.setTime(n.getTime()+r*i);else{var s=r[0],a=r[1];n[a](n[s]()+i)}return n.getTime()}}})-1,an.Expression.today=an.Expressions.push(function(e,t){return"today"===e?function(e,t){var n=new Date;return At(n),n.getTime()}:void 0})-1,an.Expression.tomorrow=an.Expressions.push(function(e,t){return"tomorrow"===e?function(e,t){var n=new Date;return n.setDate(n.getDate()+1),At(n),n.getTime()}:void 0})-1,an.Expression.yesterday=an.Expressions.push(function(e,t){return"yesterday"===e?function(e,t){var n=new Date;return n.setDate(n.getDate()-1),At(n),n.getTime()}:void 0})-1,an.Rules.abs=function(e,t,n,i,s){return function(e,t,n){return e=yt(e),R(e)&&(e=Math.abs(e)),e}},an.Rules.apply=function(e,t,n,i,s){return function(t,n,i){return n.$set(e,t),t}},an.Rules.base64=function(t,n,i,s,r){return function(t,n,i){return e.btoa&&(t=e.btoa(t)),t}},an.Rules.ceil=function(e,t,n,i,s){return function(e,t,n){return e=yt(e),R(e)&&(e=Math.ceil(e)),e}},an.Rules.endOfDay=function(e,t,n,i,s){return function(e,t,n){return Mt(e)}},an.Rules.filter=function(e,t,n,i,s){return function(e,t,n){if(A(e))for(var i=e.length-1;i>=0;i--)O(e[i])||e.splice(i,1);else if(M(e))for(var s in e)O(e[s])||delete e[s];return e}},an.Rules.floor=function(e,t,n,i,s){return function(e,t,n){return e=yt(e),R(e)&&(e=Math.floor(e)),e}},an.Rules.mod=function(e,t,n,i,s){var r=yt(t);if(!R(r))throw'"'+r+'" is not a valid number for the mod rule.';return function(e,t,n){return e=yt(e),R(e)&&(e%=r),e}},an.Rules["null"]=function(e,t,n,i,s){return function(t,n,i){return n.$set(e,null),null}},an.Rules.round=function(e,t,n,i,s){return function(e,t,n){return e=yt(e),R(e)&&(e=Math.round(e)),e}},an.Rules.startOfDay=function(e,t,n,i,s){return function(e,t,n){return At(e)}},an.Rules.trim=function(e,t,n,i,s){if(!String.prototype.trim){var r=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(r,"")}}return function(e,t,n){return E(e)&&(e=e.trim()),e}},an.Rules.unbase64=function(t,n,i,s,r){return function(t,n,i){return e.atob&&(t=e.atob(t)),t}},e.Rekord=ve,ve.Model=Te,ve.Database=ye,ve.Relation=et,ve.Operation=Ge,ve.Search=Ve,ve.SearchPaged=Ye,ve.Promise=Ke,ve.Cascade=Bt,ve.Cache=jt,ve.Store=Jt,ve.Save=Wt,ve.Map=Ie,ve.Collection=Ce,ve.FilteredCollection=Pe,ve.ModelCollection=ke,ve.FilteredModelCollection=we,ve.Page=Ue,ve.HasOne=st,ve.BelongsTo=it,ve.HasMany=rt,ve.HasManyThrough=at,ve.HasRemote=ot,ve.isRekord=$,ve.isDefined=m,ve.isFunction=p,ve.isString=E,ve.isNumber=R,ve.isBoolean=b,ve.isDate=y,ve.isRegExp=S,ve.isArray=A,ve.isObject=M,ve.isValue=O,ve.noop=_,ve.bind=D,ve.uuid=L,ve.sizeof=T,ve.isEmpty=F,ve.evaluate=I,ve.toArray=n,ve.indexOf=i,ve.collect=s,ve.swap=r,ve.reverse=a,ve.isSorted=o,ve.isPrimitiveArray=u,ve.extend=l,ve.extendArray=h,ve.addMethod=Kt,ve.addMethods=d,ve.replaceMethod=f,ve.copyConstructor=v,ve.factory=g,ve.Comparators=Gt,ve.saveComparator=C,ve.addComparator=U,ve.createComparator=P,ve.equalsStrict=k,ve.equalsCompare=w,ve.equals=H,ve.compareNumbers=x,ve.compare=V,ve.addEventFunction=Y,ve.addEventful=K,ve.applyOptions=G,ve.propsMatch=z,ve.hasFields=q,ve.grab=Q,ve.pull=B,ve.transfer=j,ve.collapse=J,ve.clean=W,ve.cleanFunctions=Z,ve.copy=X,ve.diff=ee,ve.parse=te,ve.format=ne,ve.createFormatter=ie,ve.parseDate=se,ve.NumberResolvers=zt,ve.saveNumberResolver=re,ve.createNumberResolver=ae,ve.PropertyResolvers=qt,ve.savePropertyResolver=oe,ve.createPropertyResolver=ue,ve.toCamelCase=he,ve.Wheres=Qt,ve.saveWhere=de,ve.createWhere=fe}(this);
//# sourceMappingURL=rekord.min.js.map
