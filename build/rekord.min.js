/* rekord 1.5.8 - A javascript REST ORM that is offline and real-time capable http://rekord.github.io/rekord/ by Philip Diffenderfer */
!function(e,t){"function"==typeof define&&define.amd?define("rekord",[],function(){return t(e)}):"object"==typeof module&&module.exports?module.exports=t(global):e.Rekord=t(e)}(this,function(e,t){function n(e,t){return e instanceof Array?e:f(e)?e.split(t):R(e)?[e]:[]}function i(e,t,n){for(var i=n||C,s=0,r=e.length;r>s;s++)if(i(e[s],t))return s;return!1}function s(e){var t=arguments.length>1||!E(e)?Array.prototype.slice.call(arguments):e;return Xe.create(t)}function r(e){var t=arguments.length>1||!E(e)?Array.prototype.slice.call(arguments):e;return Xe["native"](t)}function a(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function o(e){for(var t=e.length,n=Math.floor(t/2),i=0;n>i;i++)a(e,t-i-1,i);return e}function u(e,t){if(!e)return!0;for(var n=0,i=t.length-1;i>n;n++)if(e(t[n],t[n+1])>0)return!1;return!0}function h(e){for(var t=0;t<e.length;t++){var n=e[t];if(R(n))return!y(n)}return!0}function l(e){return e!==t}function c(e){return!!(e&&e.constructor&&e.call&&e.apply)}function d(e){return!!(e&&e.Database&&c(e)&&e.prototype instanceof Ye)}function f(e){return"string"==typeof e}function v(e){return"number"==typeof e&&!isNaN(e)}function g(e){return"boolean"==typeof e}function p(e){return e instanceof Date}function m(e){return e instanceof RegExp}function E(e){return e instanceof Array}function y(e){return null!==e&&"object"==typeof e}function R(e){return!(e===t||null===e)}function $(){}function b(e,t){return function(){return t.apply(e,arguments)}}function S(){return A()+A()+"-"+A()+"-"+A()+"-"+A()+"-"+A()+A()+A()}function A(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function O(e){if(E(e)||f(e))return e.length;if(y(e)){var t=0;for(var n in e)t++;return t}return v(e)?e:0}function M(e){if(null===e||e===t||0===e)return!0;if(E(e)||f(e))return 0===e.length;if(p(e))return 0===e.getTime()||isNaN(e.getTime());if(y(e)){for(var n in e)return!1;return!0}return!1}function _(e,t,n){return R(e)?d(e)?new e:c(e)?n?e.apply(n):e():t?e:Z(e):e}function D(e,t){return t?Se.on(Se.Events.Options,e):Se.on(Se.Events.Plugins,e)}function T(e,t,n){var i=N(t,n);return Wt[e]=i,i}function L(e,t,n){var i=N(t,n);return c(e)?function(t,n){var s=i(t,n);return 0!==s?s:e(t,n)}:i}function N(e,t){if(c(e))return e;if(f(e)){if(e in Wt)return Wt[e];if("-"===e.charAt(0)){var n=N(e.substring(1),!t);return function(e,t){return-n(e,t)}}if(se(e)){var i=ae(e);return function(e,t){var n=i(e),s=i(t);return n.localeCompare(s)}}if(te(e)){var s=ie(e);return function(e,n){var i=s(e),r=s(n);return U(i,r,t)}}return function(n,i){var s=R(n)?n[e]:n,r=R(i)?i[e]:i;return U(s,r,t)}}if(E(e)){for(var r=[],a=0;a<e.length;a++)r[a]=N(e[a],t);return function(e,t){for(var n=0,i=0;i<r.length&&0===n;i++)n=r[i](e,t);return n}}return null}function C(e,t){return e===t}function I(e,t){return e==t}function F(e,t){return 0===U(e,t)}function k(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,i=typeof t,s=m(e),r=m(t);if("string"===n&&r)return t.test(e);if("string"===i&&s)return e.test(t);if(n!==i)return!1;var a=E(e),o=E(t);if(a!==o)return!1;if(a){if(e.length!==t.length)return!1;for(var u=0;u<e.length;u++)if(!k(e[u],t[u]))return!1;return!0}if(p(e))return p(t)&&k(e.getTime(),t.getTime());if(s)return r&&e.toString()===t.toString();if("object"===n){for(var h in e)if(!("$"===h.charAt(0)||c(e[h])||h in t&&k(e[h],t[h])))return!1;for(var l in t)if(!("$"===l.charAt(0)||c(t[l])||l in e))return!1;return!0}return!1}function H(e,t){return e===t?0:t>e?-1:1}function U(e,t,n){if(e==t)return 0;var i=R(e),s=R(t);return i!==s?i&&!n||s&&n?-1:1:(p(e)&&(e=e.getTime()),p(t)&&(t=t.getTime()),v(e)&&v(t)?H(e,t):E(e)&&E(t)?H(e.length,t.length):g(e)&&g(t)?e?-1:1:(e+"").localeCompare(t+""))}function x(e,t,n,i){var s=i?"$on":"on",r=i?"$off":"off",a=function(e,t){function i(){var n=e.apply(t||o,arguments);n===!1&&a()}function a(){u||(o[r](n,i),u=!0)}var o=this,u=!1;return o[s](n,i),a};e.$methods?Bt.method(e,t,a):Bt.prop(e,t,a)}function P(e,t,n,i,s){this.next=e?e:this,this.prev=e?e.prev:this,e&&(e.prev.next=this,e.prev=this),this.callback=t,this.context=n,this.type=i,this.group=s||0}function w(e,t){function i(e,t,i,s,r){if(!c(i))return $;var a=s||e,o=n(t," "),u=e.$$on;u||Bt.prop(e,"$$on",u={});for(var h=[],l=0;l<o.length;l++){var d=o[l],f=u[d];f||(f=u[d]=new P),h.push(new P(f,i,a,r,v))}return function(){for(var e=0;e<h.length;e++)h[e].remove();h.length=0}}function s(e,t,n){return i(this,e,t,n,P.Types.Persistent)}function r(e,t,n){return i(this,e,t,n,P.Types.Once)}function a(e,t,n){return i(this,e,t,n,P.Types.After)}function o(e,t,n){if(e&&t in e)for(var i,s=e[t],r=s.next;r!==s;)i=r.next,r.callback===n&&r.remove(),r=i}function u(e,t){e&&t in e&&delete e[t]}function h(e,t){if(l(e)){var i=n(e," ");if(c(t))for(var s=0;s<i.length;s++)o(this.$$on,i[s],t);else for(var s=0;s<i.length;s++)u(this.$$on,i[s])}else u(this,"$$on");return this}function d(e,t,n){if(e&&t in e){for(var i,s=e[t],r=++v,a=s.next;a!==s;)i=a.next,a.trigger(r,n,!1),a=i;for(a=s.next;a!==s;)i=a.next,a.trigger(r,n,!0),a=i}}function f(e,t){try{for(var i=n(e," "),s=0;s<i.length;s++)d(this.$$on,i[s],t)}catch(r){Se.trigger(Se.Events.Error,[r])}return this}var v=0,g=null;g=t?{$on:s,$once:r,$after:a,$off:h,$trigger:f}:{on:s,once:r,after:a,off:h,trigger:f},e.$methods?Bt.methods(e,g):Bt.props(e,g)}function K(e,t,n){if(y(e)&&y(t))for(var i in t)if(!n||!n[i]){var s=t[i];if(i in e){var r=e[i];E(r)?E(s)?r.push.apply(r,s):r.push(s):y(r)?K(r,s,n):e[i]=Z(s,!0)}else e[i]=Z(s,!0)}return e}function V(e,n,i,s){n=n||{};for(var r in i){var a=i[r],o=n[r],u=R(o);if(!u&&a===t)throw r+" is a required option";u?e[r]=o:e[r]=Z(a)}for(var h in n)h in i||(e[h]=n[h]);s?e.$options=n:e.options=n}function Y(e,t,n,i,s){var r=s||Se.equals;if(f(t))return r(e[t],n[i]);for(var a=0;a<t.length;a++){var o=t[a],u=i[a];if(!r(e[o],n[u]))return!1}return!0}function G(e,t,n){if(E(t)){for(var i=0;i<t.length;i++)if(!n(e[t[i]]))return!1;return!0}return n(e[t])}function z(e,t){var n=!1;if(E(t))for(var i=0;i<t.length;i++){var s=t[i];e[s]&&(e[s]=null,n=!0)}else e[t]&&(e[t]=null,n=!0);return n}function j(e,t,n,i){var s=!1;if(E(t))for(var r=0;r<t.length;r++){var a=t[r],o=e[a],u=i[r],h=n[u];k(o,h)||(e[a]=Z(h),s=!0)}else{var o=e[t],h=n[i];k(o,h)||(e[t]=Z(h),s=!0)}return s}function Q(e,t,n){for(var i={},s=0;s<t.length;s++){var r=t[s];r in e&&(i[r]=n?Z(e[r]):e[r])}return i}function q(e,t,n){if(f(t)){var i=e[t];return n?Z(i):i}for(var s=[],r=0;r<t.length;r++){var a=t[r],i=e[a];s.push(n?Z(i):i)}return s}function B(e,t){for(var n in e)t[n]=e[n];return t}function J(){for(var e={},t=0;t<arguments.length;t++){var n=arguments[t];if(y(n))for(var i in n)i in e||(e[i]=n[i])}return e}function W(e){for(var t in e)"$"===t.charAt(0)&&delete e[t];return e}function X(e){for(var t in e)c(e[t])&&delete e[t];return e}function Z(e,n){if(null===e||e===t||"object"!=typeof e||c(e)||m(e))return e;if(E(e)){for(var i=[],s=0;s<e.length;s++)i.push(Z(e[s],n));return i}if(p(e))return new Date(e.getTime());var i={};for(var r in e)(n||"$"!==r.charAt(0))&&(i[r]=Z(e[r],n));return i}function ee(e,t,n,i){for(var s={},r=0;r<n.length;r++){var a=n[r];i(e[a],t[a])||(s[a]=Z(e[a]))}return s}function te(e){return-1!==e.indexOf(".")||-1!==e.indexOf("[")||-1!==e.indexOf("(")}function ne(e,t){return ie(e)(t)}function ie(e){for(var n=ne.REGEX,i=[],s=null;null!==(s=n.exec(e));)i.push(s[1]);return function(e){for(var n=0;n<i.length&&e!==t;n++){var s=i[n];y(e)&&(e=_(e[s],!0,e))}return e}}function se(e){return-1!==e.indexOf("{")}function re(e,t){return ae(e)(t)}function ae(e){for(var t=e.split(re.REGEX),n=1;n<t.length;n+=2)t[n]=ie(t[n]);return function(e){for(var n="",i=0;i<t.length;i++)if(0===(1&i))n+=t[i];else{var s=t[i](e);n+=R(s)?s:""}return n}}function oe(e,t){return f(e)&&(Date.parse&&(e=Date.parse(e)),v(e)||(e=new Date(e))),v(e)&&(e=new Date(e)),p(e)&&v(e.getTime())?(t&&(e=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())),e):!1}function ue(e,t,n){var i=he(t,n);return Xt[e]=i,i}function he(e,t){var n=ce(e);return f(e)&&e in Xt?Xt[e]:function(e){var i=parseFloat(n(e));return isNaN(i)?t:i}}function le(e,t){var n=ce(t);return Zt[e]=n,n}function ce(e){if(c(e))return e;if(f(e))return e in Zt?Zt[e]:se(e)?ae(e):te(e)?ie(e):function(n){return n?n[e]:t};if(E(e))return function(t){return q(t,e)};if(y(e)){var n=[],i=[];for(var s in e)n.push(s),i.push(ce(e[s]));return function(e){for(var t={},s=0;s<n.length;s++){var r=n[s];t[r]=i[s](e[r])}return t}}return function(e){return e}}function de(e){return 1===e.length?e.toUpperCase():e.charAt(1).toUpperCase()}function fe(e){return e.replace(fe.REGEX,de)}function ve(e,t,n){for(var i=m(t)?t:new RegExp("("+t+")"),s=e.split(i),r=0,a=s.length-2;a>r;){var o=s[r],u=o.length-n.length;if(o.substring(u)===n){var h=s[r+1],l=s[r+2],c=o.substring(0,u)+h+l;s.splice(r,3,c),a-=2}else r+=1,s.splice(r,1),a-=1}return s}function ge(e,t,n,i){var s=pe(t,n,i);return nn[e]=s,s}function pe(e,t,n){var i=n||C;if(c(e))return e;if(E(e)){for(var s=[],r=0;r<e.length;r++){var a=e[r];s.push(E(a)?pe.apply(this,a):pe(a))}return function(e){for(var t=0;t<s.length;t++)if(!s[t](e))return!1;return!0}}if(y(e)){var o=[];for(var u in e)o.push({tester:ye(e[u],i),resolver:ce(u)});return function(e){for(var t=0;t<o.length;t++){var n=o[t];if(!n.tester(n.resolver(e)))return!1}return!0}}if(f(e)){if(e in nn)return nn[e];var h=ce(e);if(R(t)){var l=ye(t,i);return function(e){return l(h(e))}}return function(e){return R(h(e))}}return function(e){return!0}}function me(e){return e.expression=!0,e}function Ee(e,t,n){return Re(e)?e(t,n):n(e,t)}function ye(e,t){return Re(e)?function(n){return e(n,t)}:function(n){return t(e,n)}}function Re(e){return c(e)&&e.expression}function $e(e){return Re(e)?me(function(t,n){return!e(t,n)}):c(e)?function(t){return!e(t)}:me(function(t,n){return!n(t,e)})}function be(e){var t=E(e)?e:qt.slice.call(arguments);return me(function(e,n){for(var i=0;i<t.length;i++)if(Ee(t[i],e,n))return!0;return!1})}function Se(e){var t=Se.get(e.name);if(t.isComplete())return t.results[0];Se.trigger(Se.Events.Options,[e]);var n=new Fe(e),i=Bt.dynamic(Ye,new Ye(n),n.className,"(props, remoteData) { this.$init( props, remoteData ) }");return n.Model=i,i.Database=n,Se.classes[n.name]=i,Se.trigger(Se.Events.Plugins,[i,n,e]),Se.autoload?n.loadBegin(function(e){e&&n.loadFinish()}):Se.unloaded.push(n),Se.get(n.name).resolve(i),Se.get(n.className).resolve(i),Se.debug(Se.Debugs.CREATION,n,e),i}function Ae(e,t){return!v(e)||(e&t)===t}function Oe(e,t,i){for(var s=n(e,/\s*,\s/),r=n(t,/\s*,\s/),a=dn.push(i)-1,o=cn[a]=new Xe,u=0;u<s.length;u++){var h=s[u],l=_e(r,o);if(f(h))h in Se.classes?l(Se.classes[h]):Me(h,l);else if(d(h))l(h);else{if(h!==!0)throw h+" is not a valid input for batching";for(var c in Se.classes)l(Se.classes[c]);Se.on(Se.Events.Plugins,l)}}}function Me(e,t){var n=Se.on(Se.Events.Plugins,function(i,s){s.name===e&&(t(i),n())})}function _e(e,t){return function(n){for(var i=n.Database,s=i.rest,r=0;r<e.length;r++){var a=e[r];switch(fn.push(s,a,s[a]),a){case"all":s.all=function(e,s,r){t.push({database:i,"class":n,operation:"all",options:e,success:s,failure:r})};break;case"get":s.get=function(e,s,r,a){t.push({database:i,"class":n,operation:"get",options:s,success:r,failure:a,model:e})};break;case"create":s.create=function(e,s,r,a,o){t.push({database:i,"class":n,operation:"create",options:r,success:a,failure:o,model:e,encoded:s})};break;case"update":s.update=function(e,s,r,a,o){t.push({database:i,"class":n,operation:"update",options:r,success:a,failure:o,model:e,encoded:s})};break;case"remove":s.remove=function(e,s,r,a){t.push({database:i,"class":n,operation:"remove",options:s,success:r,failure:a,model:e})};break;case"query":s.query=function(e,s,r,a,o){t.push({database:i,"class":n,operation:"query",options:r,success:a,failure:o,url:e,encoded:s})};break;default:throw a+" is not a valid operation you can batch"}}}}function De(){for(var e=0;e<cn.length;e++){var t=cn[e],n=dn[e];t.length&&(n(t),t.clear())}}function Te(){ln++}function Le(){ln--,0===ln&&De()}function Ne(){for(var e=0;e<fn.length;e+=3){var t=fn[e+0],n=fn[e+1],i=fn[e+2];t[n]=i}cn.length=0,dn.length=0,fn.length=0}function Ce(e,t){try{Te(),e.apply(t)}catch(n){throw Se.trigger(Se.Events.Error,[n]),n}finally{Le()}}function Ie(e){var t=!1,n=[],i=function(){t?e.apply(this,arguments):n.push(this,qt.slice.apply(arguments))};return i.open=function(){if(!t){for(var i=0;i<n.length;i+=2){var s=n[i],r=n[i+1];e.apply(s,r)}n.length=0,t=!0}},i}function Fe(e){V(this,e,mn),this.keyHandler=E(this.key)?new We(this):new Je(this),this.keyHandler.addToFields(this.fields),this.modelsCached=this.models=tt.create(this),this.allCached=this.all={},this.loaded={},this.className=this.className||fe(this.name),this.initialized=!1,this.pendingRefresh=!1,this.localLoaded=!1,this.remoteLoaded=!1,this.firstRefresh=!1,this.pendingOperations=0,this.afterOnline=!1,this.saveFields=Z(this.fields),this.readyPromise=new ot(null,!1),this.context=null,this.contextIndex=-1,this.prepare(this,e),this.rest=this.createRest(this),this.store=this.createStore(this),this.live=this.createLive(this),this.setComparator(this.comparator,this.comparatorNullsFirst),this.setRevision(this.revision),this.setSummarize(this.summarize),this.relations={},this.relationNames=[];for(var t in e)if(t in Se.Relations){var n=Se.Relations[t];if(n.prototype instanceof Et){var i=e[t];for(var s in i){var r=i[s],a=new n;f(r)?r={model:r}:y(r)||(r={}),r.model||r.discriminator||(r.model=s),a.init(this,s,r),a.save&&this.saveFields.push(s),this.relations[s]=a,this.relationNames.push(s)}}}for(var o in this.projections)this.projections[o]=Qe.parse(this,o)}function ke(e,t,n){var i=this.encodings;for(var s in t)s in i&&(t[s]=i[s](t[s],e,s,n));return t}function He(e,t){var n=this.decodings,i=t||e;for(var s in e)s in n?i[s]=n[s](e[s],e,s):i[s]=e[s];return i}function Ue(e){return e.$key()}function xe(e){return e.rest===!1?Se.defaultRest(e):Se.rest(e)}function Pe(e){return e.store===!1?Se.defaultStore(e):Se.store(e)}function we(e){return e.live===!1?Se.defaultLive(e):Se.live(e)}function Ke(e){return e}function Ve(e){return e}function Ye(e){Bt.prop(this,"$db",e)}function Ge(e,t,n,i,s,r,a){var o=new ot(null,!1);if(Ae(t,rn.Rest))var u=e.$once(n,function(t){h(),l(),o.resolve(e,t)}),h=e.$once(i,function(t,n){u(),l(),o.reject(e,n,t)}),l=e.$once(s,function(){u(),h(),o.noline(e)});else if(Ae(t,rn.Local))var u=e.$once(r,function(t){h(),o.resolve(e,t)}),h=e.$once(a,function(t,n){u(),o.reject(e,t)});else o.resolve(e);return o}function ze(){this.values=[],this.keys=[],this.indices={}}function je(e){this.map={},this.listeners={},this.subject=e}function Qe(e,t){this.database=e,this.input=t,this.projections={};for(var n=0;n<t.length;n++)this.addProjection(t[n])}function qe(e){if(this.databases=[],this.alls=[],this.models=[],M(e))for(var t in Se.classes)this.add(t);else if(E(e))for(var n=0;n<e.length;n++)this.add(e[n])}function Be(){}function Je(e){this.init(e)}function We(e){this.init(e)}function Xe(e){this.addAll(e,!0)}function Ze(e,t,n){this.onChanges=b(this,this.handleChanges),this.pageSize=t,this.pageIndex=n||0,this.pageCount=0,this.setCollection(e)}function et(e,t){this.bind(),this.init(e,t)}function tt(e,t,n){this.init(e,t,n)}function nt(e,t){this.bind(),this.init(e,t)}function it(e,t,n,i,s){Bt.props(this,{model:t,relator:n}),this.init(e,i,s)}function st(e,t,n){Bt.props(e,{discriminator:t,discriminatorsToModel:n});var i=(e.buildKeyFromInput,e.parseModel,e.clone),s=e.cloneEmpty;return Bt.props(e,{buildKeyFromInput:function(e){if(y(e)){var t=e[this.discriminator],n=this.discriminatorsToModel[t];if(n)return n.Database.keyHandler.buildKeyFromInput(e)}return e},parseModel:function(e,t){if(e instanceof Ye)return e;var n=R(e)?e[this.discriminator]:null,i=this.discriminatorsToModel[n];return i?i.Database.parseModel(e,t):null},clone:function(){return st(i.apply(this),t,n)},cloneEmpty:function(){return st(s.apply(this),t,n)}}),e}function rt(e,t,n,i,s){this.$init(e,t,n,i,s)}function at(e,t,n,i,s){this.$init(e,t,n,i,s)}function ot(e,t){this.status=ot.Status.Pending,this.cancelable=t!==!1,this.nexts=[],Bt.prop(this,"results",null),c(e)&&e(b(this,this.resolve),b(this,this.reject),b(this,this.noline),b(this,this.cancel))}function ut(){}function ht(e,t,n){this.reset(e,t,n)}function lt(e,t,n){this.reset(e,t,n)}function ct(e,t){this.reset(e,t)}function dt(e,t){this.reset(e,t)}function ft(e,t){this.reset(e,t)}function vt(e,t,n){this.reset(e,t,n)}function gt(e,t,n){this.reset(e,t,n)}function pt(e,t){this.reset(e,t)}function mt(e,t,n){this.reset(e,t,n)}function Et(){}function yt(){}function Rt(){}function $t(){}function bt(){}function St(){}function At(){}function Ot(){}function Mt(){}function _t(){}function Dt(e){this.database=e}function Tt(e,t,n){var i=c(n)?n:y(n)&&c(n.get)?n.get:$,s=y(n)&&c(n.set)?n.set:$;if(Object.defineProperty)Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i,set:s});else{var r=e.$init;e.$init=function(){r.apply(this,arguments);var e=this[t]=i.apply(this),n=function(){var n=this[t];n!==e?s.call(this,n):e=this[t]=i.apply(this)};this.$after(Ye.Events.Changes,n,this)}}}function Lt(e,t,n,i){var s={on:n?"$on":"on",once:n?"$once":"once",after:n?"$after":"after"},r=i||[];if(c(t))r.push({when:s.on,events:e,invoke:t});else if(E(t)&&2===t.length&&c(t[0]))r.push({when:s.on,events:e,invoke:t[0],context:t[1]});else if(y(t))for(var a in t)if(a in s){var o=t[a],u=s[a];c(o)?r.push({when:u,events:e,invoke:o}):E(o)&&2===o.length&&c(o[0])&&r.push({when:u,events:e,invoke:o[0],context:o[1]})}return r}function Nt(e,t){for(var n=0;n<t.length;n++){var i=t[n];e[i.when](i.events,i.invoke,i.context)}}function Ct(){return Qt.File&&Qt.FileReader&&Qt.FileList}function It(e){return e instanceof Qt.File?e:e instanceof Qt.Blob?e:e instanceof Qt.FileList&&e.length>0?e[0]:!1}function Ft(e){return e}function kt(e){var t=f(e)?e.indexOf(";base64,"):-1;return-1===t?e:e.substring(t+8)}function Ht(e,t){t.autoSave&&e.$isSaved()&&e.$save()}function Ut(e,t,n,i,s){e.$files=e.$files||{},e.$files[t]={value:n,user:n,file:i,options:s}}function xt(e,t,n,i,s){var r,a=!1;return e&&e.valueToUser?e.valueToUser(t,n,i,function(e){n.$files[i].user=e,a?(n[i]=e,Ht(n,s)):r=e}):r=t,a=!0,r}function Pt(e,t,n){var i=Se.fileProcessors[n.processor];return e in Qt.FileReader.prototype||Se.trigger(Se.Events.FilesNotSupported),function(s,r,a){var o=It(s);if(o!==!1){var u,h=new Qt.FileReader,l=!1;return h.onload=function(e){var s=t(e.target.result);Ut(r,a,s,o,n),u=xt(i,s,r,a,n),l&&(r[a]=u,Ht(r,n))},h[e](o),l=!0,u}if(y(s)&&s.FILE){var u,c=function(e){u=e};return Se.trigger(Se.Events.FileOffline,[s,r,a,c]),u}return Ut(r,a,s,null,n),xt(i,s,r,a,n)}}function wt(e,t,n,i){if(t.$files&&n in t.$files){var s=t.$files[n];if(i&&s.save===!1||!i&&s.store===!1)return;if(!i&&s.file){var r=Q(s.file,Se.fileProperties,!1);return r.FILE=!0,r}if(e===s.user)return i&&s.file&&t.$once(Ye.Events.RemoteSave,function(){delete s.file,t.$addOperation(gt,rn.Local)}),s.value}return e}function Kt(e){return function(t,n,i){var s=e.indices[n];if(v(s)){var r=e.listeners[n];delete e.indices[n],delete e.listeners[n],e.keys[s]=i,e.indices[i]=s,e.listeners[i]=r}}}function Vt(e,t){return $n.apply(this,arguments),t instanceof Ye&&t.$db.keyChanges&&(this.listeners=this.listeners||{},this.listeners[e]=t.$on(Ye.Events.KeyChange,Kt(this))),this}function Yt(e){var t=this.indices[e];return v(t)&&(this.listeners&&(_(this.listeners[e]),delete this.listeners[e]),this.removeAt(t)),this}function Gt(){Bt.method(ze,"put",Vt),Bt.method(ze,"remove",Yt)}function zt(){Bt.method(ze,"put",$n),Bt.method(ze,"remove",bn)}function jt(e,t,n){var i=oe(e,n);if(i===!1)return!1;if(!t)return i;switch(t){case Sn.Date:return i;case Sn.Millis:return i.getTime();case Sn.Seconds:return Math.floor(i.getTime()/1e3);default:return Se.formatDate(i,t)}}var Qt="undefined"!=typeof window?window:e,qt=Array.prototype,Bt={create:function(e,t){Bt.prop(e,"create",Bt.factory(e)),Bt.build(e,t,$)},extend:function(e,t,n){var i=J(n,e.$methods),s=Bt.copyConstructor(e);t.prototype=new s;var r=Bt.factory(t);if(Bt.isArray(e)){var a=function(){var e=[];return Bt.props(e,i),t.apply(e,arguments),e};Bt.prop(t,"native",a),Bt.prop(t,"create",en.nativeArray?a:r)}else Bt.prop(t,"create",r);Bt.build(t,i,e)},dynamic:function(e,t,n,i){var s=new Function("return function "+n+i)();return s.prototype=t,Bt.build(s,{},e),s},build:function(e,t,n){Bt.prop(e,"$methods",t),Bt.prop(e,"$prop",Bt.propThis),Bt.prop(e,"$method",Bt.methodThis),Bt.prop(e,"$replace",Bt.replaceThis),Bt.prop(e.prototype,"$super",n),Bt.prop(e.prototype,"constructor",e),Bt.props(e.prototype,t)},isArray:function(e){return Array===e||e.prototype instanceof Array},method:function(e,t,n){e.$methods&&(e.$methods[t]=n),Bt.prop(e.prototype,t,n)},methodThis:function(e,t){Bt.method(this,e,t)},methods:function(e,t){for(var n in t)Bt.method(e,n,t[n])},prop:function(){return Object.defineProperty?function(e,t,n){Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:!0,value:n})}:function(e,t,n){e[t]=n}}(),propThis:function(e,t){Bt.prop(this.prototype,e,t)},props:function(e,t){for(var n in t)Bt.prop(e,n,t[n])},replace:function(e,t,n){var i=e.prototype[t]||e[t]||$;Bt.method(e,t,n(i))},replaceThis:function(e,t){Bt.replace(this,e,t)},copyConstructor:function(e){function t(){}return t.prototype=e.prototype,t},factory:function(e){function t(t){e.apply(this,t)}return t.prototype=e.prototype,function(){return new t(arguments)}}},Jt=Date.now||function(){return(new Date).getTime()},Wt={};P.Types={Persistent:1,Once:2,After:4},Bt.create(P,{remove:function(){var e=this.next,t=this.prev;e!==this&&(t.next=e,e.prev=t,this.next=this.prev=this)},hasType:function(e){return 0!==(this.type&e)},trigger:function(e,t,n){var i=(this.type,this.hasType(P.Types.After));this.group!==e&&((n&&i||!i)&&(this.group=e,this.callback.apply(this.context,t)),this.hasType(P.Types.Once)&&this.remove())}}),ne.REGEX=/([\w$]+)/g,re.REGEX=/[\{\}]/;var Xt={},Zt={},en=e.RekordSettings||Qt.RekordSettings||{};if(Qt.document&&Qt.document.currentScript){var tn=Qt.document.currentScript;null!==tn.getAttribute("native-array")&&(en.nativeArray=!0)}fe.REGEX=/(^.|_.)/g;var nn={};Se.classes={},Se.autoload=!1,Se.unloaded=[],Se.loadPromise=null,Se.load=function(e,t){function n(e,t){if(a.push(e),r.push(t),r.length===s.length){for(var n=0;n<r.length;n++){var t=r[n],e=a[n];e&&t.loadFinish()}i.reset().resolve()}}var i=Se.loadPromise=Se.loadPromise||new ot(null,!1),s=Se.unloaded.slice(),r=[],a=[];i.success(e,t||this),Se.unloaded.length=0;for(var o=0;o<s.length;o++)s[o].loadBegin(n);return i},Se.promises={},Se.get=function(e){var t=Se.promises[e];return t||(t=Se.promises[e]=new ot(null,!1)),t},Se["export"]=function(){var e=Se.classes;for(var t in e)Qt[t]=e[t]},Se.clear=function(e){var t=Se.classes;for(var n in t)t[n].clear(e)},Se.reset=function(e,t){var n=Se.classes;if(e)for(var i in n){var s=n[i].Database;if(s.hasPending())return ot.reject(s)}return ot.singularity(this,function(){for(var e in n){var i=n[e].Database;i.reset(!1,t)}})},Se.unload=function(e,t,n,s){var r=Se.classes,a=Se.promises;if(n)for(var o in r){var u=r[o].Database,h=!E(e)||i(e,o)!==!1;if(h&&u.hasPending())return ot.reject(u)}return ot.singularity(this,function(){for(var n in r){var o=r[n].Database,u=!E(e)||i(e,n)!==!1;u&&(t&&o.reset(!1,s),delete r[n],delete a[o.name],delete a[o.className])}})},w(Se),Se.Events={Initialized:"initialized",Plugins:"plugins",Options:"options",Online:"online",Offline:"offline",Error:"error"};var sn={None:"none",Pending:"pending",All:"all"},rn={None:0,Local:1,Rest:2,NoLive:3,Live:4,NoRest:5,Remote:6,All:7},an={None:0,All:1,Lazy:2,Both:3},on={Conflict:{409:!0},NotFound:{404:!0,410:!0},Offline:{0:!0}},un={None:0,Model:4,Key:5,Keys:6},hn={None:0,Model:1,Key:2,Keys:3},ln=0,cn=[],dn=[],fn=[];Se.batch=Oe,Se.batchRun=De,Se.batchStart=Te,Se.batchEnd=Le,Se.batchClear=Ne,Se.batchExecute=Ce,Se.batchDepth=function(){return ln},Se.debug=function(e,t){},Se.setDebug=function(e,t){Se.debugSet&&!t||(Se.debug=e,Se.debugSet=!0)},Se.Debugs={CREATION:0,REST:1,AUTO_REFRESH:73,MISSING_KEY:33,REMOTE_UPDATE:2,REMOTE_CREATE:3,REMOTE_REMOVE:4,REMOTE_LOAD:5,REMOTE_LOAD_OFFLINE:6,REMOTE_LOAD_ERROR:7,REMOTE_LOAD_REMOVE:8,REMOTE_LOAD_RESUME:22,LOCAL_LOAD:9,LOCAL_RESUME_DELETE:10,LOCAL_RESUME_SAVE:11,LOCAL_LOAD_SAVED:12,REALTIME_SAVE:13,REALTIME_REMOVE:14,SAVE_VALUES:15,SAVE_PUBLISH:16,SAVE_CONFLICT:17,SAVE_UPDATE_FAIL:18,SAVE_ERROR:19,SAVE_OFFLINE:20,SAVE_RESUME:21,SAVE_REMOTE:25,SAVE_DELETED:40,SAVE_OLD_REVISION:48,SAVE_LOCAL:23,SAVE_LOCAL_ERROR:24,SAVE_LOCAL_DELETED:38,SAVE_LOCAL_BLOCKED:39,SAVE_REMOTE_DELETED:41,SAVE_REMOTE_BLOCKED:42,REMOVE_PUBLISH:26,REMOVE_LOCAL:27,REMOVE_MISSING:28,REMOVE_ERROR:29,REMOVE_OFFLINE:30,REMOVE_RESUME:31,REMOVE_REMOTE:32,REMOVE_CANCEL_SAVE:47,REMOVE_LOCAL_ERROR:34,REMOVE_LOCAL_BLOCKED:44,REMOVE_LOCAL_NONE:45,REMOVE_LOCAL_UNSAVED:46,REMOVE_REMOTE_BLOCKED:43,GET_LOCAL_SKIPPED:104,GET_LOCAL:105,GET_LOCAL_ERROR:106,GET_REMOTE:107,GET_REMOTE_ERROR:108,ONLINE:35,OFFLINE:36,PUBSUB_CREATED:37,HASONE_INIT:53,HASONE_NINJA_REMOVE:49,HASONE_INITIAL_PULLED:51,HASONE_INITIAL:52,HASONE_CLEAR_MODEL:54,HASONE_SET_MODEL:55,HASONE_PRESAVE:56,HASONE_POSTREMOVE:57,HASONE_CLEAR_KEY:58,HASONE_UPDATE_KEY:59,HASONE_LOADED:60,HASONE_QUERY:111,HASONE_QUERY_RESULTS:112,BELONGSTO_INIT:61,BELONGSTO_NINJA_REMOVE:62,BELONGSTO_NINJA_SAVE:63,BELONGSTO_INITIAL_PULLED:64,BELONGSTO_INITIAL:65,BELONGSTO_CLEAR_MODEL:66,BELONGSTO_SET_MODEL:67,BELONGSTO_POSTREMOVE:69,BELONGSTO_CLEAR_KEY:70,BELONGSTO_UPDATE_KEY:71,BELONGSTO_LOADED:72,BELONGSTO_QUERY:113,BELONGSTO_QUERY_RESULTS:114,HASREFERENCE_INIT:131,HASREFERENCE_NINJA_REMOVE:132,HASREFERENCE_INITIAL_PULLED:133,HASREFERENCE_INITIAL:134,HASREFERENCE_CLEAR_MODEL:135,HASREFERENCE_SET_MODEL:136,HASREFERENCE_CLEAR_KEY:137,HASREFERENCE_UPDATE_KEY:138,HASREFERENCE_LOADED:139,HASREFERENCE_QUERY:140,HASREFERENCE_QUERY_RESULTS:141,HASMANY_INIT:74,HASMANY_NINJA_REMOVE:75,HASMANY_NINJA_SAVE:76,HASMANY_INITIAL:77,HASMANY_INITIAL_PULLED:78,HASMANY_REMOVE:79,HASMANY_SORT:80,HASMANY_ADD:81,HASMANY_LAZY_LOAD:82,HASMANY_INITIAL_GRABBED:83,HASMANY_NINJA_ADD:84,HASMANY_AUTO_SAVE:85,HASMANY_PREREMOVE:86,HASMANY_POSTSAVE:87,HASMANY_QUERY:115,HASMANY_QUERY_RESULTS:116,HASMANY_UPDATE_KEY:129,HASMANYTHRU_INIT:88,HASMANYTHRU_NINJA_REMOVE:89,HASMANYTHRU_NINJA_SAVE:90,HASMANYTHRU_NINJA_THRU_REMOVE:91,HASMANYTHRU_INITIAL:92,HASMANYTHRU_INITIAL_PULLED:93,HASMANYTHRU_REMOVE:94,HASMANYTHRU_SORT:95,HASMANYTHRU_ADD:96,HASMANYTHRU_LAZY_LOAD:97,HASMANYTHRU_INITIAL_GRABBED:98,HASMANYTHRU_NINJA_ADD:99,HASMANYTHRU_AUTO_SAVE:100,HASMANYTHRU_PREREMOVE:101,HASMANYTHRU_POSTSAVE:102,HASMANYTHRU_THRU_ADD:103,HASMANYTHRU_THRU_REMOVE:68,HASMANYTHRU_QUERY:117,HASMANYTHRU_QUERY_RESULTS:118,HASMANYTHRU_UPDATE_KEY:130,HASREMOTE_INIT:50,HASREMOTE_SORT:121,HASREMOTE_NINJA_REMOVE:109,HASREMOTE_NINJA_SAVE:110,HASREMOTE_QUERY:119,HASREMOTE_QUERY_RESULTS:120,HASLIST_INIT:122,HASLIST_SORT:123,HASLIST_NINJA_REMOVE:124,HASLIST_NINJA_SAVE:125,HASLIST_REMOVE:126,HASLIST_ADD:127,HASLIST_INITIAL:128};var vn={};vn.Default=Se.defaultLive=Se.live=function(e){return{save:function(e,t){},remove:function(e){}}},Se.setLive=function(e,t){Se.liveSet&&!t||(Se.live=e,Se.liveSet=!0)},Se.isOnline=function(){return!Qt.navigator||Qt.navigator.onLine!==!1},Se.online=Se.isOnline(),Se.forceOffline=!1,Se.setOnline=function(){Se.online=!0,Se.debug(Se.Debugs.ONLINE),Ce(function(){Se.trigger(Se.Events.Online)})},Se.setOffline=function(){Se.online=!1,Se.debug(Se.Debugs.OFFLINE),Se.trigger(Se.Events.Offline)},Se.listenToNetworkStatus=function(){Qt.addEventListener?(Qt.addEventListener(Se.Events.Online,Se.setOnline,!1),Qt.addEventListener(Se.Events.Offline,Se.setOffline,!1)):(Qt.document.body.ononline=Se.setOnline,Qt.document.body.onoffline=Se.setOffline)},Se.checkNetworkStatus=function(){var e=Se.isOnline();Se.forceOffline&&(e=!1),e===!0&&Se.online===!1?Se.setOnline():e===!1&&Se.online===!0&&Se.setOffline()};var gn={};gn.Default=Se.defaultRest=Se.rest=function(e){return{all:function(e,t,n){t([])},get:function(e,t,n,i){i(null,-1)},create:function(e,t,n,i,s){i({})},update:function(e,t,n,i,s){i({})},remove:function(e,t,n,i){n({})},query:function(e,t,n,i,s){i([])}}},Se.setRest=function(e,t){Se.restSet&&!t||(Se.rest=e,Se.restSet=!0)};var pn={};pn.Default=Se.defaultStore=Se.store=function(e){return{put:function(e,t,n,i){n(e,t)},get:function(e,n,i){i(e,t)},remove:function(e,t,n){t(e)},all:function(e,t){e([],[])},reset:function(e,t,n,i){n(e,t)}}},Se.setStore=function(e,t){Se.storeSet&&!t||(Se.store=e,Se.storeSet=!0)},Fe.Events={NoLoad:"no-load",RemoteLoad:"remote-load",LocalLoad:"local-load",Updated:"updated",ModelAdded:"model-added",ModelUpdated:"model-updated",ModelRemoved:"model-removed",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",Loads:"no-load remote-load local-load",Changes:"updated"};var mn=Fe.Defaults={name:t,className:null,key:"id",keySeparator:"/",fields:[],ignoredFields:{},defaults:{},publishAlways:[],saveAlways:[],comparator:null,comparatorNullsFirst:null,revision:null,traits:[],cascade:rn.All,load:an.None,allComplete:!1,loadRelations:!0,autoRefresh:!0,cache:sn.All,fullSave:!1,fullPublish:!1,noReferences:!1,encodings:{},decodings:{},projections:{},allOptions:null,fetchOptions:null,getOptions:null,updateOptions:null,createOptions:null,saveOptions:null,removeOptions:null,queryOptions:null,prune:{active:!1,max:0,keepAlive:0,removeLocal:!1},prepare:$,encode:ke,decode:He,resolveModel:Ke,resolveModels:Ve,summarize:Ue,createRest:xe,createStore:Pe,createLive:we};Bt.create(Fe,{setStoreEnabled:function(e){e?this.storeDisabled&&(this.store=this.storeDisabled,this.storeDisabled=!1):this.storeDisabled||(this.storeDisabled=this.store,this.store=Se.defaultStore(this))},setRestEnabled:function(e){e?this.restDisabled&&(this.rest=this.restDisabled,this.restDisabled=!1):this.restDisabled||(this.restDisabled=this.rest,this.rest=Se.defaultRest(this))},setLiveEnabled:function(e){e?this.liveDisabled&&(this.live=this.liveDisabled,this.liveDisabled=!1):this.liveDisabled||(this.liveDisabled=this.live,this.live=Se.defaultLive(this))},ready:function(e,t,n){return this.readyPromise.success(e,t,n)},clearAll:function(){var e=this;e.context?e.context.clear(this):e.allCached=e.all={}},clear:function(e){var t=this;return t.clearAll(),t.models.clear(),e&&t.off(),t},hasPending:function(){return this.models.contains(function(e){return e.$isPending()})},reset:function(e,t){var n=this,i=new ot;return e&&n.hasPending()?i.reject(n):(n.clear(t),n.store.reset([],[],function(){i.resolve(n)},function(){i.reject(n)})),i},hasData:function(e){if(!y(e))return!1;for(var t in e)if(!this.ignoredFields[t])return!0;return!1},grabModel:function(e,t,n,i){function s(){var t=r.parseModel(e,i);if(t!==!1&&!a.isComplete()&&r.initialized){var n=r.remoteLoaded||!r.hasLoad(an.All),s=null===t||!t.$isSaved(),o=r.hasLoad(an.Lazy);o&&n&&s?(t||(t=r.keyHandler.buildObjectFromKey(r.keyHandler.buildKeyFromInput(e))),t.$once(Ye.Events.RemoteGets,function(){a.isComplete()||(y(e)&&t.$set(e),a.resolve(t.$isSaved()?t:null))}),t.$refresh(rn.All,r.fetchOptions)):a.resolve(t)}return!a.isComplete()}var r=this,a=new ot;return a.success(t,n||r),s()&&r.ready(s,r,!0),a},parseModel:function(e,t){var n=this,i=n.keyHandler,s=n.remoteLoaded||!n.hasLoad(an.All);if(!R(e))return s?null:!1;d(e)&&(e=new e),c(e)&&(e=e());var r=i.buildKeyFromInput(e);if(e instanceof n.Model)return e;if(r in n.all){var a=n.all[r];return y(e)&&(i.buildKeyFromRelations(e),t?n.putRemoteData(e,r,a):a.$set(e)),a}return y(e)?(i.buildKeyFromRelations(e),t?n.putRemoteData(e):n.instantiate(n.decode(e))):s?null:!1},updated:function(){this.sort(),this.trigger(Fe.Events.Updated)},setRevision:function(e){c(e)?this.revisionFunction=e:f(e)?this.revisionFunction=function(n,i){var s=y(n)&&e in n?n[e]:t,r=y(i)&&e in i?i[e]:t;return s===t||r===t?!1:U(s,r)>0}:this.revisionFunction=function(e,t){return!1}},setComparator:function(e,t){this.models.setComparator(e,t)},addComparator:function(e,t){this.models.addComparator(e,t);
},setSummarize:function(e){c(e)?this.summarize=e:f(e)?i(this.fields,e)!==!1?this.summarize=function(t){return R(t)?t[e]:t}:this.summarize=ae(e):this.summarize=function(e){return e.$key()}},sort:function(){this.models.sort()},isSorted:function(){return this.models.isSorted()},clean:function(){var e=this,t=e.models.keys,n=e.models;e.clearAll();for(var i=0;i<t.length;i++)e.addReference(n[i],t[i])},putRemoteData:function(e,t,n,i){if(!y(e))return n;var s=this,t=t||s.keyHandler.getKey(e,!0);if(!R(t))return void Se.debug(Se.Debugs.MISSING_KEY,s,e);var n=n||s.all[t],r=s.decode(Z(e));if(n){var a=this.revisionFunction(n,e);if(a)return Se.debug(Se.Debugs.SAVE_OLD_REVISION,s,n,e),n}if(n){s.keyHandler.hasKeyChange(n,r)&&(t=n.$setKey(s.keyHandler.getKey(r,!0))),s.addReference(n,t),n.$saved||(n.$saved={});var o=n,u={},h=!1,l={},c={},d={},f=M(n.$saved),v=s.relations,g=s.decode(n.$saved);for(var p in e)if("$"!==p.charAt(0))if(p in v)n.$set(p,e[p],!0);else{var m=o[p],E=g[p];c[p]=n[p],d[p]=E,f||i||k(m,E)?(n[p]=r[p],l[p]=e[p],n.$local&&(n.$local[p]=e[p])):(u[p]=e[p],h=!0),n.$saved[p]=Z(e[p])}h?n.$trigger(Ye.Events.PartialUpdate,[e,l,c,d,u]):n.$trigger(Ye.Events.FullUpdate,[e,l,c,d,u]),n.$trigger(Ye.Events.RemoteUpdate,[e,l,c,d,u]),n.$addOperation(pt),s.models.has(t)||(s.saveReference(n,t),s.trigger(Fe.Events.ModelAdded,[n,!0]))}else n=s.createModel(r,!0),n&&(s.cache===sn.All?(n.$local=n.$toJSON(!1),n.$local.$status=n.$status,n.$saved=n.$local.$saved=n.$toJSON(!0),n.$addOperation(pt)):n.$saved=n.$toJSON(!0));return n},createModel:function(e,t){var n=this,i=n.instantiate(e,t);if(i.$invalid===!0)return void Se.debug(Se.Debugs.MISSING_KEY,n,e);var s=i.$key();return n.models.has(s)||(n.saveReference(i,s),n.trigger(Fe.Events.ModelAdded,[i,t])),i},destroyModel:function(e,t){this.pruneModel(e,t),e.$trigger(Ye.Events.RemoteAndRemove),Se.debug(Se.Debugs.REMOTE_REMOVE,this,e)},pruneModel:function(e,t){var n=this,i=t||e.$key();n.removeReference(i),n.models.remove(i),n.trigger(Fe.Events.ModelRemoved,[e])},removeReference:function(e){delete this.all[e]},hasPruning:function(){return this.prune.max||this.prune.keepAlive},pruneModels:function(){var e=this,t=e.prune,n=e.models;if((t.max||t.keepAlive)&&t.active){for(var i=Jt()-t.keepAlive,s=function(n){t.removeLocal?n.$remove(rn.Local):e.pruneModel(n)},r=function(e){return e.$touched<=i};t.max&&n.length>t.max;){var a=n.minModel("$touched");a&&s(a)}t.keepAlive&&n.eachWhere(s,r)}},destroyLocalUncachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,n.keyHandler.removeKey(e),e.$trigger(Ye.Events.Detach),!1):(n.destroyModel(e,t),!0):!1},destroyLocalCachedModel:function(e,t){var n=this;return e?e.$hasChanges()?(delete e.$saved,n.keyHandler.removeKey(e),e.$local&&(delete e.$local.$saved,n.keyHandler.removeKey(e.$local)),e.$trigger(Ye.Events.Detach),e.$addOperation(pt),!1):(e.$addOperation(ft),n.destroyModel(e,t),!0):(n.store.remove(t,function(e){e&&Se.debug(Se.Debugs.REMOTE_REMOVE,n,e)}),!1)},destroyLocalModel:function(e){var t=this,n=t.all[e];return t.cache===sn.All?t.destroyLocalCachedModel(n,e):t.destroyLocalUncachedModel(n,e)},loadFinish:function(){var e=this;Ce(function(){for(var t in e.loaded){var n=e.loaded[t];n.$status===Ye.Status.RemovePending?(Se.debug(Se.Debugs.LOCAL_RESUME_DELETE,e,n),n.$addOperation(vt)):(n.$status===Ye.Status.SavePending?(Se.debug(Se.Debugs.LOCAL_RESUME_SAVE,e,n),n.$addOperation(mt)):Se.debug(Se.Debugs.LOCAL_LOAD_SAVED,e,n),e.saveReference(n,t,!0))}}),e.loaded={},e.updated(),e.hasLoad(an.All)&&(0===e.pendingOperations?e.refresh():e.firstRefresh=!0)},hasLoad:function(e){return 0!==(this.load&e)},loadBegin:function(e){function t(t,n){Se.debug(Se.Debugs.LOCAL_LOAD,i,t);for(var s=0;s<t.length;s++){var r=t[s],a=n[s],o=i.decode(Z(r,!0)),u=i.instantiate(o,!0);if(u.$invalid===!0){Se.debug(Se.Debugs.MISSING_KEY,i,r);break}u.$local=r,u.$saved=r.$saved,u.$status!==Ye.Status.Removed&&(i.loaded[a]=u,i.addReference(u,a))}i.localLoaded=!0,i.triggerLoad(Fe.Events.LocalLoad),e(!0,i)}function n(){i.loadNone(),e(!1,i)}var i=this;i.hasLoad(an.All)&&i.autoRefresh&&Se.after(Se.Events.Online,i.onOnline,i),i.cache===sn.None?(i.loadNone(),e(!1,i)):i.store.all(t,n)},triggerLoad:function(e,t){var n=this;n.initialized=!0,n.trigger(e,[n].concat(t||[])),n.readyPromise.reset().resolve(n)},loadNone:function(){var e=this;e.hasLoad(an.All)?e.refresh():e.triggerLoad(Fe.Events.NoLoad)},onOnline:function(){var e=this;e.afterOnline=!0,0===e.pendingOperations&&e.onOperationRest()},onOperationRest:function(){var e=this;(e.autoRefresh&&e.remoteLoaded&&e.afterOnline||e.firstRefresh)&&(e.afterOnline=!1,e.firstRefresh=!1,Se.debug(Se.Debugs.AUTO_REFRESH,e),e.refresh())},handleRefreshSuccess:function(e){var t=this;return function(n){for(var i=t.resolveModels(n),s={},r=0;r<i.length;r++){var a=t.putRemoteData(i[r]);if(a){var o=a.$key();s[o]=a}}if(t.allComplete)for(var u=t.models.keys().slice(),r=0;r<u.length;r++){var h=u[r];if(!(h in s)){var l=t.models.get(h);l.$saved&&(Se.debug(Se.Debugs.REMOTE_LOAD_REMOVE,t,h),t.destroyLocalModel(h))}}t.remoteLoaded=!0,t.triggerLoad(Fe.Events.RemoteLoad),t.updated(),Se.debug(Se.Debugs.REMOTE_LOAD,t,i),e.resolve(t.models)}},handleRefreshFailure:function(e){var t=this;return function(n,i){0===i?(Se.checkNetworkStatus(),Se.online||(t.pendingRefresh=!0,Se.once(Se.Events.Online,t.onRefreshOnline,t)),Se.debug(Se.Debugs.REMOTE_LOAD_OFFLINE,t)):(Se.debug(Se.Debugs.REMOTE_LOAD_ERROR,t,i),t.triggerLoad(Fe.Events.NoLoad,[n])),e.reject(t.models)}},executeRefresh:function(e,t){this.rest.all(this.allOptions,e,t)},refresh:function(e,t){var n=this,i=new ot,s=this.handleRefreshSuccess(i),r=this.handleRefreshFailure(i);return i.complete(e,t||n),Ce(function(){n.executeRefresh(s,r)}),i},onRefreshOnline:function(){var e=this;Se.debug(Se.Debugs.REMOTE_LOAD_RESUME,e),e.pendingRefresh&&(e.pendingRefresh=!1,e.refresh())},get:function(e){return this.all[this.keyHandler.buildKeyFromInput(e)]},filter:function(e){var t=this.all,n=[];for(var i in t){var s=t[i];e(s)&&n.push(s)}return n},hasTrait:function(e,t){var n=t||k;return E(this.traits)&&i(this.traits,e,n)!==!1},hasTraits:function(e,t){for(var n=0;n<e.length;n++)if(!this.hasTrait(e[n],t))return!1;return!0},liveSave:function(e,t){this.putRemoteData(t,e),this.updated(),Se.debug(Se.Debugs.REALTIME_SAVE,this,t,e)},liveRemove:function(e){this.destroyLocalModel(e)&&this.updated(),Se.debug(Se.Debugs.REALTIME_REMOVE,this,e)},instantiate:function(e,t){return new this.Model(e,t)},addReference:function(e,t){this.noReferences||(this.all[t||e.$key()]=e)},saveReference:function(e,t,n){this.noReferences||this.models.put(t||e.$key(),e,n)},save:function(e,t,n){var i=this;if(e.$isDeleted())return void Se.debug(Se.Debugs.SAVE_DELETED,i,e);var s=e.$key(),r=i.models.has(s);r?(i.trigger(Fe.Events.ModelUpdated,[e]),e.$trigger(Ye.Events.UpdateAndSave)):(i.saveReference(e,s),i.trigger(Fe.Events.ModelAdded,[e]),i.updated(),e.$trigger(Ye.Events.CreateAndSave)),e.$addOperation(gt,t,n)},remove:function(e,t,n){var i=this;this.removeFromModels(e),e.$status===Ye.Status.SavePending&&Se.debug(Se.Debugs.REMOVE_CANCEL_SAVE,i,e),e.$status=Ye.Status.RemovePending,e.$addOperation(dt,t,n)},removeFromModels:function(e){var t=this,n=e.$key();t.models.has(n)&&(t.models.remove(n),t.trigger(Fe.Events.ModelRemoved,[e]),t.updated(),e.$trigger(Ye.Events.Removed))}}),w(Fe),x(Fe,"change",Fe.Events.Changes),Ye.Events={Created:"created",Saved:"saved",PreSave:"pre-save",PostSave:"post-save",PreRemove:"pre-remove",PostRemove:"post-remove",PartialUpdate:"partial-update",FullUpdate:"full-update",Updated:"updated",Detach:"detach",Change:"change",CreateAndSave:"created saved",UpdateAndSave:"updated saved",KeyUpdate:"key-update",RelationUpdate:"relation-update",Removed:"removed",RemoteUpdate:"remote-update",LocalSave:"local-save",LocalSaveFailure:"local-save-failure",LocalSaves:"local-save local-save-failure",RemoteSave:"remote-save",RemoteSaveFailure:"remote-save-failure",RemoteSaveOffline:"remote-save-offline",RemoteSaves:"remote-save remote-save-failure remote-save-offline",LocalRemove:"local-remove",LocalRemoveFailure:"local-remove-failure",LocalRemoves:"local-remove local-remove-failure",RemoteRemove:"remote-remove",RemoteRemoveFailure:"remote-remove-failure",RemoteRemoveOffline:"remote-remove-offline",RemoteRemoves:"remote-remove remote-remove-failure remote-remove-offline",LocalGet:"local-get",LocalGetFailure:"local-get-failure",LocalGets:"local-get local-get-failure",RemoteGet:"remote-get",RemoteGetFailure:"remote-get-failure",RemoteGetOffline:"remote-get-offline",RemoteGets:"remote-get remote-get-failure remote-get-offline",RemoteAndRemove:"remote-remove removed",SavedRemoteUpdate:"saved remote-update",OperationsStarted:"operations-started",OperationsFinished:"operations-finished",KeyChange:"key-change",Changes:"saved remote-update key-update relation-update removed key-change change"},Ye.Status={Synced:0,SavePending:1,RemovePending:2,Removed:3},Ye.Blocked={toString:!0,valueOf:!0},Bt.create(Ye,{$init:function(e,n){if(this.$status=Ye.Status.Synced,Bt.props(this,{$operation:null,$relations:{},$dependents:new je(this),$savedState:!1,$saved:!1,$local:!1,$touched:Jt()}),n){var i=this.$db.keyHandler.getKey(e,!0);if(!R(i))return void Bt.prop(this,"$invalid",!0);this.$db.addReference(this,i),this.$set(e,t,n)}else this.$reset(e);if(this.$db.loadRelations){var s=this.$db.relations;for(var r in s){var a=s[r];a.lazy||this.$getRelation(r,t,n)}}},$load:function(e){if(E(e))for(var t=0;t<e.length;t++)this.$getRelation(e[t]);else if(f(e))this.$getRelation(e);else{var n=this.$db.relations;for(var i in n)this.$getRelation(i)}},$reset:function(e){var n=this.$db.defaults,i=this.$db.fields,s=this.$db.relations,r=this.$db.keyHandler,a=this.$db.key;if(M(n))for(var o=0;o<i.length;o++){var u=i[o];this[u]=t}else for(var o=0;o<i.length;o++){var u=i[o],h=n[u],l=_(h);this[u]=l}var c=null;if(e&&(c=r.getKey(e,!0)),R(c)?j(this,a,e,a):c=r.getKey(this),R(c)&&(this.$db.addReference(this,c),this.$$key=c),!M(n))for(var u in s)if(u in n){var h=n[u],l=_(h),d=!!this.$relations[u],f=this.$getRelation(u,l);d&&f.set(this,l)}this.$set(e)},$set:function(e,t,n,i){if(y(e))for(var s in e)this.$set(s,e[s],n,!0);else if(f(e)){if(Ye.Blocked[e])return;var r=this.$hasRelation(e),a=this.$getRelation(e,t,n);a?r&&a.set(this,t,n):this[e]=t}!i&&R(e)&&this.$trigger(Ye.Events.Change,[e,t])},$get:function(e,t){if(E(e))return Q(this,e,t);if(y(e)){for(var n in e)e[n]=t?Z(this[n]):this[n];return e}if(f(e)){if(Ye.Blocked[e])return;var i=this.$getRelation(e);if(i){var s=i.get(this);return t?Z(s):s}return t?Z(this[e]):this[e]}},$decode:function(){this.$db.decode(this)},$sync:function(e,t){var n=this.$getRelation(e);n&&n.sync(this,t)},$relate:function(e,t,n){var i=this.$getRelation(e);i&&i.relate(this,t,n)},$unrelate:function(e,t,n){var i=this.$getRelation(e);i&&i.unrelate(this,t,n)},$isRelated:function(e,t){var n=this.$getRelation(e);return n&&n.isRelated(this,t)},$hasRelation:function(e){return e in this.$relations},$getRelation:function(e,t,n){var i=this.$db.relations,s=i[e];return s?(e in this.$relations||s.load(this,t,n),s):!1},$save:function(e,n,i,s){if(y(e)?(s=i,i=n,n=t):v(e)&&(s=n,i=e,n=t,e=t),v(i)||(i=this.$db.cascade),this.$isDeleted())return Se.debug(Se.Debugs.SAVE_DELETED,this.$db,this),ot.resolve(this);if(!this.$hasKey())throw"Key missing from model";var r=Ge(this,i,Ye.Events.RemoteSave,Ye.Events.RemoteSaveFailure,Ye.Events.RemoteSaveOffline,Ye.Events.LocalSave,Ye.Events.LocalSaveFailure);return ot.singularity(r,this,function(r){Ce(function(){this.$touch(),this.$db.addReference(this),e!==t&&this.$set(e,n),this.$trigger(Ye.Events.PreSave,[this]),this.$db.save(this,i,s),this.$db.pruneModels(),this.$trigger(Ye.Events.PostSave,[this])},this)})},$remove:function(e,t){var e=v(e)?e:this.$db.cascade;if(!this.$exists())return ot.resolve(this);var n=Ge(this,e,Ye.Events.RemoteRemove,Ye.Events.RemoteRemoveFailure,Ye.Events.RemoteRemoveOffline,Ye.Events.LocalRemove,Ye.Events.LocalRemoveFailure);return ot.singularity(n,this,function(n){Ce(function(){this.$trigger(Ye.Events.PreRemove,[this]),this.$db.remove(this,e,t),this.$trigger(Ye.Events.PostRemove,[this])},this)})},$refresh:function(e,t){var n=Ge(this,e,Ye.Events.RemoteGet,Ye.Events.RemoteGetFailure,Ye.Events.RemoteGetOffline,Ye.Events.LocalGet,Ye.Events.LocalGetFailure);return Ae(e,rn.Rest)?this.$addOperation(lt,e,t):Ae(e,rn.Local)?this.$addOperation(ht,e,t):n.resolve(this),n},$autoRefresh:function(e,t){var n=function(){this.$refresh(e,t)};return Se.on(Se.Events.Online,n,this),this},$cancel:function(e,t){this.$saved?this.$save(this.$saved,this.$db.cascade,t):e&&this.$reset()},$clone:function(e){for(var t=this.$db,n=t.key,i=t.fields,s=t.relations,r={},a=0;a<i.length;a++){var o=i[a];e&&o in e?r[o]=_(e[o]):o in this&&(r[o]=Z(this[o]))}f(n)&&delete r[n];var u=t.keyHandler.getKey(r),h=this.$key();if(u===h)throw"A clone cannot have the same key as the original model.";for(var l in s)e&&l in e&&s[l].preClone(this,r,e[l]);var c=t.instantiate(r),d={};for(var l in s)e&&l in e&&s[l].postClone(this,d,e[l]);return c.$set(d),c},$push:function(e){this.$savedState=this.$db.encode(this,Q(this,e||this.$db.fields,!0),!1)},$pop:function(e){y(this.$savedState)&&(this.$set(this.$savedState),e||this.$discard())},$discard:function(){this.$savedState=!1},$exists:function(){return!this.$isDeleted()&&this.$db.models.has(this.$key())},$addOperation:function(e,t,n){var i=new e(this,t,n);this.$operation?this.$operation.queue(i):(this.$operation=i,this.$operation.execute())},$toJSON:function(e){var t=this.$db.encode(this,Q(this,this.$db.fields,!0),e),n=this.$db.relations,i=this.$relations;for(var s in i)n[s].encode(this,t,e);return t},$changed:function(){this.$trigger(Ye.Events.Change)},$updated:function(){this.$changed(),this.$db.trigger(Fe.Events.ModelUpdated,[this])},$key:function(e){return this.$$key||(this.$$key=this.$db.keyHandler.getKey(this,e)),this.$$key},$keys:function(){return this.$db.keyHandler.getKeys(this)},$uid:function(){return this.$db.name+"$"+this.$key()},$hasKey:function(){return G(this,this.$db.key,R)},$setKey:function(e,t){var n=this.$db,i=n.keyHandler.buildKeyFromInput(e),s=this.$$key;if(i!==s){if(!n.keyChanges)throw"Key changes are not supported, see the documentation on how to enable key changes.";n.removeReference(s),n.addReference(this,i),this.$$key=i,t||n.keyHandler.applyKey(i,this),this.$trigger(Ye.Events.KeyChange,[this,s,i])}return i},$remote:function(e,t){this.$db.putRemoteData(e,this.$key(),this,t)},$isSynced:function(){return this.$status===Ye.Status.Synced},$isSaving:function(){return this.$status===Ye.Status.SavePending},$isPending:function(){return this.$status===Ye.Status.SavePending||this.$status===Ye.Status.RemovePending},$isDeleted:function(){return this.$status>=Ye.Status.RemovePending},$isSaved:function(){return!!this.$saved},$isSavedLocally:function(){return!!this.$local},$isNew:function(){return!(this.$saved||this.$local)},$touch:function(){this.$db.hasPruning()&&(this.$touched=Jt())},$project:function(e){var t=Qe.parse(this.$db,e);return t.project(this)},$getChanges:function(e){var t=this.$db,n=t.decode(this.$saved,{}),i=e||this,s=t.saveFields;return n?ee(i,n,s,k):i},$hasChanges:function(e){var t=e?this.$local:this.$saved;if(!t)return!0;for(var n=this.$db,i=n.ignoredFields,s=n.decode(t,{}),r=n.saveFields,a=0;a<r.length;a++){var o=r[a],u=this[o],h=s[o];if(!i[o]&&!k(u,h))return!0}return!1},$hasChange:function(e,t){var n=t?this.$local:this.$saved;if(!n)return!0;var i=this.$db,s=i.decodings[e],r=this[e],a=s?s(n[e],n,e):n[e];return!k(r,a)},$listenForOnline:function(e,t){this.$offline||(this.$offline=!0,Se.once(Se.Events.Online,this.$resume,this)),Bt.props(this,{$resumeCascade:e,$resumeOptions:t})},$resume:function(){this.$status===Ye.Status.RemovePending?(Se.debug(Se.Debugs.REMOVE_RESUME,this),this.$addOperation(vt,this.$resumeCascade,this.$resumeOptions)):this.$status===Ye.Status.SavePending&&(Se.debug(Se.Debugs.SAVE_RESUME,this),this.$addOperation(mt,this.$resumeCascade,this.$resumeOptions)),this.$offline=!1},toString:function(){return this.$db.className+" "+JSON.stringify(this.$toJSON())}}),w(Ye,!0),x(Ye,"$change",Ye.Events.Changes,!0),Bt.create(ze,{reset:function(){return this.values.length=0,this.keys.length=0,this.indices={},this},put:function(e,t){return e in this.indices?this.values[this.indices[e]]=t:(this.indices[e]=this.values.length,qt.push.call(this.values,t),qt.push.call(this.keys,e)),this},get:function(e){return this.values[this.indices[e]]},remove:function(e){var t=this.indices[e];return v(t)&&this.removeAt(t),this},removeAt:function(e){var t=this.keys[e],n=qt.pop.apply(this.values),i=qt.pop.apply(this.keys);return e<this.values.length&&(this.values[e]=n,this.keys[e]=i,this.indices[i]=e),delete this.indices[t],this},has:function(e){return e in this.indices},size:function(){return this.values.length},subtract:function(e,t){for(var n=t||new ze,i=this.size(),s=this.values,r=this.keys,a=0;i>a;a++){var o=s[a],u=r[a];e.has(u)||n.put(u,o)}return n},filter:function(e,t){for(var n=t||new ze,i=this.size(),s=this.values,r=this.keys,a=0;i>a;a++){var o=s[a],u=r[a];e(o,u)&&n.put(u,o)}return n},reverse:function(){return o(this.values),o(this.keys),this.rebuildIndex(),this},isSorted:function(e){return u(e,this.values)},sort:function(e){function t(t,n){for(var s=i.values[Math.floor((n+t)/2)],r=t,o=n;o>=r;){for(;e(i.values[r],s)<0;)r++;for(;e(i.values[o],s)>0;)o--;o>=r&&(a(i.values,r,o),a(i.keys,r,o),r++,o--)}return r}function n(e,i){var s=t(e,i);s-1>e&&n(e,s-1),i>s&&n(s,i)}var i=this,s=this.size()-1;return s>0&&(n(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var e=0,t=this.keys.length;t>e;e++)this.indices[this.keys[e]]=e;return this},toObject:function(e){for(var t=e||{},n=this.keys,i=this.values,s=0;s<n.length;s++)t[n[s]]=i[s];return t}}),Bt.create(je,{add:function(e,t){var n=e.$uid();if(this.map[n]=e,e.$db.keyChanges&&!this.listeners[n]){var i=this.handleKeyChange(t);this.listeners[n]=e.$on(Ye.Events.KeyChange,i,this)}},remove:function(e){var t=e.$uid();_(this.listeners[t]),delete this.listeners[t],delete this.map[t]},handleKeyChange:function(e){return function(t,n,i){var s=t.$db.name+"$";n=s+n,i=s+i,this.listeners[i]=this.listeners[n],this.map[i]=this.map[n],delete this.listeners[n],delete this.map[n],e.updateForeignKey(this.subject,t,!0)}},isSaved:function(e,t){var n=this.map,i=$,s=function(){e.apply(t||this,arguments),i()};for(var r in n){var a=n[r];if(!a.$isSaved())return i=a.$once(Ye.Events.RemoteSaves,s),!1}return!0}}),Bt.create(Qe,{addProjection:function(e){var t=this,n=e,i=e.indexOf(Qe.ALIAS_DELIMITER);i>0&&(n=e.substring(0,i),e=e.substring(i+1));for(var s="",r=[],a=["property"],o=[this.database],u=0,h=[],l=function(e){if(e){var n=a[0],i=Qe.TOKEN_HANDLER[n];r.unshift(e),i&&i.post&&h.push(i.post(r,a,o,t))}},c=function(e){var n=Qe.TOKEN_HANDLER[e];a.unshift(e),n&&n.pre&&h.push(n.pre(r,a,o,t))},u=0;u<e.length;u++){var d=e.charAt(u),f=Qe.TOKENS[d];f?(l(s),c(f),s=""):s+=d}l(s);for(var v=function(e){return e},u=h.length-1;u>=0;u--)v=h[u](v);this.projections[n]=v},project:function(e){var t={};for(var n in this.projections)t[n]=this.projections[n](e);return t}}),Qe.TOKENS={".":"property","?":"where","|":"filter","#":"resolve","(":"subStart",")":"subEnd","[":"pluckValueStart","]":"pluckValueEnd","{":"pluckObjectStart",":":"pluckObjectDelimiter","}":"pluckObjectEnd","@":"aggregateStart","=":"aggregateProperty"},Qe.TOKEN_HANDLER={property:{post:function(e,t,n,s){var r=e[0],a=n[0];if(!(a instanceof Fe))throw"The property "+r+" can only be taken from a Model";var o=a.relations[r];o&&(o instanceof yt?n.unshift(o.model.Database):n.unshift(o));var u=i(a.fields,r);if(u===!1&&!o)throw"The property "+r+" does not exist as a field or relation on the Model "+a.name;return function(e){return function(t){return R(t)?e(t.$get(r)):null}}}},filter:{post:function(e,t,n,i){var s=e[0],r=Se.Filters[s];if(!r)throw s+" is not a valid filter function";return function(e){return function(t){return R(t)?e(r(t)):null}}}},resolve:{post:function(e,t,n,i){var s=e[0];return function(e){return function(t){if(!R(t))return null;var n=t[s];return c(n)&&(n=n.apply(t)),e(n)}}}},where:{post:function(e,t,n,i){var s=e[0],r=n[0],a=Se.Wheres[s];if(!a)throw s+" is not a valid where expression";if(!(r instanceof Rt))throw s+" where expressions can only be used on relations";return function(e){return function(t){return R(t)?e(t.where(a)):null}}}},aggregateProperty:{post:function(e,t,n,i){var s=e[0],r=e[1],a=n[0];if("aggregateStart"!==t[1])throw"Aggregate function syntax error, a = must follow a @";if(!(a instanceof Et))throw"Aggregate functions like "+r+" from "+a+" can only be used on relations";return function(e){return function(t){return R(t)?e(t[r](s)):null}}}},subEnd:{pre:function(e,t,n,i){var s=e[0],r=n[0];if("subStart"!==t[1])throw"Sub projection syntax error, an ending ) requires a starting (";if(!(r instanceof Et))throw"Sub projections like "+s+" from "+e[1]+" can only be used on relations";if(!r.model.Database.projections[s])throw"The projection "+s+" does not exist on "+r.model.Database.name;return r instanceof yt?function(e){return function(t){return R(t)?e(t.$project(s)):null}}:function(e){return function(t){return R(t)?e(t.project(s)):null}}}},pluckValueEnd:{pre:function(e,t,n,i){var s=e[0],r=n[0];if("pluckValueStart"!==t[1])throw"Pluck value syntax error, an ending ] requires a starting [";if(!(r instanceof Rt))throw"Pluck values like "+s+" from "+e[1]+" can only be used on relations";return function(e){return function(t){return R(t)?e(t.pluck(s)):null}}}},pluckObjectEnd:{pre:function(e,t,n,i){var s=e[0],r=e[1],a=n[0];if("pluckObjectDelimiter"!==t[1]||"pluckObjectStart"!==t[2])throw"Pluck object syntax error, must be {key: value}";if(!(a instanceof Rt))throw"Pluck values like "+s+" from "+e[1]+" can only be used on relations";return function(e){return function(t){return R(t)?e(t.pluck(s,r)):null}}}}},Qe.ALIAS_DELIMITER=":",Qe.parse=function(e,t){var n=t;if(f(t)&&(t=e.projections[t]),E(t)&&(t=new Qe(e,t)),!(t instanceof Qe))throw n+" is not a valid projection";return t},qe.start=function(e){var t=new qe(e);return t.apply(),t},Bt.create(qe,{add:function(e){f(e)&&(e=Se.classes[e]),d(e)&&(e=e.Database),e instanceof Fe&&(this.databases.push(e),this.alls.push({}),this.models.push(new tt(e)))},getApplied:function(){var e=0;return this.each(function(t){t.context===this&&e++}),e/this.databases.length},apply:function(){this.each(this.applyDatabase)},applyDatabase:function(e,t,n,i){e.all=t,e.models=n,e.context=this,e.contextIndex=i},discard:function(){this.each(this.discardDatabase)},discardDatabase:function(e){e.context===this&&(e.all=e.allCached,e.models=e.modelsCached,e.context=null,e.contextIndex=-1)},destroy:function(){this.each(this.destroyDatabase),this.databases.length=0,this.alls.length=0,this.models.length=0},destroyDatabase:function(e,t,n,i){this.discardDatabase(e),this.databases[i]=null,this.alls[i]=null,this.models[i].clear(),this.models[i]=null},clear:function(e){this.alls[e.contextIndex]={}},each:function(e){for(var t=this.databases,n=this.alls,i=this.models,s=0;s<t.length;s++)e.call(this,t[s],n[s],i[s],s)}}),Bt.create(Be,{init:function(e){this.key=e.key,this.keySeparator=e.keySeparator,this.database=e},getKey:function(e,t){var n=this.key,i=this.buildKey(e,n);if(G(e,n,R))return i;if(!t)throw"Composite key not supplied.";return null},buildKeyFromRelations:function(e){if(y(e)){var t=this.database.relations;for(var n in t)n in e&&t[n].buildKey(e)}},buildKeyFromInput:function(e){return e instanceof this.database.Model?e.$key():E(e)?e.join(this.keySeparator):y(e)?this.buildKey(e):e}}),Bt.extend(Be,Je,{getKeys:function(e){return this.buildKey(e)},removeKey:function(e){var t=this.key;delete e[t]},buildKey:function(e,t){this.buildKeyFromRelations(e);var n=t||this.key,i=e[n];return R(i)||(i=e[n]=S()),i},buildObjectFromKey:function(e){var t=this.key,n={};return n[t]=e,this.database.instantiate(n)},hasKeyChange:function(e,t){var n=this.key,i=e[n],s=t[n];return R(i)&&R(s)&&i!==s},addToFields:function(e){var t=this.key;i(e,t)===!1&&e.unshift(t)},isValid:function(e){return R(e)},copyFields:function(e,t,n,i){var s=e[t],r=n[i];!R(s)&&R(r)&&(e[t]=Z(r))},inKey:function(e){if(E(e)){for(var t=0;t<e.length;t++)if(e[t]===this.key)return!0;return!1}return e===this.key},setKeyField:function(e,t,n,i){t===i&&(e[t]=n[this.key])},applyKey:function(e,t){t[this.key]=e}}),Bt.extend(Be,We,{getKeys:function(e,t){return this.buildKeyFromRelations(e),q(e,t||this.key)},removeKey:function(e){for(var t=this.key,n=0;n<t.length;n++)delete e[t[n]]},buildKey:function(e,t){return this.getKeys(e,t).join(this.keySeparator)},buildObjectFromKey:function(e){var t=this.key,n={};f(e)&&(e=e.split(this.keySeparator));for(var i=0;i<t.length;i++)n[t[i]]=e[i];return this.database.instantiate(n)},hasKeyChange:function(e,t){for(var n=this.key,i=0;i<n.length;i++){var s=e[n[i]],r=t[n[i]];if(R(s)&&R(r)&&s!==r)return!0}return!1},addToFields:function(e){for(var t=this.key,n=t.length-1;n>=0;n--)i(e,t[n])===!1&&e.unshift(t[n])},isValid:function(e){return R(e)},copyFields:function(e,t,n,i){for(var s=0;s<t.length;s++){var r=e[t[s]],a=n[i[s]];!R(r)&&R(a)&&(e[t[s]]=Z(a))}},inKey:function(e){if(E(e)){for(var t=0;t<e.length;t++)if(i(this.key,e[t])!==!1)return!0;return!1}return i(this.key,e)!==!1},setKeyField:function(e,t,n,s){var r=i(s);r!==!1&&(e[t]=n[this.key[r]])},applyKey:function(e,t){var n=this.key;f(e)&&(e=e.split(this.keySeparator));for(var i=0;i<n.length;i++)t[n[i]]=e[i]}}),Xe.Events={Add:"add",Adds:"adds",Sort:"sort",Remove:"remove",Removes:"removes",Updates:"updates",Reset:"reset",Cleared:"cleared",Changes:"add adds sort remove removes updates reset cleared"},Bt.extend(Array,Xe,{setComparator:function(e,t){return this.comparator=N(e,t),this.sort(),this},addComparator:function(e,t){return this.comparator=L(this.comparator,e,t),this.sort(),this},isSorted:function(e,t){var n=e?N(e,t):this.comparator;return u(n,this)},sort:function(e,t,n){var i=e?N(e,t):this.comparator;return u(i,this)&&(n||i||!h(this))||(qt.sort.call(this,i),this.trigger(Xe.Events.Sort,[this])),this},reset:function(e){return this.length=0,E(e)?qt.push.apply(this,e):R(e)&&qt.push.call(this,e),this.trigger(Xe.Events.Reset,[this]),this.sort(t,t,!0),this},page:function(e,t){return new Ze(this,e,t)},filtered:function(e,t,n){var i=pe(e,t,n);return et.create(this,i)},where:function(e,t,n,i){for(var s=pe(e,t,n),r=i||this.cloneEmpty(),a=0;a<this.length;a++){var o=this[a];s(o)&&r.push(o)}return r},subtract:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||C,r=0;r<this.length;r++){for(var a=this[r],o=!1,u=0;u<e.length&&!o;u++)o=s(a,e[u]);o||i.push(a)}return i},intersect:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||C,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o&&i.push(a)}return i},complement:function(e,t,n){for(var i=t||this.cloneEmpty(),s=n||C,r=0;r<e.length;r++){for(var a=e[r],o=!1,u=0;u<this.length&&!o;u++)o=s(a,this[u]);o||i.push(a)}return i},clear:function(){return this.length=0,this.trigger(Xe.Events.Cleared,[this]),this},add:function(e,n){var i=this.length;return qt.push.call(this,e),this.trigger(Xe.Events.Add,[this,e,i]),n||this.sort(t,t,!0),this},push:function(){var e=qt.slice.apply(arguments),n=this.length;return qt.push.apply(this,e),this.trigger(Xe.Events.Adds,[this,e,n]),this.sort(t,t,!0),this.length},unshift:function(){var e=arguments;return qt.unshift.apply(this,e),this.trigger(Xe.Events.Adds,[this,qt.slice.apply(e),0]),this.sort(t,t,!0),this.length},addAll:function(e,n){if(E(e)&&e.length){var i=this.length;qt.push.apply(this,e),this.trigger(Xe.Events.Adds,[this,e,i]),n||this.sort(t,t,!0)}return this},insertAt:function(e,n,i){return qt.splice.call(this,e,0,n),this.trigger(Xe.Events.Add,[this,n,e]),i||this.sort(t,t,!0),this},pop:function(e){var n=qt.pop.apply(this),i=this.length;return this.trigger(Xe.Events.Remove,[this,n,i]),e||this.sort(t,t,!0),n},shift:function(e){var n=qt.shift.apply(this);return this.trigger(Xe.Events.Remove,[this,n,0]),e||this.sort(t,t,!0),n},removeAt:function(e,n){var i;return e>=0&&e<this.length&&(i=this[e],qt.splice.call(this,e,1),this.trigger(Xe.Events.Remove,[this,i,e]),n||this.sort(t,t,!0)),i},remove:function(e,t,n){var i=this.indexOf(e,n),s=this[i];return-1!==i&&this.removeAt(i,t),s},removeAll:function(e,n,i){var s=[],r=[];if(E(e)&&e.length){for(var a=0;a<e.length;a++){var o=e[a],u=this.indexOf(o,i);-1!==u&&(r.push(u),s.push(o))}r.sort();for(var a=r.length-1;a>=0;a--)qt.splice.call(this,r[a],1);this.trigger(Xe.Events.Removes,[this,s,r]),n||this.sort(t,t,!0)}return s},removeWhere:function(e,n,i,s,r){for(var a=pe(e,n,i),o=s||this.cloneEmpty(),u=[],h=0;h<this.length;h++){var l=this[h];a(l)&&(u.push(h),o.push(l))}for(var h=u.length-1;h>=0;h--)qt.splice.call(this,u[h],1);return this.trigger(Xe.Events.Removes,[this,o,u]),r||this.sort(t,t,!0),o},splice:function(e,n){var i=qt.slice.call(arguments,2),s=qt.splice.apply(this,arguments);return n&&this.trigger(Xe.Events.Removes,[this,s,e,n]),i.length&&this.trigger(Xe.Events.Adds,[this,i,e]),this.sort(t,t,!0),s},reverse:function(){return qt.reverse?qt.reverse.apply(this):o(this),this.trigger(Xe.Events.Updates,[this]),this},indexOf:function(e,t){for(var n=t||C,i=0;i<this.length;i++)if(n(e,this[i]))return i;return-1},minModel:function(e,t){for(var n=N(e||this.comparator,!1),i=t,s=0;s<this.length;s++)n(i,this[s])>0&&(i=this[s]);return i},maxModel:function(e,t){for(var n=N(e||this.comparator,!0),i=t,s=0;s<this.length;s++)n(i,this[s])<0&&(i=this[s]);return i},min:function(e,t,n){for(var i=n||U,s=ce(e),r=t,a=0;a<this.length;a++){var o=s(this[a]);i(r,o,!1)>0&&(r=o)}return r},max:function(e,t,n){for(var i=n||U,s=ce(e),r=t,a=0;a<this.length;a++){var o=s(this[a]);i(r,o,!0)<0&&(r=o)}return r},firstWhere:function(e,t,n){for(var i=pe(e,t,n),s=0;s<this.length;s++){var r=this[s];if(i(r))return r}return null},first:function(e){for(var t=ce(e),n=0;n<this.length;n++){var i=t(this[n]);if(R(i))return i}},lastWhere:function(e,t,n){for(var i=pe(e,t,n),s=this.length-1;s>=0;s--){var r=this[s];if(i(r))return r}return null},last:function(e){for(var t=ce(e),n=this.length-1;n>=0;n--){var i=t(this[n]);if(R(i))return i}},aggregate:function(e,t,n,i){for(var s=0;s<this.length;s++){var r=e(this[s]);t(r)&&n(r)}return i()},sum:function(e){function t(e){s+=e}function n(){return s}var i=he(e),s=0;return this.aggregate(i,v,t,n)},avg:function(e){function t(e){s+=e,r++}function n(){return 0===r?0:s/r}var i=he(e),s=0,r=0;return this.aggregate(i,v,t,n)},countWhere:function(e,t,n){for(var i=pe(e,t,n),s=0,r=0;r<this.length;r++){var a=this[r];i(a)&&s++}return s},count:function(e){if(!R(e))return this.length;for(var t=ce(e),n=0,i=0;i<this.length;i++){var s=t(this[i]);R(s)&&n++}return n},pluck:function(e,t){var n=ce(e);if(t){for(var i=ce(t),s={},r=0;r<this.length;r++){var a=this[r],o=n(a),u=i(a);s[u]=o}return s}for(var s=[],r=0;r<this.length;r++){var a=this[r],o=n(a);s.push(o)}return s},each:function(e,t){for(var n=t||this,i=0;i<this.length;i++){var s=this[i];e.call(n,s,i),this[i]!==s&&i--}return this},eachWhere:function(e,t,n,i){for(var s=pe(t,n,i),r=0;r<this.length;r++){var a=this[r];s(a)&&(e.call(this,a,r),this[r]!==a&&r--)}return this},reduce:function(e,t){for(var n=0;n<this.length;n++)t=e(t,this[n]);return t},random:function(){var e=Math.floor(Math.random()*this.length);return this[e]},chunk:function(e,t){for(var n=t||[],i=0,s=n[i]=n[i]||[],r=0,a=0;a<this.length;a++)s[r]=this[a],++r>=e&&(r=0,i++,s.length=e,s=n[i]=n[i]||[]);return 0!==r&&i++,s.length=r,n.length=i,n},contains:function(e,t,n){for(var i=pe(e,t,n),s=0;s<this.length;s++){var r=this[s];if(i(r))return!0}return!1},group:function(e){var t=ce(e.by),n=pe(e.having,e.havingValue,e.havingEquals),i=e.select||{},s={};if(f(e.by))e.by in i||(i[e.by]="first");else if(E(e.by))for(var r in e.by)r in i||(i[r]="first");for(var a=0;a<this.length;a++){var o=this[a],u=t(o),h=s[u];h||(h=s[u]=this.cloneEmpty()),h.add(o,!0)}var l=this.cloneEmpty();
l.setComparator(e.comparator,e.comparatorNullsFirst);for(var u in s){var d={},v=s[u];for(var g in i){var p=i[g];f(p)?d[g]=v[p](g):c(p)&&(d[g]=p(v,g))}e.track!==!1&&(d.$group=v),e.count!==!1&&(d.$count=v.length),n(d,v)&&l.push(d)}return l.sort(),l},toArray:function(){return this.slice()},clone:function(){return this.constructor.create(this)},cloneEmpty:function(){return this.constructor.create()}}),w(Xe),x(Xe,"change",Xe.Events.Changes);var En={bind:function(){Bt.props(this,{onAdd:b(this,En.handleAdd),onAdds:b(this,En.handleAdds),onRemove:b(this,En.handleRemove),onRemoves:b(this,En.handleRemoves),onReset:b(this,En.handleReset),onUpdates:b(this,En.handleUpdates),onCleared:b(this,En.handleCleared)})},init:function(e,t){return this.base!==e&&(this.base&&this.disconnect(),Bt.prop(this,"base",e),this.connect()),Bt.prop(this,"filter",t),this.sync(),this},setFilter:function(e,t,n){return this.filter=pe(e,t,n),this.sync(),this},connect:function(){return this.base.on(Xe.Events.Add,this.onAdd),this.base.on(Xe.Events.Adds,this.onAdds),this.base.on(Xe.Events.Remove,this.onRemove),this.base.on(Xe.Events.Removes,this.onRemoves),this.base.on(Xe.Events.Reset,this.onReset),this.base.on(Xe.Events.Updates,this.onUpdates),this.base.on(Xe.Events.Cleared,this.onCleared),this},disconnect:function(){return this.base.off(Xe.Events.Add,this.onAdd),this.base.off(Xe.Events.Adds,this.onAdds),this.base.off(Xe.Events.Remove,this.onRemove),this.base.off(Xe.Events.Removes,this.onRemoves),this.base.off(Xe.Events.Reset,this.onReset),this.base.off(Xe.Events.Updates,this.onUpdates),this.base.off(Xe.Events.Cleared,this.onCleared),this},sync:function(){for(var e=this.base,t=this.filter,n=[],i=0;i<e.length;i++){var s=e[i];t(s)&&n.push(s)}return this.reset(n)},handleAdd:function(e,t){var n=this.filter;n(t)&&this.add(t)},handleAdds:function(e,t){for(var n=this.filter,i=[],s=0;s<t.length;s++){var r=t[s];n(r)&&i.push(r)}this.addAll(i)},handleRemove:function(e,t){this.remove(t)},handleRemoves:function(e,t){this.removeAll(t)},handleReset:function(e){this.sync()},handleUpdates:function(e,t){for(var n=this.filter,i=0;i<t.length;i++){var s=t[i];n(s)?this.add(s,!0):this.remove(s,!0)}this.sort()},handleCleared:function(e){this.clear()},clone:function(){return this.constructor.create(this.base,this.filter)},cloneEmpty:function(){return this.constructor.create(this.base,this.filter)}};Ze.Events={Change:"change",Changes:"change"},Bt.extend(Array,Ze,{setPageSize:function(e){this.pageSize=e,this.handleChanges()},setPageIndex:function(e){this["goto"](e)},setCollection:function(e){e!==this.collection&&(this.collection&&this.disconnect(),this.collection=e,this.connect(),this.handleChanges(!0))},connect:function(){this.collection.on(Xe.Events.Changes,this.onChanges)},disconnect:function(){this.collection.off(Xe.Events.Changes,this.onChanges)},"goto":function(e){var t=this.page(e);t!==this.pageIndex&&(this.pageIndex=t,this.update(),this.trigger(Ze.Events.Change,[this]))},next:function(){this["goto"](this.pageIndex+1)},prev:function(){this["goto"](this.pageIndex-1)},jump:function(e){this["goto"](e)},first:function(){this["goto"](0)},last:function(){this["goto"](this.pageCount-1)},total:function(){return this.collection.length},pages:function(){return Math.ceil(this.total()/this.pageSize)},page:function(e){return Math.max(0,Math.min(e,this.pages()-1))},can:function(e){return this.total()&&e>=0&&e<this.pageCount},canFirst:function(){return this.canPrev()},canLast:function(){return this.canNext()},canPrev:function(){return this.total()&&this.pageIndex>0},canNext:function(){return this.total()&&this.pageIndex<this.pageCount-1},handleChanges:function(e){var t=this.pages(),n=this.page(this.pageIndex),i=e||this.pageIndex!==n||this.length!==this.pageSize,s=i||this.pageCount!==t;this.pageIndex=n,this.pageCount=t,i&&this.update(),s&&this.trigger(Ze.Events.Change,[this])},update:function(){var e=this.collection,t=e.length,n=this.pageIndex*this.pageSize,i=Math.min(n+this.pageSize,t),s=i-n;this.length=0;for(var r=0;s>r;r++)this.push(e[n++])},more:function(e){for(var t=this.collection,n=t.length,i=e||1,s=this.pageIndex*this.pageSize,r=s+this.length,a=this.pageSize*i,o=r+a,u=Math.min(n,o);u>r;)this.push(t[r++])},toArray:function(){return this.slice()}}),w(Ze),x(Ze,"change",Ze.Events.Changes),Bt.extend(Xe,et,{bind:En.bind,init:En.init,setFilter:En.setFilter,connect:En.connect,disconnect:En.disconnect,sync:En.sync,clone:En.clone,cloneEmpty:En.cloneEmpty}),Bt.extend(Xe,tt,{init:function(e,t,n){return Bt.props(this,{database:e,map:new ze}),this.map.values=this,this.reset(t,n),this},sort:function(e,t){var n=e?N(e,t):this.comparator;return u(n,this)||(this.map.sort(n),this.trigger(Xe.Events.Sort,[this])),this},buildKeyFromInput:function(e){return this.database.keyHandler.buildKeyFromInput(e)},parseModel:function(e,t){return this.database.parseModel(e,t)},filtered:function(e,t,n){var i=pe(e,t,n);return nt.create(this,i)},subtract:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<this.length;i++){var s=this[i],r=s.$key(),a=!1;if(e instanceof tt)a=e.has(r);else for(var o=0;o<e.length&&!a;o++){var u=this.buildKeyFromInput(e[o]);a=r===u}a||n.push(s)}return n},intersect:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<e.length;i++){var s=e[i],r=this.buildKeyFromInput(s);this.has(r)&&n.push(s)}return n},complement:function(e,t){for(var n=t||this.cloneEmpty(),i=0;i<e.length;i++){var s=e[i],r=this.buildKeyFromInput(s);this.has(r)||n.push(s)}return n},clear:function(){var e=this.map.reset();return this.trigger(Xe.Events.Cleared,[this]),e},reset:function(e,t){var n=this.map;if(n.reset(),E(e))for(var i=0;i<e.length;i++){var s=e[i],r=this.parseModel(s,t);r&&n.put(r.$key(),r)}else if(y(e)){var r=this.parseModel(e,t);r&&n.put(r.$key(),r)}return this.trigger(Xe.Events.Reset,[this]),this.sort(),this},has:function(e){return this.map.has(e)},get:function(e){return this.map.get(e)},put:function(e,t,n){this.map.put(e,t),this.trigger(Xe.Events.Add,[this,t,this.map.indices[e]]),n||this.sort()},add:function(e,t,n){var i=this.parseModel(e,n),s=i.$key();return this.map.put(s,i),this.trigger(Xe.Events.Add,[this,i,this.map.indices[s]]),t||this.sort(),this},push:function(){for(var e=qt.slice.apply(arguments),t=[],n=0;n<e.length;n++){var i=this.parseModel(e[n]),s=i.$key();this.map.put(s,i),t.push(this.map.indices[s])}return this.trigger(Xe.Events.Adds,[this,e,t]),this.sort(),this.length},unshift:function(){return this.push.apply(this,arguments)},addAll:function(e,t,n){if(E(e)){for(var i=[],s=0;s<e.length;s++){var r=this.parseModel(e[s],n),a=r.$key();this.map.put(a,r),i.push(this.map.indices[a])}this.trigger(Xe.Events.Adds,[this,e,i]),t||this.sort()}},insertAt:function(e,t,n){return this.add(t,n)},pop:function(e){var t=this.length-1,n=this[t];return this.map.removeAt(t),this.trigger(Xe.Events.Remove,[this,n,t]),e||this.sort(),n},shift:function(e){var t=this[0];return this.map.removeAt(0),this.trigger(Xe.Events.Remove,[this,t,0]),e||this.sort(),t},removeAt:function(e,t){var n;return e>=0&&e<this.length&&(n=this[e],this.map.removeAt(e),this.trigger(Xe.Events.Remove,[this,n,e]),t||this.sort()),n},remove:function(e,t){var n=this.buildKeyFromInput(e),i=this.map.get(n);if(i){var s=this.map.indices[n];this.map.remove(n),this.trigger(Xe.Events.Remove,[this,i,s]),t||this.sort()}return i},removeAll:function(e,t){for(var n=this.map,i=[],s=[],r=0;r<e.length;r++){var a=this.buildKeyFromInput(e[r]),o=n.get(a);o&&(s.push(n.indices[a]),i.push(o))}s.sort();for(var r=s.length-1;r>=0;r--)n.removeAt(s[r]);return this.trigger(Xe.Events.Removes,[this,i,s]),t||this.sort(),i},indexOf:function(e){var n=this.buildKeyFromInput(e),i=this.map.indices[n];return i===t?-1:i},rebuild:function(){this.map.rebuildIndex()},keys:function(){return this.map.keys},reverse:function(){return this.map.reverse(),this.trigger(Xe.Events.Updates,[this]),this},splice:function(e,t){for(var n=qt.slice.call(arguments,2),i=[e,t],s=0;s<n.length;s++)i.push(this.buildKeyFromInput(n[s]));var r=qt.splice.apply(this,arguments);return qt.splice.apply(this.map.keys,i),t&&this.trigger(Xe.Events.Removes,[this,r,e,t]),n.length&&this.trigger(Xe.Events.Adds,[this,n,e]),this.sort(),r},removeWhere:function(e,t,n,i,s,r,a,o){var u=pe(t,n,i),h=s||this.cloneEmpty(),l=[];return Ce(function(){for(var t=0;t<this.length;t++){var n=this[t];u(n)&&(l.push(t),h.push(n))}for(var t=0;t<h.length;t++){var n=h[t],i=n.$key();this.map.remove(i),e&&n.$remove(a,o)}},this),this.trigger(Xe.Events.Removes,[this,h,l]),r||this.sort(),h},update:function(e,t,n,i,s,r){return Ce(function(){for(var a=0;a<this.length;a++){var o=this[a];o.$set(e,t,n),i||o.$save(s,r)}},this),this.trigger(Xe.Events.Updates,[this,this]),this.sort(),this},updateWhere:function(e,t,n,i,s,r,a){var o=[];return Ce(function(){for(var u=0;u<this.length;u++){var h=this[u];e(h)&&(h.$set(t,n,i),s||h.$save(r,a),o.push(h))}},this),this.trigger(Xe.Events.Updates,[this,o]),this.sort(),o},pushWhere:function(e,t,n,i){function s(t){t.$push(e)}return this.eachWhere(s,t,n,i)},popWhere:function(e,t,n,i){function s(t){t.$pop(e)}return this.eachWhere(s,t,n,i)},discardWhere:function(e,t,n){function i(e){e.$discard()}return this.eachWhere(i,e,t,n)},cancelWhere:function(e,t,n,i){function s(t){t.$cancel(e)}return Ce(function(){this.eachWhere(s,t,n,i)},this),this},refreshWhere:function(e,t,n,i,s){function r(e){e.$refresh(i,s)}return Ce(function(){this.eachWhere(r,e,t,n)},this),this},saveWhere:function(e,t,n,i,s,r){function a(e){e.$save(i,s,r)}return Ce(function(){this.eachWhere(a,e,t,n)},this),this},hasChanges:function(e,t,n){var i=pe(e,t,n),s=function(e){return i(e)&&e.$hasChanges()};return this.contains(s)},getChanges:function(e,t,n,i){var s=pe(e,t,n),r=i&&i instanceof tt?i:this.cloneEmpty();return this.each(function(e){s(e)&&e.$hasChanges()&&r.put(e.$key(),e.$getChanges())}),r},project:function(e,t){for(var n=t||[],i=Qe.parse(this.database,e),s=0;s<this.length;s++)n.push(i.project(this[s]));return n},toObject:function(e){return this.map.toObject(e)},clone:function(e,t){var n=this;if(e){n=[];for(var i=0;i<this.length;i++)n[i]=this[i].$clone(t)}return tt.create(this.database,n,!0)},cloneEmpty:function(){return tt.create(this.database)}}),Bt.extend(tt,nt,{bind:function(){En.bind.apply(this),Bt.props(this,{onModelUpdated:b(this,this.handleModelUpdate)})},init:function(e,t){return this.base&&this.base.database.off(Fe.Events.ModelUpdated,this.onModelUpdated),tt.prototype.init.call(this,e.database),En.init.call(this,e,t),e.database.on(Fe.Events.ModelUpdated,this.onModelUpdated),this},setFilter:En.setFilter,connect:En.connect,disconnect:En.disconnect,sync:En.sync,handleModelUpdate:function(e){var t=this.has(e.$key()),n=this.filter(e);t&&!n&&this.remove(e),!t&&n&&this.add(e)},clone:En.clone,cloneEmpty:En.cloneEmpty}),Bt.extend(tt,it,{set:function(e,t){return this.relator.set(this.model,e,t),this},relate:function(e,t){return this.relator.relate(this.model,e,t),this},unrelate:function(e,t){return this.relator.unrelate(this.model,e,t),this},sync:function(e){return this.relator.sync(this.model,e),this},unrelateWhere:function(e,t,n){return this.unrelate(this.where(e,t,n,[]))},isRelated:function(e){return this.relator.isRelated(this.model,e)},clone:function(){return it.create(this.database,this.model,this.relator,this,!0)},cloneEmpty:function(){return it.create(this.database,this.model,this.relator)}}),rt.Defaults={},Bt.create(rt,{$getDefaults:function(){return rt.Defaults},$init:function(e,t,n,i,s){V(this,n,this.$getDefaults(),!0),Bt.prop(this,"$db",e),this.$append=!1,this.$url=t,this.$set(i),this.$results=tt.create(e),this.$results.$search=this,this.$promise=ot.resolve(this),s&&this.$run()},$set:function(e){return y(e)&&B(e,this),this},$unset:function(){for(var e in this)"$"!==e.charAt(0)&&delete this[e];return this},$run:function(e,t){this.$url=e||this.$url,this.$set(t);var n=new ot,i=this.$encode(),s=b(this,this.$handleSuccess(n)),r=b(this,this.$handleFailure(n)),a=this.$options||this.$db.queryOptions;return Ce(function(){this.$cancel(),this.$promise=n,this.$db.rest.query(this.$url,i,a,s,r)},this),this.$promise},$handleSuccess:function(e){return function(t){if(this.$promise.isPending()&&e===this.$promise){var n=this.$decode.apply(this,arguments);this.$append?this.$results.addAll(n,!1,!0):this.$results.reset(n,!0),this.$promise.resolve(this,t,this.$results)}}},$handleFailure:function(e){return function(t,n){if(this.$promise.isPending()&&e===this.$promise){var i=on.Offline[n];i&&(Se.checkNetworkStatus(),i=!Se.online),i?this.$promise.noline(this,t,n):this.$promise.reject(this,t,n)}}},$cancel:function(){this.$promise.cancel()},$clear:function(){this.$results.clear()},$encode:function(){return X(Z(this))},$decode:function(e){return e},$key:function(){return""},$change:function(e,t){return this.$results.change(e,t)}}),at.Defaults={page_size:10,page_index:0,total:0},Bt.extend(rt,at,{$getDefaults:function(){return at.Defaults},$goto:function(e,t){var n=this.$getPageIndex(),i=this.$getPageCount(),s=Math.max(0,Math.min(e,i-1));return n!==s&&(this.$setPageIndex(s),t||(this.$append=!1,this.$run())),this.$promise},$more:function(){var e=this.$getPageIndex()+1;return e<this.$getPageCount()&&(this.$setPageIndex(e),this.$append=!0,this.$run(),this.$promise.complete(this.$onMoreEnd,this)),this.$promise},$onMoreEnd:function(){this.$append=!1},$first:function(e){return this.$goto(0,e)},$last:function(e){return this.$goto(this.$getPageCount()-1,e)},$prev:function(e){return this.$goto(this.$getPageIndex()-1,e)},$next:function(e){return this.$goto(this.$getPageIndex()+1,e)},$total:function(){return this.$getTotal()},$pages:function(){return this.$getPageCount()},$page:function(e){return Math.max(0,Math.min(e,this.$pages()-1))},$can:function(e){return this.$getTotal()&&e>=0&&e<this.$getPageCount()},$canFirst:function(){return this.$canPrev()},$canLast:function(){return this.$canNext()},$canPrev:function(){return this.$getTotal()&&this.$getPageIndex()>0},$canNext:function(){return this.$getTotal()&&this.$getPageIndex()<this.$getPageCount()-1},$decode:function(e){return this.$updatePageSize(e),this.$updatePageIndex(e),this.$updateTotal(e),this.$decodeResults(e)},$decodeResults:function(e){return e.results},$updatePageSize:function(e){v(e.page_size)&&(this.page_size=e.page_size)},$setPageSize:function(e){this.page_size=e},$getPageSize:function(){return this.page_size},$updatePageIndex:function(e){v(e.page_index)&&(this.page_index=e.page_index)},$setPageIndex:function(e){this.page_index=e||0},$getPageIndex:function(){return this.page_index},$getPageOffset:function(){return this.page_index*this.page_size},$updateTotal:function(e){v(e.total)&&(this.total=e.total)},$setTotal:function(e){this.total=e||0},$getTotal:function(){return this.total},$getPageCount:function(){return Math.ceil(this.$getTotal()/this.$getPageSize())}}),ot.Status={Pending:"pending",Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled"},ot.Events={Success:"success",Failure:"failure",Offline:"offline",Canceled:"canceled",Unsuccessful:"failure offline canceled",Complete:"success failure offline canceled"},ot.all=function(e){function t(){r.push(qt.slice.apply(arguments)),++i===s&&n.resolve(r)}for(var n=new ot,i=0,s=e.length,r=[],a=0;a<e.length;a++){var o=e[a];o instanceof ot?o.then(t,n.reject,n.noline,n.cancel,n):s--}return n},ot.race=function(e){for(var t=new ot,n=0;n<e.length;n++){var i=e[n];i instanceof ot&&i.bind(t)}return t},ot.reject=function(e){var t=new ot;return t.reject.apply(t,arguments),t},ot.resolve=function(){var e=new ot;return e.resolve.apply(e,arguments),e},ot.noline=function(e){var t=new ot;return t.noline.apply(t,arguments),t},ot.cancel=function(){var e=new ot;return e.cancel.apply(e,arguments),e},ot.then=function(){var e=new ot;return e.resolve(),e.then.apply(e,arguments)},ot.singularity=function(){function e(){++a===r&&n.resolve(i)}function t(t){r++,t.then(e,n.reject,n.noline,null,n)}var n=null,i=null,s=!1,r=0,a=0;return function(e,o,u){var h=e,l=o,c=u;if(h instanceof ot||(h=!1,l=e,c=o),s)h&&t(h),c.call(l,n);else{s=!0,n=new ot(null,!1),i=l,r=0,a=0,h&&t(h);try{c.call(l,n)}catch(d){throw Se.trigger(Se.Events.Error,[d]),d}finally{s=!1}}return 0===r&&n.resolve(),n}}(),Bt.create(ot,{resolve:function(){this.finish(ot.Status.Success,ot.Events.Success,arguments)},reject:function(){this.finish(ot.Status.Failure,ot.Events.Failure,arguments)},noline:function(){this.finish(ot.Status.Offline,ot.Events.Offline,arguments)},cancel:function(){this.cancelable&&this.finish(ot.Status.Canceled,ot.Events.Canceled,arguments)},bind:function(e){this.success(e.resolve,e),this.failure(e.reject,e),this.offline(e.noline,e),this.canceled(e.cancel,e)},then:function(e,t,n,i,s,r){var a=new ot;return this.success(e,s,r,a),this.failure(t,s,r,a),this.offline(n,s,r,a),this.canceled(i,s,r,a),this.addNext(a),a},addNext:function(e){var t=this.nexts;0===t.length&&this.unsuccessful(function(){for(var e=0;e<t.length;e++)t[e].finish(this.status,this.status,arguments)}),t.push(e)},reset:function(e){return this.status=ot.Status.Pending,e&&this.off(),this},finish:function(e,t,n){this.status===ot.Status.Pending&&(this.results=qt.slice.apply(n),this.status=e,this.trigger(t,n))},listenFor:function(e,t,n,i,s,r){if(c(n)){var a=function(){var e=n.apply(i||this,this.results);e instanceof ot&&r instanceof ot&&r.isPending()&&e.bind(r)};this.status===ot.Status.Pending?s?this.on(t,a,this):this.once(t,a,this):e&&a.apply(this)}return this},success:function(e,t,n,i){return this.listenFor(this.isSuccess(),ot.Events.Success,e,t,n,i)},unsuccessful:function(e,t,n,i){return this.listenFor(this.isUnsuccessful(),ot.Events.Unsuccessful,e,t,n,i)},failure:function(e,t,n,i){return this.listenFor(this.isFailure(),ot.Events.Failure,e,t,n,i)},"catch":function(e,t,n,i){return this.listenFor(this.isFailure(),ot.Events.Failure,e,t,n,i)},offline:function(e,t,n,i){return this.listenFor(this.isOffline(),ot.Events.Offline,e,t,n,i)},canceled:function(e,t,n,i){return this.listenFor(this.isCanceled(),ot.Events.Canceled,e,t,n,i)},complete:function(e,t,n,i){return this.listenFor(!0,ot.Events.Complete,e,t,n,i)},isSuccess:function(){return this.status===ot.Status.Success},isUnsuccessful:function(){return this.status!==ot.Status.Success&&this.status!==ot.Status.Pending},isFailure:function(){return this.status===ot.Status.Failure},isOffline:function(){return this.status===ot.Status.Offline},isCanceled:function(){return this.status===ot.Status.Canceled},isPending:function(){return this.status===ot.Status.Pending},isComplete:function(){return this.status!==ot.Status.Pending}}),w(ot),Bt.create(ut,{reset:function(e,t,n){this.model=e,this.cascade=v(t)?t:rn.All,this.options=n,this.db=e.$db,this.next=null,this.finished=!1},canCascade:function(e){var t=e||this.cascading,n=this.cascade;return 0!==(t&n)},notCascade:function(e){var t=this.cascade;return 0===(e&t)},queue:function(e){this.next&&!e.interrupts?this.next.queue(e):(this.next=e,this.model.$trigger(Ye.Events.OperationsStarted))},tryNext:function(e){var t=!this.next;return t&&(this.next=new e(this.model,this.cascade,this.options)),t},insertNext:function(e){var t=new e(this.model,this.cascade,this.options);t.next=this.next,this.next=t},execute:function(){0===this.db.pendingOperations&&this.db.trigger(Fe.Events.OperationsStarted),this.db.pendingOperations++;try{this.run(this.db,this.model)}catch(e){throw this.finish(),Se.trigger(Se.Events.Error,[e]),e}},run:function(e,t){throw"Operation.run Not implemented"},finish:function(){return this.finished||(this.finished=!0,this.model.$operation=this.next,this.next&&this.next.execute(),this.db.pendingOperations--,this.next||this.model.$trigger(Ye.Events.OperationsFinished),0===this.db.pendingOperations&&(this.db.onOperationRest(),this.db.trigger(Fe.Events.OperationsFinished))),this},success:function(){return b(this,this.handleSuccess)},handleSuccess:function(){try{this.onSuccess.apply(this,arguments)}catch(e){throw Se.trigger(Se.Events.Error,[e]),e}finally{this.finish()}},onSuccess:function(){},failure:function(){return b(this,this.handleFailure)},handleFailure:function(){try{this.onFailure.apply(this,arguments)}catch(e){throw Se.trigger(Se.Events.Error,[e]),e}finally{this.finish()}},onFailure:function(){}}),Bt.extend(ut,ht,{cascading:rn.Local,interrupts:!1,type:"GetLocal",run:function(e,t){t.$isDeleted()?(t.$trigger(Ye.Events.LocalGetFailure,[t]),this.finish()):this.canCascade()&&e.cache===sn.All?e.store.get(t.$key(),this.success(),this.failure()):(Se.debug(Se.Debugs.GET_LOCAL_SKIPPED,t),t.$trigger(Ye.Events.LocalGet,[t]),this.insertNext(lt),this.finish())},onSuccess:function(e,t){var n=this.model;y(t)&&n.$set(t),Se.debug(Se.Debugs.GET_LOCAL,n,t),n.$trigger(Ye.Events.LocalGet,[n]),this.canCascade(rn.Rest)&&!n.$isDeleted()&&this.insertNext(lt)},onFailure:function(e){var t=this.model;Se.debug(Se.Debugs.GET_LOCAL,t,e),t.$trigger(Ye.Events.LocalGetFailure,[t]),this.canCascade(rn.Rest)&&!t.$isDeleted()&&this.insertNext(lt)}}),Bt.extend(ut,lt,{cascading:rn.Rest,interrupts:!1,type:"GetRemote",run:function(e,t){t.$isDeleted()?(t.$trigger(Ye.Events.RemoteGetFailure,[t]),this.finish()):this.canCascade()?Ce(function(){e.rest.get(t,this.options||e.getOptions,this.success(),this.failure())},this):(t.$trigger(Ye.Events.RemoteGet,[t]),this.finish())},onSuccess:function(e){var t=this.db,n=t.resolveModel(e),i=this.model;y(n)&&t.putRemoteData(n,i.$key(),i,!0),Se.debug(Se.Debugs.GET_REMOTE,i,n),i.$trigger(Ye.Events.RemoteGet,[i])},onFailure:function(e,t){var n=this.db,i=this.model;Se.debug(Se.Debugs.GET_REMOTE_ERROR,i,e,t),on.NotFound[t]?(this.insertNext(ft),n.destroyModel(i),i.$trigger(Ye.Events.RemoteGetFailure,[i,e])):on.Offline[t]?i.$trigger(Ye.Events.RemoteGetOffline,[i,e]):i.$trigger(Ye.Events.RemoteGetFailure,[i,e])}}),Bt.extend(ut,ct,{cascading:rn.None,interrupts:!0,type:"RemoveCache",run:function(e,t){e.cache===sn.None?this.finish():e.store.remove(t.$key(),this.success(),this.failure())}}),Bt.extend(ut,dt,{cascading:rn.Local,interrupts:!0,type:"RemoveLocal",run:function(e,t){t.$status=Ye.Status.RemovePending,e.cache!==sn.None&&t.$local&&this.canCascade()?t.$saved&&this.canCascade(rn.Rest)?(t.$local.$status=t.$status,e.store.put(t.$key(),t.$local,this.success(),this.failure())):(Se.debug(Se.Debugs.REMOVE_LOCAL_UNSAVED,t),e.store.remove(t.$key(),this.success(),this.failure())):(Se.debug(Se.Debugs.REMOVE_LOCAL_NONE,t),t.$trigger(Ye.Events.LocalRemove,[t]),this.insertNext(vt),this.finish())},onSuccess:function(e,t,n){var i=this.model;Se.debug(Se.Debugs.REMOVE_LOCAL,i),i.$trigger(Ye.Events.LocalRemove,[i]),i.$saved&&this.canCascade(rn.Remote)&&i.$addOperation(vt,this.cascade,this.options)},onFailure:function(e){var t=this.model;Se.debug(Se.Debugs.REMOVE_LOCAL_ERROR,t,e),t.$trigger(Ye.Events.LocalRemoveFailure,[t]),t.$saved&&this.canCascade(rn.Remote)&&t.$addOperation(vt,this.cascade,this.options)}}),Bt.extend(ut,ft,{cascading:rn.Local,interrupts:!0,type:"RemoveNow",run:function(e,t){var n=t.$key();t.$status=Ye.Status.RemovePending,e.removeFromModels(t),e.cache!==sn.None&&this.canCascade()?e.store.remove(n,this.success(),this.failure()):(this.finishRemove(),this.finish())},onSuccess:function(){this.finishRemove()},onFailure:function(){this.finishRemove()},finishRemove:function(){var e=this.model;e.$status=Ye.Status.Removed,delete e.$local,delete e.$saving,delete e.$publish,delete e.$saved}}),Bt.extend(ut,vt,{cascading:rn.Remote,interrupts:!0,type:"RemoveRemote",run:function(e,t){this.notCascade(rn.Rest)?(this.liveRemove(),t.$trigger(Ye.Events.RemoteRemove,[t]),this.finish()):(t.$status=Ye.Status.RemovePending,Ce(function(){e.rest.remove(t,this.options||this.removeOptions,this.success(),this.failure())},this))},onSuccess:function(e){this.finishRemove()},onFailure:function(e,t){var n=this.model,i=n.$key();on.NotFound[t]?(Se.debug(Se.Debugs.REMOVE_MISSING,n,i),this.finishRemove(!0)):on.Offline[t]?(Se.checkNetworkStatus(),Se.online?n.$trigger(Ye.Events.RemoteRemoveFailure,[n,e]):(n.$listenForOnline(this.cascade),n.$trigger(Ye.Events.RemoteRemoveOffline,[n,e])),Se.debug(Se.Debugs.REMOVE_OFFLINE,n,e)):(Se.debug(Se.Debugs.REMOVE_ERROR,n,t,i,e),n.$trigger(Ye.Events.RemoteRemoveFailure,[n,e]))},finishRemove:function(e){var t=this.db,n=this.model,i=n.$key();Se.debug(Se.Debugs.REMOVE_REMOTE,n,i),n.$status=Ye.Status.Removed,n.$trigger(Ye.Events.RemoteRemove,[n]),this.insertNext(ft),e||this.liveRemove(),t.removeReference(i)},liveRemove:function(){if(this.canCascade(rn.Live)){var e=this.db,t=this.model,n=t.$key();Se.debug(Se.Debugs.REMOVE_PUBLISH,t,n),e.live.remove(t)}}}),Bt.extend(ut,gt,{cascading:rn.Local,interrupts:!1,type:"SaveLocal",run:function(e,t){if(t.$isDeleted())Se.debug(Se.Debugs.SAVE_LOCAL_DELETED,t),t.$trigger(Ye.Events.LocalSaveFailure,[t]),this.finish();else if(e.cache!==sn.None&&this.canCascade()){var n=t.$key(),i=t.$toJSON(!1);this.markSaving(e,t),t.$local?B(i,t.$local):(t.$local=i,t.$saved&&(t.$local.$saved=t.$saved)),t.$local.$status=t.$status,t.$local.$saving=t.$saving,t.$local.$publish=t.$publish,e.store.put(n,t.$local,this.success(),this.failure())}else this.canCascade(rn.Remote)&&this.tryNext(mt)&&this.markSaving(e,t),t.$trigger(Ye.Events.LocalSave,[t]),this.finish()},markSaving:function(e,t){var n=t.$toJSON(!0),i=t.$getChanges(n),s=e.fullSave?n:this.grabAlways(e.saveAlways,i,n),r=e.fullPublish?n:this.grabAlways(e.publishAlways,i,n);t.$status=Ye.Status.SavePending,t.$saving=s,t.$publish=r},grabAlways:function(e,t,n){var i=null;if(e.length)for(var s=0;s<e.length;s++){var r=e[s];r in t||(i||(i=Z(t)),i[r]=n[r])}return i||t},clearLocal:function(e){e.$status=Ye.Status.Synced,e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish,this.insertNext(pt)},onSuccess:function(e,t,n){var i=this.model;Se.debug(Se.Debugs.SAVE_LOCAL,i),this.cascade?this.tryNext(mt):this.clearLocal(i),i.$trigger(Ye.Events.LocalSave,[i])},onFailure:function(e){var t=this.model;Se.debug(Se.Debugs.SAVE_LOCAL_ERROR,t,e),this.cascade?this.tryNext(mt):this.clearLocal(t),t.$trigger(Ye.Events.LocalSaveFailure,[t])}}),Bt.extend(ut,pt,{cascading:rn.Local,interrupts:!1,type:"SaveNow",run:function(e,t){var n=t.$key(),i=t.$local;e.cache===sn.All&&n&&i&&this.canCascade()?e.store.put(n,i,this.success(),this.failure()):this.finish()}}),Bt.extend(ut,mt,{cascading:rn.Remote,interrupts:!1,type:"SaveRemote",run:function(e,t){t.$isDeleted()?(Se.debug(Se.Debugs.SAVE_REMOTE_DELETED,t),this.markSynced(t,!0,Ye.Events.RemoteSaveFailure,null),this.finish()):t.$dependents.isSaved(this.tryAgain,this)?!e.hasData(t.$saving)||this.notCascade(rn.Rest)?(this.liveSave(),this.markSynced(t,!0,Ye.Events.RemoteSave,null),this.finish()):(t.$status=Ye.Status.SavePending,Ce(function(){t.$saved?e.rest.update(t,t.$saving,this.options||e.updateOptions||e.saveOptions,this.success(),this.failure()):e.rest.create(t,t.$saving,this.options||e.createOptions||e.saveOptions,this.success(),this.failure())},this)):this.finish()},onSuccess:function(e){var t=this.db,n=t.resolveModel(e),i=this.model;Se.debug(Se.Debugs.SAVE_REMOTE,i),this.handleData(n)},onFailure:function(e,t){var n=this.db,i=n.resolveModel(e),s=this.model;on.Conflict[t]?(Se.debug(Se.Debugs.SAVE_CONFLICT,s,i),this.handleData(i)):on.NotFound[t]?(Se.debug(Se.Debugs.SAVE_UPDATE_FAIL,s),this.insertNext(ft),n.destroyModel(s),s.$trigger(Ye.Events.RemoteSaveFailure,[s,e])):on.Offline[t]?(Se.checkNetworkStatus(),Se.online?this.markSynced(s,!0,Ye.Events.RemoteSaveFailure,e):(s.$listenForOnline(this.cascade),s.$trigger(Ye.Events.RemoteSaveOffline,[s,e])),Se.debug(Se.Debugs.SAVE_OFFLINE,s,e)):(Se.debug(Se.Debugs.SAVE_ERROR,s,t),this.markSynced(s,!0,Ye.Events.RemoteSaveFailure,e))},markSynced:function(e,t,n,i){e.$status=Ye.Status.Synced,this.clearPending(e),t&&this.insertNext(pt),n&&e.$trigger(n,[e,i])},clearPending:function(e){delete e.$saving,delete e.$publish,e.$local&&(e.$local.$status=e.$status,delete e.$local.$saving,delete e.$local.$publish)},handleData:function(e){var t=this.db,n=this.model,i=n.$saving;return n.$isDeleted()?(Se.debug(Se.Debugs.SAVE_REMOTE_DELETED,n,e),this.clearPending(n)):(Se.debug(Se.Debugs.SAVE_VALUES,n,i),n.$saved||(n.$saved=n.$local?n.$local.$saved={}:{}),B(i,n.$saved),M(e)||t.putRemoteData(e,n.$key(),n),this.liveSave(e),this.markSynced(n,!1,Ye.Events.RemoteSave,null),void(t.cache===sn.Pending?this.insertNext(ct):this.insertNext(pt)))},liveSave:function(e){var t=this.db,n=this.model;y(e)&&B(e,n.$publish),this.canCascade(rn.Live)&&t.hasData(n.$publish)&&(Se.debug(Se.Debugs.SAVE_PUBLISH,n,n.$publish),t.live.save(n,n.$publish))},tryAgain:function(){var e=this.model;e.$addOperation(gt,this.cascade,this.options)}}),Se.Relations={},Et.Defaults={model:null,lazy:!1,store:hn.None,save:un.None,auto:!0,autoCascade:rn.All,autoOptions:null,property:!0,preserve:!0,clearKey:!0,dynamic:!1,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},Bt.create(Et,{debugQuery:null,debugQueryResults:null,getDefaults:function(e,t,n){return Et.Defaults},init:function(e,t,n){if(V(this,n,this.getDefaults(e,t,n)),this.database=e,this.name=t,this.options=n,this.initialized=!1,this.property=this.property||i(e.fields,this.name)!==!1,this.discriminated=!M(this.discriminators),this.discriminated){if(!yn)throw"Polymorphic feature is required to use the discriminated option.";Bt.props(this,yn)}this.setReferences(e,t,n)},setReferences:function(e,t,n){d(this.model)?this.onInitialized(e,t,n):Se.get(this.model).complete(this.setModelReference(e,t,n),this)},setModelReference:function(e,t,n){return function(i){this.model=i,this.onInitialized(e,t,n)}},onInitialized:function(e,t,n){},finishInitialization:function(){this.initialized=!0,this.load.open()},load:Ie(function(e,t,n){}),set:function(e,t,n){},relate:function(e,t,n){},unrelate:function(e,t,n){},sync:function(e,t){},isRelated:function(e,t){},preClone:function(e,t,n){},postClone:function(e,t,n){},get:function(e){return e.$relations[this.name].related},encode:function(e,t,n){var i=e.$relations[this.name],s=n?this.save:this.store;if(i&&s){var r=i.related;E(r)?t[this.name]=this.getStoredArray(r,s):t[this.name]=this.getStored(r,s)}},ready:function(e){this.model.Database.ready(e,this)},listenToModelAdded:function(e){this.model.Database.on(Fe.Events.ModelAdded,e,this)},executeQuery:function(e){if(!rt)throw"Search feature is required to use the query option.";var t=this.query,n=this.queryOptions,i=this.queryData,s=f(t)?re(t,e):t,r=this.model.search(s,n,i);Se.debug(this.debugQuery,this,e,r,t,s,i);var a=r.$run();return a.complete(this.handleExecuteQuery(e),this),r},handleExecuteQuery:function(e){return function(t){var n=t.$results;Se.debug(this.debugQueryResults,this,e,t);for(var i=0;i<n.length;i++)this.relate(e,n[i],!0)}},createRelationCollection:function(e){return it.create(this.model.Database,e,this)},createCollection:function(e){return tt.create(this.model.Database,e)},parseModel:function(e,t){return this.model.Database.parseModel(e,t)},grabInitial:function(e,t){return G(e,t,R)?q(e,t):void 0},grabModel:function(e,t,n){this.model.Database.grabModel(e,t,this,n)},grabModels:function(e,t,n,i){for(var s=this.model.Database,r=0;r<t.length;r++){var a=t[r],o=s.keyHandler.buildKeyFromInput(a);e.pending[o]=!0,a instanceof Ye?n.call(this,a):s.grabModel(a,n,this,i)}},buildKey:function(e){},setProperty:function(e){if(this.property){var t=e.parent,n=this.name,i=!!e.dynamicSet;if(!i&&this.dynamic&&Object.defineProperty){var s=this;Object.defineProperty(t,n,{enumerable:!0,set:function(e){s.set(t,e)},get:function(){return e.related}}),i=e.dynamicSet=!0}i||(t[n]=e.related),e.lastRelated!==e.related&&(t.$trigger(Ye.Events.RelationUpdate,[this,e]),e.lastRelated=e.related)}},isModelArray:function(e){if(!E(e))return!1;var t=this.model.Database,n=t.key;if(!E(n))return!0;if(n.length!==e.length)return!0;for(var i=0;i<e.length;i++)if(!v(e[i])&&!f(e[i]))return!0;return!1},clearFields:function(e,t,n,i){var s=z(e,t);return s&&!n&&this.auto&&!e.$isNew()&&e.$save(i||this.autoCascade,this.autoOptions),s},updateFields:function(e,t,n,i,s){var r=j(e,t,n,i);return r&&(!this.auto||e.$isNew()||s||e.$save(this.autoCascade,this.autoOptions),
e.$trigger(Ye.Events.KeyUpdate,[e,n,t,i])),r},updateForeignKey:function(e,t,n){var i=this.getTargetFields(e),s=this.getSourceFields(t),r=e.$key(),a=e.$db.keyHandler,o=e.$db.keyChanges;if(Se.debug(this.debugUpdateKey,this,e,i,t,s),this.updateFields(e,i,t,s,n),o&&n){var u=a.getKey(e,!0);a.inKey(i)&&u!==r&&e.$setKey(u,!0)}},clearForeignKey:function(e,t){var n=this.getTargetFields(e);Se.debug(this.debugClearKey,this,e,n),this.clearFields(e,n,t)},getTargetFields:function(e){return e.$db.key},getSourceFields:function(e){return e.$db.key},getStoredArray:function(e,t){if(!t)return null;for(var n=[],i=0;i<e.length;i++){var s=this.getStored(e[i],t);null!==s&&n.push(s)}return n},getStored:function(e,t){if(e)switch(t){case un.Model:return e.$toJSON(!0);case hn.Model:if(e.$local)return e.$local;var n=e.$toJSON(!1);return e.$saved&&(n.$saved=e.$saved),n;case un.Key:case hn.Key:return e.$key();case un.Keys:case hn.Keys:return e.$keys()}return null}}),Bt.extend(Et,yt,{debugInit:null,debugClearModel:null,debugSetModel:null,debugLoaded:null,debugClearKey:null,debugUpdateKey:null,onInitialized:function(e,t,n){if(!this.discriminated){var i=this.model.Database;this.local=this.local||i.name+"_"+i.key}Se.debug(this.debugInit,this),this.finishInitialization()},set:function(e,n,i){if(M(n))this.unrelate(e,t,i);else{var s=e.$relations[this.name],r=this.parseModel(n,i);r&&s.related!==r&&(this.clearModel(s,i),this.setRelated(s,r,i))}},relate:function(e,t,n){var i=e.$relations[this.name],s=this.parseModel(t,n);s&&i.related!==s&&(this.clearModel(i,n),this.setRelated(i,s,n))},unrelate:function(e,t,n){var i=e.$relations[this.name],s=this.parseModel(t);s&&i.related!==s||this.clearRelated(i,n)},isRelated:function(e,t){var n=e.$relations[this.name],i=this.parseModel(t);return i===n.related},setRelated:function(e,t,n){t.$isDeleted()||(this.setModel(e,t),this.updateForeignKey(e.parent,t,n),this.setProperty(e))},clearRelated:function(e,t,n){if(t){var i=e.related;if(i&&i.$isSaving())return}this.clearModel(e,t,n),this.setProperty(e)},clearModel:function(e,t,n){var i=e.related;i&&(Se.debug(this.debugClearModel,this,e),e.onSaved&&i.$off(Ye.Events.Saved,e.onSaved),e.onRemoved&&i.$off(Ye.Events.Removed,e.onRemoved),e.related=null,e.dirty=!0,e.loaded=!0,e.parent.$dependents.remove(i),n||t||this.clearKey&&this.clearForeignKey(e.parent,t))},setModel:function(e,t){e.onSaved&&t.$on(Ye.Events.Saved,e.onSaved,this),e.onRemoved&&t.$on(Ye.Events.Removed,e.onRemoved,this),e.related=t,e.dirty=!0,e.loaded=!0,this.isDependent(e,t)&&e.parent.$dependents.add(t,this),Se.debug(this.debugSetModel,this,e)},isDependent:function(e,t){return!0},handleModel:function(e,t,n){return function(i){var s=e.parent;Se.debug(this.debugLoaded,this,s,e,i),(e.loaded===!1||n)&&(i&&!i.$isDeleted()?(this.setModel(e,i,t),this.updateForeignKey(s,i,t)):this.query?e.query=this.executeQuery(s):this.preserve||this.clearForeignKey(s,t),e.loaded=!0,this.setProperty(e))}},isRelatedFactory:function(e){var t=this.local;return function(n){return Y(e,t,n,n.$db.key)}},getTargetFields:function(e){return this.local},buildKey:function(e){var t=e[this.name],n=this.local;if(y(t)&&this.model){var i=this.model.Database,s=i.key;i.keyHandler.copyFields(e,n,t,s)}}}),Bt.extend(Et,Rt,{debugAutoSave:null,debugInitialGrabbed:null,debugSort:null,handleExecuteQuery:function(e){return function(t){var n=e.$relations[this.name],i=t.$results;Se.debug(this.debugQueryResults,this,e,t),this.bulk(n,function(){for(var e=0;e<i.length;e++)this.addModel(n,i[e],!0)}),this.sort(n),this.checkSave(n,!0)}},bulk:function(e,t,n){e.delaySorting=!0,e.delaySaving=!0,t.apply(this),e.delaySorting=!1,e.delaySaving=!1,this.sort(e),this.checkSave(e,n)},set:function(e,n,i){if(M(n))this.unrelate(e,t,i);else{var s=e.$relations[this.name],r=s.related,a=this.createCollection();if(this.isModelArray(n))for(var o=0;o<n.length;o++){var u=this.parseModel(n[o],i);u&&a.add(u)}else{var u=this.parseModel(n,i);u&&a.add(u)}var h=r.subtract(a),l=a.subtract(r);this.bulk(s,function(){for(var e=0;e<l.length;e++)this.addModel(s,l[e],i);for(var e=0;e<h.length;e++)this.removeModel(s,h[e],i)},i)}},relate:function(e,t,n){var i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e],n);s&&this.addModel(i,s,n)}});else if(R(t)){var s=this.parseModel(t,n);s&&this.addModel(i,s,n)}},unrelate:function(e,t,n){var i=e.$relations[this.name];if(this.isModelArray(t))this.bulk(i,function(){for(var e=0;e<t.length;e++){var s=this.parseModel(t[e]);s&&this.removeModel(i,s,n)}});else if(R(t)){var s=this.parseModel(t);s&&this.removeModel(i,s,n)}else{var r=i.related;this.bulk(i,function(){for(var e=r.length-1;e>=0;e--)this.removeModel(i,r[e],n)})}},isRelated:function(e,t){var n=e.$relations[this.name],i=n.related;if(this.isModelArray(t)){for(var s=0;s<t.length;s++){var r=this.parseModel(t[s]);if(r&&!i.has(r.$key()))return!1}return t.length>0}if(R(t)){var r=this.parseModel(t);return r&&i.has(r.$key())}return!1},canRemoveRelated:function(e,t){return!t||!e.$isSaving()},checkSave:function(e,t){e.delaySaving||t||!e.parent.$exists()||this.store!==hn.Model&&this.save!==un.Model||(Se.debug(this.debugAutoSave,this,e),e.parent.$save(this.saveParentCascade,this.saveParentOptions))},handleModel:function(e,t,n){return function(i){var s=e.pending,r=i.$key();(r in s||n)&&(Se.debug(this.debugInitialGrabbed,this,e,i),this.addModel(e,i,t),delete s[r])}},sort:function(e){var t=e.related;e.delaySorting||(Se.debug(this.debugSort,this,e),t.sort(this.comparator),e.parent.$trigger(Ye.Events.RelationUpdate,[this,e]))}}),Se.Relations.belongsTo=$t,$t.Defaults={model:null,lazy:!1,query:!1,store:hn.None,save:un.None,auto:!0,autoCascade:rn.All,autoOptions:null,property:!0,preserve:!0,clearKey:!0,dynamic:!1,local:null,cascade:rn.Local,cascadeRemoveOptions:null,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},Bt.extend(yt,$t,{type:"belongsTo",debugInit:Se.Debugs.BELONGSTO_INIT,debugClearModel:Se.Debugs.BELONGSTO_CLEAR_MODEL,debugSetModel:Se.Debugs.BELONGSTO_SET_MODEL,debugLoaded:Se.Debugs.BELONGSTO_LOADED,debugClearKey:Se.Debugs.BELONGSTO_CLEAR_KEY,debugUpdateKey:Se.Debugs.BELONGSTO_UPDATE_KEY,debugQuery:Se.Debugs.BELONGSTO_QUERY,debugQueryResults:Se.Debugs.BELONGSTO_QUERY_RESULTS,getDefaults:function(e,t,n){return $t.Defaults},load:Ie(function(e,t,n){var i=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,onRemoved:function(){Se.debug(Se.Debugs.BELONGSTO_NINJA_REMOVE,this,e,i),e.$remove(this.cascade,this.cascadeRemoveOptions),this.clearRelated(i,!1,!0)},onSaved:function(){Se.debug(Se.Debugs.BELONGSTO_NINJA_SAVE,this,e,i),i.isRelated(i.related)||this.clearRelated(i,!1,!0)}};e.$on(Ye.Events.PostRemove,this.postRemove,this),e.$on(Ye.Events.KeyUpdate,this.onKeyUpdate,this),M(t)&&(t=this.grabInitial(e,this.local),t&&Se.debug(Se.Debugs.BELONGSTO_INITIAL_PULLED,this,e,t)),M(t)?this.query&&(i.query=this.executeQuery(e)):(Se.debug(Se.Debugs.BELONGSTO_INITIAL,this,e,t),this.grabModel(t,this.handleModel(i,n),n))}),sync:function(e,t){var n=e.$relations[this.name],i=this.grabInitial(e,this.local),s=!0,r=!0,a=!0;n&&(M(i)?t&&this.clearRelated(n,s,a):this.grabModel(i,this.handleModel(n,s,r),s))},postRemove:function(e){var t=e.$relations[this.name];t&&(Se.debug(Se.Debugs.BELONGSTO_POSTREMOVE,this,e,t),this.clearModel(t),this.setProperty(t))},onKeyUpdate:function(e,t,n,i){if(this.local===n){var s=e.$relations[this.name];s&&t!==s.related&&(this.clearModel(s,!1,!0),this.setModel(s,t),this.setProperty(s))}}}),Se.Relations.hasOne=bt,bt.Defaults={model:null,lazy:!1,query:!1,store:hn.None,save:un.None,saveCascade:rn.All,saveOptions:null,auto:!0,autoCascade:rn.All,autoOptions:null,property:!0,preserve:!0,clearKey:!0,dynamic:!1,local:null,cascade:rn.All,cascadeRemoveOptions:null,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},Bt.extend(yt,bt,{type:"hasOne",debugInit:Se.Debugs.HASONE_INIT,debugClearModel:Se.Debugs.HASONE_CLEAR_MODEL,debugSetModel:Se.Debugs.HASONE_SET_MODEL,debugLoaded:Se.Debugs.HASONE_LOADED,debugClearKey:Se.Debugs.HASONE_CLEAR_KEY,debugUpdateKey:Se.Debugs.HASONE_UPDATE_KEY,debugQuery:Se.Debugs.HASONE_QUERY,debugQueryResults:Se.Debugs.HASONE_QUERY_RESULTS,getDefaults:function(e,t,n){return bt.Defaults},load:Ie(function(e,t,n){var i=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),related:null,loaded:!1,dirty:!1,saving:!1,child:k(this.local,e.$db.key),onRemoved:function(){Se.debug(Se.Debugs.HASONE_NINJA_REMOVE,this,e,i),this.clearRelated(i,!1,!0)}};e.$on(Ye.Events.PreSave,this.preSave,this),e.$on(Ye.Events.PostRemove,this.postRemove,this),M(t)&&(t=this.grabInitial(e,this.local),t&&Se.debug(Se.Debugs.HASONE_INITIAL_PULLED,this,e,t)),M(t)?this.query&&(i.query=this.executeQuery(e)):(Se.debug(Se.Debugs.HASONE_INITIAL,this,e,t),this.populateInitial(t,i,e),this.grabModel(t,this.handleModel(i,n),n))}),populateInitial:function(e,t,i){if(y(e)&&t.child)for(var s=n(this.local),r=n(this.model.Database.key),a=0;a<s.length;a++)e[r[a]]=i[s[a]]},sync:function(e,t){var n=e.$relations[this.name],i=this.grabInitial(e,this.local),s=!0,r=!0,a=!0;n&&(M(i)?t&&this.clearRelated(n,s,a):(this.populateInitial(i,n,e),this.grabModel(i,this.handleModel(n,s,r),s)))},isDependent:function(e,t){return!e.child},preClone:function(e,t,n){var i=this.get(e);if(i){var s=i.$clone(n);j(t,this.local,s,s.$db.key),t[this.name]=s}},preSave:function(e){var t=e.$relations[this.name];if(t&&t.related){var n=t.related;(t.dirty||n.$hasChanges())&&(Se.debug(Se.Debugs.HASONE_PRESAVE,this,e,t),t.saving=!0,n.$save(this.saveCascade,this.saveOptions),t.saving=!1,t.dirty=!1)}},postRemove:function(e){var t=e.$relations[this.name];t&&this.cascade&&(Se.debug(Se.Debugs.HASONE_POSTREMOVE,this,e,t),this.clearModel(t))},clearModel:function(e,t){var n=e.related;n&&(Se.debug(this.debugClearModel,this,e),n.$off(Ye.Events.Removed,e.onRemoved),this.cascade&&!n.$isDeleted()&&n.$remove(this.cascade,this.cascadeRemoveOptions),e.related=null,e.dirty=!0,e.loaded=!0,e.parent.$dependents.remove(n),this.clearKey&&this.clearForeignKey(e.parent,t))}}),Se.Relations.hasMany=St,St.Defaults={model:null,lazy:!1,query:!1,store:hn.None,save:un.None,auto:!0,autoCascade:rn.All,autoOptions:null,property:!0,preserve:!0,clearKey:!0,dynamic:!1,foreign:null,comparator:null,comparatorNullsFirst:!1,listenForRelated:!0,loadRelated:!0,where:!1,saveParentCascade:rn.All,saveParentOptions:null,cascadeRemove:rn.Local,cascadeRemoveOptions:null,cascadeSave:rn.None,cascadeSaveOptions:null,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},Bt.extend(Rt,St,{type:"hasMany",debugAutoSave:Se.Debugs.HASMANY_AUTO_SAVE,debugInitialGrabbed:Se.Debugs.HASMANY_INITIAL_GRABBED,debugSort:Se.Debugs.HASMANY_SORT,debugQuery:Se.Debugs.HASMANY_QUERY,debugQueryResults:Se.Debugs.HASMANY_QUERY_RESULTS,debugUpdateKey:Se.Debugs.HASMANY_UPDATE_KEY,getDefaults:function(e,t,n){return St.Defaults},onInitialized:function(e,t,n){this.foreign=this.foreign||e.name+"_"+e.key,this.comparator=N(this.comparator,this.comparatorNullsFirst),Se.debug(Se.Debugs.HASMANY_INIT,this),this.finishInitialization()},load:Ie(function(e,t,n){var i=this,s=e.$relations[this.name]={parent:e,pending:{},isRelated:this.isRelatedFactory(e),related:this.createRelationCollection(e),saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){Se.debug(Se.Debugs.HASMANY_NINJA_REMOVE,i,e,this,s),i.removeModel(s,this,!0,!0)},onSaved:function(){s.saving||(Se.debug(Se.Debugs.HASMANY_NINJA_SAVE,i,e,this,s),s.isRelated(this)?(i.sort(s),i.checkSave(s)):i.removeModel(s,this,!1,!0))},onChange:function(){s.saving||i.where&&!i.where(this)&&i.removeModel(s,this,!1,!0)}};e.$on(Ye.Events.PostSave,this.postSave,this),e.$on(Ye.Events.PreRemove,this.preRemove,this),this.listenForRelated&&this.listenToModelAdded(this.handleModelAdded(s)),E(t)?(Se.debug(Se.Debugs.HASMANY_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,n),n)):this.query?s.query=this.executeQuery(e):this.loadRelated&&(Se.debug(Se.Debugs.HASMANY_INITIAL_PULLED,this,e,s),this.ready(this.handleLazyLoad(s))),this.setProperty(s)}),sync:function(e,t){var n=e.$relations[this.name];if(n){var i=n.related,s=!0,r=!0,a=this,o=function(e){if(t){var o=this.createCollection();o.reset(e),i.each(function(e){o.has(e.$key())||a.removeModel(n,e,s,r)})}};this.ready(this.handleLazyLoad(n,o))}},postClone:function(e,t,n){var i=this.get(e);if(i){var s=[];j(n,this.foreign,t,e.$db.key),n[this.foreign]=t[e.$db.key];for(var r=0;r<i.length;r++)s.push(i[r].$clone(n));t[this.name]=s}},postSave:function(e){var t=e.$relations[this.name];t&&this.cascadeSave&&(Se.debug(Se.Debugs.HASMANY_POSTSAVE,this,e,t),Ce(function(){t.saving=!0,t.delaySaving=!0;for(var e=t.related,n=0;n<e.length;n++){var i=e[n];!i.$isDeleted()&&i.$hasChanges()&&i.$save(this.cascadeSave,this.cascadeSaveOptions)}t.saving=!1,t.delaySaving=!1},this))},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(Se.debug(Se.Debugs.HASMANY_PREREMOVE,this,e,t),Ce(function(){this.bulk(t,function(){for(var e=t.related,n=e.length-1;n>=0;n--){var i=e[n];i.$remove(this.cascadeRemove,this.cascadeRemoveOptions)}})},this))},handleModelAdded:function(e){return function(t,n){e.isRelated(t)&&(Se.debug(Se.Debugs.HASMANY_NINJA_ADD,this,e,t),this.addModel(e,t,n))}},handleLazyLoad:function(e,t){return function(n){var i=n.filter(e.isRelated);Se.debug(Se.Debugs.HASMANY_LAZY_LOAD,this,e,i),t&&t.call(this,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModel(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,n){if(!(t.$isDeleted()||this.where&&!this.where(t))){var i=e.parent,s=e.related,r=t.$key(),a=!s.has(r);return a&&(Se.debug(Se.Debugs.HASMANY_ADD,this,e,t),s.put(r,t),t.$on(Ye.Events.Removed,e.onRemoved),t.$on(Ye.Events.SavedRemoteUpdate,e.onSaved),this.where&&t.$on(Ye.Events.Change,e.onChange),t.$dependents.add(i,this),this.updateForeignKey(t,i,n),this.sort(e),this.checkSave(e,n)),a}},removeModel:function(e,t,n,i){if(this.canRemoveRelated(t,n)){var s=e.parent,r=e.related,a=e.pending,o=t.$key(),u=r.has(o);return u&&(Se.debug(Se.Debugs.HASMANY_REMOVE,this,e,t),r.remove(o),t.$off(Ye.Events.Removed,e.onRemoved),t.$off(Ye.Events.SavedRemoteUpdate,e.onSaved),t.$off(Ye.Events.Change,e.onChange),t.$dependents.remove(s),i||(this.clearKey&&this.clearForeignKey(t,n),this.cascadeRemove&&(n?Ae(this.cascadeRemove,rn.Local)&&t.$remove(rn.Local):t.$remove(this.cascadeRemove,this.cascadeRemoveOptions))),this.sort(e),this.checkSave(e,n)),delete a[o],u}},isRelatedFactory:function(e){var t=this.foreign,n=e.$db.key;return function(i){return Y(i,t,e,n)}},getTargetFields:function(e){return this.foreign}}),Se.Relations.hasManyThrough=At,At.Defaults={model:null,lazy:!1,query:!1,store:hn.None,save:un.None,auto:!0,autoCascade:rn.All,autoOptions:null,property:!0,dynamic:!1,through:t,local:null,foreign:null,comparator:null,comparatorNullsFirst:!1,listenForRelated:!0,loadRelated:!0,where:!1,cascadeRemove:rn.NoRest,cascadeSave:rn.All,cascadeSaveOptions:null,cascadeSaveRelated:rn.None,cascadeSaveRelatedOptions:null,saveParentCascade:rn.All,saveParentOptions:null,cascadeRemoveThroughOptions:null,discriminator:"discriminator",discriminators:{},discriminatorToModel:{}},Bt.extend(Rt,At,{type:"hasManyThrough",debugAutoSave:Se.Debugs.HASMANYTHRU_AUTO_SAVE,debugInitialGrabbed:Se.Debugs.HASMANYTHRU_INITIAL_GRABBED,debugSort:Se.Debugs.HASMANYTHRU_SORT,debugQuery:Se.Debugs.HASMANYTHRU_QUERY,debugQueryResults:Se.Debugs.HASMANYTHRU_QUERY_RESULTS,debugUpdateKey:Se.Debugs.HASMANYTHRU_UPDATE_KEY,getDefaults:function(e,t,n){return At.Defaults},onInitialized:function(e,t,n){if(!this.discriminated){var i=this.model.Database;this.foreign=this.foreign||i.name+"_"+i.key}this.local=this.local||e.name+"_"+e.key,this.comparator=N(this.comparator,this.comparatorNullsFirst),d(n.through)?this.setThrough(n.through):Se.get(n.through).complete(this.setThrough,this),Se.debug(Se.Debugs.HASMANYTHRU_INIT,this)},setThrough:function(e){this.through=e,this.finishInitialization()},load:Ie(function(e,t,n){var i=this,s=this.through.Database,r=e.$relations[this.name]={parent:e,isRelated:this.isRelatedFactory(e),pending:{},related:this.createRelationCollection(e),throughs:new ze,saving:!1,delaySorting:!1,delaySaving:!1,onRemoved:function(){Se.debug(Se.Debugs.HASMANYTHRU_NINJA_REMOVE,i,e,this,r),i.removeModel(r,this)},onSaved:function(){r.saving||(Se.debug(Se.Debugs.HASMANYTHRU_NINJA_SAVE,i,e,this,r),i.sort(r),i.checkSave(r))},onChange:function(){r.saving||i.where&&!i.where(this)&&i.removeModel(r,this)},onThroughRemoved:function(){Se.debug(Se.Debugs.HASMANYTHRU_NINJA_THRU_REMOVE,i,e,this,r),i.removeModelFromThrough(r,this)}};e.$on(Ye.Events.PostSave,this.postSave,this),e.$on(Ye.Events.PreRemove,this.preRemove,this),this.listenForRelated&&s.on(Fe.Events.ModelAdded,this.handleModelAdded(r),this),E(t)?(Se.debug(Se.Debugs.HASMANYTHRU_INITIAL,this,e,r,t),this.grabModels(r,t,this.handleModel(r,n),n)):this.query?r.query=this.executeQuery(e):this.loadRelated&&(Se.debug(Se.Debugs.HASMANYTHRU_INITIAL_PULLED,this,e,r),s.ready(this.handleLazyLoad(r),this)),this.setProperty(r)}),sync:function(e,t){var n=this.through.Database,i=e.$relations[this.name];if(i){var s=i.throughs.values,r=!0,a=this,o=function(e){if(t){var n=this.createCollection();n.reset(e);for(var o=0;o<s.length;o++){var u=s[o];n.has(u.$key())||a.removeModelFromThrough(i,u,r)}}};n.ready(this.handleLazyLoad(i,o),this)}},preClone:function(e,t,n){var i=this.get(e);i&&(t[this.name]=i.slice())},postSave:function(e){var t=e.$relations[this.name];Ce(function(){if(t&&this.cascadeSave)for(var n=t.throughs.values,i=0;i<n.length;i++){var s=n[i];!s.$isDeleted()&&s.$hasChanges()&&s.$save(this.cascadeSave,this.cascadeSaveOptions)}if(t&&this.cascadeSaveRelated){Se.debug(Se.Debugs.HASMANYTHRU_PRESAVE,this,e,t),t.saving=!0,t.delaySaving=!0;for(var r=t.related,i=0;i<r.length;i++){var a=r[i];!a.$isDeleted()&&a.$hasChanges()&&a.$save(this.cascadeSaveRelated,this.cascadeSaveRelatedOptions)}t.saving=!1,t.delaySaving=!1}},this)},preRemove:function(e){var t=e.$relations[this.name];t&&this.cascadeRemove&&(Se.debug(Se.Debugs.HASMANYTHRU_PREREMOVE,this,e,t),Ce(function(){this.bulk(t,function(){for(var e=t.throughs.values,n=0;n<e.length;n++){var i=e[n];i.$remove(this.cascadeRemove,this.cascadeRemoveThroughOptions)}})},this))},handleModelAdded:function(e){return function(t,n){e.isRelated(t)&&!e.throughs.has(t.$key())&&(Se.debug(Se.Debugs.HASMANYTHRU_NINJA_ADD,this,e,t),this.addModelFromThrough(e,t,n))}},handleLazyLoad:function(e,t){return function(n){var i=n.filter(e.isRelated);Se.debug(Se.Debugs.HASMANYTHRU_LAZY_LOAD,this,e,i),t&&t.call(this,i),i.length?this.bulk(e,function(){for(var t=0;t<i.length;t++)this.addModelFromThrough(e,i[t])}):this.query&&(e.query=this.executeQuery(e.parent))}},addModel:function(e,t,n){if(!(t.$isDeleted()||this.where&&!this.where(t))){var i=this.finishAddModel(e,t,n);return i&&this.addThrough(e,t,n),i}},addThrough:function(e,t,n){var i=this.through.Database,s=this.createThroughKey(e,t);i.grabModel(s,this.onAddThrough(e,n),this,n)},onAddThrough:function(e,t){return function(n){this.finishAddThrough(e,n,t)}},addModelFromThrough:function(e,t,n){if(!t.$isDeleted()){var i=this.model.Database,s=i.keyHandler.buildKey(t,this.foreign);i.grabModel(s,this.onAddModelFromThrough(e,t,n),this,n)}},onAddModelFromThrough:function(e,t,n){return function(i){!i||this.where&&!this.where(i)||(this.finishAddThrough(e,t,n),this.finishAddModel(e,i,n))}},finishAddThrough:function(e,t,n){var i=e.parent,s=e.throughs,r=t.$key(),a=!s.has(r);return a&&(Se.debug(Se.Debugs.HASMANYTHRU_THRU_ADD,this,e,t),s.put(r,t),t.$on(Ye.Events.Removed,e.onThroughRemoved),t.$dependents.add(i,this),!n&&this.cascadeSave&&(i.$isSaved()?t.$save(this.cascadeSave,this.cascadeSaveOptions):t.$save(rn.None))),a},finishAddModel:function(e,t,n){var i=e.related,s=t.$key(),r=!i.has(s);return r&&(Se.debug(Se.Debugs.HASMANYTHRU_ADD,this,e,t),i.put(s,t),t.$on(Ye.Events.Removed,e.onRemoved),t.$on(Ye.Events.SavedRemoteUpdate,e.onSaved),this.where&&t.$on(Ye.Events.Change,e.onChange),this.sort(e),n||this.checkSave(e)),r},removeModel:function(e,t,n){var i=t.$key(),s=e.related,r=s.get(i);r&&this.removeThrough(e,t,n)&&this.finishRemoveRelated(e,i,n)},removeThrough:function(e,t,n){var i=this.through.Database,s=this.createThroughKey(e,t),r=i.keyHandler.getKey(s),a=e.throughs,o=a.get(r);return this.finishRemoveThrough(e,o,t,!0,n)},removeModelFromThrough:function(e,n,i){var s=this.model.Database,r=s.keyHandler.buildKey(n,this.foreign);this.finishRemoveThrough(e,n,t,t,i)&&this.finishRemoveRelated(e,r,i)},finishRemoveThrough:function(e,t,n,i,s){var r=e.parent,a=!!t;if(a){if(!this.canRemoveRelated(t,s))return!1;Se.debug(Se.Debugs.HASMANYTHRU_THRU_REMOVE,this,e,t,n);var o=e.throughs,u=t.$key();t.$off(Ye.Events.Removed,e.onThroughRemoved),t.$dependents.remove(r),i&&t.$remove(s?rn.Local:rn.All,this.cascadeRemoveThroughOptions),o.remove(u)}return a},finishRemoveRelated:function(e,t,n){var i=e.pending,s=e.related,r=s.get(t);return r&&(Se.debug(Se.Debugs.HASMANYTHRU_REMOVE,this,e,r),s.remove(t),r.$off(Ye.Events.Removed,e.onRemoved),r.$off(Ye.Events.SavedRemoteUpdate,e.onSaved),r.$off(Ye.Events.Change,e.onChange),this.sort(e),this.checkSave(e,n)),delete i[t],r},isRelatedFactory:function(e){var t=e.$db.key,n=this.local;return function(i){return Y(i,n,e,t)}},createThroughKey:function(e,t){for(var n=e.parent,i=n.$db.keyHandler,s=this.model.Database.keyHandler,r=this.through.Database,a=r.key,o={},u=0;u<a.length;u++){var h=a[u];i.setKeyField(o,h,t,this.foreign),s.setKeyField(o,h,n,this.local)}return o},getTargetFields:function(e){return this.local}}),Se.Relations.hasRemote=Ot,Ot.Defaults={model:t,lazy:!1,query:!1,store:hn.None,save:un.None,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1,where:!1,autoRefresh:!1},Bt.extend(Rt,Ot,{type:"hasRemote",debugSort:Se.Debugs.HASREMOTE_SORT,debugQuery:Se.Debugs.HASREMOTE_QUERY,debugQueryResults:Se.Debugs.HASREMOTE_QUERY_RESULTS,getDefaults:function(e,t,n){return Ot.Defaults},onInitialized:function(e,t,n){this.comparator=N(this.comparator,this.comparatorNullsFirst),Se.debug(Se.Debugs.HASREMOTE_INIT,this),this.finishInitialization()},load:Ie(function(e,t,n){var i=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){Se.debug(Se.Debugs.HASREMOTE_NINJA_REMOVE,i,e,this,s),i.removeModel(s,this,!0)},onSaved:function(){Se.debug(Se.Debugs.HASREMOTE_NINJA_SAVE,i,e,this,s),i.sort(s),i.checkSave(s)},onChange:function(){s.saving||i.where&&!i.where(this)&&i.removeModel(s,this,!0)}};e.$key(),this.autoRefresh&&e.$on(this.autoRefresh,this.onRefresh(s),this),s.query=this.executeQuery(e),this.setProperty(s)}),onRefresh:function(e){return function(){e.query=this.executeQuery(e.parent)}},addModel:function(e,t,n){if(!(t.$isDeleted()||this.where&&!this.where(t))){var i=(e.parent,e.related),s=t.$key(),r=!i.has(s);return r&&(Se.debug(Se.Debugs.HASMANY_ADD,this,e,t),i.put(s,t),t.$on(Ye.Events.Removed,e.onRemoved),t.$on(Ye.Events.SavedRemoteUpdate,e.onSaved),this.where&&t.$on(Ye.Events.Change,e.onChange),this.sort(e),this.checkSave(e,n)),r}},removeModel:function(e,t,n){if(this.canRemoveRelated(t,n)){var i=(e.parent,e.related),s=e.pending,r=t.$key();i.has(r)&&(Se.debug(Se.Debugs.HASMANY_REMOVE,this,e,t),i.remove(r),t.$off(Ye.Events.Removed,e.onRemoved),t.$off(Ye.Events.SavedRemoteUpdate,e.onSaved),t.$off(Ye.Events.Change,e.onChange),this.sort(e),this.checkSave(e,n)),delete s[r]}}}),Se.Relations.hasList=Mt,Mt.Defaults={model:t,lazy:!1,store:hn.Model,save:un.Model,auto:!1,property:!0,dynamic:!1,comparator:null,comparatorNullsFirst:!1},Bt.extend(Rt,Mt,{type:"hasList",debugSort:Se.Debugs.HASLIST_SORT,getDefaults:function(e,t,n){return Mt.Defaults},onInitialized:function(e,t,n){this.comparator=N(this.comparator,this.comparatorNullsFirst),Se.debug(Se.Debugs.HASLIST_INIT,this),this.finishInitialization()},load:Ie(function(e,t,n){var i=this,s=e.$relations[this.name]={parent:e,pending:{},related:this.createRelationCollection(e),delaySorting:!1,delaySaving:!1,onRemoved:function(){Se.debug(Se.Debugs.HASLIST_NINJA_REMOVE,i,e,this,s),i.removeModel(s,this,!0)},onSaved:function(){Se.debug(Se.Debugs.HASLIST_NINJA_SAVE,i,e,this,s),i.sort(s),i.checkSave(s)}};E(t)&&(Se.debug(Se.Debugs.HASLIST_INITIAL,this,e,s,t),this.grabModels(s,t,this.handleModel(s,n),n)),this.setProperty(s)}),addModel:function(e,t,n){if(!t.$isDeleted()){var i=(e.parent,e.related),s=t.$key(),r=!i.has(s);return r&&(Se.debug(Se.Debugs.HASLIST_ADD,this,e,t),i.put(s,t),t.$on(Ye.Events.Removed,e.onRemoved),t.$on(Ye.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),n||this.checkSave(e)),r}},removeModel:function(e,t,n){if(this.canRemoveRelated(t,n)){var i=(e.parent,e.related),s=e.pending,r=t.$key();i.has(r)&&(Se.debug(Se.Debugs.HASLIST_REMOVE,this,e,t),i.remove(r),t.$off(Ye.Events.Removed,e.onRemoved),t.$off(Ye.Events.SavedRemoteUpdate,e.onSaved),this.sort(e),this.checkSave(e)),delete s[r]}},postClone:function(e,t,n){var i=this.get(e);if(i){for(var s=[],r=0;r<i.length;r++)s.push(i[r].$clone());t[this.name]=s}}}),Se.Relations.hasReference=_t,_t.Defaults={model:null,lazy:!1,query:!1,store:hn.None,save:un.None,property:!0,dynamic:!1},Bt.extend(yt,_t,{type:"hasReference",debugInit:Se.Debugs.HASREFERENCE_INIT,debugClearModel:Se.Debugs.HASREFERENCE_CLEAR_MODEL,debugSetModel:Se.Debugs.HASREFERENCE_SET_MODEL,debugLoaded:Se.Debugs.HASREFERENCE_LOADED,debugQuery:Se.Debugs.HASREFERENCE_QUERY,debugQueryResults:Se.Debugs.HASREFERENCE_QUERY_RESULTS,getDefaults:function(e,t,n){return _t.Defaults},load:Ie(function(e,t,n){var i=e.$relations[this.name]={parent:e,related:null,loaded:!1,dirty:!1,onRemoved:function(){Se.debug(Se.Debugs.HASREFERENCE_NINJA_REMOVE,this,e,i),this.clearRelated(i,!1,!0)}};M(t)?this.query&&(i.query=this.executeQuery(e)):(Se.debug(Se.Debugs.HASREFERENCE_INITIAL,this,e,t),this.grabModel(t,this.handleModel(i),n))}),preClone:function(e,t,n){var i=this.get(e);i&&(t[this.name]=i.$clone(n))},isDependent:function(e,t){return!1},updateForeignKey:function(){},clearForeignKey:function(){}});var yn={setReferences:function(e,t,n){this.isRelatedFactory=this.isRelatedDiscriminatedFactory(this.isRelatedFactory),this.loadDiscriminators(function(){this.onInitialized(e,t,n)})},isRelatedDiscriminatedFactory:function(e){return function(t){var n=e.call(this,t),i=this.getDiscriminatorForModel(t),s=this.discriminator;return function(e){return n(e)?k(i,e[s]):!1}}},loadDiscriminators:function(e){function t(){++s===i&&e.apply(this)}var n=this.discriminators,i=O(n),s=0;for(var r in n){var a=n[r];Se.get(r).complete(this.setDiscriminated(a,t),this)}},setDiscriminated:function(e,t){return function(n){this.discriminators[n.Database.name]=e,this.discriminators[n.Database.className]=e,this.discriminatorToModel[e]=n,t.apply(this)}},createRelationCollection:function(e){return st(it.create(t,e,this),this.discriminator,this.discriminatorToModel)},createCollection:function(){return st(tt.create(),this.discriminator,this.discriminatorToModel)},ready:function(e){var t=this.discriminatorToModel;for(var n in t){var i=t[n];i.Database.ready(e,this)}},listenToModelAdded:function(e){var t=this.discriminatorToModel;for(var n in t){var i=t[n];i.Database.on(Fe.Events.ModelAdded,e,this)}},executeQuery:function(e){var t=this.query,n=this.queryOptions,i=this.queryData,s=f(t)?re(t,e):t,r=e.search(s,n);y(i)&&r.$set(i),st(r.$results,this.discriminator,this.discriminatorToModel);var a=r.$run();return a.complete(this.handleExecuteQuery(e),this),r},parseModel:function(e,t){if(e instanceof Ye)return e;if(y(e)){var n=this.getDiscriminatorDatabase(e);if(n)return n.parseModel(e,t)}return!1},clearFields:function(e,t,n){var i=z(e,t);return e[this.discriminator]&&(e[this.discriminator]=null,i=!0),i&&!n&&this.auto&&!e.$isNew()&&e.$save(this.autoCascade,this.autoOptions),i},updateFields:function(e,t,n,i,s){var r=j(e,t,n,i),a=this.discriminator,o=e[a],u=this.getDiscriminatorForModel(n);return k(o,u)||(e[a]=u,r=!0),r&&(!this.auto||e.$isNew()||s||e.$save(this.autoCascade,this.autoOptions),e.$trigger(Ye.Events.KeyUpdate,[e,n,t,i])),r},grabInitial:function(e,t){var n=this.discriminator,i=e[n];if(G(e,t,R)&&R(i)){var s=this.discriminatorToModel[i];if(s.Database){var r=s.Database,a={};return a[n]=i,j(a,r.key,e,t),a}}},grabModel:function(e,t,n){if(e instanceof Ye)t.call(this,e);else if(y(e)){var i=this.getDiscriminatorDatabase(e);i!==!1&&i.grabModel(e,t,this,n)}},grabModels:function(e,t,n,i){for(var s=0;s<t.length;s++){var r=t[s];if(r instanceof Ye)e.pending[r.$key()]=!0,n.call(this,r);else if(y(r)){var a=this.getDiscriminatorDatabase(r);if(a){var o=a.keyHandler.buildKeyFromInput(r);e.pending[o]=!0,a.grabModel(r,n,this,i)}}}},ownsForeignKey:function(){return!0},isModelArray:function(e){return E(e)},getDiscriminator:function(e){return e[this.discriminator]},getDiscriminatorDatabase:function(e){var t=this.getDiscriminator(e),e=this.discriminatorToModel[t];return e?e.Database:!1},getDiscriminatorForModel:function(e){return this.discriminators[e.$db.name]}};Se.shard=function(e){return function(t){var n=new Dt(t);return Bt.props(n,e),n.initialize(t),n}},Bt.create(Dt,{STATUS_FAIL_ALL:500,STATUS_FAIL_GET:500,STATUS_FAIL_CREATE:500,STATUS_FAIL_UPDATE:500,STATUS_FAIL_REMOVE:500,STATUS_FAIL_QUERY:500,ATOMIC_ALL:!1,ATOMIC_GET:!1,ATOMIC_CREATE:!0,ATOMIC_UPDATE:!0,ATOMIC_REMOVE:!1,ATOMIC_QUERY:!0,getShards:function(e){throw"getShards not implemented"},getShardForModel:function(e,t){throw"getShardForModel not implemented"},getShardsForModel:function(e,t){var n=this.getShardForModel(e,t);return n?[n]:this.getShards(t)},getShardsForQuery:function(e,t){return this.getShards()},initialize:function(e){},all:function(e,t,n){function i(t,n,i){t.all(e,n,i)}function s(e){E(e)&&o.push.apply(o,e)}function r(e,i,s){e||o.length&&!this.ATOMIC_ALL?t(o):i||n(o,l(s)?s:this.STATUS_FAIL_ALL)}var a=this.getShards(!0),o=[];this.multiplex(a,this.ATOMIC_ALL,i,s,n,r)},get:function(e,t,n,i){function s(n,i,s){n.get(e,t,i,s)}function r(e){null===u&&y(e)&&(u=e)}function a(e,t,s){null!==u?n(u):i(u,l(s)?s:this.STATUS_FAIL_GET)}var o=this.getShardsForModel(e,!0),u=null;this.multiplex(o,this.ATOMIC_GET,s,r,$,a)},create:function(e,t,n,i,s){function r(i,s,r){i.create(e,t,n,s,r)}function a(e){null===h&&y(h)&&(h=e)}function o(e,t,n){e?i(h):s(h,l(n)?n:this.STATUS_FAIL_CREATE)}var u=this.getShardsForModel(e,!1),h=null;this.multiplex(u,this.ATOMIC_CREATE,r,a,$,o)},update:function(e,t,n,i,s){function r(i,s,r){i.update(e,t,n,s,r)}function a(e){null===h&&y(h)&&(h=e)}function o(e,t,n){e?i(h):s(h,l(n)?n:this.STATUS_FAIL_UPDATE)}var u=this.getShardsForModel(e,!1),h=null;this.multiplex(u,this.ATOMIC_UPDATE,r,a,$,o)},remove:function(e,t,n,i){function s(n,i,s){n.remove(e,t,i,s)}function r(e){null===u&&y(u)&&(u=e)}function a(e,t,s){e?n(u):i(u,l(s)?s:this.STATUS_FAIL_REMOVE)}var o=this.getShardsForModel(e,!1),u=null;this.multiplex(o,this.ATOMIC_REMOVE,s,r,$,a)},query:function(e,t,n,i,s){function r(i,s,r){i.query(e,t,n,s,r)}function a(e){E(e)&&h.push.apply(h,e)}function o(e,t,n){e||h.length&&!this.ATOMIC_QUERY?i(h):t||s(h,l(n)?n:this.STATUS_FAIL_QUERY)}var u=this.getShardsForQuery(e,t),h=[];this.multiplex(u,this.ATOMIC_QUERY,r,a,$,o)},multiplex:function(e,n,i,s,r,a){function o(){++f===e.length&&a.call(this,c,d,l)}function u(e){!c&&n||s.apply(this,arguments),o()}function h(e,i){c&&(c=!1,n&&(d=!0,r.apply(this,arguments))),v(i)&&(l===t||l>i)&&(l=i),o()}var l,c=!0,d=!1,f=0;if(E(e)&&0!==e.length)for(var g=0;g<e.length;g++)i.call(this,e[g],u,h);else a.call(this,!1,!1,l)}}),D(function(e,t,n){e.all=function(){return t.models}}),D(function(e,t,n){e.array=function(e){var n=arguments.length>1||!E(e)?qt.slice.call(arguments):e;return tt["native"](t,n)}}),D(function(e,t,n){e.at=function(e){return t.models[e]}}),D(function(e,t,n){e.boot=function(e){return E(e)?tt.create(t,e,!0):y(e)?t.putRemoteData(e):e}}),D(function(e,t,n){
e.clear=function(e){return t.clear(e)}}),D(function(e,t,n){e.collect=function(e){var n=arguments.length>1||!E(e)?qt.slice.call(arguments):e;return tt.create(t,n)}}),D(function(e,t,n){e.count=function(e,n,i){return t.models.countWhere(e,n,i)}}),D(function(e,t,n){e.create=function(e,n,i){var s=y(e)?t.createModel(e):t.instantiate();return s.$save(n,i),s}}),D(function(e,t,n){var i=J(n.dynamic,mn.dynamic);if(!M(i))for(var s in i)Tt(e.prototype,s,i[s])}),D(function(e,t,n){var i=J(n.events,mn.events);if(!M(i)){var s=[],r=[];for(var a in i){var o=i[a],u=fe(a),h=Fe.Events[u],l=Ye.Events[u];h&&Lt(h,o,!1,r),l&&Lt(l,o,!0,s)}Nt(t,r),s.length&&Bt.replace(e,"$init",function(e){return function(){e.apply(this,arguments),Nt(this,s)}})}}),D(function(e,t,n){function s(e){n[e]||(t[e]=u[e])}function r(e){var n=t[e],i=u[e];for(var s in i)s in n||(n[s]=i[s])}function a(e,n){for(var s=u[n||e],r=t[e],a=s.length-1;a>=0;a--){var o=i(r,s[a]);o!==!1&&r.splice(o,1),r.unshift(s[a])}}var o=n.extend||mn.extend;if(d(o)){var u=o.Database,h=u.options;s("keySeparator"),r("defaults"),r("ignoredFields"),s("loadRelations"),s("load"),s("autoRefresh"),s("cache"),s("fullSave"),s("fullPublish"),r("encodings"),r("decodings"),s("summarize"),a("fields"),a("saveFields","fields"),n.comparator||t.setComparator(h.comparator,h.comparatorNullsFirst),n.revision||t.setRevision(h.revision),n.summarize||t.setSummarize(h.summarize);for(var l in u.relations)if(!(l in t.relations)){var c=u.relations[l],f=new c.constructor;f.init(t,l,c.options),f.save&&t.saveFields.push(l),t.relations[l]=f,t.relationNames.push(l)}t.rest=Se.rest(t),t.store=Se.store(t),t.live=Se.live(t)}}),D(function(e,t,n){e.fetch=function(e,n,i,s){var r=t.keyHandler.buildKeyFromInput(e),a=t.get(r);if(a||(a=t.keyHandler.buildObjectFromKey(r),y(e)&&a.$set(e)),c(i)){var o=s||this;a.$once(Ye.Events.RemoteGets,function(){i.call(o,a)})}return a.$refresh(rn.Rest,n),a}}),D(function(e,t,n){e.fetchAll=function(e,n){return t.refresh(e,n),t.models}}),D(function(e,t,n){var i=n.files||mn.files;if(y(i)){if(!Ct())return void Se.trigger(Se.Events.FilesNotSupported);for(var s in i){var r=i[s];f(r)&&(r={type:r}),t.decodings[s]=Rn[r.type](t,r),t.encodings[s]=wt}}}),Se.fileProcessors={},Se.Events.FilesNotSupported="files-not-supported",Se.Events.FileTooLarge="file-too-large",Se.Events.FileWrongType="file-wrong-type",Se.Events.FileOffline="file-offline",Se.addFileProcessor=function(e,t){Se.fileProcessors[e]=t},Se.fileProperties=["lastModifiedDate","name","size","type"];var Rn={text:function(e,t){return Pt("readAsText",Ft,t)},dataURL:function(e,t){return Pt("readAsDataURL",Ft,t)},base64:function(e,t){return Pt("readAsDataURL",kt,t)},resource:function(e,t){return function(e,n,s){var r=It(e),a=Se.fileProcessors[t.processor];if(!a)throw"Processor required for resource files.";if(r!==!1){if(v(t.capacity)&&v(r.size)&&r.size>t.capacity)return void Se.trigger(Se.Events.FileTooLarge,[r,n,s]);if(E(t.types)&&f(r.type)&&i(t.types,r.type)===!1)return void Se.trigger(Se.Events.FileWrongType,[r,n,s]);var o,u=!1;return a.fileToValue(r,n,s,function(e){Ut(n,s,e,r,t),o=xt(a,e,n,s,t),u&&(n[s]=o,Ht(n,t))}),u=!0,o}return y(e)&&e.FILE?void Se.trigger(Se.Events.FileOffline,[e,n,s]):(Ut(n,s,e,null,t),xt(a,e,n,s,t))}}};D(function(e,t,n){e.filtered=function(e,n,i){return t.models.filtered(e,n,i)}}),D(function(e,t,n){e.first=e.find=function(e,n,i){return t.models.firstWhere(e,n,i)}}),D(function(e,t,n){e.findOrCreate=function(n,i,s,r,a){var o=a||this,u=t.get(n),h=!1;return u?(u.$set(n),r&&r.call(o,u,h)):t.grabModel(n,function(t){t?(u=t,u.$set(n),u.$isSaved()||u.$save(i,s)):(u=e.create(n,i,s),h=!0),r&&r.call(o,u,h)}),u}}),D(function(e,t,n){e.get=function(e,n,i){return c(n)?void t.grabModel(e,n,i):t.get(e)}}),D(function(e,t,n){e.grab=function(n,i,s,r){var a=r||this,o=t.get(n);return o?s.call(a,o):t.grabModel(n,function(t){t?s.call(a,t):e.fetch(n,i,s,r)}),o}}),D(function(e,t,n){e.grabAll=function(e,n){var i=n||this,s=t.models;return s.length?e.call(i,s):t.ready(function(){s.length?e.call(i,s):t.refresh(function(){e.call(i,s)})}),s}}),D(function(e,t,n){e.hasTrait=function(e,n){return t.hasTrait(e,n)},e.hasTraits=function(e,n){return t.hasTraits(e,n)}}),D(function(e,t,n){n.keyChanges&&Gt()});var $n=ze.prototype.put,bn=ze.prototype.remove;D(function(e,t,n){var i=J(n.methods,mn.methods);M(i)||Bt.methods(e,i)}),D(function(e,t,n){e.persist=function(t,n,i,s,r){var a=r||this;return e.findOrCreate(t,n,i,function(e,t){t||e.$save(n,i),s&&s.call(a,e)})}}),D(function(e,t,n){e.projection=function(e){return Qe.parse(t,e)}}),D(function(e,t,n){e.ready=function(e,n,i){t.ready(e,n,i)}}),D(function(e,t,n){e.refresh=function(e,n){return t.refresh(e,n)}}),D(function(e,t,n){e.reset=function(e,n){return t.reset(e,n)}}),D(function(e,t,n){e.results=function(e,n,i){return new rt(t,e,i,n,!0).$results}}),D(function(e,t,n){e.search=function(e,n,i,s){return new rt(t,e,n,i,s)}}),D(function(e,t,n){e.searchAt=function(e,n,i,s,r,a,o){var u={page_index:e,page_size:1},h=i?new at(t,n,J(s,u),r):new rt(t,n,s,r),l=new ot;return l.success(a),l.failure(o),h.$run().then(function(t,n,s){l.resolve(s[i?0:e])},function(){l.reject()},function(){l.noline()}),l}}),D(function(e,t,n){e.searchPaged=function(e,n,i,s){return new at(t,e,n,i,s)}}),D(function(e){var t=e.shard||mn.shard;y(t)&&(e.createRest=Se.shard(t))},!0),D(function(e,t,n){var i=J(n.staticMethods,mn.staticMethods);M(i)||Bt.props(e,i)}),D(function(e,t,n){function s(e,t){return y(e)&&y(t)?J(e,t):e||t}function r(e){return $===!0||i($,e)!==!1}function a(e,t){return y(t)?t[e]:t}function o(e){var t=a(e,m);return function(){return jt(new Date,t)}}function u(e,t,n,i){var s=a(n,p),r=jt(e,s);return r||e}function h(e,t,n){var i=a(n,m),s=a(n,R),r=jt(e,i,s);return r||e}function l(e){var n=i(t.fields,e);n===!1&&(t.fields.push(e),t.saveFields.push(e)),!r(e)||e in t.defaults||(t.defaults[e]=o(e)),!p||e in t.encodings||(t.encodings[e]=u),!m||e in t.decodings||(t.decodings[e]=h)}function c(e){l(e),t.ignoredFields[e]=!0}function d(n){l(n),t.ignoredFields[n]=!0,Bt.replace(e,"$save",function(e){return function(){return this[n]=_(t.defaults[n]),e.apply(this,arguments)}})}function v(e,t){switch(e){case"created_at":return c(t);case"updated_at":return d(t);default:return l(t)}}var g=n.timestamps||mn.timestamps,p=s(n.timestampFormat,mn.timestampFormat),m=s(n.timestampType,mn.timestampType),R=s(n.timestampUTC,mn.timestampUTC),$=n.timestampCurrent||mn.timestampCurrent;if(g)if(f(g))v(g,g);else if(E(g))for(var b=0;b<g.length;b++)v(g[b],g[b]);else if(y(g))for(var S in g)v(S,g[S]);else c("created_at"),d("updated_at")});var Sn={Date:"date",Millis:"millis",Seconds:"seconds"};mn.timestampFormat=Sn.Millis,mn.timestampType=Sn.Date,mn.timestampUTC=!1,mn.timestampCurrent=["created_at","updated_at"],Se.Timestamp=Sn,Se.formatDate=$,Se.convertDate=jt;var An={traits:!0};return D(function(e){var t=e.traits||mn.traits;if(!M(t)){if(c(t)&&(t=t(e)),!E(t))throw"traits are expected to be an array or a function which returns an array";for(var n=0;n<t.length;n++){var i=t[n];if(c(i)&&(i=i(e)),!y(i))throw"traits are expected to be an object or a function which returns an object of methods";K(e,i,An)}}},!0),D(function(e,t,n){e.where=function(e,n,i,s){return t.models.where(e,n,i,s)}}),Se.Model=Ye,Se.Database=Fe,Se.Defaults=mn,Se.Relation=Et,Se.Operation=ut,Se.Search=rt,Se.SearchPaged=at,Se.Promise=ot,Se.Dependents=je,Se.Shard=Dt,Se.KeyHandler=Be,Se.KeySimple=Je,Se.KeyComposite=We,Se.enableKeyChanges=Gt,Se.disableKeyChanges=zt,Se.Cascade=rn,Se.Cache=sn,Se.Store=hn,Se.Save=un,Se.Load=an,Se.RestStatus=on,Se.Map=ze,Se.Collection=Xe,Se.FilteredCollection=et,Se.ModelCollection=tt,Se.FilteredModelCollection=nt,Se.RelationCollection=it,Se.Page=Ze,Se.Context=qe,Se.HasOne=bt,Se.BelongsTo=$t,Se.HasMany=St,Se.HasManyThrough=At,Se.HasRemote=Ot,Se.HasList=Mt,Se.HasReference=_t,Se.RelationMultiple=Rt,Se.RelationSingle=yt,Se.GetLocal=ht,Se.GetRemote=lt,Se.RemoveCache=ct,Se.RemoveLocal=dt,Se.RemoveNow=ft,Se.RemoveRemote=vt,Se.SaveLocal=gt,Se.SaveNow=pt,Se.SaveRemote=mt,Se.Filters={},Se.Projection=Qe,Se.isRekord=d,Se.isDefined=l,Se.isFunction=c,Se.isString=f,Se.isNumber=v,Se.isBoolean=g,Se.isDate=p,Se.isRegExp=m,Se.isArray=E,Se.isObject=y,Se.isValue=R,Se.noop=$,Se.bind=b,Se.uuid=S,Se.sizeof=O,Se.isEmpty=M,Se.evaluate=_,Se.addPlugin=D,Se.now=Jt,Se.merge=K,Se.Gate=Ie,Se.DiscriminateCollection=st,Se.Filtering=En,Se.Polymorphic=yn,Se.toArray=n,Se.indexOf=i,Se.collect=s,Se.array=r,Se.swap=a,Se.reverse=o,Se.isSorted=u,Se.isPrimitiveArray=h,Se.Settings=en,Se.Class=Bt,Se.extend=Bt.extend,Se.extendArray=Bt.extend,Se.addMethod=Se.setProperty=Bt.prop,Se.addMethods=Se.setProperties=Bt.props,Se.replaceMethod=Bt.replace,Se.copyConstructor=Bt.copyConstructor,Se.factory=Bt.factory,Se.Comparators=Wt,Se.saveComparator=T,Se.addComparator=L,Se.createComparator=N,Se.equalsStrict=C,Se.equalsWeak=I,Se.equalsCompare=F,Se.equals=k,Se.compareNumbers=H,Se.compare=U,Se.addEventFunction=x,Se.addEventful=w,Se.applyOptions=V,Se.propsMatch=Y,Se.hasFields=G,Se.updateFieldsReturnChanges=j,Se.clearFieldsReturnChanges=z,Se.grab=Q,Se.pull=q,Se.transfer=B,Se.collapse=J,Se.clean=W,Se.cleanFunctions=X,Se.copy=Z,Se.diff=ee,Se.isParseInput=te,Se.parse=ne,Se.createParser=ie,Se.isFormatInput=se,Se.format=re,Se.createFormatter=ae,Se.parseDate=oe,Se.NumberResolvers=Xt,Se.saveNumberResolver=ue,Se.createNumberResolver=he,Se.PropertyResolvers=Zt,Se.savePropertyResolver=le,Se.createPropertyResolver=ce,Se.toCamelCase=fe,Se.split=ve,Se.Wheres=nn,Se.saveWhere=ge,Se.createWhere=pe,Se.expr=me,Se.not=$e,Se.oneOf=be,Se.isExpr=Re,Se.exprEqualsTester=ye,Se.exprEquals=Ee,Se.Stores=pn,Se.Lives=vn,Se.Rests=gn,Se});
//# sourceMappingURL=rekord.min.js.map
