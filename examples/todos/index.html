<!DOCTYPE html>
<html>
  <head>
    <title>Neurosync Todo Example</title>
  </head>
  <body ng-app="todos">

    <div ng-controller="TodoController as ctrl">

      <!-- Online status -->
      <div style="float:right">{{ ctrl.status }}</div>

      <!-- New Todo -->
      <input type="text" ng-model="ctrl.todo.name" ng-enter="ctrl.addTodo()">

      <!-- List of Todo -->
      <div ng-repeat="t in ctrl.todos">
        <todo model="t"></todo>
      </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0-beta.1/angular.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
    <script src="http://rawgit.com/ClickerMonkey/storkjs/master/build/stork.min.js"></script>
    <script src="pubsub/pubsub-client.js"></script>

    <script src="../../build/plugins/neurosync-pubsub.min.js"></script>
    <script src="../../build/plugins/neurosync-stork.min.js"></script>
    <script src="../../build/plugins/neurosync-debug.min.js"></script>
    <script src="../../build/plugins/neurosync-angular.min.js"></script>

    <!-- Todo Application -->
    <script>

      angular.module('todos', ['neurosync'])

        .config(function($logProvider)
        {
          $logProvider.debugEnabled( true );
        })

        .value('PUBSUB', 'http://localhost:3000')

        .value('RESTBASE', 'http://localhost:8080/api/')

        .factory('Accessible', function(Neuro, PUBSUB, RESTBASE)
        {
          var Accessible = Neuro({
            name: 'accessible',
            className: 'Accessible',
            api: RESTBASE + 'accessible/',
            pubsub: PUBSUB,
            channel: 'accessibles',
            token: 'root',
            key: 'id',
            fields: ['id', 'users'],
            defaults: {
              users: []
            }
          });

          window.Accessible = Accessible;

          return Accessible;
        })

        .factory('Todo', function(Neuro, Accessible, PUBSUB, RESTBASE)
        {
          var Todo = Neuro({
            name: 'todos',
            className: 'Todo',
            api: RESTBASE + 'todos/',
            pubsub: PUBSUB,
            channel: 'todos',
            token: 'root',
            key: 'id',
            fields: ['id', 'name', 'done', 'created_at', 'updated_at', 'accessible_id'],
            defaults: {
              done: false,
              created_at: Date.now,
              updated_at: Date.now,
              accessible: Accessible
            },
            comparator: '-created_at',

            loadRelations: true,
            hasOne: {
              accessible: {
                model: Accessible,
                auto: true
                // local: 'accessible_id'
                // store: Neuro.Store.None
                // save: Neuro.Save.None
              }
            }
          });

          window.Todo = Todo;

          return Todo;
        })

        .directive('todo', function()
        {
          return {
            restrict: 'E',
            scope: {
              model: '='
            },
            template: [
              '<div ng-if="editing">',
              '   <input type="text" ng-model="model.name" ng-enter="saveTodo()">',
              '</div>',
              '<div ng-if="!editing">',
              '   <input type="checkbox" id="todo{{ model.id }}" ng-model="model.done" ng-change="saveTodo()">',
              '   <label for="todo{{ model.id }}">{{ model.name }}</label>',
              '   <span style="float: right">',
              '     <span ng-hide="model.$isSaved()">(local)</span>',
              '     <a href="#" ng-click="editTodo()">Edit</a>',
              '     <a href="#" ng-click="removeTodo()">Remove</a>',
              '   </span>',
              '</div>'
            ].join('\n'),
            link: function(scope, element, attrs) {
              scope.editing = false;
              scope.editTodo = function() {
                scope.editing = true;
              };
              scope.removeTodo = function() {
                scope.model.$remove();
              },
              scope.saveTodo = function() {
                scope.model.$save({
                  updated_at: Date.now()
                });
                scope.editing = false;
              };
            }
          }
        })

        .controller('TodoController', function($scope, Neuro, Todo)
        {
          this.status = Neuro.online ? 'Online' : 'Offline';
          this.todos = Todo.Database.getModels();

          this.newTodo = function() {
            this.todo = new Todo({
              name: '',
              done: false
            });
          };

          this.setStatus = function(value) {
            return function() {
              $scope.$evalAsync(function() {
                $scope.status = value;
              });
            };
          };

          this.addTodo = function() {
            if ( this.todo.name ) {
              this.todo.$save({
                created_at: Date.now(),
                updated_at: Date.now()
              });
              this.newTodo();
            }
          };

          this.newTodo();

          Neuro.on('online', this.setStatus('Online'));
          Neuro.on('offline', this.setStatus('Offline'));

          Todo.Database.on('updated', function() {
            $scope.$evalAsync();
          });

          window.TodoController = this;
        })

        .directive('ngEnter', function()
        {
          return function(scope, element, attrs) 
          {
            element.on('keydown', function(e) 
            {
              if (e.which === 13) 
              {
                scope.$evalAsync(attrs.ngEnter);
                e.preventDefault();
              }
            });
          }
        })
      ;

    </script>

  </body>
</html>