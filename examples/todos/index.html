<!DOCTYPE html>
<html>
  <head>
    <title>Neurosync</title>
  </head>
  <body ng-app="neurosync">

    <div ng-controller="TodoController as ctrl">

      <!-- Online status -->
      <div style="float:right">{{ ctrl.status }}</div>

      <!-- New Todo -->
      <input type="text" ng-model="ctrl.todo.name" ng-enter="ctrl.addTodo()">

      <!-- List of Todo -->
      <div ng-repeat="t in ctrl.todos">
        <todo model="t"></todo>
      </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0-beta.1/angular.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
    <script src="http://rawgit.com/ClickerMonkey/storkjs/master/build/stork.min.js"></script>
    <script src="pubsub/pubsub-client.js"></script>
    <script src="../../build/neurosync.js"></script>

    <!-- Todo Application -->
    <script>

      angular.module('neurosync', [])

        .value('PUBSUB', 'http://localhost:3000')

        .value('RESTBASE', 'http://localhost:8080/api/')

        .factory('Todo', function(Neuro, PUBSUB, RESTBASE)
        {
          var Todo = Neuro({
            name: 'todos',
            className: 'Todo',
            rest: RESTBASE + 'todos/',
            pubsub: PUBSUB,
            channel: 'todos',
            token: 'root',
            key: 'id',
            fields: ['id', 'name', 'done', 'created_at', 'updated_at'],
            comparator: function(a, b) {
              return b.created_at - a.created_at;
            }
          });

          return Todo;
        })

        .directive('todo', function()
        {
          return {
            restrict: 'E',
            scope: {
              model: '='
            },
            template: [
              '<div ng-if="editing">',
              '   <input type="text" ng-model="model.name" ng-enter="saveTodo()">',
              '</div>',
              '<div ng-if="!editing">',
              '   <input type="checkbox" id="todo{{ model.id }}" ng-model="model.done" ng-change="saveTodo()">',
              '   <label for="todo{{ model.id }}">{{ model.name }}</label>',
              '   <span style="float: right">',
              '     <a href="#" ng-click="editTodo()">Edit</a>',
              '     <a href="#" ng-click="removeTodo()">Remove</a>',
              '   </span>',
              '</div>'
            ].join('\n'),
            link: function(scope, element, attrs) {
              scope.editing = false;
              scope.editTodo = function() {
                scope.editing = true;
              };
              scope.removeTodo = function() {
                scope.model.$remove();
              },
              scope.saveTodo = function() {
                scope.model.$save({
                  updated_at: Date.now()
                });
                scope.editing = false;
              };
            }
          }
        })

        .controller('TodoController', function($scope, Neuro, Todo)
        {
          this.status = Neuro.online ? 'Online' : 'Offline';
          this.todos = Todo.Database.getModels();

          this.newTodo = function() {
            this.todo = new Todo.Model({
              name: '',
              done: false
            });
          };

          this.setStatus = function(value) {
            return function() {
              $scope.$evalAsync(function() {
                $scope.status = value;
              });
            };
          };

          this.addTodo = function() {
            if ( this.todo.name ) {
              this.todo.$save({
                created_at: Date.now(),
                updated_at: Date.now()
              });
              this.newTodo();
            }
          };

          this.newTodo();

          Neuro.on('online', this.setStatus('Online'));
          Neuro.on('offline', this.setStatus('Offline'));

          Todo.Database.on('updated', function() {
            $scope.$evalAsync();
          });

          window.TodoController = this;
          window.Todo = Todo;
        })

        .factory('Neuro', function($http, $interpolate) 
        {

          var EventToDescription = {
            0:  $interpolate('Neuro created {{ a.name }}'),
            1:  $interpolate('{{ a.method }} {{ a.data }} to {{ a.url }}'),
            2:  $interpolate('Remote data received to {{ b.id }}, existing model updated {{ a }}'),
            3:  $interpolate('Remote data received, new model created {{ a }}'),
            4:  $interpolate('Model remotely removed, removed locally {{ a.name }}'),
            5:  $interpolate('Models loaded remotely: {{ a.length }}'),
            6:  $interpolate('Offline, failed loading models remotely'),
            7:  $interpolate('Error loading remote models {{ a }}'),
            8:  $interpolate('Saved model removed locally because it does not exist remotely {{ a }}'),
            9:  $interpolate('Models loaded locally: {{ a.length }}'),
            10: $interpolate('Model deleted locally, resuming remote deletion of {{ a.name }}'),
            11: $interpolate('Model loaded but not saved, resuming save of {{ a.name }}'),
            12: $interpolate('Model loaded {{ a.name }} {{ a.done }}'),
            13: $interpolate('Real-time save {{ a }}'),
            14: $interpolate('Real-time removal {{ a }}'),
            15: $interpolate('Model saved values: {{ a }}'),
            16: $interpolate('Model save published {{ a }} for {{ b.name }}'),
            17: $interpolate('Model save failure, conflict for {{ a.name }}'),
            18: $interpolate('Model update failure, does not exist remotely for {{ a.name }}'),
            19: $interpolate('Model save error {{ a.name }} {{ b }}'),
            20: $interpolate('Model save failure, offline! {{ a.name }}'),
            21: $interpolate('Model save resume {{ a.name }}'),
            22: $interpolate('Models loading remotely resumed'),
            23: $interpolate('Model saved locally {{ a.$toJSON() }}'),
            24: $interpolate('Model failed to save locally, will still try to save it remotely: {{ b }} {{ a }}'),
            25: $interpolate('Model saved remotely {{ a.name }}'),
            26: $interpolate('Model remove published {{ a }}'),
            27: $interpolate('Model removed locally {{ a }}'),
            28: $interpolate('Model remove failure, does not exist remotely {{ a }}'),
            29: $interpolate('Model remove error {{ a }}'),
            30: $interpolate('Model remove failure, offline! {{ a.name }}'),
            31: $interpolate('Model remove resume {{ a.name }}'),
            32: $interpolate('Model removed remotely {{ a.name }}'),
            33: $interpolate('Model removed locally {{ a.name }}'),
            34: $interpolate('Model failed to remove locally, will still try to remove it remotely {{ a.name }} {{ b }}'),
            35: $interpolate('Application Online'),
            36: $interpolate('Application Offline'),
            37: $interpolate('PUBSUB created {{ a.url }}'),
            38: $interpolate('Model local save ineffective, model is deleted {{ a.name }}'),
            39: $interpolate('Model local save blocked, waiting until previous operation finishes for {{ a.name }}'),
            40: $interpolate('Model save ineffective, model is deleted {{ a.name }}'),
            41: $interpolate('Model remote save ineffective, model is deleted {{ a.name }}'),
            42: $interpolate('Model remove save blocked, waiting until previous operation finishes for {{ a.name }}'),
            43: $interpolate('Model remote remove blocked, waiting until previous operation finishes for {{ a.name }}'),
            44: $interpolate('Model local remove blocked, waiting until previous operation finishes for {{ a.name }}'),
            45: $interpolate('Model local remove ineffective, no local model to remove for {{ a.name }}'),
            46: $interpolate('Model local remove effective, unsaved model removed {{ a.name }}'),
            47: $interpolate('Model had a pending save that was canceled by remove for {{ a.name }}')
          };

          Neuro.debug = function(event, a, b, c)
          {
            var exp = EventToDescription[ event ];
            var result = exp( { a: a, b: b, c: c } );

            console.log( event + ' - ' +  result );
          };

          Neuro.rest = function(options, promise) 
          {
            Neuro.debug( Neuro.Events.REST, options );

            if (Neuro.forceOffline) 
            {
              promise.$failure( [{}, 0] );
            } 
            else 
            {
              $http( options ).then(
                function onRestSuccess(response) 
                {
                  promise.$success( [response.data] );
                },
                function onRestError(response) 
                {
                  promise.$failure( [response.data, response.status] );
                })
              ;
            }            
          };

          Neuro.listenToNetworkStatus();

          return Neuro;
        })

        .directive('ngEnter', function()
        {
          return function(scope, element, attrs) 
          {
            element.on('keydown', function(e) 
            {
              if (e.which === 13) 
              {
                scope.$evalAsync(attrs.ngEnter);
                e.preventDefault();
              }
            });
          }
        })
      ;

    </script>

  </body>
</html>